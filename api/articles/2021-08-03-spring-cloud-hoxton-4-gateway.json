{"title":"SpringCloud系列教程(四)之SpringCloud Gateway","slug":"2021-08-03-spring-cloud-hoxton-4-gateway","date":"2021-08-03T01:35:00.000Z","updated":"2022-12-01T01:32:39.787Z","comments":true,"path":"api/articles/2021-08-03-spring-cloud-hoxton-4-gateway.json","excerpt":null,"covers":["data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="],"cover":"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046764668983.jpg","content":"<blockquote>\n<p>**阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：**<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6991635985847025671\" target=\"_blank\" rel=\"noopener\"># SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>\n</ul>\n<h2 id=\"本文概览\"><a href=\"#本文概览\" class=\"headerlink\" title=\"本文概览\"></a>本文概览</h2><ul>\n<li>Spring Cloud Gateway的简介</li>\n<li>gateway在微服务架构中的应用场景</li>\n<li>Spring Cloud Gateway使用</li>\n<li>相关配置详解</li>\n<li>实战中的使用</li>\n</ul>\n<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><p>Spring Cloud 作为新一代的微服务网关，该项目基于Spring webflux技术开发的网关，作为Spring Cloud生态系统中的网关，目标是替代zuul，为什么使用webflux？webflux是Reactor模式的响应式编程框架，底层使用了netty通信框架，非Reactor模式的zuul采用的是Tomcat容器，使用的还是传统的Servlet IO处理模型。想了解webflux和netty的同学可以搜索相关知识，这也是当前比较热门的技术。</p>\n<p>本文中用到的demo源码地址：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<h3 id=\"Gateway的特征\"><a href=\"#Gateway的特征\" class=\"headerlink\" title=\"Gateway的特征\"></a>Gateway的特征</h3><p>引用官方的文档：</p>\n<blockquote>\n<p>Spring Cloud Gateway features:</p>\n</blockquote>\n<ul>\n<li><p>Built on Spring Framework 5, Project Reactor and Spring Boot 2.0</p>\n</li>\n<li><p>Able to match routes on any request attribute.</p>\n</li>\n<li><p>Predicates and filters are specific to routes.</p>\n</li>\n<li><p>Circuit Breaker integration.</p>\n</li>\n<li><p>Spring Cloud DiscoveryClient integration</p>\n</li>\n<li><p>Easy to write Predicates and Filters</p>\n</li>\n<li><p>Request Rate Limiting</p>\n</li>\n<li><p>Path Rewriting</p>\n</li>\n<li><p>Spring Cloud Gateway 基于 Spring Framework 5, Project Reactor 和 Spring Boot 2.0</p>\n</li>\n<li><p>能够匹配任何请求属性上的路由。</p>\n</li>\n<li><p>Predicates和filters特定于路由，易于编写的Predicates和filters</p>\n</li>\n<li><p>Hystrix断路器的继承</p>\n</li>\n<li><p>集成了DiscoveryClient</p>\n</li>\n<li><p>具备了一些高级功：动态路由、限流、路径重写等</p>\n</li>\n</ul>\n<p>和zuul的功能相差不大，最主要的区别是底层通信框架的实现上。</p>\n<p>具体的通信框架这里就暂时不展开了。</p>\n<h2 id=\"微服务网关的应用场景\"><a href=\"#微服务网关的应用场景\" class=\"headerlink\" title=\"微服务网关的应用场景\"></a>微服务网关的应用场景</h2><p>在微服务架构中，网关起到了下层服务的路由、限流和路径重写等作用，下面用一张简单的架构图来描述一下微服务网关的作用：</p>\n<p><img   class=\"lazyload\" data-original=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/78dd5ad29dae4bf2b26ed589c74dd811~tplv-k3u1fbpfcp-zoom-1.image\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>上图中很直观的展示了Spring Cloud Gateway在整个架构中的作用。</p>\n<h2 id=\"Spring-Cloud-Gateway使用\"><a href=\"#Spring-Cloud-Gateway使用\" class=\"headerlink\" title=\"Spring Cloud Gateway使用\"></a>Spring Cloud Gateway使用</h2><h3 id=\"新建模块\"><a href=\"#新建模块\" class=\"headerlink\" title=\"新建模块\"></a>新建模块</h3><p>新建一个springboot工程，maven依赖如下，详细的配置可以查看demo源码</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-test<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">scope</span>&gt;</span>test<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">scope</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h3><p>修改配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">15010</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">118.25</span><span class=\"hljs-number\">.36</span><span class=\"hljs-number\">.41</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">locator:</span><br>          <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">false</span><br>          <span class=\"hljs-attr\">lowerCaseServiceId:</span> <span class=\"hljs-literal\">true</span><br>      <span class=\"hljs-attr\">routes:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">provider</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-provider</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/provider/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">consumer</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-consumer</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/consumer/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br><br>  <span class=\"hljs-attr\">application:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">winter-gateway</span><br></code></pre></td></tr></table></figure>\n\n<p>具体配置的解释后面会介绍。</p>\n<p>接下来就在启动类中加入注解: <code>@EnableDiscoveryClient</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@EnableDiscoveryClient</span><br><span class=\"hljs-meta\">@SpringBootApplication</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SpringCloudGatewayApplication</span> </span>&#123;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(SpringCloudGatewayApplication<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>, <span class=\"hljs-title\">args</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>启动服务：<code>spring-cloud-nacos-consumer</code>， <code>spring-cloud-nacos-provider</code>，<code>spring-cloud-gateway</code> </p>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>浏览器输入：<a href=\"http://127.0.0.1:15010/consumer/nacos/echo/hello\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:15010/consumer/nacos/echo/hello</a></p>\n<p>得到返回值：<code>Hello Nacos Discovery hello</code> </p>\n<h3 id=\"拓展：解决跨域问题\"><a href=\"#拓展：解决跨域问题\" class=\"headerlink\" title=\"拓展：解决跨域问题\"></a>拓展：解决跨域问题</h3><p>Spring Cloud Gateway如何解决跨域问题？我们可以在配置文件中加入：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">globalcors:</span><br>        <span class=\"hljs-attr\">cors-configurations:</span><br>          <span class=\"hljs-string\">'[/**]'</span><span class=\"hljs-string\">:</span> <span class=\"hljs-comment\"># 匹配所有请求</span><br>            <span class=\"hljs-attr\">allowedOrigins:</span> <span class=\"hljs-string\">\"*\"</span> <span class=\"hljs-comment\">#跨域处理 允许所有的域</span><br>            <span class=\"hljs-attr\">allowedMethods:</span> <span class=\"hljs-comment\"># 支持的方法</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">GET</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">POST</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">PUT</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">DELETE</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Spring-Cloud-Gateway-配置详解\"><a href=\"#Spring-Cloud-Gateway-配置详解\" class=\"headerlink\" title=\"Spring Cloud Gateway 配置详解\"></a>Spring Cloud Gateway 配置详解</h2><p>我们看一下上面我们用到的配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">15010</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">118.25</span><span class=\"hljs-number\">.36</span><span class=\"hljs-number\">.41</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">locator:</span><br>          <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">false</span><br>          <span class=\"hljs-attr\">lowerCaseServiceId:</span> <span class=\"hljs-literal\">true</span><br>      <span class=\"hljs-attr\">routes:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">provider</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-provider</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/provider/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span> <br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">consumer</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-consumer</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/consumer/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br><br>  <span class=\"hljs-attr\">application:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">winter-gateway</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>id</strong>：我们自定义的路由 ID，保持唯一</p>\n<p><strong>uri</strong>：目标服务地址</p>\n<p><strong>predicates</strong>：路由条件，Predicate 接受一个输入参数，返回一个布尔值结果。该接口包含多种默认方法来将 Predicate 组合成其他复杂的逻辑（比如：与，或，非）。</p>\n<p>上面这段配置的意思是，配置了一个 id 为 url-proxy-1的URI代理规则，路由的规则为：</p>\n<p>当访问地址<code>http://localhost:8080/provider/nacos/echo/hello</code>时，</p>\n<p>会路由到上游地址<code>http://winter-nacos-provider/nacos/echo/hello</code>。</p>\n<p><strong>filters</strong>: 过滤器是路由转发请求时所经过的过滤逻辑，可用于修改请求、响应内容，<code>StripPrefix=1</code>就代表截取路径的个数为1，比如前端过来请求<code>/provider/nacos/echo/hello</code>，匹配成功后，路由到后端的请求路径就会变成<code>http://127.0.0.1:16012/nacos/echo/hello</code>。</p>\n<p>关于gateway的详细配置，可以参考: </p>\n<p><a href=\"https://www.cnblogs.com/crazymakercircle/p/11704077.html\" target=\"_blank\" rel=\"noopener\">SpringCloud gateway （史上最全）</a></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>关于spring cloud gateway的介绍先讲到这里，后一篇会讲解如何在网关层集成swagger文档以及如何在网关层进行登录权限的验证。并且会介绍相关的原理。</p>\n<h2 id=\"源码地址\"><a href=\"#源码地址\" class=\"headerlink\" title=\"源码地址\"></a>源码地址</h2><p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<p>参考文献：</p>\n<p><a href=\"https://spring.io/projects/spring-cloud-gateway#overview\" target=\"_blank\" rel=\"noopener\">Spring Cloud Gateway</a></p>\n<p><a href=\"https://www.cnblogs.com/crazymakercircle/p/11704077.html\" target=\"_blank\" rel=\"noopener\">SpringCloud gateway （史上最全）</a></p>\n","more":"<blockquote>\n<p>**阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：**<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6991635985847025671\" target=\"_blank\" rel=\"noopener\"># SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>\n</ul>\n<h2 id=\"本文概览\"><a href=\"#本文概览\" class=\"headerlink\" title=\"本文概览\"></a>本文概览</h2><ul>\n<li>Spring Cloud Gateway的简介</li>\n<li>gateway在微服务架构中的应用场景</li>\n<li>Spring Cloud Gateway使用</li>\n<li>相关配置详解</li>\n<li>实战中的使用</li>\n</ul>\n<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><p>Spring Cloud 作为新一代的微服务网关，该项目基于Spring webflux技术开发的网关，作为Spring Cloud生态系统中的网关，目标是替代zuul，为什么使用webflux？webflux是Reactor模式的响应式编程框架，底层使用了netty通信框架，非Reactor模式的zuul采用的是Tomcat容器，使用的还是传统的Servlet IO处理模型。想了解webflux和netty的同学可以搜索相关知识，这也是当前比较热门的技术。</p>\n<p>本文中用到的demo源码地址：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<h3 id=\"Gateway的特征\"><a href=\"#Gateway的特征\" class=\"headerlink\" title=\"Gateway的特征\"></a>Gateway的特征</h3><p>引用官方的文档：</p>\n<blockquote>\n<p>Spring Cloud Gateway features:</p>\n</blockquote>\n<ul>\n<li><p>Built on Spring Framework 5, Project Reactor and Spring Boot 2.0</p>\n</li>\n<li><p>Able to match routes on any request attribute.</p>\n</li>\n<li><p>Predicates and filters are specific to routes.</p>\n</li>\n<li><p>Circuit Breaker integration.</p>\n</li>\n<li><p>Spring Cloud DiscoveryClient integration</p>\n</li>\n<li><p>Easy to write Predicates and Filters</p>\n</li>\n<li><p>Request Rate Limiting</p>\n</li>\n<li><p>Path Rewriting</p>\n</li>\n<li><p>Spring Cloud Gateway 基于 Spring Framework 5, Project Reactor 和 Spring Boot 2.0</p>\n</li>\n<li><p>能够匹配任何请求属性上的路由。</p>\n</li>\n<li><p>Predicates和filters特定于路由，易于编写的Predicates和filters</p>\n</li>\n<li><p>Hystrix断路器的继承</p>\n</li>\n<li><p>集成了DiscoveryClient</p>\n</li>\n<li><p>具备了一些高级功：动态路由、限流、路径重写等</p>\n</li>\n</ul>\n<p>和zuul的功能相差不大，最主要的区别是底层通信框架的实现上。</p>\n<p>具体的通信框架这里就暂时不展开了。</p>\n<h2 id=\"微服务网关的应用场景\"><a href=\"#微服务网关的应用场景\" class=\"headerlink\" title=\"微服务网关的应用场景\"></a>微服务网关的应用场景</h2><p>在微服务架构中，网关起到了下层服务的路由、限流和路径重写等作用，下面用一张简单的架构图来描述一下微服务网关的作用：</p>\n<p><img   class=\"lazyload\" data-original=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/78dd5ad29dae4bf2b26ed589c74dd811~tplv-k3u1fbpfcp-zoom-1.image\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>上图中很直观的展示了Spring Cloud Gateway在整个架构中的作用。</p>\n<h2 id=\"Spring-Cloud-Gateway使用\"><a href=\"#Spring-Cloud-Gateway使用\" class=\"headerlink\" title=\"Spring Cloud Gateway使用\"></a>Spring Cloud Gateway使用</h2><h3 id=\"新建模块\"><a href=\"#新建模块\" class=\"headerlink\" title=\"新建模块\"></a>新建模块</h3><p>新建一个springboot工程，maven依赖如下，详细的配置可以查看demo源码</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-test<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">scope</span>&gt;</span>test<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">scope</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h3><p>修改配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">15010</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">118.25</span><span class=\"hljs-number\">.36</span><span class=\"hljs-number\">.41</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">locator:</span><br>          <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">false</span><br>          <span class=\"hljs-attr\">lowerCaseServiceId:</span> <span class=\"hljs-literal\">true</span><br>      <span class=\"hljs-attr\">routes:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">provider</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-provider</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/provider/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">consumer</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-consumer</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/consumer/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br><br>  <span class=\"hljs-attr\">application:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">winter-gateway</span><br></code></pre></td></tr></table></figure>\n\n<p>具体配置的解释后面会介绍。</p>\n<p>接下来就在启动类中加入注解: <code>@EnableDiscoveryClient</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@EnableDiscoveryClient</span><br><span class=\"hljs-meta\">@SpringBootApplication</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SpringCloudGatewayApplication</span> </span>&#123;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(SpringCloudGatewayApplication<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>, <span class=\"hljs-title\">args</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>启动服务：<code>spring-cloud-nacos-consumer</code>， <code>spring-cloud-nacos-provider</code>，<code>spring-cloud-gateway</code> </p>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>浏览器输入：<a href=\"http://127.0.0.1:15010/consumer/nacos/echo/hello\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:15010/consumer/nacos/echo/hello</a></p>\n<p>得到返回值：<code>Hello Nacos Discovery hello</code> </p>\n<h3 id=\"拓展：解决跨域问题\"><a href=\"#拓展：解决跨域问题\" class=\"headerlink\" title=\"拓展：解决跨域问题\"></a>拓展：解决跨域问题</h3><p>Spring Cloud Gateway如何解决跨域问题？我们可以在配置文件中加入：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">globalcors:</span><br>        <span class=\"hljs-attr\">cors-configurations:</span><br>          <span class=\"hljs-string\">'[/**]'</span><span class=\"hljs-string\">:</span> <span class=\"hljs-comment\"># 匹配所有请求</span><br>            <span class=\"hljs-attr\">allowedOrigins:</span> <span class=\"hljs-string\">\"*\"</span> <span class=\"hljs-comment\">#跨域处理 允许所有的域</span><br>            <span class=\"hljs-attr\">allowedMethods:</span> <span class=\"hljs-comment\"># 支持的方法</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">GET</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">POST</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">PUT</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">DELETE</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Spring-Cloud-Gateway-配置详解\"><a href=\"#Spring-Cloud-Gateway-配置详解\" class=\"headerlink\" title=\"Spring Cloud Gateway 配置详解\"></a>Spring Cloud Gateway 配置详解</h2><p>我们看一下上面我们用到的配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">15010</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">118.25</span><span class=\"hljs-number\">.36</span><span class=\"hljs-number\">.41</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">locator:</span><br>          <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">false</span><br>          <span class=\"hljs-attr\">lowerCaseServiceId:</span> <span class=\"hljs-literal\">true</span><br>      <span class=\"hljs-attr\">routes:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">provider</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-provider</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/provider/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span> <br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">consumer</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-consumer</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/consumer/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br><br>  <span class=\"hljs-attr\">application:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">winter-gateway</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>id</strong>：我们自定义的路由 ID，保持唯一</p>\n<p><strong>uri</strong>：目标服务地址</p>\n<p><strong>predicates</strong>：路由条件，Predicate 接受一个输入参数，返回一个布尔值结果。该接口包含多种默认方法来将 Predicate 组合成其他复杂的逻辑（比如：与，或，非）。</p>\n<p>上面这段配置的意思是，配置了一个 id 为 url-proxy-1的URI代理规则，路由的规则为：</p>\n<p>当访问地址<code>http://localhost:8080/provider/nacos/echo/hello</code>时，</p>\n<p>会路由到上游地址<code>http://winter-nacos-provider/nacos/echo/hello</code>。</p>\n<p><strong>filters</strong>: 过滤器是路由转发请求时所经过的过滤逻辑，可用于修改请求、响应内容，<code>StripPrefix=1</code>就代表截取路径的个数为1，比如前端过来请求<code>/provider/nacos/echo/hello</code>，匹配成功后，路由到后端的请求路径就会变成<code>http://127.0.0.1:16012/nacos/echo/hello</code>。</p>\n<p>关于gateway的详细配置，可以参考: </p>\n<p><a href=\"https://www.cnblogs.com/crazymakercircle/p/11704077.html\" target=\"_blank\" rel=\"noopener\">SpringCloud gateway （史上最全）</a></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>关于spring cloud gateway的介绍先讲到这里，后一篇会讲解如何在网关层集成swagger文档以及如何在网关层进行登录权限的验证。并且会介绍相关的原理。</p>\n<h2 id=\"源码地址\"><a href=\"#源码地址\" class=\"headerlink\" title=\"源码地址\"></a>源码地址</h2><p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<p>参考文献：</p>\n<p><a href=\"https://spring.io/projects/spring-cloud-gateway#overview\" target=\"_blank\" rel=\"noopener\">Spring Cloud Gateway</a></p>\n<p><a href=\"https://www.cnblogs.com/crazymakercircle/p/11704077.html\" target=\"_blank\" rel=\"noopener\">SpringCloud gateway （史上最全）</a></p>\n","categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"},{"name":"gateway","path":"api/tags/gateway.json"},{"name":"Hoxton","path":"api/tags/Hoxton.json"}]}