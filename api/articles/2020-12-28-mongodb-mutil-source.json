{"title":"mongodb多数据源之mongotemplate和事务的配置","slug":"2020-12-28-mongodb-mutil-source","date":"2020-12-28T07:55:00.000Z","updated":"2022-12-01T01:32:39.783Z","comments":true,"path":"api/articles/2020-12-28-mongodb-mutil-source.json","excerpt":null,"covers":null,"cover":"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046758159575.jpg","content":"<blockquote>\n<p>题图：我的家乡，拍摄于2020年初疫情期间</p>\n</blockquote>\n<h2 id=\"maven坐标\"><a href=\"#maven坐标\" class=\"headerlink\" title=\"maven坐标\"></a>maven坐标</h2><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>2.1.13.RELEASE<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"多数据源配置\"><a href=\"#多数据源配置\" class=\"headerlink\" title=\"多数据源配置\"></a>多数据源配置</h2><p>配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">data:</span><br>    <span class=\"hljs-attr\">mongodb:</span><br>      <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">mongodb://192.168.150.154:17017</span><br>      <span class=\"hljs-attr\">database:</span> <span class=\"hljs-string\">ewell-label</span><br>    <span class=\"hljs-attr\">mongodb-target:</span><br>      <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">mongodb://192.168.150.154:17017</span><br>      <span class=\"hljs-attr\">database:</span> <span class=\"hljs-string\">ewell-label-target</span><br></code></pre></td></tr></table></figure>\n\n<p>java配置：</p>\n<p>主数据源：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">package</span> com.winterchen.label.service.configuration;<br><br><span class=\"hljs-keyword\">import</span> com.mongodb.MongoClient;<br><span class=\"hljs-keyword\">import</span> com.mongodb.MongoClientURI;<br><span class=\"hljs-keyword\">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class=\"hljs-keyword\">import</span> org.springframework.beans.factory.annotation.Value;<br><span class=\"hljs-keyword\">import</span> org.springframework.context.annotation.Bean;<br><span class=\"hljs-keyword\">import</span> org.springframework.context.annotation.Configuration;<br><span class=\"hljs-keyword\">import</span> org.springframework.context.annotation.Primary;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.MongoDbFactory;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.MongoTransactionManager;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.config.AbstractMongoConfiguration;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.MongoTemplate;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.SimpleMongoDbFactory;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.DefaultDbRefResolver;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.DefaultMongoTypeMapper;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.MappingMongoConverter;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.mapping.MongoMappingContext;<br><br><span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@author</span> winterchen</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@version</span> 1.0</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@date</span> 2020/12/2 3:51 下午</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@description</span> 业务mongo数据源</span><br><span class=\"hljs-comment\"> **/</span><br><span class=\"hljs-meta\">@Configuration</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">BusinessMongoConfig</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractMongoConfiguration</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;spring.data.mongodb.uri&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String uri;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;spring.data.mongodb.database&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String database;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> String <span class=\"hljs-title\">getDatabaseName</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> database;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoClient <span class=\"hljs-title\">mongoClient</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        MongoClientURI mongoClientURI = <span class=\"hljs-keyword\">new</span> MongoClientURI(uri);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoClient(mongoClientURI);<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Primary</span><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"mongoMappingContext\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoMappingContext <span class=\"hljs-title\">mongoMappingContext</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        MongoMappingContext mappingContext = <span class=\"hljs-keyword\">new</span> MongoMappingContext();<br>        <span class=\"hljs-keyword\">return</span> mappingContext;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Primary</span><br>    <span class=\"hljs-meta\">@Bean</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoTransactionManager <span class=\"hljs-title\">transactionManager</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"mongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoTransactionManager(mongoDbFactory);<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Primary</span><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"mongoDbFactory\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoDbFactory <span class=\"hljs-title\">mongoDbFactory</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> SimpleMongoDbFactory(mongoClient(), getDatabaseName());<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Primary</span><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"mappingMongoConverter\"</span>) <span class=\"hljs-comment\">//使用自定义的typeMapper去除写入mongodb时的“_class”字段</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MappingMongoConverter <span class=\"hljs-title\">mappingMongoConverter</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"mongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class=\"hljs-function\">                                                       @<span class=\"hljs-title\">Qualifier</span><span class=\"hljs-params\">(<span class=\"hljs-string\">\"mongoMappingContext\"</span>)</span> MongoMappingContext mongoMappingContext) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        DefaultDbRefResolver dbRefResolver = <span class=\"hljs-keyword\">new</span> DefaultDbRefResolver(mongoDbFactory);<br>        MappingMongoConverter converter = <span class=\"hljs-keyword\">new</span> MappingMongoConverter(dbRefResolver, mongoMappingContext);<br>        converter.setTypeMapper(<span class=\"hljs-keyword\">new</span> DefaultMongoTypeMapper(<span class=\"hljs-keyword\">null</span>));<br>        <span class=\"hljs-keyword\">return</span> converter;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Primary</span><br>    <span class=\"hljs-meta\">@Bean</span>(name = <span class=\"hljs-string\">\"mongoTemplate\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoTemplate <span class=\"hljs-title\">getMongoTemplate</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"mongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class=\"hljs-function\">                                          @<span class=\"hljs-title\">Qualifier</span><span class=\"hljs-params\">(<span class=\"hljs-string\">\"mappingMongoConverter\"</span>)</span> MappingMongoConverter mappingMongoConverter) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoTemplate(mongoDbFactory, mappingMongoConverter);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>第二数据源</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">package</span> com.winterchen.label.service.configuration;<br><br><span class=\"hljs-keyword\">import</span> com.mongodb.MongoClient;<br><span class=\"hljs-keyword\">import</span> com.mongodb.MongoClientURI;<br><span class=\"hljs-keyword\">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class=\"hljs-keyword\">import</span> org.springframework.beans.factory.annotation.Value;<br><span class=\"hljs-keyword\">import</span> org.springframework.context.annotation.Bean;<br><span class=\"hljs-keyword\">import</span> org.springframework.context.annotation.Configuration;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.MongoDbFactory;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.MongoTransactionManager;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.config.AbstractMongoConfiguration;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.MongoTemplate;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.SimpleMongoDbFactory;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.DefaultDbRefResolver;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.DefaultMongoTypeMapper;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.MappingMongoConverter;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.mapping.MongoMappingContext;<br><br><span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@author</span> winterchen</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@version</span> 1.0</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@date</span> 2020/12/2 3:53 下午</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@description</span> TODO</span><br><span class=\"hljs-comment\"> **/</span><br><span class=\"hljs-meta\">@Configuration</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">TargetMongoConfig</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractMongoConfiguration</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;spring.data.mongodb-target.uri&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String uri;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;spring.data.mongodb-target.database&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String database;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> String <span class=\"hljs-title\">getDatabaseName</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> database;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoClient <span class=\"hljs-title\">mongoClient</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        MongoClientURI mongoClientURI = <span class=\"hljs-keyword\">new</span> MongoClientURI(uri);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoClient(mongoClientURI);<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"targetMongoMappingContext\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoMappingContext <span class=\"hljs-title\">mongoMappingContext</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        MongoMappingContext mappingContext = <span class=\"hljs-keyword\">new</span> MongoMappingContext();<br>        <span class=\"hljs-keyword\">return</span> mappingContext;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"TARGET_MONGO_TRANSACTION_MANAGER\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoTransactionManager <span class=\"hljs-title\">transactionManager</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"targetMongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoTransactionManager(mongoDbFactory);<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"targetMongoDbFactory\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoDbFactory <span class=\"hljs-title\">mongoDbFactory</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> SimpleMongoDbFactory(mongoClient(), getDatabaseName());<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"targetMappingMongoConverter\"</span>) <span class=\"hljs-comment\">//使用自定义的typeMapper去除写入mongodb时的“_class”字段</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MappingMongoConverter <span class=\"hljs-title\">mappingMongoConverter</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"targetMongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class=\"hljs-function\">                                                       @<span class=\"hljs-title\">Qualifier</span><span class=\"hljs-params\">(<span class=\"hljs-string\">\"targetMongoMappingContext\"</span>)</span> MongoMappingContext mongoMappingContext) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        DefaultDbRefResolver dbRefResolver = <span class=\"hljs-keyword\">new</span> DefaultDbRefResolver(mongoDbFactory);<br>        MappingMongoConverter converter = <span class=\"hljs-keyword\">new</span> MappingMongoConverter(dbRefResolver, mongoMappingContext);<br>        converter.setTypeMapper(<span class=\"hljs-keyword\">new</span> DefaultMongoTypeMapper(<span class=\"hljs-keyword\">null</span>));<br>        <span class=\"hljs-keyword\">return</span> converter;<br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * MongoTemplate实现</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@Bean</span>(name = <span class=\"hljs-string\">\"targetMongoTemplate\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoTemplate <span class=\"hljs-title\">getMongoTemplate</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"targetMongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class=\"hljs-function\">                                          @<span class=\"hljs-title\">Qualifier</span><span class=\"hljs-params\">(<span class=\"hljs-string\">\"mappingMongoConverter\"</span>)</span> MappingMongoConverter mappingMongoConverter) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoTemplate(mongoDbFactory, mappingMongoConverter);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p>默认的使用：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Autowired</span><br>  <span class=\"hljs-keyword\">private</span> MongoTemplate mongoTemplate;<br></code></pre></td></tr></table></figure>\n\n<p>使用另一个数据源，只需要指定名称即可:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Autowired</span><br>  <span class=\"hljs-meta\">@Qualifier</span>(<span class=\"hljs-string\">\"targetMongoTemplate\"</span>)<br>  <span class=\"hljs-keyword\">private</span> MongoTemplate targetMongoTemplate;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"事务\"><a href=\"#事务\" class=\"headerlink\" title=\"事务\"></a>事务</h2><p>普通的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Throwable<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span><br></code></pre></td></tr></table></figure>\n\n<p>其他数据源指定事务管理器即可</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Throwable<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>, <span class=\"hljs-title\">transactionManager</span> </span>= <span class=\"hljs-string\">\"TARGET_MONGO_TRANSACTION_MANAGER\"</span>)<br></code></pre></td></tr></table></figure>\n\n<p>注意：两种事务不能混合使用</p>\n","more":"<blockquote>\n<p>题图：我的家乡，拍摄于2020年初疫情期间</p>\n</blockquote>\n<h2 id=\"maven坐标\"><a href=\"#maven坐标\" class=\"headerlink\" title=\"maven坐标\"></a>maven坐标</h2><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>2.1.13.RELEASE<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"多数据源配置\"><a href=\"#多数据源配置\" class=\"headerlink\" title=\"多数据源配置\"></a>多数据源配置</h2><p>配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">data:</span><br>    <span class=\"hljs-attr\">mongodb:</span><br>      <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">mongodb://192.168.150.154:17017</span><br>      <span class=\"hljs-attr\">database:</span> <span class=\"hljs-string\">ewell-label</span><br>    <span class=\"hljs-attr\">mongodb-target:</span><br>      <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">mongodb://192.168.150.154:17017</span><br>      <span class=\"hljs-attr\">database:</span> <span class=\"hljs-string\">ewell-label-target</span><br></code></pre></td></tr></table></figure>\n\n<p>java配置：</p>\n<p>主数据源：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">package</span> com.winterchen.label.service.configuration;<br><br><span class=\"hljs-keyword\">import</span> com.mongodb.MongoClient;<br><span class=\"hljs-keyword\">import</span> com.mongodb.MongoClientURI;<br><span class=\"hljs-keyword\">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class=\"hljs-keyword\">import</span> org.springframework.beans.factory.annotation.Value;<br><span class=\"hljs-keyword\">import</span> org.springframework.context.annotation.Bean;<br><span class=\"hljs-keyword\">import</span> org.springframework.context.annotation.Configuration;<br><span class=\"hljs-keyword\">import</span> org.springframework.context.annotation.Primary;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.MongoDbFactory;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.MongoTransactionManager;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.config.AbstractMongoConfiguration;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.MongoTemplate;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.SimpleMongoDbFactory;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.DefaultDbRefResolver;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.DefaultMongoTypeMapper;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.MappingMongoConverter;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.mapping.MongoMappingContext;<br><br><span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@author</span> winterchen</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@version</span> 1.0</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@date</span> 2020/12/2 3:51 下午</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@description</span> 业务mongo数据源</span><br><span class=\"hljs-comment\"> **/</span><br><span class=\"hljs-meta\">@Configuration</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">BusinessMongoConfig</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractMongoConfiguration</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;spring.data.mongodb.uri&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String uri;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;spring.data.mongodb.database&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String database;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> String <span class=\"hljs-title\">getDatabaseName</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> database;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoClient <span class=\"hljs-title\">mongoClient</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        MongoClientURI mongoClientURI = <span class=\"hljs-keyword\">new</span> MongoClientURI(uri);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoClient(mongoClientURI);<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Primary</span><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"mongoMappingContext\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoMappingContext <span class=\"hljs-title\">mongoMappingContext</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        MongoMappingContext mappingContext = <span class=\"hljs-keyword\">new</span> MongoMappingContext();<br>        <span class=\"hljs-keyword\">return</span> mappingContext;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Primary</span><br>    <span class=\"hljs-meta\">@Bean</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoTransactionManager <span class=\"hljs-title\">transactionManager</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"mongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoTransactionManager(mongoDbFactory);<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Primary</span><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"mongoDbFactory\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoDbFactory <span class=\"hljs-title\">mongoDbFactory</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> SimpleMongoDbFactory(mongoClient(), getDatabaseName());<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Primary</span><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"mappingMongoConverter\"</span>) <span class=\"hljs-comment\">//使用自定义的typeMapper去除写入mongodb时的“_class”字段</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MappingMongoConverter <span class=\"hljs-title\">mappingMongoConverter</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"mongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class=\"hljs-function\">                                                       @<span class=\"hljs-title\">Qualifier</span><span class=\"hljs-params\">(<span class=\"hljs-string\">\"mongoMappingContext\"</span>)</span> MongoMappingContext mongoMappingContext) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        DefaultDbRefResolver dbRefResolver = <span class=\"hljs-keyword\">new</span> DefaultDbRefResolver(mongoDbFactory);<br>        MappingMongoConverter converter = <span class=\"hljs-keyword\">new</span> MappingMongoConverter(dbRefResolver, mongoMappingContext);<br>        converter.setTypeMapper(<span class=\"hljs-keyword\">new</span> DefaultMongoTypeMapper(<span class=\"hljs-keyword\">null</span>));<br>        <span class=\"hljs-keyword\">return</span> converter;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Primary</span><br>    <span class=\"hljs-meta\">@Bean</span>(name = <span class=\"hljs-string\">\"mongoTemplate\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoTemplate <span class=\"hljs-title\">getMongoTemplate</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"mongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class=\"hljs-function\">                                          @<span class=\"hljs-title\">Qualifier</span><span class=\"hljs-params\">(<span class=\"hljs-string\">\"mappingMongoConverter\"</span>)</span> MappingMongoConverter mappingMongoConverter) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoTemplate(mongoDbFactory, mappingMongoConverter);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>第二数据源</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">package</span> com.winterchen.label.service.configuration;<br><br><span class=\"hljs-keyword\">import</span> com.mongodb.MongoClient;<br><span class=\"hljs-keyword\">import</span> com.mongodb.MongoClientURI;<br><span class=\"hljs-keyword\">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class=\"hljs-keyword\">import</span> org.springframework.beans.factory.annotation.Value;<br><span class=\"hljs-keyword\">import</span> org.springframework.context.annotation.Bean;<br><span class=\"hljs-keyword\">import</span> org.springframework.context.annotation.Configuration;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.MongoDbFactory;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.MongoTransactionManager;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.config.AbstractMongoConfiguration;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.MongoTemplate;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.SimpleMongoDbFactory;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.DefaultDbRefResolver;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.DefaultMongoTypeMapper;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.convert.MappingMongoConverter;<br><span class=\"hljs-keyword\">import</span> org.springframework.data.mongodb.core.mapping.MongoMappingContext;<br><br><span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@author</span> winterchen</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@version</span> 1.0</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@date</span> 2020/12/2 3:53 下午</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@description</span> TODO</span><br><span class=\"hljs-comment\"> **/</span><br><span class=\"hljs-meta\">@Configuration</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">TargetMongoConfig</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractMongoConfiguration</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;spring.data.mongodb-target.uri&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String uri;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;spring.data.mongodb-target.database&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String database;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> String <span class=\"hljs-title\">getDatabaseName</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> database;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoClient <span class=\"hljs-title\">mongoClient</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        MongoClientURI mongoClientURI = <span class=\"hljs-keyword\">new</span> MongoClientURI(uri);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoClient(mongoClientURI);<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"targetMongoMappingContext\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoMappingContext <span class=\"hljs-title\">mongoMappingContext</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        MongoMappingContext mappingContext = <span class=\"hljs-keyword\">new</span> MongoMappingContext();<br>        <span class=\"hljs-keyword\">return</span> mappingContext;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"TARGET_MONGO_TRANSACTION_MANAGER\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoTransactionManager <span class=\"hljs-title\">transactionManager</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"targetMongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoTransactionManager(mongoDbFactory);<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"targetMongoDbFactory\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoDbFactory <span class=\"hljs-title\">mongoDbFactory</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> SimpleMongoDbFactory(mongoClient(), getDatabaseName());<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Bean</span>(<span class=\"hljs-string\">\"targetMappingMongoConverter\"</span>) <span class=\"hljs-comment\">//使用自定义的typeMapper去除写入mongodb时的“_class”字段</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MappingMongoConverter <span class=\"hljs-title\">mappingMongoConverter</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"targetMongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class=\"hljs-function\">                                                       @<span class=\"hljs-title\">Qualifier</span><span class=\"hljs-params\">(<span class=\"hljs-string\">\"targetMongoMappingContext\"</span>)</span> MongoMappingContext mongoMappingContext) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        DefaultDbRefResolver dbRefResolver = <span class=\"hljs-keyword\">new</span> DefaultDbRefResolver(mongoDbFactory);<br>        MappingMongoConverter converter = <span class=\"hljs-keyword\">new</span> MappingMongoConverter(dbRefResolver, mongoMappingContext);<br>        converter.setTypeMapper(<span class=\"hljs-keyword\">new</span> DefaultMongoTypeMapper(<span class=\"hljs-keyword\">null</span>));<br>        <span class=\"hljs-keyword\">return</span> converter;<br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * MongoTemplate实现</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@Bean</span>(name = <span class=\"hljs-string\">\"targetMongoTemplate\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> MongoTemplate <span class=\"hljs-title\">getMongoTemplate</span><span class=\"hljs-params\">(@Qualifier(<span class=\"hljs-string\">\"targetMongoDbFactory\"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class=\"hljs-function\">                                          @<span class=\"hljs-title\">Qualifier</span><span class=\"hljs-params\">(<span class=\"hljs-string\">\"mappingMongoConverter\"</span>)</span> MappingMongoConverter mappingMongoConverter) <span class=\"hljs-keyword\">throws</span> Exception </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> MongoTemplate(mongoDbFactory, mappingMongoConverter);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p>默认的使用：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Autowired</span><br>  <span class=\"hljs-keyword\">private</span> MongoTemplate mongoTemplate;<br></code></pre></td></tr></table></figure>\n\n<p>使用另一个数据源，只需要指定名称即可:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Autowired</span><br>  <span class=\"hljs-meta\">@Qualifier</span>(<span class=\"hljs-string\">\"targetMongoTemplate\"</span>)<br>  <span class=\"hljs-keyword\">private</span> MongoTemplate targetMongoTemplate;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"事务\"><a href=\"#事务\" class=\"headerlink\" title=\"事务\"></a>事务</h2><p>普通的：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Throwable<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span><br></code></pre></td></tr></table></figure>\n\n<p>其他数据源指定事务管理器即可</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Throwable<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>, <span class=\"hljs-title\">transactionManager</span> </span>= <span class=\"hljs-string\">\"TARGET_MONGO_TRANSACTION_MANAGER\"</span>)<br></code></pre></td></tr></table></figure>\n\n<p>注意：两种事务不能混合使用</p>\n","categories":[{"name":"mongodb","path":"api/categories/mongodb.json"}],"tags":[{"name":"springboot","path":"api/tags/springboot.json"},{"name":"mongodb","path":"api/tags/mongodb.json"},{"name":"mongotemplate","path":"api/tags/mongotemplate.json"},{"name":"transactional","path":"api/tags/transactional.json"}]}