{"title":"当springMVC上下文尚未初始化的时候如何@Autowired注入对象呢？","slug":"spring-autowired","date":"2018-05-30T01:45:00.000Z","updated":"2022-12-01T01:32:39.787Z","comments":true,"path":"api/articles/spring-autowired.json","excerpt":" [Figure] 一个问题困扰了我一天，场景是这样的：公司有一个独立的SSO用户权限验证中心，我负责的是公司的一个其他的独立项目；每次用户session过期或者未登录的时候跳统一登录页面；用户成功登录之后都会回调，回调的信息中有用户的userAccount；此时需要根据用户的userAccount获取用户的详细信息；权限系统提供了一个获取用户的接口；","covers":["data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="],"cover":"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046776553776.jpg","content":"<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046776701619.jpg\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>一个问题困扰了我一天，场景是这样的：</p>\n<ul>\n<li>公司有一个独立的SSO用户权限验证中心，我负责的是公司的一个其他的独立项目；</li>\n<li>每次用户session过期或者未登录的时候跳统一登录页面；</li>\n<li>用户成功登录之后都会回调，回调的信息中有用户的userAccount；</li>\n<li>此时需要根据用户的userAccount获取用户的详细信息；</li>\n<li>权限系统提供了一个获取用户的接口；<a id=\"more\"></a>\n\n</li>\n</ul>\n<p>遇到的问题：</p>\n<ul>\n<li>使用的是shrio进行系统权限的控制，当用户在SSO登录页面成功登录之后会回调到shrio的配置类中；</li>\n<li>需要在shrio的配置类中调用根据用户账号获取用户信息的接口：</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">IecWepmShiroAuthService</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractShiroAuthService</span>&lt;<span class=\"hljs-title\">SessionUser</span>&gt; <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">EnvironmentAware</span> </span>&#123;<br><br>\t<span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> TenantUserCloudService tenantUserCloudService;<br>&#125;<br>```\t<br><br>调用的就是这么一个接口<br><br>```java<br><span class=\"hljs-meta\">@CloudServiceClient</span>(<span class=\"hljs-string\">\"gap-service-tenant-auth\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">TenantUserCloudService</span> </span>&#123;<br><br>\t<span class=\"hljs-meta\">@RequestMapping</span>(<br>        value = &#123;<span class=\"hljs-string\">\"/tenant/user/by-emp-no\"</span>&#125;,<br>        method = &#123;RequestMethod.GET&#125;<br>    )<br>    <span class=\"hljs-function\">APIResponse&lt;TenantUser&gt; <span class=\"hljs-title\">getTenantUserByEmpNo</span><span class=\"hljs-params\">(@RequestParam(name = <span class=\"hljs-string\">\"tenantId\"</span>,required = <span class=\"hljs-keyword\">true</span>)</span> Integer var1, @<span class=\"hljs-title\">RequestParam</span><span class=\"hljs-params\">(name = <span class=\"hljs-string\">\"empNo\"</span>,required = <span class=\"hljs-keyword\">true</span>)</span> String var2)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>如果按照下面的代码进行注入，那么由于shrio的初始化要先与springMVC，所以导致找不到相关处理的类；</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><br><span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> TenantUserCloudService tenantUserCloudService;<br></code></pre></td></tr></table></figure>\n\n<p>解决的思路就是：</p>\n<ul>\n<li>首先不进行<code>tenantUserCloudService</code>的初始化，只有在调用该接口的时候进行初始化；</li>\n<li>创建一个类实现<code>ApplicationContextAware</code>接口，实现这个接口可以很方便的从spring容器中获取bean；</li>\n<li>机制就是<strong>当调用这个接口的时候才从spring容器中获取这个bean</strong>；</li>\n</ul>\n<p>创建一个类实现<code>ApplicationContextAware</code>接口：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-comment\">//相当于给一个bean进行代理</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">DelegateBean</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">ApplicationContextAware</span> </span>&#123;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> Logger logger = LoggerFactory.getLogger(DelegateBean<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span>;<br>    <span class=\"hljs-keyword\">protected</span> ApplicationContext applicationContext;<br>    <span class=\"hljs-keyword\">protected</span> Object target;<br>    <span class=\"hljs-keyword\">protected</span> String targetBeanName;<br>    <span class=\"hljs-keyword\">protected</span> Class targetBeanType;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DelegateBean</span><span class=\"hljs-params\">(String targetBeanName)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.targetBeanName = targetBeanName;<br>    &#125;<br>\t<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DelegateBean</span><span class=\"hljs-params\">(Class targetBeanType)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.targetBeanType = targetBeanType;<br>    &#125;<br>\t<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DelegateBean</span><span class=\"hljs-params\">(ApplicationContext applicationContext, String targetBeanName)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.applicationContext = applicationContext;<br>        <span class=\"hljs-keyword\">this</span>.targetBeanName = targetBeanName;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DelegateBean</span><span class=\"hljs-params\">(ApplicationContext applicationContext, Class targetBeanType)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.applicationContext = applicationContext;<br>        <span class=\"hljs-keyword\">this</span>.targetBeanType = targetBeanType;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">setApplicationContext</span><span class=\"hljs-params\">(ApplicationContext applicationContext)</span> <span class=\"hljs-keyword\">throws</span> BeansException </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.applicationContext = applicationContext;<br>    &#125;<br>\t<span class=\"hljs-comment\">//当调用这个方法的时候才从spring容器中获取bean；</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Object <span class=\"hljs-title\">target</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        Assert.notNull(<span class=\"hljs-keyword\">this</span>.applicationContext, <span class=\"hljs-string\">\"A DelegateBean should be managed by ApplicationContext or pass ApplicationContext though constructor arg\"</span>);<br>        <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-keyword\">this</span>.target == <span class=\"hljs-keyword\">null</span>) &#123;<br>            <span class=\"hljs-keyword\">synchronized</span>(<span class=\"hljs-keyword\">this</span>) &#123;<br>                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.target != <span class=\"hljs-keyword\">null</span>?<span class=\"hljs-keyword\">this</span>.target:(<span class=\"hljs-keyword\">this</span>.target = <span class=\"hljs-keyword\">this</span>.doGetBeanFromApplicationContext());<br>            &#125;<br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.target;<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> Object <span class=\"hljs-title\">doGetBeanFromApplicationContext</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.targetBeanName != <span class=\"hljs-keyword\">null</span>?<span class=\"hljs-keyword\">this</span>.applicationContext.getBean(<span class=\"hljs-keyword\">this</span>.targetBeanName):(<span class=\"hljs-keyword\">this</span>.targetBeanType != <span class=\"hljs-keyword\">null</span>?<span class=\"hljs-keyword\">this</span>.applicationContext.getBean(<span class=\"hljs-keyword\">this</span>.targetBeanType):<span class=\"hljs-keyword\">null</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>只是这样配置还是不够的，我们需要在spring初始化的时候将这个代理bean交给spring容器进行管理；</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Configuration</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">IecWepmAutoConfiguration</span></span>&#123;<br><br>\t<span class=\"hljs-meta\">@Bean</span><br>    <span class=\"hljs-meta\">@Qualifier</span>(<span class=\"hljs-string\">\"tenantUserCloudService\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> DelegateBean <span class=\"hljs-title\">tenantUserCloudService</span><span class=\"hljs-params\">()</span></span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> DelegateBean(TenantUserCloudService<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>然后再shrio的类中我们需要进行这样的使用：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">IecWepmShiroAuthService</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractShiroAuthService</span>&lt;<span class=\"hljs-title\">SessionUser</span>&gt; <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">EnvironmentAware</span> </span>&#123;<br>\t<span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-meta\">@Qualifier</span>(<span class=\"hljs-string\">\"tenantUserCloudService\"</span>)<br>    <span class=\"hljs-keyword\">private</span> DelegateBean tenantUserCloudService;<br>\t<br>\t<span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> SessionUser <span class=\"hljs-title\">doLogin</span><span class=\"hljs-params\">(String userAccount, String userPwd)</span> </span>&#123;<br>        <br>        <span class=\"hljs-comment\">//根据用户编号获取用户信息,调用target()是关键，只有在调用这个方法的时候才会从spring容器中获取信息</span><br>        APIResponse&lt;TenantUser&gt; tenantUserByEmpNo = ((TenantUserCloudService) tenantUserCloudService.target())<br>                .getTenantUserByEmpNo(TENANT_ID, userAccount);<br>        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-string\">\"success\"</span>.equals(tenantUserByEmpNo.getCode()) &amp;&amp; <span class=\"hljs-keyword\">null</span> != tenantUserByEmpNo.getData())&#123;<br>            userAccount = tenantUserByEmpNo.getData().getDomainAccountList().get(<span class=\"hljs-number\">0</span>).getDomainAccount();<br>        &#125;<br>        UserInfoDto userInfo = userService.getUserByAccount(userAccount);<br>        SessionUser sessionUser = <span class=\"hljs-keyword\">new</span> SessionUser();<br>        sessionUser.setUserId(Integer.valueOf(userAccount));<br>        AuthUtils.setSessionUser(sessionUser);<br>        <span class=\"hljs-comment\">// todo 返回的SessionUser 就是保存在session里的对象 通过 SessionUser sessionUser = (SessionUser) AuthUtils.getSessionUser(); 进行获取</span><br>        <span class=\"hljs-keyword\">return</span> sessionUser;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n\n<p>关键： <strong>以上的思路最主要的就是，在shrio初始化的时候仅仅只是初始化一个空壳，只有当使用那个bean的时候才从spring容器中获取bean并且注入，这样的好处就是当当前bean的声明周期还未开始的时候预留一个位置，当使用的时候才从spring容器中注入，这样不会导致项目启动的时候就会找不到bean</strong>；</p>\n","more":"</li>\n</ul>\n<p>遇到的问题：</p>\n<ul>\n<li>使用的是shrio进行系统权限的控制，当用户在SSO登录页面成功登录之后会回调到shrio的配置类中；</li>\n<li>需要在shrio的配置类中调用根据用户账号获取用户信息的接口：</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">IecWepmShiroAuthService</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractShiroAuthService</span>&lt;<span class=\"hljs-title\">SessionUser</span>&gt; <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">EnvironmentAware</span> </span>&#123;<br><br>\t<span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> TenantUserCloudService tenantUserCloudService;<br>&#125;<br>```\t<br><br>调用的就是这么一个接口<br><br>```java<br><span class=\"hljs-meta\">@CloudServiceClient</span>(<span class=\"hljs-string\">\"gap-service-tenant-auth\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">TenantUserCloudService</span> </span>&#123;<br><br>\t<span class=\"hljs-meta\">@RequestMapping</span>(<br>        value = &#123;<span class=\"hljs-string\">\"/tenant/user/by-emp-no\"</span>&#125;,<br>        method = &#123;RequestMethod.GET&#125;<br>    )<br>    <span class=\"hljs-function\">APIResponse&lt;TenantUser&gt; <span class=\"hljs-title\">getTenantUserByEmpNo</span><span class=\"hljs-params\">(@RequestParam(name = <span class=\"hljs-string\">\"tenantId\"</span>,required = <span class=\"hljs-keyword\">true</span>)</span> Integer var1, @<span class=\"hljs-title\">RequestParam</span><span class=\"hljs-params\">(name = <span class=\"hljs-string\">\"empNo\"</span>,required = <span class=\"hljs-keyword\">true</span>)</span> String var2)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>如果按照下面的代码进行注入，那么由于shrio的初始化要先与springMVC，所以导致找不到相关处理的类；</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><br><span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> TenantUserCloudService tenantUserCloudService;<br></code></pre></td></tr></table></figure>\n\n<p>解决的思路就是：</p>\n<ul>\n<li>首先不进行<code>tenantUserCloudService</code>的初始化，只有在调用该接口的时候进行初始化；</li>\n<li>创建一个类实现<code>ApplicationContextAware</code>接口，实现这个接口可以很方便的从spring容器中获取bean；</li>\n<li>机制就是<strong>当调用这个接口的时候才从spring容器中获取这个bean</strong>；</li>\n</ul>\n<p>创建一个类实现<code>ApplicationContextAware</code>接口：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-comment\">//相当于给一个bean进行代理</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">DelegateBean</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">ApplicationContextAware</span> </span>&#123;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> Logger logger = LoggerFactory.getLogger(DelegateBean<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span>;<br>    <span class=\"hljs-keyword\">protected</span> ApplicationContext applicationContext;<br>    <span class=\"hljs-keyword\">protected</span> Object target;<br>    <span class=\"hljs-keyword\">protected</span> String targetBeanName;<br>    <span class=\"hljs-keyword\">protected</span> Class targetBeanType;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DelegateBean</span><span class=\"hljs-params\">(String targetBeanName)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.targetBeanName = targetBeanName;<br>    &#125;<br>\t<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DelegateBean</span><span class=\"hljs-params\">(Class targetBeanType)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.targetBeanType = targetBeanType;<br>    &#125;<br>\t<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DelegateBean</span><span class=\"hljs-params\">(ApplicationContext applicationContext, String targetBeanName)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.applicationContext = applicationContext;<br>        <span class=\"hljs-keyword\">this</span>.targetBeanName = targetBeanName;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">DelegateBean</span><span class=\"hljs-params\">(ApplicationContext applicationContext, Class targetBeanType)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.applicationContext = applicationContext;<br>        <span class=\"hljs-keyword\">this</span>.targetBeanType = targetBeanType;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">setApplicationContext</span><span class=\"hljs-params\">(ApplicationContext applicationContext)</span> <span class=\"hljs-keyword\">throws</span> BeansException </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.applicationContext = applicationContext;<br>    &#125;<br>\t<span class=\"hljs-comment\">//当调用这个方法的时候才从spring容器中获取bean；</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Object <span class=\"hljs-title\">target</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        Assert.notNull(<span class=\"hljs-keyword\">this</span>.applicationContext, <span class=\"hljs-string\">\"A DelegateBean should be managed by ApplicationContext or pass ApplicationContext though constructor arg\"</span>);<br>        <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-keyword\">this</span>.target == <span class=\"hljs-keyword\">null</span>) &#123;<br>            <span class=\"hljs-keyword\">synchronized</span>(<span class=\"hljs-keyword\">this</span>) &#123;<br>                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.target != <span class=\"hljs-keyword\">null</span>?<span class=\"hljs-keyword\">this</span>.target:(<span class=\"hljs-keyword\">this</span>.target = <span class=\"hljs-keyword\">this</span>.doGetBeanFromApplicationContext());<br>            &#125;<br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.target;<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> Object <span class=\"hljs-title\">doGetBeanFromApplicationContext</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.targetBeanName != <span class=\"hljs-keyword\">null</span>?<span class=\"hljs-keyword\">this</span>.applicationContext.getBean(<span class=\"hljs-keyword\">this</span>.targetBeanName):(<span class=\"hljs-keyword\">this</span>.targetBeanType != <span class=\"hljs-keyword\">null</span>?<span class=\"hljs-keyword\">this</span>.applicationContext.getBean(<span class=\"hljs-keyword\">this</span>.targetBeanType):<span class=\"hljs-keyword\">null</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>只是这样配置还是不够的，我们需要在spring初始化的时候将这个代理bean交给spring容器进行管理；</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Configuration</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">IecWepmAutoConfiguration</span></span>&#123;<br><br>\t<span class=\"hljs-meta\">@Bean</span><br>    <span class=\"hljs-meta\">@Qualifier</span>(<span class=\"hljs-string\">\"tenantUserCloudService\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> DelegateBean <span class=\"hljs-title\">tenantUserCloudService</span><span class=\"hljs-params\">()</span></span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> DelegateBean(TenantUserCloudService<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>然后再shrio的类中我们需要进行这样的使用：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">IecWepmShiroAuthService</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractShiroAuthService</span>&lt;<span class=\"hljs-title\">SessionUser</span>&gt; <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">EnvironmentAware</span> </span>&#123;<br>\t<span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-meta\">@Qualifier</span>(<span class=\"hljs-string\">\"tenantUserCloudService\"</span>)<br>    <span class=\"hljs-keyword\">private</span> DelegateBean tenantUserCloudService;<br>\t<br>\t<span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> SessionUser <span class=\"hljs-title\">doLogin</span><span class=\"hljs-params\">(String userAccount, String userPwd)</span> </span>&#123;<br>        <br>        <span class=\"hljs-comment\">//根据用户编号获取用户信息,调用target()是关键，只有在调用这个方法的时候才会从spring容器中获取信息</span><br>        APIResponse&lt;TenantUser&gt; tenantUserByEmpNo = ((TenantUserCloudService) tenantUserCloudService.target())<br>                .getTenantUserByEmpNo(TENANT_ID, userAccount);<br>        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-string\">\"success\"</span>.equals(tenantUserByEmpNo.getCode()) &amp;&amp; <span class=\"hljs-keyword\">null</span> != tenantUserByEmpNo.getData())&#123;<br>            userAccount = tenantUserByEmpNo.getData().getDomainAccountList().get(<span class=\"hljs-number\">0</span>).getDomainAccount();<br>        &#125;<br>        UserInfoDto userInfo = userService.getUserByAccount(userAccount);<br>        SessionUser sessionUser = <span class=\"hljs-keyword\">new</span> SessionUser();<br>        sessionUser.setUserId(Integer.valueOf(userAccount));<br>        AuthUtils.setSessionUser(sessionUser);<br>        <span class=\"hljs-comment\">// todo 返回的SessionUser 就是保存在session里的对象 通过 SessionUser sessionUser = (SessionUser) AuthUtils.getSessionUser(); 进行获取</span><br>        <span class=\"hljs-keyword\">return</span> sessionUser;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n\n<p>关键： <strong>以上的思路最主要的就是，在shrio初始化的时候仅仅只是初始化一个空壳，只有当使用那个bean的时候才从spring容器中获取bean并且注入，这样的好处就是当当前bean的声明周期还未开始的时候预留一个位置，当使用的时候才从spring容器中注入，这样不会导致项目启动的时候就会找不到bean</strong>；</p>","categories":[{"name":"spring","path":"api/categories/spring.json"}],"tags":[{"name":"spring","path":"api/tags/spring.json"}]}