{"title":"SpringCloud系列教程(八)之整合seata分布式事务","slug":"2021-11-09-spring-cloud-hoxton-8-seata","date":"2021-11-09T01:40:00.000Z","updated":"2022-12-01T01:32:39.787Z","comments":true,"path":"api/articles/2021-11-09-spring-cloud-hoxton-8-seata.json","excerpt":null,"covers":["data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==","data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="],"cover":"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109105218.jpg","content":"<blockquote>\n<p>阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<blockquote>\n<p>两个月没有更新了，这次趁着刷技术文章的机会，把目前比较热门的分布式事务框架seata整合一下，分布式事务的出现是因为微服务导致业务分部在不同的服务中，不能像本地事务一样使用事务。</p>\n</blockquote>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6991635985847025671\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992010061576929310\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(四)之SpringCloud Gateway | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992404611617259534\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(五)之SpringCloud Gateway 网关聚合开发文档 swagger knife4j 和登录权限统一验证</a></li>\n<li><a href=\"https://juejin.cn/post/6992404611617259534\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(六)之SpringCloud 使用sentinel作为熔断器</a></li>\n<li><a href=\"https://juejin.cn/post/6993124554428121096\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(七)之使用Spring Cloud Sleuth+Zipkin实现链路追踪</a></li>\n</ul>\n<h2 id=\"什么是seata？\"><a href=\"#什么是seata？\" class=\"headerlink\" title=\"什么是seata？\"></a>什么是seata？</h2><p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p>\n<p>关于更多的原理可以参考官方文档，这里就不赘述了：<a href=\"http://seata.io/zh-cn/docs/overview/what-is-seata.html\" target=\"_blank\" rel=\"noopener\">Seata 是什么</a></p>\n<h2 id=\"下载安装seata-server\"><a href=\"#下载安装seata-server\" class=\"headerlink\" title=\"下载安装seata-server\"></a>下载安装seata-server</h2><h3 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h3><p>下载地址：<a href=\"https://github.com/seata/seata/releases\" target=\"_blank\" rel=\"noopener\">Releases · seata/seata (github.com)</a></p>\n<p>window下载zip，linux/mac下载tar.gz</p>\n<blockquote>\n<p>注意：如何安装nacos请看这：<a href=\"https://nacos.io/zh-cn/docs/quick-start.html\" target=\"_blank\" rel=\"noopener\">Nacos 快速入门</a>，建议查看前面的文章以做到丝滑入戏。</p>\n</blockquote>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><p>解压之后修改配置文件registry.conf（这里主要是配置nacos作为配置中心）：</p>\n<figure class=\"highlight protobuf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs protobuf\">config &#123;<br>  type = <span class=\"hljs-string\">\"nacos\"</span> ## 这里修改为nacos，并且修改下面对应的配置<br><br>  nacos &#123;<br>    serverAddr = <span class=\"hljs-string\">\"127.0.0.1:8848\"</span><br>    namespace = <span class=\"hljs-string\">\"public\"</span><br>    <span class=\"hljs-keyword\">group</span> = <span class=\"hljs-string\">\"SEATA_GROUP\"</span><br>    username = <span class=\"hljs-string\">\"nacos\"</span><br>    password = <span class=\"hljs-string\">\"nacos\"</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>然后继续修改注册中心（nacos作为注册中心）：</p>\n<figure class=\"highlight protobuf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs protobuf\">registry &#123;<br> <br>  type = <span class=\"hljs-string\">\"nacos\"</span><br><br>  nacos &#123;<br>    application = <span class=\"hljs-string\">\"seata-server\"</span><br>    serverAddr = <span class=\"hljs-string\">\"127.0.0.1:8848\"</span><br>    <span class=\"hljs-keyword\">group</span> = <span class=\"hljs-string\">\"DEFAULT_GROUP\"</span> #这里的<span class=\"hljs-keyword\">group</span>需要与业务服务在一个<span class=\"hljs-keyword\">group</span>内<br>    namespace = <span class=\"hljs-string\">\"public\"</span><br>    cluster = <span class=\"hljs-string\">\"default\"</span><br>    username = <span class=\"hljs-string\">\"nacos\"</span><br>    password = <span class=\"hljs-string\">\"nacos\"</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>本文是以nacos作为注册中心和配置中心的，如果需要其它的方式可以查看官方文档。</p>\n<h3 id=\"上传配置\"><a href=\"#上传配置\" class=\"headerlink\" title=\"上传配置\"></a>上传配置</h3><p>在上传之前先下载对应的配置文件模板</p>\n<ol>\n<li>首先下载config.txt文件：<a href=\"https://github.com/seata/seata/tree/develop/script/config-center\" target=\"_blank\" rel=\"noopener\">seata/script/config-center at develop · seata/seata (github.com)</a> ，将其放入到seata的解压目录下；见图例1</li>\n<li>然后在目录下找到对应的配置中心的目录下的shell脚本，这里使用的是nacos-config.sh <a href=\"https://github.com/seata/seata/tree/develop/script/config-center/nacos\" target=\"_blank\" rel=\"noopener\">seata/script/config-center/nacos at develop · seata/seata (github.com)</a>，将其放入到<code>${SEATA_DIR}/script/config-center/nacos/nacos-config.sh</code> 注意：<code>${SEATA_DIR}</code> 是seata的根目录；见图例2</li>\n<li>到seata的解压根目录下运行 <code>sh script/config-center/nacos/nacos-config.sh -h 127.0.0.1 -p 8848 -g SEATA_GROUP -u nacos -w nacos</code> 注意：nacos-config.sh是第2步下载的脚本文件，见图例3</li>\n</ol>\n<p>图例1：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104117.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例1</span></p>\n<p>图例2：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104139.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例2</span></p>\n<p>图例3：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104156.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例3</span></p>\n<p>图例4：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104216.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例4</span></p>\n<p>在nacos控制台（localhost:8848/nacos，账密：nacos/nacos）：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104233.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>可以看到配置已经成功上传</p>\n<p>具体的配置请查看：<a href=\"https://github.com/seata/seata/blob/develop/script/config-center/config.txt\" target=\"_blank\" rel=\"noopener\">seata/config.txt at develop · seata/seata (github.com)</a></p>\n<p>配置参数官方对照表：<a href=\"http://seata.io/zh-cn/docs/user/configurations.html\" target=\"_blank\" rel=\"noopener\">Seata 参数配置</a></p>\n<p>注意修改对应数据库的配置，可以直接在nacos中修改配置。</p>\n<blockquote>\n<p>有一个比较关键的点，也是很容易出错的点，有一个配置参数单独拿出来讲一下，<br><code>service.vgroupMapping.&lt;你的服务名称&gt;-group=default</code> 这个分组需要seata-server和client都保持一致，当然，seata是可以存在多个事务分组的，比如我们订单业务涉及到库存等等逻辑，那么将这些在同一个事务的服务加入到同一个事务分组内，就如默认的配置文件中设置为：<code>service.vgroupMapping.my_test_tx_group=default</code> 那么我们需要在服务的application.yml中配置该组：</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">seata:</span><br>  <span class=\"hljs-attr\">tx-service-group:</span> <span class=\"hljs-string\">my_test_tx_group</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"启动seata-server：\"><a href=\"#启动seata-server：\" class=\"headerlink\" title=\"启动seata-server：\"></a>启动seata-server：</h2><p>windows：打开控制台：<code>./seata-server.bat -h 127.0.0.1</code></p>\n<p>linux/macos: <code>sh [seata-server.sh](http://seata-server.sh) -h 127.0.0.1</code></p>\n<p>成功启动：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104300.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">成功启动</span></p>\n<p>nacos注册中心：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104319.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">nacos注册中心</span></p>\n<h3 id=\"多种部署方式：\"><a href=\"#多种部署方式：\" class=\"headerlink\" title=\"多种部署方式：\"></a>多种部署方式：</h3><ul>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-by-docker.html\" target=\"_blank\" rel=\"noopener\">使用 Docker 部署 Seata Server</a></li>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-by-kubernetes.html\" target=\"_blank\" rel=\"noopener\">使用 Kubernetes 部署 Seata Server</a></li>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-by-helm.html\" target=\"_blank\" rel=\"noopener\">使用 Helm 部署 Seata Server</a></li>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-ha.html\" target=\"_blank\" rel=\"noopener\">Seata 高可用部署</a></li>\n</ul>\n<h3 id=\"新增seata的数据表：\"><a href=\"#新增seata的数据表：\" class=\"headerlink\" title=\"新增seata的数据表：\"></a>新增seata的数据表：</h3><p>对应的sql文件请查看：<a href=\"https://github.com/seata/seata/tree/1.4.0/script/server/db\" target=\"_blank\" rel=\"noopener\">seata/script/server/db at 1.4.0 · seata/seata (github.com)</a></p>\n<p>下载之后在数据库中新建库：seata，然后将建库脚本导入。</p>\n<h2 id=\"工程改造\"><a href=\"#工程改造\" class=\"headerlink\" title=\"工程改造\"></a>工程改造</h2><h3 id=\"1-复制工程\"><a href=\"#1-复制工程\" class=\"headerlink\" title=\"1.复制工程\"></a>1.复制工程</h3><p>将工程：spring-cloud-nacos-consumer 复制一份，改为：order-server</p>\n<p>将工程：spring-cloud-nacos-provider 复制一份，改为：stock-server</p>\n<p>注意：复制之后需要修改部分pom配置才可以（改为对应的名称）：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>order-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>0.0.1-SNAPSHOT<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">name</span>&gt;</span>order-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">name</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">description</span>&gt;</span>Demo project for Spring Boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">description</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>并且在父pom中加入：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">modules</span>&gt;</span><br>    ...<br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">module</span>&gt;</span>stock-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">module</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">module</span>&gt;</span>order-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">module</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">modules</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>然后重新导入依赖即可</p>\n<p>如果还存在异常，请将.imi文件删除</p>\n<h3 id=\"2-增加依赖\"><a href=\"#2-增加依赖\" class=\"headerlink\" title=\"2.增加依赖\"></a>2.增加依赖</h3><p>在两个工程模块的pom中增加依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-comment\">&lt;!-- seata --&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>io.seata<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>seata-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>1.4.2<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">exclusions</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">exclusion</span>&gt;</span><br>                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>io.seata<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>seata-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">exclusion</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">exclusions</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-修改工程的application-yml配置\"><a href=\"#3-修改工程的application-yml配置\" class=\"headerlink\" title=\"3.修改工程的application.yml配置\"></a>3.修改工程的application.yml配置</h3><p>order-server</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">logging:</span><br>  <span class=\"hljs-attr\">level:</span><br>    <span class=\"hljs-attr\">io:</span><br>      <span class=\"hljs-attr\">seata:</span> <span class=\"hljs-string\">debug</span><br><span class=\"hljs-attr\">seata:</span><br>  <span class=\"hljs-attr\">tx-service-group:</span> <span class=\"hljs-string\">my_test_tx_group</span><br></code></pre></td></tr></table></figure>\n\n<p>stock-server</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">logging:</span><br>  <span class=\"hljs-attr\">level:</span><br>    <span class=\"hljs-attr\">io:</span><br>      <span class=\"hljs-attr\">seata:</span> <span class=\"hljs-string\">debug</span><br><span class=\"hljs-attr\">seata:</span><br>  <span class=\"hljs-attr\">tx-service-group:</span> <span class=\"hljs-string\">my_test_tx_group</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"4-数据库初始化\"><a href=\"#4-数据库初始化\" class=\"headerlink\" title=\"4.数据库初始化\"></a>4.数据库初始化</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-comment\">-- 创建 order库、业务表、undo_log表</span><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">database</span> seata_order;<br><span class=\"hljs-keyword\">use</span> seata_order;<br><br><span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> <span class=\"hljs-string\">`order_tbl`</span>;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`order_tbl`</span> (<br>  <span class=\"hljs-string\">`id`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`user_id`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`commodity_code`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`count`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span>,<br>  <span class=\"hljs-string\">`money`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span>=utf8;<br><br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`undo_log`</span><br>(<br>  <span class=\"hljs-string\">`id`</span>            <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`branch_id`</span>     <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`xid`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`context`</span>       <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">128</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`rollback_info`</span> LONGBLOB     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_status`</span>    <span class=\"hljs-built_in\">INT</span>(<span class=\"hljs-number\">11</span>)      <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_created`</span>   DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_modified`</span>  DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`ext`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>),<br>  <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">KEY</span> <span class=\"hljs-string\">`ux_undo_log`</span> (<span class=\"hljs-string\">`xid`</span>, <span class=\"hljs-string\">`branch_id`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span> = <span class=\"hljs-keyword\">InnoDB</span><br>  AUTO_INCREMENT = <span class=\"hljs-number\">1</span><br>  <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span> = utf8;<br><br><span class=\"hljs-comment\">-- 创建 stock库、业务表、undo_log表</span><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">database</span> seata_stock;<br><span class=\"hljs-keyword\">use</span> seata_stock;<br><br><span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> <span class=\"hljs-string\">`stock_tbl`</span>;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`stock_tbl`</span> (<br>  <span class=\"hljs-string\">`id`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`commodity_code`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`count`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>),<br>  <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`commodity_code`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span>=utf8;<br><br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`undo_log`</span><br>(<br>  <span class=\"hljs-string\">`id`</span>            <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`branch_id`</span>     <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`xid`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`context`</span>       <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">128</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`rollback_info`</span> LONGBLOB     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_status`</span>    <span class=\"hljs-built_in\">INT</span>(<span class=\"hljs-number\">11</span>)      <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_created`</span>   DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_modified`</span>  DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`ext`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>),<br>  <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">KEY</span> <span class=\"hljs-string\">`ux_undo_log`</span> (<span class=\"hljs-string\">`xid`</span>, <span class=\"hljs-string\">`branch_id`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span> = <span class=\"hljs-keyword\">InnoDB</span><br>  AUTO_INCREMENT = <span class=\"hljs-number\">1</span><br>  <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span> = utf8;<br><br><span class=\"hljs-comment\">-- 初始化库存模拟数据</span><br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> seata_stock.stock_tbl (<span class=\"hljs-keyword\">id</span>, commodity_code, <span class=\"hljs-keyword\">count</span>) <span class=\"hljs-keyword\">VALUES</span> (<span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">'product-1'</span>, <span class=\"hljs-number\">9999999</span>);<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> seata_stock.stock_tbl (<span class=\"hljs-keyword\">id</span>, commodity_code, <span class=\"hljs-keyword\">count</span>) <span class=\"hljs-keyword\">VALUES</span> (<span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">'product-2'</span>, <span class=\"hljs-number\">0</span>);<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"5-引入mybatis-plus\"><a href=\"#5-引入mybatis-plus\" class=\"headerlink\" title=\"5.引入mybatis plus\"></a>5.引入mybatis plus</h3><p>父pom引入依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-comment\">&lt;!-- mybatis plus --&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.baomidou<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>3.4.3.4<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-comment\">&lt;!-- 提供mysql驱动 --&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>mysql<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>8.0.16<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>两个工程分别引入依赖:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-comment\">&lt;!-- mybatis plus --&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.baomidou<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>mysql<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"6-order-server业务修改\"><a href=\"#6-order-server业务修改\" class=\"headerlink\" title=\"6.order-server业务修改\"></a>6.order-server业务修改</h3><p>新增部分类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Data</span><br><span class=\"hljs-meta\">@TableName</span>(<span class=\"hljs-string\">\"order_tbl\"</span>)<br><span class=\"hljs-meta\">@Accessors</span>(chain = <span class=\"hljs-keyword\">true</span>)<br><span class=\"hljs-meta\">@Builder</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Order</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">Serializable</span> </span>&#123;<br><br>   <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> longserialVersionUID= <span class=\"hljs-number\">1L</span>;<br><br>    <span class=\"hljs-meta\">@JsonFormat</span>(shape = JsonFormat.Shape.STRING)<br>    <span class=\"hljs-meta\">@TableId</span>(value=<span class=\"hljs-string\">\"id\"</span> ,type = IdType.AUTO)<br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"id\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer id;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"user_id\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String userId;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"commodity_code\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String commodityCode;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"count\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer count;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"money\"</span>)<br>    <span class=\"hljs-keyword\">private</span> BigDecimal money;<br><br>    <span class=\"hljs-meta\">@Tolerate</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">Order</span><span class=\"hljs-params\">()</span></span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Mapper</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">OrderTblMapper</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">BaseMapper</span>&lt;<span class=\"hljs-title\">Order</span>&gt; </span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>mapperxml:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span><br><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-meta-keyword\">mapper</span> <span class=\"hljs-meta-keyword\">PUBLIC</span> <span class=\"hljs-meta-string\">\"-//mybatis.org//DTD Mapper 3.0//EN\"</span> <span class=\"hljs-meta-string\">\"http://mybatis.org/dtd/mybatis-3-mapper.dtd\"</span>&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">mapper</span> <span class=\"hljs-attr\">namespace</span>=<span class=\"hljs-string\">\"com.winterchen.nacos.mapper.OrderTblMapper\"</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>service:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">OrderTblService</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">IService</span>&lt;<span class=\"hljs-title\">Order</span>&gt; </span>&#123;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">placeOrder</span><span class=\"hljs-params\">(String userId, String commodityCode, Integer count)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Service</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OrderTblServiceImpl</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">ServiceImpl</span>&lt;<span class=\"hljs-title\">OrderTblMapper</span>, <span class=\"hljs-title\">Order</span>&gt; <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">OrderTblService</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> StockFeignClient stockFeignClient;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 下单：创建订单、减库存，涉及到两个服务</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> userId</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> commodityCode</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> count</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@GlobalTransactional</span><br>    <span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Exception<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span><br><span class=\"hljs-class\">    @<span class=\"hljs-title\">Override</span></span><br><span class=\"hljs-class\">    <span class=\"hljs-title\">public</span> <span class=\"hljs-title\">void</span> <span class=\"hljs-title\">placeOrder</span>(<span class=\"hljs-title\">String</span> <span class=\"hljs-title\">userId</span>, <span class=\"hljs-title\">String</span> <span class=\"hljs-title\">commodityCode</span>, <span class=\"hljs-title\">Integer</span> <span class=\"hljs-title\">count</span>) </span>&#123;<br>        BigDecimal orderMoney = <span class=\"hljs-keyword\">new</span> BigDecimal(count).multiply(<span class=\"hljs-keyword\">new</span> BigDecimal(<span class=\"hljs-number\">5</span>));<br>        Order order = <span class=\"hljs-keyword\">new</span> Order().setUserId(userId).setCommodityCode(commodityCode).setCount(count).setMoney(orderMoney);<br>        baseMapper.insert(order);<br>        stockFeignClient.deduct(commodityCode, count);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>StockFeignClient</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@FeignClient</span>(name = <span class=\"hljs-string\">\"stock-server\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">StockFeignClient</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/api/stock/deduct\"</span>)<br>    <span class=\"hljs-function\">Boolean <span class=\"hljs-title\">deduct</span><span class=\"hljs-params\">(@RequestParam(<span class=\"hljs-string\">\"commodityCode\"</span>)</span> String commodityCode, @<span class=\"hljs-title\">RequestParam</span><span class=\"hljs-params\">(<span class=\"hljs-string\">\"count\"</span>)</span> Integer count)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Api</span>(tags=<span class=\"hljs-string\">\"订单API\"</span>)<br><span class=\"hljs-meta\">@RestController</span><br><span class=\"hljs-meta\">@RequestMapping</span>(<span class=\"hljs-string\">\"/api/order\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OrderTblController</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> OrderTblService orderTblService;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 下单：插入订单表、扣减库存，模拟回滚</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/placeOrder/commit\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">placeOrderCommit</span><span class=\"hljs-params\">()</span> </span>&#123;<br><br>        orderTblService.placeOrder(<span class=\"hljs-string\">\"1\"</span>, <span class=\"hljs-string\">\"product-1\"</span>, <span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br><br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 下单：插入订单表、扣减库存，模拟回滚</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/placeOrder/rollback\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">placeOrderRollback</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-comment\">// product-2 扣库存时模拟了一个业务异常,</span><br>        orderTblService.placeOrder(<span class=\"hljs-string\">\"1\"</span>, <span class=\"hljs-string\">\"product-2\"</span>, <span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/placeOrder\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">placeOrder</span><span class=\"hljs-params\">(String userId, String commodityCode, Integer count)</span> </span>&#123;<br>        orderTblService.placeOrder(userId, commodityCode, count);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"7-stock-server业务修改\"><a href=\"#7-stock-server业务修改\" class=\"headerlink\" title=\"7.stock-server业务修改\"></a>7.stock-server业务修改</h3><p>entity:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Data</span><br><span class=\"hljs-meta\">@TableName</span>(<span class=\"hljs-string\">\"stock_tbl\"</span>)<br><span class=\"hljs-meta\">@Accessors</span>(chain = <span class=\"hljs-keyword\">true</span>)<br><span class=\"hljs-meta\">@Builder</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Stock</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">Serializable</span> </span>&#123;<br>\t<br>\t<span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-keyword\">long</span> serialVersionUID = <span class=\"hljs-number\">1L</span>;<br>\t\t<br>    <span class=\"hljs-meta\">@JsonFormat</span>(shape = JsonFormat.Shape.STRING)<br>    <span class=\"hljs-meta\">@TableId</span>(value=<span class=\"hljs-string\">\"id\"</span> ,type = IdType.AUTO)<br>    <span class=\"hljs-comment\">/**  */</span><br>    <span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"id\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer id;<br><br>    <span class=\"hljs-comment\">/**  */</span><br>    <span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"commodity_code\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String commodityCode;<br><br>    <span class=\"hljs-comment\">/**  */</span><br>    <span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"count\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer count;<br><br>    <span class=\"hljs-meta\">@Tolerate</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">Stock</span><span class=\"hljs-params\">()</span></span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>mapper:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Mapper</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">StockTblMapper</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">BaseMapper</span>&lt;<span class=\"hljs-title\">Stock</span>&gt; </span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>mapperxml:</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">&lt;?xml version=<span class=\"hljs-string\">\"1.0\"</span> encoding=<span class=\"hljs-string\">\"UTF-8\"</span>?&gt;<br>&lt;!DOCTYPE mapper PUBLIC <span class=\"hljs-string\">\"-//mybatis.org//DTD Mapper 3.0//EN\"</span> <span class=\"hljs-string\">\"http://mybatis.org/dtd/mybatis-3-mapper.dtd\"</span>&gt;<br>&lt;mapper namespace=<span class=\"hljs-string\">\"com.winterchen.nacos.mapper.StockTblMapper\"</span>&gt;<br><br>&lt;/mapper&gt;<br></code></pre></td></tr></table></figure>\n\n<p>service:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">StockTblService</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">IService</span>&lt;<span class=\"hljs-title\">Stock</span>&gt; </span>&#123;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">deduct</span><span class=\"hljs-params\">(String commodityCode, <span class=\"hljs-keyword\">int</span> count)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Service</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">StockTblServiceImpl</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">ServiceImpl</span>&lt;<span class=\"hljs-title\">StockTblMapper</span>, <span class=\"hljs-title\">Stock</span>&gt; <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">StockTblService</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Exception<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span><br><span class=\"hljs-class\">    @<span class=\"hljs-title\">Override</span></span><br><span class=\"hljs-class\">    <span class=\"hljs-title\">public</span> <span class=\"hljs-title\">void</span> <span class=\"hljs-title\">deduct</span>(<span class=\"hljs-title\">String</span> <span class=\"hljs-title\">commodityCode</span>, <span class=\"hljs-title\">int</span> <span class=\"hljs-title\">count</span>) </span>&#123;<br>        <span class=\"hljs-keyword\">if</span> (commodityCode.equals(<span class=\"hljs-string\">\"product-2\"</span>)) &#123;<br>            <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> RuntimeException(<span class=\"hljs-string\">\"异常:模拟业务异常:stock branch exception\"</span>);<br>        &#125;<br><br>        QueryWrapper&lt;Stock&gt; wrapper = <span class=\"hljs-keyword\">new</span> QueryWrapper&lt;&gt;();<br>        wrapper.setEntity(<span class=\"hljs-keyword\">new</span> Stock().setCommodityCode(commodityCode));<br>        Stock stock = baseMapper.selectOne(wrapper);<br>        stock.setCount(stock.getCount() - count);<br><br>        baseMapper.updateById(stock);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>controller：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Api</span>(tags=<span class=\"hljs-string\">\"库存API\"</span>)<br><span class=\"hljs-meta\">@RestController</span><br><span class=\"hljs-meta\">@RequestMapping</span>(<span class=\"hljs-string\">\"/api/stock\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">StockTblController</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> StockTblService stockTblService;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 减库存</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> commodityCode 商品代码</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> count         数量</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@PostMapping</span>(path = <span class=\"hljs-string\">\"/deduct\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">deduct</span><span class=\"hljs-params\">(String commodityCode, Integer count)</span> </span>&#123;<br>        stockTblService.deduct(commodityCode, count);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"8-修改gateway：\"><a href=\"#8-修改gateway：\" class=\"headerlink\" title=\"8. 修改gateway：\"></a>8. 修改gateway：</h3><p>修改<code>GatewayConfiguration</code></p>\n<p><code>initCustomizedApis</code> 新增对<code>order-server</code>和<code>stock-server</code>的初始化</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">ApiDefinition api3 = <span class=\"hljs-keyword\">new</span> ApiDefinition(<span class=\"hljs-string\">\"order\"</span>)<br>                .setPredicateItems(<span class=\"hljs-keyword\">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br><br>                    add(<span class=\"hljs-keyword\">new</span> ApiPathPredicateItem().setPattern(<span class=\"hljs-string\">\"/order/**\"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>        ApiDefinition api4 = <span class=\"hljs-keyword\">new</span> ApiDefinition(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setPredicateItems(<span class=\"hljs-keyword\">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br>                    add(<span class=\"hljs-keyword\">new</span> ApiPathPredicateItem().setPattern(<span class=\"hljs-string\">\"/stock/**\"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>  definitions.add(api3);<br>  definitions.add(api4);<br></code></pre></td></tr></table></figure>\n\n<p><code>initGatewayRules</code> 新增规则</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"order\"</span>)<br>                .setCount(<span class=\"hljs-number\">10</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"order\"</span>)<br>                .setCount(<span class=\"hljs-number\">2</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">2</span>)<br>                .setBurst(<span class=\"hljs-number\">2</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_CLIENT_IP)<br>                )<br>        );<br><br>rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setCount(<span class=\"hljs-number\">10</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER)<br>                .setMaxQueueingTimeoutMs(<span class=\"hljs-number\">600</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_HEADER)<br>                        .setFieldName(<span class=\"hljs-string\">\"X-Sentinel-Flag\"</span>)<br>                )<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setCount(<span class=\"hljs-number\">1</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"pa\"</span>)<br>                )<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setCount(<span class=\"hljs-number\">2</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">30</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"type\"</span>)<br>                        .setPattern(<span class=\"hljs-string\">\"warn\"</span>)<br>                        .setMatchStrategy(SentinelGatewayConstants.PARAM_MATCH_STRATEGY_CONTAINS)<br>                )<br>        );<br><br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_CUSTOM_API_NAME)<br>                .setCount(<span class=\"hljs-number\">5</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"pn\"</span>)<br>                )<br>        );<br></code></pre></td></tr></table></figure>\n\n<p><code>appilcation.yml</code>新增对<code>order-server</code>和<code>stock-server</code>的路由配置:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">locator:</span><br>          <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">false</span><br>          <span class=\"hljs-attr\">lowerCaseServiceId:</span> <span class=\"hljs-literal\">true</span><br>      <span class=\"hljs-attr\">routes:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">provider</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-provider</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/provider/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span> <span class=\"hljs-comment\">#StripPrefix=1就代表截取路径的个数为1，比如前端过来请求/test/good/1/view，匹配成功后，路由到后端的请求路径就会变成http://localhost:8888/good/1/view</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">consumer</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-consumer</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/consumer/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">auth</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://auth</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/auth/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">order-server</span>   <span class=\"hljs-string\">-------新增order-server的路由规则</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://order-server</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/order/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">stock-server</span>  <span class=\"hljs-string\">---------</span> <span class=\"hljs-string\">新增stock-server的路由规则</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://stock-server</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/stock/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"测试：\"><a href=\"#测试：\" class=\"headerlink\" title=\"测试：\"></a>测试：</h2><p>首先启动对应的服务：</p>\n<ul>\n<li>spring-cloud-gateway</li>\n<li>spring-cloud-auth</li>\n<li>order-server</li>\n<li>stock-server</li>\n</ul>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104335.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>然后打开swagger进行测试: <a href=\"http://127.0.0.1:15010/doc.html#/order-server/%E8%AE%A2%E5%8D%95API/placeOrderUsingPOST\" target=\"_blank\" rel=\"noopener\">consumer服务</a></p>\n<h3 id=\"测试提交：\"><a href=\"#测试提交：\" class=\"headerlink\" title=\"测试提交：\"></a>测试提交：</h3><p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104403.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>订单创建成功：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104411.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>库存扣减成功：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104419.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<h3 id=\"测试回滚：\"><a href=\"#测试回滚：\" class=\"headerlink\" title=\"测试回滚：\"></a>测试回滚：</h3><p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104428.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>此时数据库里面都正常回滚。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>以上就是本教程的全部内容了，seata是一款非常好用的分布式事务框架，为开发人员提供了比较简单的API，seata默认使用的是AT模式的事务，当然，可以结合自身的业务选择比较合适的分布式事务模式，具体的配置可以参考官方文档。</p>\n<p>本项目的源码地址为：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">WinterChenS/spring-cloud-hoxton-study: spring cloud hoxton release study (github.com)</a></p>\n<h2 id=\"参考文献：\"><a href=\"#参考文献：\" class=\"headerlink\" title=\"参考文献：\"></a>参考文献：</h2><p><a href=\"http://seata.io/zh-cn/docs/overview/what-is-seata.html\" target=\"_blank\" rel=\"noopener\">Seata 是什么</a></p>\n<p><a href=\"http://seata.io/zh-cn/blog/integrate-seata-with-spring-cloud.html\" target=\"_blank\" rel=\"noopener\">Seata（Fescar）分布式事务 整合 Spring Cloud</a></p>\n","more":"<blockquote>\n<p>阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<blockquote>\n<p>两个月没有更新了，这次趁着刷技术文章的机会，把目前比较热门的分布式事务框架seata整合一下，分布式事务的出现是因为微服务导致业务分部在不同的服务中，不能像本地事务一样使用事务。</p>\n</blockquote>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6991635985847025671\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992010061576929310\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(四)之SpringCloud Gateway | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992404611617259534\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(五)之SpringCloud Gateway 网关聚合开发文档 swagger knife4j 和登录权限统一验证</a></li>\n<li><a href=\"https://juejin.cn/post/6992404611617259534\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(六)之SpringCloud 使用sentinel作为熔断器</a></li>\n<li><a href=\"https://juejin.cn/post/6993124554428121096\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(七)之使用Spring Cloud Sleuth+Zipkin实现链路追踪</a></li>\n</ul>\n<h2 id=\"什么是seata？\"><a href=\"#什么是seata？\" class=\"headerlink\" title=\"什么是seata？\"></a>什么是seata？</h2><p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p>\n<p>关于更多的原理可以参考官方文档，这里就不赘述了：<a href=\"http://seata.io/zh-cn/docs/overview/what-is-seata.html\" target=\"_blank\" rel=\"noopener\">Seata 是什么</a></p>\n<h2 id=\"下载安装seata-server\"><a href=\"#下载安装seata-server\" class=\"headerlink\" title=\"下载安装seata-server\"></a>下载安装seata-server</h2><h3 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h3><p>下载地址：<a href=\"https://github.com/seata/seata/releases\" target=\"_blank\" rel=\"noopener\">Releases · seata/seata (github.com)</a></p>\n<p>window下载zip，linux/mac下载tar.gz</p>\n<blockquote>\n<p>注意：如何安装nacos请看这：<a href=\"https://nacos.io/zh-cn/docs/quick-start.html\" target=\"_blank\" rel=\"noopener\">Nacos 快速入门</a>，建议查看前面的文章以做到丝滑入戏。</p>\n</blockquote>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><p>解压之后修改配置文件registry.conf（这里主要是配置nacos作为配置中心）：</p>\n<figure class=\"highlight protobuf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs protobuf\">config &#123;<br>  type = <span class=\"hljs-string\">\"nacos\"</span> ## 这里修改为nacos，并且修改下面对应的配置<br><br>  nacos &#123;<br>    serverAddr = <span class=\"hljs-string\">\"127.0.0.1:8848\"</span><br>    namespace = <span class=\"hljs-string\">\"public\"</span><br>    <span class=\"hljs-keyword\">group</span> = <span class=\"hljs-string\">\"SEATA_GROUP\"</span><br>    username = <span class=\"hljs-string\">\"nacos\"</span><br>    password = <span class=\"hljs-string\">\"nacos\"</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>然后继续修改注册中心（nacos作为注册中心）：</p>\n<figure class=\"highlight protobuf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs protobuf\">registry &#123;<br> <br>  type = <span class=\"hljs-string\">\"nacos\"</span><br><br>  nacos &#123;<br>    application = <span class=\"hljs-string\">\"seata-server\"</span><br>    serverAddr = <span class=\"hljs-string\">\"127.0.0.1:8848\"</span><br>    <span class=\"hljs-keyword\">group</span> = <span class=\"hljs-string\">\"DEFAULT_GROUP\"</span> #这里的<span class=\"hljs-keyword\">group</span>需要与业务服务在一个<span class=\"hljs-keyword\">group</span>内<br>    namespace = <span class=\"hljs-string\">\"public\"</span><br>    cluster = <span class=\"hljs-string\">\"default\"</span><br>    username = <span class=\"hljs-string\">\"nacos\"</span><br>    password = <span class=\"hljs-string\">\"nacos\"</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>本文是以nacos作为注册中心和配置中心的，如果需要其它的方式可以查看官方文档。</p>\n<h3 id=\"上传配置\"><a href=\"#上传配置\" class=\"headerlink\" title=\"上传配置\"></a>上传配置</h3><p>在上传之前先下载对应的配置文件模板</p>\n<ol>\n<li>首先下载config.txt文件：<a href=\"https://github.com/seata/seata/tree/develop/script/config-center\" target=\"_blank\" rel=\"noopener\">seata/script/config-center at develop · seata/seata (github.com)</a> ，将其放入到seata的解压目录下；见图例1</li>\n<li>然后在目录下找到对应的配置中心的目录下的shell脚本，这里使用的是nacos-config.sh <a href=\"https://github.com/seata/seata/tree/develop/script/config-center/nacos\" target=\"_blank\" rel=\"noopener\">seata/script/config-center/nacos at develop · seata/seata (github.com)</a>，将其放入到<code>${SEATA_DIR}/script/config-center/nacos/nacos-config.sh</code> 注意：<code>${SEATA_DIR}</code> 是seata的根目录；见图例2</li>\n<li>到seata的解压根目录下运行 <code>sh script/config-center/nacos/nacos-config.sh -h 127.0.0.1 -p 8848 -g SEATA_GROUP -u nacos -w nacos</code> 注意：nacos-config.sh是第2步下载的脚本文件，见图例3</li>\n</ol>\n<p>图例1：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104117.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例1</span></p>\n<p>图例2：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104139.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例2</span></p>\n<p>图例3：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104156.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例3</span></p>\n<p>图例4：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104216.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例4</span></p>\n<p>在nacos控制台（localhost:8848/nacos，账密：nacos/nacos）：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104233.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>可以看到配置已经成功上传</p>\n<p>具体的配置请查看：<a href=\"https://github.com/seata/seata/blob/develop/script/config-center/config.txt\" target=\"_blank\" rel=\"noopener\">seata/config.txt at develop · seata/seata (github.com)</a></p>\n<p>配置参数官方对照表：<a href=\"http://seata.io/zh-cn/docs/user/configurations.html\" target=\"_blank\" rel=\"noopener\">Seata 参数配置</a></p>\n<p>注意修改对应数据库的配置，可以直接在nacos中修改配置。</p>\n<blockquote>\n<p>有一个比较关键的点，也是很容易出错的点，有一个配置参数单独拿出来讲一下，<br><code>service.vgroupMapping.&lt;你的服务名称&gt;-group=default</code> 这个分组需要seata-server和client都保持一致，当然，seata是可以存在多个事务分组的，比如我们订单业务涉及到库存等等逻辑，那么将这些在同一个事务的服务加入到同一个事务分组内，就如默认的配置文件中设置为：<code>service.vgroupMapping.my_test_tx_group=default</code> 那么我们需要在服务的application.yml中配置该组：</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">seata:</span><br>  <span class=\"hljs-attr\">tx-service-group:</span> <span class=\"hljs-string\">my_test_tx_group</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"启动seata-server：\"><a href=\"#启动seata-server：\" class=\"headerlink\" title=\"启动seata-server：\"></a>启动seata-server：</h2><p>windows：打开控制台：<code>./seata-server.bat -h 127.0.0.1</code></p>\n<p>linux/macos: <code>sh [seata-server.sh](http://seata-server.sh) -h 127.0.0.1</code></p>\n<p>成功启动：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104300.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">成功启动</span></p>\n<p>nacos注册中心：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104319.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">nacos注册中心</span></p>\n<h3 id=\"多种部署方式：\"><a href=\"#多种部署方式：\" class=\"headerlink\" title=\"多种部署方式：\"></a>多种部署方式：</h3><ul>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-by-docker.html\" target=\"_blank\" rel=\"noopener\">使用 Docker 部署 Seata Server</a></li>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-by-kubernetes.html\" target=\"_blank\" rel=\"noopener\">使用 Kubernetes 部署 Seata Server</a></li>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-by-helm.html\" target=\"_blank\" rel=\"noopener\">使用 Helm 部署 Seata Server</a></li>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-ha.html\" target=\"_blank\" rel=\"noopener\">Seata 高可用部署</a></li>\n</ul>\n<h3 id=\"新增seata的数据表：\"><a href=\"#新增seata的数据表：\" class=\"headerlink\" title=\"新增seata的数据表：\"></a>新增seata的数据表：</h3><p>对应的sql文件请查看：<a href=\"https://github.com/seata/seata/tree/1.4.0/script/server/db\" target=\"_blank\" rel=\"noopener\">seata/script/server/db at 1.4.0 · seata/seata (github.com)</a></p>\n<p>下载之后在数据库中新建库：seata，然后将建库脚本导入。</p>\n<h2 id=\"工程改造\"><a href=\"#工程改造\" class=\"headerlink\" title=\"工程改造\"></a>工程改造</h2><h3 id=\"1-复制工程\"><a href=\"#1-复制工程\" class=\"headerlink\" title=\"1.复制工程\"></a>1.复制工程</h3><p>将工程：spring-cloud-nacos-consumer 复制一份，改为：order-server</p>\n<p>将工程：spring-cloud-nacos-provider 复制一份，改为：stock-server</p>\n<p>注意：复制之后需要修改部分pom配置才可以（改为对应的名称）：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>order-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>0.0.1-SNAPSHOT<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">name</span>&gt;</span>order-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">name</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">description</span>&gt;</span>Demo project for Spring Boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">description</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>并且在父pom中加入：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">modules</span>&gt;</span><br>    ...<br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">module</span>&gt;</span>stock-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">module</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">module</span>&gt;</span>order-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">module</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">modules</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>然后重新导入依赖即可</p>\n<p>如果还存在异常，请将.imi文件删除</p>\n<h3 id=\"2-增加依赖\"><a href=\"#2-增加依赖\" class=\"headerlink\" title=\"2.增加依赖\"></a>2.增加依赖</h3><p>在两个工程模块的pom中增加依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-comment\">&lt;!-- seata --&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>io.seata<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>seata-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>1.4.2<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">exclusions</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">exclusion</span>&gt;</span><br>                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>io.seata<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>seata-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">exclusion</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">exclusions</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-修改工程的application-yml配置\"><a href=\"#3-修改工程的application-yml配置\" class=\"headerlink\" title=\"3.修改工程的application.yml配置\"></a>3.修改工程的application.yml配置</h3><p>order-server</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">logging:</span><br>  <span class=\"hljs-attr\">level:</span><br>    <span class=\"hljs-attr\">io:</span><br>      <span class=\"hljs-attr\">seata:</span> <span class=\"hljs-string\">debug</span><br><span class=\"hljs-attr\">seata:</span><br>  <span class=\"hljs-attr\">tx-service-group:</span> <span class=\"hljs-string\">my_test_tx_group</span><br></code></pre></td></tr></table></figure>\n\n<p>stock-server</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">logging:</span><br>  <span class=\"hljs-attr\">level:</span><br>    <span class=\"hljs-attr\">io:</span><br>      <span class=\"hljs-attr\">seata:</span> <span class=\"hljs-string\">debug</span><br><span class=\"hljs-attr\">seata:</span><br>  <span class=\"hljs-attr\">tx-service-group:</span> <span class=\"hljs-string\">my_test_tx_group</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"4-数据库初始化\"><a href=\"#4-数据库初始化\" class=\"headerlink\" title=\"4.数据库初始化\"></a>4.数据库初始化</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-comment\">-- 创建 order库、业务表、undo_log表</span><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">database</span> seata_order;<br><span class=\"hljs-keyword\">use</span> seata_order;<br><br><span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> <span class=\"hljs-string\">`order_tbl`</span>;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`order_tbl`</span> (<br>  <span class=\"hljs-string\">`id`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`user_id`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`commodity_code`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`count`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span>,<br>  <span class=\"hljs-string\">`money`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span>=utf8;<br><br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`undo_log`</span><br>(<br>  <span class=\"hljs-string\">`id`</span>            <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`branch_id`</span>     <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`xid`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`context`</span>       <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">128</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`rollback_info`</span> LONGBLOB     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_status`</span>    <span class=\"hljs-built_in\">INT</span>(<span class=\"hljs-number\">11</span>)      <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_created`</span>   DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_modified`</span>  DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`ext`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>),<br>  <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">KEY</span> <span class=\"hljs-string\">`ux_undo_log`</span> (<span class=\"hljs-string\">`xid`</span>, <span class=\"hljs-string\">`branch_id`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span> = <span class=\"hljs-keyword\">InnoDB</span><br>  AUTO_INCREMENT = <span class=\"hljs-number\">1</span><br>  <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span> = utf8;<br><br><span class=\"hljs-comment\">-- 创建 stock库、业务表、undo_log表</span><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">database</span> seata_stock;<br><span class=\"hljs-keyword\">use</span> seata_stock;<br><br><span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> <span class=\"hljs-string\">`stock_tbl`</span>;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`stock_tbl`</span> (<br>  <span class=\"hljs-string\">`id`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`commodity_code`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`count`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>),<br>  <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`commodity_code`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span>=utf8;<br><br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`undo_log`</span><br>(<br>  <span class=\"hljs-string\">`id`</span>            <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`branch_id`</span>     <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`xid`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`context`</span>       <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">128</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`rollback_info`</span> LONGBLOB     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_status`</span>    <span class=\"hljs-built_in\">INT</span>(<span class=\"hljs-number\">11</span>)      <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_created`</span>   DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_modified`</span>  DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`ext`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>),<br>  <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">KEY</span> <span class=\"hljs-string\">`ux_undo_log`</span> (<span class=\"hljs-string\">`xid`</span>, <span class=\"hljs-string\">`branch_id`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span> = <span class=\"hljs-keyword\">InnoDB</span><br>  AUTO_INCREMENT = <span class=\"hljs-number\">1</span><br>  <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span> = utf8;<br><br><span class=\"hljs-comment\">-- 初始化库存模拟数据</span><br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> seata_stock.stock_tbl (<span class=\"hljs-keyword\">id</span>, commodity_code, <span class=\"hljs-keyword\">count</span>) <span class=\"hljs-keyword\">VALUES</span> (<span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">'product-1'</span>, <span class=\"hljs-number\">9999999</span>);<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> seata_stock.stock_tbl (<span class=\"hljs-keyword\">id</span>, commodity_code, <span class=\"hljs-keyword\">count</span>) <span class=\"hljs-keyword\">VALUES</span> (<span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">'product-2'</span>, <span class=\"hljs-number\">0</span>);<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"5-引入mybatis-plus\"><a href=\"#5-引入mybatis-plus\" class=\"headerlink\" title=\"5.引入mybatis plus\"></a>5.引入mybatis plus</h3><p>父pom引入依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-comment\">&lt;!-- mybatis plus --&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.baomidou<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>3.4.3.4<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-comment\">&lt;!-- 提供mysql驱动 --&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>mysql<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>8.0.16<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>两个工程分别引入依赖:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-comment\">&lt;!-- mybatis plus --&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.baomidou<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>mysql<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"6-order-server业务修改\"><a href=\"#6-order-server业务修改\" class=\"headerlink\" title=\"6.order-server业务修改\"></a>6.order-server业务修改</h3><p>新增部分类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Data</span><br><span class=\"hljs-meta\">@TableName</span>(<span class=\"hljs-string\">\"order_tbl\"</span>)<br><span class=\"hljs-meta\">@Accessors</span>(chain = <span class=\"hljs-keyword\">true</span>)<br><span class=\"hljs-meta\">@Builder</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Order</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">Serializable</span> </span>&#123;<br><br>   <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> longserialVersionUID= <span class=\"hljs-number\">1L</span>;<br><br>    <span class=\"hljs-meta\">@JsonFormat</span>(shape = JsonFormat.Shape.STRING)<br>    <span class=\"hljs-meta\">@TableId</span>(value=<span class=\"hljs-string\">\"id\"</span> ,type = IdType.AUTO)<br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"id\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer id;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"user_id\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String userId;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"commodity_code\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String commodityCode;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"count\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer count;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"money\"</span>)<br>    <span class=\"hljs-keyword\">private</span> BigDecimal money;<br><br>    <span class=\"hljs-meta\">@Tolerate</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">Order</span><span class=\"hljs-params\">()</span></span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Mapper</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">OrderTblMapper</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">BaseMapper</span>&lt;<span class=\"hljs-title\">Order</span>&gt; </span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>mapperxml:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span><br><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-meta-keyword\">mapper</span> <span class=\"hljs-meta-keyword\">PUBLIC</span> <span class=\"hljs-meta-string\">\"-//mybatis.org//DTD Mapper 3.0//EN\"</span> <span class=\"hljs-meta-string\">\"http://mybatis.org/dtd/mybatis-3-mapper.dtd\"</span>&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">mapper</span> <span class=\"hljs-attr\">namespace</span>=<span class=\"hljs-string\">\"com.winterchen.nacos.mapper.OrderTblMapper\"</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>service:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">OrderTblService</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">IService</span>&lt;<span class=\"hljs-title\">Order</span>&gt; </span>&#123;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">placeOrder</span><span class=\"hljs-params\">(String userId, String commodityCode, Integer count)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Service</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OrderTblServiceImpl</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">ServiceImpl</span>&lt;<span class=\"hljs-title\">OrderTblMapper</span>, <span class=\"hljs-title\">Order</span>&gt; <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">OrderTblService</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> StockFeignClient stockFeignClient;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 下单：创建订单、减库存，涉及到两个服务</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> userId</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> commodityCode</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> count</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@GlobalTransactional</span><br>    <span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Exception<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span><br><span class=\"hljs-class\">    @<span class=\"hljs-title\">Override</span></span><br><span class=\"hljs-class\">    <span class=\"hljs-title\">public</span> <span class=\"hljs-title\">void</span> <span class=\"hljs-title\">placeOrder</span>(<span class=\"hljs-title\">String</span> <span class=\"hljs-title\">userId</span>, <span class=\"hljs-title\">String</span> <span class=\"hljs-title\">commodityCode</span>, <span class=\"hljs-title\">Integer</span> <span class=\"hljs-title\">count</span>) </span>&#123;<br>        BigDecimal orderMoney = <span class=\"hljs-keyword\">new</span> BigDecimal(count).multiply(<span class=\"hljs-keyword\">new</span> BigDecimal(<span class=\"hljs-number\">5</span>));<br>        Order order = <span class=\"hljs-keyword\">new</span> Order().setUserId(userId).setCommodityCode(commodityCode).setCount(count).setMoney(orderMoney);<br>        baseMapper.insert(order);<br>        stockFeignClient.deduct(commodityCode, count);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>StockFeignClient</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@FeignClient</span>(name = <span class=\"hljs-string\">\"stock-server\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">StockFeignClient</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/api/stock/deduct\"</span>)<br>    <span class=\"hljs-function\">Boolean <span class=\"hljs-title\">deduct</span><span class=\"hljs-params\">(@RequestParam(<span class=\"hljs-string\">\"commodityCode\"</span>)</span> String commodityCode, @<span class=\"hljs-title\">RequestParam</span><span class=\"hljs-params\">(<span class=\"hljs-string\">\"count\"</span>)</span> Integer count)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Api</span>(tags=<span class=\"hljs-string\">\"订单API\"</span>)<br><span class=\"hljs-meta\">@RestController</span><br><span class=\"hljs-meta\">@RequestMapping</span>(<span class=\"hljs-string\">\"/api/order\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OrderTblController</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> OrderTblService orderTblService;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 下单：插入订单表、扣减库存，模拟回滚</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/placeOrder/commit\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">placeOrderCommit</span><span class=\"hljs-params\">()</span> </span>&#123;<br><br>        orderTblService.placeOrder(<span class=\"hljs-string\">\"1\"</span>, <span class=\"hljs-string\">\"product-1\"</span>, <span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br><br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 下单：插入订单表、扣减库存，模拟回滚</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/placeOrder/rollback\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">placeOrderRollback</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-comment\">// product-2 扣库存时模拟了一个业务异常,</span><br>        orderTblService.placeOrder(<span class=\"hljs-string\">\"1\"</span>, <span class=\"hljs-string\">\"product-2\"</span>, <span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/placeOrder\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">placeOrder</span><span class=\"hljs-params\">(String userId, String commodityCode, Integer count)</span> </span>&#123;<br>        orderTblService.placeOrder(userId, commodityCode, count);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"7-stock-server业务修改\"><a href=\"#7-stock-server业务修改\" class=\"headerlink\" title=\"7.stock-server业务修改\"></a>7.stock-server业务修改</h3><p>entity:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Data</span><br><span class=\"hljs-meta\">@TableName</span>(<span class=\"hljs-string\">\"stock_tbl\"</span>)<br><span class=\"hljs-meta\">@Accessors</span>(chain = <span class=\"hljs-keyword\">true</span>)<br><span class=\"hljs-meta\">@Builder</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Stock</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">Serializable</span> </span>&#123;<br>\t<br>\t<span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-keyword\">long</span> serialVersionUID = <span class=\"hljs-number\">1L</span>;<br>\t\t<br>    <span class=\"hljs-meta\">@JsonFormat</span>(shape = JsonFormat.Shape.STRING)<br>    <span class=\"hljs-meta\">@TableId</span>(value=<span class=\"hljs-string\">\"id\"</span> ,type = IdType.AUTO)<br>    <span class=\"hljs-comment\">/**  */</span><br>    <span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"id\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer id;<br><br>    <span class=\"hljs-comment\">/**  */</span><br>    <span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"commodity_code\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String commodityCode;<br><br>    <span class=\"hljs-comment\">/**  */</span><br>    <span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"count\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer count;<br><br>    <span class=\"hljs-meta\">@Tolerate</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">Stock</span><span class=\"hljs-params\">()</span></span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>mapper:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Mapper</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">StockTblMapper</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">BaseMapper</span>&lt;<span class=\"hljs-title\">Stock</span>&gt; </span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>mapperxml:</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">&lt;?xml version=<span class=\"hljs-string\">\"1.0\"</span> encoding=<span class=\"hljs-string\">\"UTF-8\"</span>?&gt;<br>&lt;!DOCTYPE mapper PUBLIC <span class=\"hljs-string\">\"-//mybatis.org//DTD Mapper 3.0//EN\"</span> <span class=\"hljs-string\">\"http://mybatis.org/dtd/mybatis-3-mapper.dtd\"</span>&gt;<br>&lt;mapper namespace=<span class=\"hljs-string\">\"com.winterchen.nacos.mapper.StockTblMapper\"</span>&gt;<br><br>&lt;/mapper&gt;<br></code></pre></td></tr></table></figure>\n\n<p>service:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">StockTblService</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">IService</span>&lt;<span class=\"hljs-title\">Stock</span>&gt; </span>&#123;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">deduct</span><span class=\"hljs-params\">(String commodityCode, <span class=\"hljs-keyword\">int</span> count)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Service</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">StockTblServiceImpl</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">ServiceImpl</span>&lt;<span class=\"hljs-title\">StockTblMapper</span>, <span class=\"hljs-title\">Stock</span>&gt; <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">StockTblService</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Exception<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span><br><span class=\"hljs-class\">    @<span class=\"hljs-title\">Override</span></span><br><span class=\"hljs-class\">    <span class=\"hljs-title\">public</span> <span class=\"hljs-title\">void</span> <span class=\"hljs-title\">deduct</span>(<span class=\"hljs-title\">String</span> <span class=\"hljs-title\">commodityCode</span>, <span class=\"hljs-title\">int</span> <span class=\"hljs-title\">count</span>) </span>&#123;<br>        <span class=\"hljs-keyword\">if</span> (commodityCode.equals(<span class=\"hljs-string\">\"product-2\"</span>)) &#123;<br>            <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> RuntimeException(<span class=\"hljs-string\">\"异常:模拟业务异常:stock branch exception\"</span>);<br>        &#125;<br><br>        QueryWrapper&lt;Stock&gt; wrapper = <span class=\"hljs-keyword\">new</span> QueryWrapper&lt;&gt;();<br>        wrapper.setEntity(<span class=\"hljs-keyword\">new</span> Stock().setCommodityCode(commodityCode));<br>        Stock stock = baseMapper.selectOne(wrapper);<br>        stock.setCount(stock.getCount() - count);<br><br>        baseMapper.updateById(stock);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>controller：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Api</span>(tags=<span class=\"hljs-string\">\"库存API\"</span>)<br><span class=\"hljs-meta\">@RestController</span><br><span class=\"hljs-meta\">@RequestMapping</span>(<span class=\"hljs-string\">\"/api/stock\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">StockTblController</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> StockTblService stockTblService;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 减库存</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> commodityCode 商品代码</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> count         数量</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@PostMapping</span>(path = <span class=\"hljs-string\">\"/deduct\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">deduct</span><span class=\"hljs-params\">(String commodityCode, Integer count)</span> </span>&#123;<br>        stockTblService.deduct(commodityCode, count);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"8-修改gateway：\"><a href=\"#8-修改gateway：\" class=\"headerlink\" title=\"8. 修改gateway：\"></a>8. 修改gateway：</h3><p>修改<code>GatewayConfiguration</code></p>\n<p><code>initCustomizedApis</code> 新增对<code>order-server</code>和<code>stock-server</code>的初始化</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">ApiDefinition api3 = <span class=\"hljs-keyword\">new</span> ApiDefinition(<span class=\"hljs-string\">\"order\"</span>)<br>                .setPredicateItems(<span class=\"hljs-keyword\">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br><br>                    add(<span class=\"hljs-keyword\">new</span> ApiPathPredicateItem().setPattern(<span class=\"hljs-string\">\"/order/**\"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>        ApiDefinition api4 = <span class=\"hljs-keyword\">new</span> ApiDefinition(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setPredicateItems(<span class=\"hljs-keyword\">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br>                    add(<span class=\"hljs-keyword\">new</span> ApiPathPredicateItem().setPattern(<span class=\"hljs-string\">\"/stock/**\"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>  definitions.add(api3);<br>  definitions.add(api4);<br></code></pre></td></tr></table></figure>\n\n<p><code>initGatewayRules</code> 新增规则</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"order\"</span>)<br>                .setCount(<span class=\"hljs-number\">10</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"order\"</span>)<br>                .setCount(<span class=\"hljs-number\">2</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">2</span>)<br>                .setBurst(<span class=\"hljs-number\">2</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_CLIENT_IP)<br>                )<br>        );<br><br>rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setCount(<span class=\"hljs-number\">10</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER)<br>                .setMaxQueueingTimeoutMs(<span class=\"hljs-number\">600</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_HEADER)<br>                        .setFieldName(<span class=\"hljs-string\">\"X-Sentinel-Flag\"</span>)<br>                )<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setCount(<span class=\"hljs-number\">1</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"pa\"</span>)<br>                )<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setCount(<span class=\"hljs-number\">2</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">30</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"type\"</span>)<br>                        .setPattern(<span class=\"hljs-string\">\"warn\"</span>)<br>                        .setMatchStrategy(SentinelGatewayConstants.PARAM_MATCH_STRATEGY_CONTAINS)<br>                )<br>        );<br><br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_CUSTOM_API_NAME)<br>                .setCount(<span class=\"hljs-number\">5</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"pn\"</span>)<br>                )<br>        );<br></code></pre></td></tr></table></figure>\n\n<p><code>appilcation.yml</code>新增对<code>order-server</code>和<code>stock-server</code>的路由配置:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">locator:</span><br>          <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">false</span><br>          <span class=\"hljs-attr\">lowerCaseServiceId:</span> <span class=\"hljs-literal\">true</span><br>      <span class=\"hljs-attr\">routes:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">provider</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-provider</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/provider/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span> <span class=\"hljs-comment\">#StripPrefix=1就代表截取路径的个数为1，比如前端过来请求/test/good/1/view，匹配成功后，路由到后端的请求路径就会变成http://localhost:8888/good/1/view</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">consumer</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-consumer</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/consumer/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">auth</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://auth</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/auth/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">order-server</span>   <span class=\"hljs-string\">-------新增order-server的路由规则</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://order-server</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/order/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">stock-server</span>  <span class=\"hljs-string\">---------</span> <span class=\"hljs-string\">新增stock-server的路由规则</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://stock-server</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/stock/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"测试：\"><a href=\"#测试：\" class=\"headerlink\" title=\"测试：\"></a>测试：</h2><p>首先启动对应的服务：</p>\n<ul>\n<li>spring-cloud-gateway</li>\n<li>spring-cloud-auth</li>\n<li>order-server</li>\n<li>stock-server</li>\n</ul>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104335.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>然后打开swagger进行测试: <a href=\"http://127.0.0.1:15010/doc.html#/order-server/%E8%AE%A2%E5%8D%95API/placeOrderUsingPOST\" target=\"_blank\" rel=\"noopener\">consumer服务</a></p>\n<h3 id=\"测试提交：\"><a href=\"#测试提交：\" class=\"headerlink\" title=\"测试提交：\"></a>测试提交：</h3><p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104403.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>订单创建成功：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104411.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>库存扣减成功：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104419.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<h3 id=\"测试回滚：\"><a href=\"#测试回滚：\" class=\"headerlink\" title=\"测试回滚：\"></a>测试回滚：</h3><p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104428.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>此时数据库里面都正常回滚。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>以上就是本教程的全部内容了，seata是一款非常好用的分布式事务框架，为开发人员提供了比较简单的API，seata默认使用的是AT模式的事务，当然，可以结合自身的业务选择比较合适的分布式事务模式，具体的配置可以参考官方文档。</p>\n<p>本项目的源码地址为：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">WinterChenS/spring-cloud-hoxton-study: spring cloud hoxton release study (github.com)</a></p>\n<h2 id=\"参考文献：\"><a href=\"#参考文献：\" class=\"headerlink\" title=\"参考文献：\"></a>参考文献：</h2><p><a href=\"http://seata.io/zh-cn/docs/overview/what-is-seata.html\" target=\"_blank\" rel=\"noopener\">Seata 是什么</a></p>\n<p><a href=\"http://seata.io/zh-cn/blog/integrate-seata-with-spring-cloud.html\" target=\"_blank\" rel=\"noopener\">Seata（Fescar）分布式事务 整合 Spring Cloud</a></p>\n","categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"},{"name":"Hoxton","path":"api/tags/Hoxton.json"},{"name":"seata","path":"api/tags/seata.json"}]}