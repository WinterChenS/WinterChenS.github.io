{"name":"springcloud","postlist":[{"title":"SpringCloud系列教程(四)之SpringCloud Gateway","slug":"2021-08-03-spring-cloud-hoxton-4-gateway","date":"2021-08-03T01:35:00.000Z","updated":"2022-12-01T01:32:39.787Z","comments":true,"top":null,"path":"api/articles/2021-08-03-spring-cloud-hoxton-4-gateway.json","excerpt":null,"keywords":"java,spring,springboot,springcloud,mybatis,jQuery,html,css","cover":"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046764668983.jpg","content":"<blockquote>\n<p>**阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：**<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6991635985847025671\" target=\"_blank\" rel=\"noopener\"># SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>\n</ul>\n<h2 id=\"本文概览\"><a href=\"#本文概览\" class=\"headerlink\" title=\"本文概览\"></a>本文概览</h2><ul>\n<li>Spring Cloud Gateway的简介</li>\n<li>gateway在微服务架构中的应用场景</li>\n<li>Spring Cloud Gateway使用</li>\n<li>相关配置详解</li>\n<li>实战中的使用</li>\n</ul>\n<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><p>Spring Cloud 作为新一代的微服务网关，该项目基于Spring webflux技术开发的网关，作为Spring Cloud生态系统中的网关，目标是替代zuul，为什么使用webflux？webflux是Reactor模式的响应式编程框架，底层使用了netty通信框架，非Reactor模式的zuul采用的是Tomcat容器，使用的还是传统的Servlet IO处理模型。想了解webflux和netty的同学可以搜索相关知识，这也是当前比较热门的技术。</p>\n<p>本文中用到的demo源码地址：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<h3 id=\"Gateway的特征\"><a href=\"#Gateway的特征\" class=\"headerlink\" title=\"Gateway的特征\"></a>Gateway的特征</h3><p>引用官方的文档：</p>\n<blockquote>\n<p>Spring Cloud Gateway features:</p>\n</blockquote>\n<ul>\n<li><p>Built on Spring Framework 5, Project Reactor and Spring Boot 2.0</p>\n</li>\n<li><p>Able to match routes on any request attribute.</p>\n</li>\n<li><p>Predicates and filters are specific to routes.</p>\n</li>\n<li><p>Circuit Breaker integration.</p>\n</li>\n<li><p>Spring Cloud DiscoveryClient integration</p>\n</li>\n<li><p>Easy to write Predicates and Filters</p>\n</li>\n<li><p>Request Rate Limiting</p>\n</li>\n<li><p>Path Rewriting</p>\n</li>\n<li><p>Spring Cloud Gateway 基于 Spring Framework 5, Project Reactor 和 Spring Boot 2.0</p>\n</li>\n<li><p>能够匹配任何请求属性上的路由。</p>\n</li>\n<li><p>Predicates和filters特定于路由，易于编写的Predicates和filters</p>\n</li>\n<li><p>Hystrix断路器的继承</p>\n</li>\n<li><p>集成了DiscoveryClient</p>\n</li>\n<li><p>具备了一些高级功：动态路由、限流、路径重写等</p>\n</li>\n</ul>\n<p>和zuul的功能相差不大，最主要的区别是底层通信框架的实现上。</p>\n<p>具体的通信框架这里就暂时不展开了。</p>\n<h2 id=\"微服务网关的应用场景\"><a href=\"#微服务网关的应用场景\" class=\"headerlink\" title=\"微服务网关的应用场景\"></a>微服务网关的应用场景</h2><p>在微服务架构中，网关起到了下层服务的路由、限流和路径重写等作用，下面用一张简单的架构图来描述一下微服务网关的作用：</p>\n<p><img   class=\"lazyload\" data-original=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/78dd5ad29dae4bf2b26ed589c74dd811~tplv-k3u1fbpfcp-zoom-1.image\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>上图中很直观的展示了Spring Cloud Gateway在整个架构中的作用。</p>\n<h2 id=\"Spring-Cloud-Gateway使用\"><a href=\"#Spring-Cloud-Gateway使用\" class=\"headerlink\" title=\"Spring Cloud Gateway使用\"></a>Spring Cloud Gateway使用</h2><h3 id=\"新建模块\"><a href=\"#新建模块\" class=\"headerlink\" title=\"新建模块\"></a>新建模块</h3><p>新建一个springboot工程，maven依赖如下，详细的配置可以查看demo源码</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-test<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">scope</span>&gt;</span>test<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">scope</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h3><p>修改配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">15010</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">118.25</span><span class=\"hljs-number\">.36</span><span class=\"hljs-number\">.41</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">locator:</span><br>          <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">false</span><br>          <span class=\"hljs-attr\">lowerCaseServiceId:</span> <span class=\"hljs-literal\">true</span><br>      <span class=\"hljs-attr\">routes:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">provider</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-provider</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/provider/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">consumer</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-consumer</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/consumer/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br><br>  <span class=\"hljs-attr\">application:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">winter-gateway</span><br></code></pre></td></tr></table></figure>\n\n<p>具体配置的解释后面会介绍。</p>\n<p>接下来就在启动类中加入注解: <code>@EnableDiscoveryClient</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@EnableDiscoveryClient</span><br><span class=\"hljs-meta\">@SpringBootApplication</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SpringCloudGatewayApplication</span> </span>&#123;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(SpringCloudGatewayApplication<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>, <span class=\"hljs-title\">args</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>启动服务：<code>spring-cloud-nacos-consumer</code>， <code>spring-cloud-nacos-provider</code>，<code>spring-cloud-gateway</code> </p>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>浏览器输入：<a href=\"http://127.0.0.1:15010/consumer/nacos/echo/hello\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:15010/consumer/nacos/echo/hello</a></p>\n<p>得到返回值：<code>Hello Nacos Discovery hello</code> </p>\n<h3 id=\"拓展：解决跨域问题\"><a href=\"#拓展：解决跨域问题\" class=\"headerlink\" title=\"拓展：解决跨域问题\"></a>拓展：解决跨域问题</h3><p>Spring Cloud Gateway如何解决跨域问题？我们可以在配置文件中加入：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">globalcors:</span><br>        <span class=\"hljs-attr\">cors-configurations:</span><br>          <span class=\"hljs-string\">'[/**]'</span><span class=\"hljs-string\">:</span> <span class=\"hljs-comment\"># 匹配所有请求</span><br>            <span class=\"hljs-attr\">allowedOrigins:</span> <span class=\"hljs-string\">\"*\"</span> <span class=\"hljs-comment\">#跨域处理 允许所有的域</span><br>            <span class=\"hljs-attr\">allowedMethods:</span> <span class=\"hljs-comment\"># 支持的方法</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">GET</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">POST</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">PUT</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">DELETE</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Spring-Cloud-Gateway-配置详解\"><a href=\"#Spring-Cloud-Gateway-配置详解\" class=\"headerlink\" title=\"Spring Cloud Gateway 配置详解\"></a>Spring Cloud Gateway 配置详解</h2><p>我们看一下上面我们用到的配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">15010</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">118.25</span><span class=\"hljs-number\">.36</span><span class=\"hljs-number\">.41</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">locator:</span><br>          <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">false</span><br>          <span class=\"hljs-attr\">lowerCaseServiceId:</span> <span class=\"hljs-literal\">true</span><br>      <span class=\"hljs-attr\">routes:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">provider</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-provider</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/provider/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span> <br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">consumer</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-consumer</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/consumer/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br><br>  <span class=\"hljs-attr\">application:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">winter-gateway</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>id</strong>：我们自定义的路由 ID，保持唯一</p>\n<p><strong>uri</strong>：目标服务地址</p>\n<p><strong>predicates</strong>：路由条件，Predicate 接受一个输入参数，返回一个布尔值结果。该接口包含多种默认方法来将 Predicate 组合成其他复杂的逻辑（比如：与，或，非）。</p>\n<p>上面这段配置的意思是，配置了一个 id 为 url-proxy-1的URI代理规则，路由的规则为：</p>\n<p>当访问地址<code>http://localhost:8080/provider/nacos/echo/hello</code>时，</p>\n<p>会路由到上游地址<code>http://winter-nacos-provider/nacos/echo/hello</code>。</p>\n<p><strong>filters</strong>: 过滤器是路由转发请求时所经过的过滤逻辑，可用于修改请求、响应内容，<code>StripPrefix=1</code>就代表截取路径的个数为1，比如前端过来请求<code>/provider/nacos/echo/hello</code>，匹配成功后，路由到后端的请求路径就会变成<code>http://127.0.0.1:16012/nacos/echo/hello</code>。</p>\n<p>关于gateway的详细配置，可以参考: </p>\n<p><a href=\"https://www.cnblogs.com/crazymakercircle/p/11704077.html\" target=\"_blank\" rel=\"noopener\">SpringCloud gateway （史上最全）</a></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>关于spring cloud gateway的介绍先讲到这里，后一篇会讲解如何在网关层集成swagger文档以及如何在网关层进行登录权限的验证。并且会介绍相关的原理。</p>\n<h2 id=\"源码地址\"><a href=\"#源码地址\" class=\"headerlink\" title=\"源码地址\"></a>源码地址</h2><p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<p>参考文献：</p>\n<p><a href=\"https://spring.io/projects/spring-cloud-gateway#overview\" target=\"_blank\" rel=\"noopener\">Spring Cloud Gateway</a></p>\n<p><a href=\"https://www.cnblogs.com/crazymakercircle/p/11704077.html\" target=\"_blank\" rel=\"noopener\">SpringCloud gateway （史上最全）</a></p>\n","raw":null,"categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"},{"name":"gateway","path":"api/tags/gateway.json"},{"name":"Hoxton","path":"api/tags/Hoxton.json"}]},{"title":"SpringCloud系列教程开篇","slug":"2021-07-23-spring-cloud-hoxton-1","date":"2021-07-23T08:55:00.000Z","updated":"2022-12-01T01:32:39.783Z","comments":true,"top":null,"path":"api/articles/2021-07-23-spring-cloud-hoxton-1.json","excerpt":null,"keywords":"java,spring,springboot,springcloud,mybatis,jQuery,html,css","cover":"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046760324597.jpg","content":"<p>SpringCloud 作为目前最热门的技术之一，拥有众多的开发者的爱戴，开箱即用，简单配置的特性让开发者只需要关注业务代码的开发，无需在繁琐和架构中挣扎。SpringCloud也成为了java开发人员必须了解和使用的技能。</p>\n<p>作为系列的开篇，全系列会介绍hoxton的正式版如何使用，也会对一些组件的原理进行介绍，并且会结合实战中的使用着重讲一讲。本文也会照顾初学者，一些详细的配置会深入浅出。</p>\n<h2 id=\"大纲\"><a href=\"#大纲\" class=\"headerlink\" title=\"大纲\"></a>大纲</h2><ul>\n<li>为什么要学习Spring Cloud</li>\n<li>什么是Spring Cloud</li>\n<li>优缺点</li>\n<li>需要的版本</li>\n<li>组件的介绍</li>\n<li>实战中的应用介绍</li>\n</ul>\n<h2 id=\"为什么要学习springcloud\"><a href=\"#为什么要学习springcloud\" class=\"headerlink\" title=\"为什么要学习springcloud\"></a>为什么要学习springcloud</h2><p>不论是商业应用还是用户应用，在业务初期都很简单，我们通常会把它实现为单体结构的应用。但是，随着业务逐渐发展，产品思想会变得越来越复杂，单体结构的应用也会越来越复杂。这就会给应用带来如下的几个问题：</p>\n<ul>\n<li>代码结构混乱：业务复杂，导致代码量很大，管理会越来越困难。同时，这也会给业务的快速迭代带来巨大挑战；</li>\n<li>开发效率变低：开发人员同时开发一套代码，很难避免代码冲突。开发过程会伴随着不断解决冲突的过程，这会严重的影响开发效率；</li>\n<li>排查解决问题成本高：线上业务发现 bug，修复 bug 的过程可能很简单。但是，由于只有一套代码，需要重新编译、打包、上线，成本很高。</li>\n</ul>\n<p>由于单体结构的应用随着系统复杂度的增高，会暴露出各种各样的问题。近些年来，微服务架构逐渐取代了单体架构，且这种趋势将会越来越流行。Spring Cloud是目前最常用的微服务开发框架，已经在企业级开发中大量的应用。</p>\n<h2 id=\"什么是Spring-Cloud\"><a href=\"#什么是Spring-Cloud\" class=\"headerlink\" title=\"什么是Spring Cloud\"></a>什么是Spring Cloud</h2><p>Spring Cloud是一系列框架的有序集合。它利用Spring Boot的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、智能路由、消息总线、负载均衡、断路器、数据监控等，都可以用Spring Boot的开发风格做到一键启动和部署。Spring Cloud并没有重复制造轮子，它只是将各家公司开发的比较成熟、经得起实际考验的服务框架组合起来，通过Spring Boot风格进行再封装屏蔽掉了复杂的配置和实现原理，最终给开发者留出了一套简单易懂、易部署和易维护的分布式系统开发工具包。</p>\n<h2 id=\"优缺点\"><a href=\"#优缺点\" class=\"headerlink\" title=\"优缺点\"></a>优缺点</h2><h3 id=\"优点：\"><a href=\"#优点：\" class=\"headerlink\" title=\"优点：\"></a>优点：</h3><ul>\n<li>产出于Spring大家族，Spring在企业级开发框架中无人能敌，来头很大，可以保证后续的更新、完善</li>\n<li>组件丰富，功能齐全。Spring Cloud 为微服务架构提供了非常完整的支持。例如、配置管理、服务发现、断路器、微服务网关等；</li>\n<li>Spring Cloud 社区活跃度很高，教程很丰富，遇到问题很容易找到解决方案</li>\n<li>服务拆分粒度更细，耦合度比较低，有利于资源重复利用，有利于提高开发效率</li>\n<li>可以更精准的制定优化服务方案，提高系统的可维护性</li>\n<li>减轻团队的成本，可以并行开发，不用关注其他人怎么开发，先关注自己的开发</li>\n<li>微服务可以是跨平台的，可以用任何一种语言开发</li>\n<li>适于互联网时代，产品迭代周期更短</li>\n</ul>\n<h3 id=\"缺点：\"><a href=\"#缺点：\" class=\"headerlink\" title=\"缺点：\"></a>缺点：</h3><ul>\n<li>微服务过多，治理成本高，不利于维护系统</li>\n<li>分布式系统开发的成本高(容错，分布式事务等)对团队挑战大</li>\n</ul>\n<p>总的来说优点大过于缺点，目前看来Spring Cloud是一套非常完善的分布式框架，目前很多企业开始用微服务、Spring Cloud的优势是显而易见的。因此对于想研究微服务架构的同学来说，学习Spring Cloud是一个不错的选择。</p>\n<h2 id=\"版本\"><a href=\"#版本\" class=\"headerlink\" title=\"版本\"></a>版本</h2><p>本次教程以Hoxton最新的RELEASE版本进行整合。</p>\n<h3 id=\"为什么使用Hoxton版本？\"><a href=\"#为什么使用Hoxton版本？\" class=\"headerlink\" title=\"为什么使用Hoxton版本？\"></a>为什么使用Hoxton版本？</h3><p>因为springboot作为springcloud底层基础设施，所以springcloud与springboot版本需要正确的兼容，不然会在整合的过程中出现很多的问题，各种<code>class not found</code>，<code>method not found</code>。回到问题本身，为什么要使用hoxton版本，那是因为直到目前为止，官方更新的稳定版只有hoxton.release，在生产环境中，最好要使用release版本。</p>\n<h3 id=\"那么初学者如何快速找到合适的版本呢？\"><a href=\"#那么初学者如何快速找到合适的版本呢？\" class=\"headerlink\" title=\"那么初学者如何快速找到合适的版本呢？\"></a>那么初学者如何快速找到合适的版本呢？</h3><p>当然是查看<a href=\"https://spring.io/projects/spring-cloud\" target=\"_blank\" rel=\"noopener\">官方文档</a>了</p>\n<table>\n<thead>\n<tr>\n<th>Release Train</th>\n<th>Boot Version</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><a href=\"https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2020.0-Release-Notes\" target=\"_blank\" rel=\"noopener\">https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2020.0-Release-Notes</a> aka Ilford</td>\n<td>2.4.x, 2.5.x (Starting with 2020.0.3)</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Hoxton-Release-Notes\" target=\"_blank\" rel=\"noopener\">https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Hoxton-Release-Notes</a></td>\n<td>2.2.x, 2.3.x (Starting with SR5)</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Greenwich-Release-Notes\" target=\"_blank\" rel=\"noopener\">https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Greenwich-Release-Notes</a></td>\n<td>2.1.x</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Finchley-Release-Notes\" target=\"_blank\" rel=\"noopener\">https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Finchley-Release-Notes</a></td>\n<td>2.0.x</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Edgware-Release-Notes\" target=\"_blank\" rel=\"noopener\">https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Edgware-Release-Notes</a></td>\n<td>1.5.x</td>\n</tr>\n<tr>\n<td><a href=\"https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Dalston-Release-Notes\" target=\"_blank\" rel=\"noopener\">https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Dalston-Release-Notes</a></td>\n<td>1.5.x</td>\n</tr>\n</tbody></table>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046454878575.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">springcloud版本</span></p>\n<p>由此可以看出最新的稳定版。</p>\n<h2 id=\"组件的介绍\"><a href=\"#组件的介绍\" class=\"headerlink\" title=\"组件的介绍\"></a>组件的介绍</h2><p>springcloud家族有着众多的组件，不可能所有的组件都是我们适用的，需要结合业务选择合适的组件使用，其他的组件可以了解一下，后面的教程会结合目前比较热门的方案进行整合使用，下面的表是比较热门的组件介绍：</p>\n<table>\n<thead>\n<tr>\n<th>组件名</th>\n<th>功能</th>\n<th>简介</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>spring-cloud-starter-alibaba-nacos-config</td>\n<td>配置中心</td>\n<td>阿里巴巴开源的nacos配置中心，简单易用，稳定可靠。</td>\n</tr>\n<tr>\n<td>spring-cloud-starter-alibaba-nacos-discovery</td>\n<td>服务注册与发现（注册中心）</td>\n<td>阿里巴巴开源的nacox注册中心，非常稳定，速度快。</td>\n</tr>\n<tr>\n<td>spring-cloud-openfeign</td>\n<td>服务远程调用，服务熔断，负载均衡</td>\n<td></td>\n</tr>\n<tr>\n<td>spring-cloud-gateway</td>\n<td>服务网关</td>\n<td>负责服务的路由，限流，权限验证，请求过滤</td>\n</tr>\n<tr>\n<td>spring-cloud-starter-alibaba-sentinel</td>\n<td>服务限流</td>\n<td>阿里巴巴开源</td>\n</tr>\n<tr>\n<td>spring-cloud-starter-alibaba-seata</td>\n<td>分布式事务组件</td>\n<td>阿里巴巴开源</td>\n</tr>\n</tbody></table>\n<p>其它的组件后续会继续讲解。</p>\n<h2 id=\"实战中的应用\"><a href=\"#实战中的应用\" class=\"headerlink\" title=\"实战中的应用\"></a>实战中的应用</h2><p>先看一张技术架构图：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046455117574.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">spring cloud 技术架构图</span></p>\n<p>假设现在有一个请求过来，</p>\n<ul>\n<li>第一站到达gateway网关，gateway负责请求的路由（请求到具体的服务节点），限流权限验证（登录，权限），请求过滤；</li>\n<li>第二站，路由到了具体的服务，比如用户中心，用户中心调用课程管理中心接口，课程管理中心服务有很多节点，具体选择哪个节点呢？这时候需要服务的负载均衡，ribbon根据具体的策略进行服务的负载。</li>\n<li>如果请求课程管理中心服务的节点超时异常，那么feign集成的hystrix负责服务的熔断，如果不熔断会导致请求阻塞，请求一直积压，最终会导致整个服务器集群宕机，有了服务熔断机制，当服务不可用的时候会将节点设置为不可用状态，并将请求打到其它可用节点，后续会轮询该节点，如果可用会恢复到可用状态。</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>讲到了为何使用springcloud以及基础组件的介绍，后续会更加深入的讲解组件的使用。</p>\n<p>搭建源码地址：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">WinterChenS/spring-cloud-hoxton-study</a></p>\n<h3 id=\"参考文档：\"><a href=\"#参考文档：\" class=\"headerlink\" title=\"参考文档：\"></a>参考文档：</h3><p><a href=\"https://spring.io/projects/spring-cloud\" target=\"_blank\" rel=\"noopener\">Spring Cloud</a></p>\n<p><a href=\"https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Hoxton-Release-Notes\" target=\"_blank\" rel=\"noopener\">Spring Cloud Hoxton Release Notes · spring-cloud/spring-cloud-release Wiki</a></p>\n<p><a href=\"https://blog.csdn.net/weixin_39786341/article/details/111392364\" target=\"_blank\" rel=\"noopener\">springcloud 版本</a></p>\n","raw":null,"categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"}]},{"title":"SpringCloud系列教程(二)之Nacos","slug":"2021-08-01-spring-cloud-hoxton-2-nacos","date":"2021-08-01T05:14:00.000Z","updated":"2022-12-01T01:32:39.783Z","comments":true,"top":null,"path":"api/articles/2021-08-01-spring-cloud-hoxton-2-nacos.json","excerpt":null,"keywords":"java,spring,springboot,springcloud,mybatis,jQuery,html,css","cover":"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046761982351.jpg","content":"<blockquote>\n<p>阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n</ol>\n<h2 id=\"本文概览\"><a href=\"#本文概览\" class=\"headerlink\" title=\"本文概览\"></a>本文概览</h2><ul>\n<li>什么是注册中心？</li>\n<li>什么是配置中心？</li>\n<li>如何在springcloud中使用Nacos？</li>\n</ul>\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在使用nacos之前我们需要理解nacos在整个微服务架构中担任了什么样的角色，在微服务架构中，注册中心是非常核心的基础服务之一，在微服务流行之前就已经出现在分布式架构中。比如Dubbo，Dubbo在国内是比较流行的分布式架构，也是一个非常实用的框架，提供了比较完备的服务治理功能，而服务治理的实现主要依靠注册中心。</p>\n<p>本文中用到的demo源码地址：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<h2 id=\"什么是注册中心？\"><a href=\"#什么是注册中心？\" class=\"headerlink\" title=\"什么是注册中心？\"></a>什么是注册中心？</h2><p>注册中心可以说是微服务架构中的”通讯录“，它记录了服务和服务地址的映射关系。在分布式架构中，服务会注册到这里，当服务需要调用其它服务时，就这里找到服务的地址，进行调用。</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046455713643.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>列举一个比较简单的生活例子：</p>\n<ol>\n<li>小明要给小红打电话，需要从通讯录(注册中心)中获取到小红的电话号码(服务地址);</li>\n<li>小明根据通讯录中的电话号码拨打小红的电话号码(服务请求);</li>\n<li>小红接通了电话，并随后完成了通话；</li>\n<li>后面再拨打小红的电话号码可以通过电话保存的号码进行拨打(本地缓存);</li>\n</ol>\n<p>nacos在整个微服务架构中充当了通讯录的角色，服务之间的调用，监控等都需要通过注册中心进行获取服务的地址端口的映射，并且一般服务端都会有本地缓存，下次请求之前会查询本地的服务映射信息，可以减少网络请求提高服务的吞吐量。</p>\n<h2 id=\"什么是配置中心？\"><a href=\"#什么是配置中心？\" class=\"headerlink\" title=\"什么是配置中心？\"></a>什么是配置中心？</h2><p>配置中心其实理解起来很简单，就是字面意思，把服务的配置集中在配置中心，可以实现动态的修改，避免了每次修改配置文件都需要重新发布服务的尴尬。</p>\n<h2 id=\"下载nacos，并启动\"><a href=\"#下载nacos，并启动\" class=\"headerlink\" title=\"下载nacos，并启动\"></a>下载nacos，并启动</h2><p>Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。下载地址<a href=\"https://github.com/alibaba/nacos/releases，下载最新版的2.0版本。\" target=\"_blank\" rel=\"noopener\">https://github.com/alibaba/nacos/releases，下载最新版的2.0版本。</a></p>\n<p>下载完成后，解压，在解压后的文件的/bin目录下，windows系统点击startup.cmd就可以启动nacos。linux或mac执行以下命令启动nacos。</p>\n<p>sh startup.sh -m standalone</p>\n<p>登陆页面：<a href=\"http://localhost:8848/nacos/\" target=\"_blank\" rel=\"noopener\">http://localhost:8848/nacos/</a> 登陆用户nacos，登陆密码为nacos。</p>\n<h2 id=\"jdk版本\"><a href=\"#jdk版本\" class=\"headerlink\" title=\"jdk版本\"></a>jdk版本</h2><ul>\n<li>jdk： 1.8</li>\n<li>maven： 3.3.9</li>\n<li>nacos: 2.0</li>\n</ul>\n<h2 id=\"springcloud-和-springboot-版本\"><a href=\"#springcloud-和-springboot-版本\" class=\"headerlink\" title=\"springcloud 和 springboot 版本\"></a>springcloud 和 springboot 版本</h2><ul>\n<li>springcloud: Hoxton.RELEASE</li>\n<li>springboot: 2.2.13.RELEASE</li>\n<li>springcloud-alibaba: 2.2.0.RELEASE</li>\n</ul>\n<h2 id=\"配置中心\"><a href=\"#配置中心\" class=\"headerlink\" title=\"配置中心\"></a>配置中心</h2><p>首先我们新建一个springboot 基础项目，这里项目命名为：<code>spring-cloud-hoxton-study</code></p>\n<h3 id=\"项目结构：\"><a href=\"#项目结构：\" class=\"headerlink\" title=\"项目结构：\"></a>项目结构：</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\">-spring-cloud-hoxton-study<br>  |—spring-cloud-nacos-consumer<br>  |—pom.xml<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"父pom文件加入依赖-spring-cloud-hoxton-study-：\"><a href=\"#父pom文件加入依赖-spring-cloud-hoxton-study-：\" class=\"headerlink\" title=\"父pom文件加入依赖(spring-cloud-hoxton-study)：\"></a>父pom文件加入依赖(spring-cloud-hoxton-study)：</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">properties</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">java.version</span>&gt;</span>1.8<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">java.version</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">spring-cloud.version</span>&gt;</span>Hoxton.RELEASE<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">spring-cloud.version</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">spring-boot.version</span>&gt;</span>2.2.13.RELEASE<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">spring-boot.version</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">spring-cloud-alibaba.version</span>&gt;</span>2.2.0.RELEASE<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">spring-cloud-alibaba.version</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">properties</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependencyManagement</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependencies</span>&gt;</span><br>            <span class=\"hljs-comment\">&lt;!-- springCloud依赖 --&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-dependencies<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">type</span>&gt;</span>pom<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">type</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">scope</span>&gt;</span>import<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">scope</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br>            <span class=\"hljs-comment\">&lt;!-- springBoot依赖 --&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-dependencies<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">type</span>&gt;</span>pom<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">type</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">scope</span>&gt;</span>import<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">scope</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br>\t\t\t\t\t\t<span class=\"hljs-comment\">&lt;!-- spring cloud alibaba 依赖 --&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">type</span>&gt;</span>pom<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">type</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">scope</span>&gt;</span>import<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">scope</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependencies</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"子pom修改-spring-cloud-nacos-consumer-：parent\"><a href=\"#子pom修改-spring-cloud-nacos-consumer-：parent\" class=\"headerlink\" title=\"子pom修改(spring-cloud-nacos-consumer)：parent\"></a>子pom修改(spring-cloud-nacos-consumer)：parent</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">parent</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.winterchen<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-hoxton-study<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>0.0.1-SNAPSHOT<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">parent</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"子pom加入依赖-spring-cloud-nacos-consumer-：\"><a href=\"#子pom加入依赖-spring-cloud-nacos-consumer-：\" class=\"headerlink\" title=\"子pom加入依赖(spring-cloud-nacos-consumer)：\"></a>子pom加入依赖(spring-cloud-nacos-consumer)：</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-web<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意：这里只是放了主要的maven依赖，如果需要查看全部的依赖，请查看<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">demo的源码</a></p>\n</blockquote>\n<h3 id=\"创建配置：bootstrap-properties-或者-bootstrap-yml\"><a href=\"#创建配置：bootstrap-properties-或者-bootstrap-yml\" class=\"headerlink\" title=\"创建配置：bootstrap.properties 或者 bootstrap.yml\"></a>创建配置：<code>bootstrap.properties</code> 或者 <code>bootstrap.yml</code></h3><p>bootstrap.properties</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs plain\">spring.cloud.nacos.config.server-addr&#x3D;127.0.0.1:8848<br><br>spring.application.name&#x3D;winter-nacos-consumer<br><br>spring.profiles.active&#x3D;dev<br></code></pre></td></tr></table></figure>\n\n<p>bootstrap.yml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">config:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8848</span><br>        <span class=\"hljs-attr\">file-extension:</span> <span class=\"hljs-string\">yaml</span><br>  <span class=\"hljs-attr\">application:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">winter-nacos-consumer</span><br>  <span class=\"hljs-attr\">profiles:</span><br>    <span class=\"hljs-attr\">active:</span> <span class=\"hljs-string\">dev</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>文中的：127.0.0.1:8848 就是上面搭建的nacos服务</p>\n</blockquote>\n<p>之所以需要配置 <code>spring.application.name</code>是因为nacos默认获取配置文件是按照name作为dataId的</p>\n<p>在 Nacos Spring Cloud 中，dataId 的完整格式如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs plain\">$&#123;prefix&#125;-$&#123;spring.profiles.active&#125;.$&#123;file-extension&#125;<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li>prefix 默认为 <code>spring.application.name</code> 的值，也可以通过配置项 <code>spring.cloud.nacos.config.prefix</code>来配置。</li>\n<li><code>spring.profiles.active</code> 即为当前环境对应的 <code>profile</code>，详情可以参考 <code>Spring Boot</code>文档。 注意：当 <code>spring.profiles.active</code> 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 <code>${prefix}.${file-extension}</code></li>\n<li><code>file-exetension</code> 为配置内容的数据格式，可以通过配置项 <code>spring.cloud.nacos.config.file-extension</code> 来配置。目前只支持 <code>properties</code> 和 <code>yaml</code> 类型。</li>\n</ul>\n<h3 id=\"在nacos配置中心创建配置文件\"><a href=\"#在nacos配置中心创建配置文件\" class=\"headerlink\" title=\"在nacos配置中心创建配置文件\"></a>在nacos配置中心创建配置文件</h3><p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046455981185.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>配置详情：</p>\n<p>Data ID: <code>winter-nacos-consumer-dev.yaml</code></p>\n<p>Group: <code>DEFAULT_GROUP</code></p>\n<p>配置内容：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">16011</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8848</span><br><br><span class=\"hljs-attr\">test:</span><br>  <span class=\"hljs-attr\">config:</span><br>    <span class=\"hljs-attr\">refresh:</span> <span class=\"hljs-literal\">true</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"自动刷新\"><a href=\"#自动刷新\" class=\"headerlink\" title=\"自动刷新\"></a>自动刷新</h3><p>通过 Spring Cloud 原生注解 @RefreshScope 实现配置自动更新：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Api</span>(<span class=\"hljs-string\">\"nacos api\"</span>)<br><span class=\"hljs-meta\">@RestController</span><br><span class=\"hljs-meta\">@RequestMapping</span>(<span class=\"hljs-string\">\"/nacos\"</span>)<br><span class=\"hljs-meta\">@RefreshScope</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">NacosController</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">BaseController</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;test.config.refresh:true&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">boolean</span> refresh;<br><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> CommonResult&lt;Boolean&gt; <span class=\"hljs-title\">get</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> CommonResult.success(refresh);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"如何测试\"><a href=\"#如何测试\" class=\"headerlink\" title=\"如何测试\"></a>如何测试</h3><p>我们可以通过请求上面的接口: <a href=\"http://127.0.0.1:16011/nacos\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:16011/nacos</a></p>\n<p>返回的结果是：true</p>\n<p>然后修改一下配置中心的:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">test:<br>  config:<br>    refresh: <span class=\"hljs-keyword\">false</span><br></code></pre></td></tr></table></figure>\n\n<p>可以发现控制台的日志有打印：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-number\">2021</span>-<span class=\"hljs-number\">07</span>-<span class=\"hljs-number\">27</span> <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">25</span>:<span class=\"hljs-number\">13.973</span>  INFO <span class=\"hljs-number\">17240</span> --- [<span class=\"hljs-number\">8.25</span><span class=\"hljs-number\">.36</span><span class=\"hljs-number\">.41_8848</span>] o.s.c.e.event.RefreshEventListener       : Refresh keys changed: [test.config.refresh]<br></code></pre></td></tr></table></figure>\n\n<p>再请求一次就可以发现结果变成了：false</p>\n<h2 id=\"服务注册与发现\"><a href=\"#服务注册与发现\" class=\"headerlink\" title=\"服务注册与发现\"></a>服务注册与发现</h2><p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046456195432.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<blockquote>\n<p>仍然使用上面的项目进行</p>\n</blockquote>\n<h3 id=\"添加依赖：\"><a href=\"#添加依赖：\" class=\"headerlink\" title=\"添加依赖：\"></a>添加依赖：</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">&lt;!-- Nacos 注册中心 --&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"增加配置\"><a href=\"#增加配置\" class=\"headerlink\" title=\"增加配置\"></a>增加配置</h3><p>以下是完整的配置</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">16011</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8848</span><br><br><span class=\"hljs-attr\">test:</span><br>  <span class=\"hljs-attr\">config:</span><br>    <span class=\"hljs-attr\">refresh:</span> <span class=\"hljs-literal\">true</span><br></code></pre></td></tr></table></figure>\n\n<p>启动类增加：<code>@EnableDiscoveryClient</code> 以启用服务注册与发现</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@SpringBootApplication</span>(exclude= &#123;DataSourceAutoConfiguration<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>&#125;)</span><br><span class=\"hljs-class\">@<span class=\"hljs-title\">EnableDiscoveryClient</span></span><br><span class=\"hljs-class\"><span class=\"hljs-title\">public</span> <span class=\"hljs-title\">class</span> <span class=\"hljs-title\">SpringCloudNacosApplication</span> </span>&#123;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(SpringCloudNacosApplication<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>, <span class=\"hljs-title\">args</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>接下来需要测试一下服务注册与发现的功能是否正常，所以我们需要<strong>复制</strong>原有的服务<code>spring-cloud-nacos-consumer</code> 并改名为：<code>spring-cloud-nacos-provider</code></p>\n<p>当前工程结构：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\">-spring-cloud-hoxton-study<br>  |—spring-cloud-nacos-consumer<br>  |—spring-cloud-nacos-provider<br>  |—pom.xml<br></code></pre></td></tr></table></figure>\n\n<p><code>spring-cloud-nacos-consumer</code> 服务下的<code>NacosController</code> 增加方法：<code>echo</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@RestController</span><br><span class=\"hljs-meta\">@RequestMapping</span>(<span class=\"hljs-string\">\"/nacos\"</span>)<br><span class=\"hljs-meta\">@RefreshScope</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">NacosController</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;test.config.refresh:true&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">boolean</span> refresh;<br><br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> RestTemplate restTemplate;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">NacosController</span><span class=\"hljs-params\">(RestTemplate restTemplate)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.restTemplate = restTemplate;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">boolean</span> <span class=\"hljs-title\">get</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> refresh;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/echo/&#123;str&#125;\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">echo</span><span class=\"hljs-params\">(@PathVariable String str)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> restTemplate.getForObject(<span class=\"hljs-string\">\"http://winter-nacos-provider/nacos/echo/\"</span> + str, String<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>spring-cloud-nacos-provider</code> 服务下的<code>NacosController</code> 增加方法：<code>echo</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@RestController</span><br><span class=\"hljs-meta\">@RequestMapping</span>(<span class=\"hljs-string\">\"/nacos\"</span>)<br><span class=\"hljs-meta\">@RefreshScope</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">NacosController</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;test.config.refresh:true&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">boolean</span> refresh;<br><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">boolean</span> <span class=\"hljs-title\">get</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> refresh;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/echo/&#123;string&#125;\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">echo</span><span class=\"hljs-params\">(@PathVariable String string)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"Hello Nacos Discovery \"</span> + string;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"开始测试：\"><a href=\"#开始测试：\" class=\"headerlink\" title=\"开始测试：\"></a>开始测试：</h3><p>测试之前需要给<code>spring-cloud-nacos-provider</code> 进行配置中心的配置：</p>\n<ol>\n<li>修改<code>bootstrap.yml</code> 的 <code>spring.application.name=winter-nacos-provider</code> ;</li>\n<li>在配置中心新增配置文件：<code>winter-nacos-provider-dev.yaml</code> 具体的配置如下:</li>\n</ol>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">16012</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">118.25</span><span class=\"hljs-number\">.36</span><span class=\"hljs-number\">.41</span><span class=\"hljs-string\">:8848</span><br>  <span class=\"hljs-attr\">profiles:</span><br>    <span class=\"hljs-attr\">active:</span> <span class=\"hljs-string\">dev</span><br><br><span class=\"hljs-attr\">test:</span><br>  <span class=\"hljs-attr\">config:</span><br>    <span class=\"hljs-attr\">refresh:</span> <span class=\"hljs-literal\">true</span><br></code></pre></td></tr></table></figure>\n\n<p>分别启动两个服务，然后调用接口: <a href=\"http://127.0.0.1:16011/nacos/echo/hello\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:16011/nacos/echo/hello</a></p>\n<p>请求的结果：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046456542050.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>本文介绍了springcloud如何使用nacos作为配置中心和注册中心，作为微服务中比较核心的两个基础功能，需要熟练的在实战中进行使用，后面也会陆续介绍如何与其他的组件进行组合使用。</p>\n<p>上面使用的restTemplate进行服务的调用，这样显然在实际的使用当中是非常的不便利的，那么在实际应用中使用什么方式进行远程调用呢？下一篇将介绍如何使用open feign进行远程服务调用的。</p>\n<h2 id=\"源码地址\"><a href=\"#源码地址\" class=\"headerlink\" title=\"源码地址\"></a>源码地址</h2><p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<p>参考文献：</p>\n<p><a href=\"https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html\" target=\"_blank\" rel=\"noopener\">Nacos Spring Cloud 快速开始</a></p>\n","raw":null,"categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"},{"name":"Hoxton","path":"api/tags/Hoxton.json"},{"name":"nacos","path":"api/tags/nacos.json"}]},{"title":"SpringCloud系列教程(六)之SpringCloud 使用sentinel作为熔断器","slug":"2021-08-05-spring-cloud-hoxton-6-sentinel","date":"2021-08-05T02:05:00.000Z","updated":"2022-12-01T01:32:39.787Z","comments":true,"top":null,"path":"api/articles/2021-08-05-spring-cloud-hoxton-6-sentinel.json","excerpt":null,"keywords":"java,spring,springboot,springcloud,mybatis,jQuery,html,css","cover":"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805100552.jpg","content":"<blockquote>\n<p>阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>由于knife4j比swagger更加友好，所以本文集成knife4j</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6991635985847025671\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992010061576929310\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(四)之SpringCloud Gateway | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992404611617259534\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(五)之SpringCloud Gateway 网关聚合开发文档 swagger knife4j 和登录权限统一验证</a></li>\n</ul>\n<h2 id=\"本文概览\"><a href=\"#本文概览\" class=\"headerlink\" title=\"本文概览\"></a>本文概览</h2><ul>\n<li>什么是熔断器</li>\n<li>什么是sentinel</li>\n<li>spring cloud 整合sentinel</li>\n<li>实际的应用场景</li>\n</ul>\n<h2 id=\"什么是熔断器\"><a href=\"#什么是熔断器\" class=\"headerlink\" title=\"什么是熔断器\"></a>什么是熔断器</h2><p>想必大家都知道一个生活中常见的物件，保险丝，其实它就是一种熔断器，当电器出现短路故障导致瞬间电流超过瞬间值会触发熔断，导致断开电路，从而保护了整个电路和电器的安全。</p>\n<p><strong>熔断器（fuse）</strong>是指当电流超过规定值时，以本身产生的热量使熔体熔断，断开电路的一种电器。熔断器是根据电流超过规定值一段时间后，以其自身产生的热量使熔体熔化，从而使电路断开；运用这种原理制成的一种电流保护器。熔断器广泛应用于高低压配电系统和控制系统以及用电设备中，作为短路和过电流的保护器，是应用最普遍的保护器件之一。</p>\n<p>可能就有同学要问了，这个跟我们说的服务的熔断器有什么关系呢？其实很多原理性的事物都跟生活息息相关的，电路的熔断，保护电路和电器。在代码的世界里，可以对服务起到流量控制和降级熔断的能力，可以做到部分服务的宕机不会导致整个服务集群的雪崩。</p>\n<h2 id=\"什么是sentinel\"><a href=\"#什么是sentinel\" class=\"headerlink\" title=\"什么是sentinel\"></a>什么是sentinel</h2><p>sentinel是阿里巴巴开源的服务治理的框架，sentinel中文译名为哨兵，是为微服务提供流量控制、熔断降级的功能，它和Hystrix提供的功能一样，可以有效的解决微服务调用产生的“雪崩”效应，为微服务系统提供了稳定性的解决方案。</p>\n<p>随着Hytrxi进入了维护期，不再提供新功能，Sentinel是一个不错的替代方案。通常情况，Hystrix采用线程池对服务的调用进行隔离，Sentinel才用了用户线程对接口进行隔离，二者相比，Hystrxi是服务级别的隔离，Sentinel提供了接口级别的隔离，Sentinel隔离级别更加精细，另外Sentinel直接使用用户线程进行限制，相比Hystrix的线程池隔离，减少了线程切换的开销。另外Sentinel的DashBoard提供了在线更改限流规则的配置，也更加的优化。</p>\n<p>通过官方文档的介绍，sentinel有以下特征：</p>\n<ul>\n<li>丰富的应用场景： Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、实时熔断下游不可用应用等。</li>\n<li>完备的实时监控： Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li>\n<li>广泛的开源生态： Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</li>\n<li>完善的 SPI 扩展点： Sentinel 提供简单易用、完善的 SPI 扩展点。您可以通过实现扩展点，快速的定制逻辑。例如定制规则管理、适配数据源等。</li>\n</ul>\n<p>Sentinel的主要特性：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095331.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<h3 id=\"Sentinel-功能和设计理念\"><a href=\"#Sentinel-功能和设计理念\" class=\"headerlink\" title=\"Sentinel 功能和设计理念\"></a>Sentinel 功能和设计理念</h3><p><strong>流量控制</strong></p>\n<p>流量控制在网络传输中是一个常用的概念，它用于调整网络包的发送数据。然而，从系统稳定性角度考虑，在处理请求的速度上，也有非常多的讲究。任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。Sentinel 作为一个调配器，可以根据需要把随机的请求调整成合适的形状，如下图所示：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095541.jpeg\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>流量控制有以下几个角度:</p>\n<ul>\n<li>资源的调用关系，例如资源的调用链路，资源和资源之间的关系；</li>\n<li>运行指标，例如 QPS、线程池、系统负载等；</li>\n<li>控制的效果，例如直接限流、冷启动、排队等。</li>\n</ul>\n<p>Sentinel 的设计理念是让您自由选择控制的角度，并进行灵活组合，从而达到想要的效果。</p>\n<h3 id=\"熔断降级\"><a href=\"#熔断降级\" class=\"headerlink\" title=\"熔断降级\"></a>熔断降级</h3><p>除了流量控制以外，降低调用链路中的不稳定资源也是 Sentinel 的使命之一。由于调用关系的复杂性，如果调用链路中的某个资源出现了不稳定，最终会导致请求发生堆积。这个问题和 <a href=\"https://github.com/Netflix/Hystrix/wiki#what-problem-does-hystrix-solve\" target=\"_blank\" rel=\"noopener\">Hystrix</a> 里面描述的问题是一样的。</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095642.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>Sentinel 和 Hystrix 的原则是一致的: 当调用链路中某个资源出现不稳定，例如，表现为 timeout，异常比例升高的时候，则对这个资源的调用进行限制，并让请求快速失败，避免影响到其它的资源，最终产生雪崩的效果。</p>\n<h3 id=\"Sentinel-是如何工作的\"><a href=\"#Sentinel-是如何工作的\" class=\"headerlink\" title=\"Sentinel 是如何工作的\"></a>Sentinel 是如何工作的</h3><p>Sentinel 的主要工作机制如下：</p>\n<ul>\n<li>对主流框架提供适配或者显示的 API，来定义需要保护的资源，并提供设施对资源进行实时统计和调用链路分析。</li>\n<li>根据预设的规则，结合对资源的实时统计信息，对流量进行控制。同时，Sentinel 提供开放的接口，方便您定义及改变规则。</li>\n<li>Sentinel 提供实时的监控系统，方便您快速了解目前系统的状态。</li>\n</ul>\n<h2 id=\"Spring-Cloud-整合-Sentinel\"><a href=\"#Spring-Cloud-整合-Sentinel\" class=\"headerlink\" title=\"Spring Cloud 整合 Sentinel\"></a>Spring Cloud 整合 Sentinel</h2><blockquote>\n<p>注意：本文整合的工程是基于前几篇文章提供的，所以需要根据前几篇的内容一步步的搭建</p>\n</blockquote>\n<h3 id=\"下载安装sentinel-dashboard\"><a href=\"#下载安装sentinel-dashboard\" class=\"headerlink\" title=\"下载安装sentinel dashboard\"></a>下载安装sentinel dashboard</h3><p>从官方的github仓库下载最新的release版本：<a href=\"https://github.com/alibaba/Sentinel/releases\" target=\"_blank\" rel=\"noopener\">https://github.com/alibaba/Sentinel/releases</a></p>\n<p>下载完之后启动服务，端口为8748，启动命令如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">java -Dserver.port=<span class=\"hljs-number\">8748</span> -Dcsp.sentinel.dashboard.server=localhost:<span class=\"hljs-number\">8748</span> -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-<span class=\"hljs-number\">1.8</span><span class=\"hljs-number\">.2</span>.jar<br></code></pre></td></tr></table></figure>\n\n<p>启动完之后登录控制台：<a href=\"http://localhost:8748/\" target=\"_blank\" rel=\"noopener\">http://localhost:8748</a></p>\n<p>账号：sentinel   密码:   sentinel</p>\n<h3 id=\"改造工程consumer\"><a href=\"#改造工程consumer\" class=\"headerlink\" title=\"改造工程consumer\"></a>改造工程consumer</h3><p>增加maven依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>修改配置<code>application.yml</code>(只显示部分需要修改的配置)：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">sentinel:</span><br>      <span class=\"hljs-attr\">transport:</span><br>        <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">18763</span>  <span class=\"hljs-comment\">#1</span><br>        <span class=\"hljs-attr\">dashboard:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8748</span><br><br><span class=\"hljs-attr\">feign:</span><br>  <span class=\"hljs-attr\">sentinel:</span><br>    <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">true</span> <span class=\"hljs-comment\">#2</span><br></code></pre></td></tr></table></figure>\n\n<ol>\n<li>这里的 <code>spring.cloud.sentinel.transport.port</code> 端口配置会在应用对应的机器上启动一个 Http Server，该 Server 会与 Sentinel 控制台做交互。比如 Sentinel 控制台添加了一个限流规则，会把规则数据 push 给这个 Http Server 接收，Http Server 再将规则注册到 Sentinel 中。</li>\n<li>通过<code>feign.sentinel.enable</code>开启Feign和sentinel的自动适配。</li>\n</ol>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>分别启动provider/consumer/gateway服务，然后<strong>多次请求</strong>: <a href=\"http://localhost:16011/nacos/feign-test/hello\" target=\"_blank\" rel=\"noopener\">http://localhost:16011/nacos/feign-test/hello</a></p>\n<blockquote>\n<p>注意：需要请求接口之后才可以在控制台看到对应的服务和接口。</p>\n</blockquote>\n<p>打开控制台可以看到：</p>\n<p>实时监控：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095343.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>簇点链路：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095425.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>增加流控规则</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095437.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>可以通过修改后面的一些控制来限制接口的一些功能，大家可以改一改尝试一下，这里就不赘述了。</p>\n<blockquote>\n<p>可以给其他的服务：provider和auth也按照上面的步骤进行配置。</p>\n</blockquote>\n<h3 id=\"Spring-Cloud-Gateway使用Sentinel\"><a href=\"#Spring-Cloud-Gateway使用Sentinel\" class=\"headerlink\" title=\"Spring Cloud Gateway使用Sentinel\"></a>Spring Cloud Gateway使用Sentinel</h3><p>在工程 gateway中修改</p>\n<p>增加maven依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-alibaba-sentinel-gateway<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>修改<code>application.yml</code>配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">sentinel:</span><br>     <span class=\"hljs-attr\">transport:</span><br>       <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">15000</span><br>       <span class=\"hljs-attr\">dashboard:</span> <span class=\"hljs-string\">localhost:8748</span><br></code></pre></td></tr></table></figure>\n\n<p>创建一个网关分组和网关的限流规则：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Configuration</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">GatewayConfiguration</span> </span>&#123;<br><br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> List&lt;ViewResolver&gt; viewResolvers;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> ServerCodecConfigurer serverCodecConfigurer;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">GatewayConfiguration</span><span class=\"hljs-params\">(ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider,</span></span><br><span class=\"hljs-function\"><span class=\"hljs-params\">                                ServerCodecConfigurer serverCodecConfigurer)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);<br>        <span class=\"hljs-keyword\">this</span>.serverCodecConfigurer = serverCodecConfigurer;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Bean</span><br>    <span class=\"hljs-meta\">@Order</span>(Ordered.HIGHEST_PRECEDENCE)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> SentinelGatewayBlockExceptionHandler <span class=\"hljs-title\">sentinelGatewayBlockExceptionHandler</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-comment\">// Register the block exception handler for Spring Cloud Gateway.</span><br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);<br>    &#125;<br><br>    <span class=\"hljs-meta\">@PostConstruct</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">doInit</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        initCustomizedApis();<br>        initGatewayRules();<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">initCustomizedApis</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        Set&lt;ApiDefinition&gt; definitions = <span class=\"hljs-keyword\">new</span> HashSet&lt;&gt;();<br>        ApiDefinition api1 = <span class=\"hljs-keyword\">new</span> ApiDefinition(<span class=\"hljs-string\">\"consumer\"</span>)<br>                .setPredicateItems(<span class=\"hljs-keyword\">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br><br>                    add(<span class=\"hljs-keyword\">new</span> ApiPathPredicateItem().setPattern(<span class=\"hljs-string\">\"/consumer/**\"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>        ApiDefinition api2 = <span class=\"hljs-keyword\">new</span> ApiDefinition(<span class=\"hljs-string\">\"provider\"</span>)<br>                .setPredicateItems(<span class=\"hljs-keyword\">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br>                    add(<span class=\"hljs-keyword\">new</span> ApiPathPredicateItem().setPattern(<span class=\"hljs-string\">\"/provider/**\"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>        definitions.add(api1);<br>        definitions.add(api2);<br>        GatewayApiDefinitionManager.loadApiDefinitions(definitions);<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">initGatewayRules</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        Set&lt;GatewayFlowRule&gt; rules = <span class=\"hljs-keyword\">new</span> HashSet&lt;&gt;();<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"consumer\"</span>)<br>                .setCount(<span class=\"hljs-number\">10</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"consumer\"</span>)<br>                .setCount(<span class=\"hljs-number\">2</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">2</span>)<br>                .setBurst(<span class=\"hljs-number\">2</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_CLIENT_IP)<br>                )<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"provider\"</span>)<br>                .setCount(<span class=\"hljs-number\">10</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER)<br>                .setMaxQueueingTimeoutMs(<span class=\"hljs-number\">600</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_HEADER)<br>                        .setFieldName(<span class=\"hljs-string\">\"X-Sentinel-Flag\"</span>)<br>                )<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"provider\"</span>)<br>                .setCount(<span class=\"hljs-number\">1</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"pa\"</span>)<br>                )<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"provider\"</span>)<br>                .setCount(<span class=\"hljs-number\">2</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">30</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"type\"</span>)<br>                        .setPattern(<span class=\"hljs-string\">\"warn\"</span>)<br>                        .setMatchStrategy(SentinelGatewayConstants.PARAM_MATCH_STRATEGY_CONTAINS)<br>                )<br>        );<br><br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"provider\"</span>)<br>                .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_CUSTOM_API_NAME)<br>                .setCount(<span class=\"hljs-number\">5</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"pn\"</span>)<br>                )<br>        );<br>        GatewayRuleManager.loadRules(rules);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"测试-1\"><a href=\"#测试-1\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>通过上面的配置gateway已经成功整合了Sentinel，然后我们可以通过请求接口：<a href=\"http://127.0.0.1:15010/consumer/nacos\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:15010/consumer/nacos</a>  </p>\n<p>正常的结果：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">&#123;<br><span class=\"hljs-string\">\"code\"</span>: <span class=\"hljs-number\">401</span>,<br><span class=\"hljs-string\">\"message\"</span>: <span class=\"hljs-string\">\"未登录\"</span><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>这里返回的结果是因为之前gateway做了登录权限的校验，可以通过auth服务登录之后，将header中的token值作为请求的header中的token，就可以得到正确的返回值，对于当前的测试这个都是无关紧要的，可以通过查看前面的教程知道前因后果。</p>\n<p>通过修改限流：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095453.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>多次点击可以得到异常信息:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">Blocked by Sentinel: FlowException<br></code></pre></td></tr></table></figure>\n\n<p>这样就可以通过网关层进行统一的接口流量控制，当然Sentinel的作用不止于此，大家可以通过其他的功能掌握对于接口的控制。</p>\n<h2 id=\"应用场景\"><a href=\"#应用场景\" class=\"headerlink\" title=\"应用场景\"></a>应用场景</h2><p>通过接口的限流和熔断可以让微服务中的模块可以更加的稳定，当大量流量来袭的时候也丝毫不慌。</p>\n<p>除了一些比较极端的比如秒杀抢购抢券等功能，在流量比较大的应用中也是广泛的使用。</p>\n<h2 id=\"源码地址\"><a href=\"#源码地址\" class=\"headerlink\" title=\"源码地址\"></a>源码地址</h2><p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<p>参考文献</p>\n<p><a href=\"https://sentinelguard.io/zh-cn/docs/introduction.html\" target=\"_blank\" rel=\"noopener\">introduction</a></p>\n<p><a href=\"https://forezp.blog.csdn.net/article/details/115632888\" target=\"_blank\" rel=\"noopener\">SpringCloud 2020版本教程3：使用sentinel作为熔断器_方志朋的专栏-CSDN博客</a></p>\n","raw":null,"categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"},{"name":"Hoxton","path":"api/tags/Hoxton.json"},{"name":"Sentinel","path":"api/tags/Sentinel.json"}]},{"title":"SpringCloud系列教程(七)之使用Spring Cloud Sleuth+Zipkin实现链路追踪","slug":"2021-08-06-spring-cloud-hoxton-7-sleuth","date":"2021-08-06T01:40:00.000Z","updated":"2022-12-01T01:32:39.787Z","comments":true,"top":null,"path":"api/articles/2021-08-06-spring-cloud-hoxton-7-sleuth.json","excerpt":null,"keywords":"java,spring,springboot,springcloud,mybatis,jQuery,html,css","cover":"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210806093925.jpg","content":"<blockquote>\n<p>阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6991635985847025671\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992010061576929310\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(四)之SpringCloud Gateway | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992404611617259534\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(五)之SpringCloud Gateway 网关聚合开发文档 swagger knife4j 和登录权限统一验证</a></li>\n<li><a href=\"https://juejin.cn/post/6992404611617259534\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(六)之SpringCloud 使用sentinel作为熔断器</a></li>\n</ul>\n<h2 id=\"全文概要\"><a href=\"#全文概要\" class=\"headerlink\" title=\"全文概要\"></a>全文概要</h2><ul>\n<li>Sleuth快速开始</li>\n<li>跟踪原理</li>\n<li>与Zipkin整合</li>\n</ul>\n<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><p>通过前面的学习，实际上已经搭建出一个基础的微服务架构系统来实现业务要求了。但是随着业务的的发展壮大，系统的规模也越来越大，各个业务模块之间的服务调用也越来越错综复杂，通常一个请求在后端会经过多个不同的业务模块来协同产生最后的结果，在复杂的微服务架构系统中，几乎每个请求都会形成一条复杂的分布式服务调用链路，在每条链路中任何一个业务服务出现延迟或者异常都会导致整个请求的失败。所以，对于每个请求，全链路调用的追踪越来越重要了，通过实现对于请求调用的链路追踪可以帮助我们快速的定位异常的根源以及链路中的性能瓶颈。针对分布式链路追踪，目前有许多业内常用的解决方案，比如Sleuth+Zipkin，skywalking等。本文主要是针对Sleuth+Zipkin的方案。</p>\n<h2 id=\"Sleuth快速开始\"><a href=\"#Sleuth快速开始\" class=\"headerlink\" title=\"Sleuth快速开始\"></a>Sleuth快速开始</h2><blockquote>\n<p>在整合Sleuth开始之前，友情提醒一下，为了顺畅的整合，建议查看前面的文章，因为依赖前面文章的工程。</p>\n</blockquote>\n<h3 id=\"工程改造\"><a href=\"#工程改造\" class=\"headerlink\" title=\"工程改造\"></a>工程改造</h3><p>在<code>consumer</code>，<code>provider</code>，<code>gateway</code>，<code>auth</code>四个工程中增加依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>然后依次启动四个服务，如果Hystrix和Sentinel冲突可以将<code>feign.hystrix.enable: true</code> 去除，因为接入Sentinel之后就不需要Hystrix组件来实现服务熔断，反而造成组件冲突。</p>\n<p>试着请求接口：<a href=\"http://127.0.0.1:15010/consumer/nacos/echo/hello\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:15010/consumer/nacos/echo/hello</a></p>\n<p>可以看到控制台日志输出变了：</p>\n<p>gateway:</p>\n<figure class=\"highlight prolog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs prolog\"><span class=\"hljs-number\">2021</span><span class=\"hljs-number\">-08</span><span class=\"hljs-number\">-04</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">57</span>:<span class=\"hljs-number\">25.166</span>  <span class=\"hljs-symbol\">INFO</span> [winter-gateway,<span class=\"hljs-number\">88</span>a4de6d2424cedf,<span class=\"hljs-number\">88</span>a4de6d2424cedf,false] <span class=\"hljs-number\">23972</span> --- [ctor-http-nio<span class=\"hljs-number\">-2</span>] c.w.gateway.filter.<span class=\"hljs-symbol\">AuthorizeFilter</span>       : <span class=\"hljs-symbol\">AccessToken</span>: [eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJhdXRoX3VzZXIiLCJleHAiOjE2MzAxMzUzNTQsIm5iZiI6MTYyNzU0MzM1NCwidXNlcklkIjoxMDAwMDAwMDF9.c09H4l_QW3v_ReNyec4nv-vqXtMDBlp4RRhh80RquPS1Ol_slH2k_dZ4vo_MYjCzJXKwWhZpt58UzgG6ZUfK8Q]<br><span class=\"hljs-number\">2021</span><span class=\"hljs-number\">-08</span><span class=\"hljs-number\">-04</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">57</span>:<span class=\"hljs-number\">25.456</span>  <span class=\"hljs-symbol\">INFO</span> [winter-gateway,<span class=\"hljs-number\">88</span>a4de6d2424cedf,<span class=\"hljs-number\">88</span>a4de6d2424cedf,false] <span class=\"hljs-number\">23972</span> --- [ctor-http-nio<span class=\"hljs-number\">-2</span>] c.w.gateway.filter.<span class=\"hljs-symbol\">AuthorizeFilter</span>       : claims is:&#123;sub=auth_user, exp=<span class=\"hljs-number\">1630135354</span>, nbf=<span class=\"hljs-number\">1627543354</span>, userId=<span class=\"hljs-number\">100000001</span>&#125;<br><span class=\"hljs-number\">2021</span><span class=\"hljs-number\">-08</span><span class=\"hljs-number\">-04</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">57</span>:<span class=\"hljs-number\">25.457</span>  <span class=\"hljs-symbol\">INFO</span> [winter-gateway,<span class=\"hljs-number\">88</span>a4de6d2424cedf,<span class=\"hljs-number\">88</span>a4de6d2424cedf,false] <span class=\"hljs-number\">23972</span> --- [ctor-http-nio<span class=\"hljs-number\">-2</span>] c.w.gateway.filter.<span class=\"hljs-symbol\">AuthorizeFilter</span>       : userId:<span class=\"hljs-number\">100000001</span><br></code></pre></td></tr></table></figure>\n\n<p>consumer:</p>\n<figure class=\"highlight prolog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs prolog\"><span class=\"hljs-number\">2021</span><span class=\"hljs-number\">-08</span><span class=\"hljs-number\">-04</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">57</span>:<span class=\"hljs-number\">26.566</span>  <span class=\"hljs-symbol\">INFO</span> [winter-nacos-consumer,<span class=\"hljs-number\">88</span>a4de6d2424cedf,<span class=\"hljs-number\">1170003686062</span>d81,false] <span class=\"hljs-number\">26520</span> --- [io<span class=\"hljs-number\">-16011</span>-exec<span class=\"hljs-number\">-1</span>] com.alibaba.nacos.client.naming          : new ips(<span class=\"hljs-number\">1</span>) service: <span class=\"hljs-symbol\">DEFAULT_GROUP</span>@@winter-nacos-provider -&gt; [&#123;<span class=\"hljs-string\">\"clusterName\"</span>:<span class=\"hljs-string\">\"DEFAULT\"</span>,<span class=\"hljs-string\">\"enabled\"</span>:true,<span class=\"hljs-string\">\"ephemeral\"</span>:true,<span class=\"hljs-string\">\"healthy\"</span>:true,<span class=\"hljs-string\">\"instanceHeartBeatInterval\"</span>:<span class=\"hljs-number\">5000</span>,<span class=\"hljs-string\">\"instanceHeartBeatTimeOut\"</span>:<span class=\"hljs-number\">15000</span>,<span class=\"hljs-string\">\"instanceId\"</span>:<span class=\"hljs-string\">\"10.1.18.76#16012#DEFAULT#DEFAULT_GROUP@@winter-nacos-provider\"</span>,<span class=\"hljs-string\">\"ip\"</span>:<span class=\"hljs-string\">\"10.1.18.76\"</span>,<span class=\"hljs-string\">\"ipDeleteTimeout\"</span>:<span class=\"hljs-number\">30000</span>,<span class=\"hljs-string\">\"metadata\"</span>:&#123;<span class=\"hljs-string\">\"preserved.register.source\"</span>:<span class=\"hljs-string\">\"SPRING_CLOUD\"</span>&#125;,<span class=\"hljs-string\">\"port\"</span>:<span class=\"hljs-number\">16012</span>,<span class=\"hljs-string\">\"serviceName\"</span>:<span class=\"hljs-string\">\"DEFAULT_GROUP@@winter-nacos-provider\"</span>,<span class=\"hljs-string\">\"weight\"</span>:<span class=\"hljs-number\">1.0</span>&#125;]<br></code></pre></td></tr></table></figure>\n\n<p>从上面的控制台输出内容 中 ， 我 们可 以看到多了一些形如［[winter-gateway,88a4de6d2424cedf,88a4de6d2424cedf,false]的日志信息， 而这些元素正是实现分布式服务跟踪的重要组成部分，每个值的含义如下所述。</p>\n<ul>\n<li>第一 个值： <code>winter-gateway</code>, 它记录了应用的名称，也就是 <code>application.properties</code>中 <code>spring.application.name</code>参数配置的属性。</li>\n<li>第二个值： <code>88a4de6d2424cedf</code>, <code>Spring Cloud Sleuth</code>生成的 一 个<code>ID</code>,称为<code>Trace ID</code>,它用来标识 一 条请求链路。一 条请求链路中包含 一 个<code>TraceID</code>, 多个<code>SpanID</code>。</li>\n<li>第三个值： <code>88a4de6d2424cedf</code>, <code>Spring Cloud Sleuth</code>生成的另外 一 个<code>ID</code>, 称为<code>Span ID</code>, 它表示 一 个基本的工作单元， 比如发送 一 个HTTP请求。</li>\n<li>第四个值： <code>false</code>, 表示是否要将该信息输出到<code>Zipkin</code>等服务中来收集和展示 。</li>\n</ul>\n<p>上面四个值中的<code>TraceID</code>和<code>SpanID</code>是<code>Spring Cloud Sleuth</code>实现分布式服务跟踪的核心。 在 一 次服务请求链路的调用过程中， 会保待并传递同 一 个<code>Trace ID</code>, 从而将整个分布于不同微服务进程中的请求跟踪信息串联起来。 以上面输出内容为例， <code>winter-gateway</code> 和 <code>winter-nacos-consumer</code>同属于 一 个前端服务请求来源，所以它们的TraceID是相同的，处于同 一 条请求链路中。</p>\n<h3 id=\"跟踪原理\"><a href=\"#跟踪原理\" class=\"headerlink\" title=\"跟踪原理:\"></a>跟踪原理:</h3><p>分布式系统中的服务跟踪在理论上并不复杂， 它主要包括下面两个关键点。</p>\n<ul>\n<li>为了实现请求跟踪， 当请求发送到分布式系统的入口端点时， 只需要服务跟踪框架为该请求创建 一 个唯 一 的跟踪标识， 同时在分布式系统内部流转的时候，框架始终保待传递 该唯 一 标识， 直到返回给请求方为止， 这个唯 一 标识就是前文中提到的Trace ID。 通过TraceID的记录， 我们就能将所有请求过程的日志关联起来。</li>\n<li>为了统计各处理单元的时间延迟， 当请求到达各个服务组件时， 或是处理逻辑到达某个状态时，也通过 一 个唯 一 标识来标记它的开始、 具体过程以及结束， 该标识就是前文中提到的SpanID。 对于每个Span来说， 它必须有开始和结束 两个节点， 通过记录开始 Span和结束Span的时间戳，就能统计出该Span的时间延迟，除了时间戳记录之外，它还可以包含 一 些其他元数据， 比如事件名称、 请求信息等。</li>\n</ul>\n<h2 id=\"与Zipkin整合\"><a href=\"#与Zipkin整合\" class=\"headerlink\" title=\"与Zipkin整合\"></a>与Zipkin整合</h2><h2 id=\"Zipkin安装\"><a href=\"#Zipkin安装\" class=\"headerlink\" title=\"Zipkin安装\"></a>Zipkin安装</h2><p>普通安装：</p>\n<figure class=\"highlight prolog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs prolog\">curl -sSL https://zipkin.io/quickstart.sh | bash -s<br>java -jar zipkin.jar<br></code></pre></td></tr></table></figure>\n\n<p>docker-compose启动：</p>\n<p>docker-compose.yml:</p>\n<figure class=\"highlight prolog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs prolog\">version: <span class=\"hljs-string\">'2'</span><br><br>services:<br>  zipkin:<br>    image: openzipkin/zipkin<br>    container_name: zipkin<br>    environment:<br>      - <span class=\"hljs-symbol\">STORAGE_TYPE</span>=mysql<br>      - <span class=\"hljs-symbol\">MYSQL_DB</span>=zipkin<br>      - <span class=\"hljs-symbol\">MYSQL_USER</span>=root<br>      - <span class=\"hljs-symbol\">MYSQL_PASS</span>=root<br>      - <span class=\"hljs-symbol\">MYSQL_HOST</span>=<span class=\"hljs-number\">172.26</span><span class=\"hljs-number\">.208</span><span class=\"hljs-number\">.1</span><br>      - <span class=\"hljs-symbol\">MYSQL_TCP_PORT</span>=<span class=\"hljs-number\">3306</span><br>    ports:<br>      - <span class=\"hljs-number\">9411</span>:<span class=\"hljs-number\">9411</span><br></code></pre></td></tr></table></figure>\n\n<p>同时支持多种数据存储方式，比如es\\mysql等，更多收集数据和存储方式见：<a href=\"https://github.com/openzipkin/zipkin/tree/master/zipkin-server\" target=\"_blank\" rel=\"noopener\">https://github.com/openzipkin/zipkin/tree/master/zipkin-server</a></p>\n<p><strong>如果使用mysql</strong>需要新建库和表：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">EXISTS</span> zipkin_spans (<br>  <span class=\"hljs-string\">`trace_id_high`</span> <span class=\"hljs-built_in\">BIGINT</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit'</span>,<br>  <span class=\"hljs-string\">`trace_id`</span> <span class=\"hljs-built_in\">BIGINT</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`id`</span> <span class=\"hljs-built_in\">BIGINT</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`name`</span> <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`remote_service_name`</span> <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">255</span>),<br>  <span class=\"hljs-string\">`parent_id`</span> <span class=\"hljs-built_in\">BIGINT</span>,<br>  <span class=\"hljs-string\">`debug`</span> <span class=\"hljs-built_in\">BIT</span>(<span class=\"hljs-number\">1</span>),<br>  <span class=\"hljs-string\">`start_ts`</span> <span class=\"hljs-built_in\">BIGINT</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'Span.timestamp(): epoch micros used for endTs query and to implement TTL'</span>,<br>  <span class=\"hljs-string\">`duration`</span> <span class=\"hljs-built_in\">BIGINT</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'Span.duration(): micros used for minDuration and maxDuration query'</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`trace_id_high`</span>, <span class=\"hljs-string\">`trace_id`</span>, <span class=\"hljs-string\">`id`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span> ROW_FORMAT=COMPRESSED <span class=\"hljs-built_in\">CHARACTER</span> <span class=\"hljs-keyword\">SET</span>=utf8 <span class=\"hljs-keyword\">COLLATE</span> utf8_general_ci;<br><br><span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">TABLE</span> zipkin_spans <span class=\"hljs-keyword\">ADD</span> <span class=\"hljs-keyword\">INDEX</span>(<span class=\"hljs-string\">`trace_id_high`</span>, <span class=\"hljs-string\">`trace_id`</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'for getTracesByIds'</span>;<br><span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">TABLE</span> zipkin_spans <span class=\"hljs-keyword\">ADD</span> <span class=\"hljs-keyword\">INDEX</span>(<span class=\"hljs-string\">`name`</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'for getTraces and getSpanNames'</span>;<br><span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">TABLE</span> zipkin_spans <span class=\"hljs-keyword\">ADD</span> <span class=\"hljs-keyword\">INDEX</span>(<span class=\"hljs-string\">`remote_service_name`</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'for getTraces and getRemoteServiceNames'</span>;<br><span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">TABLE</span> zipkin_spans <span class=\"hljs-keyword\">ADD</span> <span class=\"hljs-keyword\">INDEX</span>(<span class=\"hljs-string\">`start_ts`</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'for getTraces ordering and range'</span>;<br><br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">EXISTS</span> zipkin_annotations (<br>  <span class=\"hljs-string\">`trace_id_high`</span> <span class=\"hljs-built_in\">BIGINT</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit'</span>,<br>  <span class=\"hljs-string\">`trace_id`</span> <span class=\"hljs-built_in\">BIGINT</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'coincides with zipkin_spans.trace_id'</span>,<br>  <span class=\"hljs-string\">`span_id`</span> <span class=\"hljs-built_in\">BIGINT</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'coincides with zipkin_spans.id'</span>,<br>  <span class=\"hljs-string\">`a_key`</span> <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'BinaryAnnotation.key or Annotation.value if type == -1'</span>,<br>  <span class=\"hljs-string\">`a_value`</span> <span class=\"hljs-built_in\">BLOB</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'BinaryAnnotation.value(), which must be smaller than 64KB'</span>,<br>  <span class=\"hljs-string\">`a_type`</span> <span class=\"hljs-built_in\">INT</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'BinaryAnnotation.type() or -1 if Annotation'</span>,<br>  <span class=\"hljs-string\">`a_timestamp`</span> <span class=\"hljs-built_in\">BIGINT</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'Used to implement TTL; Annotation.timestamp or zipkin_spans.timestamp'</span>,<br>  <span class=\"hljs-string\">`endpoint_ipv4`</span> <span class=\"hljs-built_in\">INT</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'Null when Binary/Annotation.endpoint is null'</span>,<br>  <span class=\"hljs-string\">`endpoint_ipv6`</span> <span class=\"hljs-built_in\">BINARY</span>(<span class=\"hljs-number\">16</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'Null when Binary/Annotation.endpoint is null, or no IPv6 address'</span>,<br>  <span class=\"hljs-string\">`endpoint_port`</span> <span class=\"hljs-built_in\">SMALLINT</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'Null when Binary/Annotation.endpoint is null'</span>,<br>  <span class=\"hljs-string\">`endpoint_service_name`</span> <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'Null when Binary/Annotation.endpoint is null'</span><br>) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span> ROW_FORMAT=COMPRESSED <span class=\"hljs-built_in\">CHARACTER</span> <span class=\"hljs-keyword\">SET</span>=utf8 <span class=\"hljs-keyword\">COLLATE</span> utf8_general_ci;<br><br><span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">TABLE</span> zipkin_annotations <span class=\"hljs-keyword\">ADD</span> <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">KEY</span>(<span class=\"hljs-string\">`trace_id_high`</span>, <span class=\"hljs-string\">`trace_id`</span>, <span class=\"hljs-string\">`span_id`</span>, <span class=\"hljs-string\">`a_key`</span>, <span class=\"hljs-string\">`a_timestamp`</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'Ignore insert on duplicate'</span>;<br><span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">TABLE</span> zipkin_annotations <span class=\"hljs-keyword\">ADD</span> <span class=\"hljs-keyword\">INDEX</span>(<span class=\"hljs-string\">`trace_id_high`</span>, <span class=\"hljs-string\">`trace_id`</span>, <span class=\"hljs-string\">`span_id`</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'for joining with zipkin_spans'</span>;<br><span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">TABLE</span> zipkin_annotations <span class=\"hljs-keyword\">ADD</span> <span class=\"hljs-keyword\">INDEX</span>(<span class=\"hljs-string\">`trace_id_high`</span>, <span class=\"hljs-string\">`trace_id`</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'for getTraces/ByIds'</span>;<br><span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">TABLE</span> zipkin_annotations <span class=\"hljs-keyword\">ADD</span> <span class=\"hljs-keyword\">INDEX</span>(<span class=\"hljs-string\">`endpoint_service_name`</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'for getTraces and getServiceNames'</span>;<br><span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">TABLE</span> zipkin_annotations <span class=\"hljs-keyword\">ADD</span> <span class=\"hljs-keyword\">INDEX</span>(<span class=\"hljs-string\">`a_type`</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'for getTraces and autocomplete values'</span>;<br><span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">TABLE</span> zipkin_annotations <span class=\"hljs-keyword\">ADD</span> <span class=\"hljs-keyword\">INDEX</span>(<span class=\"hljs-string\">`a_key`</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'for getTraces and autocomplete values'</span>;<br><span class=\"hljs-keyword\">ALTER</span> <span class=\"hljs-keyword\">TABLE</span> zipkin_annotations <span class=\"hljs-keyword\">ADD</span> <span class=\"hljs-keyword\">INDEX</span>(<span class=\"hljs-string\">`trace_id`</span>, <span class=\"hljs-string\">`span_id`</span>, <span class=\"hljs-string\">`a_key`</span>) <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'for dependencies job'</span>;<br><br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">EXISTS</span> zipkin_dependencies (<br>  <span class=\"hljs-string\">`day`</span> <span class=\"hljs-built_in\">DATE</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`parent`</span> <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`child`</span> <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`call_count`</span> <span class=\"hljs-built_in\">BIGINT</span>,<br>  <span class=\"hljs-string\">`error_count`</span> <span class=\"hljs-built_in\">BIGINT</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`day`</span>, <span class=\"hljs-string\">`parent`</span>, <span class=\"hljs-string\">`child`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span> ROW_FORMAT=COMPRESSED <span class=\"hljs-built_in\">CHARACTER</span> <span class=\"hljs-keyword\">SET</span>=utf8 <span class=\"hljs-keyword\">COLLATE</span> utf8_general_ci;<br></code></pre></td></tr></table></figure>\n\n<p>访问控制台：<a href=\"http://127.0.0.1:9411/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:9411</a></p>\n<h3 id=\"修改工程\"><a href=\"#修改工程\" class=\"headerlink\" title=\"修改工程\"></a>修改工程</h3><p>在<code>consumer</code>，<code>provider</code>，<code>gateway</code>，<code>auth</code>四个工程中增加依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-sleuth-zipkin<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>四个工程分别修改配置：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">zipkin:</span><br>    <span class=\"hljs-attr\">sender:</span><br>      <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">web</span><br>    <span class=\"hljs-attr\">base-url:</span> <span class=\"hljs-string\">http://localhost:9411/</span><br>    <span class=\"hljs-attr\">service:</span><br>      <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">consumer</span> <span class=\"hljs-comment\"># 这里根据spring.application.name相同即可</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>分别启动四个工程<code>consumer</code>，<code>provider</code>，<code>gateway</code>，<code>auth</code> 然后浏览器访问：<a href=\"http://127.0.0.1:15010/consumer/nacos/feign-test/hello\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:15010/consumer/nacos/feign-test/hello</a></p>\n<p>访问：<a href=\"http://127.0.0.1:9411/\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:9411/</a>  点击Run Query 即可查询到链路追踪数据：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210806092410.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p> 随便点击一个SHOW查看链路详细信息：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210806092422.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>可以看到整个请求链路的过程关系，以及请求的耗时等信息。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>在复杂的微服务架构中，服务之间的链路追踪也是至关重要的，可以帮助定位服务的异常和性能瓶颈，除了Sleuth+Zipkin还可以使用其他的一些解决方案。</p>\n<h2 id=\"源码地址\"><a href=\"#源码地址\" class=\"headerlink\" title=\"源码地址\"></a>源码地址</h2><p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">GitHub - WinterChenS/spring-cloud-hoxton-study: spring cloud hoxton release study</a></p>\n<p>参考文献</p>\n<p><a href=\"https://forezp.blog.csdn.net/article/details/115632914\" target=\"_blank\" rel=\"noopener\">https://forezp.blog.csdn.net/article/details/115632914</a></p>\n<p><a href=\"https://www.cnblogs.com/wuzhenzhao/p/12762976.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/wuzhenzhao/p/12762976.html</a></p>\n","raw":null,"categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"},{"name":"Hoxton","path":"api/tags/Hoxton.json"},{"name":"Sleuth","path":"api/tags/Sleuth.json"},{"name":"Zipkin","path":"api/tags/Zipkin.json"}]},{"title":"SpringCloud系列教程(三)之Open Feign","slug":"2021-08-02-spring-cloud-hoxton-3-feign","date":"2021-08-02T02:33:00.000Z","updated":"2022-12-01T01:32:39.787Z","comments":true,"top":null,"path":"api/articles/2021-08-02-spring-cloud-hoxton-3-feign.json","excerpt":null,"keywords":"java,spring,springboot,springcloud,mybatis,jQuery,html,css","cover":"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046763540560.jpg","content":"<blockquote>\n<p>阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(二)之Nacos | 8月更文挑战 (juejin.cn)</a></li>\n</ul>\n<h2 id=\"本文概览\"><a href=\"#本文概览\" class=\"headerlink\" title=\"本文概览\"></a>本文概览</h2><ul>\n<li>RPC是什么？</li>\n<li>Spring Cloud如何整合openfeign</li>\n<li>如何使用ribbon和Hystrix 进行服务的负载均衡和服务熔断</li>\n<li>实际的应用场景</li>\n</ul>\n<blockquote>\n<p>上篇文章介绍了Spring Cloud如何整合Nacos作为配置中心和注册中心，接下来将介绍如何结合<br>Open Feign进行远程服务调用。在讲解OpenFeign之前我们需要了解一下RPC的基础概念。</p>\n</blockquote>\n<p>本文中用到的demo源码地址：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<h2 id=\"什么是RPC？\"><a href=\"#什么是RPC？\" class=\"headerlink\" title=\"什么是RPC？\"></a>什么是RPC？</h2><blockquote>\n<p>在分布式计算，<strong>远程过程调用</strong>（英语：<strong>Remote Procedure Call</strong>，缩写为 RPC）是一个计算机通信协议。该协议允许运行于一台计算机的程序调用另一个地址空间（通常为一个开放网络的一台计算机）的子程序，而程序员就像调用本地程序一样，无需额外地为这个交互作用编程（无需关注细节）。RPC是一种服务器-客户端（Client/Server）模式，经典实现是一个通过发送请求-接受回应进行信息交互的系统。<br>如果涉及的软件采用面向对象编程，那么远程过程调用亦可称作远程调用或远程方法调用，例：Java RMI。<br>RPC是一种进程间通信的模式，程序分布在不同的地址空间里。如果在同一主机里，RPC可以通过不同的虚拟地址空间（即便使用相同的物理地址）进行通讯，而在不同的主机间，则通过不同的物理地址进行交互。许多技术（常常是不兼容）都是基于这种概念而实现的。<br>                                                                                                                — 引用自维基百科</p>\n</blockquote>\n<p>Feign与RPC的关系是什么？为什么有人觉得Feign是伪RPC？</p>\n<p>其实Feign实现了可以通过像调用本地方法去调用远程服务的话，就是RPC，RPC最关键的两个协议是：</p>\n<ol>\n<li>通讯协议</li>\n<li>序列化协议</li>\n</ol>\n<p>常用的rpc框架有：open feign 和 dubbo，feign基于http协议，dubbo基于tcp协议。</p>\n<h3 id=\"feign的原理：\"><a href=\"#feign的原理：\" class=\"headerlink\" title=\"feign的原理：\"></a>feign的原理：</h3><p>feign集成了两个重要的模块：<strong>ribbon</strong>，<strong>Hystrix</strong> 来实现<strong>负载均衡</strong>和<strong>服务熔断，</strong>ribbon内置了<strong>RestTemplate,</strong> RestTemplate基于HTTP，所以说feign基于HTTP。</p>\n<p>Feign通过处理注解，将请求模板化，当实际调用的时候，传入参数，根据参数再应用到请求上，进而转化成真正的 Request 请求。通过Feign以及JAVA的动态代理机制，使得Java 开发人员，可以不用通过HTTP框架去封装HTTP请求报文的方式，完成远程服务的HTTP调用。</p>\n<h2 id=\"Spring-Cloud集成feign\"><a href=\"#Spring-Cloud集成feign\" class=\"headerlink\" title=\"Spring Cloud集成feign\"></a>Spring Cloud集成feign</h2><p>根据上篇的文章中我们使用的Nacos作为代码基础，在此之上集成Feign，所以请查看上一篇文章以做到无缝衔接。</p>\n<h3 id=\"spring-cloud-nacos-provider-修改：\"><a href=\"#spring-cloud-nacos-provider-修改：\" class=\"headerlink\" title=\"spring-cloud-nacos-provider 修改：\"></a>spring-cloud-nacos-provider 修改：</h3><p>在工程<code>spring-cloud-nacos-provider</code> 中增加依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-comment\">&lt;!-- springCloud-feign --&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>新建一个类：<code>NacosProviderClient</code> 并增加注解：<code>@FeignClient(value = &quot;winter-nacos-provider&quot;)</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@FeignClient</span>(value = <span class=\"hljs-string\">\"winter-nacos-provider\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">NacosProviderClient</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/nacos/feign-test/&#123;string&#125;\"</span>)<br>    <span class=\"hljs-function\">String <span class=\"hljs-title\">echo2</span><span class=\"hljs-params\">(@PathVariable String string)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>类：<code>NacosController</code> 增加方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"feign-test/&#123;string&#125;\"</span>)<br><span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">feignTest</span><span class=\"hljs-params\">(@PathVariable String string)</span> </span>&#123;<br>    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"Hello feign \"</span> + string;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"spring-cloud-nacos-consumer-修改：\"><a href=\"#spring-cloud-nacos-consumer-修改：\" class=\"headerlink\" title=\"spring-cloud-nacos-consumer 修改：\"></a>spring-cloud-nacos-consumer 修改：</h3><p>在工程<code>spring-cloud-nacos-consumer</code> 中增加依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-comment\">&lt;!-- springCloud-feign --&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><span class=\"hljs-comment\">&lt;!-- 对于服务provider的依赖 --&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.winterchen<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-nacos-provider<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>0.0.1-SNAPSHOT<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>在启动类<code>NacosConsumerApplication</code> 中增加注解：<code>@EnableFeignClients</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@EnableDiscoveryClient</span><br><span class=\"hljs-meta\">@EnableFeignClients</span><br><span class=\"hljs-meta\">@SpringBootApplication</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">NacosConsumerApplication</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@LoadBalanced</span><br>    <span class=\"hljs-meta\">@Bean</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> RestTemplate <span class=\"hljs-title\">restTemplate</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> RestTemplate();<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(NacosConsumerApplication<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>, <span class=\"hljs-title\">args</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>在类：<code>NacosController</code> 中增加方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><br><span class=\"hljs-meta\">@Autowired</span><br><span class=\"hljs-keyword\">private</span> NacosProviderClient nacosProviderClient;<br><br><span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/feign-test/&#123;str&#125;\"</span>)<br><span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">feignTest</span><span class=\"hljs-params\">(@PathVariable String str)</span> </span>&#123;<br>    <span class=\"hljs-keyword\">return</span> nacosProviderClient.echo2(str);<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"测试：\"><a href=\"#测试：\" class=\"headerlink\" title=\"测试：\"></a>测试：</h3><ol>\n<li>依次启动两个服务；</li>\n<li>浏览器输入：<a href=\"http://127.0.0.1:16011/nacos/feign-test/hello\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:16011/nacos/feign-test/hello</a></li>\n<li>返回：Hello feign hello  就表示成功了</li>\n</ol>\n<h2 id=\"使用Ribbon\"><a href=\"#使用Ribbon\" class=\"headerlink\" title=\"使用Ribbon\"></a>使用Ribbon</h2><p>Feign内置了ribbon用于服务的负载均衡，所以只需要引入feign的依赖就会自动使用负载均衡，接下来我们试一下服务的负载均衡：</p>\n<h3 id=\"spring-cloud-nacos-provider-修改：-1\"><a href=\"#spring-cloud-nacos-provider-修改：-1\" class=\"headerlink\" title=\"spring-cloud-nacos-provider 修改：\"></a>spring-cloud-nacos-provider 修改：</h3><p><code>NacosController</code> 新增方法和参数：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;server.port&#125;\"</span>)<br>  String port;<br><br><span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/ribbon-test\"</span>)<br>  <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">ribbonTest</span><span class=\"hljs-params\">()</span> </span>&#123;<br>      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"Hello ribbon , my port: \"</span> + port;<br>  &#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>NacosProviderClient</code> 新增接口：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/nacos/ribbon-test\"</span>)<br>  <span class=\"hljs-function\">String <span class=\"hljs-title\">ribbonTest</span><span class=\"hljs-params\">()</span></span>;<br></code></pre></td></tr></table></figure>\n\n<p>为了测试服务的负载，所以provider服务不使用配置中心的配置，删除配置中心的配置，然后新建<code>application.yml</code> 配置文件，内容如下:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">16012</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">118.25</span><span class=\"hljs-number\">.36</span><span class=\"hljs-number\">.41</span><span class=\"hljs-string\">:8848</span><br><br><span class=\"hljs-attr\">test:</span><br>  <span class=\"hljs-attr\">config:</span><br>    <span class=\"hljs-attr\">refresh:</span> <span class=\"hljs-literal\">false</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"spring-cloud-nacos-consumer-修改\"><a href=\"#spring-cloud-nacos-consumer-修改\" class=\"headerlink\" title=\"spring-cloud-nacos-consumer 修改\"></a>spring-cloud-nacos-consumer 修改</h3><p><code>NacosController</code> 新增方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/ribbon-test\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">ribbonTest1</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> nacosProviderClient.ribbonTest();<br>    &#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"测试：-1\"><a href=\"#测试：-1\" class=\"headerlink\" title=\"测试：\"></a>测试：</h3><p>在测试之前需要修改idea的配置，红色方框处勾选之后服务可以启动多个节点</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046456754692.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>依次启动两个服务，然后修改<code>spring-cloud-nacos-provider</code> 的端口配置</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">16013</span><br></code></pre></td></tr></table></figure>\n\n<p>然后再次启动<code>spring-cloud-nacos-provider</code> 服务，启动后该服务存在两个节点</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046456920605.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>然后调用：<a href=\"http://127.0.0.1:16011/nacos/ribbon-test\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:16011/nacos/ribbon-test</a></p>\n<p>可以发现请求会轮流调用：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-string\">Hello</span> <span class=\"hljs-string\">ribbon</span> <span class=\"hljs-string\">,</span> <span class=\"hljs-attr\">my port:</span> <span class=\"hljs-number\">16012</span><br><span class=\"hljs-string\">Hello</span> <span class=\"hljs-string\">ribbon</span> <span class=\"hljs-string\">,</span> <span class=\"hljs-attr\">my port:</span> <span class=\"hljs-number\">16013</span><br></code></pre></td></tr></table></figure>\n\n<p>这样就实现了服务的负载均衡。</p>\n<h3 id=\"Ribbon的配置\"><a href=\"#Ribbon的配置\" class=\"headerlink\" title=\"Ribbon的配置\"></a>Ribbon的配置</h3><p>可以配置Ribbon的一些参数实现更多的控制，简单的介绍一下Ribbon的配置，我们可以在consumer工程的配置文件中增加：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">feign:</span><br>  <span class=\"hljs-attr\">client:</span><br>    <span class=\"hljs-attr\">config:</span><br>      <span class=\"hljs-attr\">winter-nacos-consumer:</span><br>        <span class=\"hljs-attr\">connectTimeout:</span> <span class=\"hljs-number\">12000000</span><br>        <span class=\"hljs-attr\">readTimeout:</span> <span class=\"hljs-number\">12000000</span><br>        <span class=\"hljs-attr\">NFLoadBalancerRuleClassName:</span> <span class=\"hljs-string\">com.netflix.loadbalancer.RandomRule</span><br>        <span class=\"hljs-attr\">OkToRetryOnAllOperations:</span> <span class=\"hljs-literal\">true</span><br>        <span class=\"hljs-attr\">MaxAutoRetriesNextServer:</span> <span class=\"hljs-number\">2</span><br>        <span class=\"hljs-attr\">MaxAutoRetries:</span> <span class=\"hljs-number\">1</span><br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs plain\">    ConnectTimeout: #单位ms,请求连接超时时间<br>    ReadTimeout:  #单位ms,请求处理的超时时间<br>    OkToRetryOnAllOperations: #对所有操作请求都进行重试<br>    MaxAutoRetriesNextServer: #切换实例的重试次数<br>    MaxAutoRetries: #对当前实例的重试次数<br>NFLoadBalancerRuleClassName #配置Ribbon负载均衡规则:IRule<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Hystrix-使用\"><a href=\"#Hystrix-使用\" class=\"headerlink\" title=\"Hystrix 使用\"></a>Hystrix 使用</h2><p>除了上面提到的<code>Ribbon</code>，<code>Feign</code>还集成了<code>Hystrix</code> 作为服务熔断组件，服务为什么需要熔断呢？是因为一旦下层服务超时或异常导致不可用，没有熔断机制会导致整个服务集群宕机，所以在微服务架构中，服务的熔断是非常重要的。</p>\n<h3 id=\"spring-cloud-nacos-provider-修改：-2\"><a href=\"#spring-cloud-nacos-provider-修改：-2\" class=\"headerlink\" title=\"spring-cloud-nacos-provider 修改：\"></a>spring-cloud-nacos-provider 修改：</h3><p><code>NacosController</code> 新增方法：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/hystrix-test\"</span>)<br>  <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">hystrixTest</span><span class=\"hljs-params\">()</span> </span>&#123;<br>      <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> RuntimeException(<span class=\"hljs-string\">\"ex\"</span>);<br>  &#125;<br></code></pre></td></tr></table></figure>\n\n<p>新增类<code>NacosProviderClientFallback</code> 并实现接口<code>NacosProviderClient</code> ：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Component</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">NacosProviderClientFallback</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">NacosProviderClient</span></span>&#123;<br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">echo2</span><span class=\"hljs-params\">(String string)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"error\"</span>;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">ribbonTest</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"error\"</span>;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/hystrix-test\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">hystrixTest</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"hystrix error\"</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>修改<code>NacosProviderClient</code> ，新增方法并且<code>@FeignClient</code> 注解增加<code>fallback</code>  参数，该参数就是服务降级的类，当服务不可用会调用此类的实现方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@FeignClient</span>(value = <span class=\"hljs-string\">\"winter-nacos-provider\"</span>, fallback = NacosProviderClientFallback<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span><br><span class=\"hljs-class\"><span class=\"hljs-title\">public</span> <span class=\"hljs-title\">interface</span> <span class=\"hljs-title\">NacosProviderClient</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/nacos/feign-test/&#123;string&#125;\"</span>)<br>    <span class=\"hljs-function\">String <span class=\"hljs-title\">echo2</span><span class=\"hljs-params\">(@PathVariable String string)</span></span>;<br><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/nacos/ribbon-test\"</span>)<br>    <span class=\"hljs-function\">String <span class=\"hljs-title\">ribbonTest</span><span class=\"hljs-params\">()</span></span>;<br><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/nacos/hystrix-test\"</span>)<br>    <span class=\"hljs-function\">String <span class=\"hljs-title\">hystrixTest</span><span class=\"hljs-params\">()</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"spring-cloud-nacos-consumer-修改-1\"><a href=\"#spring-cloud-nacos-consumer-修改-1\" class=\"headerlink\" title=\"spring-cloud-nacos-consumer 修改\"></a>spring-cloud-nacos-consumer 修改</h3><p>增加配置：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">feign:</span><br>  <span class=\"hljs-attr\">client:</span><br>    <span class=\"hljs-attr\">config:</span><br>      <span class=\"hljs-attr\">winter-nacos-consumer:</span><br>        <span class=\"hljs-attr\">connectTimeout:</span> <span class=\"hljs-number\">12000000</span><br>        <span class=\"hljs-attr\">readTimeout:</span> <span class=\"hljs-number\">12000000</span><br>        <span class=\"hljs-attr\">NFLoadBalancerRuleClassName:</span> <span class=\"hljs-string\">com.netflix.loadbalancer.RandomRule</span><br>        <span class=\"hljs-attr\">OkToRetryOnAllOperations:</span> <span class=\"hljs-literal\">true</span><br>        <span class=\"hljs-attr\">MaxAutoRetriesNextServer:</span> <span class=\"hljs-number\">2</span><br>        <span class=\"hljs-attr\">MaxAutoRetries:</span> <span class=\"hljs-number\">1</span><br>  <span class=\"hljs-attr\">hystrix:</span><br>    <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">true</span> <span class=\"hljs-comment\">#启用hystrix</span><br><br><span class=\"hljs-attr\">hystrix:</span><br>  <span class=\"hljs-attr\">command:</span><br>    <span class=\"hljs-attr\">default:</span><br>      <span class=\"hljs-attr\">execution:</span><br>        <span class=\"hljs-attr\">isolation:</span><br>          <span class=\"hljs-attr\">thread:</span><br>            <span class=\"hljs-attr\">timeoutInMilliseconds:</span> <span class=\"hljs-number\">20000</span> <span class=\"hljs-comment\">#默认的超时时间</span><br>    <span class=\"hljs-attr\">winter-nacos-consumer:</span><br>      <span class=\"hljs-attr\">execution:</span><br>        <span class=\"hljs-attr\">isolation:</span><br>          <span class=\"hljs-attr\">thread:</span><br>            <span class=\"hljs-attr\">timeoutInMilliseconds:</span> <span class=\"hljs-number\">20000</span> <span class=\"hljs-comment\">#当前服务的超时时间，可以不写</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注释的注解都是新增的，如果要特定某个服务的配置，就不写default，直接指定服务名就可以，如上面的配置。</p>\n</blockquote>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>分别启动两个服务，然后调用：<a href=\"http://127.0.0.1:16011/nacos/hystrix-test\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:16011/nacos/hystrix-test</a></p>\n<p>返回的响应：<code>hystrix error</code> </p>\n<h3 id=\"拓展：hystrix的配置\"><a href=\"#拓展：hystrix的配置\" class=\"headerlink\" title=\"拓展：hystrix的配置\"></a>拓展：hystrix的配置</h3><p>线程池配置<br>| Name                                                             | 备注                                                | 默认值   |<br>|——————————————————————|—————————————————|——-|<br>| hystrix.threadpool.default.coreSize                              | 线程池大小                                             | 10    |<br>| hystrix.threadpool.default.maximumSize                           | 线程池最大大小                                           | 10    |<br>| hystrix.threadpool.default.allowMaximumSizeToDivergeFromCoreSize | 是否允许动态调整线程数量，默认false，只有设置为true了，上面的maximumSize才有效 | FALSE |<br>| hystrix.threadpool.default.keepAliveTimeMinutes                  | 超出coreSize的线程，空闲1分钟后释放掉                           | 1     |<br>| hystrix.threadpool.default.maxQueueSize                          | 不能动态修改                                            | -1    |<br>| hystrix.threadpool.default.queueSizeRejectionThreshold           | 可以动态修改，默认是5，先进入请求队列，然后再由线程池执行                     | 5     |</p>\n<p><strong>如何计算线程池数量？</strong></p>\n<p><strong>高峰期每秒的请求数量 / 1000毫秒 / TP99请求延时 + buffer空间</strong></p>\n<p>比如说处理一个请求，要50ms，那么TP99，也就是99%的请求里处理一个请求耗时最长是50ms。</p>\n<p>我们给一点缓冲空间10ms，那就是处理请求接口耗时60ms。</p>\n<p>所以一秒钟一个线程可以处理：1000 / 60 = 16，一个线程一秒钟可以处理16个请求。</p>\n<p>假设高峰期，每秒最多1200个请求，一个线程每秒可以处理16个请求，需要多少个线程才能处理每秒1200个请求呢？1200 / 16 = 75，最多需要75个线程，每个线程每秒处理16个请求，75个线程每秒才可以处理1200个请求。</p>\n<p>最多需要多少个线程数量，就是这样子算出来</p>\n<p><strong>如果是服务B -&gt; 服务A的话，服务B线程数量怎么设置？</strong></p>\n<p>服务B调用服务A的线程池需要多少个线程呢？</p>\n<p>高峰期，服务B最多要调用服务A每秒钟1200次，服务A处理一个请求是60ms，服务B每次调用服务A的时候，用一个线程发起一次请求，那么这个服务B的这个线程，要60ms才能返回。</p>\n<p>服务B而言，一个线程对服务A发起一次请求需要60ms，一个线程每秒钟可以请求服务A达到16次，但是现在服务B每秒钟需要请求服务A达到1200次，那么服务B就需要75个线程，在高峰期并发请求服务A，才可以完成每秒1200次的调用。</p>\n<p>服务B，部署多台机器，每台机器调用服务A的线程池有10个线程，比如说搞个10个线程，一共部署10台机器，那么服务B调用服务A的线程数量，一共有100个线程，轻轻松松可以支撑高峰期调用服务A的1200次的场景</p>\n<p>每个线程调用服务A一次，耗时60ms，每个线程每秒可以调用服务A一共是16次，100个线程，每秒最多可以调用服务A是1600次，高峰的时候只要支持调用服务A的1200次就可以了，所以这个机器部署就绰绰有余了</p>\n<p>执行配置<br>| Name                                                                        | 备注                             | 默认值    |<br>|—————————————————————————–|——————————–|——–|<br>| hystrix.command.default.execution.isolation.strategy                        | 隔离策略，默认Thread，可以选择Semaphore信号量 | Thread |<br>| hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds    | 超时时间                           | 1000ms |<br>| hystrix.command.default.execution.timeout.enabled                           | 是否启用超时                         | TRUE   |<br>| hystrix.command.default.execution.isolation.thread.interruptOnTimeout       | 超时的时候是否中断执行                    | TRUE   |<br>| hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests | 信号量隔离策略下，允许的最大并发请求数量           | 10     |</p>\n<p>降级配置<br>| Name                                     | 备注     | 默认值  |<br>|——————————————|——–|——|<br>| hystrix.command.default.fallback.enabled | 是否启用降级 | TRUE |</p>\n<p>熔断配置<br>| Name                                                             | 备注                                              | 默认值  |<br>|——————————————————————|————————————————-|——|<br>| hystrix.command.default.circuitBreaker.enabled                   | 是否启用熔断器                                         | TRUE |<br>| hystrix.command.default.circuitBreaker.requestVolumeThreshold    | 10秒钟内，请求数量达到多少才能去尝试触发熔断                         | 20   |<br>| hystrix.command.default.circuitBreaker.errorThresholdPercentage  | 10秒钟内，请求数量达到20，同时异常比例达到50%，就会触发熔断               | 50   |<br>| hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds | 触发熔断之后，5s内直接拒绝请求，走降级逻辑，5s后尝试half-open放过少量流量试着恢复 | 5000 |<br>| hystrix.command.default.circuitBreaker.forceOpen                 | 强制打开熔断器                                         |      |<br>| hystrix.command.default.circuitBreaker.forceClosed               | 强制关闭熔断器                                         |      |</p>\n<p>监控配置<br>| Name                                                                  | 备注                                                                                                                                                        | 默认值           |<br>|———————————————————————–|———————————————————————————————————————————————————–|—————|<br>| hystrix.threadpool.default.metrics.rollingStats.timeInMillisecond     | 线程池统计指标的时间                                                                                                                                                | 默认10000，就是10s |<br>| hystrix.threadpool.default.metrics.rollingStats.numBuckets            | 将rolling window划分为n个buckets                                                                                                                               | 10            |<br>| hystrix.command.default.metrics.rollingStats.timeInMilliseconds       | command的统计时间，熔断器是否打开会根据1个rolling window的统计来计算。若rolling window被设为10000毫秒，则rolling window会被分成n个buckets，每个bucket包含success，failure，timeout，rejection的次数的统计信息。 | 10000         |<br>| hystrix.command.default.metrics.rollingStats.numBuckets               | 设置一个rolling window被划分的数量，若numBuckets＝10，rolling window＝10000，那么一个bucket的时间即1秒。必须符合rolling window % numberBuckets == 0                                     | 10            |<br>| hystrix.command.default.metrics.rollingPercentile.enabled             |  执行时是否enable指标的计算和跟踪                                                                                                                                      | TRUE          |<br>| hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds  | 设置rolling percentile window的时间                                                                                                                            | 60000         |<br>| hystrix.command.default.metrics.rollingPercentile.numBuckets          | 设置rolling percentile window的numberBuckets。逻辑同上。                                                                                                           | 6             |<br>| hystrix.command.default.metrics.rollingPercentile.bucketSize          | 如果bucket size＝100，window＝10s，若这10s里有500次执行，只有最后100次执行会被统计到bucket里去。增加该值会增加内存开销以及排序的开销。                                                                    | 100           |<br>| hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds | 记录health 快照（用来统计成功和错误绿）的间隔                                                                                                                                | 500ms         |</p>\n<p>高阶特性配置<br>| Name                                               | 备注                                                               | 默认值               |<br>|—————————————————-|——————————————————————|——————-|<br>| hystrix.command.default.requestCache.enabled       | 是否启用请求缓存                                                         | TRUE              |<br>| hystrix.command.default.requestLog.enabled         | 记录日志到HystrixRequestLog                                           | TRUE              |<br>| hystrix.collapser.default.maxRequestsInBatch       | 单次批处理的最大请求数，达到该数量触发批处理                                           | Integer.MAX_VALUE |<br>| hystrix.collapser.default.timerDelayInMilliseconds | 触发批处理的延迟，也可以为创建批处理的时间＋该值                                         | 10                |<br>| hystrix.collapser.default.requestCache.enabled     | 是否对HystrixCollapser.execute() and HystrixCollapser.queue()的cache | TRUE              |</p>\n<p><strong>Feign和Hystrix结合的原理</strong></p>\n<p>Feign在和Hystrix整合的时候，feign动态代理里面有一些Hystrix相关的代码，请求走feign动态代理的时候，就会基于Hystrix Command发送请求，实现服务间调用的隔离、限流、超时、降级、熔断、统计等。</p>\n<p><img    class=\"lazyload\" data-original=\"http://www.saily.top/img/spring-cloud/Feign%E5%92%8CHystrix%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.jpg\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">http://www.saily.top/img/spring-cloud/Feign%E5%92%8CHystrix%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.jpg</span></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>本文学习了springcloud整合feign实现远程服务调用，并且使用了feign集成的Ribbon和Hystrix实现的负载均衡和服务熔断，以及对服务负载均衡和熔断进行了深度的了解和实际使用当中的一些配置，下一篇将会讲讲微服务网关SpringCloud Gateway。</p>\n<h2 id=\"源码地址\"><a href=\"#源码地址\" class=\"headerlink\" title=\"源码地址\"></a>源码地址</h2><p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<p>参考文档：</p>\n<p><a href=\"https://spring.io/projects/spring-cloud-openfeign\" target=\"_blank\" rel=\"noopener\">Spring Cloud OpenFeign</a></p>\n<p><a href=\"http://www.saily.top/2020/04/19/springcloud/hystrix05/\" target=\"_blank\" rel=\"noopener\">Feign和Hystrix的结合使用</a></p>\n","raw":null,"categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"},{"name":"Hoxton","path":"api/tags/Hoxton.json"},{"name":"feign","path":"api/tags/feign.json"}]},{"title":"SpringCloud系列教程(五)之SpringCloud Gateway 网关聚合开发文档 swagger knife4j 和登录权限统一验证","slug":"2021-08-04-spring-cloud-hoxton-5-swagger","date":"2021-08-04T04:21:00.000Z","updated":"2022-12-01T01:32:39.787Z","comments":true,"top":null,"path":"api/articles/2021-08-04-spring-cloud-hoxton-5-swagger.json","excerpt":null,"keywords":"java,spring,springboot,springcloud,mybatis,jQuery,html,css","cover":"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804122154.jpg","content":"<blockquote>\n<p>阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>由于knife4j比swagger更加友好，所以本文集成knife4j</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\" title=\"https://juejin.cn/post/6987998097209032741\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\" title=\"https://juejin.cn/post/6991323018802757662\">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6991635985847025671\" target=\"_blank\" rel=\"noopener\" title=\"https://juejin.cn/post/6991635985847025671\"># SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992010061576929310\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(四)之SpringCloud Gateway | 8月更文挑战</a></li>\n</ul>\n<h2 id=\"本文概览\"><a href=\"#本文概览\" class=\"headerlink\" title=\"本文概览\"></a>本文概览</h2><ul>\n<li>Spring Cloud Gateway集成Knife4j</li>\n<li>Spring Cloud Gateway集成登录权限统一校验</li>\n</ul>\n<h2 id=\"开始\"><a href=\"#开始\" class=\"headerlink\" title=\"开始\"></a>开始</h2><p>上篇文章介绍了Spring Cloud Gateway的使用，本文将介绍如何在网关层聚合swagger文档，聚合之后可以非常方便的对开发文档进行管理，也是业界比较常用的方式。</p>\n<p>首先在<strong>父pom</strong>文件<code>dependencyManagement</code> 节点中增加knife4j的依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.github.xiaoymin<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>3.0.3<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置-spring-cloud-nacos-provider和spring-cloud-nacos-consumer\"><a href=\"#配置-spring-cloud-nacos-provider和spring-cloud-nacos-consumer\" class=\"headerlink\" title=\"配置 spring-cloud-nacos-provider和spring-cloud-nacos-consumer\"></a>配置 spring-cloud-nacos-provider和spring-cloud-nacos-consumer</h2><blockquote>\n<p>注意，这里标题中两个工程为前几篇文章中构建的，如果不想看前几篇文章，就创建两个模块然后分别集成nacos，knife4j即可。</p>\n</blockquote>\n<p>在两个模块中分别增加maven依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.github.xiaoymin<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>在两个模块中分别新增配置类：<code>Knife4jConfiguration</code> </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Configuration</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Knife4jConfiguration</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;swagger.enable:true&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">boolean</span> enableSwagger;<br><br>    <span class=\"hljs-meta\">@Bean</span>(value = <span class=\"hljs-string\">\"defaultApi2\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Docket <span class=\"hljs-title\">createRestApi</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Docket(DocumentationType.SWAGGER_2)<br>                .apiInfo(<span class=\"hljs-keyword\">new</span> ApiInfoBuilder()<br>                            .title(<span class=\"hljs-string\">\"provider服务\"</span>)<br>                            .version(<span class=\"hljs-string\">\"1.0\"</span>)<br>                            .build())<br>                .enable(enableSwagger)<br>                .select()<br>                .apis(RequestHandlerSelectors.basePackage(<span class=\"hljs-string\">\"com.winterchen.nacos.rest\"</span>))<br>                .paths(PathSelectors.any())<br>                .build();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>注意有些相关的信息需要修改。</p>\n<p>新增配置：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">swagger:</span><br>    <span class=\"hljs-attr\">enable:</span> <span class=\"hljs-literal\">true</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置-spring-cloud-gateway\"><a href=\"#配置-spring-cloud-gateway\" class=\"headerlink\" title=\"配置 spring-cloud-gateway\"></a>配置 spring-cloud-gateway</h2><p>接下来是重头戏，如何在Spring Cloud Gateway中聚合swagger文档。</p>\n<p>首先在pom中增加maven依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.github.xiaoymin<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>新增Swagger的配置类：<code>SwaggerResourceConfig</code> </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Component</span><br><span class=\"hljs-meta\">@Primary</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SwaggerResourceConfig</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">SwaggerResourcesProvider</span> </span>&#123;<br><br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> RouteLocator routeLocator;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> GatewayProperties gatewayProperties;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">SwaggerResourceConfig</span><span class=\"hljs-params\">(RouteLocator routeLocator, GatewayProperties gatewayProperties)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.routeLocator = routeLocator;<br>        <span class=\"hljs-keyword\">this</span>.gatewayProperties = gatewayProperties;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> List&lt;SwaggerResource&gt; <span class=\"hljs-title\">get</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        List&lt;SwaggerResource&gt; resources = <span class=\"hljs-keyword\">new</span> ArrayList&lt;&gt;();<br>        List&lt;String&gt; routes = <span class=\"hljs-keyword\">new</span> ArrayList&lt;&gt;();<br>        <span class=\"hljs-comment\">//获取所有路由的ID</span><br>        routeLocator.getRoutes().subscribe(route -&gt; routes.add(route.getId()));<br>        <span class=\"hljs-comment\">//过滤出配置文件中定义的路由-&gt;过滤出Path Route Predicate-&gt;根据路径拼接成api-docs路径-&gt;生成SwaggerResource</span><br>        gatewayProperties.getRoutes().stream().filter(routeDefinition -&gt; routes.contains(routeDefinition.getId())).forEach(route -&gt; &#123;<br>            route.getPredicates().stream()<br>                    .filter(predicateDefinition -&gt; (<span class=\"hljs-string\">\"Path\"</span>).equalsIgnoreCase(predicateDefinition.getName()))<br>                    .forEach(predicateDefinition -&gt; resources.add(swaggerResource(route.getId(),<br>                            predicateDefinition.getArgs().get(NameUtils.GENERATED_NAME_PREFIX + <span class=\"hljs-string\">\"0\"</span>)<br>                                    .replace(<span class=\"hljs-string\">\"**\"</span>, <span class=\"hljs-string\">\"v2/api-docs\"</span>))));<br>        &#125;);<br><br>        <span class=\"hljs-keyword\">return</span> resources;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> SwaggerResource <span class=\"hljs-title\">swaggerResource</span><span class=\"hljs-params\">(String name, String location)</span> </span>&#123;<br>        SwaggerResource swaggerResource = <span class=\"hljs-keyword\">new</span> SwaggerResource();<br>        swaggerResource.setName(name);<br>        swaggerResource.setLocation(location);<br>        swaggerResource.setSwaggerVersion(<span class=\"hljs-string\">\"2.0\"</span>);<br>        <span class=\"hljs-keyword\">return</span> swaggerResource;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>主要的配置的作用已经在代码中进行注释。</p>\n<p>新增一个控制器：<code>SwaggerHandler</code> </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@RestController</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SwaggerHandler</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span>(required = <span class=\"hljs-keyword\">false</span>)<br>    <span class=\"hljs-keyword\">private</span> SecurityConfiguration securityConfiguration;<br><br>    <span class=\"hljs-meta\">@Autowired</span>(required = <span class=\"hljs-keyword\">false</span>)<br>    <span class=\"hljs-keyword\">private</span> UiConfiguration uiConfiguration;<br><br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> SwaggerResourcesProvider swaggerResources;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">SwaggerHandler</span><span class=\"hljs-params\">(SwaggerResourcesProvider swaggerResources)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.swaggerResources = swaggerResources;<br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * Swagger安全配置，支持oauth和apiKey设置</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/swagger-resources/configuration/security\"</span>)<br>    <span class=\"hljs-keyword\">public</span> Mono&lt;ResponseEntity&lt;SecurityConfiguration&gt;&gt; securityConfiguration() &#123;<br>        <span class=\"hljs-keyword\">return</span> Mono.just(<span class=\"hljs-keyword\">new</span> ResponseEntity&lt;&gt;(<br>                Optional.ofNullable(securityConfiguration).orElse(SecurityConfigurationBuilder.builder().build()), HttpStatus.OK));<br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * Swagger UI配置</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/swagger-resources/configuration/ui\"</span>)<br>    <span class=\"hljs-keyword\">public</span> Mono&lt;ResponseEntity&lt;UiConfiguration&gt;&gt; uiConfiguration() &#123;<br>        <span class=\"hljs-keyword\">return</span> Mono.just(<span class=\"hljs-keyword\">new</span> ResponseEntity&lt;&gt;(<br>                Optional.ofNullable(uiConfiguration).orElse(UiConfigurationBuilder.builder().build()), HttpStatus.OK));<br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * Swagger资源配置，微服务中这各个服务的api-docs信息</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/swagger-resources\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Mono&lt;ResponseEntity&gt; <span class=\"hljs-title\">swaggerResources</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> Mono.just((<span class=\"hljs-keyword\">new</span> ResponseEntity&lt;&gt;(swaggerResources.get(), HttpStatus.OK)));<br>    &#125;<br>&#125;-----------------<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>分别运行：spring-cloud-nacos-provider，spring-cloud-nacos-consumer，spring-cloud-gateway 三个服务。</p>\n<p>打开swagger的地址: <a href=\"http://127.0.0.1:15010/doc.html\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:15010/doc.html</a></p>\n<p>验证结果：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124615.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>看到上图中的结果说明聚合成功。</p>\n<h2 id=\"集成登录权限的统一校验\"><a href=\"#集成登录权限的统一校验\" class=\"headerlink\" title=\"集成登录权限的统一校验\"></a>集成登录权限的统一校验</h2><blockquote>\n<p>为了直达主题，本次集成登录权限会尽量的简单，其中忽略一些细节，比如登录服务模块，可以查看demo的源码：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study/tree/main/spring-cloud-auth\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study/tree/main/spring-cloud-auth</a><br>并且我会在关键的点上明确讲解。</p>\n</blockquote>\n<p>在开始之前需要明白一个原理，如果要实现统一鉴权，那么需要对所有的请求进行统一的拦截，要实现统一的拦截，在Spring Cloud Gateway中有一个filter接口为：<code>GlobalFilter</code> 。</p>\n<p>所以我们可以通过实现<code>GlobalFilter</code> 接口来实现请求的拦截。</p>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><p>新建一个类实现<code>GlobalFilter</code> 接口，并且实现<code>filter</code> 方法，在此基础上我们还需要实现<code>Ordered</code> 接口，控制拦截的优先级，鉴权拦截优先级是最高的，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Slf</span>4j<br><span class=\"hljs-meta\">@Component</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AuthorizeFilter</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">GlobalFilter</span>, <span class=\"hljs-title\">Ordered</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    UserRedisCollection userRedisCollection;<br><br>\t\t<span class=\"hljs-comment\">// (1)</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">boolean</span> <span class=\"hljs-title\">checkWhiteList</span><span class=\"hljs-params\">(String uri)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">boolean</span> access = <span class=\"hljs-keyword\">false</span>;<br>        <span class=\"hljs-keyword\">if</span> (uri.contains(<span class=\"hljs-string\">\"/login\"</span>) || uri.contains(<span class=\"hljs-string\">\"/v2/api-docs\"</span>)) &#123;<br>            access = <span class=\"hljs-keyword\">true</span>;<br>            <span class=\"hljs-keyword\">if</span> (uri.contains(<span class=\"hljs-string\">\"logout\"</span>)) &#123;<br>                access = <span class=\"hljs-keyword\">false</span>;<br>            &#125;<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (uri.contains(<span class=\"hljs-string\">\"/open-api\"</span>)) &#123;<br>            access = <span class=\"hljs-keyword\">true</span>;<br>        &#125;<br>        <span class=\"hljs-keyword\">return</span> access;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Mono&lt;Void&gt; <span class=\"hljs-title\">filter</span><span class=\"hljs-params\">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;<br>\t\t\t  <span class=\"hljs-comment\">// (2)</span><br>        ServerHttpRequest request = exchange.getRequest();<br>        ServerHttpResponse response = exchange.getResponse();<br>        String uri = request.getURI().getPath();<br>\t\t\t\t<br>\t\t\t\t<span class=\"hljs-comment\">// (3)</span><br>        <span class=\"hljs-comment\">//前端访问不到header问题</span><br>        response.getHeaders().add(<span class=\"hljs-string\">\"Access-Control-Allow-Headers\"</span>,<span class=\"hljs-string\">\"X-PINGOTHER, Origin, X-Requested-With, Content-Type, Accept, token\"</span>);<br>        response.getHeaders().add(<span class=\"hljs-string\">\"Access-Control-Expose-Headers\"</span>, <span class=\"hljs-string\">\"token\"</span>);<br>        ServerHttpRequest mutableReq = request.mutate()<br>                .header(DefaultConstants.IP_ADDRESS, getIpAddress(request))<br>                .build();<br>        ServerWebExchange mutableExchange = exchange.mutate().request(mutableReq).build();<br>        <span class=\"hljs-comment\">// (4)</span><br>\t\t\t\t<span class=\"hljs-comment\">//检查白名单</span><br>        <span class=\"hljs-keyword\">if</span> (checkWhiteList(uri)) &#123;<br>            <span class=\"hljs-keyword\">return</span> chain.filter(mutableExchange);<br>        &#125;<br>\t\t\t\t<br>\t\t\t\t<span class=\"hljs-comment\">// (5)</span><br>        <span class=\"hljs-comment\">//从request获取token</span><br>        String accessToken = request.getHeaders().getFirst(DefaultConstants.TOKEN);<br>        log.info(<span class=\"hljs-string\">\"AccessToken: [&#123;&#125;]\"</span>, accessToken);<br><br>\t\t\t\t<span class=\"hljs-comment\">// (6)</span><br>        <span class=\"hljs-keyword\">if</span> (StringUtils.isBlank(accessToken)) &#123;<br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class=\"hljs-keyword\">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class=\"hljs-string\">\"未登录\"</span>);<br>        &#125;<br>        Claims claims = <span class=\"hljs-keyword\">null</span>;<br>        <span class=\"hljs-keyword\">try</span> &#123;<br>\t\t\t\t\t\t<span class=\"hljs-comment\">// (7)</span><br>            claims = JwtUtil.parseJWT(accessToken, DefaultConstants.SECRET_KEY);<br>\t\t\t\t\t\t<br>            <span class=\"hljs-keyword\">if</span> (claims == <span class=\"hljs-keyword\">null</span>) &#123;<br>                response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>                <span class=\"hljs-keyword\">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class=\"hljs-string\">\"未登录\"</span>);<br>            &#125;<br>            log.info(<span class=\"hljs-string\">\"claims is:&#123;&#125;\"</span>, claims);<br>            <span class=\"hljs-keyword\">if</span> (claims.getSubject().equals(DefaultConstants.USER))&#123;<br>                <span class=\"hljs-keyword\">if</span>(claims.get(DefaultConstants.USERID)!=<span class=\"hljs-keyword\">null</span>) &#123;<br>                    Long userId = Long.parseLong(claims.get(DefaultConstants.USERID).toString());<br><br>                    log.info(<span class=\"hljs-string\">\"userId:&#123;&#125;\"</span>, userId);<br>                    Map&lt;String, Object&gt; map = Maps.newHashMapWithExpectedSize(<span class=\"hljs-number\">1</span>);<br>                    map.put(DefaultConstants.USERID,userId.toString());<br>\t\t\t\t\t\t\t\t\t\t<br>\t\t\t\t\t\t\t\t\t\t<span class=\"hljs-comment\">// (8)</span><br>                    UserInfoEntity userInfo = userRedisCollection.getAuthUserInfoAndCache(userId);<br>                    <span class=\"hljs-comment\">//判断是否</span><br>                    <span class=\"hljs-keyword\">if</span> (userInfo == <span class=\"hljs-keyword\">null</span>) &#123;<br>                        response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>                        <span class=\"hljs-keyword\">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class=\"hljs-string\">\"未登录\"</span>);<br>                    &#125;<br><br>\t\t\t\t\t\t\t\t\t\t<span class=\"hljs-comment\">// (9)</span><br>                    String token = JwtUtil.createToken(DefaultConstants.USER, map, DefaultConstants.SECRET_KEY);<br>                    response.getHeaders().add(DefaultConstants.TOKEN, token);<br>\t\t\t\t\t\t\t\t\t\t<br>                    mutableReq = request.mutate().header(DefaultConstants.USER_ID, String.valueOf(userId))<br>                            .header(DefaultConstants.IP_ADDRESS, getIpAddress(request))<br>                            .build();<br>                    mutableExchange = exchange.mutate().request(mutableReq).build();<br>                    <span class=\"hljs-keyword\">return</span> chain.filter(mutableExchange);<br><br>                &#125;<br><br>            &#125;<br>        &#125; <span class=\"hljs-keyword\">catch</span> (Exception e) &#123;<br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class=\"hljs-keyword\">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class=\"hljs-string\">\"未登录\"</span>);<br>        &#125;<br><br>        <span class=\"hljs-keyword\">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class=\"hljs-string\">\"未登录\"</span>);<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> Mono&lt;Void&gt; <span class=\"hljs-title\">getVoidMono</span><span class=\"hljs-params\">(ServerHttpResponse serverHttpResponse, ResultCodeEnum resultCode, String responseText)</span> </span>&#123;<br>        serverHttpResponse.getHeaders().add(<span class=\"hljs-string\">\"Content-Type\"</span>, <span class=\"hljs-string\">\"application/json;charset=UTF-8\"</span>);<br>        CommonResult&lt;?&gt; result = CommonResult.failed(resultCode.getCode(), responseText);<br>        DataBuffer dataBuffer = serverHttpResponse.bufferFactory().wrap(JSON.toJSONString(result).getBytes());<br>        <span class=\"hljs-keyword\">return</span> serverHttpResponse.writeWith(Flux.just(dataBuffer));<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">getIpAddress</span><span class=\"hljs-params\">(ServerHttpRequest request)</span> </span>&#123;<br>        String ip = request.getHeaders().getFirst(<span class=\"hljs-string\">\"x-forwarded-for\"</span>);<br>        <span class=\"hljs-keyword\">if</span> (ip == <span class=\"hljs-keyword\">null</span> || ip.length() == <span class=\"hljs-number\">0</span> || <span class=\"hljs-string\">\"unknown\"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class=\"hljs-string\">\"Proxy-Client-IP\"</span>);<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ip == <span class=\"hljs-keyword\">null</span> || ip.length() == <span class=\"hljs-number\">0</span> || <span class=\"hljs-string\">\"unknown\"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class=\"hljs-string\">\"WL-Proxy-Client-IP\"</span>);<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ip == <span class=\"hljs-keyword\">null</span> || ip.length() == <span class=\"hljs-number\">0</span> || <span class=\"hljs-string\">\"unknown\"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class=\"hljs-string\">\"HTTP_CLIENT_IP\"</span>);<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ip == <span class=\"hljs-keyword\">null</span> || ip.length() == <span class=\"hljs-number\">0</span> || <span class=\"hljs-string\">\"unknown\"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class=\"hljs-string\">\"HTTP_X_FORWARDED_FOR\"</span>);<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ip == <span class=\"hljs-keyword\">null</span> || ip.length() == <span class=\"hljs-number\">0</span> || <span class=\"hljs-string\">\"unknown\"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getRemoteAddress().getHostString();<br>        &#125;<br>        <span class=\"hljs-keyword\">return</span> ip;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">getOrder</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> -<span class=\"hljs-number\">100</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li>(1) 这个方法可以将白名单加入，当请求到这些url的时候不进行权限的校验</li>\n<li>(2) 我们在使用Spring Cloud Gateway的时候，注意到过滤器（包括GatewayFilter、GlobalFilter和过滤器链GatewayFilterChain），都依赖到ServerWebExchange，这里filter的设计跟Servlet中的的filter相似，也就是当前过滤器决定是否执行下一个过滤器的逻辑，而ServerWebExchange就是当前请求和响应的上下文，不仅包含了request和response，还包含了一些扩展方法，如代码中可以获取到request和response。</li>\n<li>(3) 这一步，主要是解决前端无法中header中获取到需要获取的参数。比如<code>token</code> 。</li>\n<li>(4) 这里对应了第一步白名单的判断，如果当前请求在白名单就跳过后面的一些权限的判断，直接执行下一个过滤器。</li>\n<li>(5) 这里很简单，就是从request中获取到token，方便jwt转换成对应的用户信息。</li>\n<li>(6) 如果请求没有携带token就不予通过。</li>\n<li>(7) jwt将token转换成用户信息，用于后面的判断以及用户的基本信息。</li>\n<li>(8) 上面获取到用户的信息之后，根据用户的userId查询redis中是否存在该用户数据，如果不存在表示该用户的用户信息已经过期了，而且从redis查询的时候会重置超时时间（也就保证了只要经常的在线就不需要重新登录，超过设定的时间没有在线，那么就需要重新登录）。注意：这里是需要跟登录服务进行联动，也就是登录成功之后将用户的信息存入redis，然后gateway这边能取到该用户信息。所以需要保证这一点。</li>\n<li>(9) 这里会重新颁发token，主要是防止token会过期，token的过期时间在jwtUtils中可以设置，所以，前端需要每次请求之后都将新的token作为下一次请求的token。</li>\n<li>注意：本文的token是放在header中，前端小伙伴需要从header中取token。</li>\n</ul>\n<p>代码中的方法：<code>UserRedisCollection.getAuthUserInfoAndCache(Long userId)</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> RedisTemplate redisTemplate;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> UserInfoEntity <span class=\"hljs-title\">getAuthUserInfoAndCache</span><span class=\"hljs-params\">(Long userId)</span> </span>&#123;<br>        CommonAssert.meetCondition(userId == <span class=\"hljs-keyword\">null</span>, <span class=\"hljs-string\">\"未获取到userId\"</span>);<br>        String key = DefaultConstants.USER_INFO_REDIS + userId;<br>        UserInfoEntity entity = (UserInfoEntity) redisTemplate.opsForValue().get(key);<br>        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">null</span> != entity) &#123;<br>            redisTemplate.opsForValue().set(key, entity, <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">24</span> * <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">1000</span>, TimeUnit.MILLISECONDS);<br>            <span class=\"hljs-keyword\">return</span> entity;<br>        &#125;<br>        CommonAssert.meetCondition(<span class=\"hljs-keyword\">true</span>, <span class=\"hljs-string\">\"当前用户未登陆，未获取到登陆信息\"</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>\n\n<p>该方法简单，就是根据userId获取到用户信息的，成功获取之后会重置超时时间，时长可以根据需要进行修改。</p>\n<p>关于本文的登录服务，可以从demo源码中获取：</p>\n<p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study/tree/main/spring-cloud-auth\" target=\"_blank\" rel=\"noopener\">spring-cloud-hoxton-study/spring-cloud-auth at main · WinterChenS/spring-cloud-hoxton-study</a></p>\n<h3 id=\"测试-1\"><a href=\"#测试-1\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>分别启动gateway,provider,auth服务。</p>\n<p>首先，测试未登录的情况：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124637.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>然后进入auth服务，打开登录接口：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124653.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>打开Headers，复制token</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124712.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>再次切换到provider服务，设置文档的全局参数：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124726.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>然后刷新一下页面再请求就可以发现，请求成功：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124735.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>到这里就成功集成了gateway鉴权了。</p>\n<h3 id=\"拓展\"><a href=\"#拓展\" class=\"headerlink\" title=\"拓展\"></a>拓展</h3><ul>\n<li>至于登出的逻辑，思路是这样的，登出只需要在auth服务中将用户信息从redis清除即可，这样在gateway中查询redis就可以查到用户登录信息已经失效了。</li>\n<li>如何在服务中获取当前登录用户信息呢？这个其实挺简单的，一般的做法就是写一个工具类，该工具类从请求的header中获取token，或者在请求阶段就讲userId设置到token中，如果只有token就讲token转换成用户信息，然后根据id从redis中获取用户详细信息，不过一般只需要userId就可以了，这边给个示例：</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> String <span class=\"hljs-title\">getUserIdByCurrent</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder<br>                .getRequestAttributes();<br>        <span class=\"hljs-keyword\">if</span> (attributes != <span class=\"hljs-keyword\">null</span>) &#123;<br>            HttpServletRequest request = attributes.getRequest();<br>            <span class=\"hljs-keyword\">return</span> request.getHeader(ConstantsUtil.USER_ID);<br>        &#125;<span class=\"hljs-keyword\">else</span>&#123;<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"\"</span>;<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>本章介绍了如何在gateway中聚合swagger文档以及统一鉴权的集成，内容其实并不多，原本打算分开两篇进行介绍的，swagger部分没有什么需要注意的原理，索性就放在一起，真正重要的点就是Spring Cloud Gateway中的filter的应用，这部分可以通过查找资料详细的了解一下，下一篇将介绍如何使用限流组件Sentinel，这个组件由alibaba提供。</p>\n<h2 id=\"源码地址\"><a href=\"#源码地址\" class=\"headerlink\" title=\"源码地址\"></a>源码地址</h2><p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<p>参考文献</p>\n<p><a href=\"https://juejin.cn/post/6844903846469189645\" target=\"_blank\" rel=\"noopener\">Spring Cloud Gateway-ServerWebExchange核心方法与请求或者响应内容的修改</a></p>\n","raw":null,"categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"},{"name":"gateway","path":"api/tags/gateway.json"},{"name":"Hoxton","path":"api/tags/Hoxton.json"},{"name":"swagger","path":"api/tags/swagger.json"},{"name":"knife4j","path":"api/tags/knife4j.json"},{"name":"auth","path":"api/tags/auth.json"}]},{"title":"SpringCloud系列教程(八)之整合seata分布式事务","slug":"2021-11-09-spring-cloud-hoxton-8-seata","date":"2021-11-09T01:40:00.000Z","updated":"2022-12-01T01:32:39.787Z","comments":true,"top":null,"path":"api/articles/2021-11-09-spring-cloud-hoxton-8-seata.json","excerpt":null,"keywords":"java,spring,springboot,springcloud,mybatis,jQuery,html,css","cover":"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109105218.jpg","content":"<blockquote>\n<p>阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<blockquote>\n<p>两个月没有更新了，这次趁着刷技术文章的机会，把目前比较热门的分布式事务框架seata整合一下，分布式事务的出现是因为微服务导致业务分部在不同的服务中，不能像本地事务一样使用事务。</p>\n</blockquote>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6991635985847025671\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992010061576929310\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(四)之SpringCloud Gateway | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992404611617259534\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(五)之SpringCloud Gateway 网关聚合开发文档 swagger knife4j 和登录权限统一验证</a></li>\n<li><a href=\"https://juejin.cn/post/6992404611617259534\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(六)之SpringCloud 使用sentinel作为熔断器</a></li>\n<li><a href=\"https://juejin.cn/post/6993124554428121096\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(七)之使用Spring Cloud Sleuth+Zipkin实现链路追踪</a></li>\n</ul>\n<h2 id=\"什么是seata？\"><a href=\"#什么是seata？\" class=\"headerlink\" title=\"什么是seata？\"></a>什么是seata？</h2><p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p>\n<p>关于更多的原理可以参考官方文档，这里就不赘述了：<a href=\"http://seata.io/zh-cn/docs/overview/what-is-seata.html\" target=\"_blank\" rel=\"noopener\">Seata 是什么</a></p>\n<h2 id=\"下载安装seata-server\"><a href=\"#下载安装seata-server\" class=\"headerlink\" title=\"下载安装seata-server\"></a>下载安装seata-server</h2><h3 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h3><p>下载地址：<a href=\"https://github.com/seata/seata/releases\" target=\"_blank\" rel=\"noopener\">Releases · seata/seata (github.com)</a></p>\n<p>window下载zip，linux/mac下载tar.gz</p>\n<blockquote>\n<p>注意：如何安装nacos请看这：<a href=\"https://nacos.io/zh-cn/docs/quick-start.html\" target=\"_blank\" rel=\"noopener\">Nacos 快速入门</a>，建议查看前面的文章以做到丝滑入戏。</p>\n</blockquote>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><p>解压之后修改配置文件registry.conf（这里主要是配置nacos作为配置中心）：</p>\n<figure class=\"highlight protobuf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs protobuf\">config &#123;<br>  type = <span class=\"hljs-string\">\"nacos\"</span> ## 这里修改为nacos，并且修改下面对应的配置<br><br>  nacos &#123;<br>    serverAddr = <span class=\"hljs-string\">\"127.0.0.1:8848\"</span><br>    namespace = <span class=\"hljs-string\">\"public\"</span><br>    <span class=\"hljs-keyword\">group</span> = <span class=\"hljs-string\">\"SEATA_GROUP\"</span><br>    username = <span class=\"hljs-string\">\"nacos\"</span><br>    password = <span class=\"hljs-string\">\"nacos\"</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>然后继续修改注册中心（nacos作为注册中心）：</p>\n<figure class=\"highlight protobuf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs protobuf\">registry &#123;<br> <br>  type = <span class=\"hljs-string\">\"nacos\"</span><br><br>  nacos &#123;<br>    application = <span class=\"hljs-string\">\"seata-server\"</span><br>    serverAddr = <span class=\"hljs-string\">\"127.0.0.1:8848\"</span><br>    <span class=\"hljs-keyword\">group</span> = <span class=\"hljs-string\">\"DEFAULT_GROUP\"</span> #这里的<span class=\"hljs-keyword\">group</span>需要与业务服务在一个<span class=\"hljs-keyword\">group</span>内<br>    namespace = <span class=\"hljs-string\">\"public\"</span><br>    cluster = <span class=\"hljs-string\">\"default\"</span><br>    username = <span class=\"hljs-string\">\"nacos\"</span><br>    password = <span class=\"hljs-string\">\"nacos\"</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>本文是以nacos作为注册中心和配置中心的，如果需要其它的方式可以查看官方文档。</p>\n<h3 id=\"上传配置\"><a href=\"#上传配置\" class=\"headerlink\" title=\"上传配置\"></a>上传配置</h3><p>在上传之前先下载对应的配置文件模板</p>\n<ol>\n<li>首先下载config.txt文件：<a href=\"https://github.com/seata/seata/tree/develop/script/config-center\" target=\"_blank\" rel=\"noopener\">seata/script/config-center at develop · seata/seata (github.com)</a> ，将其放入到seata的解压目录下；见图例1</li>\n<li>然后在目录下找到对应的配置中心的目录下的shell脚本，这里使用的是nacos-config.sh <a href=\"https://github.com/seata/seata/tree/develop/script/config-center/nacos\" target=\"_blank\" rel=\"noopener\">seata/script/config-center/nacos at develop · seata/seata (github.com)</a>，将其放入到<code>${SEATA_DIR}/script/config-center/nacos/nacos-config.sh</code> 注意：<code>${SEATA_DIR}</code> 是seata的根目录；见图例2</li>\n<li>到seata的解压根目录下运行 <code>sh script/config-center/nacos/nacos-config.sh -h 127.0.0.1 -p 8848 -g SEATA_GROUP -u nacos -w nacos</code> 注意：nacos-config.sh是第2步下载的脚本文件，见图例3</li>\n</ol>\n<p>图例1：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104117.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例1</span></p>\n<p>图例2：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104139.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例2</span></p>\n<p>图例3：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104156.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例3</span></p>\n<p>图例4：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104216.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">图例4</span></p>\n<p>在nacos控制台（localhost:8848/nacos，账密：nacos/nacos）：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104233.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>可以看到配置已经成功上传</p>\n<p>具体的配置请查看：<a href=\"https://github.com/seata/seata/blob/develop/script/config-center/config.txt\" target=\"_blank\" rel=\"noopener\">seata/config.txt at develop · seata/seata (github.com)</a></p>\n<p>配置参数官方对照表：<a href=\"http://seata.io/zh-cn/docs/user/configurations.html\" target=\"_blank\" rel=\"noopener\">Seata 参数配置</a></p>\n<p>注意修改对应数据库的配置，可以直接在nacos中修改配置。</p>\n<blockquote>\n<p>有一个比较关键的点，也是很容易出错的点，有一个配置参数单独拿出来讲一下，<br><code>service.vgroupMapping.&lt;你的服务名称&gt;-group=default</code> 这个分组需要seata-server和client都保持一致，当然，seata是可以存在多个事务分组的，比如我们订单业务涉及到库存等等逻辑，那么将这些在同一个事务的服务加入到同一个事务分组内，就如默认的配置文件中设置为：<code>service.vgroupMapping.my_test_tx_group=default</code> 那么我们需要在服务的application.yml中配置该组：</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">seata:</span><br>  <span class=\"hljs-attr\">tx-service-group:</span> <span class=\"hljs-string\">my_test_tx_group</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"启动seata-server：\"><a href=\"#启动seata-server：\" class=\"headerlink\" title=\"启动seata-server：\"></a>启动seata-server：</h2><p>windows：打开控制台：<code>./seata-server.bat -h 127.0.0.1</code></p>\n<p>linux/macos: <code>sh [seata-server.sh](http://seata-server.sh) -h 127.0.0.1</code></p>\n<p>成功启动：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104300.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">成功启动</span></p>\n<p>nacos注册中心：</p>\n<p><img    class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104319.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"   ><span class=\"image-caption\">nacos注册中心</span></p>\n<h3 id=\"多种部署方式：\"><a href=\"#多种部署方式：\" class=\"headerlink\" title=\"多种部署方式：\"></a>多种部署方式：</h3><ul>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-by-docker.html\" target=\"_blank\" rel=\"noopener\">使用 Docker 部署 Seata Server</a></li>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-by-kubernetes.html\" target=\"_blank\" rel=\"noopener\">使用 Kubernetes 部署 Seata Server</a></li>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-by-helm.html\" target=\"_blank\" rel=\"noopener\">使用 Helm 部署 Seata Server</a></li>\n<li><a href=\"http://seata.io/zh-cn/docs/ops/deploy-ha.html\" target=\"_blank\" rel=\"noopener\">Seata 高可用部署</a></li>\n</ul>\n<h3 id=\"新增seata的数据表：\"><a href=\"#新增seata的数据表：\" class=\"headerlink\" title=\"新增seata的数据表：\"></a>新增seata的数据表：</h3><p>对应的sql文件请查看：<a href=\"https://github.com/seata/seata/tree/1.4.0/script/server/db\" target=\"_blank\" rel=\"noopener\">seata/script/server/db at 1.4.0 · seata/seata (github.com)</a></p>\n<p>下载之后在数据库中新建库：seata，然后将建库脚本导入。</p>\n<h2 id=\"工程改造\"><a href=\"#工程改造\" class=\"headerlink\" title=\"工程改造\"></a>工程改造</h2><h3 id=\"1-复制工程\"><a href=\"#1-复制工程\" class=\"headerlink\" title=\"1.复制工程\"></a>1.复制工程</h3><p>将工程：spring-cloud-nacos-consumer 复制一份，改为：order-server</p>\n<p>将工程：spring-cloud-nacos-provider 复制一份，改为：stock-server</p>\n<p>注意：复制之后需要修改部分pom配置才可以（改为对应的名称）：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>order-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>0.0.1-SNAPSHOT<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">name</span>&gt;</span>order-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">name</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">description</span>&gt;</span>Demo project for Spring Boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">description</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>并且在父pom中加入：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">modules</span>&gt;</span><br>    ...<br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">module</span>&gt;</span>stock-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">module</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">module</span>&gt;</span>order-server<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">module</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">modules</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>然后重新导入依赖即可</p>\n<p>如果还存在异常，请将.imi文件删除</p>\n<h3 id=\"2-增加依赖\"><a href=\"#2-增加依赖\" class=\"headerlink\" title=\"2.增加依赖\"></a>2.增加依赖</h3><p>在两个工程模块的pom中增加依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-comment\">&lt;!-- seata --&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>io.seata<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>seata-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>1.4.2<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">exclusions</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">exclusion</span>&gt;</span><br>                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>io.seata<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>                    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>seata-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>                <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">exclusion</span>&gt;</span><br>            <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">exclusions</span>&gt;</span><br>        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"3-修改工程的application-yml配置\"><a href=\"#3-修改工程的application-yml配置\" class=\"headerlink\" title=\"3.修改工程的application.yml配置\"></a>3.修改工程的application.yml配置</h3><p>order-server</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">logging:</span><br>  <span class=\"hljs-attr\">level:</span><br>    <span class=\"hljs-attr\">io:</span><br>      <span class=\"hljs-attr\">seata:</span> <span class=\"hljs-string\">debug</span><br><span class=\"hljs-attr\">seata:</span><br>  <span class=\"hljs-attr\">tx-service-group:</span> <span class=\"hljs-string\">my_test_tx_group</span><br></code></pre></td></tr></table></figure>\n\n<p>stock-server</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">logging:</span><br>  <span class=\"hljs-attr\">level:</span><br>    <span class=\"hljs-attr\">io:</span><br>      <span class=\"hljs-attr\">seata:</span> <span class=\"hljs-string\">debug</span><br><span class=\"hljs-attr\">seata:</span><br>  <span class=\"hljs-attr\">tx-service-group:</span> <span class=\"hljs-string\">my_test_tx_group</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"4-数据库初始化\"><a href=\"#4-数据库初始化\" class=\"headerlink\" title=\"4.数据库初始化\"></a>4.数据库初始化</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs sql\"><span class=\"hljs-comment\">-- 创建 order库、业务表、undo_log表</span><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">database</span> seata_order;<br><span class=\"hljs-keyword\">use</span> seata_order;<br><br><span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> <span class=\"hljs-string\">`order_tbl`</span>;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`order_tbl`</span> (<br>  <span class=\"hljs-string\">`id`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`user_id`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`commodity_code`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`count`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span>,<br>  <span class=\"hljs-string\">`money`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span>=utf8;<br><br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`undo_log`</span><br>(<br>  <span class=\"hljs-string\">`id`</span>            <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`branch_id`</span>     <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`xid`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`context`</span>       <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">128</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`rollback_info`</span> LONGBLOB     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_status`</span>    <span class=\"hljs-built_in\">INT</span>(<span class=\"hljs-number\">11</span>)      <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_created`</span>   DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_modified`</span>  DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`ext`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>),<br>  <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">KEY</span> <span class=\"hljs-string\">`ux_undo_log`</span> (<span class=\"hljs-string\">`xid`</span>, <span class=\"hljs-string\">`branch_id`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span> = <span class=\"hljs-keyword\">InnoDB</span><br>  AUTO_INCREMENT = <span class=\"hljs-number\">1</span><br>  <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span> = utf8;<br><br><span class=\"hljs-comment\">-- 创建 stock库、业务表、undo_log表</span><br><span class=\"hljs-keyword\">create</span> <span class=\"hljs-keyword\">database</span> seata_stock;<br><span class=\"hljs-keyword\">use</span> seata_stock;<br><br><span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> <span class=\"hljs-string\">`stock_tbl`</span>;<br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`stock_tbl`</span> (<br>  <span class=\"hljs-string\">`id`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`commodity_code`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">255</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`count`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>),<br>  <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`commodity_code`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span>=utf8;<br><br><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`undo_log`</span><br>(<br>  <span class=\"hljs-string\">`id`</span>            <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,<br>  <span class=\"hljs-string\">`branch_id`</span>     <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">20</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`xid`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`context`</span>       <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">128</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`rollback_info`</span> LONGBLOB     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_status`</span>    <span class=\"hljs-built_in\">INT</span>(<span class=\"hljs-number\">11</span>)      <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_created`</span>   DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`log_modified`</span>  DATETIME     <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,<br>  <span class=\"hljs-string\">`ext`</span>           <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">100</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-literal\">NULL</span>,<br>  PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`id`</span>),<br>  <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">KEY</span> <span class=\"hljs-string\">`ux_undo_log`</span> (<span class=\"hljs-string\">`xid`</span>, <span class=\"hljs-string\">`branch_id`</span>)<br>) <span class=\"hljs-keyword\">ENGINE</span> = <span class=\"hljs-keyword\">InnoDB</span><br>  AUTO_INCREMENT = <span class=\"hljs-number\">1</span><br>  <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CHARSET</span> = utf8;<br><br><span class=\"hljs-comment\">-- 初始化库存模拟数据</span><br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> seata_stock.stock_tbl (<span class=\"hljs-keyword\">id</span>, commodity_code, <span class=\"hljs-keyword\">count</span>) <span class=\"hljs-keyword\">VALUES</span> (<span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">'product-1'</span>, <span class=\"hljs-number\">9999999</span>);<br><span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> seata_stock.stock_tbl (<span class=\"hljs-keyword\">id</span>, commodity_code, <span class=\"hljs-keyword\">count</span>) <span class=\"hljs-keyword\">VALUES</span> (<span class=\"hljs-number\">2</span>, <span class=\"hljs-string\">'product-2'</span>, <span class=\"hljs-number\">0</span>);<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"5-引入mybatis-plus\"><a href=\"#5-引入mybatis-plus\" class=\"headerlink\" title=\"5.引入mybatis plus\"></a>5.引入mybatis plus</h3><p>父pom引入依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-comment\">&lt;!-- mybatis plus --&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.baomidou<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>3.4.3.4<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-comment\">&lt;!-- 提供mysql驱动 --&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>mysql<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>8.0.16<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>两个工程分别引入依赖:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-comment\">&lt;!-- mybatis plus --&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.baomidou<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>mysql<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"6-order-server业务修改\"><a href=\"#6-order-server业务修改\" class=\"headerlink\" title=\"6.order-server业务修改\"></a>6.order-server业务修改</h3><p>新增部分类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Data</span><br><span class=\"hljs-meta\">@TableName</span>(<span class=\"hljs-string\">\"order_tbl\"</span>)<br><span class=\"hljs-meta\">@Accessors</span>(chain = <span class=\"hljs-keyword\">true</span>)<br><span class=\"hljs-meta\">@Builder</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Order</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">Serializable</span> </span>&#123;<br><br>   <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> longserialVersionUID= <span class=\"hljs-number\">1L</span>;<br><br>    <span class=\"hljs-meta\">@JsonFormat</span>(shape = JsonFormat.Shape.STRING)<br>    <span class=\"hljs-meta\">@TableId</span>(value=<span class=\"hljs-string\">\"id\"</span> ,type = IdType.AUTO)<br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"id\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer id;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"user_id\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String userId;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"commodity_code\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String commodityCode;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"count\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer count;<br><br><span class=\"hljs-comment\">/**  */</span><br><span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"money\"</span>)<br>    <span class=\"hljs-keyword\">private</span> BigDecimal money;<br><br>    <span class=\"hljs-meta\">@Tolerate</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">Order</span><span class=\"hljs-params\">()</span></span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Mapper</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">OrderTblMapper</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">BaseMapper</span>&lt;<span class=\"hljs-title\">Order</span>&gt; </span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>mapperxml:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;</span><br><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-meta-keyword\">mapper</span> <span class=\"hljs-meta-keyword\">PUBLIC</span> <span class=\"hljs-meta-string\">\"-//mybatis.org//DTD Mapper 3.0//EN\"</span> <span class=\"hljs-meta-string\">\"http://mybatis.org/dtd/mybatis-3-mapper.dtd\"</span>&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">mapper</span> <span class=\"hljs-attr\">namespace</span>=<span class=\"hljs-string\">\"com.winterchen.nacos.mapper.OrderTblMapper\"</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>service:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">OrderTblService</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">IService</span>&lt;<span class=\"hljs-title\">Order</span>&gt; </span>&#123;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">placeOrder</span><span class=\"hljs-params\">(String userId, String commodityCode, Integer count)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Service</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OrderTblServiceImpl</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">ServiceImpl</span>&lt;<span class=\"hljs-title\">OrderTblMapper</span>, <span class=\"hljs-title\">Order</span>&gt; <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">OrderTblService</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> StockFeignClient stockFeignClient;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 下单：创建订单、减库存，涉及到两个服务</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> userId</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> commodityCode</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> count</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@GlobalTransactional</span><br>    <span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Exception<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span><br><span class=\"hljs-class\">    @<span class=\"hljs-title\">Override</span></span><br><span class=\"hljs-class\">    <span class=\"hljs-title\">public</span> <span class=\"hljs-title\">void</span> <span class=\"hljs-title\">placeOrder</span>(<span class=\"hljs-title\">String</span> <span class=\"hljs-title\">userId</span>, <span class=\"hljs-title\">String</span> <span class=\"hljs-title\">commodityCode</span>, <span class=\"hljs-title\">Integer</span> <span class=\"hljs-title\">count</span>) </span>&#123;<br>        BigDecimal orderMoney = <span class=\"hljs-keyword\">new</span> BigDecimal(count).multiply(<span class=\"hljs-keyword\">new</span> BigDecimal(<span class=\"hljs-number\">5</span>));<br>        Order order = <span class=\"hljs-keyword\">new</span> Order().setUserId(userId).setCommodityCode(commodityCode).setCount(count).setMoney(orderMoney);<br>        baseMapper.insert(order);<br>        stockFeignClient.deduct(commodityCode, count);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p><code>StockFeignClient</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@FeignClient</span>(name = <span class=\"hljs-string\">\"stock-server\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">StockFeignClient</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/api/stock/deduct\"</span>)<br>    <span class=\"hljs-function\">Boolean <span class=\"hljs-title\">deduct</span><span class=\"hljs-params\">(@RequestParam(<span class=\"hljs-string\">\"commodityCode\"</span>)</span> String commodityCode, @<span class=\"hljs-title\">RequestParam</span><span class=\"hljs-params\">(<span class=\"hljs-string\">\"count\"</span>)</span> Integer count)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Api</span>(tags=<span class=\"hljs-string\">\"订单API\"</span>)<br><span class=\"hljs-meta\">@RestController</span><br><span class=\"hljs-meta\">@RequestMapping</span>(<span class=\"hljs-string\">\"/api/order\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OrderTblController</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> OrderTblService orderTblService;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 下单：插入订单表、扣减库存，模拟回滚</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/placeOrder/commit\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">placeOrderCommit</span><span class=\"hljs-params\">()</span> </span>&#123;<br><br>        orderTblService.placeOrder(<span class=\"hljs-string\">\"1\"</span>, <span class=\"hljs-string\">\"product-1\"</span>, <span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br><br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 下单：插入订单表、扣减库存，模拟回滚</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/placeOrder/rollback\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">placeOrderRollback</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-comment\">// product-2 扣库存时模拟了一个业务异常,</span><br>        orderTblService.placeOrder(<span class=\"hljs-string\">\"1\"</span>, <span class=\"hljs-string\">\"product-2\"</span>, <span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@PostMapping</span>(<span class=\"hljs-string\">\"/placeOrder\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">placeOrder</span><span class=\"hljs-params\">(String userId, String commodityCode, Integer count)</span> </span>&#123;<br>        orderTblService.placeOrder(userId, commodityCode, count);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"7-stock-server业务修改\"><a href=\"#7-stock-server业务修改\" class=\"headerlink\" title=\"7.stock-server业务修改\"></a>7.stock-server业务修改</h3><p>entity:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Data</span><br><span class=\"hljs-meta\">@TableName</span>(<span class=\"hljs-string\">\"stock_tbl\"</span>)<br><span class=\"hljs-meta\">@Accessors</span>(chain = <span class=\"hljs-keyword\">true</span>)<br><span class=\"hljs-meta\">@Builder</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Stock</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">Serializable</span> </span>&#123;<br>\t<br>\t<span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-keyword\">long</span> serialVersionUID = <span class=\"hljs-number\">1L</span>;<br>\t\t<br>    <span class=\"hljs-meta\">@JsonFormat</span>(shape = JsonFormat.Shape.STRING)<br>    <span class=\"hljs-meta\">@TableId</span>(value=<span class=\"hljs-string\">\"id\"</span> ,type = IdType.AUTO)<br>    <span class=\"hljs-comment\">/**  */</span><br>    <span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"id\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer id;<br><br>    <span class=\"hljs-comment\">/**  */</span><br>    <span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"commodity_code\"</span>)<br>    <span class=\"hljs-keyword\">private</span> String commodityCode;<br><br>    <span class=\"hljs-comment\">/**  */</span><br>    <span class=\"hljs-meta\">@TableField</span>(<span class=\"hljs-string\">\"count\"</span>)<br>    <span class=\"hljs-keyword\">private</span> Integer count;<br><br>    <span class=\"hljs-meta\">@Tolerate</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">Stock</span><span class=\"hljs-params\">()</span></span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>mapper:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Mapper</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">StockTblMapper</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">BaseMapper</span>&lt;<span class=\"hljs-title\">Stock</span>&gt; </span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>mapperxml:</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">&lt;?xml version=<span class=\"hljs-string\">\"1.0\"</span> encoding=<span class=\"hljs-string\">\"UTF-8\"</span>?&gt;<br>&lt;!DOCTYPE mapper PUBLIC <span class=\"hljs-string\">\"-//mybatis.org//DTD Mapper 3.0//EN\"</span> <span class=\"hljs-string\">\"http://mybatis.org/dtd/mybatis-3-mapper.dtd\"</span>&gt;<br>&lt;mapper namespace=<span class=\"hljs-string\">\"com.winterchen.nacos.mapper.StockTblMapper\"</span>&gt;<br><br>&lt;/mapper&gt;<br></code></pre></td></tr></table></figure>\n\n<p>service:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">StockTblService</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">IService</span>&lt;<span class=\"hljs-title\">Stock</span>&gt; </span>&#123;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">deduct</span><span class=\"hljs-params\">(String commodityCode, <span class=\"hljs-keyword\">int</span> count)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Service</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">StockTblServiceImpl</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">ServiceImpl</span>&lt;<span class=\"hljs-title\">StockTblMapper</span>, <span class=\"hljs-title\">Stock</span>&gt; <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">StockTblService</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Exception<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span><br><span class=\"hljs-class\">    @<span class=\"hljs-title\">Override</span></span><br><span class=\"hljs-class\">    <span class=\"hljs-title\">public</span> <span class=\"hljs-title\">void</span> <span class=\"hljs-title\">deduct</span>(<span class=\"hljs-title\">String</span> <span class=\"hljs-title\">commodityCode</span>, <span class=\"hljs-title\">int</span> <span class=\"hljs-title\">count</span>) </span>&#123;<br>        <span class=\"hljs-keyword\">if</span> (commodityCode.equals(<span class=\"hljs-string\">\"product-2\"</span>)) &#123;<br>            <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> RuntimeException(<span class=\"hljs-string\">\"异常:模拟业务异常:stock branch exception\"</span>);<br>        &#125;<br><br>        QueryWrapper&lt;Stock&gt; wrapper = <span class=\"hljs-keyword\">new</span> QueryWrapper&lt;&gt;();<br>        wrapper.setEntity(<span class=\"hljs-keyword\">new</span> Stock().setCommodityCode(commodityCode));<br>        Stock stock = baseMapper.selectOne(wrapper);<br>        stock.setCount(stock.getCount() - count);<br><br>        baseMapper.updateById(stock);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>controller：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Api</span>(tags=<span class=\"hljs-string\">\"库存API\"</span>)<br><span class=\"hljs-meta\">@RestController</span><br><span class=\"hljs-meta\">@RequestMapping</span>(<span class=\"hljs-string\">\"/api/stock\"</span>)<br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">StockTblController</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> StockTblService stockTblService;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 减库存</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> commodityCode 商品代码</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> count         数量</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@PostMapping</span>(path = <span class=\"hljs-string\">\"/deduct\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Boolean <span class=\"hljs-title\">deduct</span><span class=\"hljs-params\">(String commodityCode, Integer count)</span> </span>&#123;<br>        stockTblService.deduct(commodityCode, count);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">true</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"8-修改gateway：\"><a href=\"#8-修改gateway：\" class=\"headerlink\" title=\"8. 修改gateway：\"></a>8. 修改gateway：</h3><p>修改<code>GatewayConfiguration</code></p>\n<p><code>initCustomizedApis</code> 新增对<code>order-server</code>和<code>stock-server</code>的初始化</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">ApiDefinition api3 = <span class=\"hljs-keyword\">new</span> ApiDefinition(<span class=\"hljs-string\">\"order\"</span>)<br>                .setPredicateItems(<span class=\"hljs-keyword\">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br><br>                    add(<span class=\"hljs-keyword\">new</span> ApiPathPredicateItem().setPattern(<span class=\"hljs-string\">\"/order/**\"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>        ApiDefinition api4 = <span class=\"hljs-keyword\">new</span> ApiDefinition(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setPredicateItems(<span class=\"hljs-keyword\">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br>                    add(<span class=\"hljs-keyword\">new</span> ApiPathPredicateItem().setPattern(<span class=\"hljs-string\">\"/stock/**\"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>  definitions.add(api3);<br>  definitions.add(api4);<br></code></pre></td></tr></table></figure>\n\n<p><code>initGatewayRules</code> 新增规则</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"order\"</span>)<br>                .setCount(<span class=\"hljs-number\">10</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"order\"</span>)<br>                .setCount(<span class=\"hljs-number\">2</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">2</span>)<br>                .setBurst(<span class=\"hljs-number\">2</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_CLIENT_IP)<br>                )<br>        );<br><br>rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setCount(<span class=\"hljs-number\">10</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER)<br>                .setMaxQueueingTimeoutMs(<span class=\"hljs-number\">600</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_HEADER)<br>                        .setFieldName(<span class=\"hljs-string\">\"X-Sentinel-Flag\"</span>)<br>                )<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setCount(<span class=\"hljs-number\">1</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"pa\"</span>)<br>                )<br>        );<br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setCount(<span class=\"hljs-number\">2</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">30</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"type\"</span>)<br>                        .setPattern(<span class=\"hljs-string\">\"warn\"</span>)<br>                        .setMatchStrategy(SentinelGatewayConstants.PARAM_MATCH_STRATEGY_CONTAINS)<br>                )<br>        );<br><br>        rules.add(<span class=\"hljs-keyword\">new</span> GatewayFlowRule(<span class=\"hljs-string\">\"stock\"</span>)<br>                .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_CUSTOM_API_NAME)<br>                .setCount(<span class=\"hljs-number\">5</span>)<br>                .setIntervalSec(<span class=\"hljs-number\">1</span>)<br>                .setParamItem(<span class=\"hljs-keyword\">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class=\"hljs-string\">\"pn\"</span>)<br>                )<br>        );<br></code></pre></td></tr></table></figure>\n\n<p><code>appilcation.yml</code>新增对<code>order-server</code>和<code>stock-server</code>的路由配置:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">locator:</span><br>          <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">false</span><br>          <span class=\"hljs-attr\">lowerCaseServiceId:</span> <span class=\"hljs-literal\">true</span><br>      <span class=\"hljs-attr\">routes:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">provider</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-provider</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/provider/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span> <span class=\"hljs-comment\">#StripPrefix=1就代表截取路径的个数为1，比如前端过来请求/test/good/1/view，匹配成功后，路由到后端的请求路径就会变成http://localhost:8888/good/1/view</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">consumer</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-consumer</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/consumer/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">auth</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://auth</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/auth/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">order-server</span>   <span class=\"hljs-string\">-------新增order-server的路由规则</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://order-server</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/order/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">stock-server</span>  <span class=\"hljs-string\">---------</span> <span class=\"hljs-string\">新增stock-server的路由规则</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://stock-server</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/stock/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"测试：\"><a href=\"#测试：\" class=\"headerlink\" title=\"测试：\"></a>测试：</h2><p>首先启动对应的服务：</p>\n<ul>\n<li>spring-cloud-gateway</li>\n<li>spring-cloud-auth</li>\n<li>order-server</li>\n<li>stock-server</li>\n</ul>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104335.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>然后打开swagger进行测试: <a href=\"http://127.0.0.1:15010/doc.html#/order-server/%E8%AE%A2%E5%8D%95API/placeOrderUsingPOST\" target=\"_blank\" rel=\"noopener\">consumer服务</a></p>\n<h3 id=\"测试提交：\"><a href=\"#测试提交：\" class=\"headerlink\" title=\"测试提交：\"></a>测试提交：</h3><p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104403.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>订单创建成功：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104411.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>库存扣减成功：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104419.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<h3 id=\"测试回滚：\"><a href=\"#测试回滚：\" class=\"headerlink\" title=\"测试回滚：\"></a>测试回滚：</h3><p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104428.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>此时数据库里面都正常回滚。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>以上就是本教程的全部内容了，seata是一款非常好用的分布式事务框架，为开发人员提供了比较简单的API，seata默认使用的是AT模式的事务，当然，可以结合自身的业务选择比较合适的分布式事务模式，具体的配置可以参考官方文档。</p>\n<p>本项目的源码地址为：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">WinterChenS/spring-cloud-hoxton-study: spring cloud hoxton release study (github.com)</a></p>\n<h2 id=\"参考文献：\"><a href=\"#参考文献：\" class=\"headerlink\" title=\"参考文献：\"></a>参考文献：</h2><p><a href=\"http://seata.io/zh-cn/docs/overview/what-is-seata.html\" target=\"_blank\" rel=\"noopener\">Seata 是什么</a></p>\n<p><a href=\"http://seata.io/zh-cn/blog/integrate-seata-with-spring-cloud.html\" target=\"_blank\" rel=\"noopener\">Seata（Fescar）分布式事务 整合 Spring Cloud</a></p>\n","raw":null,"categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"},{"name":"Hoxton","path":"api/tags/Hoxton.json"},{"name":"seata","path":"api/tags/seata.json"}]}]}