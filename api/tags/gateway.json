{"name":"gateway","postlist":[{"title":"SpringCloud系列教程(四)之SpringCloud Gateway","slug":"2021-08-03-spring-cloud-hoxton-4-gateway","date":"2021-08-03T01:35:00.000Z","updated":"2022-12-01T01:32:39.787Z","comments":true,"top":null,"path":"api/articles/2021-08-03-spring-cloud-hoxton-4-gateway.json","excerpt":null,"keywords":"java,spring,springboot,springcloud,mybatis,jQuery,html,css","cover":"https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046764668983.jpg","content":"<blockquote>\n<p>**阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：**<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6991635985847025671\" target=\"_blank\" rel=\"noopener\"># SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>\n</ul>\n<h2 id=\"本文概览\"><a href=\"#本文概览\" class=\"headerlink\" title=\"本文概览\"></a>本文概览</h2><ul>\n<li>Spring Cloud Gateway的简介</li>\n<li>gateway在微服务架构中的应用场景</li>\n<li>Spring Cloud Gateway使用</li>\n<li>相关配置详解</li>\n<li>实战中的使用</li>\n</ul>\n<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><p>Spring Cloud 作为新一代的微服务网关，该项目基于Spring webflux技术开发的网关，作为Spring Cloud生态系统中的网关，目标是替代zuul，为什么使用webflux？webflux是Reactor模式的响应式编程框架，底层使用了netty通信框架，非Reactor模式的zuul采用的是Tomcat容器，使用的还是传统的Servlet IO处理模型。想了解webflux和netty的同学可以搜索相关知识，这也是当前比较热门的技术。</p>\n<p>本文中用到的demo源码地址：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<h3 id=\"Gateway的特征\"><a href=\"#Gateway的特征\" class=\"headerlink\" title=\"Gateway的特征\"></a>Gateway的特征</h3><p>引用官方的文档：</p>\n<blockquote>\n<p>Spring Cloud Gateway features:</p>\n</blockquote>\n<ul>\n<li><p>Built on Spring Framework 5, Project Reactor and Spring Boot 2.0</p>\n</li>\n<li><p>Able to match routes on any request attribute.</p>\n</li>\n<li><p>Predicates and filters are specific to routes.</p>\n</li>\n<li><p>Circuit Breaker integration.</p>\n</li>\n<li><p>Spring Cloud DiscoveryClient integration</p>\n</li>\n<li><p>Easy to write Predicates and Filters</p>\n</li>\n<li><p>Request Rate Limiting</p>\n</li>\n<li><p>Path Rewriting</p>\n</li>\n<li><p>Spring Cloud Gateway 基于 Spring Framework 5, Project Reactor 和 Spring Boot 2.0</p>\n</li>\n<li><p>能够匹配任何请求属性上的路由。</p>\n</li>\n<li><p>Predicates和filters特定于路由，易于编写的Predicates和filters</p>\n</li>\n<li><p>Hystrix断路器的继承</p>\n</li>\n<li><p>集成了DiscoveryClient</p>\n</li>\n<li><p>具备了一些高级功：动态路由、限流、路径重写等</p>\n</li>\n</ul>\n<p>和zuul的功能相差不大，最主要的区别是底层通信框架的实现上。</p>\n<p>具体的通信框架这里就暂时不展开了。</p>\n<h2 id=\"微服务网关的应用场景\"><a href=\"#微服务网关的应用场景\" class=\"headerlink\" title=\"微服务网关的应用场景\"></a>微服务网关的应用场景</h2><p>在微服务架构中，网关起到了下层服务的路由、限流和路径重写等作用，下面用一张简单的架构图来描述一下微服务网关的作用：</p>\n<p><img   class=\"lazyload\" data-original=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/78dd5ad29dae4bf2b26ed589c74dd811~tplv-k3u1fbpfcp-zoom-1.image\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>上图中很直观的展示了Spring Cloud Gateway在整个架构中的作用。</p>\n<h2 id=\"Spring-Cloud-Gateway使用\"><a href=\"#Spring-Cloud-Gateway使用\" class=\"headerlink\" title=\"Spring Cloud Gateway使用\"></a>Spring Cloud Gateway使用</h2><h3 id=\"新建模块\"><a href=\"#新建模块\" class=\"headerlink\" title=\"新建模块\"></a>新建模块</h3><p>新建一个springboot工程，maven依赖如下，详细的配置可以查看demo源码</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.alibaba.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-test<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">scope</span>&gt;</span>test<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">scope</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h3><p>修改配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">15010</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">118.25</span><span class=\"hljs-number\">.36</span><span class=\"hljs-number\">.41</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">locator:</span><br>          <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">false</span><br>          <span class=\"hljs-attr\">lowerCaseServiceId:</span> <span class=\"hljs-literal\">true</span><br>      <span class=\"hljs-attr\">routes:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">provider</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-provider</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/provider/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">consumer</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-consumer</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/consumer/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br><br>  <span class=\"hljs-attr\">application:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">winter-gateway</span><br></code></pre></td></tr></table></figure>\n\n<p>具体配置的解释后面会介绍。</p>\n<p>接下来就在启动类中加入注解: <code>@EnableDiscoveryClient</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@EnableDiscoveryClient</span><br><span class=\"hljs-meta\">@SpringBootApplication</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SpringCloudGatewayApplication</span> </span>&#123;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(SpringCloudGatewayApplication<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>, <span class=\"hljs-title\">args</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>启动服务：<code>spring-cloud-nacos-consumer</code>， <code>spring-cloud-nacos-provider</code>，<code>spring-cloud-gateway</code> </p>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>浏览器输入：<a href=\"http://127.0.0.1:15010/consumer/nacos/echo/hello\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:15010/consumer/nacos/echo/hello</a></p>\n<p>得到返回值：<code>Hello Nacos Discovery hello</code> </p>\n<h3 id=\"拓展：解决跨域问题\"><a href=\"#拓展：解决跨域问题\" class=\"headerlink\" title=\"拓展：解决跨域问题\"></a>拓展：解决跨域问题</h3><p>Spring Cloud Gateway如何解决跨域问题？我们可以在配置文件中加入：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">globalcors:</span><br>        <span class=\"hljs-attr\">cors-configurations:</span><br>          <span class=\"hljs-string\">'[/**]'</span><span class=\"hljs-string\">:</span> <span class=\"hljs-comment\"># 匹配所有请求</span><br>            <span class=\"hljs-attr\">allowedOrigins:</span> <span class=\"hljs-string\">\"*\"</span> <span class=\"hljs-comment\">#跨域处理 允许所有的域</span><br>            <span class=\"hljs-attr\">allowedMethods:</span> <span class=\"hljs-comment\"># 支持的方法</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">GET</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">POST</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">PUT</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">DELETE</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"Spring-Cloud-Gateway-配置详解\"><a href=\"#Spring-Cloud-Gateway-配置详解\" class=\"headerlink\" title=\"Spring Cloud Gateway 配置详解\"></a>Spring Cloud Gateway 配置详解</h2><p>我们看一下上面我们用到的配置文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">server:</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">15010</span><br><br><span class=\"hljs-attr\">spring:</span><br>  <span class=\"hljs-attr\">cloud:</span><br>    <span class=\"hljs-attr\">nacos:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">118.25</span><span class=\"hljs-number\">.36</span><span class=\"hljs-number\">.41</span><span class=\"hljs-string\">:8848</span><br>    <span class=\"hljs-attr\">gateway:</span><br>      <span class=\"hljs-attr\">discovery:</span><br>        <span class=\"hljs-attr\">locator:</span><br>          <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">false</span><br>          <span class=\"hljs-attr\">lowerCaseServiceId:</span> <span class=\"hljs-literal\">true</span><br>      <span class=\"hljs-attr\">routes:</span><br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">provider</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-provider</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/provider/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span> <br>        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">consumer</span><br>          <span class=\"hljs-attr\">uri:</span> <span class=\"hljs-string\">lb://winter-nacos-consumer</span><br>          <span class=\"hljs-attr\">predicates:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">Path=/consumer/**</span><br>          <span class=\"hljs-attr\">filters:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">StripPrefix=1</span><br><br>  <span class=\"hljs-attr\">application:</span><br>    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">winter-gateway</span><br></code></pre></td></tr></table></figure>\n\n<p><strong>id</strong>：我们自定义的路由 ID，保持唯一</p>\n<p><strong>uri</strong>：目标服务地址</p>\n<p><strong>predicates</strong>：路由条件，Predicate 接受一个输入参数，返回一个布尔值结果。该接口包含多种默认方法来将 Predicate 组合成其他复杂的逻辑（比如：与，或，非）。</p>\n<p>上面这段配置的意思是，配置了一个 id 为 url-proxy-1的URI代理规则，路由的规则为：</p>\n<p>当访问地址<code>http://localhost:8080/provider/nacos/echo/hello</code>时，</p>\n<p>会路由到上游地址<code>http://winter-nacos-provider/nacos/echo/hello</code>。</p>\n<p><strong>filters</strong>: 过滤器是路由转发请求时所经过的过滤逻辑，可用于修改请求、响应内容，<code>StripPrefix=1</code>就代表截取路径的个数为1，比如前端过来请求<code>/provider/nacos/echo/hello</code>，匹配成功后，路由到后端的请求路径就会变成<code>http://127.0.0.1:16012/nacos/echo/hello</code>。</p>\n<p>关于gateway的详细配置，可以参考: </p>\n<p><a href=\"https://www.cnblogs.com/crazymakercircle/p/11704077.html\" target=\"_blank\" rel=\"noopener\">SpringCloud gateway （史上最全）</a></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>关于spring cloud gateway的介绍先讲到这里，后一篇会讲解如何在网关层集成swagger文档以及如何在网关层进行登录权限的验证。并且会介绍相关的原理。</p>\n<h2 id=\"源码地址\"><a href=\"#源码地址\" class=\"headerlink\" title=\"源码地址\"></a>源码地址</h2><p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<p>参考文献：</p>\n<p><a href=\"https://spring.io/projects/spring-cloud-gateway#overview\" target=\"_blank\" rel=\"noopener\">Spring Cloud Gateway</a></p>\n<p><a href=\"https://www.cnblogs.com/crazymakercircle/p/11704077.html\" target=\"_blank\" rel=\"noopener\">SpringCloud gateway （史上最全）</a></p>\n","raw":null,"categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"},{"name":"gateway","path":"api/tags/gateway.json"},{"name":"Hoxton","path":"api/tags/Hoxton.json"}]},{"title":"SpringCloud系列教程(五)之SpringCloud Gateway 网关聚合开发文档 swagger knife4j 和登录权限统一验证","slug":"2021-08-04-spring-cloud-hoxton-5-swagger","date":"2021-08-04T04:21:00.000Z","updated":"2022-12-01T01:32:39.787Z","comments":true,"top":null,"path":"api/articles/2021-08-04-spring-cloud-hoxton-5-swagger.json","excerpt":null,"keywords":"java,spring,springboot,springcloud,mybatis,jQuery,html,css","cover":"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804122154.jpg","content":"<blockquote>\n<p>阅读提醒：</p>\n</blockquote>\n<ol>\n<li>本文面向的是有一定springboot基础者</li>\n<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>\n<li>由于knife4j比swagger更加友好，所以本文集成knife4j</li>\n<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>\n</ol>\n<h2 id=\"前情概要\"><a href=\"#前情概要\" class=\"headerlink\" title=\"前情概要\"></a>前情概要</h2><ul>\n<li><a href=\"https://juejin.cn/post/6987998097209032741\" target=\"_blank\" rel=\"noopener\" title=\"https://juejin.cn/post/6987998097209032741\">SpringCloud系列教程(一)开篇</a></li>\n<li><a href=\"https://juejin.cn/post/6991323018802757662\" target=\"_blank\" rel=\"noopener\" title=\"https://juejin.cn/post/6991323018802757662\">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6991635985847025671\" target=\"_blank\" rel=\"noopener\" title=\"https://juejin.cn/post/6991635985847025671\"># SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>\n<li><a href=\"https://juejin.cn/post/6992010061576929310\" target=\"_blank\" rel=\"noopener\">SpringCloud系列教程(四)之SpringCloud Gateway | 8月更文挑战</a></li>\n</ul>\n<h2 id=\"本文概览\"><a href=\"#本文概览\" class=\"headerlink\" title=\"本文概览\"></a>本文概览</h2><ul>\n<li>Spring Cloud Gateway集成Knife4j</li>\n<li>Spring Cloud Gateway集成登录权限统一校验</li>\n</ul>\n<h2 id=\"开始\"><a href=\"#开始\" class=\"headerlink\" title=\"开始\"></a>开始</h2><p>上篇文章介绍了Spring Cloud Gateway的使用，本文将介绍如何在网关层聚合swagger文档，聚合之后可以非常方便的对开发文档进行管理，也是业界比较常用的方式。</p>\n<p>首先在<strong>父pom</strong>文件<code>dependencyManagement</code> 节点中增加knife4j的依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.github.xiaoymin<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>3.0.3<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置-spring-cloud-nacos-provider和spring-cloud-nacos-consumer\"><a href=\"#配置-spring-cloud-nacos-provider和spring-cloud-nacos-consumer\" class=\"headerlink\" title=\"配置 spring-cloud-nacos-provider和spring-cloud-nacos-consumer\"></a>配置 spring-cloud-nacos-provider和spring-cloud-nacos-consumer</h2><blockquote>\n<p>注意，这里标题中两个工程为前几篇文章中构建的，如果不想看前几篇文章，就创建两个模块然后分别集成nacos，knife4j即可。</p>\n</blockquote>\n<p>在两个模块中分别增加maven依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.github.xiaoymin<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br>  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>在两个模块中分别新增配置类：<code>Knife4jConfiguration</code> </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Configuration</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Knife4jConfiguration</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Value</span>(<span class=\"hljs-string\">\"$&#123;swagger.enable:true&#125;\"</span>)<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">boolean</span> enableSwagger;<br><br>    <span class=\"hljs-meta\">@Bean</span>(value = <span class=\"hljs-string\">\"defaultApi2\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Docket <span class=\"hljs-title\">createRestApi</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Docket(DocumentationType.SWAGGER_2)<br>                .apiInfo(<span class=\"hljs-keyword\">new</span> ApiInfoBuilder()<br>                            .title(<span class=\"hljs-string\">\"provider服务\"</span>)<br>                            .version(<span class=\"hljs-string\">\"1.0\"</span>)<br>                            .build())<br>                .enable(enableSwagger)<br>                .select()<br>                .apis(RequestHandlerSelectors.basePackage(<span class=\"hljs-string\">\"com.winterchen.nacos.rest\"</span>))<br>                .paths(PathSelectors.any())<br>                .build();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>注意有些相关的信息需要修改。</p>\n<p>新增配置：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">swagger:</span><br>    <span class=\"hljs-attr\">enable:</span> <span class=\"hljs-literal\">true</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置-spring-cloud-gateway\"><a href=\"#配置-spring-cloud-gateway\" class=\"headerlink\" title=\"配置 spring-cloud-gateway\"></a>配置 spring-cloud-gateway</h2><p>接下来是重头戏，如何在Spring Cloud Gateway中聚合swagger文档。</p>\n<p>首先在pom中增加maven依赖：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.github.xiaoymin<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span><br>    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>\n\n<p>新增Swagger的配置类：<code>SwaggerResourceConfig</code> </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Component</span><br><span class=\"hljs-meta\">@Primary</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SwaggerResourceConfig</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">SwaggerResourcesProvider</span> </span>&#123;<br><br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> RouteLocator routeLocator;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> GatewayProperties gatewayProperties;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">SwaggerResourceConfig</span><span class=\"hljs-params\">(RouteLocator routeLocator, GatewayProperties gatewayProperties)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.routeLocator = routeLocator;<br>        <span class=\"hljs-keyword\">this</span>.gatewayProperties = gatewayProperties;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> List&lt;SwaggerResource&gt; <span class=\"hljs-title\">get</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        List&lt;SwaggerResource&gt; resources = <span class=\"hljs-keyword\">new</span> ArrayList&lt;&gt;();<br>        List&lt;String&gt; routes = <span class=\"hljs-keyword\">new</span> ArrayList&lt;&gt;();<br>        <span class=\"hljs-comment\">//获取所有路由的ID</span><br>        routeLocator.getRoutes().subscribe(route -&gt; routes.add(route.getId()));<br>        <span class=\"hljs-comment\">//过滤出配置文件中定义的路由-&gt;过滤出Path Route Predicate-&gt;根据路径拼接成api-docs路径-&gt;生成SwaggerResource</span><br>        gatewayProperties.getRoutes().stream().filter(routeDefinition -&gt; routes.contains(routeDefinition.getId())).forEach(route -&gt; &#123;<br>            route.getPredicates().stream()<br>                    .filter(predicateDefinition -&gt; (<span class=\"hljs-string\">\"Path\"</span>).equalsIgnoreCase(predicateDefinition.getName()))<br>                    .forEach(predicateDefinition -&gt; resources.add(swaggerResource(route.getId(),<br>                            predicateDefinition.getArgs().get(NameUtils.GENERATED_NAME_PREFIX + <span class=\"hljs-string\">\"0\"</span>)<br>                                    .replace(<span class=\"hljs-string\">\"**\"</span>, <span class=\"hljs-string\">\"v2/api-docs\"</span>))));<br>        &#125;);<br><br>        <span class=\"hljs-keyword\">return</span> resources;<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> SwaggerResource <span class=\"hljs-title\">swaggerResource</span><span class=\"hljs-params\">(String name, String location)</span> </span>&#123;<br>        SwaggerResource swaggerResource = <span class=\"hljs-keyword\">new</span> SwaggerResource();<br>        swaggerResource.setName(name);<br>        swaggerResource.setLocation(location);<br>        swaggerResource.setSwaggerVersion(<span class=\"hljs-string\">\"2.0\"</span>);<br>        <span class=\"hljs-keyword\">return</span> swaggerResource;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<p>主要的配置的作用已经在代码中进行注释。</p>\n<p>新增一个控制器：<code>SwaggerHandler</code> </p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@RestController</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SwaggerHandler</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span>(required = <span class=\"hljs-keyword\">false</span>)<br>    <span class=\"hljs-keyword\">private</span> SecurityConfiguration securityConfiguration;<br><br>    <span class=\"hljs-meta\">@Autowired</span>(required = <span class=\"hljs-keyword\">false</span>)<br>    <span class=\"hljs-keyword\">private</span> UiConfiguration uiConfiguration;<br><br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">final</span> SwaggerResourcesProvider swaggerResources;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">SwaggerHandler</span><span class=\"hljs-params\">(SwaggerResourcesProvider swaggerResources)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">this</span>.swaggerResources = swaggerResources;<br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * Swagger安全配置，支持oauth和apiKey设置</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/swagger-resources/configuration/security\"</span>)<br>    <span class=\"hljs-keyword\">public</span> Mono&lt;ResponseEntity&lt;SecurityConfiguration&gt;&gt; securityConfiguration() &#123;<br>        <span class=\"hljs-keyword\">return</span> Mono.just(<span class=\"hljs-keyword\">new</span> ResponseEntity&lt;&gt;(<br>                Optional.ofNullable(securityConfiguration).orElse(SecurityConfigurationBuilder.builder().build()), HttpStatus.OK));<br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * Swagger UI配置</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/swagger-resources/configuration/ui\"</span>)<br>    <span class=\"hljs-keyword\">public</span> Mono&lt;ResponseEntity&lt;UiConfiguration&gt;&gt; uiConfiguration() &#123;<br>        <span class=\"hljs-keyword\">return</span> Mono.just(<span class=\"hljs-keyword\">new</span> ResponseEntity&lt;&gt;(<br>                Optional.ofNullable(uiConfiguration).orElse(UiConfigurationBuilder.builder().build()), HttpStatus.OK));<br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * Swagger资源配置，微服务中这各个服务的api-docs信息</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/swagger-resources\"</span>)<br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Mono&lt;ResponseEntity&gt; <span class=\"hljs-title\">swaggerResources</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> Mono.just((<span class=\"hljs-keyword\">new</span> ResponseEntity&lt;&gt;(swaggerResources.get(), HttpStatus.OK)));<br>    &#125;<br>&#125;-----------------<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>分别运行：spring-cloud-nacos-provider，spring-cloud-nacos-consumer，spring-cloud-gateway 三个服务。</p>\n<p>打开swagger的地址: <a href=\"http://127.0.0.1:15010/doc.html\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1:15010/doc.html</a></p>\n<p>验证结果：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124615.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>看到上图中的结果说明聚合成功。</p>\n<h2 id=\"集成登录权限的统一校验\"><a href=\"#集成登录权限的统一校验\" class=\"headerlink\" title=\"集成登录权限的统一校验\"></a>集成登录权限的统一校验</h2><blockquote>\n<p>为了直达主题，本次集成登录权限会尽量的简单，其中忽略一些细节，比如登录服务模块，可以查看demo的源码：<a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study/tree/main/spring-cloud-auth\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study/tree/main/spring-cloud-auth</a><br>并且我会在关键的点上明确讲解。</p>\n</blockquote>\n<p>在开始之前需要明白一个原理，如果要实现统一鉴权，那么需要对所有的请求进行统一的拦截，要实现统一的拦截，在Spring Cloud Gateway中有一个filter接口为：<code>GlobalFilter</code> 。</p>\n<p>所以我们可以通过实现<code>GlobalFilter</code> 接口来实现请求的拦截。</p>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><p>新建一个类实现<code>GlobalFilter</code> 接口，并且实现<code>filter</code> 方法，在此基础上我们还需要实现<code>Ordered</code> 接口，控制拦截的优先级，鉴权拦截优先级是最高的，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Slf</span>4j<br><span class=\"hljs-meta\">@Component</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AuthorizeFilter</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">GlobalFilter</span>, <span class=\"hljs-title\">Ordered</span> </span>&#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    UserRedisCollection userRedisCollection;<br><br>\t\t<span class=\"hljs-comment\">// (1)</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">boolean</span> <span class=\"hljs-title\">checkWhiteList</span><span class=\"hljs-params\">(String uri)</span> </span>&#123;<br>        <span class=\"hljs-keyword\">boolean</span> access = <span class=\"hljs-keyword\">false</span>;<br>        <span class=\"hljs-keyword\">if</span> (uri.contains(<span class=\"hljs-string\">\"/login\"</span>) || uri.contains(<span class=\"hljs-string\">\"/v2/api-docs\"</span>)) &#123;<br>            access = <span class=\"hljs-keyword\">true</span>;<br>            <span class=\"hljs-keyword\">if</span> (uri.contains(<span class=\"hljs-string\">\"logout\"</span>)) &#123;<br>                access = <span class=\"hljs-keyword\">false</span>;<br>            &#125;<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (uri.contains(<span class=\"hljs-string\">\"/open-api\"</span>)) &#123;<br>            access = <span class=\"hljs-keyword\">true</span>;<br>        &#125;<br>        <span class=\"hljs-keyword\">return</span> access;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Mono&lt;Void&gt; <span class=\"hljs-title\">filter</span><span class=\"hljs-params\">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;<br>\t\t\t  <span class=\"hljs-comment\">// (2)</span><br>        ServerHttpRequest request = exchange.getRequest();<br>        ServerHttpResponse response = exchange.getResponse();<br>        String uri = request.getURI().getPath();<br>\t\t\t\t<br>\t\t\t\t<span class=\"hljs-comment\">// (3)</span><br>        <span class=\"hljs-comment\">//前端访问不到header问题</span><br>        response.getHeaders().add(<span class=\"hljs-string\">\"Access-Control-Allow-Headers\"</span>,<span class=\"hljs-string\">\"X-PINGOTHER, Origin, X-Requested-With, Content-Type, Accept, token\"</span>);<br>        response.getHeaders().add(<span class=\"hljs-string\">\"Access-Control-Expose-Headers\"</span>, <span class=\"hljs-string\">\"token\"</span>);<br>        ServerHttpRequest mutableReq = request.mutate()<br>                .header(DefaultConstants.IP_ADDRESS, getIpAddress(request))<br>                .build();<br>        ServerWebExchange mutableExchange = exchange.mutate().request(mutableReq).build();<br>        <span class=\"hljs-comment\">// (4)</span><br>\t\t\t\t<span class=\"hljs-comment\">//检查白名单</span><br>        <span class=\"hljs-keyword\">if</span> (checkWhiteList(uri)) &#123;<br>            <span class=\"hljs-keyword\">return</span> chain.filter(mutableExchange);<br>        &#125;<br>\t\t\t\t<br>\t\t\t\t<span class=\"hljs-comment\">// (5)</span><br>        <span class=\"hljs-comment\">//从request获取token</span><br>        String accessToken = request.getHeaders().getFirst(DefaultConstants.TOKEN);<br>        log.info(<span class=\"hljs-string\">\"AccessToken: [&#123;&#125;]\"</span>, accessToken);<br><br>\t\t\t\t<span class=\"hljs-comment\">// (6)</span><br>        <span class=\"hljs-keyword\">if</span> (StringUtils.isBlank(accessToken)) &#123;<br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class=\"hljs-keyword\">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class=\"hljs-string\">\"未登录\"</span>);<br>        &#125;<br>        Claims claims = <span class=\"hljs-keyword\">null</span>;<br>        <span class=\"hljs-keyword\">try</span> &#123;<br>\t\t\t\t\t\t<span class=\"hljs-comment\">// (7)</span><br>            claims = JwtUtil.parseJWT(accessToken, DefaultConstants.SECRET_KEY);<br>\t\t\t\t\t\t<br>            <span class=\"hljs-keyword\">if</span> (claims == <span class=\"hljs-keyword\">null</span>) &#123;<br>                response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>                <span class=\"hljs-keyword\">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class=\"hljs-string\">\"未登录\"</span>);<br>            &#125;<br>            log.info(<span class=\"hljs-string\">\"claims is:&#123;&#125;\"</span>, claims);<br>            <span class=\"hljs-keyword\">if</span> (claims.getSubject().equals(DefaultConstants.USER))&#123;<br>                <span class=\"hljs-keyword\">if</span>(claims.get(DefaultConstants.USERID)!=<span class=\"hljs-keyword\">null</span>) &#123;<br>                    Long userId = Long.parseLong(claims.get(DefaultConstants.USERID).toString());<br><br>                    log.info(<span class=\"hljs-string\">\"userId:&#123;&#125;\"</span>, userId);<br>                    Map&lt;String, Object&gt; map = Maps.newHashMapWithExpectedSize(<span class=\"hljs-number\">1</span>);<br>                    map.put(DefaultConstants.USERID,userId.toString());<br>\t\t\t\t\t\t\t\t\t\t<br>\t\t\t\t\t\t\t\t\t\t<span class=\"hljs-comment\">// (8)</span><br>                    UserInfoEntity userInfo = userRedisCollection.getAuthUserInfoAndCache(userId);<br>                    <span class=\"hljs-comment\">//判断是否</span><br>                    <span class=\"hljs-keyword\">if</span> (userInfo == <span class=\"hljs-keyword\">null</span>) &#123;<br>                        response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>                        <span class=\"hljs-keyword\">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class=\"hljs-string\">\"未登录\"</span>);<br>                    &#125;<br><br>\t\t\t\t\t\t\t\t\t\t<span class=\"hljs-comment\">// (9)</span><br>                    String token = JwtUtil.createToken(DefaultConstants.USER, map, DefaultConstants.SECRET_KEY);<br>                    response.getHeaders().add(DefaultConstants.TOKEN, token);<br>\t\t\t\t\t\t\t\t\t\t<br>                    mutableReq = request.mutate().header(DefaultConstants.USER_ID, String.valueOf(userId))<br>                            .header(DefaultConstants.IP_ADDRESS, getIpAddress(request))<br>                            .build();<br>                    mutableExchange = exchange.mutate().request(mutableReq).build();<br>                    <span class=\"hljs-keyword\">return</span> chain.filter(mutableExchange);<br><br>                &#125;<br><br>            &#125;<br>        &#125; <span class=\"hljs-keyword\">catch</span> (Exception e) &#123;<br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class=\"hljs-keyword\">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class=\"hljs-string\">\"未登录\"</span>);<br>        &#125;<br><br>        <span class=\"hljs-keyword\">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class=\"hljs-string\">\"未登录\"</span>);<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> Mono&lt;Void&gt; <span class=\"hljs-title\">getVoidMono</span><span class=\"hljs-params\">(ServerHttpResponse serverHttpResponse, ResultCodeEnum resultCode, String responseText)</span> </span>&#123;<br>        serverHttpResponse.getHeaders().add(<span class=\"hljs-string\">\"Content-Type\"</span>, <span class=\"hljs-string\">\"application/json;charset=UTF-8\"</span>);<br>        CommonResult&lt;?&gt; result = CommonResult.failed(resultCode.getCode(), responseText);<br>        DataBuffer dataBuffer = serverHttpResponse.bufferFactory().wrap(JSON.toJSONString(result).getBytes());<br>        <span class=\"hljs-keyword\">return</span> serverHttpResponse.writeWith(Flux.just(dataBuffer));<br>    &#125;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">getIpAddress</span><span class=\"hljs-params\">(ServerHttpRequest request)</span> </span>&#123;<br>        String ip = request.getHeaders().getFirst(<span class=\"hljs-string\">\"x-forwarded-for\"</span>);<br>        <span class=\"hljs-keyword\">if</span> (ip == <span class=\"hljs-keyword\">null</span> || ip.length() == <span class=\"hljs-number\">0</span> || <span class=\"hljs-string\">\"unknown\"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class=\"hljs-string\">\"Proxy-Client-IP\"</span>);<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ip == <span class=\"hljs-keyword\">null</span> || ip.length() == <span class=\"hljs-number\">0</span> || <span class=\"hljs-string\">\"unknown\"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class=\"hljs-string\">\"WL-Proxy-Client-IP\"</span>);<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ip == <span class=\"hljs-keyword\">null</span> || ip.length() == <span class=\"hljs-number\">0</span> || <span class=\"hljs-string\">\"unknown\"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class=\"hljs-string\">\"HTTP_CLIENT_IP\"</span>);<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ip == <span class=\"hljs-keyword\">null</span> || ip.length() == <span class=\"hljs-number\">0</span> || <span class=\"hljs-string\">\"unknown\"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class=\"hljs-string\">\"HTTP_X_FORWARDED_FOR\"</span>);<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (ip == <span class=\"hljs-keyword\">null</span> || ip.length() == <span class=\"hljs-number\">0</span> || <span class=\"hljs-string\">\"unknown\"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getRemoteAddress().getHostString();<br>        &#125;<br>        <span class=\"hljs-keyword\">return</span> ip;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">getOrder</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        <span class=\"hljs-keyword\">return</span> -<span class=\"hljs-number\">100</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li>(1) 这个方法可以将白名单加入，当请求到这些url的时候不进行权限的校验</li>\n<li>(2) 我们在使用Spring Cloud Gateway的时候，注意到过滤器（包括GatewayFilter、GlobalFilter和过滤器链GatewayFilterChain），都依赖到ServerWebExchange，这里filter的设计跟Servlet中的的filter相似，也就是当前过滤器决定是否执行下一个过滤器的逻辑，而ServerWebExchange就是当前请求和响应的上下文，不仅包含了request和response，还包含了一些扩展方法，如代码中可以获取到request和response。</li>\n<li>(3) 这一步，主要是解决前端无法中header中获取到需要获取的参数。比如<code>token</code> 。</li>\n<li>(4) 这里对应了第一步白名单的判断，如果当前请求在白名单就跳过后面的一些权限的判断，直接执行下一个过滤器。</li>\n<li>(5) 这里很简单，就是从request中获取到token，方便jwt转换成对应的用户信息。</li>\n<li>(6) 如果请求没有携带token就不予通过。</li>\n<li>(7) jwt将token转换成用户信息，用于后面的判断以及用户的基本信息。</li>\n<li>(8) 上面获取到用户的信息之后，根据用户的userId查询redis中是否存在该用户数据，如果不存在表示该用户的用户信息已经过期了，而且从redis查询的时候会重置超时时间（也就保证了只要经常的在线就不需要重新登录，超过设定的时间没有在线，那么就需要重新登录）。注意：这里是需要跟登录服务进行联动，也就是登录成功之后将用户的信息存入redis，然后gateway这边能取到该用户信息。所以需要保证这一点。</li>\n<li>(9) 这里会重新颁发token，主要是防止token会过期，token的过期时间在jwtUtils中可以设置，所以，前端需要每次请求之后都将新的token作为下一次请求的token。</li>\n<li>注意：本文的token是放在header中，前端小伙伴需要从header中取token。</li>\n</ul>\n<p>代码中的方法：<code>UserRedisCollection.getAuthUserInfoAndCache(Long userId)</code></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> RedisTemplate redisTemplate;<br><br>    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> UserInfoEntity <span class=\"hljs-title\">getAuthUserInfoAndCache</span><span class=\"hljs-params\">(Long userId)</span> </span>&#123;<br>        CommonAssert.meetCondition(userId == <span class=\"hljs-keyword\">null</span>, <span class=\"hljs-string\">\"未获取到userId\"</span>);<br>        String key = DefaultConstants.USER_INFO_REDIS + userId;<br>        UserInfoEntity entity = (UserInfoEntity) redisTemplate.opsForValue().get(key);<br>        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">null</span> != entity) &#123;<br>            redisTemplate.opsForValue().set(key, entity, <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">24</span> * <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">60</span> * <span class=\"hljs-number\">1000</span>, TimeUnit.MILLISECONDS);<br>            <span class=\"hljs-keyword\">return</span> entity;<br>        &#125;<br>        CommonAssert.meetCondition(<span class=\"hljs-keyword\">true</span>, <span class=\"hljs-string\">\"当前用户未登陆，未获取到登陆信息\"</span>);<br>        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>\n\n<p>该方法简单，就是根据userId获取到用户信息的，成功获取之后会重置超时时间，时长可以根据需要进行修改。</p>\n<p>关于本文的登录服务，可以从demo源码中获取：</p>\n<p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study/tree/main/spring-cloud-auth\" target=\"_blank\" rel=\"noopener\">spring-cloud-hoxton-study/spring-cloud-auth at main · WinterChenS/spring-cloud-hoxton-study</a></p>\n<h3 id=\"测试-1\"><a href=\"#测试-1\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>分别启动gateway,provider,auth服务。</p>\n<p>首先，测试未登录的情况：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124637.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>然后进入auth服务，打开登录接口：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124653.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>打开Headers，复制token</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124712.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>再次切换到provider服务，设置文档的全局参数：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124726.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>然后刷新一下页面再请求就可以发现，请求成功：</p>\n<p><img   class=\"lazyload\" data-original=\"https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124735.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  alt=\"\"></p>\n<p>到这里就成功集成了gateway鉴权了。</p>\n<h3 id=\"拓展\"><a href=\"#拓展\" class=\"headerlink\" title=\"拓展\"></a>拓展</h3><ul>\n<li>至于登出的逻辑，思路是这样的，登出只需要在auth服务中将用户信息从redis清除即可，这样在gateway中查询redis就可以查到用户登录信息已经失效了。</li>\n<li>如何在服务中获取当前登录用户信息呢？这个其实挺简单的，一般的做法就是写一个工具类，该工具类从请求的header中获取token，或者在请求阶段就讲userId设置到token中，如果只有token就讲token转换成用户信息，然后根据id从redis中获取用户详细信息，不过一般只需要userId就可以了，这边给个示例：</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> String <span class=\"hljs-title\">getUserIdByCurrent</span><span class=\"hljs-params\">()</span> </span>&#123;<br>        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder<br>                .getRequestAttributes();<br>        <span class=\"hljs-keyword\">if</span> (attributes != <span class=\"hljs-keyword\">null</span>) &#123;<br>            HttpServletRequest request = attributes.getRequest();<br>            <span class=\"hljs-keyword\">return</span> request.getHeader(ConstantsUtil.USER_ID);<br>        &#125;<span class=\"hljs-keyword\">else</span>&#123;<br>            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"\"</span>;<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>本章介绍了如何在gateway中聚合swagger文档以及统一鉴权的集成，内容其实并不多，原本打算分开两篇进行介绍的，swagger部分没有什么需要注意的原理，索性就放在一起，真正重要的点就是Spring Cloud Gateway中的filter的应用，这部分可以通过查找资料详细的了解一下，下一篇将介绍如何使用限流组件Sentinel，这个组件由alibaba提供。</p>\n<h2 id=\"源码地址\"><a href=\"#源码地址\" class=\"headerlink\" title=\"源码地址\"></a>源码地址</h2><p><a href=\"https://github.com/WinterChenS/spring-cloud-hoxton-study\" target=\"_blank\" rel=\"noopener\">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>\n<p>参考文献</p>\n<p><a href=\"https://juejin.cn/post/6844903846469189645\" target=\"_blank\" rel=\"noopener\">Spring Cloud Gateway-ServerWebExchange核心方法与请求或者响应内容的修改</a></p>\n","raw":null,"categories":[{"name":"springcloud","path":"api/categories/springcloud.json"}],"tags":[{"name":"springcloud","path":"api/tags/springcloud.json"},{"name":"gateway","path":"api/tags/gateway.json"},{"name":"Hoxton","path":"api/tags/Hoxton.json"},{"name":"swagger","path":"api/tags/swagger.json"},{"name":"knife4j","path":"api/tags/knife4j.json"},{"name":"auth","path":"api/tags/auth.json"}]}]}