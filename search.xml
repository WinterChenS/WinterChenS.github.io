<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>SpringCloud系列教程(八)之整合seata分布式事务</title>
    <url>/2021/11/09/2021-11-09-spring-cloud-hoxton-8-seata/</url>
    <content><![CDATA[<blockquote>
<p>阅读提醒：</p>
</blockquote>
<ol>
<li>本文面向的是有一定springboot基础者</li>
<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>
<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>
</ol>
<blockquote>
<p>两个月没有更新了，这次趁着刷技术文章的机会，把目前比较热门的分布式事务框架seata整合一下，分布式事务的出现是因为微服务导致业务分部在不同的服务中，不能像本地事务一样使用事务。</p>
</blockquote>
<h2 id="前情概要"><a href="#前情概要" class="headerlink" title="前情概要"></a>前情概要</h2><ul>
<li><a href="https://juejin.cn/post/6987998097209032741" target="_blank" rel="noopener">SpringCloud系列教程(一)开篇</a></li>
<li><a href="https://juejin.cn/post/6991323018802757662" target="_blank" rel="noopener">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6991635985847025671" target="_blank" rel="noopener">SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6992010061576929310" target="_blank" rel="noopener">SpringCloud系列教程(四)之SpringCloud Gateway | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6992404611617259534" target="_blank" rel="noopener">SpringCloud系列教程(五)之SpringCloud Gateway 网关聚合开发文档 swagger knife4j 和登录权限统一验证</a></li>
<li><a href="https://juejin.cn/post/6992404611617259534" target="_blank" rel="noopener">SpringCloud系列教程(六)之SpringCloud 使用sentinel作为熔断器</a></li>
<li><a href="https://juejin.cn/post/6993124554428121096" target="_blank" rel="noopener">SpringCloud系列教程(七)之使用Spring Cloud Sleuth+Zipkin实现链路追踪</a></li>
</ul>
<h2 id="什么是seata？"><a href="#什么是seata？" class="headerlink" title="什么是seata？"></a>什么是seata？</h2><p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p>
<p>关于更多的原理可以参考官方文档，这里就不赘述了：<a href="http://seata.io/zh-cn/docs/overview/what-is-seata.html" target="_blank" rel="noopener">Seata 是什么</a></p>
<h2 id="下载安装seata-server"><a href="#下载安装seata-server" class="headerlink" title="下载安装seata-server"></a>下载安装seata-server</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>下载地址：<a href="https://github.com/seata/seata/releases" target="_blank" rel="noopener">Releases · seata/seata (github.com)</a></p>
<p>window下载zip，linux/mac下载tar.gz</p>
<blockquote>
<p>注意：如何安装nacos请看这：<a href="https://nacos.io/zh-cn/docs/quick-start.html" target="_blank" rel="noopener">Nacos 快速入门</a>，建议查看前面的文章以做到丝滑入戏。</p>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>解压之后修改配置文件registry.conf（这里主要是配置nacos作为配置中心）：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><code class="hljs protobuf">config &#123;<br>  type = <span class="hljs-string">"nacos"</span> ## 这里修改为nacos，并且修改下面对应的配置<br><br>  nacos &#123;<br>    serverAddr = <span class="hljs-string">"127.0.0.1:8848"</span><br>    namespace = <span class="hljs-string">"public"</span><br>    <span class="hljs-keyword">group</span> = <span class="hljs-string">"SEATA_GROUP"</span><br>    username = <span class="hljs-string">"nacos"</span><br>    password = <span class="hljs-string">"nacos"</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后继续修改注册中心（nacos作为注册中心）：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><code class="hljs protobuf">registry &#123;<br> <br>  type = <span class="hljs-string">"nacos"</span><br><br>  nacos &#123;<br>    application = <span class="hljs-string">"seata-server"</span><br>    serverAddr = <span class="hljs-string">"127.0.0.1:8848"</span><br>    <span class="hljs-keyword">group</span> = <span class="hljs-string">"DEFAULT_GROUP"</span> #这里的<span class="hljs-keyword">group</span>需要与业务服务在一个<span class="hljs-keyword">group</span>内<br>    namespace = <span class="hljs-string">"public"</span><br>    cluster = <span class="hljs-string">"default"</span><br>    username = <span class="hljs-string">"nacos"</span><br>    password = <span class="hljs-string">"nacos"</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>本文是以nacos作为注册中心和配置中心的，如果需要其它的方式可以查看官方文档。</p>
<h3 id="上传配置"><a href="#上传配置" class="headerlink" title="上传配置"></a>上传配置</h3><p>在上传之前先下载对应的配置文件模板</p>
<ol>
<li>首先下载config.txt文件：<a href="https://github.com/seata/seata/tree/develop/script/config-center" target="_blank" rel="noopener">seata/script/config-center at develop · seata/seata (github.com)</a> ，将其放入到seata的解压目录下；见图例1</li>
<li>然后在目录下找到对应的配置中心的目录下的shell脚本，这里使用的是nacos-config.sh <a href="https://github.com/seata/seata/tree/develop/script/config-center/nacos" target="_blank" rel="noopener">seata/script/config-center/nacos at develop · seata/seata (github.com)</a>，将其放入到<code>${SEATA_DIR}/script/config-center/nacos/nacos-config.sh</code> 注意：<code>${SEATA_DIR}</code> 是seata的根目录；见图例2</li>
<li>到seata的解压根目录下运行 <code>sh script/config-center/nacos/nacos-config.sh -h 127.0.0.1 -p 8848 -g SEATA_GROUP -u nacos -w nacos</code> 注意：nacos-config.sh是第2步下载的脚本文件，见图例3</li>
</ol>
<p>图例1：</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104117.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">图例1</span></p>
<p>图例2：</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104139.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">图例2</span></p>
<p>图例3：</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104156.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">图例3</span></p>
<p>图例4：</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104216.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">图例4</span></p>
<p>在nacos控制台（localhost:8848/nacos，账密：nacos/nacos）：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104233.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>可以看到配置已经成功上传</p>
<p>具体的配置请查看：<a href="https://github.com/seata/seata/blob/develop/script/config-center/config.txt" target="_blank" rel="noopener">seata/config.txt at develop · seata/seata (github.com)</a></p>
<p>配置参数官方对照表：<a href="http://seata.io/zh-cn/docs/user/configurations.html" target="_blank" rel="noopener">Seata 参数配置</a></p>
<p>注意修改对应数据库的配置，可以直接在nacos中修改配置。</p>
<blockquote>
<p>有一个比较关键的点，也是很容易出错的点，有一个配置参数单独拿出来讲一下，<br><code>service.vgroupMapping.&lt;你的服务名称&gt;-group=default</code> 这个分组需要seata-server和client都保持一致，当然，seata是可以存在多个事务分组的，比如我们订单业务涉及到库存等等逻辑，那么将这些在同一个事务的服务加入到同一个事务分组内，就如默认的配置文件中设置为：<code>service.vgroupMapping.my_test_tx_group=default</code> 那么我们需要在服务的application.yml中配置该组：</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">my_test_tx_group</span><br></code></pre></td></tr></table></figure>

<h2 id="启动seata-server："><a href="#启动seata-server：" class="headerlink" title="启动seata-server："></a>启动seata-server：</h2><p>windows：打开控制台：<code>./seata-server.bat -h 127.0.0.1</code></p>
<p>linux/macos: <code>sh [seata-server.sh](http://seata-server.sh) -h 127.0.0.1</code></p>
<p>成功启动：</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104300.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">成功启动</span></p>
<p>nacos注册中心：</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104319.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">nacos注册中心</span></p>
<h3 id="多种部署方式："><a href="#多种部署方式：" class="headerlink" title="多种部署方式："></a>多种部署方式：</h3><ul>
<li><a href="http://seata.io/zh-cn/docs/ops/deploy-by-docker.html" target="_blank" rel="noopener">使用 Docker 部署 Seata Server</a></li>
<li><a href="http://seata.io/zh-cn/docs/ops/deploy-by-kubernetes.html" target="_blank" rel="noopener">使用 Kubernetes 部署 Seata Server</a></li>
<li><a href="http://seata.io/zh-cn/docs/ops/deploy-by-helm.html" target="_blank" rel="noopener">使用 Helm 部署 Seata Server</a></li>
<li><a href="http://seata.io/zh-cn/docs/ops/deploy-ha.html" target="_blank" rel="noopener">Seata 高可用部署</a></li>
</ul>
<h3 id="新增seata的数据表："><a href="#新增seata的数据表：" class="headerlink" title="新增seata的数据表："></a>新增seata的数据表：</h3><p>对应的sql文件请查看：<a href="https://github.com/seata/seata/tree/1.4.0/script/server/db" target="_blank" rel="noopener">seata/script/server/db at 1.4.0 · seata/seata (github.com)</a></p>
<p>下载之后在数据库中新建库：seata，然后将建库脚本导入。</p>
<h2 id="工程改造"><a href="#工程改造" class="headerlink" title="工程改造"></a>工程改造</h2><h3 id="1-复制工程"><a href="#1-复制工程" class="headerlink" title="1.复制工程"></a>1.复制工程</h3><p>将工程：spring-cloud-nacos-consumer 复制一份，改为：order-server</p>
<p>将工程：spring-cloud-nacos-provider 复制一份，改为：stock-server</p>
<p>注意：复制之后需要修改部分pom配置才可以（改为对应的名称）：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>order-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>order-server<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>并且在父pom中加入：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>    ...<br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>stock-server<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>order-server<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>然后重新导入依赖即可</p>
<p>如果还存在异常，请将.imi文件删除</p>
<h3 id="2-增加依赖"><a href="#2-增加依赖" class="headerlink" title="2.增加依赖"></a>2.增加依赖</h3><p>在两个工程模块的pom中增加依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- seata --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-修改工程的application-yml配置"><a href="#3-修改工程的application-yml配置" class="headerlink" title="3.修改工程的application.yml配置"></a>3.修改工程的application.yml配置</h3><p>order-server</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">io:</span><br>      <span class="hljs-attr">seata:</span> <span class="hljs-string">debug</span><br><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">my_test_tx_group</span><br></code></pre></td></tr></table></figure>

<p>stock-server</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">io:</span><br>      <span class="hljs-attr">seata:</span> <span class="hljs-string">debug</span><br><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">my_test_tx_group</span><br></code></pre></td></tr></table></figure>

<h3 id="4-数据库初始化"><a href="#4-数据库初始化" class="headerlink" title="4.数据库初始化"></a>4.数据库初始化</h3><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 创建 order库、业务表、undo_log表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> seata_order;<br><span class="hljs-keyword">use</span> seata_order;<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`order_tbl`</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`order_tbl`</span> (<br>  <span class="hljs-string">`id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,<br>  <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`commodity_code`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`count`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,<br>  <span class="hljs-string">`money`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>)<br>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`undo_log`</span><br>(<br>  <span class="hljs-string">`id`</span>            <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">20</span>)   <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,<br>  <span class="hljs-string">`branch_id`</span>     <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">20</span>)   <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`xid`</span>           <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`context`</span>       <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`rollback_info`</span> LONGBLOB     <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`log_status`</span>    <span class="hljs-built_in">INT</span>(<span class="hljs-number">11</span>)      <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`log_created`</span>   DATETIME     <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`log_modified`</span>  DATETIME     <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`ext`</span>           <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>),<br>  <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">KEY</span> <span class="hljs-string">`ux_undo_log`</span> (<span class="hljs-string">`xid`</span>, <span class="hljs-string">`branch_id`</span>)<br>) <span class="hljs-keyword">ENGINE</span> = <span class="hljs-keyword">InnoDB</span><br>  AUTO_INCREMENT = <span class="hljs-number">1</span><br>  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span> = utf8;<br><br><span class="hljs-comment">-- 创建 stock库、业务表、undo_log表</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> seata_stock;<br><span class="hljs-keyword">use</span> seata_stock;<br><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`stock_tbl`</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`stock_tbl`</span> (<br>  <span class="hljs-string">`id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,<br>  <span class="hljs-string">`commodity_code`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`count`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>),<br>  <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`commodity_code`</span>)<br>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`undo_log`</span><br>(<br>  <span class="hljs-string">`id`</span>            <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">20</span>)   <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,<br>  <span class="hljs-string">`branch_id`</span>     <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">20</span>)   <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`xid`</span>           <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`context`</span>       <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`rollback_info`</span> LONGBLOB     <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`log_status`</span>    <span class="hljs-built_in">INT</span>(<span class="hljs-number">11</span>)      <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`log_created`</span>   DATETIME     <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`log_modified`</span>  DATETIME     <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`ext`</span>           <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>),<br>  <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">KEY</span> <span class="hljs-string">`ux_undo_log`</span> (<span class="hljs-string">`xid`</span>, <span class="hljs-string">`branch_id`</span>)<br>) <span class="hljs-keyword">ENGINE</span> = <span class="hljs-keyword">InnoDB</span><br>  AUTO_INCREMENT = <span class="hljs-number">1</span><br>  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span> = utf8;<br><br><span class="hljs-comment">-- 初始化库存模拟数据</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> seata_stock.stock_tbl (<span class="hljs-keyword">id</span>, commodity_code, <span class="hljs-keyword">count</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'product-1'</span>, <span class="hljs-number">9999999</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> seata_stock.stock_tbl (<span class="hljs-keyword">id</span>, commodity_code, <span class="hljs-keyword">count</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">'product-2'</span>, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<h3 id="5-引入mybatis-plus"><a href="#5-引入mybatis-plus" class="headerlink" title="5.引入mybatis plus"></a>5.引入mybatis plus</h3><p>父pom引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- mybatis plus --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.3.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 提供mysql驱动 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>两个工程分别引入依赖:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- mybatis plus --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="6-order-server业务修改"><a href="#6-order-server业务修改" class="headerlink" title="6.order-server业务修改"></a>6.order-server业务修改</h3><p>新增部分类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName</span>(<span class="hljs-string">"order_tbl"</span>)<br><span class="hljs-meta">@Accessors</span>(chain = <span class="hljs-keyword">true</span>)<br><span class="hljs-meta">@Builder</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Order</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> longserialVersionUID= <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-meta">@JsonFormat</span>(shape = JsonFormat.Shape.STRING)<br>    <span class="hljs-meta">@TableId</span>(value=<span class="hljs-string">"id"</span> ,type = IdType.AUTO)<br><span class="hljs-comment">/**  */</span><br><span class="hljs-meta">@TableField</span>(<span class="hljs-string">"id"</span>)<br>    <span class="hljs-keyword">private</span> Integer id;<br><br><span class="hljs-comment">/**  */</span><br><span class="hljs-meta">@TableField</span>(<span class="hljs-string">"user_id"</span>)<br>    <span class="hljs-keyword">private</span> String userId;<br><br><span class="hljs-comment">/**  */</span><br><span class="hljs-meta">@TableField</span>(<span class="hljs-string">"commodity_code"</span>)<br>    <span class="hljs-keyword">private</span> String commodityCode;<br><br><span class="hljs-comment">/**  */</span><br><span class="hljs-meta">@TableField</span>(<span class="hljs-string">"count"</span>)<br>    <span class="hljs-keyword">private</span> Integer count;<br><br><span class="hljs-comment">/**  */</span><br><span class="hljs-meta">@TableField</span>(<span class="hljs-string">"money"</span>)<br>    <span class="hljs-keyword">private</span> BigDecimal money;<br><br>    <span class="hljs-meta">@Tolerate</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Order</span><span class="hljs-params">()</span></span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderTblMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseMapper</span>&lt;<span class="hljs-title">Order</span>&gt; </span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>mapperxml:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.winterchen.nacos.mapper.OrderTblMapper"</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>service:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderTblService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IService</span>&lt;<span class="hljs-title">Order</span>&gt; </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">placeOrder</span><span class="hljs-params">(String userId, String commodityCode, Integer count)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderTblServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceImpl</span>&lt;<span class="hljs-title">OrderTblMapper</span>, <span class="hljs-title">Order</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">OrderTblService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StockFeignClient stockFeignClient;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 下单：创建订单、减库存，涉及到两个服务</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> commodityCode</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> count</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GlobalTransactional</span><br>    <span class="hljs-meta">@Transactional</span>(rollbackFor = Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><br><span class="hljs-class">    @<span class="hljs-title">Override</span></span><br><span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">placeOrder</span>(<span class="hljs-title">String</span> <span class="hljs-title">userId</span>, <span class="hljs-title">String</span> <span class="hljs-title">commodityCode</span>, <span class="hljs-title">Integer</span> <span class="hljs-title">count</span>) </span>&#123;<br>        BigDecimal orderMoney = <span class="hljs-keyword">new</span> BigDecimal(count).multiply(<span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-number">5</span>));<br>        Order order = <span class="hljs-keyword">new</span> Order().setUserId(userId).setCommodityCode(commodityCode).setCount(count).setMoney(orderMoney);<br>        baseMapper.insert(order);<br>        stockFeignClient.deduct(commodityCode, count);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>StockFeignClient</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient</span>(name = <span class="hljs-string">"stock-server"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">StockFeignClient</span> </span>&#123;<br><br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/api/stock/deduct"</span>)<br>    <span class="hljs-function">Boolean <span class="hljs-title">deduct</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"commodityCode"</span>)</span> String commodityCode, @<span class="hljs-title">RequestParam</span><span class="hljs-params">(<span class="hljs-string">"count"</span>)</span> Integer count)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Api</span>(tags=<span class="hljs-string">"订单API"</span>)<br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/api/order"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderTblController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderTblService orderTblService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 下单：插入订单表、扣减库存，模拟回滚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/placeOrder/commit"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">placeOrderCommit</span><span class="hljs-params">()</span> </span>&#123;<br><br>        orderTblService.placeOrder(<span class="hljs-string">"1"</span>, <span class="hljs-string">"product-1"</span>, <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 下单：插入订单表、扣减库存，模拟回滚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/placeOrder/rollback"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">placeOrderRollback</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// product-2 扣库存时模拟了一个业务异常,</span><br>        orderTblService.placeOrder(<span class="hljs-string">"1"</span>, <span class="hljs-string">"product-2"</span>, <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/placeOrder"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">placeOrder</span><span class="hljs-params">(String userId, String commodityCode, Integer count)</span> </span>&#123;<br>        orderTblService.placeOrder(userId, commodityCode, count);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="7-stock-server业务修改"><a href="#7-stock-server业务修改" class="headerlink" title="7.stock-server业务修改"></a>7.stock-server业务修改</h3><p>entity:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName</span>(<span class="hljs-string">"stock_tbl"</span>)<br><span class="hljs-meta">@Accessors</span>(chain = <span class="hljs-keyword">true</span>)<br><span class="hljs-meta">@Builder</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Stock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br>	<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">1L</span>;<br>		<br>    <span class="hljs-meta">@JsonFormat</span>(shape = JsonFormat.Shape.STRING)<br>    <span class="hljs-meta">@TableId</span>(value=<span class="hljs-string">"id"</span> ,type = IdType.AUTO)<br>    <span class="hljs-comment">/**  */</span><br>    <span class="hljs-meta">@TableField</span>(<span class="hljs-string">"id"</span>)<br>    <span class="hljs-keyword">private</span> Integer id;<br><br>    <span class="hljs-comment">/**  */</span><br>    <span class="hljs-meta">@TableField</span>(<span class="hljs-string">"commodity_code"</span>)<br>    <span class="hljs-keyword">private</span> String commodityCode;<br><br>    <span class="hljs-comment">/**  */</span><br>    <span class="hljs-meta">@TableField</span>(<span class="hljs-string">"count"</span>)<br>    <span class="hljs-keyword">private</span> Integer count;<br><br>    <span class="hljs-meta">@Tolerate</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Stock</span><span class="hljs-params">()</span></span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>mapper:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">StockTblMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseMapper</span>&lt;<span class="hljs-title">Stock</span>&gt; </span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>mapperxml:</p>
<figure class="highlight"><table><tr><td class="code"><pre><code class="hljs java">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;<br>&lt;!DOCTYPE mapper PUBLIC <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;<br>&lt;mapper namespace=<span class="hljs-string">"com.winterchen.nacos.mapper.StockTblMapper"</span>&gt;<br><br>&lt;/mapper&gt;<br></code></pre></td></tr></table></figure>

<p>service:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">StockTblService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IService</span>&lt;<span class="hljs-title">Stock</span>&gt; </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">deduct</span><span class="hljs-params">(String commodityCode, <span class="hljs-keyword">int</span> count)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StockTblServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceImpl</span>&lt;<span class="hljs-title">StockTblMapper</span>, <span class="hljs-title">Stock</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">StockTblService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Transactional</span>(rollbackFor = Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><br><span class="hljs-class">    @<span class="hljs-title">Override</span></span><br><span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">deduct</span>(<span class="hljs-title">String</span> <span class="hljs-title">commodityCode</span>, <span class="hljs-title">int</span> <span class="hljs-title">count</span>) </span>&#123;<br>        <span class="hljs-keyword">if</span> (commodityCode.equals(<span class="hljs-string">"product-2"</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"异常:模拟业务异常:stock branch exception"</span>);<br>        &#125;<br><br>        QueryWrapper&lt;Stock&gt; wrapper = <span class="hljs-keyword">new</span> QueryWrapper&lt;&gt;();<br>        wrapper.setEntity(<span class="hljs-keyword">new</span> Stock().setCommodityCode(commodityCode));<br>        Stock stock = baseMapper.selectOne(wrapper);<br>        stock.setCount(stock.getCount() - count);<br><br>        baseMapper.updateById(stock);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>controller：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Api</span>(tags=<span class="hljs-string">"库存API"</span>)<br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/api/stock"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StockTblController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StockTblService stockTblService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 减库存</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> commodityCode 商品代码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> count         数量</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping</span>(path = <span class="hljs-string">"/deduct"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">deduct</span><span class="hljs-params">(String commodityCode, Integer count)</span> </span>&#123;<br>        stockTblService.deduct(commodityCode, count);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="8-修改gateway："><a href="#8-修改gateway：" class="headerlink" title="8. 修改gateway："></a>8. 修改gateway：</h3><p>修改<code>GatewayConfiguration</code></p>
<p><code>initCustomizedApis</code> 新增对<code>order-server</code>和<code>stock-server</code>的初始化</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">ApiDefinition api3 = <span class="hljs-keyword">new</span> ApiDefinition(<span class="hljs-string">"order"</span>)<br>                .setPredicateItems(<span class="hljs-keyword">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br><br>                    add(<span class="hljs-keyword">new</span> ApiPathPredicateItem().setPattern(<span class="hljs-string">"/order/**"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>        ApiDefinition api4 = <span class="hljs-keyword">new</span> ApiDefinition(<span class="hljs-string">"stock"</span>)<br>                .setPredicateItems(<span class="hljs-keyword">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br>                    add(<span class="hljs-keyword">new</span> ApiPathPredicateItem().setPattern(<span class="hljs-string">"/stock/**"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>  definitions.add(api3);<br>  definitions.add(api4);<br></code></pre></td></tr></table></figure>

<p><code>initGatewayRules</code> 新增规则</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"order"</span>)<br>                .setCount(<span class="hljs-number">10</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>)<br>        );<br>        rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"order"</span>)<br>                .setCount(<span class="hljs-number">2</span>)<br>                .setIntervalSec(<span class="hljs-number">2</span>)<br>                .setBurst(<span class="hljs-number">2</span>)<br>                .setParamItem(<span class="hljs-keyword">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_CLIENT_IP)<br>                )<br>        );<br><br>rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"stock"</span>)<br>                .setCount(<span class="hljs-number">10</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>)<br>                .setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER)<br>                .setMaxQueueingTimeoutMs(<span class="hljs-number">600</span>)<br>                .setParamItem(<span class="hljs-keyword">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_HEADER)<br>                        .setFieldName(<span class="hljs-string">"X-Sentinel-Flag"</span>)<br>                )<br>        );<br>        rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"stock"</span>)<br>                .setCount(<span class="hljs-number">1</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>)<br>                .setParamItem(<span class="hljs-keyword">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class="hljs-string">"pa"</span>)<br>                )<br>        );<br>        rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"stock"</span>)<br>                .setCount(<span class="hljs-number">2</span>)<br>                .setIntervalSec(<span class="hljs-number">30</span>)<br>                .setParamItem(<span class="hljs-keyword">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class="hljs-string">"type"</span>)<br>                        .setPattern(<span class="hljs-string">"warn"</span>)<br>                        .setMatchStrategy(SentinelGatewayConstants.PARAM_MATCH_STRATEGY_CONTAINS)<br>                )<br>        );<br><br>        rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"stock"</span>)<br>                .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_CUSTOM_API_NAME)<br>                .setCount(<span class="hljs-number">5</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>)<br>                .setParamItem(<span class="hljs-keyword">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class="hljs-string">"pn"</span>)<br>                )<br>        );<br></code></pre></td></tr></table></figure>

<p><code>appilcation.yml</code>新增对<code>order-server</code>和<code>stock-server</code>的路由配置:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">locator:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">lowerCaseServiceId:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">provider</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://winter-nacos-provider</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/provider/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span> <span class="hljs-comment">#StripPrefix=1就代表截取路径的个数为1，比如前端过来请求/test/good/1/view，匹配成功后，路由到后端的请求路径就会变成http://localhost:8888/good/1/view</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">consumer</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://winter-nacos-consumer</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/consumer/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">auth</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://auth</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/auth/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order-server</span>   <span class="hljs-string">-------新增order-server的路由规则</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order-server</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/order/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">stock-server</span>  <span class="hljs-string">---------</span> <span class="hljs-string">新增stock-server的路由规则</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://stock-server</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/stock/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure>

<h2 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h2><p>首先启动对应的服务：</p>
<ul>
<li>spring-cloud-gateway</li>
<li>spring-cloud-auth</li>
<li>order-server</li>
<li>stock-server</li>
</ul>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104335.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>然后打开swagger进行测试: <a href="http://127.0.0.1:15010/doc.html#/order-server/%E8%AE%A2%E5%8D%95API/placeOrderUsingPOST" target="_blank" rel="noopener">consumer服务</a></p>
<h3 id="测试提交："><a href="#测试提交：" class="headerlink" title="测试提交："></a>测试提交：</h3><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104403.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>订单创建成功：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104411.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>库存扣减成功：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104419.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="测试回滚："><a href="#测试回滚：" class="headerlink" title="测试回滚："></a>测试回滚：</h3><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20211109104428.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>此时数据库里面都正常回滚。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是本教程的全部内容了，seata是一款非常好用的分布式事务框架，为开发人员提供了比较简单的API，seata默认使用的是AT模式的事务，当然，可以结合自身的业务选择比较合适的分布式事务模式，具体的配置可以参考官方文档。</p>
<p>本项目的源码地址为：<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">WinterChenS/spring-cloud-hoxton-study: spring cloud hoxton release study (github.com)</a></p>
<h2 id="参考文献："><a href="#参考文献：" class="headerlink" title="参考文献："></a>参考文献：</h2><p><a href="http://seata.io/zh-cn/docs/overview/what-is-seata.html" target="_blank" rel="noopener">Seata 是什么</a></p>
<p><a href="http://seata.io/zh-cn/blog/integrate-seata-with-spring-cloud.html" target="_blank" rel="noopener">Seata（Fescar）分布式事务 整合 Spring Cloud</a></p>
]]></content>
      <categories>
        <category>springcloud</category>
      </categories>
      <tags>
        <tag>springcloud</tag>
        <tag>Hoxton</tag>
        <tag>seata</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud系列教程(七)之使用Spring Cloud Sleuth+Zipkin实现链路追踪</title>
    <url>/2021/08/06/2021-08-06-spring-cloud-hoxton-7-sleuth/</url>
    <content><![CDATA[<blockquote>
<p>阅读提醒：</p>
</blockquote>
<ol>
<li>本文面向的是有一定springboot基础者</li>
<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>
<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>
</ol>
<h2 id="前情概要"><a href="#前情概要" class="headerlink" title="前情概要"></a>前情概要</h2><ul>
<li><a href="https://juejin.cn/post/6987998097209032741" target="_blank" rel="noopener">SpringCloud系列教程(一)开篇</a></li>
<li><a href="https://juejin.cn/post/6991323018802757662" target="_blank" rel="noopener">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6991635985847025671" target="_blank" rel="noopener">SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6992010061576929310" target="_blank" rel="noopener">SpringCloud系列教程(四)之SpringCloud Gateway | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6992404611617259534" target="_blank" rel="noopener">SpringCloud系列教程(五)之SpringCloud Gateway 网关聚合开发文档 swagger knife4j 和登录权限统一验证</a></li>
<li><a href="https://juejin.cn/post/6992404611617259534" target="_blank" rel="noopener">SpringCloud系列教程(六)之SpringCloud 使用sentinel作为熔断器</a></li>
</ul>
<h2 id="全文概要"><a href="#全文概要" class="headerlink" title="全文概要"></a>全文概要</h2><ul>
<li>Sleuth快速开始</li>
<li>跟踪原理</li>
<li>与Zipkin整合</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>通过前面的学习，实际上已经搭建出一个基础的微服务架构系统来实现业务要求了。但是随着业务的的发展壮大，系统的规模也越来越大，各个业务模块之间的服务调用也越来越错综复杂，通常一个请求在后端会经过多个不同的业务模块来协同产生最后的结果，在复杂的微服务架构系统中，几乎每个请求都会形成一条复杂的分布式服务调用链路，在每条链路中任何一个业务服务出现延迟或者异常都会导致整个请求的失败。所以，对于每个请求，全链路调用的追踪越来越重要了，通过实现对于请求调用的链路追踪可以帮助我们快速的定位异常的根源以及链路中的性能瓶颈。针对分布式链路追踪，目前有许多业内常用的解决方案，比如Sleuth+Zipkin，skywalking等。本文主要是针对Sleuth+Zipkin的方案。</p>
<h2 id="Sleuth快速开始"><a href="#Sleuth快速开始" class="headerlink" title="Sleuth快速开始"></a>Sleuth快速开始</h2><blockquote>
<p>在整合Sleuth开始之前，友情提醒一下，为了顺畅的整合，建议查看前面的文章，因为依赖前面文章的工程。</p>
</blockquote>
<h3 id="工程改造"><a href="#工程改造" class="headerlink" title="工程改造"></a>工程改造</h3><p>在<code>consumer</code>，<code>provider</code>，<code>gateway</code>，<code>auth</code>四个工程中增加依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>然后依次启动四个服务，如果Hystrix和Sentinel冲突可以将<code>feign.hystrix.enable: true</code> 去除，因为接入Sentinel之后就不需要Hystrix组件来实现服务熔断，反而造成组件冲突。</p>
<p>试着请求接口：<a href="http://127.0.0.1:15010/consumer/nacos/echo/hello" target="_blank" rel="noopener">http://127.0.0.1:15010/consumer/nacos/echo/hello</a></p>
<p>可以看到控制台日志输出变了：</p>
<p>gateway:</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><code class="hljs prolog"><span class="hljs-number">2021</span><span class="hljs-number">-08</span><span class="hljs-number">-04</span> <span class="hljs-number">16</span>:<span class="hljs-number">57</span>:<span class="hljs-number">25.166</span>  <span class="hljs-symbol">INFO</span> [winter-gateway,<span class="hljs-number">88</span>a4de6d2424cedf,<span class="hljs-number">88</span>a4de6d2424cedf,false] <span class="hljs-number">23972</span> --- [ctor-http-nio<span class="hljs-number">-2</span>] c.w.gateway.filter.<span class="hljs-symbol">AuthorizeFilter</span>       : <span class="hljs-symbol">AccessToken</span>: [eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJhdXRoX3VzZXIiLCJleHAiOjE2MzAxMzUzNTQsIm5iZiI6MTYyNzU0MzM1NCwidXNlcklkIjoxMDAwMDAwMDF9.c09H4l_QW3v_ReNyec4nv-vqXtMDBlp4RRhh80RquPS1Ol_slH2k_dZ4vo_MYjCzJXKwWhZpt58UzgG6ZUfK8Q]<br><span class="hljs-number">2021</span><span class="hljs-number">-08</span><span class="hljs-number">-04</span> <span class="hljs-number">16</span>:<span class="hljs-number">57</span>:<span class="hljs-number">25.456</span>  <span class="hljs-symbol">INFO</span> [winter-gateway,<span class="hljs-number">88</span>a4de6d2424cedf,<span class="hljs-number">88</span>a4de6d2424cedf,false] <span class="hljs-number">23972</span> --- [ctor-http-nio<span class="hljs-number">-2</span>] c.w.gateway.filter.<span class="hljs-symbol">AuthorizeFilter</span>       : claims is:&#123;sub=auth_user, exp=<span class="hljs-number">1630135354</span>, nbf=<span class="hljs-number">1627543354</span>, userId=<span class="hljs-number">100000001</span>&#125;<br><span class="hljs-number">2021</span><span class="hljs-number">-08</span><span class="hljs-number">-04</span> <span class="hljs-number">16</span>:<span class="hljs-number">57</span>:<span class="hljs-number">25.457</span>  <span class="hljs-symbol">INFO</span> [winter-gateway,<span class="hljs-number">88</span>a4de6d2424cedf,<span class="hljs-number">88</span>a4de6d2424cedf,false] <span class="hljs-number">23972</span> --- [ctor-http-nio<span class="hljs-number">-2</span>] c.w.gateway.filter.<span class="hljs-symbol">AuthorizeFilter</span>       : userId:<span class="hljs-number">100000001</span><br></code></pre></td></tr></table></figure>

<p>consumer:</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><code class="hljs prolog"><span class="hljs-number">2021</span><span class="hljs-number">-08</span><span class="hljs-number">-04</span> <span class="hljs-number">16</span>:<span class="hljs-number">57</span>:<span class="hljs-number">26.566</span>  <span class="hljs-symbol">INFO</span> [winter-nacos-consumer,<span class="hljs-number">88</span>a4de6d2424cedf,<span class="hljs-number">1170003686062</span>d81,false] <span class="hljs-number">26520</span> --- [io<span class="hljs-number">-16011</span>-exec<span class="hljs-number">-1</span>] com.alibaba.nacos.client.naming          : new ips(<span class="hljs-number">1</span>) service: <span class="hljs-symbol">DEFAULT_GROUP</span>@@winter-nacos-provider -&gt; [&#123;<span class="hljs-string">"clusterName"</span>:<span class="hljs-string">"DEFAULT"</span>,<span class="hljs-string">"enabled"</span>:true,<span class="hljs-string">"ephemeral"</span>:true,<span class="hljs-string">"healthy"</span>:true,<span class="hljs-string">"instanceHeartBeatInterval"</span>:<span class="hljs-number">5000</span>,<span class="hljs-string">"instanceHeartBeatTimeOut"</span>:<span class="hljs-number">15000</span>,<span class="hljs-string">"instanceId"</span>:<span class="hljs-string">"10.1.18.76#16012#DEFAULT#DEFAULT_GROUP@@winter-nacos-provider"</span>,<span class="hljs-string">"ip"</span>:<span class="hljs-string">"10.1.18.76"</span>,<span class="hljs-string">"ipDeleteTimeout"</span>:<span class="hljs-number">30000</span>,<span class="hljs-string">"metadata"</span>:&#123;<span class="hljs-string">"preserved.register.source"</span>:<span class="hljs-string">"SPRING_CLOUD"</span>&#125;,<span class="hljs-string">"port"</span>:<span class="hljs-number">16012</span>,<span class="hljs-string">"serviceName"</span>:<span class="hljs-string">"DEFAULT_GROUP@@winter-nacos-provider"</span>,<span class="hljs-string">"weight"</span>:<span class="hljs-number">1.0</span>&#125;]<br></code></pre></td></tr></table></figure>

<p>从上面的控制台输出内容 中 ， 我 们可 以看到多了一些形如［[winter-gateway,88a4de6d2424cedf,88a4de6d2424cedf,false]的日志信息， 而这些元素正是实现分布式服务跟踪的重要组成部分，每个值的含义如下所述。</p>
<ul>
<li>第一 个值： <code>winter-gateway</code>, 它记录了应用的名称，也就是 <code>application.properties</code>中 <code>spring.application.name</code>参数配置的属性。</li>
<li>第二个值： <code>88a4de6d2424cedf</code>, <code>Spring Cloud Sleuth</code>生成的 一 个<code>ID</code>,称为<code>Trace ID</code>,它用来标识 一 条请求链路。一 条请求链路中包含 一 个<code>TraceID</code>, 多个<code>SpanID</code>。</li>
<li>第三个值： <code>88a4de6d2424cedf</code>, <code>Spring Cloud Sleuth</code>生成的另外 一 个<code>ID</code>, 称为<code>Span ID</code>, 它表示 一 个基本的工作单元， 比如发送 一 个HTTP请求。</li>
<li>第四个值： <code>false</code>, 表示是否要将该信息输出到<code>Zipkin</code>等服务中来收集和展示 。</li>
</ul>
<p>上面四个值中的<code>TraceID</code>和<code>SpanID</code>是<code>Spring Cloud Sleuth</code>实现分布式服务跟踪的核心。 在 一 次服务请求链路的调用过程中， 会保待并传递同 一 个<code>Trace ID</code>, 从而将整个分布于不同微服务进程中的请求跟踪信息串联起来。 以上面输出内容为例， <code>winter-gateway</code> 和 <code>winter-nacos-consumer</code>同属于 一 个前端服务请求来源，所以它们的TraceID是相同的，处于同 一 条请求链路中。</p>
<h3 id="跟踪原理"><a href="#跟踪原理" class="headerlink" title="跟踪原理:"></a>跟踪原理:</h3><p>分布式系统中的服务跟踪在理论上并不复杂， 它主要包括下面两个关键点。</p>
<ul>
<li>为了实现请求跟踪， 当请求发送到分布式系统的入口端点时， 只需要服务跟踪框架为该请求创建 一 个唯 一 的跟踪标识， 同时在分布式系统内部流转的时候，框架始终保待传递 该唯 一 标识， 直到返回给请求方为止， 这个唯 一 标识就是前文中提到的Trace ID。 通过TraceID的记录， 我们就能将所有请求过程的日志关联起来。</li>
<li>为了统计各处理单元的时间延迟， 当请求到达各个服务组件时， 或是处理逻辑到达某个状态时，也通过 一 个唯 一 标识来标记它的开始、 具体过程以及结束， 该标识就是前文中提到的SpanID。 对于每个Span来说， 它必须有开始和结束 两个节点， 通过记录开始 Span和结束Span的时间戳，就能统计出该Span的时间延迟，除了时间戳记录之外，它还可以包含 一 些其他元数据， 比如事件名称、 请求信息等。</li>
</ul>
<h2 id="与Zipkin整合"><a href="#与Zipkin整合" class="headerlink" title="与Zipkin整合"></a>与Zipkin整合</h2><h2 id="Zipkin安装"><a href="#Zipkin安装" class="headerlink" title="Zipkin安装"></a>Zipkin安装</h2><p>普通安装：</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><code class="hljs prolog">curl -sSL https://zipkin.io/quickstart.sh | bash -s<br>java -jar zipkin.jar<br></code></pre></td></tr></table></figure>

<p>docker-compose启动：</p>
<p>docker-compose.yml:</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><code class="hljs prolog">version: <span class="hljs-string">'2'</span><br><br>services:<br>  zipkin:<br>    image: openzipkin/zipkin<br>    container_name: zipkin<br>    environment:<br>      - <span class="hljs-symbol">STORAGE_TYPE</span>=mysql<br>      - <span class="hljs-symbol">MYSQL_DB</span>=zipkin<br>      - <span class="hljs-symbol">MYSQL_USER</span>=root<br>      - <span class="hljs-symbol">MYSQL_PASS</span>=root<br>      - <span class="hljs-symbol">MYSQL_HOST</span>=<span class="hljs-number">172.26</span><span class="hljs-number">.208</span><span class="hljs-number">.1</span><br>      - <span class="hljs-symbol">MYSQL_TCP_PORT</span>=<span class="hljs-number">3306</span><br>    ports:<br>      - <span class="hljs-number">9411</span>:<span class="hljs-number">9411</span><br></code></pre></td></tr></table></figure>

<p>同时支持多种数据存储方式，比如es\mysql等，更多收集数据和存储方式见：<a href="https://github.com/openzipkin/zipkin/tree/master/zipkin-server" target="_blank" rel="noopener">https://github.com/openzipkin/zipkin/tree/master/zipkin-server</a></p>
<p><strong>如果使用mysql</strong>需要新建库和表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> zipkin_spans (<br>  <span class="hljs-string">`trace_id_high`</span> <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit'</span>,<br>  <span class="hljs-string">`trace_id`</span> <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`id`</span> <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`name`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`remote_service_name`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),<br>  <span class="hljs-string">`parent_id`</span> <span class="hljs-built_in">BIGINT</span>,<br>  <span class="hljs-string">`debug`</span> <span class="hljs-built_in">BIT</span>(<span class="hljs-number">1</span>),<br>  <span class="hljs-string">`start_ts`</span> <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'Span.timestamp(): epoch micros used for endTs query and to implement TTL'</span>,<br>  <span class="hljs-string">`duration`</span> <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'Span.duration(): micros used for minDuration and maxDuration query'</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`trace_id_high`</span>, <span class="hljs-string">`trace_id`</span>, <span class="hljs-string">`id`</span>)<br>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> ROW_FORMAT=COMPRESSED <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span>=utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci;<br><br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> zipkin_spans <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span>(<span class="hljs-string">`trace_id_high`</span>, <span class="hljs-string">`trace_id`</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'for getTracesByIds'</span>;<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> zipkin_spans <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span>(<span class="hljs-string">`name`</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'for getTraces and getSpanNames'</span>;<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> zipkin_spans <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span>(<span class="hljs-string">`remote_service_name`</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'for getTraces and getRemoteServiceNames'</span>;<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> zipkin_spans <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span>(<span class="hljs-string">`start_ts`</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'for getTraces ordering and range'</span>;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> zipkin_annotations (<br>  <span class="hljs-string">`trace_id_high`</span> <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit'</span>,<br>  <span class="hljs-string">`trace_id`</span> <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'coincides with zipkin_spans.trace_id'</span>,<br>  <span class="hljs-string">`span_id`</span> <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'coincides with zipkin_spans.id'</span>,<br>  <span class="hljs-string">`a_key`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'BinaryAnnotation.key or Annotation.value if type == -1'</span>,<br>  <span class="hljs-string">`a_value`</span> <span class="hljs-built_in">BLOB</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'BinaryAnnotation.value(), which must be smaller than 64KB'</span>,<br>  <span class="hljs-string">`a_type`</span> <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'BinaryAnnotation.type() or -1 if Annotation'</span>,<br>  <span class="hljs-string">`a_timestamp`</span> <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'Used to implement TTL; Annotation.timestamp or zipkin_spans.timestamp'</span>,<br>  <span class="hljs-string">`endpoint_ipv4`</span> <span class="hljs-built_in">INT</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'Null when Binary/Annotation.endpoint is null'</span>,<br>  <span class="hljs-string">`endpoint_ipv6`</span> <span class="hljs-built_in">BINARY</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'Null when Binary/Annotation.endpoint is null, or no IPv6 address'</span>,<br>  <span class="hljs-string">`endpoint_port`</span> <span class="hljs-built_in">SMALLINT</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'Null when Binary/Annotation.endpoint is null'</span>,<br>  <span class="hljs-string">`endpoint_service_name`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'Null when Binary/Annotation.endpoint is null'</span><br>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> ROW_FORMAT=COMPRESSED <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span>=utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci;<br><br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> zipkin_annotations <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">KEY</span>(<span class="hljs-string">`trace_id_high`</span>, <span class="hljs-string">`trace_id`</span>, <span class="hljs-string">`span_id`</span>, <span class="hljs-string">`a_key`</span>, <span class="hljs-string">`a_timestamp`</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'Ignore insert on duplicate'</span>;<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> zipkin_annotations <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span>(<span class="hljs-string">`trace_id_high`</span>, <span class="hljs-string">`trace_id`</span>, <span class="hljs-string">`span_id`</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'for joining with zipkin_spans'</span>;<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> zipkin_annotations <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span>(<span class="hljs-string">`trace_id_high`</span>, <span class="hljs-string">`trace_id`</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'for getTraces/ByIds'</span>;<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> zipkin_annotations <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span>(<span class="hljs-string">`endpoint_service_name`</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'for getTraces and getServiceNames'</span>;<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> zipkin_annotations <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span>(<span class="hljs-string">`a_type`</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'for getTraces and autocomplete values'</span>;<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> zipkin_annotations <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span>(<span class="hljs-string">`a_key`</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'for getTraces and autocomplete values'</span>;<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> zipkin_annotations <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">INDEX</span>(<span class="hljs-string">`trace_id`</span>, <span class="hljs-string">`span_id`</span>, <span class="hljs-string">`a_key`</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'for dependencies job'</span>;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> zipkin_dependencies (<br>  <span class="hljs-string">`day`</span> <span class="hljs-built_in">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`parent`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`child`</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`call_count`</span> <span class="hljs-built_in">BIGINT</span>,<br>  <span class="hljs-string">`error_count`</span> <span class="hljs-built_in">BIGINT</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`day`</span>, <span class="hljs-string">`parent`</span>, <span class="hljs-string">`child`</span>)<br>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> ROW_FORMAT=COMPRESSED <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span>=utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci;<br></code></pre></td></tr></table></figure>

<p>访问控制台：<a href="http://127.0.0.1:9411/" target="_blank" rel="noopener">http://127.0.0.1:9411</a></p>
<h3 id="修改工程"><a href="#修改工程" class="headerlink" title="修改工程"></a>修改工程</h3><p>在<code>consumer</code>，<code>provider</code>，<code>gateway</code>，<code>auth</code>四个工程中增加依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-sleuth-zipkin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>四个工程分别修改配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">zipkin:</span><br>    <span class="hljs-attr">sender:</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">web</span><br>    <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:9411/</span><br>    <span class="hljs-attr">service:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">consumer</span> <span class="hljs-comment"># 这里根据spring.application.name相同即可</span><br></code></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>分别启动四个工程<code>consumer</code>，<code>provider</code>，<code>gateway</code>，<code>auth</code> 然后浏览器访问：<a href="http://127.0.0.1:15010/consumer/nacos/feign-test/hello" target="_blank" rel="noopener">http://127.0.0.1:15010/consumer/nacos/feign-test/hello</a></p>
<p>访问：<a href="http://127.0.0.1:9411/" target="_blank" rel="noopener">http://127.0.0.1:9411/</a>  点击Run Query 即可查询到链路追踪数据：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210806092410.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p> 随便点击一个SHOW查看链路详细信息：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210806092422.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>可以看到整个请求链路的过程关系，以及请求的耗时等信息。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在复杂的微服务架构中，服务之间的链路追踪也是至关重要的，可以帮助定位服务的异常和性能瓶颈，除了Sleuth+Zipkin还可以使用其他的一些解决方案。</p>
<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">GitHub - WinterChenS/spring-cloud-hoxton-study: spring cloud hoxton release study</a></p>
<p>参考文献</p>
<p><a href="https://forezp.blog.csdn.net/article/details/115632914" target="_blank" rel="noopener">https://forezp.blog.csdn.net/article/details/115632914</a></p>
<p><a href="https://www.cnblogs.com/wuzhenzhao/p/12762976.html" target="_blank" rel="noopener">https://www.cnblogs.com/wuzhenzhao/p/12762976.html</a></p>
]]></content>
      <categories>
        <category>springcloud</category>
      </categories>
      <tags>
        <tag>springcloud</tag>
        <tag>Hoxton</tag>
        <tag>Sleuth</tag>
        <tag>Zipkin</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud系列教程(六)之SpringCloud 使用sentinel作为熔断器</title>
    <url>/2021/08/05/2021-08-05-spring-cloud-hoxton-6-sentinel/</url>
    <content><![CDATA[<blockquote>
<p>阅读提醒：</p>
</blockquote>
<ol>
<li>本文面向的是有一定springboot基础者</li>
<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>
<li>由于knife4j比swagger更加友好，所以本文集成knife4j</li>
<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>
</ol>
<h2 id="前情概要"><a href="#前情概要" class="headerlink" title="前情概要"></a>前情概要</h2><ul>
<li><a href="https://juejin.cn/post/6987998097209032741" target="_blank" rel="noopener">SpringCloud系列教程(一)开篇</a></li>
<li><a href="https://juejin.cn/post/6991323018802757662" target="_blank" rel="noopener">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6991635985847025671" target="_blank" rel="noopener">SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6992010061576929310" target="_blank" rel="noopener">SpringCloud系列教程(四)之SpringCloud Gateway | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6992404611617259534" target="_blank" rel="noopener">SpringCloud系列教程(五)之SpringCloud Gateway 网关聚合开发文档 swagger knife4j 和登录权限统一验证</a></li>
</ul>
<h2 id="本文概览"><a href="#本文概览" class="headerlink" title="本文概览"></a>本文概览</h2><ul>
<li>什么是熔断器</li>
<li>什么是sentinel</li>
<li>spring cloud 整合sentinel</li>
<li>实际的应用场景</li>
</ul>
<h2 id="什么是熔断器"><a href="#什么是熔断器" class="headerlink" title="什么是熔断器"></a>什么是熔断器</h2><p>想必大家都知道一个生活中常见的物件，保险丝，其实它就是一种熔断器，当电器出现短路故障导致瞬间电流超过瞬间值会触发熔断，导致断开电路，从而保护了整个电路和电器的安全。</p>
<p><strong>熔断器（fuse）</strong>是指当电流超过规定值时，以本身产生的热量使熔体熔断，断开电路的一种电器。熔断器是根据电流超过规定值一段时间后，以其自身产生的热量使熔体熔化，从而使电路断开；运用这种原理制成的一种电流保护器。熔断器广泛应用于高低压配电系统和控制系统以及用电设备中，作为短路和过电流的保护器，是应用最普遍的保护器件之一。</p>
<p>可能就有同学要问了，这个跟我们说的服务的熔断器有什么关系呢？其实很多原理性的事物都跟生活息息相关的，电路的熔断，保护电路和电器。在代码的世界里，可以对服务起到流量控制和降级熔断的能力，可以做到部分服务的宕机不会导致整个服务集群的雪崩。</p>
<h2 id="什么是sentinel"><a href="#什么是sentinel" class="headerlink" title="什么是sentinel"></a>什么是sentinel</h2><p>sentinel是阿里巴巴开源的服务治理的框架，sentinel中文译名为哨兵，是为微服务提供流量控制、熔断降级的功能，它和Hystrix提供的功能一样，可以有效的解决微服务调用产生的“雪崩”效应，为微服务系统提供了稳定性的解决方案。</p>
<p>随着Hytrxi进入了维护期，不再提供新功能，Sentinel是一个不错的替代方案。通常情况，Hystrix采用线程池对服务的调用进行隔离，Sentinel才用了用户线程对接口进行隔离，二者相比，Hystrxi是服务级别的隔离，Sentinel提供了接口级别的隔离，Sentinel隔离级别更加精细，另外Sentinel直接使用用户线程进行限制，相比Hystrix的线程池隔离，减少了线程切换的开销。另外Sentinel的DashBoard提供了在线更改限流规则的配置，也更加的优化。</p>
<p>通过官方文档的介绍，sentinel有以下特征：</p>
<ul>
<li>丰富的应用场景： Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、实时熔断下游不可用应用等。</li>
<li>完备的实时监控： Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li>
<li>广泛的开源生态： Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</li>
<li>完善的 SPI 扩展点： Sentinel 提供简单易用、完善的 SPI 扩展点。您可以通过实现扩展点，快速的定制逻辑。例如定制规则管理、适配数据源等。</li>
</ul>
<p>Sentinel的主要特性：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095331.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="Sentinel-功能和设计理念"><a href="#Sentinel-功能和设计理念" class="headerlink" title="Sentinel 功能和设计理念"></a>Sentinel 功能和设计理念</h3><p><strong>流量控制</strong></p>
<p>流量控制在网络传输中是一个常用的概念，它用于调整网络包的发送数据。然而，从系统稳定性角度考虑，在处理请求的速度上，也有非常多的讲究。任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。Sentinel 作为一个调配器，可以根据需要把随机的请求调整成合适的形状，如下图所示：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095541.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>流量控制有以下几个角度:</p>
<ul>
<li>资源的调用关系，例如资源的调用链路，资源和资源之间的关系；</li>
<li>运行指标，例如 QPS、线程池、系统负载等；</li>
<li>控制的效果，例如直接限流、冷启动、排队等。</li>
</ul>
<p>Sentinel 的设计理念是让您自由选择控制的角度，并进行灵活组合，从而达到想要的效果。</p>
<h3 id="熔断降级"><a href="#熔断降级" class="headerlink" title="熔断降级"></a>熔断降级</h3><p>除了流量控制以外，降低调用链路中的不稳定资源也是 Sentinel 的使命之一。由于调用关系的复杂性，如果调用链路中的某个资源出现了不稳定，最终会导致请求发生堆积。这个问题和 <a href="https://github.com/Netflix/Hystrix/wiki#what-problem-does-hystrix-solve" target="_blank" rel="noopener">Hystrix</a> 里面描述的问题是一样的。</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095642.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>Sentinel 和 Hystrix 的原则是一致的: 当调用链路中某个资源出现不稳定，例如，表现为 timeout，异常比例升高的时候，则对这个资源的调用进行限制，并让请求快速失败，避免影响到其它的资源，最终产生雪崩的效果。</p>
<h3 id="Sentinel-是如何工作的"><a href="#Sentinel-是如何工作的" class="headerlink" title="Sentinel 是如何工作的"></a>Sentinel 是如何工作的</h3><p>Sentinel 的主要工作机制如下：</p>
<ul>
<li>对主流框架提供适配或者显示的 API，来定义需要保护的资源，并提供设施对资源进行实时统计和调用链路分析。</li>
<li>根据预设的规则，结合对资源的实时统计信息，对流量进行控制。同时，Sentinel 提供开放的接口，方便您定义及改变规则。</li>
<li>Sentinel 提供实时的监控系统，方便您快速了解目前系统的状态。</li>
</ul>
<h2 id="Spring-Cloud-整合-Sentinel"><a href="#Spring-Cloud-整合-Sentinel" class="headerlink" title="Spring Cloud 整合 Sentinel"></a>Spring Cloud 整合 Sentinel</h2><blockquote>
<p>注意：本文整合的工程是基于前几篇文章提供的，所以需要根据前几篇的内容一步步的搭建</p>
</blockquote>
<h3 id="下载安装sentinel-dashboard"><a href="#下载安装sentinel-dashboard" class="headerlink" title="下载安装sentinel dashboard"></a>下载安装sentinel dashboard</h3><p>从官方的github仓库下载最新的release版本：<a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/releases</a></p>
<p>下载完之后启动服务，端口为8748，启动命令如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">java -Dserver.port=<span class="hljs-number">8748</span> -Dcsp.sentinel.dashboard.server=localhost:<span class="hljs-number">8748</span> -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-<span class="hljs-number">1.8</span><span class="hljs-number">.2</span>.jar<br></code></pre></td></tr></table></figure>

<p>启动完之后登录控制台：<a href="http://localhost:8748/" target="_blank" rel="noopener">http://localhost:8748</a></p>
<p>账号：sentinel   密码:   sentinel</p>
<h3 id="改造工程consumer"><a href="#改造工程consumer" class="headerlink" title="改造工程consumer"></a>改造工程consumer</h3><p>增加maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>修改配置<code>application.yml</code>(只显示部分需要修改的配置)：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">18763</span>  <span class="hljs-comment">#1</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8748</span><br><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">sentinel:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#2</span><br></code></pre></td></tr></table></figure>

<ol>
<li>这里的 <code>spring.cloud.sentinel.transport.port</code> 端口配置会在应用对应的机器上启动一个 Http Server，该 Server 会与 Sentinel 控制台做交互。比如 Sentinel 控制台添加了一个限流规则，会把规则数据 push 给这个 Http Server 接收，Http Server 再将规则注册到 Sentinel 中。</li>
<li>通过<code>feign.sentinel.enable</code>开启Feign和sentinel的自动适配。</li>
</ol>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>分别启动provider/consumer/gateway服务，然后<strong>多次请求</strong>: <a href="http://localhost:16011/nacos/feign-test/hello" target="_blank" rel="noopener">http://localhost:16011/nacos/feign-test/hello</a></p>
<blockquote>
<p>注意：需要请求接口之后才可以在控制台看到对应的服务和接口。</p>
</blockquote>
<p>打开控制台可以看到：</p>
<p>实时监控：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095343.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>簇点链路：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095425.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>增加流控规则</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095437.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>可以通过修改后面的一些控制来限制接口的一些功能，大家可以改一改尝试一下，这里就不赘述了。</p>
<blockquote>
<p>可以给其他的服务：provider和auth也按照上面的步骤进行配置。</p>
</blockquote>
<h3 id="Spring-Cloud-Gateway使用Sentinel"><a href="#Spring-Cloud-Gateway使用Sentinel" class="headerlink" title="Spring Cloud Gateway使用Sentinel"></a>Spring Cloud Gateway使用Sentinel</h3><p>在工程 gateway中修改</p>
<p>增加maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-sentinel-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>修改<code>application.yml</code>配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>     <span class="hljs-attr">transport:</span><br>       <span class="hljs-attr">port:</span> <span class="hljs-number">15000</span><br>       <span class="hljs-attr">dashboard:</span> <span class="hljs-string">localhost:8748</span><br></code></pre></td></tr></table></figure>

<p>创建一个网关分组和网关的限流规则：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GatewayConfiguration</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;ViewResolver&gt; viewResolvers;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ServerCodecConfigurer serverCodecConfigurer;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GatewayConfiguration</span><span class="hljs-params">(ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider,</span></span><br><span class="hljs-function"><span class="hljs-params">                                ServerCodecConfigurer serverCodecConfigurer)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);<br>        <span class="hljs-keyword">this</span>.serverCodecConfigurer = serverCodecConfigurer;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Order</span>(Ordered.HIGHEST_PRECEDENCE)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> SentinelGatewayBlockExceptionHandler <span class="hljs-title">sentinelGatewayBlockExceptionHandler</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// Register the block exception handler for Spring Cloud Gateway.</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);<br>    &#125;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doInit</span><span class="hljs-params">()</span> </span>&#123;<br>        initCustomizedApis();<br>        initGatewayRules();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initCustomizedApis</span><span class="hljs-params">()</span> </span>&#123;<br>        Set&lt;ApiDefinition&gt; definitions = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();<br>        ApiDefinition api1 = <span class="hljs-keyword">new</span> ApiDefinition(<span class="hljs-string">"consumer"</span>)<br>                .setPredicateItems(<span class="hljs-keyword">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br><br>                    add(<span class="hljs-keyword">new</span> ApiPathPredicateItem().setPattern(<span class="hljs-string">"/consumer/**"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>        ApiDefinition api2 = <span class="hljs-keyword">new</span> ApiDefinition(<span class="hljs-string">"provider"</span>)<br>                .setPredicateItems(<span class="hljs-keyword">new</span> HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;<br>                    add(<span class="hljs-keyword">new</span> ApiPathPredicateItem().setPattern(<span class="hljs-string">"/provider/**"</span>)<br>                            .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));<br>                &#125;&#125;);<br>        definitions.add(api1);<br>        definitions.add(api2);<br>        GatewayApiDefinitionManager.loadApiDefinitions(definitions);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initGatewayRules</span><span class="hljs-params">()</span> </span>&#123;<br>        Set&lt;GatewayFlowRule&gt; rules = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();<br>        rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"consumer"</span>)<br>                .setCount(<span class="hljs-number">10</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>)<br>        );<br>        rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"consumer"</span>)<br>                .setCount(<span class="hljs-number">2</span>)<br>                .setIntervalSec(<span class="hljs-number">2</span>)<br>                .setBurst(<span class="hljs-number">2</span>)<br>                .setParamItem(<span class="hljs-keyword">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_CLIENT_IP)<br>                )<br>        );<br>        rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"provider"</span>)<br>                .setCount(<span class="hljs-number">10</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>)<br>                .setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER)<br>                .setMaxQueueingTimeoutMs(<span class="hljs-number">600</span>)<br>                .setParamItem(<span class="hljs-keyword">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_HEADER)<br>                        .setFieldName(<span class="hljs-string">"X-Sentinel-Flag"</span>)<br>                )<br>        );<br>        rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"provider"</span>)<br>                .setCount(<span class="hljs-number">1</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>)<br>                .setParamItem(<span class="hljs-keyword">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class="hljs-string">"pa"</span>)<br>                )<br>        );<br>        rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"provider"</span>)<br>                .setCount(<span class="hljs-number">2</span>)<br>                .setIntervalSec(<span class="hljs-number">30</span>)<br>                .setParamItem(<span class="hljs-keyword">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class="hljs-string">"type"</span>)<br>                        .setPattern(<span class="hljs-string">"warn"</span>)<br>                        .setMatchStrategy(SentinelGatewayConstants.PARAM_MATCH_STRATEGY_CONTAINS)<br>                )<br>        );<br><br>        rules.add(<span class="hljs-keyword">new</span> GatewayFlowRule(<span class="hljs-string">"provider"</span>)<br>                .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_CUSTOM_API_NAME)<br>                .setCount(<span class="hljs-number">5</span>)<br>                .setIntervalSec(<span class="hljs-number">1</span>)<br>                .setParamItem(<span class="hljs-keyword">new</span> GatewayParamFlowItem()<br>                        .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)<br>                        .setFieldName(<span class="hljs-string">"pn"</span>)<br>                )<br>        );<br>        GatewayRuleManager.loadRules(rules);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>通过上面的配置gateway已经成功整合了Sentinel，然后我们可以通过请求接口：<a href="http://127.0.0.1:15010/consumer/nacos" target="_blank" rel="noopener">http://127.0.0.1:15010/consumer/nacos</a>  </p>
<p>正常的结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">&#123;<br><span class="hljs-string">"code"</span>: <span class="hljs-number">401</span>,<br><span class="hljs-string">"message"</span>: <span class="hljs-string">"未登录"</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里返回的结果是因为之前gateway做了登录权限的校验，可以通过auth服务登录之后，将header中的token值作为请求的header中的token，就可以得到正确的返回值，对于当前的测试这个都是无关紧要的，可以通过查看前面的教程知道前因后果。</p>
<p>通过修改限流：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210805095453.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>多次点击可以得到异常信息:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">Blocked by Sentinel: FlowException<br></code></pre></td></tr></table></figure>

<p>这样就可以通过网关层进行统一的接口流量控制，当然Sentinel的作用不止于此，大家可以通过其他的功能掌握对于接口的控制。</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>通过接口的限流和熔断可以让微服务中的模块可以更加的稳定，当大量流量来袭的时候也丝毫不慌。</p>
<p>除了一些比较极端的比如秒杀抢购抢券等功能，在流量比较大的应用中也是广泛的使用。</p>
<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>
<p>参考文献</p>
<p><a href="https://sentinelguard.io/zh-cn/docs/introduction.html" target="_blank" rel="noopener">introduction</a></p>
<p><a href="https://forezp.blog.csdn.net/article/details/115632888" target="_blank" rel="noopener">SpringCloud 2020版本教程3：使用sentinel作为熔断器_方志朋的专栏-CSDN博客</a></p>
]]></content>
      <categories>
        <category>springcloud</category>
      </categories>
      <tags>
        <tag>springcloud</tag>
        <tag>Hoxton</tag>
        <tag>Sentinel</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud系列教程(五)之SpringCloud Gateway 网关聚合开发文档 swagger knife4j 和登录权限统一验证</title>
    <url>/2021/08/04/2021-08-04-spring-cloud-hoxton-5-swagger/</url>
    <content><![CDATA[<blockquote>
<p>阅读提醒：</p>
</blockquote>
<ol>
<li>本文面向的是有一定springboot基础者</li>
<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>
<li>由于knife4j比swagger更加友好，所以本文集成knife4j</li>
<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>
</ol>
<h2 id="前情概要"><a href="#前情概要" class="headerlink" title="前情概要"></a>前情概要</h2><ul>
<li><a href="https://juejin.cn/post/6987998097209032741" target="_blank" rel="noopener" title="https://juejin.cn/post/6987998097209032741">SpringCloud系列教程(一)开篇</a></li>
<li><a href="https://juejin.cn/post/6991323018802757662" target="_blank" rel="noopener" title="https://juejin.cn/post/6991323018802757662">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6991635985847025671" target="_blank" rel="noopener" title="https://juejin.cn/post/6991635985847025671"># SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6992010061576929310" target="_blank" rel="noopener">SpringCloud系列教程(四)之SpringCloud Gateway | 8月更文挑战</a></li>
</ul>
<h2 id="本文概览"><a href="#本文概览" class="headerlink" title="本文概览"></a>本文概览</h2><ul>
<li>Spring Cloud Gateway集成Knife4j</li>
<li>Spring Cloud Gateway集成登录权限统一校验</li>
</ul>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>上篇文章介绍了Spring Cloud Gateway的使用，本文将介绍如何在网关层聚合swagger文档，聚合之后可以非常方便的对开发文档进行管理，也是业界比较常用的方式。</p>
<p>首先在<strong>父pom</strong>文件<code>dependencyManagement</code> 节点中增加knife4j的依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="配置-spring-cloud-nacos-provider和spring-cloud-nacos-consumer"><a href="#配置-spring-cloud-nacos-provider和spring-cloud-nacos-consumer" class="headerlink" title="配置 spring-cloud-nacos-provider和spring-cloud-nacos-consumer"></a>配置 spring-cloud-nacos-provider和spring-cloud-nacos-consumer</h2><blockquote>
<p>注意，这里标题中两个工程为前几篇文章中构建的，如果不想看前几篇文章，就创建两个模块然后分别集成nacos，knife4j即可。</p>
</blockquote>
<p>在两个模块中分别增加maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在两个模块中分别新增配置类：<code>Knife4jConfiguration</code> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Knife4jConfiguration</span> </span>&#123;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;swagger.enable:true&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> enableSwagger;<br><br>    <span class="hljs-meta">@Bean</span>(value = <span class="hljs-string">"defaultApi2"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Docket <span class="hljs-title">createRestApi</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Docket(DocumentationType.SWAGGER_2)<br>                .apiInfo(<span class="hljs-keyword">new</span> ApiInfoBuilder()<br>                            .title(<span class="hljs-string">"provider服务"</span>)<br>                            .version(<span class="hljs-string">"1.0"</span>)<br>                            .build())<br>                .enable(enableSwagger)<br>                .select()<br>                .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">"com.winterchen.nacos.rest"</span>))<br>                .paths(PathSelectors.any())<br>                .build();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意有些相关的信息需要修改。</p>
<p>新增配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">swagger:</span><br>    <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h2 id="配置-spring-cloud-gateway"><a href="#配置-spring-cloud-gateway" class="headerlink" title="配置 spring-cloud-gateway"></a>配置 spring-cloud-gateway</h2><p>接下来是重头戏，如何在Spring Cloud Gateway中聚合swagger文档。</p>
<p>首先在pom中增加maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>新增Swagger的配置类：<code>SwaggerResourceConfig</code> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Primary</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SwaggerResourceConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SwaggerResourcesProvider</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RouteLocator routeLocator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> GatewayProperties gatewayProperties;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SwaggerResourceConfig</span><span class="hljs-params">(RouteLocator routeLocator, GatewayProperties gatewayProperties)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.routeLocator = routeLocator;<br>        <span class="hljs-keyword">this</span>.gatewayProperties = gatewayProperties;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;SwaggerResource&gt; <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>        List&lt;SwaggerResource&gt; resources = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        List&lt;String&gt; routes = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-comment">//获取所有路由的ID</span><br>        routeLocator.getRoutes().subscribe(route -&gt; routes.add(route.getId()));<br>        <span class="hljs-comment">//过滤出配置文件中定义的路由-&gt;过滤出Path Route Predicate-&gt;根据路径拼接成api-docs路径-&gt;生成SwaggerResource</span><br>        gatewayProperties.getRoutes().stream().filter(routeDefinition -&gt; routes.contains(routeDefinition.getId())).forEach(route -&gt; &#123;<br>            route.getPredicates().stream()<br>                    .filter(predicateDefinition -&gt; (<span class="hljs-string">"Path"</span>).equalsIgnoreCase(predicateDefinition.getName()))<br>                    .forEach(predicateDefinition -&gt; resources.add(swaggerResource(route.getId(),<br>                            predicateDefinition.getArgs().get(NameUtils.GENERATED_NAME_PREFIX + <span class="hljs-string">"0"</span>)<br>                                    .replace(<span class="hljs-string">"**"</span>, <span class="hljs-string">"v2/api-docs"</span>))));<br>        &#125;);<br><br>        <span class="hljs-keyword">return</span> resources;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> SwaggerResource <span class="hljs-title">swaggerResource</span><span class="hljs-params">(String name, String location)</span> </span>&#123;<br>        SwaggerResource swaggerResource = <span class="hljs-keyword">new</span> SwaggerResource();<br>        swaggerResource.setName(name);<br>        swaggerResource.setLocation(location);<br>        swaggerResource.setSwaggerVersion(<span class="hljs-string">"2.0"</span>);<br>        <span class="hljs-keyword">return</span> swaggerResource;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主要的配置的作用已经在代码中进行注释。</p>
<p>新增一个控制器：<code>SwaggerHandler</code> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SwaggerHandler</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span>(required = <span class="hljs-keyword">false</span>)<br>    <span class="hljs-keyword">private</span> SecurityConfiguration securityConfiguration;<br><br>    <span class="hljs-meta">@Autowired</span>(required = <span class="hljs-keyword">false</span>)<br>    <span class="hljs-keyword">private</span> UiConfiguration uiConfiguration;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SwaggerResourcesProvider swaggerResources;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SwaggerHandler</span><span class="hljs-params">(SwaggerResourcesProvider swaggerResources)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.swaggerResources = swaggerResources;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Swagger安全配置，支持oauth和apiKey设置</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/swagger-resources/configuration/security"</span>)<br>    <span class="hljs-keyword">public</span> Mono&lt;ResponseEntity&lt;SecurityConfiguration&gt;&gt; securityConfiguration() &#123;<br>        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-keyword">new</span> ResponseEntity&lt;&gt;(<br>                Optional.ofNullable(securityConfiguration).orElse(SecurityConfigurationBuilder.builder().build()), HttpStatus.OK));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Swagger UI配置</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/swagger-resources/configuration/ui"</span>)<br>    <span class="hljs-keyword">public</span> Mono&lt;ResponseEntity&lt;UiConfiguration&gt;&gt; uiConfiguration() &#123;<br>        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-keyword">new</span> ResponseEntity&lt;&gt;(<br>                Optional.ofNullable(uiConfiguration).orElse(UiConfigurationBuilder.builder().build()), HttpStatus.OK));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Swagger资源配置，微服务中这各个服务的api-docs信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/swagger-resources"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Mono&lt;ResponseEntity&gt; <span class="hljs-title">swaggerResources</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> Mono.just((<span class="hljs-keyword">new</span> ResponseEntity&lt;&gt;(swaggerResources.get(), HttpStatus.OK)));<br>    &#125;<br>&#125;-----------------<br></code></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>分别运行：spring-cloud-nacos-provider，spring-cloud-nacos-consumer，spring-cloud-gateway 三个服务。</p>
<p>打开swagger的地址: <a href="http://127.0.0.1:15010/doc.html" target="_blank" rel="noopener">http://127.0.0.1:15010/doc.html</a></p>
<p>验证结果：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124615.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>看到上图中的结果说明聚合成功。</p>
<h2 id="集成登录权限的统一校验"><a href="#集成登录权限的统一校验" class="headerlink" title="集成登录权限的统一校验"></a>集成登录权限的统一校验</h2><blockquote>
<p>为了直达主题，本次集成登录权限会尽量的简单，其中忽略一些细节，比如登录服务模块，可以查看demo的源码：<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study/tree/main/spring-cloud-auth" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study/tree/main/spring-cloud-auth</a><br>并且我会在关键的点上明确讲解。</p>
</blockquote>
<p>在开始之前需要明白一个原理，如果要实现统一鉴权，那么需要对所有的请求进行统一的拦截，要实现统一的拦截，在Spring Cloud Gateway中有一个filter接口为：<code>GlobalFilter</code> 。</p>
<p>所以我们可以通过实现<code>GlobalFilter</code> 接口来实现请求的拦截。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>新建一个类实现<code>GlobalFilter</code> 接口，并且实现<code>filter</code> 方法，在此基础上我们还需要实现<code>Ordered</code> 接口，控制拦截的优先级，鉴权拦截优先级是最高的，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorizeFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GlobalFilter</span>, <span class="hljs-title">Ordered</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    UserRedisCollection userRedisCollection;<br><br>		<span class="hljs-comment">// (1)</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">checkWhiteList</span><span class="hljs-params">(String uri)</span> </span>&#123;<br>        <span class="hljs-keyword">boolean</span> access = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-keyword">if</span> (uri.contains(<span class="hljs-string">"/login"</span>) || uri.contains(<span class="hljs-string">"/v2/api-docs"</span>)) &#123;<br>            access = <span class="hljs-keyword">true</span>;<br>            <span class="hljs-keyword">if</span> (uri.contains(<span class="hljs-string">"logout"</span>)) &#123;<br>                access = <span class="hljs-keyword">false</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (uri.contains(<span class="hljs-string">"/open-api"</span>)) &#123;<br>            access = <span class="hljs-keyword">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> access;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;<br>			  <span class="hljs-comment">// (2)</span><br>        ServerHttpRequest request = exchange.getRequest();<br>        ServerHttpResponse response = exchange.getResponse();<br>        String uri = request.getURI().getPath();<br>				<br>				<span class="hljs-comment">// (3)</span><br>        <span class="hljs-comment">//前端访问不到header问题</span><br>        response.getHeaders().add(<span class="hljs-string">"Access-Control-Allow-Headers"</span>,<span class="hljs-string">"X-PINGOTHER, Origin, X-Requested-With, Content-Type, Accept, token"</span>);<br>        response.getHeaders().add(<span class="hljs-string">"Access-Control-Expose-Headers"</span>, <span class="hljs-string">"token"</span>);<br>        ServerHttpRequest mutableReq = request.mutate()<br>                .header(DefaultConstants.IP_ADDRESS, getIpAddress(request))<br>                .build();<br>        ServerWebExchange mutableExchange = exchange.mutate().request(mutableReq).build();<br>        <span class="hljs-comment">// (4)</span><br>				<span class="hljs-comment">//检查白名单</span><br>        <span class="hljs-keyword">if</span> (checkWhiteList(uri)) &#123;<br>            <span class="hljs-keyword">return</span> chain.filter(mutableExchange);<br>        &#125;<br>				<br>				<span class="hljs-comment">// (5)</span><br>        <span class="hljs-comment">//从request获取token</span><br>        String accessToken = request.getHeaders().getFirst(DefaultConstants.TOKEN);<br>        log.info(<span class="hljs-string">"AccessToken: [&#123;&#125;]"</span>, accessToken);<br><br>				<span class="hljs-comment">// (6)</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isBlank(accessToken)) &#123;<br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-keyword">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class="hljs-string">"未登录"</span>);<br>        &#125;<br>        Claims claims = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>						<span class="hljs-comment">// (7)</span><br>            claims = JwtUtil.parseJWT(accessToken, DefaultConstants.SECRET_KEY);<br>						<br>            <span class="hljs-keyword">if</span> (claims == <span class="hljs-keyword">null</span>) &#123;<br>                response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>                <span class="hljs-keyword">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class="hljs-string">"未登录"</span>);<br>            &#125;<br>            log.info(<span class="hljs-string">"claims is:&#123;&#125;"</span>, claims);<br>            <span class="hljs-keyword">if</span> (claims.getSubject().equals(DefaultConstants.USER))&#123;<br>                <span class="hljs-keyword">if</span>(claims.get(DefaultConstants.USERID)!=<span class="hljs-keyword">null</span>) &#123;<br>                    Long userId = Long.parseLong(claims.get(DefaultConstants.USERID).toString());<br><br>                    log.info(<span class="hljs-string">"userId:&#123;&#125;"</span>, userId);<br>                    Map&lt;String, Object&gt; map = Maps.newHashMapWithExpectedSize(<span class="hljs-number">1</span>);<br>                    map.put(DefaultConstants.USERID,userId.toString());<br>										<br>										<span class="hljs-comment">// (8)</span><br>                    UserInfoEntity userInfo = userRedisCollection.getAuthUserInfoAndCache(userId);<br>                    <span class="hljs-comment">//判断是否</span><br>                    <span class="hljs-keyword">if</span> (userInfo == <span class="hljs-keyword">null</span>) &#123;<br>                        response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>                        <span class="hljs-keyword">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class="hljs-string">"未登录"</span>);<br>                    &#125;<br><br>										<span class="hljs-comment">// (9)</span><br>                    String token = JwtUtil.createToken(DefaultConstants.USER, map, DefaultConstants.SECRET_KEY);<br>                    response.getHeaders().add(DefaultConstants.TOKEN, token);<br>										<br>                    mutableReq = request.mutate().header(DefaultConstants.USER_ID, String.valueOf(userId))<br>                            .header(DefaultConstants.IP_ADDRESS, getIpAddress(request))<br>                            .build();<br>                    mutableExchange = exchange.mutate().request(mutableReq).build();<br>                    <span class="hljs-keyword">return</span> chain.filter(mutableExchange);<br><br>                &#125;<br><br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-keyword">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class="hljs-string">"未登录"</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> getVoidMono(response, ResultCodeEnum.UNAUTHORIZED, <span class="hljs-string">"未登录"</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> Mono&lt;Void&gt; <span class="hljs-title">getVoidMono</span><span class="hljs-params">(ServerHttpResponse serverHttpResponse, ResultCodeEnum resultCode, String responseText)</span> </span>&#123;<br>        serverHttpResponse.getHeaders().add(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json;charset=UTF-8"</span>);<br>        CommonResult&lt;?&gt; result = CommonResult.failed(resultCode.getCode(), responseText);<br>        DataBuffer dataBuffer = serverHttpResponse.bufferFactory().wrap(JSON.toJSONString(result).getBytes());<br>        <span class="hljs-keyword">return</span> serverHttpResponse.writeWith(Flux.just(dataBuffer));<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getIpAddress</span><span class="hljs-params">(ServerHttpRequest request)</span> </span>&#123;<br>        String ip = request.getHeaders().getFirst(<span class="hljs-string">"x-forwarded-for"</span>);<br>        <span class="hljs-keyword">if</span> (ip == <span class="hljs-keyword">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class="hljs-string">"Proxy-Client-IP"</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ip == <span class="hljs-keyword">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class="hljs-string">"WL-Proxy-Client-IP"</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ip == <span class="hljs-keyword">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class="hljs-string">"HTTP_CLIENT_IP"</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ip == <span class="hljs-keyword">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getHeaders().getFirst(<span class="hljs-string">"HTTP_X_FORWARDED_FOR"</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ip == <span class="hljs-keyword">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) &#123;<br>            ip = request.getRemoteAddress().getHostString();<br>        &#125;<br>        <span class="hljs-keyword">return</span> ip;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">100</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>(1) 这个方法可以将白名单加入，当请求到这些url的时候不进行权限的校验</li>
<li>(2) 我们在使用Spring Cloud Gateway的时候，注意到过滤器（包括GatewayFilter、GlobalFilter和过滤器链GatewayFilterChain），都依赖到ServerWebExchange，这里filter的设计跟Servlet中的的filter相似，也就是当前过滤器决定是否执行下一个过滤器的逻辑，而ServerWebExchange就是当前请求和响应的上下文，不仅包含了request和response，还包含了一些扩展方法，如代码中可以获取到request和response。</li>
<li>(3) 这一步，主要是解决前端无法中header中获取到需要获取的参数。比如<code>token</code> 。</li>
<li>(4) 这里对应了第一步白名单的判断，如果当前请求在白名单就跳过后面的一些权限的判断，直接执行下一个过滤器。</li>
<li>(5) 这里很简单，就是从request中获取到token，方便jwt转换成对应的用户信息。</li>
<li>(6) 如果请求没有携带token就不予通过。</li>
<li>(7) jwt将token转换成用户信息，用于后面的判断以及用户的基本信息。</li>
<li>(8) 上面获取到用户的信息之后，根据用户的userId查询redis中是否存在该用户数据，如果不存在表示该用户的用户信息已经过期了，而且从redis查询的时候会重置超时时间（也就保证了只要经常的在线就不需要重新登录，超过设定的时间没有在线，那么就需要重新登录）。注意：这里是需要跟登录服务进行联动，也就是登录成功之后将用户的信息存入redis，然后gateway这边能取到该用户信息。所以需要保证这一点。</li>
<li>(9) 这里会重新颁发token，主要是防止token会过期，token的过期时间在jwtUtils中可以设置，所以，前端需要每次请求之后都将新的token作为下一次请求的token。</li>
<li>注意：本文的token是放在header中，前端小伙伴需要从header中取token。</li>
</ul>
<p>代码中的方法：<code>UserRedisCollection.getAuthUserInfoAndCache(Long userId)</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> UserInfoEntity <span class="hljs-title">getAuthUserInfoAndCache</span><span class="hljs-params">(Long userId)</span> </span>&#123;<br>        CommonAssert.meetCondition(userId == <span class="hljs-keyword">null</span>, <span class="hljs-string">"未获取到userId"</span>);<br>        String key = DefaultConstants.USER_INFO_REDIS + userId;<br>        UserInfoEntity entity = (UserInfoEntity) redisTemplate.opsForValue().get(key);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != entity) &#123;<br>            redisTemplate.opsForValue().set(key, entity, <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, TimeUnit.MILLISECONDS);<br>            <span class="hljs-keyword">return</span> entity;<br>        &#125;<br>        CommonAssert.meetCondition(<span class="hljs-keyword">true</span>, <span class="hljs-string">"当前用户未登陆，未获取到登陆信息"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>该方法简单，就是根据userId获取到用户信息的，成功获取之后会重置超时时间，时长可以根据需要进行修改。</p>
<p>关于本文的登录服务，可以从demo源码中获取：</p>
<p><a href="https://github.com/WinterChenS/spring-cloud-hoxton-study/tree/main/spring-cloud-auth" target="_blank" rel="noopener">spring-cloud-hoxton-study/spring-cloud-auth at main · WinterChenS/spring-cloud-hoxton-study</a></p>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>分别启动gateway,provider,auth服务。</p>
<p>首先，测试未登录的情况：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124637.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>然后进入auth服务，打开登录接口：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124653.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>打开Headers，复制token</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124712.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>再次切换到provider服务，设置文档的全局参数：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124726.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>然后刷新一下页面再请求就可以发现，请求成功：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210731124735.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>到这里就成功集成了gateway鉴权了。</p>
<h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><ul>
<li>至于登出的逻辑，思路是这样的，登出只需要在auth服务中将用户信息从redis清除即可，这样在gateway中查询redis就可以查到用户登录信息已经失效了。</li>
<li>如何在服务中获取当前登录用户信息呢？这个其实挺简单的，一般的做法就是写一个工具类，该工具类从请求的header中获取token，或者在请求阶段就讲userId设置到token中，如果只有token就讲token转换成用户信息，然后根据id从redis中获取用户详细信息，不过一般只需要userId就可以了，这边给个示例：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getUserIdByCurrent</span><span class="hljs-params">()</span> </span>&#123;<br>        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder<br>                .getRequestAttributes();<br>        <span class="hljs-keyword">if</span> (attributes != <span class="hljs-keyword">null</span>) &#123;<br>            HttpServletRequest request = attributes.getRequest();<br>            <span class="hljs-keyword">return</span> request.getHeader(ConstantsUtil.USER_ID);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章介绍了如何在gateway中聚合swagger文档以及统一鉴权的集成，内容其实并不多，原本打算分开两篇进行介绍的，swagger部分没有什么需要注意的原理，索性就放在一起，真正重要的点就是Spring Cloud Gateway中的filter的应用，这部分可以通过查找资料详细的了解一下，下一篇将介绍如何使用限流组件Sentinel，这个组件由alibaba提供。</p>
<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>
<p>参考文献</p>
<p><a href="https://juejin.cn/post/6844903846469189645" target="_blank" rel="noopener">Spring Cloud Gateway-ServerWebExchange核心方法与请求或者响应内容的修改</a></p>
]]></content>
      <categories>
        <category>springcloud</category>
      </categories>
      <tags>
        <tag>springcloud</tag>
        <tag>gateway</tag>
        <tag>Hoxton</tag>
        <tag>swagger</tag>
        <tag>knife4j</tag>
        <tag>auth</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud系列教程(四)之SpringCloud Gateway</title>
    <url>/2021/08/03/2021-08-03-spring-cloud-hoxton-4-gateway/</url>
    <content><![CDATA[<blockquote>
<p>**阅读提醒：</p>
</blockquote>
<ol>
<li>本文面向的是有一定springboot基础者</li>
<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>
<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：**<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>
</ol>
<h2 id="前情概要"><a href="#前情概要" class="headerlink" title="前情概要"></a>前情概要</h2><ul>
<li><a href="https://juejin.cn/post/6987998097209032741" target="_blank" rel="noopener">SpringCloud系列教程(一)开篇</a></li>
<li><a href="https://juejin.cn/post/6991323018802757662" target="_blank" rel="noopener">SpringCloud系列教程(二)之Nacos | 8月更文挑战</a></li>
<li><a href="https://juejin.cn/post/6991635985847025671" target="_blank" rel="noopener"># SpringCloud系列教程(三)之Open Feign | 8月更文挑战</a></li>
</ul>
<h2 id="本文概览"><a href="#本文概览" class="headerlink" title="本文概览"></a>本文概览</h2><ul>
<li>Spring Cloud Gateway的简介</li>
<li>gateway在微服务架构中的应用场景</li>
<li>Spring Cloud Gateway使用</li>
<li>相关配置详解</li>
<li>实战中的使用</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Spring Cloud 作为新一代的微服务网关，该项目基于Spring webflux技术开发的网关，作为Spring Cloud生态系统中的网关，目标是替代zuul，为什么使用webflux？webflux是Reactor模式的响应式编程框架，底层使用了netty通信框架，非Reactor模式的zuul采用的是Tomcat容器，使用的还是传统的Servlet IO处理模型。想了解webflux和netty的同学可以搜索相关知识，这也是当前比较热门的技术。</p>
<p>本文中用到的demo源码地址：<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>
<h3 id="Gateway的特征"><a href="#Gateway的特征" class="headerlink" title="Gateway的特征"></a>Gateway的特征</h3><p>引用官方的文档：</p>
<blockquote>
<p>Spring Cloud Gateway features:</p>
</blockquote>
<ul>
<li><p>Built on Spring Framework 5, Project Reactor and Spring Boot 2.0</p>
</li>
<li><p>Able to match routes on any request attribute.</p>
</li>
<li><p>Predicates and filters are specific to routes.</p>
</li>
<li><p>Circuit Breaker integration.</p>
</li>
<li><p>Spring Cloud DiscoveryClient integration</p>
</li>
<li><p>Easy to write Predicates and Filters</p>
</li>
<li><p>Request Rate Limiting</p>
</li>
<li><p>Path Rewriting</p>
</li>
<li><p>Spring Cloud Gateway 基于 Spring Framework 5, Project Reactor 和 Spring Boot 2.0</p>
</li>
<li><p>能够匹配任何请求属性上的路由。</p>
</li>
<li><p>Predicates和filters特定于路由，易于编写的Predicates和filters</p>
</li>
<li><p>Hystrix断路器的继承</p>
</li>
<li><p>集成了DiscoveryClient</p>
</li>
<li><p>具备了一些高级功：动态路由、限流、路径重写等</p>
</li>
</ul>
<p>和zuul的功能相差不大，最主要的区别是底层通信框架的实现上。</p>
<p>具体的通信框架这里就暂时不展开了。</p>
<h2 id="微服务网关的应用场景"><a href="#微服务网关的应用场景" class="headerlink" title="微服务网关的应用场景"></a>微服务网关的应用场景</h2><p>在微服务架构中，网关起到了下层服务的路由、限流和路径重写等作用，下面用一张简单的架构图来描述一下微服务网关的作用：</p>
<p><img   class="lazyload" data-original="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/78dd5ad29dae4bf2b26ed589c74dd811~tplv-k3u1fbpfcp-zoom-1.image" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>上图中很直观的展示了Spring Cloud Gateway在整个架构中的作用。</p>
<h2 id="Spring-Cloud-Gateway使用"><a href="#Spring-Cloud-Gateway使用" class="headerlink" title="Spring Cloud Gateway使用"></a>Spring Cloud Gateway使用</h2><h3 id="新建模块"><a href="#新建模块" class="headerlink" title="新建模块"></a>新建模块</h3><p>新建一个springboot工程，maven依赖如下，详细的配置可以查看demo源码</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>修改配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">15010</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">118.25</span><span class="hljs-number">.36</span><span class="hljs-number">.41</span><span class="hljs-string">:8848</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">locator:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">lowerCaseServiceId:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">provider</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://winter-nacos-provider</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/provider/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">consumer</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://winter-nacos-consumer</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/consumer/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">winter-gateway</span><br></code></pre></td></tr></table></figure>

<p>具体配置的解释后面会介绍。</p>
<p>接下来就在启动类中加入注解: <code>@EnableDiscoveryClient</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringCloudGatewayApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(SpringCloudGatewayApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>启动服务：<code>spring-cloud-nacos-consumer</code>， <code>spring-cloud-nacos-provider</code>，<code>spring-cloud-gateway</code> </p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>浏览器输入：<a href="http://127.0.0.1:15010/consumer/nacos/echo/hello" target="_blank" rel="noopener">http://127.0.0.1:15010/consumer/nacos/echo/hello</a></p>
<p>得到返回值：<code>Hello Nacos Discovery hello</code> </p>
<h3 id="拓展：解决跨域问题"><a href="#拓展：解决跨域问题" class="headerlink" title="拓展：解决跨域问题"></a>拓展：解决跨域问题</h3><p>Spring Cloud Gateway如何解决跨域问题？我们可以在配置文件中加入：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">globalcors:</span><br>        <span class="hljs-attr">cors-configurations:</span><br>          <span class="hljs-string">'[/**]'</span><span class="hljs-string">:</span> <span class="hljs-comment"># 匹配所有请求</span><br>            <span class="hljs-attr">allowedOrigins:</span> <span class="hljs-string">"*"</span> <span class="hljs-comment">#跨域处理 允许所有的域</span><br>            <span class="hljs-attr">allowedMethods:</span> <span class="hljs-comment"># 支持的方法</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">POST</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">PUT</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">DELETE</span><br></code></pre></td></tr></table></figure>

<h2 id="Spring-Cloud-Gateway-配置详解"><a href="#Spring-Cloud-Gateway-配置详解" class="headerlink" title="Spring Cloud Gateway 配置详解"></a>Spring Cloud Gateway 配置详解</h2><p>我们看一下上面我们用到的配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">15010</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">118.25</span><span class="hljs-number">.36</span><span class="hljs-number">.41</span><span class="hljs-string">:8848</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">locator:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">lowerCaseServiceId:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">provider</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://winter-nacos-provider</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/provider/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span> <br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">consumer</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://winter-nacos-consumer</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/consumer/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">winter-gateway</span><br></code></pre></td></tr></table></figure>

<p><strong>id</strong>：我们自定义的路由 ID，保持唯一</p>
<p><strong>uri</strong>：目标服务地址</p>
<p><strong>predicates</strong>：路由条件，Predicate 接受一个输入参数，返回一个布尔值结果。该接口包含多种默认方法来将 Predicate 组合成其他复杂的逻辑（比如：与，或，非）。</p>
<p>上面这段配置的意思是，配置了一个 id 为 url-proxy-1的URI代理规则，路由的规则为：</p>
<p>当访问地址<code>http://localhost:8080/provider/nacos/echo/hello</code>时，</p>
<p>会路由到上游地址<code>http://winter-nacos-provider/nacos/echo/hello</code>。</p>
<p><strong>filters</strong>: 过滤器是路由转发请求时所经过的过滤逻辑，可用于修改请求、响应内容，<code>StripPrefix=1</code>就代表截取路径的个数为1，比如前端过来请求<code>/provider/nacos/echo/hello</code>，匹配成功后，路由到后端的请求路径就会变成<code>http://127.0.0.1:16012/nacos/echo/hello</code>。</p>
<p>关于gateway的详细配置，可以参考: </p>
<p><a href="https://www.cnblogs.com/crazymakercircle/p/11704077.html" target="_blank" rel="noopener">SpringCloud gateway （史上最全）</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>关于spring cloud gateway的介绍先讲到这里，后一篇会讲解如何在网关层集成swagger文档以及如何在网关层进行登录权限的验证。并且会介绍相关的原理。</p>
<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>
<p>参考文献：</p>
<p><a href="https://spring.io/projects/spring-cloud-gateway#overview" target="_blank" rel="noopener">Spring Cloud Gateway</a></p>
<p><a href="https://www.cnblogs.com/crazymakercircle/p/11704077.html" target="_blank" rel="noopener">SpringCloud gateway （史上最全）</a></p>
]]></content>
      <categories>
        <category>springcloud</category>
      </categories>
      <tags>
        <tag>springcloud</tag>
        <tag>gateway</tag>
        <tag>Hoxton</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud系列教程(三)之Open Feign</title>
    <url>/2021/08/02/2021-08-02-spring-cloud-hoxton-3-feign/</url>
    <content><![CDATA[<blockquote>
<p>阅读提醒：</p>
</blockquote>
<ol>
<li>本文面向的是有一定springboot基础者</li>
<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>
<li>本文依赖上一篇的工程，请查看上一篇文章以做到无缝衔接，或者直接下载源码：<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></li>
</ol>
<h2 id="前情概要"><a href="#前情概要" class="headerlink" title="前情概要"></a>前情概要</h2><ul>
<li><a href="https://juejin.cn/post/6987998097209032741" target="_blank" rel="noopener">SpringCloud系列教程(一)开篇</a></li>
<li><a href="https://juejin.cn/post/6991323018802757662" target="_blank" rel="noopener">SpringCloud系列教程(二)之Nacos | 8月更文挑战 (juejin.cn)</a></li>
</ul>
<h2 id="本文概览"><a href="#本文概览" class="headerlink" title="本文概览"></a>本文概览</h2><ul>
<li>RPC是什么？</li>
<li>Spring Cloud如何整合openfeign</li>
<li>如何使用ribbon和Hystrix 进行服务的负载均衡和服务熔断</li>
<li>实际的应用场景</li>
</ul>
<blockquote>
<p>上篇文章介绍了Spring Cloud如何整合Nacos作为配置中心和注册中心，接下来将介绍如何结合<br>Open Feign进行远程服务调用。在讲解OpenFeign之前我们需要了解一下RPC的基础概念。</p>
</blockquote>
<p>本文中用到的demo源码地址：<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>
<h2 id="什么是RPC？"><a href="#什么是RPC？" class="headerlink" title="什么是RPC？"></a>什么是RPC？</h2><blockquote>
<p>在分布式计算，<strong>远程过程调用</strong>（英语：<strong>Remote Procedure Call</strong>，缩写为 RPC）是一个计算机通信协议。该协议允许运行于一台计算机的程序调用另一个地址空间（通常为一个开放网络的一台计算机）的子程序，而程序员就像调用本地程序一样，无需额外地为这个交互作用编程（无需关注细节）。RPC是一种服务器-客户端（Client/Server）模式，经典实现是一个通过发送请求-接受回应进行信息交互的系统。<br>如果涉及的软件采用面向对象编程，那么远程过程调用亦可称作远程调用或远程方法调用，例：Java RMI。<br>RPC是一种进程间通信的模式，程序分布在不同的地址空间里。如果在同一主机里，RPC可以通过不同的虚拟地址空间（即便使用相同的物理地址）进行通讯，而在不同的主机间，则通过不同的物理地址进行交互。许多技术（常常是不兼容）都是基于这种概念而实现的。<br>                                                                                                                — 引用自维基百科</p>
</blockquote>
<p>Feign与RPC的关系是什么？为什么有人觉得Feign是伪RPC？</p>
<p>其实Feign实现了可以通过像调用本地方法去调用远程服务的话，就是RPC，RPC最关键的两个协议是：</p>
<ol>
<li>通讯协议</li>
<li>序列化协议</li>
</ol>
<p>常用的rpc框架有：open feign 和 dubbo，feign基于http协议，dubbo基于tcp协议。</p>
<h3 id="feign的原理："><a href="#feign的原理：" class="headerlink" title="feign的原理："></a>feign的原理：</h3><p>feign集成了两个重要的模块：<strong>ribbon</strong>，<strong>Hystrix</strong> 来实现<strong>负载均衡</strong>和<strong>服务熔断，</strong>ribbon内置了<strong>RestTemplate,</strong> RestTemplate基于HTTP，所以说feign基于HTTP。</p>
<p>Feign通过处理注解，将请求模板化，当实际调用的时候，传入参数，根据参数再应用到请求上，进而转化成真正的 Request 请求。通过Feign以及JAVA的动态代理机制，使得Java 开发人员，可以不用通过HTTP框架去封装HTTP请求报文的方式，完成远程服务的HTTP调用。</p>
<h2 id="Spring-Cloud集成feign"><a href="#Spring-Cloud集成feign" class="headerlink" title="Spring Cloud集成feign"></a>Spring Cloud集成feign</h2><p>根据上篇的文章中我们使用的Nacos作为代码基础，在此之上集成Feign，所以请查看上一篇文章以做到无缝衔接。</p>
<h3 id="spring-cloud-nacos-provider-修改："><a href="#spring-cloud-nacos-provider-修改：" class="headerlink" title="spring-cloud-nacos-provider 修改："></a>spring-cloud-nacos-provider 修改：</h3><p>在工程<code>spring-cloud-nacos-provider</code> 中增加依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- springCloud-feign --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>新建一个类：<code>NacosProviderClient</code> 并增加注解：<code>@FeignClient(value = &quot;winter-nacos-provider&quot;)</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"winter-nacos-provider"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">NacosProviderClient</span> </span>&#123;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/nacos/feign-test/&#123;string&#125;"</span>)<br>    <span class="hljs-function">String <span class="hljs-title">echo2</span><span class="hljs-params">(@PathVariable String string)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>类：<code>NacosController</code> 增加方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"feign-test/&#123;string&#125;"</span>)<br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">feignTest</span><span class="hljs-params">(@PathVariable String string)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello feign "</span> + string;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="spring-cloud-nacos-consumer-修改："><a href="#spring-cloud-nacos-consumer-修改：" class="headerlink" title="spring-cloud-nacos-consumer 修改："></a>spring-cloud-nacos-consumer 修改：</h3><p>在工程<code>spring-cloud-nacos-consumer</code> 中增加依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- springCloud-feign --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 对于服务provider的依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.winterchen<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-nacos-provider<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在启动类<code>NacosConsumerApplication</code> 中增加注解：<code>@EnableFeignClients</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@EnableFeignClients</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NacosConsumerApplication</span> </span>&#123;<br><br>    <span class="hljs-meta">@LoadBalanced</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(NacosConsumerApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>在类：<code>NacosController</code> 中增加方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> NacosProviderClient nacosProviderClient;<br><br><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/feign-test/&#123;str&#125;"</span>)<br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">feignTest</span><span class="hljs-params">(@PathVariable String str)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> nacosProviderClient.echo2(str);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h3><ol>
<li>依次启动两个服务；</li>
<li>浏览器输入：<a href="http://127.0.0.1:16011/nacos/feign-test/hello" target="_blank" rel="noopener">http://127.0.0.1:16011/nacos/feign-test/hello</a></li>
<li>返回：Hello feign hello  就表示成功了</li>
</ol>
<h2 id="使用Ribbon"><a href="#使用Ribbon" class="headerlink" title="使用Ribbon"></a>使用Ribbon</h2><p>Feign内置了ribbon用于服务的负载均衡，所以只需要引入feign的依赖就会自动使用负载均衡，接下来我们试一下服务的负载均衡：</p>
<h3 id="spring-cloud-nacos-provider-修改：-1"><a href="#spring-cloud-nacos-provider-修改：-1" class="headerlink" title="spring-cloud-nacos-provider 修改："></a>spring-cloud-nacos-provider 修改：</h3><p><code>NacosController</code> 新增方法和参数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;server.port&#125;"</span>)<br>  String port;<br><br><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/ribbon-test"</span>)<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">ribbonTest</span><span class="hljs-params">()</span> </span>&#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello ribbon , my port: "</span> + port;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p><code>NacosProviderClient</code> 新增接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/nacos/ribbon-test"</span>)<br>  <span class="hljs-function">String <span class="hljs-title">ribbonTest</span><span class="hljs-params">()</span></span>;<br></code></pre></td></tr></table></figure>

<p>为了测试服务的负载，所以provider服务不使用配置中心的配置，删除配置中心的配置，然后新建<code>application.yml</code> 配置文件，内容如下:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">16012</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">118.25</span><span class="hljs-number">.36</span><span class="hljs-number">.41</span><span class="hljs-string">:8848</span><br><br><span class="hljs-attr">test:</span><br>  <span class="hljs-attr">config:</span><br>    <span class="hljs-attr">refresh:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<h3 id="spring-cloud-nacos-consumer-修改"><a href="#spring-cloud-nacos-consumer-修改" class="headerlink" title="spring-cloud-nacos-consumer 修改"></a>spring-cloud-nacos-consumer 修改</h3><p><code>NacosController</code> 新增方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/ribbon-test"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">ribbonTest1</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> nacosProviderClient.ribbonTest();<br>    &#125;<br></code></pre></td></tr></table></figure>

<h3 id="测试：-1"><a href="#测试：-1" class="headerlink" title="测试："></a>测试：</h3><p>在测试之前需要修改idea的配置，红色方框处勾选之后服务可以启动多个节点</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046456754692.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>依次启动两个服务，然后修改<code>spring-cloud-nacos-provider</code> 的端口配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">16013</span><br></code></pre></td></tr></table></figure>

<p>然后再次启动<code>spring-cloud-nacos-provider</code> 服务，启动后该服务存在两个节点</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046456920605.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>然后调用：<a href="http://127.0.0.1:16011/nacos/ribbon-test" target="_blank" rel="noopener">http://127.0.0.1:16011/nacos/ribbon-test</a></p>
<p>可以发现请求会轮流调用：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">Hello</span> <span class="hljs-string">ribbon</span> <span class="hljs-string">,</span> <span class="hljs-attr">my port:</span> <span class="hljs-number">16012</span><br><span class="hljs-string">Hello</span> <span class="hljs-string">ribbon</span> <span class="hljs-string">,</span> <span class="hljs-attr">my port:</span> <span class="hljs-number">16013</span><br></code></pre></td></tr></table></figure>

<p>这样就实现了服务的负载均衡。</p>
<h3 id="Ribbon的配置"><a href="#Ribbon的配置" class="headerlink" title="Ribbon的配置"></a>Ribbon的配置</h3><p>可以配置Ribbon的一些参数实现更多的控制，简单的介绍一下Ribbon的配置，我们可以在consumer工程的配置文件中增加：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">winter-nacos-consumer:</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">12000000</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">12000000</span><br>        <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RandomRule</span><br>        <span class="hljs-attr">OkToRetryOnAllOperations:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">MaxAutoRetriesNextServer:</span> <span class="hljs-number">2</span><br>        <span class="hljs-attr">MaxAutoRetries:</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">    ConnectTimeout: #单位ms,请求连接超时时间<br>    ReadTimeout:  #单位ms,请求处理的超时时间<br>    OkToRetryOnAllOperations: #对所有操作请求都进行重试<br>    MaxAutoRetriesNextServer: #切换实例的重试次数<br>    MaxAutoRetries: #对当前实例的重试次数<br>NFLoadBalancerRuleClassName #配置Ribbon负载均衡规则:IRule<br></code></pre></td></tr></table></figure>

<h2 id="Hystrix-使用"><a href="#Hystrix-使用" class="headerlink" title="Hystrix 使用"></a>Hystrix 使用</h2><p>除了上面提到的<code>Ribbon</code>，<code>Feign</code>还集成了<code>Hystrix</code> 作为服务熔断组件，服务为什么需要熔断呢？是因为一旦下层服务超时或异常导致不可用，没有熔断机制会导致整个服务集群宕机，所以在微服务架构中，服务的熔断是非常重要的。</p>
<h3 id="spring-cloud-nacos-provider-修改：-2"><a href="#spring-cloud-nacos-provider-修改：-2" class="headerlink" title="spring-cloud-nacos-provider 修改："></a>spring-cloud-nacos-provider 修改：</h3><p><code>NacosController</code> 新增方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/hystrix-test"</span>)<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hystrixTest</span><span class="hljs-params">()</span> </span>&#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"ex"</span>);<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>新增类<code>NacosProviderClientFallback</code> 并实现接口<code>NacosProviderClient</code> ：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NacosProviderClientFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">NacosProviderClient</span></span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">echo2</span><span class="hljs-params">(String string)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"error"</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">ribbonTest</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"error"</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/hystrix-test"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hystrixTest</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"hystrix error"</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改<code>NacosProviderClient</code> ，新增方法并且<code>@FeignClient</code> 注解增加<code>fallback</code>  参数，该参数就是服务降级的类，当服务不可用会调用此类的实现方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"winter-nacos-provider"</span>, fallback = NacosProviderClientFallback<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><br><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">interface</span> <span class="hljs-title">NacosProviderClient</span> </span>&#123;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/nacos/feign-test/&#123;string&#125;"</span>)<br>    <span class="hljs-function">String <span class="hljs-title">echo2</span><span class="hljs-params">(@PathVariable String string)</span></span>;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/nacos/ribbon-test"</span>)<br>    <span class="hljs-function">String <span class="hljs-title">ribbonTest</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/nacos/hystrix-test"</span>)<br>    <span class="hljs-function">String <span class="hljs-title">hystrixTest</span><span class="hljs-params">()</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="spring-cloud-nacos-consumer-修改-1"><a href="#spring-cloud-nacos-consumer-修改-1" class="headerlink" title="spring-cloud-nacos-consumer 修改"></a>spring-cloud-nacos-consumer 修改</h3><p>增加配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">winter-nacos-consumer:</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">12000000</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">12000000</span><br>        <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RandomRule</span><br>        <span class="hljs-attr">OkToRetryOnAllOperations:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">MaxAutoRetriesNextServer:</span> <span class="hljs-number">2</span><br>        <span class="hljs-attr">MaxAutoRetries:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#启用hystrix</span><br><br><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">20000</span> <span class="hljs-comment">#默认的超时时间</span><br>    <span class="hljs-attr">winter-nacos-consumer:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">20000</span> <span class="hljs-comment">#当前服务的超时时间，可以不写</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>注释的注解都是新增的，如果要特定某个服务的配置，就不写default，直接指定服务名就可以，如上面的配置。</p>
</blockquote>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>分别启动两个服务，然后调用：<a href="http://127.0.0.1:16011/nacos/hystrix-test" target="_blank" rel="noopener">http://127.0.0.1:16011/nacos/hystrix-test</a></p>
<p>返回的响应：<code>hystrix error</code> </p>
<h3 id="拓展：hystrix的配置"><a href="#拓展：hystrix的配置" class="headerlink" title="拓展：hystrix的配置"></a>拓展：hystrix的配置</h3><p>线程池配置<br>| Name                                                             | 备注                                                | 默认值   |<br>|——————————————————————|—————————————————|——-|<br>| hystrix.threadpool.default.coreSize                              | 线程池大小                                             | 10    |<br>| hystrix.threadpool.default.maximumSize                           | 线程池最大大小                                           | 10    |<br>| hystrix.threadpool.default.allowMaximumSizeToDivergeFromCoreSize | 是否允许动态调整线程数量，默认false，只有设置为true了，上面的maximumSize才有效 | FALSE |<br>| hystrix.threadpool.default.keepAliveTimeMinutes                  | 超出coreSize的线程，空闲1分钟后释放掉                           | 1     |<br>| hystrix.threadpool.default.maxQueueSize                          | 不能动态修改                                            | -1    |<br>| hystrix.threadpool.default.queueSizeRejectionThreshold           | 可以动态修改，默认是5，先进入请求队列，然后再由线程池执行                     | 5     |</p>
<p><strong>如何计算线程池数量？</strong></p>
<p><strong>高峰期每秒的请求数量 / 1000毫秒 / TP99请求延时 + buffer空间</strong></p>
<p>比如说处理一个请求，要50ms，那么TP99，也就是99%的请求里处理一个请求耗时最长是50ms。</p>
<p>我们给一点缓冲空间10ms，那就是处理请求接口耗时60ms。</p>
<p>所以一秒钟一个线程可以处理：1000 / 60 = 16，一个线程一秒钟可以处理16个请求。</p>
<p>假设高峰期，每秒最多1200个请求，一个线程每秒可以处理16个请求，需要多少个线程才能处理每秒1200个请求呢？1200 / 16 = 75，最多需要75个线程，每个线程每秒处理16个请求，75个线程每秒才可以处理1200个请求。</p>
<p>最多需要多少个线程数量，就是这样子算出来</p>
<p><strong>如果是服务B -&gt; 服务A的话，服务B线程数量怎么设置？</strong></p>
<p>服务B调用服务A的线程池需要多少个线程呢？</p>
<p>高峰期，服务B最多要调用服务A每秒钟1200次，服务A处理一个请求是60ms，服务B每次调用服务A的时候，用一个线程发起一次请求，那么这个服务B的这个线程，要60ms才能返回。</p>
<p>服务B而言，一个线程对服务A发起一次请求需要60ms，一个线程每秒钟可以请求服务A达到16次，但是现在服务B每秒钟需要请求服务A达到1200次，那么服务B就需要75个线程，在高峰期并发请求服务A，才可以完成每秒1200次的调用。</p>
<p>服务B，部署多台机器，每台机器调用服务A的线程池有10个线程，比如说搞个10个线程，一共部署10台机器，那么服务B调用服务A的线程数量，一共有100个线程，轻轻松松可以支撑高峰期调用服务A的1200次的场景</p>
<p>每个线程调用服务A一次，耗时60ms，每个线程每秒可以调用服务A一共是16次，100个线程，每秒最多可以调用服务A是1600次，高峰的时候只要支持调用服务A的1200次就可以了，所以这个机器部署就绰绰有余了</p>
<p>执行配置<br>| Name                                                                        | 备注                             | 默认值    |<br>|—————————————————————————–|——————————–|——–|<br>| hystrix.command.default.execution.isolation.strategy                        | 隔离策略，默认Thread，可以选择Semaphore信号量 | Thread |<br>| hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds    | 超时时间                           | 1000ms |<br>| hystrix.command.default.execution.timeout.enabled                           | 是否启用超时                         | TRUE   |<br>| hystrix.command.default.execution.isolation.thread.interruptOnTimeout       | 超时的时候是否中断执行                    | TRUE   |<br>| hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests | 信号量隔离策略下，允许的最大并发请求数量           | 10     |</p>
<p>降级配置<br>| Name                                     | 备注     | 默认值  |<br>|——————————————|——–|——|<br>| hystrix.command.default.fallback.enabled | 是否启用降级 | TRUE |</p>
<p>熔断配置<br>| Name                                                             | 备注                                              | 默认值  |<br>|——————————————————————|————————————————-|——|<br>| hystrix.command.default.circuitBreaker.enabled                   | 是否启用熔断器                                         | TRUE |<br>| hystrix.command.default.circuitBreaker.requestVolumeThreshold    | 10秒钟内，请求数量达到多少才能去尝试触发熔断                         | 20   |<br>| hystrix.command.default.circuitBreaker.errorThresholdPercentage  | 10秒钟内，请求数量达到20，同时异常比例达到50%，就会触发熔断               | 50   |<br>| hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds | 触发熔断之后，5s内直接拒绝请求，走降级逻辑，5s后尝试half-open放过少量流量试着恢复 | 5000 |<br>| hystrix.command.default.circuitBreaker.forceOpen                 | 强制打开熔断器                                         |      |<br>| hystrix.command.default.circuitBreaker.forceClosed               | 强制关闭熔断器                                         |      |</p>
<p>监控配置<br>| Name                                                                  | 备注                                                                                                                                                        | 默认值           |<br>|———————————————————————–|———————————————————————————————————————————————————–|—————|<br>| hystrix.threadpool.default.metrics.rollingStats.timeInMillisecond     | 线程池统计指标的时间                                                                                                                                                | 默认10000，就是10s |<br>| hystrix.threadpool.default.metrics.rollingStats.numBuckets            | 将rolling window划分为n个buckets                                                                                                                               | 10            |<br>| hystrix.command.default.metrics.rollingStats.timeInMilliseconds       | command的统计时间，熔断器是否打开会根据1个rolling window的统计来计算。若rolling window被设为10000毫秒，则rolling window会被分成n个buckets，每个bucket包含success，failure，timeout，rejection的次数的统计信息。 | 10000         |<br>| hystrix.command.default.metrics.rollingStats.numBuckets               | 设置一个rolling window被划分的数量，若numBuckets＝10，rolling window＝10000，那么一个bucket的时间即1秒。必须符合rolling window % numberBuckets == 0                                     | 10            |<br>| hystrix.command.default.metrics.rollingPercentile.enabled             |  执行时是否enable指标的计算和跟踪                                                                                                                                      | TRUE          |<br>| hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds  | 设置rolling percentile window的时间                                                                                                                            | 60000         |<br>| hystrix.command.default.metrics.rollingPercentile.numBuckets          | 设置rolling percentile window的numberBuckets。逻辑同上。                                                                                                           | 6             |<br>| hystrix.command.default.metrics.rollingPercentile.bucketSize          | 如果bucket size＝100，window＝10s，若这10s里有500次执行，只有最后100次执行会被统计到bucket里去。增加该值会增加内存开销以及排序的开销。                                                                    | 100           |<br>| hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds | 记录health 快照（用来统计成功和错误绿）的间隔                                                                                                                                | 500ms         |</p>
<p>高阶特性配置<br>| Name                                               | 备注                                                               | 默认值               |<br>|—————————————————-|——————————————————————|——————-|<br>| hystrix.command.default.requestCache.enabled       | 是否启用请求缓存                                                         | TRUE              |<br>| hystrix.command.default.requestLog.enabled         | 记录日志到HystrixRequestLog                                           | TRUE              |<br>| hystrix.collapser.default.maxRequestsInBatch       | 单次批处理的最大请求数，达到该数量触发批处理                                           | Integer.MAX_VALUE |<br>| hystrix.collapser.default.timerDelayInMilliseconds | 触发批处理的延迟，也可以为创建批处理的时间＋该值                                         | 10                |<br>| hystrix.collapser.default.requestCache.enabled     | 是否对HystrixCollapser.execute() and HystrixCollapser.queue()的cache | TRUE              |</p>
<p><strong>Feign和Hystrix结合的原理</strong></p>
<p>Feign在和Hystrix整合的时候，feign动态代理里面有一些Hystrix相关的代码，请求走feign动态代理的时候，就会基于Hystrix Command发送请求，实现服务间调用的隔离、限流、超时、降级、熔断、统计等。</p>
<p><img    class="lazyload" data-original="http://www.saily.top/img/spring-cloud/Feign%E5%92%8CHystrix%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">http://www.saily.top/img/spring-cloud/Feign%E5%92%8CHystrix%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86.jpg</span></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文学习了springcloud整合feign实现远程服务调用，并且使用了feign集成的Ribbon和Hystrix实现的负载均衡和服务熔断，以及对服务负载均衡和熔断进行了深度的了解和实际使用当中的一些配置，下一篇将会讲讲微服务网关SpringCloud Gateway。</p>
<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>
<p>参考文档：</p>
<p><a href="https://spring.io/projects/spring-cloud-openfeign" target="_blank" rel="noopener">Spring Cloud OpenFeign</a></p>
<p><a href="http://www.saily.top/2020/04/19/springcloud/hystrix05/" target="_blank" rel="noopener">Feign和Hystrix的结合使用</a></p>
]]></content>
      <categories>
        <category>springcloud</category>
      </categories>
      <tags>
        <tag>springcloud</tag>
        <tag>Hoxton</tag>
        <tag>feign</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud系列教程(二)之Nacos</title>
    <url>/2021/08/01/2021-08-01-spring-cloud-hoxton-2-nacos/</url>
    <content><![CDATA[<blockquote>
<p>阅读提醒：</p>
</blockquote>
<ol>
<li>本文面向的是有一定springboot基础者</li>
<li>本次教程使用的Spring Cloud Hoxton RELEASE版本</li>
</ol>
<h2 id="本文概览"><a href="#本文概览" class="headerlink" title="本文概览"></a>本文概览</h2><ul>
<li>什么是注册中心？</li>
<li>什么是配置中心？</li>
<li>如何在springcloud中使用Nacos？</li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在使用nacos之前我们需要理解nacos在整个微服务架构中担任了什么样的角色，在微服务架构中，注册中心是非常核心的基础服务之一，在微服务流行之前就已经出现在分布式架构中。比如Dubbo，Dubbo在国内是比较流行的分布式架构，也是一个非常实用的框架，提供了比较完备的服务治理功能，而服务治理的实现主要依靠注册中心。</p>
<p>本文中用到的demo源码地址：<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>
<h2 id="什么是注册中心？"><a href="#什么是注册中心？" class="headerlink" title="什么是注册中心？"></a>什么是注册中心？</h2><p>注册中心可以说是微服务架构中的”通讯录“，它记录了服务和服务地址的映射关系。在分布式架构中，服务会注册到这里，当服务需要调用其它服务时，就这里找到服务的地址，进行调用。</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046455713643.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>列举一个比较简单的生活例子：</p>
<ol>
<li>小明要给小红打电话，需要从通讯录(注册中心)中获取到小红的电话号码(服务地址);</li>
<li>小明根据通讯录中的电话号码拨打小红的电话号码(服务请求);</li>
<li>小红接通了电话，并随后完成了通话；</li>
<li>后面再拨打小红的电话号码可以通过电话保存的号码进行拨打(本地缓存);</li>
</ol>
<p>nacos在整个微服务架构中充当了通讯录的角色，服务之间的调用，监控等都需要通过注册中心进行获取服务的地址端口的映射，并且一般服务端都会有本地缓存，下次请求之前会查询本地的服务映射信息，可以减少网络请求提高服务的吞吐量。</p>
<h2 id="什么是配置中心？"><a href="#什么是配置中心？" class="headerlink" title="什么是配置中心？"></a>什么是配置中心？</h2><p>配置中心其实理解起来很简单，就是字面意思，把服务的配置集中在配置中心，可以实现动态的修改，避免了每次修改配置文件都需要重新发布服务的尴尬。</p>
<h2 id="下载nacos，并启动"><a href="#下载nacos，并启动" class="headerlink" title="下载nacos，并启动"></a>下载nacos，并启动</h2><p>Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。下载地址<a href="https://github.com/alibaba/nacos/releases，下载最新版的2.0版本。" target="_blank" rel="noopener">https://github.com/alibaba/nacos/releases，下载最新版的2.0版本。</a></p>
<p>下载完成后，解压，在解压后的文件的/bin目录下，windows系统点击startup.cmd就可以启动nacos。linux或mac执行以下命令启动nacos。</p>
<p>sh startup.sh -m standalone</p>
<p>登陆页面：<a href="http://localhost:8848/nacos/" target="_blank" rel="noopener">http://localhost:8848/nacos/</a> 登陆用户nacos，登陆密码为nacos。</p>
<h2 id="jdk版本"><a href="#jdk版本" class="headerlink" title="jdk版本"></a>jdk版本</h2><ul>
<li>jdk： 1.8</li>
<li>maven： 3.3.9</li>
<li>nacos: 2.0</li>
</ul>
<h2 id="springcloud-和-springboot-版本"><a href="#springcloud-和-springboot-版本" class="headerlink" title="springcloud 和 springboot 版本"></a>springcloud 和 springboot 版本</h2><ul>
<li>springcloud: Hoxton.RELEASE</li>
<li>springboot: 2.2.13.RELEASE</li>
<li>springcloud-alibaba: 2.2.0.RELEASE</li>
</ul>
<h2 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h2><p>首先我们新建一个springboot 基础项目，这里项目命名为：<code>spring-cloud-hoxton-study</code></p>
<h3 id="项目结构："><a href="#项目结构：" class="headerlink" title="项目结构："></a>项目结构：</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml">-spring-cloud-hoxton-study<br>  |—spring-cloud-nacos-consumer<br>  |—pom.xml<br></code></pre></td></tr></table></figure>

<h3 id="父pom文件加入依赖-spring-cloud-hoxton-study-："><a href="#父pom文件加入依赖-spring-cloud-hoxton-study-：" class="headerlink" title="父pom文件加入依赖(spring-cloud-hoxton-study)："></a>父pom文件加入依赖(spring-cloud-hoxton-study)：</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>Hoxton.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.2.13.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud-alibaba.version</span>&gt;</span>2.2.0.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud-alibaba.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- springCloud依赖 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>            <span class="hljs-comment">&lt;!-- springBoot依赖 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>						<span class="hljs-comment">&lt;!-- spring cloud alibaba 依赖 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="子pom修改-spring-cloud-nacos-consumer-：parent"><a href="#子pom修改-spring-cloud-nacos-consumer-：parent" class="headerlink" title="子pom修改(spring-cloud-nacos-consumer)：parent"></a>子pom修改(spring-cloud-nacos-consumer)：parent</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.winterchen<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-hoxton-study<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="子pom加入依赖-spring-cloud-nacos-consumer-："><a href="#子pom加入依赖-spring-cloud-nacos-consumer-：" class="headerlink" title="子pom加入依赖(spring-cloud-nacos-consumer)："></a>子pom加入依赖(spring-cloud-nacos-consumer)：</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>注意：这里只是放了主要的maven依赖，如果需要查看全部的依赖，请查看<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">demo的源码</a></p>
</blockquote>
<h3 id="创建配置：bootstrap-properties-或者-bootstrap-yml"><a href="#创建配置：bootstrap-properties-或者-bootstrap-yml" class="headerlink" title="创建配置：bootstrap.properties 或者 bootstrap.yml"></a>创建配置：<code>bootstrap.properties</code> 或者 <code>bootstrap.yml</code></h3><p>bootstrap.properties</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">spring.cloud.nacos.config.server-addr&#x3D;127.0.0.1:8848<br><br>spring.application.name&#x3D;winter-nacos-consumer<br><br>spring.profiles.active&#x3D;dev<br></code></pre></td></tr></table></figure>

<p>bootstrap.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">winter-nacos-consumer</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>文中的：127.0.0.1:8848 就是上面搭建的nacos服务</p>
</blockquote>
<p>之所以需要配置 <code>spring.application.name</code>是因为nacos默认获取配置文件是按照name作为dataId的</p>
<p>在 Nacos Spring Cloud 中，dataId 的完整格式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">$&#123;prefix&#125;-$&#123;spring.profiles.active&#125;.$&#123;file-extension&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>prefix 默认为 <code>spring.application.name</code> 的值，也可以通过配置项 <code>spring.cloud.nacos.config.prefix</code>来配置。</li>
<li><code>spring.profiles.active</code> 即为当前环境对应的 <code>profile</code>，详情可以参考 <code>Spring Boot</code>文档。 注意：当 <code>spring.profiles.active</code> 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 <code>${prefix}.${file-extension}</code></li>
<li><code>file-exetension</code> 为配置内容的数据格式，可以通过配置项 <code>spring.cloud.nacos.config.file-extension</code> 来配置。目前只支持 <code>properties</code> 和 <code>yaml</code> 类型。</li>
</ul>
<h3 id="在nacos配置中心创建配置文件"><a href="#在nacos配置中心创建配置文件" class="headerlink" title="在nacos配置中心创建配置文件"></a>在nacos配置中心创建配置文件</h3><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046455981185.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>配置详情：</p>
<p>Data ID: <code>winter-nacos-consumer-dev.yaml</code></p>
<p>Group: <code>DEFAULT_GROUP</code></p>
<p>配置内容：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">16011</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br><br><span class="hljs-attr">test:</span><br>  <span class="hljs-attr">config:</span><br>    <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<h3 id="自动刷新"><a href="#自动刷新" class="headerlink" title="自动刷新"></a>自动刷新</h3><p>通过 Spring Cloud 原生注解 @RefreshScope 实现配置自动更新：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Api</span>(<span class="hljs-string">"nacos api"</span>)<br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/nacos"</span>)<br><span class="hljs-meta">@RefreshScope</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NacosController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;test.config.refresh:true&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> refresh;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> CommonResult&lt;Boolean&gt; <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> CommonResult.success(refresh);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="如何测试"><a href="#如何测试" class="headerlink" title="如何测试"></a>如何测试</h3><p>我们可以通过请求上面的接口: <a href="http://127.0.0.1:16011/nacos" target="_blank" rel="noopener">http://127.0.0.1:16011/nacos</a></p>
<p>返回的结果是：true</p>
<p>然后修改一下配置中心的:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">test:<br>  config:<br>    refresh: <span class="hljs-keyword">false</span><br></code></pre></td></tr></table></figure>

<p>可以发现控制台的日志有打印：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-number">2021</span>-<span class="hljs-number">07</span>-<span class="hljs-number">27</span> <span class="hljs-number">11</span>:<span class="hljs-number">25</span>:<span class="hljs-number">13.973</span>  INFO <span class="hljs-number">17240</span> --- [<span class="hljs-number">8.25</span><span class="hljs-number">.36</span><span class="hljs-number">.41_8848</span>] o.s.c.e.event.RefreshEventListener       : Refresh keys changed: [test.config.refresh]<br></code></pre></td></tr></table></figure>

<p>再请求一次就可以发现结果变成了：false</p>
<h2 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046456195432.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<blockquote>
<p>仍然使用上面的项目进行</p>
</blockquote>
<h3 id="添加依赖："><a href="#添加依赖：" class="headerlink" title="添加依赖："></a>添加依赖：</h3><figure class="highlight"><table><tr><td class="code"><pre><code class="hljs java">&lt;!-- Nacos 注册中心 --&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<h3 id="增加配置"><a href="#增加配置" class="headerlink" title="增加配置"></a>增加配置</h3><p>以下是完整的配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">16011</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br><br><span class="hljs-attr">test:</span><br>  <span class="hljs-attr">config:</span><br>    <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>启动类增加：<code>@EnableDiscoveryClient</code> 以启用服务注册与发现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>(exclude= &#123;DataSourceAutoConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>&#125;)</span><br><span class="hljs-class">@<span class="hljs-title">EnableDiscoveryClient</span></span><br><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">SpringCloudNacosApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(SpringCloudNacosApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来需要测试一下服务注册与发现的功能是否正常，所以我们需要<strong>复制</strong>原有的服务<code>spring-cloud-nacos-consumer</code> 并改名为：<code>spring-cloud-nacos-provider</code></p>
<p>当前工程结构：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml">-spring-cloud-hoxton-study<br>  |—spring-cloud-nacos-consumer<br>  |—spring-cloud-nacos-provider<br>  |—pom.xml<br></code></pre></td></tr></table></figure>

<p><code>spring-cloud-nacos-consumer</code> 服务下的<code>NacosController</code> 增加方法：<code>echo</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/nacos"</span>)<br><span class="hljs-meta">@RefreshScope</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NacosController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;test.config.refresh:true&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> refresh;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NacosController</span><span class="hljs-params">(RestTemplate restTemplate)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.restTemplate = restTemplate;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">""</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> refresh;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/echo/&#123;str&#125;"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">echo</span><span class="hljs-params">(@PathVariable String str)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> restTemplate.getForObject(<span class="hljs-string">"http://winter-nacos-provider/nacos/echo/"</span> + str, String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>spring-cloud-nacos-provider</code> 服务下的<code>NacosController</code> 增加方法：<code>echo</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/nacos"</span>)<br><span class="hljs-meta">@RefreshScope</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NacosController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;test.config.refresh:true&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> refresh;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">""</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> refresh;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/echo/&#123;string&#125;"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">echo</span><span class="hljs-params">(@PathVariable String string)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello Nacos Discovery "</span> + string;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="开始测试："><a href="#开始测试：" class="headerlink" title="开始测试："></a>开始测试：</h3><p>测试之前需要给<code>spring-cloud-nacos-provider</code> 进行配置中心的配置：</p>
<ol>
<li>修改<code>bootstrap.yml</code> 的 <code>spring.application.name=winter-nacos-provider</code> ;</li>
<li>在配置中心新增配置文件：<code>winter-nacos-provider-dev.yaml</code> 具体的配置如下:</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">16012</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">118.25</span><span class="hljs-number">.36</span><span class="hljs-number">.41</span><span class="hljs-string">:8848</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br><br><span class="hljs-attr">test:</span><br>  <span class="hljs-attr">config:</span><br>    <span class="hljs-attr">refresh:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>分别启动两个服务，然后调用接口: <a href="http://127.0.0.1:16011/nacos/echo/hello" target="_blank" rel="noopener">http://127.0.0.1:16011/nacos/echo/hello</a></p>
<p>请求的结果：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046456542050.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文介绍了springcloud如何使用nacos作为配置中心和注册中心，作为微服务中比较核心的两个基础功能，需要熟练的在实战中进行使用，后面也会陆续介绍如何与其他的组件进行组合使用。</p>
<p>上面使用的restTemplate进行服务的调用，这样显然在实际的使用当中是非常的不便利的，那么在实际应用中使用什么方式进行远程调用呢？下一篇将介绍如何使用open feign进行远程服务调用的。</p>
<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">https://github.com/WinterChenS/spring-cloud-hoxton-study</a></p>
<p>参考文献：</p>
<p><a href="https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html" target="_blank" rel="noopener">Nacos Spring Cloud 快速开始</a></p>
]]></content>
      <categories>
        <category>springcloud</category>
      </categories>
      <tags>
        <tag>springcloud</tag>
        <tag>Hoxton</tag>
        <tag>nacos</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud系列教程开篇</title>
    <url>/2021/07/23/2021-07-23-spring-cloud-hoxton-1/</url>
    <content><![CDATA[<p>SpringCloud 作为目前最热门的技术之一，拥有众多的开发者的爱戴，开箱即用，简单配置的特性让开发者只需要关注业务代码的开发，无需在繁琐和架构中挣扎。SpringCloud也成为了java开发人员必须了解和使用的技能。</p>
<p>作为系列的开篇，全系列会介绍hoxton的正式版如何使用，也会对一些组件的原理进行介绍，并且会结合实战中的使用着重讲一讲。本文也会照顾初学者，一些详细的配置会深入浅出。</p>
<h2 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h2><ul>
<li>为什么要学习Spring Cloud</li>
<li>什么是Spring Cloud</li>
<li>优缺点</li>
<li>需要的版本</li>
<li>组件的介绍</li>
<li>实战中的应用介绍</li>
</ul>
<h2 id="为什么要学习springcloud"><a href="#为什么要学习springcloud" class="headerlink" title="为什么要学习springcloud"></a>为什么要学习springcloud</h2><p>不论是商业应用还是用户应用，在业务初期都很简单，我们通常会把它实现为单体结构的应用。但是，随着业务逐渐发展，产品思想会变得越来越复杂，单体结构的应用也会越来越复杂。这就会给应用带来如下的几个问题：</p>
<ul>
<li>代码结构混乱：业务复杂，导致代码量很大，管理会越来越困难。同时，这也会给业务的快速迭代带来巨大挑战；</li>
<li>开发效率变低：开发人员同时开发一套代码，很难避免代码冲突。开发过程会伴随着不断解决冲突的过程，这会严重的影响开发效率；</li>
<li>排查解决问题成本高：线上业务发现 bug，修复 bug 的过程可能很简单。但是，由于只有一套代码，需要重新编译、打包、上线，成本很高。</li>
</ul>
<p>由于单体结构的应用随着系统复杂度的增高，会暴露出各种各样的问题。近些年来，微服务架构逐渐取代了单体架构，且这种趋势将会越来越流行。Spring Cloud是目前最常用的微服务开发框架，已经在企业级开发中大量的应用。</p>
<h2 id="什么是Spring-Cloud"><a href="#什么是Spring-Cloud" class="headerlink" title="什么是Spring Cloud"></a>什么是Spring Cloud</h2><p>Spring Cloud是一系列框架的有序集合。它利用Spring Boot的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、智能路由、消息总线、负载均衡、断路器、数据监控等，都可以用Spring Boot的开发风格做到一键启动和部署。Spring Cloud并没有重复制造轮子，它只是将各家公司开发的比较成熟、经得起实际考验的服务框架组合起来，通过Spring Boot风格进行再封装屏蔽掉了复杂的配置和实现原理，最终给开发者留出了一套简单易懂、易部署和易维护的分布式系统开发工具包。</p>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><h3 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h3><ul>
<li>产出于Spring大家族，Spring在企业级开发框架中无人能敌，来头很大，可以保证后续的更新、完善</li>
<li>组件丰富，功能齐全。Spring Cloud 为微服务架构提供了非常完整的支持。例如、配置管理、服务发现、断路器、微服务网关等；</li>
<li>Spring Cloud 社区活跃度很高，教程很丰富，遇到问题很容易找到解决方案</li>
<li>服务拆分粒度更细，耦合度比较低，有利于资源重复利用，有利于提高开发效率</li>
<li>可以更精准的制定优化服务方案，提高系统的可维护性</li>
<li>减轻团队的成本，可以并行开发，不用关注其他人怎么开发，先关注自己的开发</li>
<li>微服务可以是跨平台的，可以用任何一种语言开发</li>
<li>适于互联网时代，产品迭代周期更短</li>
</ul>
<h3 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h3><ul>
<li>微服务过多，治理成本高，不利于维护系统</li>
<li>分布式系统开发的成本高(容错，分布式事务等)对团队挑战大</li>
</ul>
<p>总的来说优点大过于缺点，目前看来Spring Cloud是一套非常完善的分布式框架，目前很多企业开始用微服务、Spring Cloud的优势是显而易见的。因此对于想研究微服务架构的同学来说，学习Spring Cloud是一个不错的选择。</p>
<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>本次教程以Hoxton最新的RELEASE版本进行整合。</p>
<h3 id="为什么使用Hoxton版本？"><a href="#为什么使用Hoxton版本？" class="headerlink" title="为什么使用Hoxton版本？"></a>为什么使用Hoxton版本？</h3><p>因为springboot作为springcloud底层基础设施，所以springcloud与springboot版本需要正确的兼容，不然会在整合的过程中出现很多的问题，各种<code>class not found</code>，<code>method not found</code>。回到问题本身，为什么要使用hoxton版本，那是因为直到目前为止，官方更新的稳定版只有hoxton.release，在生产环境中，最好要使用release版本。</p>
<h3 id="那么初学者如何快速找到合适的版本呢？"><a href="#那么初学者如何快速找到合适的版本呢？" class="headerlink" title="那么初学者如何快速找到合适的版本呢？"></a>那么初学者如何快速找到合适的版本呢？</h3><p>当然是查看<a href="https://spring.io/projects/spring-cloud" target="_blank" rel="noopener">官方文档</a>了</p>
<table>
<thead>
<tr>
<th>Release Train</th>
<th>Boot Version</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2020.0-Release-Notes" target="_blank" rel="noopener">https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2020.0-Release-Notes</a> aka Ilford</td>
<td>2.4.x, 2.5.x (Starting with 2020.0.3)</td>
</tr>
<tr>
<td><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Hoxton-Release-Notes" target="_blank" rel="noopener">https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Hoxton-Release-Notes</a></td>
<td>2.2.x, 2.3.x (Starting with SR5)</td>
</tr>
<tr>
<td><a href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Greenwich-Release-Notes" target="_blank" rel="noopener">https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Greenwich-Release-Notes</a></td>
<td>2.1.x</td>
</tr>
<tr>
<td><a href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Finchley-Release-Notes" target="_blank" rel="noopener">https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Finchley-Release-Notes</a></td>
<td>2.0.x</td>
</tr>
<tr>
<td><a href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Edgware-Release-Notes" target="_blank" rel="noopener">https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Edgware-Release-Notes</a></td>
<td>1.5.x</td>
</tr>
<tr>
<td><a href="https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Dalston-Release-Notes" target="_blank" rel="noopener">https://github.com/spring-projects/spring-cloud/wiki/Spring-Cloud-Dalston-Release-Notes</a></td>
<td>1.5.x</td>
</tr>
</tbody></table>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046454878575.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">springcloud版本</span></p>
<p>由此可以看出最新的稳定版。</p>
<h2 id="组件的介绍"><a href="#组件的介绍" class="headerlink" title="组件的介绍"></a>组件的介绍</h2><p>springcloud家族有着众多的组件，不可能所有的组件都是我们适用的，需要结合业务选择合适的组件使用，其他的组件可以了解一下，后面的教程会结合目前比较热门的方案进行整合使用，下面的表是比较热门的组件介绍：</p>
<table>
<thead>
<tr>
<th>组件名</th>
<th>功能</th>
<th>简介</th>
</tr>
</thead>
<tbody><tr>
<td>spring-cloud-starter-alibaba-nacos-config</td>
<td>配置中心</td>
<td>阿里巴巴开源的nacos配置中心，简单易用，稳定可靠。</td>
</tr>
<tr>
<td>spring-cloud-starter-alibaba-nacos-discovery</td>
<td>服务注册与发现（注册中心）</td>
<td>阿里巴巴开源的nacox注册中心，非常稳定，速度快。</td>
</tr>
<tr>
<td>spring-cloud-openfeign</td>
<td>服务远程调用，服务熔断，负载均衡</td>
<td></td>
</tr>
<tr>
<td>spring-cloud-gateway</td>
<td>服务网关</td>
<td>负责服务的路由，限流，权限验证，请求过滤</td>
</tr>
<tr>
<td>spring-cloud-starter-alibaba-sentinel</td>
<td>服务限流</td>
<td>阿里巴巴开源</td>
</tr>
<tr>
<td>spring-cloud-starter-alibaba-seata</td>
<td>分布式事务组件</td>
<td>阿里巴巴开源</td>
</tr>
</tbody></table>
<p>其它的组件后续会继续讲解。</p>
<h2 id="实战中的应用"><a href="#实战中的应用" class="headerlink" title="实战中的应用"></a>实战中的应用</h2><p>先看一张技术架构图：</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046455117574.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">spring cloud 技术架构图</span></p>
<p>假设现在有一个请求过来，</p>
<ul>
<li>第一站到达gateway网关，gateway负责请求的路由（请求到具体的服务节点），限流权限验证（登录，权限），请求过滤；</li>
<li>第二站，路由到了具体的服务，比如用户中心，用户中心调用课程管理中心接口，课程管理中心服务有很多节点，具体选择哪个节点呢？这时候需要服务的负载均衡，ribbon根据具体的策略进行服务的负载。</li>
<li>如果请求课程管理中心服务的节点超时异常，那么feign集成的hystrix负责服务的熔断，如果不熔断会导致请求阻塞，请求一直积压，最终会导致整个服务器集群宕机，有了服务熔断机制，当服务不可用的时候会将节点设置为不可用状态，并将请求打到其它可用节点，后续会轮询该节点，如果可用会恢复到可用状态。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>讲到了为何使用springcloud以及基础组件的介绍，后续会更加深入的讲解组件的使用。</p>
<p>搭建源码地址：<a href="https://github.com/WinterChenS/spring-cloud-hoxton-study" target="_blank" rel="noopener">WinterChenS/spring-cloud-hoxton-study</a></p>
<h3 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h3><p><a href="https://spring.io/projects/spring-cloud" target="_blank" rel="noopener">Spring Cloud</a></p>
<p><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Hoxton-Release-Notes" target="_blank" rel="noopener">Spring Cloud Hoxton Release Notes · spring-cloud/spring-cloud-release Wiki</a></p>
<p><a href="https://blog.csdn.net/weixin_39786341/article/details/111392364" target="_blank" rel="noopener">springcloud 版本</a></p>
]]></content>
      <categories>
        <category>springcloud</category>
      </categories>
      <tags>
        <tag>springcloud</tag>
      </tags>
  </entry>
  <entry>
    <title>mongodb多数据源之mongotemplate和事务的配置</title>
    <url>/2020/12/28/2020-12-28-mongodb-mutil-source/</url>
    <content><![CDATA[<blockquote>
<p>题图：我的家乡，拍摄于2020年初疫情期间</p>
</blockquote>
<h2 id="maven坐标"><a href="#maven坐标" class="headerlink" title="maven坐标"></a>maven坐标</h2><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.13.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="多数据源配置"><a href="#多数据源配置" class="headerlink" title="多数据源配置"></a>多数据源配置</h2><p>配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">mongodb:</span><br>      <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://192.168.150.154:17017</span><br>      <span class="hljs-attr">database:</span> <span class="hljs-string">ewell-label</span><br>    <span class="hljs-attr">mongodb-target:</span><br>      <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://192.168.150.154:17017</span><br>      <span class="hljs-attr">database:</span> <span class="hljs-string">ewell-label-target</span><br></code></pre></td></tr></table></figure>

<p>java配置：</p>
<p>主数据源：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.label.service.configuration;<br><br><span class="hljs-keyword">import</span> com.mongodb.MongoClient;<br><span class="hljs-keyword">import</span> com.mongodb.MongoClientURI;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Primary;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.MongoDbFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.MongoTransactionManager;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.config.AbstractMongoConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.SimpleMongoDbFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.convert.DefaultDbRefResolver;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.convert.DefaultMongoTypeMapper;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.convert.MappingMongoConverter;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.mapping.MongoMappingContext;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/12/2 3:51 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 业务mongo数据源</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BusinessMongoConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMongoConfiguration</span> </span>&#123;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.data.mongodb.uri&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String uri;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.data.mongodb.database&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String database;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">getDatabaseName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> database;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MongoClient <span class="hljs-title">mongoClient</span><span class="hljs-params">()</span> </span>&#123;<br>        MongoClientURI mongoClientURI = <span class="hljs-keyword">new</span> MongoClientURI(uri);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MongoClient(mongoClientURI);<br>    &#125;<br><br>    <span class="hljs-meta">@Primary</span><br>    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"mongoMappingContext"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MongoMappingContext <span class="hljs-title">mongoMappingContext</span><span class="hljs-params">()</span> </span>&#123;<br>        MongoMappingContext mappingContext = <span class="hljs-keyword">new</span> MongoMappingContext();<br>        <span class="hljs-keyword">return</span> mappingContext;<br>    &#125;<br><br>    <span class="hljs-meta">@Primary</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MongoTransactionManager <span class="hljs-title">transactionManager</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"mongoDbFactory"</span>)</span> MongoDbFactory mongoDbFactory) <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MongoTransactionManager(mongoDbFactory);<br>    &#125;<br><br>    <span class="hljs-meta">@Primary</span><br>    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"mongoDbFactory"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MongoDbFactory <span class="hljs-title">mongoDbFactory</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SimpleMongoDbFactory(mongoClient(), getDatabaseName());<br>    &#125;<br><br>    <span class="hljs-meta">@Primary</span><br>    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"mappingMongoConverter"</span>) <span class="hljs-comment">//使用自定义的typeMapper去除写入mongodb时的“_class”字段</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MappingMongoConverter <span class="hljs-title">mappingMongoConverter</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"mongoDbFactory"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class="hljs-function">                                                       @<span class="hljs-title">Qualifier</span><span class="hljs-params">(<span class="hljs-string">"mongoMappingContext"</span>)</span> MongoMappingContext mongoMappingContext) <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        DefaultDbRefResolver dbRefResolver = <span class="hljs-keyword">new</span> DefaultDbRefResolver(mongoDbFactory);<br>        MappingMongoConverter converter = <span class="hljs-keyword">new</span> MappingMongoConverter(dbRefResolver, mongoMappingContext);<br>        converter.setTypeMapper(<span class="hljs-keyword">new</span> DefaultMongoTypeMapper(<span class="hljs-keyword">null</span>));<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br><br>    <span class="hljs-meta">@Primary</span><br>    <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"mongoTemplate"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MongoTemplate <span class="hljs-title">getMongoTemplate</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"mongoDbFactory"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class="hljs-function">                                          @<span class="hljs-title">Qualifier</span><span class="hljs-params">(<span class="hljs-string">"mappingMongoConverter"</span>)</span> MappingMongoConverter mappingMongoConverter) <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MongoTemplate(mongoDbFactory, mappingMongoConverter);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>第二数据源</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.label.service.configuration;<br><br><span class="hljs-keyword">import</span> com.mongodb.MongoClient;<br><span class="hljs-keyword">import</span> com.mongodb.MongoClientURI;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.MongoDbFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.MongoTransactionManager;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.config.AbstractMongoConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.SimpleMongoDbFactory;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.convert.DefaultDbRefResolver;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.convert.DefaultMongoTypeMapper;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.convert.MappingMongoConverter;<br><span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.mapping.MongoMappingContext;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/12/2 3:53 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> TODO</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TargetMongoConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMongoConfiguration</span> </span>&#123;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.data.mongodb-target.uri&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String uri;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.data.mongodb-target.database&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String database;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">getDatabaseName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> database;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MongoClient <span class="hljs-title">mongoClient</span><span class="hljs-params">()</span> </span>&#123;<br>        MongoClientURI mongoClientURI = <span class="hljs-keyword">new</span> MongoClientURI(uri);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MongoClient(mongoClientURI);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"targetMongoMappingContext"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MongoMappingContext <span class="hljs-title">mongoMappingContext</span><span class="hljs-params">()</span> </span>&#123;<br>        MongoMappingContext mappingContext = <span class="hljs-keyword">new</span> MongoMappingContext();<br>        <span class="hljs-keyword">return</span> mappingContext;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"TARGET_MONGO_TRANSACTION_MANAGER"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MongoTransactionManager <span class="hljs-title">transactionManager</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"targetMongoDbFactory"</span>)</span> MongoDbFactory mongoDbFactory) <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MongoTransactionManager(mongoDbFactory);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"targetMongoDbFactory"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MongoDbFactory <span class="hljs-title">mongoDbFactory</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SimpleMongoDbFactory(mongoClient(), getDatabaseName());<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"targetMappingMongoConverter"</span>) <span class="hljs-comment">//使用自定义的typeMapper去除写入mongodb时的“_class”字段</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MappingMongoConverter <span class="hljs-title">mappingMongoConverter</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"targetMongoDbFactory"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class="hljs-function">                                                       @<span class="hljs-title">Qualifier</span><span class="hljs-params">(<span class="hljs-string">"targetMongoMappingContext"</span>)</span> MongoMappingContext mongoMappingContext) <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        DefaultDbRefResolver dbRefResolver = <span class="hljs-keyword">new</span> DefaultDbRefResolver(mongoDbFactory);<br>        MappingMongoConverter converter = <span class="hljs-keyword">new</span> MappingMongoConverter(dbRefResolver, mongoMappingContext);<br>        converter.setTypeMapper(<span class="hljs-keyword">new</span> DefaultMongoTypeMapper(<span class="hljs-keyword">null</span>));<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * MongoTemplate实现</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"targetMongoTemplate"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MongoTemplate <span class="hljs-title">getMongoTemplate</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"targetMongoDbFactory"</span>)</span> MongoDbFactory mongoDbFactory,</span><br><span class="hljs-function">                                          @<span class="hljs-title">Qualifier</span><span class="hljs-params">(<span class="hljs-string">"mappingMongoConverter"</span>)</span> MappingMongoConverter mappingMongoConverter) <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MongoTemplate(mongoDbFactory, mappingMongoConverter);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>默认的使用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>  <span class="hljs-keyword">private</span> MongoTemplate mongoTemplate;<br></code></pre></td></tr></table></figure>

<p>使用另一个数据源，只需要指定名称即可:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>  <span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"targetMongoTemplate"</span>)<br>  <span class="hljs-keyword">private</span> MongoTemplate targetMongoTemplate;<br></code></pre></td></tr></table></figure>

<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>普通的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span>(rollbackFor = Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><br></code></pre></td></tr></table></figure>

<p>其他数据源指定事务管理器即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span>(rollbackFor = Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">transactionManager</span> </span>= <span class="hljs-string">"TARGET_MONGO_TRANSACTION_MANAGER"</span>)<br></code></pre></td></tr></table></figure>

<p>注意：两种事务不能混合使用</p>
]]></content>
      <categories>
        <category>mongodb</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>mongodb</tag>
        <tag>mongotemplate</tag>
        <tag>transactional</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot集成Oozie实战</title>
    <url>/2020/12/01/2020-12-01-springboot-oozie/</url>
    <content><![CDATA[<p>本文将以springboot调用Oozie的API实现workflow和coordinator等任务的提交停止</p>
<h2 id="前提："><a href="#前提：" class="headerlink" title="前提："></a>前提：</h2><p>关于hadoop的集成，请参考另外一篇文章，这里就过多的赘述：</p>
<p><a href="https://blog.winterchen.com/2020/12/01/2020-12-01-springboot-hadoop-hdfs-mapreduce/">springboot集成hadoop实战</a></p>
<h2 id="maven坐标"><a href="#maven坐标" class="headerlink" title="maven坐标"></a>maven坐标</h2><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-streaming<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-yarn-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>             <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>             <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>         <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-distcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-mapreduce-client-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-hdfs<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-mapreduce-client-jobclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>	<span class="hljs-comment">&lt;!-- oozie --&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.oozie<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>oozie-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>         <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hdfs:</span><br>  <span class="hljs-attr">hdfsPath:</span> <span class="hljs-string">hdfs://bigdata-master:8020</span><br>  <span class="hljs-attr">hdfsName:</span> <span class="hljs-string">bigdata-master</span><br><br><span class="hljs-attr">oozie:</span><br>  <span class="hljs-attr">url:</span> <span class="hljs-string">http://bigdata-master:11000/oozie</span><br>  <span class="hljs-attr">wf:</span><br>    <span class="hljs-attr">application:</span><br>      <span class="hljs-attr">path:</span> <span class="hljs-string">hdfs://bigdata-master:9000/user/oozie/workflow/hiveserver2.xml</span><br>  <span class="hljs-attr">use:</span><br>    <span class="hljs-attr">system:</span><br>      <span class="hljs-attr">libpath:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">libpath:</span> <span class="hljs-string">hdfs://bigdata-master:8020/user/oozie/share/lib</span><br>  <span class="hljs-attr">callback:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">http://172.16.120.29:8080/label/oozie/callback?executeType=$1\&amp;taskType=$2\&amp;callbackId=$3</span><br>  <span class="hljs-attr">jdbc:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:hive2://192.168.150.119:10000/default</span><br>    <span class="hljs-attr">password:</span><br>  <span class="hljs-attr">nameNode:</span> <span class="hljs-string">hdfs://bigdata-master:8020</span><br>  <span class="hljs-attr">resourceManager:</span> <span class="hljs-string">hdfs://bigdata-master:8088</span><br>  <span class="hljs-attr">queueName:</span> <span class="hljs-string">default</span><br>  <span class="hljs-attr">job-tracker:</span> <span class="hljs-string">bigdata-master:8032</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.model;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/19 7:21 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span></span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OozieConfig</span> </span>&#123;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oozie.nameNode&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String nameNode;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oozie.job-tracker&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String jobTracker;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oozie.resourceManager&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String resourceManager;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oozie.queueName&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String queueName;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oozie.url&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String url;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oozie.wf.application.path&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String oozieApplicationPath;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oozie.libpath&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String oozieLibPath;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oozie.use.system.libpath&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> oozieSystemLibPath;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oozie.jdbc.url&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String jdbcUrl;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oozie.jdbc.password&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oozie.callback.url&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String callbackUrl;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="基础类"><a href="#基础类" class="headerlink" title="基础类"></a>基础类</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/23 2:23 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span></span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OozieConstants</span> </span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String NAME_NODE= <span class="hljs-string">"nameNode"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String RESOURCE_MANAGER = <span class="hljs-string">"resourcemanager"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_NAME = <span class="hljs-string">"queueName"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ROOT_DIR = <span class="hljs-string">"rootdir"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String JOB_TRACKER = <span class="hljs-string">"jobTracker"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String JOB_OUTPUT = <span class="hljs-string">"jobOutput"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String JDBC_URL = <span class="hljs-string">"jdbcUrl"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PASSWORD = <span class="hljs-string">"password"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SQL_INPUT = <span class="hljs-string">"sqlInput"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String USER_NAME = <span class="hljs-string">"user.name"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TASK_TYPE = <span class="hljs-string">"taskType"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SHELL_FILE_NAME = <span class="hljs-string">"shellFileName"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SHELL_FILE_PATH = <span class="hljs-string">"shellFilePath"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CALLBACK_ID = <span class="hljs-string">"callbackId"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String WORKFLOW_ROOT = <span class="hljs-string">"workflowRoot"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String START = <span class="hljs-string">"start"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String END = <span class="hljs-string">"end"</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.model;<br><br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.enums.FrequencyTypeEnum;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> lombok.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/25 6:01 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 定时调度任务请求</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@EqualsAndHashCode</span>(callSuper = <span class="hljs-keyword">false</span>)<br><span class="hljs-meta">@ToString</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@ApiModel</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CoordinatorRequest</span> </span>&#123;<br><br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"定时调度任务名称"</span>)<br>    <span class="hljs-keyword">private</span> String coordName;<br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"定时调度任务文件路径"</span>)<br>    <span class="hljs-keyword">private</span> String coordPath;<br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"频率"</span>)<br>    <span class="hljs-keyword">private</span> FrequencyTypeEnum frequencyType;<br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"开始时间"</span>)<br>    <span class="hljs-keyword">private</span> String startTime;<br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"结束时间"</span>)<br>    <span class="hljs-keyword">private</span> String endTime;<br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"workflow名称"</span>)<br>    <span class="hljs-keyword">private</span> String wfName;<br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"workflow路径"</span>)<br>    <span class="hljs-keyword">private</span> String wfPath;<br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"回调编号"</span>)<br>    <span class="hljs-keyword">private</span> String callbackId;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.model;<br><br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModel;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiModelProperty;<br><span class="hljs-keyword">import</span> lombok.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/25 5:33 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> workflow任务请求</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@EqualsAndHashCode</span>(callSuper = <span class="hljs-keyword">false</span>)<br><span class="hljs-meta">@ToString</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@ApiModel</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WorkflowRequest</span> </span>&#123;<br><br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"workflow名称"</span>)<br>    <span class="hljs-keyword">private</span> String wfName;<br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"workflow路径"</span>)<br>    <span class="hljs-keyword">private</span> String wfPath;<br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"执行的sql"</span>)<br>    <span class="hljs-keyword">private</span> String sql;<br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"回调编号"</span>)<br>    <span class="hljs-keyword">private</span> String callbackId;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.service;<br><br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.enums.FrequencyTypeEnum;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.model.CoordinatorRequest;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.model.WorkflowRequest;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/23 2:06 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span></span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OozieService</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> winterchen</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> 提交workflow任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Date</span> 6:21 下午 2020/11/25</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span> [workflowRequest]</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> java.lang.String</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-function">String <span class="hljs-title">submitWorkflow</span><span class="hljs-params">(WorkflowRequest workflowRequest)</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> winterchen</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> 提交coordinator任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Date</span> 6:21 下午 2020/11/25</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span> [coordinatorRequest]</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> java.lang.String</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-function">String <span class="hljs-title">submitCoordinator</span><span class="hljs-params">(CoordinatorRequest coordinatorRequest)</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> winterchen</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> 创建并上传sql文件至hdfs</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Date</span> 6:21 下午 2020/11/25</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span> [sql, sqlPath]</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> java.lang.String 文件地址</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-function">String <span class="hljs-title">createSqlFileAndUpload</span><span class="hljs-params">(String sql, String sqlPath)</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> winterchen</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> 创建并上传workflow任务脚本文件至hdfs</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Date</span> 6:22 下午 2020/11/25</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span> [wfName, wfPath, sqlPath, callbackId]</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> String 文件地址</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-function">String <span class="hljs-title">createWfFileAndUpload</span><span class="hljs-params">(String wfName, String wfPath, String sqlPath, String callbackId)</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> winterchen</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> 创建并上传coordinator定时任务脚本文件至hdfs</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Date</span> 6:23 下午 2020/11/25</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span> [coordName, coordPath, wfPath, frequencyType, callbackId]</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> String 文件地址</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-function">String <span class="hljs-title">createCoordFileAndUpload</span><span class="hljs-params">(String coordName, String coordPath, String wfPath, FrequencyTypeEnum frequencyType, String callbackId)</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> winterchen</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> 创建shell脚本并上传</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Date</span> 6:41 下午 2020/11/25</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span> [shellFileName, shellFilePath]</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> String 文件地址</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-function">String  <span class="hljs-title">createShellFileAndUpload</span><span class="hljs-params">(String shellFileName, String shellFilePath)</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> winterchen</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> 处理回调</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Date</span> 6:24 下午 2020/11/25</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span> [targetType, targetId]</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">executeCallback</span><span class="hljs-params">(String executeType, String taskType, String callbackId)</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> winterchen</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> 停止定时调度任务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Date</span> 6:24 下午 2020/11/25</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span> [jobId]</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> void</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">killCoordinatorJob</span><span class="hljs-params">(String jobId)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.service.impl;<br><br><span class="hljs-keyword">import</span> cn.hutool.core.date.DateUtil;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.constants.OozieConstants;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.enums.FrequencyTypeEnum;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.enums.TaskTypeEnum;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.model.CoordinatorRequest;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.model.OozieConfig;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.model.WorkflowRequest;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.service.OozieService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.apache.hadoop.fs.FileSystem;<br><span class="hljs-keyword">import</span> org.apache.hadoop.fs.Path;<br><span class="hljs-keyword">import</span> org.apache.oozie.client.*;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.OutputStreamWriter;<br><span class="hljs-keyword">import</span> java.io.Writer;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/23 2:06 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span></span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Slf</span>4j<br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OozieServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OozieService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FileSystem fileSystem;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OozieConfig oozieConfig;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OozieServiceImpl</span><span class="hljs-params">(OozieConfig oozieConfig)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.oozieConfig = oozieConfig;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">submitWorkflow</span><span class="hljs-params">(WorkflowRequest workflowRequest)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            OozieClient oozieClient = <span class="hljs-keyword">new</span> OozieClient(oozieConfig.getUrl());<br>            oozieClient.setDebugMode(<span class="hljs-number">1</span>);<br>            Path appPath = <span class="hljs-keyword">new</span> Path(fileSystem.getHomeDirectory(), workflowRequest.getWfPath().concat(workflowRequest.getWfName()).concat(<span class="hljs-string">".xml"</span>));<br>            <span class="hljs-comment">// 创建相关文件</span><br><br>            <span class="hljs-comment">// 创建并上传sql文件</span><br>            String sqlPath = workflowRequest.getWfPath().concat(<span class="hljs-string">"sql/"</span>.concat(workflowRequest.getWfName()).concat(<span class="hljs-string">"-sql.q"</span>));<br>            createSqlFileAndUpload(workflowRequest.getSql(), sqlPath);<br><br>            <span class="hljs-comment">// 创建shell脚本</span><br>            String shellFileName = workflowRequest.getWfName() + <span class="hljs-string">"-shell.sh"</span>;<br>            String shellFilePath = workflowRequest.getWfPath().concat(workflowRequest.getWfName()).concat(<span class="hljs-string">"/shell/"</span>);<br>            String shellPath = createShellFileAndUpload(shellFileName, shellFilePath);<br><br>            <span class="hljs-comment">// 创建并上传wf脚本文件</span><br>            createWfFileAndUpload(workflowRequest.getWfName(), workflowRequest.getWfPath(), sqlPath, workflowRequest.getCallbackId());<br><br>            <span class="hljs-comment">// 创建脚本任务的配置</span><br>            Properties prop = oozieClient.createConfiguration();<br>            prop.setProperty(OozieClient.APP_PATH, appPath.toString());<br>            prop.setProperty(oozieClient.LIBPATH, oozieConfig.getOozieLibPath());<br>            prop.setProperty(oozieClient.USE_SYSTEM_LIBPATH, String.valueOf(oozieConfig.isOozieSystemLibPath()));<br><br>            <span class="hljs-comment">/*Set Your Application Configuration*/</span><br>            prop.setProperty(OozieConstants.NAME_NODE, oozieConfig.getNameNode());<br>            prop.setProperty(OozieConstants.JOB_TRACKER,oozieConfig.getJobTracker());<br>            Path outputPath = <span class="hljs-keyword">new</span> Path(fileSystem.getHomeDirectory(), workflowRequest.getWfPath().concat(<span class="hljs-string">"output/"</span>));<br>            prop.setProperty(OozieConstants.JOB_OUTPUT, outputPath.toString());<br>            prop.setProperty(OozieConstants.JDBC_URL, oozieConfig.getJdbcUrl());<br>            prop.setProperty(OozieConstants.PASSWORD, StringUtils.isEmpty(oozieConfig.getPassword()) ? <span class="hljs-string">""</span> : oozieConfig.getPassword());<br>            prop.setProperty(OozieConstants.SQL_INPUT,workflowRequest.getWfPath().concat(<span class="hljs-string">"sql/"</span>));<br>            prop.setProperty(OozieConstants.USER_NAME,<span class="hljs-string">"admin"</span>);<br>            prop.setProperty(OozieConstants.TASK_TYPE, TaskTypeEnum.WORKFLOW.name());<br>            prop.setProperty(OozieConstants.SHELL_FILE_NAME,shellFileName);<br>            prop.setProperty(OozieConstants.SHELL_FILE_PATH, shellPath);<br>            prop.setProperty(OozieConstants.CALLBACK_ID, workflowRequest.getCallbackId());<br>            prop.setProperty(OozieConstants.QUEUE_NAME, oozieConfig.getQueueName());<br><br>            String jobId = oozieClient.submit(prop);<br>            oozieClient.start(jobId);<br><br>            log.debug(<span class="hljs-string">"workflow job submitted, jobId = &#123;&#125;"</span>, jobId);<br><br>            <span class="hljs-keyword">return</span> jobId;<br>        &#125; <span class="hljs-keyword">catch</span> (OozieClientException e) &#123;<br>            log.error(<span class="hljs-string">"workflow任务提交失败"</span> ,e);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">submitCoordinator</span><span class="hljs-params">(CoordinatorRequest coordinatorRequest)</span> </span>&#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            OozieClient oozieClient = <span class="hljs-keyword">new</span> OozieClient(oozieConfig.getUrl());<br>            oozieClient.setDebugMode(<span class="hljs-number">1</span>);<br>            Path rootPath = <span class="hljs-keyword">new</span> Path(fileSystem.getHomeDirectory(), coordinatorRequest.getCoordPath());<br>            Path appPath = <span class="hljs-keyword">new</span> Path(fileSystem.getHomeDirectory(), coordinatorRequest.getCoordPath()<br>                    .concat(coordinatorRequest.getCoordName()).concat(<span class="hljs-string">".xml"</span>));<br>            Path wf = <span class="hljs-keyword">new</span> Path(fileSystem.getHomeDirectory(), coordinatorRequest.getWfPath());<br>            <span class="hljs-comment">// 创建相关文件</span><br>            <span class="hljs-comment">// 创建并上传定时调度任务脚本</span><br>            createCoordFileAndUpload(coordinatorRequest.getCoordName(),coordinatorRequest.getCoordPath(),<br>                    wf.toString().concat(<span class="hljs-string">"/"</span>).concat(coordinatorRequest.getWfName()).concat(<span class="hljs-string">".xml"</span>),coordinatorRequest.getFrequencyType(), coordinatorRequest.getCallbackId());<br><br>            <span class="hljs-comment">// 创建shell脚本</span><br>            String shellFileName = coordinatorRequest.getWfName() + <span class="hljs-string">"-shell.sh"</span>;<br>            String shellFilePath = coordinatorRequest.getWfPath().concat(coordinatorRequest.getWfName()).concat(<span class="hljs-string">"/shell/"</span>);<br>            String shellPath = createShellFileAndUpload(shellFileName, shellFilePath);<br><br>            <span class="hljs-comment">// 创建脚本任务的配置</span><br>            Properties prop = oozieClient.createConfiguration();<br>            prop.setProperty(OozieClient.COORDINATOR_APP_PATH, appPath.toString());<br>            prop.setProperty(oozieClient.LIBPATH, oozieConfig.getOozieLibPath());<br>            prop.setProperty(oozieClient.USE_SYSTEM_LIBPATH, String.valueOf(oozieConfig.isOozieSystemLibPath()));<br>            prop.setProperty(OozieConstants.JOB_TRACKER,oozieConfig.getJobTracker());<br>            prop.setProperty(OozieConstants.USER_NAME,<span class="hljs-string">"admin"</span>);<br>            prop.setProperty(OozieConstants.WORKFLOW_ROOT, rootPath.toString());<br>            String start = DateUtil.format(DateUtil.parse(coordinatorRequest.getStartTime(), <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>), <span class="hljs-string">"yyyy-MM-dd'T'HH:mm'Z'"</span>);<br>            prop.setProperty(OozieConstants.START, start);<br>            String end = DateUtil.format(DateUtil.parse(coordinatorRequest.getEndTime(), <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>), <span class="hljs-string">"yyyy-MM-dd'T'HH:mm'Z'"</span>);<br>            prop.setProperty(OozieConstants.END, end);<br>            Path outputPath = <span class="hljs-keyword">new</span> Path(fileSystem.getHomeDirectory(), coordinatorRequest.getWfPath().concat(<span class="hljs-string">"output/"</span>));<br>            prop.setProperty(OozieConstants.JOB_OUTPUT, outputPath.toString());<br>            prop.setProperty(OozieConstants.JDBC_URL, oozieConfig.getJdbcUrl());<br>            prop.setProperty(OozieConstants.PASSWORD, StringUtils.isEmpty(oozieConfig.getPassword()) ? <span class="hljs-string">""</span> : oozieConfig.getPassword());<br>            prop.setProperty(OozieConstants.SQL_INPUT,coordinatorRequest.getWfPath().concat(<span class="hljs-string">"sql/"</span>));<br>            prop.setProperty(OozieConstants.TASK_TYPE, TaskTypeEnum.COORDINATOR.name());<br>            prop.setProperty(OozieConstants.SHELL_FILE_NAME,shellFileName);<br>            prop.setProperty(OozieConstants.SHELL_FILE_PATH, shellPath);<br>            prop.setProperty(OozieConstants.CALLBACK_ID, coordinatorRequest.getCallbackId());<br>            prop.setProperty(OozieConstants.QUEUE_NAME, oozieConfig.getQueueName());<br><br>            <span class="hljs-comment">/*Set Your Application Configuration*/</span><br>            prop.setProperty(OozieConstants.NAME_NODE, oozieConfig.getNameNode());<br><br>            String jobId = oozieClient.submit(prop);<br><br>            log.debug(<span class="hljs-string">"workflow job submitted, jobId = &#123;&#125;"</span>, jobId);<br><br>            <span class="hljs-keyword">return</span> jobId;<br>        &#125; <span class="hljs-keyword">catch</span> (OozieClientException e) &#123;<br>            log.error(<span class="hljs-string">"workflow任务提交失败"</span> ,e);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">createSqlFileAndUpload</span><span class="hljs-params">(String sql, String sqlPath)</span> </span>&#123;<br>        Writer writer = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Path sqlP = <span class="hljs-keyword">new</span> Path(fileSystem.getHomeDirectory(),sqlPath);<br>            writer = <span class="hljs-keyword">new</span> OutputStreamWriter(fileSystem.create(sqlP));<br><br>            writer.write(sql);<br>            <span class="hljs-keyword">return</span> sqlP.toString();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(<span class="hljs-string">"创建sql文件失败"</span>, e);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != writer) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    writer.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    log.error(<span class="hljs-string">"关闭流失败"</span>, e);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">createWfFileAndUpload</span><span class="hljs-params">(String wfName, String wfPath, String sqlFileName, String callbackId)</span> </span>&#123;<br>        Writer writer = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Path wf = <span class="hljs-keyword">new</span> Path(fileSystem.getHomeDirectory(),wfPath.concat(wfName).concat(<span class="hljs-string">".xml"</span>));<br>            writer = <span class="hljs-keyword">new</span> OutputStreamWriter(fileSystem.create(wf));<br>            String wfApp =<br>                    <span class="hljs-string">"&lt;workflow-app xmlns='uri:oozie:workflow:0.4' name='"</span> + wfName + <span class="hljs-string">"'&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;start to='my-hive2-action'/&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;action name='my-hive2-action'&gt;\n"</span> +<br>                            <span class="hljs-string">"       &lt;hive2 xmlns='uri:oozie:hive2-action:0.1'&gt;\n"</span> +<br>                            <span class="hljs-string">"           &lt;name-node&gt;$&#123;nameNode&#125;&lt;/name-node&gt;\n"</span> +<br>                            <span class="hljs-string">"           &lt;prepare&gt;\n"</span> +<br>                            <span class="hljs-string">"               &lt;delete path='$&#123;jobOutput&#125;'/&gt;\n"</span> +<br>                            <span class="hljs-string">"           &lt;/prepare&gt;\n"</span> +<br>                            <span class="hljs-string">"           &lt;configuration&gt;\n"</span> +<br>                            <span class="hljs-string">"                &lt;property&gt;\n"</span> +<br>                            <span class="hljs-string">"                    &lt;name&gt;mapred.compress.map.output&lt;/name&gt;\n"</span> +<br>                            <span class="hljs-string">"                    &lt;value&gt;true&lt;/value&gt;\n"</span> +<br>                            <span class="hljs-string">"                &lt;/property&gt;\n"</span> +<br>                            <span class="hljs-string">"           &lt;/configuration&gt;\n"</span> +<br>                            <span class="hljs-string">"           &lt;jdbc-url&gt;$&#123;jdbcUrl&#125;&lt;/jdbc-url&gt;\n"</span> +<br><span class="hljs-comment">//                            "           &lt;password&gt;$&#123;password&#125;&lt;/password&gt;\n" +</span><br>                            <span class="hljs-string">"           &lt;script&gt;"</span> + sqlFileName + <span class="hljs-string">"&lt;/script&gt;\n"</span> +<br>                            <span class="hljs-string">"           &lt;param&gt;InputDir=$&#123;sqlInput&#125;&lt;/param&gt;\n"</span> +<br>                            <span class="hljs-string">"           &lt;param&gt;OutputDir=$&#123;jobOutput&#125;&lt;/param&gt;\n"</span> +<br>                            <span class="hljs-string">"       &lt;/hive2&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;ok to='success-action'/&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;error to='error-action'/&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;/action&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;!-- 成功回调 --&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;action name='success-action'&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;shell xmlns=\"uri:oozie:shell-action:0.2\"&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;job-tracker&gt;$&#123;jobTracker&#125;&lt;/job-tracker&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;name-node&gt;$&#123;nameNode&#125;&lt;/name-node&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;configuration&gt;\n"</span> +<br>                            <span class="hljs-string">"                &lt;property&gt;\n"</span> +<br>                            <span class="hljs-string">"                  &lt;name&gt;mapred.job.queue.name&lt;/name&gt;\n"</span> +<br>                            <span class="hljs-string">"                  &lt;value&gt;$&#123;queueName&#125;&lt;/value&gt;\n"</span> +<br>                            <span class="hljs-string">"                &lt;/property&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;/configuration&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;exec&gt;$&#123;shellFileName&#125;&lt;/exec&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;argument&gt;$&#123;taskType&#125;&lt;/argument&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;argument&gt;OK&lt;/argument&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;argument&gt;$&#123;callbackId&#125;&lt;/argument&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;file&gt;$&#123;shellFilePath&#125;#$&#123;shellFilePath&#125;&lt;/file&gt; &lt;!--Copy the executable to compute node's current working directory --&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;/shell&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;ok to='end' /&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;error to='fail' /&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;/action&gt;\n"</span> +<br>                            <span class="hljs-string">"     \n"</span> +<br>                            <span class="hljs-string">"    &lt;!-- 失败回调 --&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;action name='error-action'&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;shell xmlns=\"uri:oozie:shell-action:0.2\"&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;job-tracker&gt;$&#123;jobTracker&#125;&lt;/job-tracker&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;name-node&gt;$&#123;nameNode&#125;&lt;/name-node&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;configuration&gt;\n"</span> +<br>                            <span class="hljs-string">"                &lt;property&gt;\n"</span> +<br>                            <span class="hljs-string">"                  &lt;name&gt;mapred.job.queue.name&lt;/name&gt;\n"</span> +<br>                            <span class="hljs-string">"                  &lt;value&gt;$&#123;queueName&#125;&lt;/value&gt;\n"</span> +<br>                            <span class="hljs-string">"                &lt;/property&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;/configuration&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;exec&gt;$&#123;shellFileName&#125;&lt;/exec&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;argument&gt;$&#123;taskType&#125;&lt;/argument&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;argument&gt;FAIL&lt;/argument&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;argument&gt;$&#123;callbackId&#125;&lt;/argument&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;file&gt;$&#123;shellFilePath&#125;#$&#123;shellFilePath&#125;&lt;/file&gt; &lt;!--Copy the executable to compute node's current working directory --&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;/shell&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;ok to='end' /&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;error to='fail' /&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;/action&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;kill name='fail'&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;message&gt;执行脚本失败&lt;/message&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;/kill&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;end name='end'/&gt;\n"</span>   +<br>                            <span class="hljs-string">"&lt;/workflow-app&gt;"</span>;<br>            writer.write(wfApp);<br>            <span class="hljs-keyword">return</span> wf.toString();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(<span class="hljs-string">"创建workflow文件失败"</span>, e);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != writer) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    writer.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    log.error(<span class="hljs-string">"关闭流失败"</span>, e);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">createCoordFileAndUpload</span><span class="hljs-params">(String coordName, String coordPath, String wfPath, FrequencyTypeEnum frequencyType, String callbackId)</span> </span>&#123;<br>        Writer writer = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Path coord = <span class="hljs-keyword">new</span> Path(fileSystem.getHomeDirectory(),coordPath.concat(coordName).concat(<span class="hljs-string">".xml"</span>));<br>            writer = <span class="hljs-keyword">new</span> OutputStreamWriter(fileSystem.create(coord));<br>            String frequency = FrequencyTypeEnum.getExpressionByName(frequencyType.name(), <span class="hljs-number">1</span>);<br>            String wfApp =<br>                    <span class="hljs-string">"&lt;coordinator-app name='"</span> + coordName + <span class="hljs-string">"' frequency='"</span> + frequency + <span class="hljs-string">"' start='$&#123;start&#125;' end='$&#123;end&#125;' timezone='Asia/Shanghai'\n"</span> +<br>                            <span class="hljs-string">"                 xmlns='uri:oozie:coordinator:0.4'&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;action&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;workflow&gt;\n"</span> +<br>                            <span class="hljs-string">"            &lt;app-path&gt;"</span> + wfPath + <span class="hljs-string">"&lt;/app-path&gt;\n"</span> +<br>                            <span class="hljs-string">"        &lt;/workflow&gt;\n"</span> +<br>                            <span class="hljs-string">"    &lt;/action&gt;\n"</span> +<br>                            <span class="hljs-string">"&lt;/coordinator-app&gt;"</span>;<br>            writer.write(wfApp);<br>            <span class="hljs-keyword">return</span> coordName.toString();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(<span class="hljs-string">"创建coordinator文件失败"</span>, e);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != writer) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    writer.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    log.error(<span class="hljs-string">"关闭流失败"</span>, e);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">createShellFileAndUpload</span><span class="hljs-params">(String shellFileName, String shellFilePath)</span> </span>&#123;<br>        Writer writer = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Path shellPath = <span class="hljs-keyword">new</span> Path(fileSystem.getHomeDirectory(),shellFilePath.concat(shellFileName));<br>            writer = <span class="hljs-keyword">new</span> OutputStreamWriter(fileSystem.create(shellPath));<br>            String shell =<br>                    <span class="hljs-string">"#!/bin/bash\n"</span> +<br>                    <span class="hljs-string">"echo 'curl "</span> + oozieConfig.getCallbackUrl() + <span class="hljs-string">"';\n"</span> +<br>                    <span class="hljs-string">"curl -X GET "</span> + oozieConfig.getCallbackUrl();<br>            writer.write(shell);<br>            <span class="hljs-keyword">return</span> shellPath.toString();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(<span class="hljs-string">"创建shell文件失败"</span>, e);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != writer) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    writer.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    log.error(<span class="hljs-string">"关闭流失败"</span>, e);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeCallback</span><span class="hljs-params">(String executeType, String taskType, String callbackId)</span> </span>&#123;<br>        <span class="hljs-comment">// TODO</span><br>        log.info(<span class="hljs-string">"回调处理，executeType=&#123;&#125;, taskType=&#123;&#125;, callbackId=&#123;&#125;"</span>, executeType, taskType, callbackId);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">killCoordinatorJob</span><span class="hljs-params">(String jobId)</span> </span>&#123;<br>        OozieClient oozieClient = <span class="hljs-keyword">new</span> OozieClient(oozieConfig.getUrl());<br>        oozieClient.setDebugMode(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            oozieClient.kill(jobId);<br>        &#125; <span class="hljs-keyword">catch</span> (OozieClientException e) &#123;<br>            log.error(<span class="hljs-string">"停止定时任务失败"</span>, e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意：上面调用的hdfs的接口是本文开头提到的前提条件，请到相应的文章集成hdfs，因为这是必须的，需要将脚本文件上传到hdfs才可以在oozie中引用到脚本文件。</p>
<p>控制器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.controller;<br><br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.model.CoordinatorRequest;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.model.WorkflowRequest;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.service.OozieService;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.utils.APIResponse;<br><span class="hljs-keyword">import</span> io.swagger.annotations.Api;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;<br><span class="hljs-keyword">import</span> io.swagger.annotations.ApiParam;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/25 11:10 上午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> TODO</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Api</span>(tags = <span class="hljs-string">"oozie调度任务"</span>)<br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/oozie"</span>)<br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OozieController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OozieService oozieService;<br><br>    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"提交workflow任务"</span>)<br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/job/workflow"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> APIResponse&lt;String&gt; <span class="hljs-title">submitWorkflowJob</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">        @RequestBody WorkflowRequest workflowRequest</span></span><br><span class="hljs-function"><span class="hljs-params">    )</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> APIResponse.success(oozieService.submitWorkflow(workflowRequest));<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"提交coordinator定时调度任务"</span>)<br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/job/coordinator"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> APIResponse&lt;String&gt; <span class="hljs-title">submitCoordJob</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">            @RequestBody CoordinatorRequest coordinatorRequest</span></span><br><span class="hljs-function"><span class="hljs-params">            )</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> APIResponse.success(oozieService.submitCoordinator(coordinatorRequest));<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"停止定时调度任务"</span>)<br>    <span class="hljs-meta">@DeleteMapping</span>(<span class="hljs-string">"/&#123;jobId&#125;"</span>)<br>    <span class="hljs-keyword">public</span> APIResponse&lt;?&gt; killCoordJob(<br>            <span class="hljs-meta">@PathVariable</span>(<span class="hljs-string">"jobId"</span>)<br>            String jobId<br>    ) &#123;<br>        oozieService.killCoordinatorJob(jobId);<br>        <span class="hljs-keyword">return</span> APIResponse.success();<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"处理回调"</span>)<br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/callback"</span>)<br>    <span class="hljs-keyword">public</span> APIResponse&lt;?&gt; executeCallback(<br>            <span class="hljs-meta">@ApiParam</span>(name = <span class="hljs-string">"executeType"</span>, value = <span class="hljs-string">"处理类型"</span>, required = <span class="hljs-keyword">true</span>)<br>            <span class="hljs-meta">@RequestParam</span>(name = <span class="hljs-string">"executeType"</span>, required = <span class="hljs-keyword">true</span>)<br>                    String executeType,<br>            <span class="hljs-meta">@ApiParam</span>(name = <span class="hljs-string">"taskType"</span>, value = <span class="hljs-string">"任务类型"</span>, required = <span class="hljs-keyword">true</span>)<br>            <span class="hljs-meta">@RequestParam</span>(name = <span class="hljs-string">"taskType"</span>, required = <span class="hljs-keyword">true</span>)<br>                    String taskType,<br>            <span class="hljs-meta">@ApiParam</span>(name = <span class="hljs-string">"callbackId"</span>, value = <span class="hljs-string">"回调编号"</span>, required = <span class="hljs-keyword">true</span>)<br>            <span class="hljs-meta">@RequestParam</span>(name = <span class="hljs-string">"callbackId"</span>, required = <span class="hljs-keyword">true</span>)<br>            String callbackId<br>    ) &#123;<br>        oozieService.executeCallback(executeType, taskType, callbackId);<br>        <span class="hljs-keyword">return</span> APIResponse.success();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面实现的主要功能有：提交workflow和coordinator任务，停止任务等功能；</p>
<p>处理回调并不是必须的，可以根据业务要求来实现各种个性化功能；</p>
<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址:"></a>源码地址:</h2><p><a href="https://github.com/WinterChenS/springboot-learning-experience/tree/master/spring-boot-hadoop" target="_blank" rel="noopener">WinterChenS/springboot-learning-experience</a></p>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><ul>
<li><a href="https://oozie-study.readthedocs.io/en/master/Official%20Document/02.%20Example/#java-api" target="_blank" rel="noopener">https://oozie-study.readthedocs.io/en/master/Official Document/02. Example/#java-api</a></li>
<li><a href="https://timepasstechies.com/oozie-workflow-example-shell-action-end-end-configuration/" target="_blank" rel="noopener">https://timepasstechies.com/oozie-workflow-example-shell-action-end-end-configuration/</a></li>
<li><a href="https://oozie.apache.org/docs/3.1.3-incubating/DG_CommandLineTool.html" target="_blank" rel="noopener">https://oozie.apache.org/docs/3.1.3-incubating/DG_CommandLineTool.html</a></li>
<li><a href="https://www.programcreek.com/java-api-examples/?api=org.apache.oozie.client.OozieClient" target="_blank" rel="noopener">https://www.programcreek.com/java-api-examples/?api=org.apache.oozie.client.OozieClient</a></li>
</ul>
]]></content>
      <categories>
        <category>hadoop</category>
      </categories>
      <tags>
        <tag>hadoop</tag>
        <tag>springboot</tag>
        <tag>oozie</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot集成hive实战</title>
    <url>/2020/12/01/2020-12-01-springboot-hive/</url>
    <content><![CDATA[<p>springboot集成hive实现基本的api调用</p>
<h2 id="maven坐标"><a href="#maven坐标" class="headerlink" title="maven坐标"></a>maven坐标</h2><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- hadoop --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-streaming<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-yarn-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-distcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-mapreduce-client-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-hdfs<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-mapreduce-client-jobclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- hive依赖 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hive<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hive-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 中文分词器 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.bestwu<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ik-analyzers<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="配置："><a href="#配置：" class="headerlink" title="配置："></a>配置：</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">hadoop-demo</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">hive:</span> <span class="hljs-comment">#hive数据源</span><br>      <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:hive2://192.168.150.119:10000/default</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">winterchen</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">winterchen</span><br>      <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">org.apache.hive.jdbc.HiveDriver</span><br>    <span class="hljs-attr">common-config:</span> <span class="hljs-comment">#连接池统一配置，应用到所有的数据源</span><br>      <span class="hljs-attr">initialSize:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">minIdle:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">maxIdle:</span> <span class="hljs-number">5</span><br>      <span class="hljs-attr">maxActive:</span> <span class="hljs-number">50</span><br>      <span class="hljs-attr">maxWait:</span> <span class="hljs-number">10000</span><br>      <span class="hljs-attr">timeBetweenEvictionRunsMillis:</span> <span class="hljs-number">10000</span><br>      <span class="hljs-attr">minEvictableIdleTimeMillis:</span> <span class="hljs-number">300000</span><br>      <span class="hljs-attr">validationQuery:</span> <span class="hljs-string">select</span> <span class="hljs-string">'x'</span><br>      <span class="hljs-attr">testWhileIdle:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">testOnBorrow:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">testOnReturn:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">poolPreparedStatements:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">maxOpenPreparedStatements:</span> <span class="hljs-number">20</span><br>      <span class="hljs-attr">filters:</span> <span class="hljs-string">stat</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.hive"</span>, ignoreUnknownFields = <span class="hljs-keyword">false</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HiveJdbcProperties</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> String url;<br><br>    <span class="hljs-keyword">private</span> String type;<br><br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-keyword">private</span> String driverClassName;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.common-config"</span>, ignoreUnknownFields = <span class="hljs-keyword">false</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceCommonProperties</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> initialSize = <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> minIdle;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> maxIdle;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> maxActive;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> maxWait;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> timeBetweenEvictionRunsMillis;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> minEvictableIdleTimeMillis;<br>    <span class="hljs-keyword">private</span> String validationQuery;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> testWhileIdle;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> testOnBorrow;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> testOnReturn;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> poolPreparedStatements;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> maxOpenPreparedStatements;<br>    <span class="hljs-keyword">private</span> String filters;<br><br>    <span class="hljs-keyword">private</span> String mapperLocations;<br>    <span class="hljs-keyword">private</span> String typeAliasPackage;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableConfigurationProperties</span>(&#123;HiveJdbcProperties<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">DataSourceCommonProperties</span>.<span class="hljs-title">class</span>&#125;)</span><br><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">HiveDruidConfiguration</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HiveJdbcProperties hiveJdbcProperties;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DataSourceCommonProperties dataSourceCommonProperties;<br><br>    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"hiveDruidDataSource"</span>) <span class="hljs-comment">//新建bean实例</span><br>    <span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"hiveDruidDataSource"</span>)<span class="hljs-comment">//标识</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DataSource <span class="hljs-title">dataSource</span><span class="hljs-params">()</span></span>&#123;<br>        DruidDataSource datasource = <span class="hljs-keyword">new</span> DruidDataSource();<br><br>        <span class="hljs-comment">//配置数据源属性</span><br>        datasource.setUrl(hiveJdbcProperties.getUrl());<br>        datasource.setUsername(hiveJdbcProperties.getUsername());<br>        datasource.setPassword(hiveJdbcProperties.getPassword());<br>        datasource.setDriverClassName(hiveJdbcProperties.getDriverClassName());<br><br>        <span class="hljs-comment">//配置统一属性</span><br>        datasource.setInitialSize(dataSourceCommonProperties.getInitialSize());<br>        datasource.setMinIdle(dataSourceCommonProperties.getMinIdle());<br>        datasource.setMaxActive(dataSourceCommonProperties.getMaxActive());<br>        datasource.setMaxWait(dataSourceCommonProperties.getMaxWait());<br>        datasource.setTimeBetweenEvictionRunsMillis(dataSourceCommonProperties.getTimeBetweenEvictionRunsMillis());<br>        datasource.setMinEvictableIdleTimeMillis(dataSourceCommonProperties.getMinEvictableIdleTimeMillis());<br>        datasource.setValidationQuery(dataSourceCommonProperties.getValidationQuery());<br>        datasource.setTestWhileIdle(dataSourceCommonProperties.isTestWhileIdle());<br>        datasource.setTestOnBorrow(dataSourceCommonProperties.isTestOnBorrow());<br>        datasource.setTestOnReturn(dataSourceCommonProperties.isTestOnReturn());<br>        datasource.setPoolPreparedStatements(dataSourceCommonProperties.isPoolPreparedStatements());<br>        <span class="hljs-keyword">try</span> &#123;<br>            datasource.setFilters(dataSourceCommonProperties.getFilters());<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            log.error(<span class="hljs-string">"Druid configuration initialization filter error."</span>, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> datasource;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注册jdbcTemplate </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HiveJdbcConfiguration</span> </span>&#123;<br><br>    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"hiveJdbcTemplate"</span>)<br>    <span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"hiveJdbcTemplate"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> JdbcTemplate <span class="hljs-title">jdbcTemplate</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"hiveDruidDataSource"</span>)</span> DataSource dataSource) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JdbcTemplate(dataSource);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="基本api调用"><a href="#基本api调用" class="headerlink" title="基本api调用"></a>基本api调用</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HiveService</span> </span>&#123;<br><br>    <span class="hljs-function">Object <span class="hljs-title">select</span><span class="hljs-params">(String hql)</span></span>;<br><br>    <span class="hljs-function">List&lt;String&gt; <span class="hljs-title">listAllTables</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-function">List&lt;String&gt; <span class="hljs-title">describeTable</span><span class="hljs-params">(String tableName)</span></span>;<br><br>    <span class="hljs-function">List&lt;String&gt; <span class="hljs-title">selectFromTable</span><span class="hljs-params">(String tableName)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.service.impl;<br><br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.service.HiveService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.sql.ResultSet;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.Statement;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Collections;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Slf</span>4j<br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HiveServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HiveService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"hiveJdbcTemplate"</span>)<br>    <span class="hljs-keyword">private</span> JdbcTemplate hiveJdbcTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"hiveDruidDataSource"</span>)<br>    <span class="hljs-keyword">private</span> DataSource hiveDruidDataSource;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">select</span><span class="hljs-params">(String hql)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> hiveJdbcTemplate.queryForObject(hql, Object<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">listAllTables</span><span class="hljs-params">()</span> </span>&#123;<br>        List&lt;String&gt; result = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">try</span> &#123;<br>            Statement statement = hiveDruidDataSource.getConnection().createStatement();<br>            String sql = <span class="hljs-string">"show tables"</span>;<br>            log.info(<span class="hljs-string">"Running: "</span> + sql);<br>            ResultSet resultSet = statement.executeQuery(sql);<br>            <span class="hljs-keyword">while</span> (resultSet.next()) &#123;<br>                result.add(resultSet.getString(<span class="hljs-number">1</span>));<br>            &#125;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException throwables) &#123;<br>            log.error(throwables.getMessage());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> Collections.emptyList();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">describeTable</span><span class="hljs-params">(String tableName)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(tableName))&#123;<br>            <span class="hljs-keyword">return</span> Collections.emptyList();<br>        &#125;<br>        List&lt;String&gt; result = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">try</span> &#123;<br>            Statement statement = hiveDruidDataSource.getConnection().createStatement();<br>            String sql = <span class="hljs-string">"describe "</span> + tableName;<br>            log.info(<span class="hljs-string">"Running"</span> + sql);<br>            ResultSet resultSet = statement.executeQuery(sql);<br>            <span class="hljs-keyword">while</span> (resultSet.next()) &#123;<br>                result.add(resultSet.getString(<span class="hljs-number">1</span>));<br>            &#125;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException throwables) &#123;<br>            log.error(throwables.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> Collections.emptyList();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">selectFromTable</span><span class="hljs-params">(String tableName)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(tableName))&#123;<br>            <span class="hljs-keyword">return</span> Collections.emptyList();<br>        &#125;<br>        List&lt;String&gt; result = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">try</span> &#123;<br>            Statement statement = hiveDruidDataSource.getConnection().createStatement();<br>            String sql = <span class="hljs-string">"select * from "</span> + tableName;<br>            log.info(<span class="hljs-string">"Running"</span> + sql);<br>            ResultSet resultSet = statement.executeQuery(sql);<br>            <span class="hljs-keyword">int</span> columnCount = resultSet.getMetaData().getColumnCount();<br>            String str = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-keyword">while</span> (resultSet.next()) &#123;<br>                str = <span class="hljs-string">""</span>;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; columnCount; i++) &#123;<br>                    str += resultSet.getString(i) + <span class="hljs-string">" "</span>;<br>                &#125;<br>                str += resultSet.getString(columnCount);<br>                log.info(str);<br>                result.add(str);<br>            &#125;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException throwables) &#123;<br>            log.error(throwables.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> Collections.emptyList();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>hive本身就是基于hadoop的MapReduce的一层封装，所以对于hive的操作都是查询和新增等操作，其他的api请参考jdbctemplate接口</p>
<p>源码地址: </p>
<p><a href="https://github.com/WinterChenS/springboot-learning-experience/tree/master/spring-boot-hadoop" target="_blank" rel="noopener">WinterChenS/springboot-learning-experience</a></p>
]]></content>
      <categories>
        <category>hadoop</category>
      </categories>
      <tags>
        <tag>hadoop</tag>
        <tag>hive</tag>
        <tag>springboot</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot集成hadoop实战</title>
    <url>/2020/12/01/2020-12-01-springboot-hadoop-hdfs-mapreduce/</url>
    <content><![CDATA[<p>springboot集成hadoop实现hdfs增删改查</p>
<h2 id="maven坐标"><a href="#maven坐标" class="headerlink" title="maven坐标"></a>maven坐标</h2><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-streaming<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-yarn-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-distcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-mapreduce-client-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-hdfs<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hadoop<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hadoop-mapreduce-client-jobclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;hadoop.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 中文分词器 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.bestwu<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ik-analyzers<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>hdfs的配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hdfs:</span><br>  <span class="hljs-attr">hdfsPath:</span> <span class="hljs-string">hdfs://bigdata-master:8020</span><br>  <span class="hljs-attr">hdfsName:</span> <span class="hljs-string">bigdata-master</span><br></code></pre></td></tr></table></figure>

<p>将fileSystem配置并注册到spring容器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HadoopHDFSConfiguration</span> </span>&#123;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;hdfs.hdfsPath&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String hdfsPath;<br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;hdfs.hdfsName&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String hdfsName;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> org.apache.hadoop.conf.<span class="hljs-function">Configuration  <span class="hljs-title">getConfiguration</span><span class="hljs-params">()</span></span>&#123;<br>        org.apache.hadoop.conf.Configuration configuration = <span class="hljs-keyword">new</span> org.apache.hadoop.conf.Configuration();<br>        configuration.set(<span class="hljs-string">"fs.defaultFS"</span>, hdfsPath);<br>        <span class="hljs-keyword">return</span> configuration;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> FileSystem <span class="hljs-title">getFileSystem</span><span class="hljs-params">()</span></span>&#123;<br>        FileSystem fileSystem = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            fileSystem = FileSystem.get(<span class="hljs-keyword">new</span> URI(hdfsPath), getConfiguration(), hdfsName);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-comment">// TODO Auto-generated catch block</span><br>            log.error(e.getMessage());<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-comment">// TODO Auto-generated catch block</span><br>            log.error(e.getMessage());<br>        &#125; <span class="hljs-keyword">catch</span> (URISyntaxException e) &#123;<br>            <span class="hljs-comment">// TODO Auto-generated catch block</span><br>            log.error(e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> fileSystem;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HDFSService</span> </span>&#123;<br><br>		<span class="hljs-comment">// 创建文件夹</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">makeFolder</span><span class="hljs-params">(String path)</span></span>;<br>		<span class="hljs-comment">// 是否存在文件</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">existFile</span><span class="hljs-params">(String path)</span></span>;<br>		<br>    List&lt;Map&lt;String, Object&gt;&gt; readCatalog(String path);<br><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">createFile</span><span class="hljs-params">(String path, MultipartFile file)</span></span>;<br><br>    <span class="hljs-function">String <span class="hljs-title">readFileContent</span><span class="hljs-params">(String path)</span></span>;<br><br>    List&lt;Map&lt;String, Object&gt;&gt; listFile(String path);<br><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">renameFile</span><span class="hljs-params">(String oldName, String newName)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">deleteFile</span><span class="hljs-params">(String path)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">uploadFile</span><span class="hljs-params">(String path, String uploadPath)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">downloadFile</span><span class="hljs-params">(String path, String downloadPath)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">copyFile</span><span class="hljs-params">(String sourcePath, String targetPath)</span></span>;<br><br>    <span class="hljs-keyword">byte</span>[] openFileToBytes(String path);<br><br>    BlockLocation[] getFileBlockLocations(String path);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HDFSServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HDFSService</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> bufferSize = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">64</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FileSystem fileSystem;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">makeFolder</span><span class="hljs-params">(String path)</span> </span>&#123;<br>        <span class="hljs-keyword">boolean</span> target = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(path)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (existFile(path)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<br>        Path src = <span class="hljs-keyword">new</span> Path(path);<br>        <span class="hljs-keyword">try</span> &#123;<br>            target = fileSystem.mkdirs(src);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> target;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">existFile</span><span class="hljs-params">(String path)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(path))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        Path src = <span class="hljs-keyword">new</span> Path(path);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> fileSystem.exists(src);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; readCatalog(String path) &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(path))&#123;<br>            <span class="hljs-keyword">return</span> Collections.emptyList();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!existFile(path))&#123;<br>            log.error(<span class="hljs-string">"catalog is not exist!!"</span>);<br>            <span class="hljs-keyword">return</span> Collections.emptyList();<br>        &#125;<br><br>        Path src = <span class="hljs-keyword">new</span> Path(path);<br>        FileStatus[] fileStatuses = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            fileStatuses = fileSystem.listStatus(src);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage());<br>        &#125;<br>        List&lt;Map&lt;String, Object&gt;&gt; result = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(fileStatuses.length);<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != fileStatuses &amp;&amp; <span class="hljs-number">0</span> &lt; fileStatuses.length) &#123;<br>            <span class="hljs-keyword">for</span> (FileStatus fileStatus : fileStatuses) &#123;<br>                Map&lt;String, Object&gt; cataLogMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>                cataLogMap.put(<span class="hljs-string">"filePath"</span>, fileStatus.getPath());<br>                cataLogMap.put(<span class="hljs-string">"fileStatus"</span>, fileStatus);<br>                result.add(cataLogMap);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">createFile</span><span class="hljs-params">(String path, MultipartFile file)</span> </span>&#123;<br>        <span class="hljs-keyword">boolean</span> target = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(path)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        String fileName = file.getName();<br>        Path newPath = <span class="hljs-keyword">new</span> Path(path + <span class="hljs-string">"/"</span> + fileName);<br><br>        FSDataOutputStream outputStream = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            outputStream = fileSystem.create(newPath);<br>            outputStream.write(file.getBytes());<br>            target = <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != outputStream) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    outputStream.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    log.error(e.getMessage());<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> target;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">readFileContent</span><span class="hljs-params">(String path)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(path))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!existFile(path)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        Path src = <span class="hljs-keyword">new</span> Path(path);<br><br>        FSDataInputStream inputStream = <span class="hljs-keyword">null</span>;<br>        StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>        <span class="hljs-keyword">try</span> &#123;<br>            inputStream = fileSystem.open(src);<br>            String lineText = <span class="hljs-string">""</span>;<br>            <span class="hljs-keyword">while</span> ((lineText = inputStream.readLine()) != <span class="hljs-keyword">null</span>) &#123;<br>                sb.append(lineText);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != inputStream) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    inputStream.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    log.error(e.getMessage());<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; listFile(String path) &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(path)) &#123;<br>            <span class="hljs-keyword">return</span> Collections.emptyList();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!existFile(path)) &#123;<br>            <span class="hljs-keyword">return</span> Collections.emptyList();<br>        &#125;<br>        List&lt;Map&lt;String,Object&gt;&gt; resultList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>        Path src = <span class="hljs-keyword">new</span> Path(path);<br>        <span class="hljs-keyword">try</span> &#123;<br>            RemoteIterator&lt;LocatedFileStatus&gt; fileIterator = fileSystem.listFiles(src, <span class="hljs-keyword">true</span>);<br>            <span class="hljs-keyword">while</span> (fileIterator.hasNext()) &#123;<br>                LocatedFileStatus next = fileIterator.next();<br>                Path filePath = next.getPath();<br>                String fileName = filePath.getName();<br>                Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>                map.put(<span class="hljs-string">"fileName"</span>, fileName);<br>                map.put(<span class="hljs-string">"filePath"</span>, filePath.toString());<br>                resultList.add(map);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> resultList;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">renameFile</span><span class="hljs-params">(String oldName, String newName)</span> </span>&#123;<br>        <span class="hljs-keyword">boolean</span> target = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(oldName) || StringUtils.isEmpty(newName)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        Path oldPath = <span class="hljs-keyword">new</span> Path(oldName);<br>        Path newPath = <span class="hljs-keyword">new</span> Path(newName);<br>        <span class="hljs-keyword">try</span> &#123;<br>            target = fileSystem.rename(oldPath, newPath);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> target;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">deleteFile</span><span class="hljs-params">(String path)</span> </span>&#123;<br>        <span class="hljs-keyword">boolean</span> target = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(path)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!existFile(path)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        Path src = <span class="hljs-keyword">new</span> Path(path);<br>        <span class="hljs-keyword">try</span> &#123;<br>            target = fileSystem.deleteOnExit(src);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> target;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">uploadFile</span><span class="hljs-params">(String path, String uploadPath)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(path) || StringUtils.isEmpty(uploadPath)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br><br>        Path clientPath = <span class="hljs-keyword">new</span> Path(path);<br><br>        Path serverPath = <span class="hljs-keyword">new</span> Path(uploadPath);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            fileSystem.copyFromLocalFile(<span class="hljs-keyword">false</span>,clientPath,serverPath);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage(), e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">downloadFile</span><span class="hljs-params">(String path, String downloadPath)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(path) || StringUtils.isEmpty(downloadPath)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br><br>        Path clienPath = <span class="hljs-keyword">new</span> Path(path);<br><br>        Path targetPath = <span class="hljs-keyword">new</span> Path(downloadPath);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            fileSystem.copyToLocalFile(<span class="hljs-keyword">false</span>,clienPath, targetPath);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">copyFile</span><span class="hljs-params">(String sourcePath, String targetPath)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(sourcePath) || StringUtils.isEmpty(targetPath)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br><br>        Path oldPath = <span class="hljs-keyword">new</span> Path(sourcePath);<br><br>        Path newPath = <span class="hljs-keyword">new</span> Path(targetPath);<br><br>        FSDataInputStream inputStream = <span class="hljs-keyword">null</span>;<br>        FSDataOutputStream outputStream = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            inputStream = fileSystem.open(oldPath);<br>            outputStream = fileSystem.create(newPath);<br><br>            IOUtils.copyBytes(inputStream,outputStream,bufferSize,<span class="hljs-keyword">false</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != inputStream) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    inputStream.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    log.error(e.getMessage());<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != outputStream) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    outputStream.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    log.error(e.getMessage());<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] openFileToBytes(String path) &#123;<br><br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(path)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!existFile(path)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        Path src = <span class="hljs-keyword">new</span> Path(path);<br>        <span class="hljs-keyword">byte</span>[] result = <span class="hljs-keyword">null</span>;<br>        FSDataInputStream inputStream = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            inputStream = fileSystem.open(src);<br>            result = IOUtils.readFullyToByteArray(inputStream);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(e.getMessage());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != inputStream)&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    inputStream.close();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    log.error(e.getMessage());<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> BlockLocation[] getFileBlockLocations(String path) &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(path)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!existFile(path)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        BlockLocation[] blocks = <span class="hljs-keyword">null</span>;<br>        Path src = <span class="hljs-keyword">new</span> Path(path);<br>        <span class="hljs-keyword">try</span>&#123;<br>            FileStatus fileStatus = fileSystem.getFileStatus(src);<br>            blocks = fileSystem.getFileBlockLocations(fileStatus, <span class="hljs-number">0</span>, fileStatus.getLen());<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            log.error(e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> blocks;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="mapReduce"><a href="#mapReduce" class="headerlink" title="mapReduce"></a>mapReduce</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.reduce;<br><br><span class="hljs-keyword">import</span> org.apache.hadoop.io.IntWritable;<br><span class="hljs-keyword">import</span> org.apache.hadoop.io.LongWritable;<br><span class="hljs-keyword">import</span> org.apache.hadoop.io.Text;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapreduce.Reducer;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 继承Reducer类需要定义四个输出、输出类型泛型：</span><br><span class="hljs-comment"> * 四个泛型类型分别代表：</span><br><span class="hljs-comment"> * KeyIn        Reducer的输入数据的Key，这里是每行文字中的单词"hello"</span><br><span class="hljs-comment"> * ValueIn      Reducer的输入数据的Value，这里是每行文字中的次数</span><br><span class="hljs-comment"> * KeyOut       Reducer的输出数据的Key，这里是每行文字中的单词"hello"</span><br><span class="hljs-comment"> * ValueOut     Reducer的输出数据的Value，这里是每行文字中的出现的总次数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WordReduce</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Reducer</span>&lt;<span class="hljs-title">Text</span>, <span class="hljs-title">IntWritable</span>, <span class="hljs-title">Text</span>, <span class="hljs-title">IntWritable</span>&gt; </span>&#123;<br><br>    <span class="hljs-keyword">private</span> IntWritable result = <span class="hljs-keyword">new</span> IntWritable();<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; textList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reduce</span><span class="hljs-params">(Text key, Iterable&lt;IntWritable&gt; values, Context context)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException </span>&#123;<br>        <span class="hljs-keyword">int</span> sum = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (IntWritable val : values) &#123;<br>            sum += val.get();<br>        &#125;<br>        result.set(sum);<br>        context.write(key, result);<br><br>        String keyStr = key.toString();<br><br>        <span class="hljs-comment">// 使用分词器，内容已经被统计好了，直接输出即可</span><br>        <span class="hljs-keyword">if</span> (textList.contains(keyStr)) &#123;<br>            System.out.println(<span class="hljs-string">"============ "</span> + keyStr + <span class="hljs-string">" 统计分词为: "</span> + sum + <span class="hljs-string">" ============"</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.configuration;<br><br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.HadoopDemoApplication;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.mapper.WordMapper;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.reduce.WordReduce;<br><span class="hljs-keyword">import</span> org.apache.hadoop.conf.Configuration;<br><span class="hljs-keyword">import</span> org.apache.hadoop.fs.Path;<br><span class="hljs-keyword">import</span> org.apache.hadoop.io.IntWritable;<br><span class="hljs-keyword">import</span> org.apache.hadoop.io.Text;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapreduce.Job;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;<br><span class="hljs-keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReduceJobsConfiguration</span> </span>&#123;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;hdfs.hdfsPath&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String hdfsPath;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取HDFS配置信息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Configuration <span class="hljs-title">getConfiguration</span><span class="hljs-params">()</span> </span>&#123;<br>        Configuration configuration = <span class="hljs-keyword">new</span> Configuration();<br>        configuration.set(<span class="hljs-string">"fs.defaultFS"</span>, hdfsPath);<br>        configuration.set(<span class="hljs-string">"mapred.job.tracker"</span>, hdfsPath);<br>        <span class="hljs-keyword">return</span> configuration;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取单词统计的配置信息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> jobName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> inputPath</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> outputPath</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> ClassNotFoundException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> InterruptedException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getWordCountJobsConf</span><span class="hljs-params">(String jobName, String inputPath, String outputPath)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;<br>        Configuration conf = getConfiguration();<br>        Job job = Job.getInstance(conf, jobName);<br><br>        job.setMapperClass(WordMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        job.setCombinerClass(WordReduce<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        job.setJarByClass(HadoopDemoApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        job.setReducerClass(WordReduce<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>        job.setOutputKeyClass(Text<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        job.setOutputValueClass(IntWritable<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>        FileInputFormat.addInputPath(job, <span class="hljs-keyword">new</span> Path(inputPath));<br>        FileOutputFormat.setOutputPath(job, <span class="hljs-keyword">new</span> Path(outputPath));<br>        job.waitForCompletion(<span class="hljs-keyword">true</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getPath</span><span class="hljs-params">()</span> </span>&#123;<br>        hdfsPath = <span class="hljs-keyword">this</span>.hdfsPath;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getHdfsPath</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> hdfsPath;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MapReduceService</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wordCount</span><span class="hljs-params">(String jobName, String inputPath, String outputPath)</span> <span class="hljs-keyword">throws</span> Exception</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.service.impl;<br><br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.configuration.ReduceJobsConfiguration;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.service.HDFSService;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.service.MapReduceService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MapReduceServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MapReduceService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HDFSService hdfsService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ReduceJobsConfiguration reduceJobsConfiguration;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">wordCount</span><span class="hljs-params">(String jobName, String inputPath, String outputPath)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(jobName) || StringUtils.isEmpty(inputPath)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 输出目录 = output/当前Job,如果输出路径存在则删除，保证每次都是最新的</span><br>        <span class="hljs-keyword">if</span> (hdfsService.existFile(outputPath)) &#123;<br>            hdfsService.deleteFile(outputPath);<br>        &#125;<br>        reduceJobsConfiguration.getWordCountJobsConf(jobName, inputPath, outputPath);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.hadoopdemo.service.impl;<br><br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.configuration.ReduceJobsConfiguration;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.service.HDFSService;<br><span class="hljs-keyword">import</span> com.winterchen.hadoopdemo.service.MapReduceService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MapReduceServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MapReduceService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HDFSService hdfsService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ReduceJobsConfiguration reduceJobsConfiguration;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">wordCount</span><span class="hljs-params">(String jobName, String inputPath, String outputPath)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(jobName) || StringUtils.isEmpty(inputPath)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 输出目录 = output/当前Job,如果输出路径存在则删除，保证每次都是最新的</span><br>        <span class="hljs-keyword">if</span> (hdfsService.existFile(outputPath)) &#123;<br>            hdfsService.deleteFile(outputPath);<br>        &#125;<br>        reduceJobsConfiguration.getWordCountJobsConf(jobName, inputPath, outputPath);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<br><span class="hljs-meta">@Api</span>(tags = <span class="hljs-string">"map reduce api"</span>)<br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/api/v1/map-reduce"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MapReduceController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MapReduceService mapReduceService;<br><br>    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"count word"</span>)<br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/word/count"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> APIResponse <span class="hljs-title">wordCount</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">            @ApiParam(name = <span class="hljs-string">"jobName"</span>, required = <span class="hljs-keyword">true</span>)</span></span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(name = <span class="hljs-string">"jobName"</span>, required = <span class="hljs-keyword">true</span>)</span></span><br><span class="hljs-function">            String jobName,</span><br><span class="hljs-function">            @<span class="hljs-title">ApiParam</span><span class="hljs-params">(name = <span class="hljs-string">"inputPath"</span>, required = <span class="hljs-keyword">true</span>)</span></span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(name = <span class="hljs-string">"inputPath"</span>, required = <span class="hljs-keyword">true</span>)</span></span><br><span class="hljs-function">            String inputPath,</span><br><span class="hljs-function">            @<span class="hljs-title">ApiParam</span><span class="hljs-params">(name = <span class="hljs-string">"outputPath"</span>, required = <span class="hljs-keyword">true</span>)</span></span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(name = <span class="hljs-string">"outputPath"</span>, required = <span class="hljs-keyword">true</span>)</span></span><br><span class="hljs-function">            String outputPath</span><br><span class="hljs-function">    )</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            mapReduceService.wordCount(jobName, inputPath, outputPath);<br>            <span class="hljs-keyword">return</span> APIResponse.success();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(e.getMessage());<br>            <span class="hljs-keyword">return</span> APIResponse.fail(e.getMessage());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上就是日常开发中能使用到的基本的功能：hdfs的增删改查，以及MapReduce；</p>
<p>源码地址: </p>
<p><a href="https://github.com/WinterChenS/springboot-learning-experience/tree/master/spring-boot-hadoop" target="_blank" rel="noopener">WinterChenS/springboot-learning-experience</a></p>
]]></content>
      <categories>
        <category>hadoop</category>
      </categories>
      <tags>
        <tag>hadoop</tag>
        <tag>springboot</tag>
        <tag>hdfs</tag>
      </tags>
  </entry>
  <entry>
    <title>mapstruct 高级用法之userid转换为username</title>
    <url>/2020/11/30/2020-11-30-mapstruct-convert-userid-to-username/</url>
    <content><![CDATA[<p>mapstruct的简单用法就不讲了，看完这篇文章能获得什么呢？</p>
<ul>
<li>1.普通用法：将userId转换为userName？</li>
<li>2.高级用法：一劳永逸的将userId转换为userName？</li>
</ul>
<p>很多时候在数据库里面只有userid而没有username的冗余信息，在entity转换为dto，vo等模型的时候需要额外的设值，mapstruct可以很方便的进行对象之间的转换，那么接下来我们就开始吧</p>
<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/27 4:52 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 项目信息</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@ToString</span><br><span class="hljs-meta">@ApiModel</span>(<span class="hljs-string">"项目信息"</span>)<br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@EqualsAndHashCode</span>(callSuper=<span class="hljs-keyword">false</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProjectDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">2601073448289463936L</span>;<br><br>		<span class="hljs-comment">// ... 省略部分字段</span><br>		<br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"创建人"</span>)<br>    <span class="hljs-keyword">private</span> String createUserId;<br>		<br>		<span class="hljs-comment">// 这里一定不能使用String类型，必须要自己包装一个简单的类型，因为mapstruct是根据类型进行转换的</span><br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"创建人名称"</span>)<br>    <span class="hljs-keyword">private</span> SimpleUserDTO createUserName;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@ToString</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@ApiModel</span>(<span class="hljs-string">"基本用户信息"</span>)<br><span class="hljs-meta">@EqualsAndHashCode</span>(callSuper=<span class="hljs-keyword">false</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleUserDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">6889842645997918707L</span>;<br><br>    <span class="hljs-meta">@ApiModelProperty</span>(<span class="hljs-string">"用户名"</span>)<br>    <span class="hljs-keyword">private</span> String userName;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/27 4:52 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 项目信息</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@ToString</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@Document</span>(collection = <span class="hljs-string">"project"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Project</span> </span>&#123;<br><br>		<span class="hljs-comment">// ... 省略部分字段   </span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建人</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@CreatedBy</span><br>    <span class="hljs-keyword">private</span> String createUserId;<br><br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="普通用法"><a href="#普通用法" class="headerlink" title="普通用法"></a>普通用法</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/28 1:48 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span></span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Mapper</span>(componentModel = <span class="hljs-string">"spring"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProjectMapping</span></span>&#123;<br>		<br>		<span class="hljs-comment">// 博主这里使用的是mongodb，这里可以换成你对应的查询用户信息的类</span><br>		<span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">protected</span> MongoTemplate mongoTemplate;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * 这里的注释主要是指定需要转换的source到target的信息，mapstruct会根据类型进行相应的转换</span><br><span class="hljs-comment">		 * 比如 String-&gt; SimpleUserDTO</span><br><span class="hljs-comment">		 * 所以我们需要指定属性名称，然后mapstruct会根据属性类型调用方法 SimpleUserDTO toConvertToUserName(String userId) </span><br><span class="hljs-comment">		 **/</span><br>    <span class="hljs-meta">@Mappings</span>(&#123;<br>            <span class="hljs-meta">@Mapping</span>(target = <span class="hljs-string">"createUserName"</span>, source = <span class="hljs-string">"createUserId"</span>)<br>    &#125;)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> ProjectDTO <span class="hljs-title">toConvertToDto</span><span class="hljs-params">(Project project)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> List&lt;ProjectDTO&gt; <span class="hljs-title">toConvertToDtos</span><span class="hljs-params">(List&lt;Project&gt; projects)</span></span>;<br><br>		<span class="hljs-function"><span class="hljs-keyword">protected</span> SimpleUserDTO <span class="hljs-title">toConvertToUserName</span><span class="hljs-params">(String userId)</span> </span>&#123;<br>	        Query query = <span class="hljs-keyword">new</span> Query(Criteria.where(<span class="hljs-string">"id"</span>).is(userId));<br>	        User user = mongoTemplate.findOne(query, User<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>	        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != user) &#123;<br>	            SimpleUserDTO result = SimpleUserDTO.builder()<br>	                    .userName(user.getUserName())<br>	                    .build();<br>	            <span class="hljs-keyword">return</span> result;<br>	        &#125;<br>	        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>注意点：没有使用interface而是使用abstract抽象类，主要原因是因为需要有自己的实现方法来转换userid到username</li>
</ul>
<p>我们看看maven编译之后的实现类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Generated</span>(<br>    value = <span class="hljs-string">"org.mapstruct.ap.MappingProcessor"</span>,<br>    date = <span class="hljs-string">"2020-11-28T16:43:17+0800"</span>,<br>    comments = <span class="hljs-string">"version: 1.3.1.Final, compiler: javac, environment: Java 1.8.0_251 (Oracle Corporation)"</span><br>)<br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProjectMappingImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ProjectMapping</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ProjectDTO <span class="hljs-title">toConvertToDto</span><span class="hljs-params">(Project project)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> ( project == <span class="hljs-keyword">null</span> ) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        ProjectDTOBuilder projectDTO = ProjectDTO.builder();<br>				<span class="hljs-comment">// 重点看这里，mapstruct生成的实现类会自动调用我们定义的方法</span><br>        projectDTO.createUserName( toConvertToUserName( project.getCreateUserId() ) );<br>        projectDTO.createUserId( project.getCreateUserId() );<br>        <span class="hljs-keyword">return</span> projectDTO.build();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;ProjectDTO&gt; <span class="hljs-title">toConvertToDtos</span><span class="hljs-params">(List&lt;Project&gt; projects)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> ( projects == <span class="hljs-keyword">null</span> ) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        List&lt;ProjectDTO&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;ProjectDTO&gt;( projects.size() );<br>        <span class="hljs-keyword">for</span> ( Project project : projects ) &#123;<br>            list.add( toConvertToDto( project ) );<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br><br>		<span class="hljs-function"><span class="hljs-keyword">protected</span> SimpleUserDTO <span class="hljs-title">toConvertToUserName</span><span class="hljs-params">(String userId)</span> </span>&#123;<br>		        Query query = <span class="hljs-keyword">new</span> Query(Criteria.where(<span class="hljs-string">"id"</span>).is(userId));<br>		        User user = mongoTemplate.findOne(query, User<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>		        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != user) &#123;<br>		            SimpleUserDTO result = SimpleUserDTO.builder()<br>		                    .userName(user.getUserName())<br>		                    .build();<br>		            <span class="hljs-keyword">return</span> result;<br>		        &#125;<br>		        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回的结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">"code"</span>: <span class="hljs-number">200</span>,<br>  <span class="hljs-attr">"data"</span>: &#123;<br>    <span class="hljs-attr">"createUserId"</span>: <span class="hljs-string">"5fb476444dfa732e47790966"</span>,<br>    <span class="hljs-attr">"createUserName"</span>: &#123;<br>      <span class="hljs-attr">"userName"</span>: <span class="hljs-string">"winter"</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">"message"</span>: <span class="hljs-string">"操作成功"</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="高级用法：一劳永逸型用法"><a href="#高级用法：一劳永逸型用法" class="headerlink" title="高级用法：一劳永逸型用法"></a>高级用法：一劳永逸型用法</h2><p>所谓的一劳永逸主要是解决每次都要写实现就很烦了，所以就要实现写一次后面都不用实现了，思路是这样的，ProjectMapping抽象类继续往上抽象一层，将上述的转换方法抽到上一层，以后有需要转换userid到username的需求只需要继承那个抽象类（BaseMapping）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/28 4:31 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span> 基本的mapping</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseMapping</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">protected</span> MongoTemplate mongoTemplate;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> SimpleUserDTO <span class="hljs-title">toConvertToUserName</span><span class="hljs-params">(String userId)</span> </span>&#123;<br>        Query query = <span class="hljs-keyword">new</span> Query(Criteria.where(<span class="hljs-string">"id"</span>).is(userId));<br>        User user = mongoTemplate.findOne(query, User<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != user) &#123;<br>            SimpleUserDTO result = SimpleUserDTO.builder()<br>                    .userName(user.getUserName())<br>                    .build();<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> winterchen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020/11/28 1:48 下午</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@description</span></span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">@Mapper</span>(componentModel = <span class="hljs-string">"spring"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProjectMapping</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseMapping</span></span>&#123;<br><br>    <span class="hljs-meta">@Mappings</span>(&#123;<br>            <span class="hljs-meta">@Mapping</span>(target = <span class="hljs-string">"createUserName"</span>, source = <span class="hljs-string">"createUserId"</span>)<br>    &#125;)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> ProjectDTO <span class="hljs-title">toConvertToDto</span><span class="hljs-params">(Project project)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> List&lt;ProjectDTO&gt; <span class="hljs-title">toConvertToDtos</span><span class="hljs-params">(List&lt;Project&gt; projects)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上就可以使用了，只需要继承这个抽象类就可以，前提是DTO，VO中的属性类型是SimpleUserDTO</p>
<h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><p>按照这种方式其实可以举一反三，以后遇到需要获取源对象内子对象的某个属性到DTO、VO的属性字段也可以使用这种方式</p>
]]></content>
      <categories>
        <category>springboot</category>
      </categories>
      <tags>
        <tag>mapstruct</tag>
      </tags>
  </entry>
  <entry>
    <title>站点托管CDN加速的平台vercel使用之组织免费使用</title>
    <url>/2020/08/28/2020-08-28-vercel-use/</url>
    <content><![CDATA[<blockquote>
<p>vercel是什么？</p>
</blockquote>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>vercel是一个站点托管平台，提供CDN加速，同类的平台有Netlify 和 Github Pages，相比之下，vercel国内的访问速度更快，并且提供Production环境和development环境，对于项目开发非常的有用的，并且支持持续集成，一次push或者一次PR会自动化构建发布，发布在development环境，都会生成不一样的链接可供预览。</p>
<p>但是vercel只是针对个人用户免费，teams是收费的，对于Organization用户来说成本还是挺高的，那么如果在Organization Project在vercel中免费呢？</p>
<h3 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h3><p>我们可以选择绕过vercel的产品定位策略，vercel提供了CLI生成个人项目，那么我们可以利用github action部署到vercel，下面来讲讲具体的实现方案：</p>
<p>1.用户将代码push到github；<br>2.触发github action构建，使用vercel的action将当前代码库的文件推送到vercel；<br>3.vercel进行构建部署；</p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><h4 id="创建一个项目"><a href="#创建一个项目" class="headerlink" title="创建一个项目"></a>创建一个项目</h4><p>如果已经存在仓库，clone该仓库到安装过nodejs的电脑，不存在仓库新建一个项目并且push到github。</p>
<h4 id="安装vercel-cli"><a href="#安装vercel-cli" class="headerlink" title="安装vercel cli"></a>安装vercel cli</h4><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">npm i -g vercel<br></code></pre></td></tr></table></figure>

<h4 id="部署项目"><a href="#部署项目" class="headerlink" title="部署项目"></a>部署项目</h4><p>因为vercel不支持网页端创建项目，只支持CLI创建项目，所以我们这一步的目的就是创建项目，后续的构建和发布直接使用github action 持续集成部署。</p>
<p>进入项目根目录执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">vercel<br></code></pre></td></tr></table></figure>
<p>按照需求进行配置相关信息即可创建项目，最重要的是project.json内的项目相关信息</p>
<p>会打印出创建的项目相关的信息，orgid 和 projectid （非常重要的参数）</p>
<h4 id="获取相关配置"><a href="#获取相关配置" class="headerlink" title="获取相关配置"></a>获取相关配置</h4><h5 id="github"><a href="#github" class="headerlink" title="github"></a>github</h5><p><a href="https://github.com/settings/tokens" target="_blank" rel="noopener">获取Github Access Token</a></p>
<h5 id="vercel"><a href="#vercel" class="headerlink" title="vercel"></a>vercel</h5><p>项目根目录运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">cat .vercel&#x2F;project.json<br></code></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">&#123;&quot;orgId&quot;:&quot;r359XAnYONVAmiXtdxZ22A2E&quot;,&quot;projectId&quot;:&quot;Qma3GdwoiAfJSsbsSydBgaCDh8LJj6wTWvvqpUwrN6J2F3&quot;&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><p>Org ID：标示用户的Id，对应project.json中的orgId</p>
</li>
<li><p>Project ID：项目的标示，对应project.json中的projectId</p>
</li>
<li><p>Vercel Token： <a href="https://vercel.com/account/tokens" target="_blank" rel="noopener">点击Create</a></p>
</li>
</ol>
<h5 id="配置github-Secret"><a href="#配置github-Secret" class="headerlink" title="配置github Secret"></a>配置github Secret</h5><p>github action可以获取Secret参数，一些敏感信息可以设置到Secret中，并且以变量的方式传入到github action的参数中。</p>
<p>打开github项目的Setting -&gt; Secret，点击 new secret创建三个配置</p>
<ul>
<li>VERCEL_TOKEN：上一步的Vercel Token</li>
<li>ORG_ID：  上一步的Org ID</li>
<li>PROJECT_ID：上一步的Project ID</li>
</ul>
<p>配置好这些参数就可以进行github action脚本的编写了</p>
<h4 id="编写Github-Action脚本"><a href="#编写Github-Action脚本" class="headerlink" title="编写Github Action脚本"></a>编写Github Action脚本</h4><p>在github中创建action（具体方法自行搜索）</p>
<p>使用了<code>amondnet/vercel-action@v19.0.1+3</code> 组件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">- name: Vercel Action<br>      # You may pin to the exact commit or the version.<br>      # uses: amondnet&#x2F;vercel-action@77cb0ce3642a451f7f18d63821c0e26f7adead9a<br>      uses: amondnet&#x2F;vercel-action@v19.0.1+3<br>      with:<br>        # Vercel token<br>        vercel-token: $&#123;&#123; secrets.VERCEL_TOKEN &#125;&#125;<br>        # <br>        # if you want to comment on pr and commit, set token<br>        github-token: $&#123;&#123; secrets.OP_TOKEN &#125;&#125; # optional<br>        # if you want to create github deployment, set true, default: false<br>        github-deployment: false # optional, default is false<br>        # the working directory<br>        working-directory: .&#x2F; # optional<br>        # Vercel CLI 17+, ❗️  The &#96;name&#96; property in vercel.json is deprecated (https:&#x2F;&#x2F;zeit.ink&#x2F;5F)<br>        vercel-project-id: $&#123;&#123; secrets.PROJECT_ID&#125;&#125; # optional<br>        # Vercel CLI 17+, ❗️  The &#96;name&#96; property in vercel.json is deprecated (https:&#x2F;&#x2F;zeit.ink&#x2F;5F)<br>        vercel-org-id: $&#123;&#123; secrets.ORG_ID&#125;&#125; # optional<br>        vercel-args: &#39;--prod&#39; #这是一个关键点，这里执行生产生产环境还是开发环境，默认是测试环境<br></code></pre></td></tr></table></figure>

<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><p>完整的案例：<a href="https://github.com/sam-bo/blog_back" target="_blank" rel="noopener">https://github.com/sam-bo/blog_back</a></p>
<p>案例里面的其它脚本可以忽略，根据实际的情况进行编写。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>安装上面的步骤，代码提交之后就可以自动构建了，是不是很简单呢？</p>
<p>vercel在国内的访问速度可以秒杀github pages了，vercel虽然不支持组织，利用这种方式我们可以免费使用。</p>
]]></content>
      <categories>
        <category>github</category>
      </categories>
      <tags>
        <tag>share</tag>
      </tags>
  </entry>
  <entry>
    <title>整理了一个资源分享的站点-tool.winterchen.com</title>
    <url>/2020/08/26/2020-08-26-new-source-site/</url>
    <content><![CDATA[<p>花了点时间把所有使用过，并且非常好用的网站整理出来</p>
<p>主要类别有：游戏，开发工具，设计工具</p>
<p>后期规划：chrome插件，github开源项目，图片网站等等，如果有好的资源可以留言告诉博主</p>
<p>网址：<a href="https://tools.winterchen.com" target="_blank" rel="noopener">https://tools.winterchen.com</a></p>
<iframe src="https://tools.winterchen.com" width="700px" height="700px" frameborder="0" scrolling="yes"> </iframe>]]></content>
      <categories>
        <category>share</category>
      </categories>
      <tags>
        <tag>share</tag>
      </tags>
  </entry>
  <entry>
    <title>软件分享-免费的网站状态监控平台</title>
    <url>/2020/08/25/2020-08-25-share-tools/</url>
    <content><![CDATA[<blockquote>
<p>有段时间没有更新了，今天分享一下一个很有用的工具：<a href="https://uptimerobot.com/" target="_blank" rel="noopener">uptimerobot</a>,可以用来监控树莓派是否宕机，nacos注册中心是否可用等等</p>
</blockquote>
<h4 id="主要功能："><a href="#主要功能：" class="headerlink" title="主要功能："></a>主要功能：</h4><ul>
<li>网站状态监控</li>
<li>网站状态警报</li>
</ul>
<h4 id="使用感受"><a href="#使用感受" class="headerlink" title="使用感受"></a>使用感受</h4><p>免费版有50个站点，最低5分钟检测的限制，一般人足够了，一个有意思的地方就是可以创建一个public的页面并且绑定自己的域名；</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p><a href="https://stats.winterchen.com" target="_blank" rel="noopener">https://stats.winterchen.com</a></p>
<ul>
<li>以下非截图，为动态网页</li>
</ul>
<iframe src="https://stats.winterchen.com" width="700px" height="700px" frameborder="0" scrolling="no"> </iframe>

<p>顺便分享一个技巧，在markdown中嵌入网页：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://stats.winterchen.com"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"700px"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"500px"</span> <span class="hljs-attr">frameborder</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">scrolling</span>=<span class="hljs-string">"no"</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>注意事项：</p>
<ul>
<li><code>&amp; -&gt; &amp;amp</code></li>
<li><code>&lt;&gt;&lt;/&gt;</code>直接要留有空格</li>
</ul>
]]></content>
      <categories>
        <category>share</category>
      </categories>
      <tags>
        <tag>share</tag>
      </tags>
  </entry>
  <entry>
    <title>风景摄影-关于夏天的雨</title>
    <url>/2020/07/05/2020-07-05-summer/</url>
    <content><![CDATA[<p>关于夏日雨季的记忆是什么？</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046738800228.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046740278599.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046742666469.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>作品</category>
      </categories>
      <tags>
        <tag>作品</tag>
      </tags>
  </entry>
  <entry>
    <title>人像摄影-关于夏天的定义</title>
    <url>/2020/07/05/2020-07-05-summer-with-rain/</url>
    <content><![CDATA[<p>梅雨季节还没有过去，这个夏天，有那么一段时间没有拍照了，拉来了小模特，拍了几张</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046723289468.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046723654508.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046724123957.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804112430.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804112457.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804112524.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804112551.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046727258633.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804112618.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046728278404.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046728818616.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804112642.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046729764562.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046730406720.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804112717.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046731499985.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046732095635.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046732705756.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046733251120.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804112747.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804112813.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>作品</category>
      </categories>
      <tags>
        <tag>作品</tag>
      </tags>
  </entry>
  <entry>
    <title>一个人的周末</title>
    <url>/2020/06/14/2020-06-14-sunday/</url>
    <content><![CDATA[<p>这周休息一天，一个人在家无聊透顶，加上有很长一段时间没有拍照，今天一整天把个人摄影作品主页建设完成了，网站包含作品、素材、摄影师等模块，网站使用了github+hexo+github actions等技术，把原有的jenkins自动部署改为了github actions，一个超级好用的新技术，居然一直都没有注意到，以后需要把markdown文档写好提交就会自动发布，具体的教程可以看上一篇博文。</p>
<p>说回正文，作品收录拍过的一些摄影作品，也算记录一下拍摄技术和审美提高的一个过程，尽管现在拍得一些片子不咋地，这也就是有了两个其它模块的原因，前期可以模仿大师的构图和调色。</p>
<p>一直喜欢的摄影师滨田英明，独爱他的调色，有一种初夏的感觉，有幸今天找到了他的<a href="http://hideakihamada.com" target="_blank" rel="noopener">个人主页</a>，超级简约有设计感，下午还想着把他的作品全部趴出来呢，结果写了脚本一直卡着，也不知道啥原因，python技术目前有点渣，顺便看了一下这个网站的html，里面很多图片都放在js里面，这是什么意思？难道这个也是静态的？</p>
<p>滨田英明的作品：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046588865258.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046589306166.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046722034494.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046722213554.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046722389722.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>贴一下大佬的<a href="http://hideakihamada.com" target="_blank" rel="noopener">主页</a></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046449456744.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>我的个人主页：</p>
<p>地址：<a href="https://photo.winterchen.com" target="_blank" rel="noopener">https://photo.winterchen.com</a></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046450220996.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046452039277.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046453311374.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>随笔</category>
      </categories>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>如何使用 GitHub Actions 实现 Hexo 博客的 CICD</title>
    <url>/2020/06/13/2020-06-13-hexo-deploy-from-github-ci-cd/</url>
    <content><![CDATA[<h2 id="仓库准备"><a href="#仓库准备" class="headerlink" title="仓库准备"></a>仓库准备</h2><table>
<thead>
<tr>
<th>项目仓库</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://github.com/WinterChenS/blog-back" target="_blank" rel="noopener">https://github.com/WinterChenS/blog-back</a></td>
<td>用于存放 hexo 生成的项目，可以理解成源码</td>
</tr>
<tr>
<td><a href="https://github.com/WinterChenS/WinterChenS.github.io" target="_blank" rel="noopener">https://github.com/WinterChenS/WinterChenS.github.io</a></td>
<td>存放 hexo 编译后的静态文件，也是博客页面</td>
</tr>
</tbody></table>
<h2 id="秘钥生成"><a href="#秘钥生成" class="headerlink" title="秘钥生成"></a>秘钥生成</h2><p>Hexo编译之后需要把生成的静态页面代码push到github pages的仓库，也就是 <code>WinterChenS/WinterChenS.github.io</code> ，没有秘钥就没有权限push。</p>
<blockquote>
<p>随便找一台电脑或者服务器，生成秘钥：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">ssh-keygen -f github-deploy-key # 三次回车即可<br></code></pre></td></tr></table></figure>

<p>以上步骤会生成<code>github-deploy-key</code> 和 <code>github-deploy-key.pub</code> 两个文件。</p>
<h2 id="配置github仓库"><a href="#配置github仓库" class="headerlink" title="配置github仓库"></a>配置github仓库</h2><h3 id="配置blog-back仓库"><a href="#配置blog-back仓库" class="headerlink" title="配置blog-back仓库"></a>配置blog-back仓库</h3><p>打开 <code>https://github.com/WinterChenS/blog-back/settings/secrets</code> 点击 <code>Add new secrets</code>，分别在:</p>
<ul>
<li>Name 输入 <code>HEXO_DEPLOY_KEY</code></li>
<li>Value 输入前面生成的私有KEY <code>github-deploy-key</code> 的内容</li>
</ul>
<h3 id="配置WinterChenS-github-io仓库"><a href="#配置WinterChenS-github-io仓库" class="headerlink" title="配置WinterChenS.github.io仓库"></a>配置WinterChenS.github.io仓库</h3><p>打开 <a href="https://github.com/WinterChenS/WinterChenS.github.io/settings/Deploy" target="_blank" rel="noopener">https://github.com/WinterChenS/WinterChenS.github.io/settings/Deploy</a> keys，点击 Add deploy key，分别在:</p>
<ul>
<li>Title 输入 <code>HEXO_DEPLOY_KEY</code></li>
<li>Key 输入前面生成的公KEY <code>github-deploy-key.pub</code> 的内容名称随意，但要勾选 Allow write access</li>
</ul>
<h2 id="编写-Action-脚本"><a href="#编写-Action-脚本" class="headerlink" title="编写 Action 脚本"></a>编写 Action 脚本</h2><p>使用前先要申请，直接打开<code>https://github.com/WinterChenS/WinterChenS.github.io/actions/new</code></p>
<p>main.yml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">name: Deploy Blog<br><br>on: [push] # 当有新push时运行<br><br>env:<br>  TZ: Asia&#x2F;Shanghai<br><br>jobs:<br>  build: # 一项叫做build的任务<br><br>    runs-on: ubuntu-latest # 在最新版的Ubuntu系统下运行<br>    <br>    steps:<br>    - name: Checkout # 将仓库内master分支的内容下载到工作目录<br>      uses: actions&#x2F;checkout@v1 # 脚本来自 https:&#x2F;&#x2F;github.com&#x2F;actions&#x2F;checkout<br>      <br>    - name: Use Node.js 10.x # 配置Node环境<br>      uses: actions&#x2F;setup-node@v1 # 配置脚本来自 https:&#x2F;&#x2F;github.com&#x2F;actions&#x2F;setup-node<br>      with:<br>        node-version: &quot;10.x&quot;<br>    <br>    - name: Setup Hexo env<br>      env:<br>        ACTION_DEPLOY_KEY: $&#123;&#123; secrets.HEXO_DEPLOY_KEY &#125;&#125; # 这里是上面WinterChenS.github.io新增的公钥：HEXO_DEPLOY_KEY<br>      run: |<br>        # set up private key for deploy<br>        mkdir -p ~&#x2F;.ssh&#x2F;<br>        echo &quot;$ACTION_DEPLOY_KEY&quot; | tr -d &#39;\r&#39; &gt; ~&#x2F;.ssh&#x2F;id_rsa # 配置秘钥<br>        chmod 600 ~&#x2F;.ssh&#x2F;id_rsa<br>        ssh-keyscan github.com &gt;&gt; ~&#x2F;.ssh&#x2F;known_hosts<br>        # set git infomation<br>        git config --global user.name &#39;winterchens&#39; # 换成你自己的邮箱和名字<br>        git config --global user.email &#39;1085143002@qq.com&#39;<br>        # install dependencies<br>        npm i -g hexo-cli # 安装hexo<br>        npm i<br>        # 拉取主题代码<br>        rm -rf themes&#x2F;*<br>        git clone https:&#x2F;&#x2F;github.com&#x2F;WinterChenS&#x2F;hexo-theme-diaspora.git themes&#x2F;diaspora<br>        <br>  <br>    - name: Deploy<br>      run: |<br>        # publish<br>        hexo generate &amp;&amp; hexo deploy # 执行部署程序<br></code></pre></td></tr></table></figure>

<h2 id="修改blog-back根目录的-config-yml"><a href="#修改blog-back根目录的-config-yml" class="headerlink" title="修改blog-back根目录的_config.yml"></a>修改blog-back根目录的_config.yml</h2><p>如果你使用的是http，那么需要修改为ssh，已经是ssh就无须修改</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">deploy:<br>  type: git<br>  repo: git@github.com:WinterChenS&#x2F;WinterChenS.github.io.git<br>  branch: master<br></code></pre></td></tr></table></figure>

<p>以后只需要把代码提交到blog-back就可以自动进行编译发布了，是不是很爽</p>
]]></content>
      <categories>
        <category>github-actions</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>github</tag>
        <tag>github-actions</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot 整合 Shardingsphere 4.0 分库分表</title>
    <url>/2020/04/21/2020-04-21-sharingsphere-springboot/</url>
    <content><![CDATA[<blockquote>
<p>最近Shardingsphere在Apache Software Foundation 简称ASF 毕业成为Apache顶级项目，也是目前ASF收个分布式数据库中间件项目，未来可期啊，今天我们就搭建一下springboot整合Shardingsphere4.0版本。</p>
</blockquote>
<h2 id="依赖："><a href="#依赖：" class="headerlink" title="依赖："></a>依赖：</h2><ul>
<li>jdk1.8</li>
<li>maven3.6.3</li>
<li>mybatis plus</li>
<li>mysql8.0</li>
<li>Shardingsphere 4.0</li>
</ul>
<h2 id="数据库的结构："><a href="#数据库的结构：" class="headerlink" title="数据库的结构："></a>数据库的结构：</h2><p>–|<br>  |- ds0<br>  |   |- t_order0<br>  |   |- t_order1<br>  |<br>  |- ds1<br>      |- t_order0<br>      |- t_order1</p>
<h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><h4 id="数据库ds0"><a href="#数据库ds0" class="headerlink" title="数据库ds0"></a>数据库ds0</h4><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`ds0`</span> <span class="hljs-comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci */</span>;<br><span class="hljs-keyword">USE</span> <span class="hljs-string">`ds0`</span>;<br><br><span class="hljs-keyword">SET</span> <span class="hljs-keyword">NAMES</span> utf8mb4;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for t_order0</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`t_order0`</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`t_order0`</span>  (<br>  <span class="hljs-string">`order_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单号（主键）'</span>,<br>  <span class="hljs-string">`order_name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单名称'</span>,<br>  <span class="hljs-string">`order_status`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">0</span>) <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单状态'</span>,<br>  <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户id'</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`order_id`</span>) <span class="hljs-keyword">USING</span> BTREE<br>) <span class="hljs-keyword">ENGINE</span> = <span class="hljs-keyword">InnoDB</span> <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> = utf8mb4 <span class="hljs-keyword">COLLATE</span> = utf8mb4_general_ci ROW_FORMAT = Dynamic;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for t_order1</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`t_order1`</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`t_order1`</span>  (<br>  <span class="hljs-string">`order_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单号（主键）'</span>,<br>  <span class="hljs-string">`order_name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单名称'</span>,<br>  <span class="hljs-string">`order_status`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">0</span>) <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单状态'</span>,<br>  <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户id'</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`order_id`</span>) <span class="hljs-keyword">USING</span> BTREE<br>) <span class="hljs-keyword">ENGINE</span> = <span class="hljs-keyword">InnoDB</span> <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> = utf8mb4 <span class="hljs-keyword">COLLATE</span> = utf8mb4_general_ci ROW_FORMAT = Dynamic;<br><br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS = <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<h4 id="数据库ds1"><a href="#数据库ds1" class="headerlink" title="数据库ds1"></a>数据库ds1</h4><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`ds1`</span> <span class="hljs-comment">/*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci */</span>;<br><span class="hljs-keyword">USE</span> <span class="hljs-string">`ds1`</span>;<br><br><span class="hljs-keyword">SET</span> <span class="hljs-keyword">NAMES</span> utf8mb4;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for t_order0</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`t_order0`</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`t_order0`</span>  (<br>  <span class="hljs-string">`order_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单号（主键）'</span>,<br>  <span class="hljs-string">`order_name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单名称'</span>,<br>  <span class="hljs-string">`order_status`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">0</span>) <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单状态'</span>,<br>  <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户id'</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`order_id`</span>) <span class="hljs-keyword">USING</span> BTREE<br>) <span class="hljs-keyword">ENGINE</span> = <span class="hljs-keyword">InnoDB</span> <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> = utf8mb4 <span class="hljs-keyword">COLLATE</span> = utf8mb4_general_ci ROW_FORMAT = Dynamic;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Table structure for t_order1</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`t_order1`</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`t_order1`</span>  (<br>  <span class="hljs-string">`order_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单号（主键）'</span>,<br>  <span class="hljs-string">`order_name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单名称'</span>,<br>  <span class="hljs-string">`order_status`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">0</span>) <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单状态'</span>,<br>  <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户id'</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`order_id`</span>) <span class="hljs-keyword">USING</span> BTREE<br>) <span class="hljs-keyword">ENGINE</span> = <span class="hljs-keyword">InnoDB</span> <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> = utf8mb4 <span class="hljs-keyword">COLLATE</span> = utf8mb4_general_ci ROW_FORMAT = Dynamic;<br><br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS = <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<h2 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h2><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.6.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.winterchen<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shardingsphere-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>shardingsphere-demo<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>shardingsphere demo<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sharding-sphere.version</span>&gt;</span>4.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">sharding-sphere.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--mysql，根据自己数据库版本进行相关调整，不然会报错--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--Mybatis-Plus--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- for spring boot --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- for spring namespace --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sharding-jdbc-spring-namespace<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;sharding-sphere.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>注意：数据库驱动版本，请根据自己数据库版本进行相关调整，不然会报错</p>
</blockquote>
<h2 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h2><h3 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h3><figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">server.port</span>=<span class="hljs-string">8098</span><br><br><span class="hljs-comment"># 数据源 ds0,ds1</span><br><span class="hljs-meta">spring.shardingsphere.datasource.names</span>=<span class="hljs-string">ds0,ds1</span><br><span class="hljs-comment"># 第一个数据库</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds0.type</span>=<span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds0.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds0.jdbc-url</span>=<span class="hljs-string">jdbc:mysql://192.168.133.134:3306/ds0?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf8&amp;characterSetResults=utf8&amp;useSSL=false&amp;verifyServerCertificate=false&amp;autoReconnct=true&amp;autoReconnectForPools=true&amp;allowMultiQueries=true</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds0.username</span>=<span class="hljs-string">root</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds0.password</span>=<span class="hljs-string">root</span><br><br><span class="hljs-comment"># 第二个数据库</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds1.type</span>=<span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds1.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds1.jdbc-url</span>=<span class="hljs-string">jdbc:mysql://192.168.133.134:3306/ds1?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf8&amp;characterSetResults=utf8&amp;useSSL=false&amp;verifyServerCertificate=false&amp;autoReconnct=true&amp;autoReconnectForPools=true&amp;allowMultiQueries=true</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds1.username</span>=<span class="hljs-string">root</span><br><span class="hljs-meta">spring.shardingsphere.datasource.ds1.password</span>=<span class="hljs-string">root</span><br><br><span class="hljs-comment"># 水平拆分的数据库（表） 配置分库 + 分表策略 行表达式分片策略</span><br><span class="hljs-comment"># 分库策略</span><br><span class="hljs-meta">spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column</span>=<span class="hljs-string">user_id</span><br><span class="hljs-meta">spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression</span>=<span class="hljs-string">ds$-&gt;&#123;user_id % 2&#125;</span><br><br><br><span class="hljs-comment"># 分表策略 其中t_order为逻辑表 分表主要取决于order_id行</span><br><span class="hljs-meta">spring.shardingsphere.sharding.tables.t_order.actual-data-nodes</span>=<span class="hljs-string">ds$-&gt;&#123;0..1&#125;.t_order$-&gt;&#123;0..1&#125;</span><br><span class="hljs-meta">spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.sharding-column</span>=<span class="hljs-string">order_id</span><br><span class="hljs-meta">spring.shardingsphere.sharding.tables.t_order.key-generator.column</span>=<span class="hljs-string">order_id</span><br><span class="hljs-meta">spring.shardingsphere.sharding.tables.t_order.key-generator.type</span>=<span class="hljs-string">SNOWFLAKE</span><br><br><span class="hljs-comment"># 分片算法表达式</span><br><span class="hljs-meta">spring.shardingsphere.sharding.tables.t_order.table-strategy.inline.algorithm-expression</span>=<span class="hljs-string">t_order$-&gt;&#123;order_id % 2&#125;</span><br><br><br><span class="hljs-comment"># 打印执行的数据库以及语句</span><br><span class="hljs-meta">spring.shardingsphere.props.sql.show</span>=<span class="hljs-string">true</span><br><span class="hljs-meta">spring.main.allow-bean-definition-overriding</span>=<span class="hljs-string">true</span><br><br><br><span class="hljs-comment"># mybatis-plus</span><br><span class="hljs-meta">mybatis-plus.mapper-locations</span>=<span class="hljs-string">classpath:/mapper/*.xml</span><br><span class="hljs-meta">mybatis-plus.configuration.jdbc-type-for-null</span>=<span class="hljs-string">'null'</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>注意：数据库连接配置、mybatis-plus扫包路径，需要根据实际情况进行改变</p>
</blockquote>
<p>以上的配置实现了分库分表，一下几点概念需要明白：</p>
<h3 id="逻辑表"><a href="#逻辑表" class="headerlink" title="逻辑表"></a>逻辑表</h3><p>水平拆分的数据库（表）的相同逻辑和数据结构表的总称。例：订单数据根据主键尾数拆分为10张表，分别是t_order0到t_order9，他们的逻辑表名为t_order。</p>
<h3 id="真实表"><a href="#真实表" class="headerlink" title="真实表"></a>真实表</h3><p>在分片的数据库中真实存在的物理表。即上个示例中的t_order0到t_order9。</p>
<h3 id="数据节点"><a href="#数据节点" class="headerlink" title="数据节点"></a>数据节点</h3><p>数据分片的最小单元。由数据源名称和数据表组成，例：ds0.t_order0。</p>
<h3 id="分片键"><a href="#分片键" class="headerlink" title="分片键"></a>分片键</h3><p>用于分片的数据库字段，是将数据库(表)水平拆分的关键字段。例：将订单表中的订单主键的尾数取模分片，则订单主键为分片字段。 SQL中如果无分片字段，将执行全路由，性能较差。 除了对单分片字段的支持，ShardingSphere也支持根据多个字段进行分片。</p>
<h3 id="分片算法"><a href="#分片算法" class="headerlink" title="分片算法"></a>分片算法</h3><p>通过分片算法将数据分片，支持通过=、&gt;=、&lt;=、&gt;、&lt;、BETWEEN和IN分片。分片算法需要应用方开发者自行实现，可实现的灵活度非常高。</p>
<p>目前提供4种分片算法。由于分片算法和业务实现紧密相关，因此并未提供内置分片算法，而是通过分片策略将各种场景提炼出来，提供更高层级的抽象，并提供接口让应用开发者自行实现分片算法。</p>
<ul>
<li>精确分片算法</li>
</ul>
<p>对应PreciseShardingAlgorithm，用于处理使用单一键作为分片键的=与IN进行分片的场景。需要配合StandardShardingStrategy使用。</p>
<ul>
<li>范围分片算法</li>
</ul>
<p>对应RangeShardingAlgorithm，用于处理使用单一键作为分片键的BETWEEN AND、&gt;、&lt;、&gt;=、&lt;=进行分片的场景。需要配合StandardShardingStrategy使用。</p>
<ul>
<li>复合分片算法</li>
</ul>
<p>对应ComplexKeysShardingAlgorithm，用于处理使用多键作为分片键进行分片的场景，包含多个分片键的逻辑较复杂，需要应用开发者自行处理其中的复杂度。需要配合ComplexShardingStrategy使用。</p>
<ul>
<li>Hint分片算法</li>
</ul>
<p>对应HintShardingAlgorithm，用于处理使用Hint行分片的场景。需要配合HintShardingStrategy使用。</p>
<h3 id="分片策略"><a href="#分片策略" class="headerlink" title="分片策略"></a>分片策略</h3><p>包含分片键和分片算法，由于分片算法的独立性，将其独立抽离。真正可用于分片操作的是分片键 + 分片算法，也就是分片策略。目前提供5种分片策略。</p>
<ul>
<li>标准分片策略</li>
</ul>
<p>对应StandardShardingStrategy。提供对SQL语句中的=, &gt;, &lt;, &gt;=, &lt;=, IN和BETWEEN AND的分片操作支持。StandardShardingStrategy只支持单分片键，提供PreciseShardingAlgorithm和RangeShardingAlgorithm两个分片算法。PreciseShardingAlgorithm是必选的，用于处理=和IN的分片。RangeShardingAlgorithm是可选的，用于处理BETWEEN AND, &gt;, &lt;, &gt;=, &lt;=分片，如果不配置RangeShardingAlgorithm，SQL中的BETWEEN AND将按照全库路由处理。</p>
<ul>
<li>复合分片策略</li>
</ul>
<p>对应ComplexShardingStrategy。复合分片策略。提供对SQL语句中的=, &gt;, &lt;, &gt;=, &lt;=, IN和BETWEEN AND的分片操作支持。ComplexShardingStrategy支持多分片键，由于多分片键之间的关系复杂，因此并未进行过多的封装，而是直接将分片键值组合以及分片操作符透传至分片算法，完全由应用开发者实现，提供最大的灵活度。</p>
<ul>
<li>行表达式分片策略</li>
</ul>
<p>对应InlineShardingStrategy。使用Groovy的表达式，提供对SQL语句中的=和IN的分片操作支持，只支持单分片键。对于简单的分片算法，可以通过简单的配置使用，从而避免繁琐的Java代码开发，如: t_user_$-&gt;{u_id % 8} 表示t_user表根据u_id模8，而分成8张表，表名称为t_user_0到t_user_7。</p>
<ul>
<li>Hint分片策略</li>
</ul>
<p>对应HintShardingStrategy。通过Hint指定分片值而非从SQL中提取分片值的方式进行分片的策略。</p>
<ul>
<li>不分片策略</li>
</ul>
<p>对应NoneShardingStrategy。不分片的策略。</p>
<h3 id="SQL-Hint"><a href="#SQL-Hint" class="headerlink" title="SQL Hint"></a>SQL Hint</h3><p>对于分片字段非SQL决定，而由其他外置条件决定的场景，可使用SQL Hint灵活的注入分片字段。例：内部系统，按照员工登录主键分库，而数据库中并无此字段。SQL Hint支持通过Java API和SQL注释(待实现)两种方式使用。</p>
<h3 id="自增主键生成策略"><a href="#自增主键生成策略" class="headerlink" title="自增主键生成策略"></a>自增主键生成策略</h3><p>通过在客户端生成自增主键替换以数据库原生自增主键的方式，做到分布式主键无重复。 采用UUID.randomUUID()的方式产生分布式主键。或者 SNOWFLAKE</p>
<h2 id="mybatis-plus"><a href="#mybatis-plus" class="headerlink" title="mybatis-plus"></a>mybatis-plus</h2><p>mybatis-plus极大的提高了开发效率，简单的配置和使用mybatis-plus</p>
<p>配置mybatis-plus的分页</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.shardingspheredemo.configuration;<br><br><br><span class="hljs-meta">@EnableTransactionManagement</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@MapperScan</span>(<span class="hljs-string">"com.winterchen.shardingspheredemo.dao"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MybatisPlusConfig</span> </span>&#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> PaginationInterceptor <span class="hljs-title">paginationInterceptor</span><span class="hljs-params">()</span> </span>&#123;<br>        PaginationInterceptor paginationInterceptor = <span class="hljs-keyword">new</span> PaginationInterceptor();<br>        <span class="hljs-comment">// 设置请求的页面大于最大页后操作， true调回到首页，false 继续请求  默认false</span><br>        <span class="hljs-comment">// paginationInterceptor.setOverflow(false);</span><br>        <span class="hljs-comment">// 设置最大单页限制数量，默认 500 条，-1 不受限制</span><br>        <span class="hljs-comment">// paginationInterceptor.setLimit(500);</span><br>        <span class="hljs-comment">// 开启 count 的 join 优化,只针对部分 left join</span><br>        paginationInterceptor.setCountSqlParser(<span class="hljs-keyword">new</span> JsqlParserCountOptimize());<br>        <span class="hljs-keyword">return</span> paginationInterceptor;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>配置自定义的通用mapper</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.shardingspheredemo.configuration;<br><br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MyBaseMapper</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseMapper</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br><br>    <span class="hljs-function">IPage&lt;T&gt; <span class="hljs-title">selectAllByCondition</span><span class="hljs-params">(Page&lt;?&gt; page, @Param(<span class="hljs-string">"condition"</span>)</span>Map&lt;String, Object&gt; condition)</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteById</span><span class="hljs-params">(@Param(<span class="hljs-string">"condition"</span>)</span>Map&lt;String, Object&gt; condition)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.shardingspheredemo.model;<br><br><br><span class="hljs-meta">@TableName</span>(<span class="hljs-string">"t_order"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderInfo</span> </span>&#123;<br><br>    <span class="hljs-meta">@TableId</span>(value = <span class="hljs-string">"order_id"</span>)<br>    <span class="hljs-keyword">private</span> Long orderId;<br><br>    <span class="hljs-meta">@TableField</span>(value = <span class="hljs-string">"order_name"</span>)<br>    <span class="hljs-keyword">private</span> String orderName;<br><br>    <span class="hljs-meta">@TableField</span>(value = <span class="hljs-string">"order_status"</span>)<br>    <span class="hljs-keyword">private</span> Integer orderStatus;<br><br>    <span class="hljs-meta">@TableField</span>(value = <span class="hljs-string">"user_id"</span>)<br>    <span class="hljs-keyword">private</span> Long userId;<br><br>    <span class="hljs-comment">//省略get/set</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h3><h4 id="mapper"><a href="#mapper" class="headerlink" title="mapper"></a>mapper</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.shardingspheredemo.dao;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MyBaseMapper</span>&lt;<span class="hljs-title">OrderInfo</span>&gt; </span>&#123;<br><br>    <span class="hljs-function">IPage&lt;OrderInfo&gt; <span class="hljs-title">selectAllByCondition</span><span class="hljs-params">(Page&lt;?&gt; page, @Param(<span class="hljs-string">"condition"</span>)</span> Map&lt;String, Object&gt; condition)</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteById</span><span class="hljs-params">(@Param(<span class="hljs-string">"condition"</span>)</span>Map&lt;String, Object&gt; condition)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="mapper-xml"><a href="#mapper-xml" class="headerlink" title="mapper xml"></a>mapper xml</h4><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.winterchen.shardingspheredemo.dao.OrderMapper"</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Base_Column_List"</span>&gt;</span><br>        order_id, order_name, order_status, user_id<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectAllByCondition"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.winterchen.shardingspheredemo.model.OrderInfo"</span>&gt;</span><br>        select<br>            <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span>/&gt;</span><br>        from<br>           t_order<br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"condition.userId != null"</span>&gt;</span><br>                and user_id = #&#123;condition.userId, jdbcType=BIGINT&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"condition.orderId != null"</span>&gt;</span><br>                and order_id = #&#123;condition.orderId, jdbcType=BIGINT&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"condition.orderName != null and condition.orderName != ''"</span>&gt;</span><br>                and order_name like concat('%',#&#123;condition.orderName,jdbcType=VARCHAR&#125; ,'%')<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"condition.orderStatus != null"</span>&gt;</span><br>                and order_status = #&#123;condition.orderStatus, jdbcType=INTEGER&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteById"</span>&gt;</span><br>        delete from t_order where order_id = #&#123;condition.orderId, jdbcType=BIGINT&#125; and user_id = #&#123;condition.userId, jdbcType=BIGINT&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.shardingspheredemo.service;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IService</span>&lt;<span class="hljs-title">OrderInfo</span>&gt; </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">save</span><span class="hljs-params">(OrderInfo entity)</span></span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">removeById</span><span class="hljs-params">(Serializable id)</span></span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">updateById</span><span class="hljs-params">(OrderInfo entity)</span></span>;<br><br>    <span class="hljs-function">IPage&lt;OrderInfo&gt; <span class="hljs-title">pageOrderInfos</span><span class="hljs-params">(Page&lt;?&gt; page, OrderInfo orderInfo)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.shardingspheredemo.service.impl;<br><br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceImpl</span>&lt;<span class="hljs-title">OrderMapper</span>, <span class="hljs-title">OrderInfo</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">OrderService</span> </span>&#123;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">save</span><span class="hljs-params">(OrderInfo entity)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.save(entity);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">removeById</span><span class="hljs-params">(Serializable id)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.removeById(id);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">updateById</span><span class="hljs-params">(OrderInfo entity)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.updateById(entity);<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> IPage&lt;OrderInfo&gt; <span class="hljs-title">pageOrderInfos</span><span class="hljs-params">(Page&lt;?&gt; page, OrderInfo orderInfo)</span> </span>&#123;<br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        map.put(<span class="hljs-string">"userId"</span>, orderInfo.getUserId());<br>        map.put(<span class="hljs-string">"orderId"</span>, orderInfo.getOrderId());<br>        map.put(<span class="hljs-string">"orderName"</span>, orderInfo.getOrderName());<br>        map.put(<span class="hljs-string">"orderStatus"</span>, orderInfo.getOrderStatus());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.baseMapper.selectAllByCondition(page, map);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.shardingspheredemo.controller;<br><br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/api/v1/order"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br><br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">""</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">save</span><span class="hljs-params">(@RequestBody OrderInfo orderInfo)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> orderService.save(orderInfo);<br>    &#125;<br><br>    <span class="hljs-meta">@DeleteMapping</span>(<span class="hljs-string">"/&#123;orderId&#125;"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">deleteById</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">            @PathVariable(<span class="hljs-string">"orderId"</span>)</span></span><br><span class="hljs-function">            Long id) </span>&#123;<br>        <span class="hljs-keyword">return</span> orderService.removeById(id);<br>    &#125;<br><br>    <span class="hljs-meta">@PutMapping</span>(<span class="hljs-string">"/&#123;orderId&#125;"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">updateById</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">            @PathVariable(<span class="hljs-string">"orderId"</span>)</span></span><br><span class="hljs-function">            Long orderId,</span><br><span class="hljs-function">            @RequestBody OrderInfo orderInfo) </span>&#123;<br>        orderInfo.setOrderId(orderId);<br>        <span class="hljs-keyword">return</span> orderService.updateById(orderInfo);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/list"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> IPage <span class="hljs-title">page</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">            @RequestParam(name = <span class="hljs-string">"pageNum"</span>, required = <span class="hljs-keyword">false</span>, defaultValue = <span class="hljs-string">"1"</span>)</span></span><br><span class="hljs-function">                    Integer pageNum,</span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(name = <span class="hljs-string">"pageSize"</span>, required = <span class="hljs-keyword">false</span>, defaultValue = <span class="hljs-string">"10"</span>)</span></span><br><span class="hljs-function">                    Integer pageSize,</span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(name = <span class="hljs-string">"orderId"</span>, required = <span class="hljs-keyword">false</span>)</span></span><br><span class="hljs-function">            Long orderId,</span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(name = <span class="hljs-string">"orderStatus"</span>, required = <span class="hljs-keyword">false</span>)</span></span><br><span class="hljs-function">            Integer orderStatus,</span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(name = <span class="hljs-string">"orderName"</span>, required = <span class="hljs-keyword">false</span>)</span></span><br><span class="hljs-function">            String orderName) </span>&#123;<br>        Page&lt;OrderInfo&gt; page = <span class="hljs-keyword">new</span> Page&lt;&gt;(pageNum,pageSize);<br>        OrderInfo orderInfo = <span class="hljs-keyword">new</span> OrderInfo();<br>        orderInfo.setOrderId(orderId);<br>        orderInfo.setOrderName(orderName);<br>        orderInfo.setOrderStatus(orderStatus);<br>        <span class="hljs-keyword">return</span> orderService.pageOrderInfos(page, orderInfo);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.shardingspheredemo;<br><br><br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShardingsphereDemoApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ShardingsphereDemoApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上就整合完毕了，可以使用postMan进行测试，测试截图就不展示了，后面会介绍关于读写分离的相关介绍，如果需要查看详细的介绍可以参考官方文档。</p>
<h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><ul>
<li>官方源码地址：<a href="https://github.com/apache/shardingsphere" target="_blank" rel="noopener">https://github.com/apache/shardingsphere</a></li>
<li>官方文档：<a href="https://shardingsphere.apache.org/document/current/cn/overview/" target="_blank" rel="noopener">https://shardingsphere.apache.org/document/current/cn/overview/</a></li>
<li>mybatis-plus官方文档：<a href="https://mp.baomidou.com/guide/" target="_blank" rel="noopener">https://mp.baomidou.com/guide/</a></li>
</ul>
]]></content>
      <categories>
        <category>sharingsphere</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>sharingsphere</tag>
        <tag>mybatis-plus</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkins 持续集成 docker服务到堡垒机</title>
    <url>/2020/04/14/2020-04-14-jenkins-docker/</url>
    <content><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>公司原来的项目发布很繁琐也很普通，最近捣鼓一下jenkins+docker，做一下一键发布，由于公司服务器都加了堡垒机，所以需要解决不能远程ssh部署，整体的思路如下：</p>
<ol>
<li>jenkins使用pipeline脚本编写（更灵活，方便多套环境复制使用）；</li>
<li>拉取代码并编译成jar包；</li>
<li>将jar包编译为docker镜像；</li>
<li>将镜像上传到本地私有仓库（速度快）</li>
<li>调用写好的跑脚本的服务接口实现在堡垒机中实现docker镜像的新版本发布；</li>
</ol>
<p>关于jenkins的安装方式一开始尝试了很多种方案：</p>
<ul>
<li>jenkins部署在docker容器内，使用远程docker rest api进行镜像打包上传，但是遇到很大的问题就是阿里云私有镜像仓库登录方式不一样，导致登录失败，而且不能使用脚本操作docker，因为jenkins容器内没有docker环境，如果安装docker in docker，这样就太麻烦了，在容器外面就有一套docker环境；(如果不依赖阿里云私有仓库，这种方案就没有关系了)</li>
<li>jenkins安装在有docker环境的服务器内，那么可以使用shell脚本灵活的进行编译上传等操作（适用于比较灵活的使用场景）</li>
</ul>
<h2 id="开始："><a href="#开始：" class="headerlink" title="开始："></a>开始：</h2><h3 id="依赖环境："><a href="#依赖环境：" class="headerlink" title="依赖环境："></a>依赖环境：</h3><ul>
<li>jenkins</li>
<li>docker</li>
</ul>
<h3 id="jenkins安装"><a href="#jenkins安装" class="headerlink" title="jenkins安装"></a>jenkins安装</h3><p>安装步骤请查询相关文档，这里就略过</p>
<h3 id="jenkins安装插件提速"><a href="#jenkins安装插件提速" class="headerlink" title="jenkins安装插件提速"></a>jenkins安装插件提速</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">cd &#123;你的Jenkins工作目录&#125;&#x2F;updates  #进入更新配置位置<br><br>vim default.json<br><br>##替换软件源<br>:1,$s&#x2F;http:\&#x2F;\&#x2F;updates.jenkins-ci.org\&#x2F;download&#x2F;https:\&#x2F;\&#x2F;mirrors.tuna.tsinghua.edu.cn\&#x2F;jenkins&#x2F;g<br></code></pre></td></tr></table></figure>

<h3 id="安装jenkins插件-HTTP-Request"><a href="#安装jenkins插件-HTTP-Request" class="headerlink" title="安装jenkins插件 HTTP Request"></a>安装jenkins插件 HTTP Request</h3><p>这个插件用于jenkins将docker镜像push到目标仓库之后调用堡垒机中发布服务进行docker镜像的发布</p>
<h3 id="编写jenkins发布脚本"><a href="#编写jenkins发布脚本" class="headerlink" title="编写jenkins发布脚本"></a>编写jenkins发布脚本</h3><p>步骤：新建item -&gt; 选择pipeline（流水线） -&gt; 编辑流水线脚本</p>
<p>注意：</p>
<ul>
<li>在输入框的左下角有：流水线语法，可以根据某些你需要用到的插件生成模板脚本，非常方便</li>
<li>脚本有一点需要注意，单引号内只能为文本不能使用变量，如果需要使用变量，使用双引号；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">pipeline &#123;<br>   agent any<br><br>   tools &#123;<br>      &#x2F;&#x2F; Install the Maven version configured as &quot;M3&quot; and add it to the path.<br>      maven &quot;maven3.6.3&quot;<br>   &#125;<br>   <br>   &#x2F;&#x2F;环境变量，一下变量名称都可以自定义，在后面的脚本中使用<br>   environment &#123;<br>      &#x2F;&#x2F;git仓库<br>	  GIT_REGISTRY &#x3D; &#39;https:&#x2F;&#x2F;github.com&#x2F;WinterChenS&#x2F;my-site.git&#39;<br>	  &#x2F;&#x2F;分支<br>	  GIT_BRANCH &#x3D; &#39;sit&#39;<br>	  &#x2F;&#x2F;profile<br>	  PROFILES &#x3D; &#39;sit&#39;<br>	  &#x2F;&#x2F;如果仓库是私有的需要在凭证中添加凭证，然后把id写到这里<br>	  GITLAB_ACCESS_TOKEN_ID &#x3D; &#39;85465d36-4c3a-469f-b92f-f53dae47fd0c&#39;<br>	  &#x2F;&#x2F;服务名称<br>	  SERVICE_NAME &#x3D; &#39;my-site&#39;<br>	  &#x2F;&#x2F;镜像名称,aaa_sit是命名空间，可以区分不同的环境<br>	  IMAGE_NAME &#x3D; &quot;127.0.0.1:8999&#x2F;aaa_sit&#x2F;$&#123;SERVICE_NAME&#125;&quot;<br>	  &#x2F;&#x2F;镜像tag<br>	  TAG &#x3D; &quot;latest&quot;<br>	  &#x2F;&#x2F;远程发布服务的地址<br>	  REMOTE_EXECUTE_HOST &#x3D; &#39;http:&#x2F;&#x2F;10.85.54.33:7017&#x2F;shell&#39;<br>	  &#x2F;&#x2F;服务开放的端口<br>	  SERVER_PORT &#x3D; &#39;19070&#39;<br>	  &#x2F;&#x2F;日志目录，容器内目录<br>	  LOG_DIR &#x3D; &#39;&#x2F;var&#x2F;logs&#39;<br>	  &#x2F;&#x2F;宿主机目录<br>      MAIN_VOLUME &#x3D; &quot;$&#123;LOG_DIR&#125;&#x2F;jar_$&#123;env.SERVER_PORT&#125;&quot;<br>      &#x2F;&#x2F;jvm参数<br>      JVM_ARG &#x3D; &quot;-server -Xms512m -Xmx512m  -XX:+HeapDumpOnOutOfMemoryError  -XX:HeapDumpPath&#x3D;$&#123;LOG_DIR&#125;&#x2F;dump&#x2F;dump-yyy.log  -XX:ErrorFile&#x3D;$&#123;LOG_DIR&#125;&#x2F;jvm&#x2F;jvm-crash.log&quot;<br>   &#125;<br>   <br>   <br><br>   stages &#123;<br>      stage(&#39;Build&#39;) &#123;<br>         steps &#123;<br>            &#x2F;&#x2F; 获取代码<br>            git credentialsId: &quot;$&#123;env.GITLAB_ACCESS_TOKEN_ID&#125;&quot;, url: &quot;$&#123;env.GIT_REGISTRY&#125;&quot;, branch: &quot;$&#123;env.GIT_BRANCH&#125;&quot;<br><br>            &#x2F;&#x2F; maven 打包<br>            sh &quot;mvn -Dmaven.test.failure.ignore&#x3D;true clean package -P $&#123;env.PROFILES&#125;&quot;<br><br>         &#125;<br><br>      &#125;<br>      <br>      stage(&#39;Execute shell&#39;) &#123;<br>	    &#x2F;&#x2F; 将jar包拷贝到Dockerfile所在目录<br>		steps &#123;<br>		    &#x2F;&#x2F;注意，这里的目录一定要跟项目实际的目录结构要对应上<br>			sh &quot;cp $&#123;env.WORKSPACE&#125;&#x2F;$&#123;env.SERVICE_NAME&#125;&#x2F;target&#x2F;*.jar $&#123;env.WORKSPACE&#125;&#x2F;$&#123;env.SERVICE_NAME&#125;&#x2F;src&#x2F;main&#x2F;docker&#x2F;$&#123;env.SERVICE_NAME&#125;.jar&quot;<br>		<br>		&#125;<br>	  &#125;<br>	  <br>	  <br>	 <br>	  <br>	  stage(&#39;Image Build And Push&#39;) &#123;<br><br>		steps &#123;<br>            &#x2F;&#x2F;运行这些脚本的条件就是jenkins运行的服务器有docker环境<br>            &#x2F;&#x2F;如果jdk版本是你自己编译成的docker镜像，那么首次编译的时候需要pull<br>			sh &quot;echo &#39;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;开始拉取基础镜像jdk1.8&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#39;&quot;	<br>			&#x2F;&#x2F;这里根据你的私有仓库而定，如果是使用公共镜像的openjdk那么可以略过这一步<br>			sh &quot;docker pull 127.0.0.1:8999&#x2F;jdk&#x2F;jdk1.8:8u171&quot;<br>			sh &quot;echo &#39;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;基础镜像拉取完毕&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#39;&quot;<br>			<br>			sh &quot;echo &#39;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;开始编译并上传镜像&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#39;&quot;<br>			&#x2F;&#x2F;注意目录结构<br>			sh &quot;cd $&#123;env.WORKSPACE&#125;&#x2F;$&#123;env.SERVICE_NAME&#125;&#x2F;src&#x2F;main&#x2F;docker&#x2F; &amp;&amp; docker build -t $&#123;env.IMAGE_NAME&#125;:$&#123;env.TAG&#125; . &amp;&amp; docker push $&#123;env.IMAGE_NAME&#125;:$&#123;env.TAG&#125;&quot;<br>			sh &quot;echo &#39;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;镜像上传成功&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#39;&quot;<br>			<br>			sh &quot;echo &#39;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;删除本地镜像&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#39;&quot;<br>			&#x2F;&#x2F;删除本地镜像防止占用资源<br>			sh &quot;docker rmi $&#123;env.IMAGE_NAME&#125;:$&#123;env.TAG&#125;&quot;<br>			<br>		&#125;<br>		<br><br>	  &#125;<br>	  <br>	  stage(&#39;Execute service&#39;) &#123;<br><br>	    &#x2F;&#x2F;请求堡垒机内的发布服务，具体代码后面会给出<br>		steps &#123;<br>		    &#x2F;&#x2F;以下整个脚本都依赖jenkins插件：HTTP Request<br>		    &#x2F;&#x2F;将body转换为json<br>            script &#123;<br>              def toJson &#x3D; &#123;<br>                input -&gt;<br>                groovy.json.JsonOutput.toJson(input)<br>            &#125;<br>			&#x2F;&#x2F;body定义,根据实际情况而定<br>			def body &#x3D; [<br>                imageName: &quot;$&#123;env.IMAGE_NAME&#125;&quot;,<br>                tag:&quot;$&#123;env.TAG&#125;&quot;,<br>                port:&quot;$&#123;env.SERVER_PORT&#125;&quot;,<br>                simpleImageName: &quot;$&#123;env.SERVICE_NAME&#125;&quot;,<br>                envs: [<br>                    JVM_ARGS: &quot;$&#123;env.JVM_ARG&#125;&quot;<br>                ],<br>                volumes: [&quot;$&#123;env.MAIN_VOLUME&#125;:$&#123;env.LOG_DIR&#125;&quot;]<br>            ]<br>			<br>			sh &quot;echo &#39;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;开始调用目标服务器发布&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#39;&quot;<br>			response &#x3D; httpRequest acceptType: &#39;APPLICATION_JSON&#39;, consoleLogResponseBody: true, contentType: &#39;APPLICATION_JSON&#39;, httpMode: &#39;POST&#39;, requestBody: toJson(body), responseHandle: &#39;NONE&#39;, url: &quot;$&#123;env.REMOTE_EXECUTE_HOST&#125;&quot;<br>		    sh &quot;echo &#39;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;结束调用目标服务器发布&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#39;&quot;			<br>		&#125;<br>		<br><br>	  &#125;<br>   &#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="远程堡垒机发布服务"><a href="#远程堡垒机发布服务" class="headerlink" title="远程堡垒机发布服务"></a>远程堡垒机发布服务</h3><p>远程发布服务其实是一个很简单的执行脚本的服务</p>
<p>ShellRequestDTO.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.jenkinsauto.dto;<br><br><span class="hljs-keyword">import</span> javax.validation.constraints.NotBlank;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShellRequestDTO</span> </span>&#123;<br><br>    <span class="hljs-meta">@NotBlank</span><br>    <span class="hljs-keyword">private</span> String imageName;<br><br>    <span class="hljs-meta">@NotBlank</span><br>    <span class="hljs-keyword">private</span> String tag;<br><br>    <span class="hljs-meta">@NotBlank</span><br>    <span class="hljs-keyword">private</span> String simpleImageName;<br><br>    <span class="hljs-meta">@NotBlank</span><br>    <span class="hljs-keyword">private</span> String port;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 环境变量列表</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; envs;<br><br>    <span class="hljs-keyword">private</span> List&lt;String&gt; volumes;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getImageName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> imageName;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setImageName</span><span class="hljs-params">(String imageName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.imageName = imageName;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getTag</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> tag;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTag</span><span class="hljs-params">(String tag)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.tag = tag;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPort</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> port;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPort</span><span class="hljs-params">(String port)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.port = port;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSimpleImageName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> simpleImageName;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSimpleImageName</span><span class="hljs-params">(String simpleImageName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.simpleImageName = simpleImageName;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title">getEnvs</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> envs;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setEnvs</span><span class="hljs-params">(Map&lt;String, String&gt; envs)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.envs = envs;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">getVolumes</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> volumes;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setVolumes</span><span class="hljs-params">(List&lt;String&gt; volumes)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.volumes = volumes;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">final</span> StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"ShellRequestDTO&#123;"</span>);<br>        sb.append(<span class="hljs-string">"imageName='"</span>).append(imageName).append(<span class="hljs-string">'\''</span>);<br>        sb.append(<span class="hljs-string">", tag='"</span>).append(tag).append(<span class="hljs-string">'\''</span>);<br>        sb.append(<span class="hljs-string">", simpleImageName='"</span>).append(simpleImageName).append(<span class="hljs-string">'\''</span>);<br>        sb.append(<span class="hljs-string">", port='"</span>).append(port).append(<span class="hljs-string">'\''</span>);<br>        sb.append(<span class="hljs-string">", envs="</span>).append(envs);<br>        sb.append(<span class="hljs-string">", volumes="</span>).append(volumes);<br>        sb.append(<span class="hljs-string">'&#125;'</span>);<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>APIResponse.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.jenkinsauto.dto;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">APIRespose</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Integer code;<br><br>    <span class="hljs-keyword">private</span> T data;<br><br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">private</span> Boolean success;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> APIRespose <span class="hljs-title">success</span><span class="hljs-params">()</span></span>&#123;<br>        APIRespose apiRespose = <span class="hljs-keyword">new</span> APIRespose();<br>        apiRespose.setCode(<span class="hljs-number">200</span>);<br>        apiRespose.setSuccess(<span class="hljs-keyword">true</span>);<br>        <span class="hljs-keyword">return</span> apiRespose;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> APIRespose <span class="hljs-title">success</span><span class="hljs-params">(Object data)</span> </span>&#123;<br>        APIRespose apiRespose = <span class="hljs-keyword">new</span> APIRespose();<br>        apiRespose.setCode(<span class="hljs-number">200</span>);<br>        apiRespose.setSuccess(<span class="hljs-keyword">true</span>);<br>        apiRespose.setData(data);<br>        <span class="hljs-keyword">return</span> apiRespose;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> APIRespose <span class="hljs-title">fail</span><span class="hljs-params">(String message)</span> </span>&#123;<br>        APIRespose apiRespose = <span class="hljs-keyword">new</span> APIRespose();<br>        apiRespose.setCode(<span class="hljs-number">500</span>);<br>        apiRespose.setSuccess(<span class="hljs-keyword">false</span>);<br>        apiRespose.setMessage(message);<br>        <span class="hljs-keyword">return</span> apiRespose;<br>    &#125;<br><br>   <span class="hljs-comment">//get,set省略</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>BaseController.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.jenkinsauto.controller;<br><br><span class="hljs-keyword">import</span> com.winterchen.jenkinsauto.dto.APIRespose;<br><span class="hljs-keyword">import</span> com.winterchen.jenkinsauto.dto.ShellRequestDTO;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.validation.annotation.Validated;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.text.MessageFormat;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/shell"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseController</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(BaseController<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">""</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> APIRespose <span class="hljs-title">executeShell</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">        @RequestBody</span></span><br><span class="hljs-function"><span class="hljs-params">        @Validated</span></span><br><span class="hljs-function"><span class="hljs-params">        ShellRequestDTO requestDTO</span></span><br><span class="hljs-function"><span class="hljs-params">    )</span> </span>&#123;<br>        LOGGER.info(<span class="hljs-string">"当前请求参数："</span> + requestDTO.toString());<br>        StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>        <span class="hljs-keyword">try</span> &#123;<br>            doExecuteShell(requestDTO, sb);<br>            <span class="hljs-keyword">return</span> APIRespose.success(sb.toString());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> APIRespose.fail(e.getMessage());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doExecuteShell</span><span class="hljs-params">(ShellRequestDTO requestDTO, StringBuilder sb)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        <span class="hljs-comment">//停止旧的容器</span><br>        stopContainer(requestDTO.getSimpleImageName(), sb);<br>        <span class="hljs-comment">//stopContainerByImageId(requestDTO.getImageName(), sb);</span><br>        <span class="hljs-comment">//删除旧的容器</span><br>        removeContainer(requestDTO.getSimpleImageName(), sb);<br>        <span class="hljs-comment">//removeContainerByImageId(requestDTO.getImageName(),sb);</span><br>        <span class="hljs-comment">//删除旧的镜像</span><br>        removeImage(requestDTO.getImageName(), sb);<br>        removeNoneImages(sb);<br>        <span class="hljs-comment">//拉取最新的镜像</span><br>        pullImage(requestDTO.getImageName(), requestDTO.getTag(), sb);<br>        <span class="hljs-comment">//运行最新镜像</span><br>        runImage(requestDTO, sb);<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pullImage</span><span class="hljs-params">(String imageName, String tag, StringBuilder sb)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        execute(MessageFormat.format(<span class="hljs-string">"docker pull &#123;0&#125;:&#123;1&#125;"</span>, imageName, tag), sb);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stopContainer</span><span class="hljs-params">(String simpleImageName, StringBuilder sb)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            execute(<span class="hljs-string">"docker stop "</span> + simpleImageName, sb);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            LOGGER.error(<span class="hljs-string">"停止容器失败"</span>, e);<br>        &#125;<br>    &#125;<br><br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">removeImage</span><span class="hljs-params">(String imageName, StringBuilder sb)</span>  </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            execute(<span class="hljs-string">"docker rmi -f "</span> + imageName, sb);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            LOGGER.error(<span class="hljs-string">"删除镜像失败"</span>, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">removeNoneImages</span><span class="hljs-params">(StringBuilder sb)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            execute(<span class="hljs-string">"docker ps -a | grep `docker images -f 'dangling=true' -q` | awk '&#123;print $1&#125;'"</span>, sb);<br>            execute(<span class="hljs-string">"docker stop $(docker ps -a | grep `docker images -f 'dangling=true' -q` | awk '&#123;print $1&#125;')"</span>, sb);<br>            execute(<span class="hljs-string">"docker ps -a | grep `docker images -f 'dangling=true' -q` | awk '&#123;print $1&#125;'"</span>,sb);<br>            execute(<span class="hljs-string">"docker rm  $(docker ps -a | grep `docker images -f 'dangling=true' -q` | awk '&#123;print $1&#125;')"</span>, sb);<br>            execute(<span class="hljs-string">"docker images -f 'dangling=true'|awk '&#123;print $3&#125;'"</span>, sb);<br>            execute(<span class="hljs-string">"docker image rm -f  `docker images -f 'dangling=true'|awk '&#123;print $3&#125;'`"</span>, sb);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            LOGGER.error(<span class="hljs-string">"删除none镜像失败"</span>, e);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">removeContainer</span><span class="hljs-params">(String simpleImageName, StringBuilder sb)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            execute(<span class="hljs-string">"docker rm "</span> + simpleImageName, sb);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            LOGGER.error(<span class="hljs-string">"删除容器失败"</span>, e);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">runImage</span><span class="hljs-params">(ShellRequestDTO requestDTO, StringBuilder sb)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        StringBuilder shell = <span class="hljs-keyword">new</span> StringBuilder();<br>        shell.append(<span class="hljs-string">"docker run -p "</span>).append(requestDTO.getPort()).append(<span class="hljs-string">":"</span>).append(requestDTO.getPort());<br>        shell.append(<span class="hljs-string">" --network=host "</span>);<br>        shell.append(<span class="hljs-string">" --name="</span>).append(requestDTO.getSimpleImageName());<br>        shell.append(<span class="hljs-string">" -d "</span>);<br>        formatEnv(requestDTO.getEnvs(), shell);<br>        formatVolumes(requestDTO.getVolumes(), shell);<br>        shell.append(requestDTO.getImageName()).append(<span class="hljs-string">":"</span>).append(requestDTO.getTag());<br>        execute(shell.toString(), sb);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">formatVolumes</span><span class="hljs-params">(List&lt;String&gt; volumes, StringBuilder shell)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (volumes == <span class="hljs-keyword">null</span> || <span class="hljs-number">0</span> == volumes.size()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        volumes.forEach(volume -&gt; &#123;<br>            shell.append(<span class="hljs-string">" -v "</span>);<br>            shell.append(<span class="hljs-string">" '"</span>).append(volume).append(<span class="hljs-string">"' "</span>);<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">formatEnv</span><span class="hljs-params">(Map&lt;String, String&gt; env, StringBuilder shell)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (env == <span class="hljs-keyword">null</span> || env.isEmpty()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : env.entrySet()) &#123;<br>            shell.append(<span class="hljs-string">" -e "</span>);<br>            shell.append(entry.getKey()).append(<span class="hljs-string">"='"</span>).append(entry.getValue()).append(<span class="hljs-string">"' "</span>);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(String command, StringBuilder sb)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        BufferedReader infoInput = <span class="hljs-keyword">null</span>;<br>        BufferedReader errorInput = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            LOGGER.info(<span class="hljs-string">"======================当前执行命令======================"</span>);<br>            LOGGER.info(command);<br>            LOGGER.info(<span class="hljs-string">"======================当前执行命令======================"</span>);<br>            <span class="hljs-comment">//执行脚本并等待脚本执行完成</span><br>            String[] commands = &#123; <span class="hljs-string">"/bin/sh"</span>, <span class="hljs-string">"-c"</span>, command &#125;;<br>            Process process = Runtime.getRuntime().exec(commands);<br>            <span class="hljs-comment">//写出脚本执行中的过程信息</span><br>            infoInput = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(process.getInputStream()));<br>            errorInput = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(process.getErrorStream()));<br>            String line = <span class="hljs-string">""</span>;<br>            <span class="hljs-keyword">while</span> ((line = infoInput.readLine()) != <span class="hljs-keyword">null</span>) &#123;<br>                sb.append(line).append(System.lineSeparator());<br>                LOGGER.info(line);<br>            &#125;<br>            <span class="hljs-keyword">while</span> ((line = errorInput.readLine()) != <span class="hljs-keyword">null</span>) &#123;<br>                sb.append(line).append(System.lineSeparator());<br>                LOGGER.error(line);<br>            &#125;<br>            <span class="hljs-comment">//阻塞执行线程直至脚本执行完成后返回</span><br>            process.waitFor();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (infoInput != <span class="hljs-keyword">null</span>) &#123;<br>                    infoInput.close();<br>                &#125;<br>                <span class="hljs-keyword">if</span> (errorInput != <span class="hljs-keyword">null</span>) &#123;<br>                    errorInput.close();<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><ul>
<li><a href="https://docs.docker.com/engine/api/v1.24/" target="_blank" rel="noopener">docker rest api 官方文档</a></li>
<li><a href="https://jenkins.io/zh/doc/" target="_blank" rel="noopener">jenkins 官方文档</a></li>
<li><a href="https://docs.docker.com/engine/" target="_blank" rel="noopener">docker 官方文档</a></li>
</ul>
]]></content>
      <categories>
        <category>jenkins</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>树莓派 docker 运行 redis</title>
    <url>/2020/03/31/2020-03-31-raspberry-docker-redis/</url>
    <content><![CDATA[<blockquote>
<p>树莓派上运行docker是不同于其他平台，树莓派属于arm32架构，经过前期的踩坑，在树莓派中运行docker镜像需要注意镜像对于doker的支持，在官方镜像搜索页是有系统架构作为删选的，如果需要运行arm32架构的镜像，需要使用对应的版本。</p>
</blockquote>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li>树莓派4B</li>
<li>docker</li>
<li>docker-compose</li>
</ul>
<h2 id="使用镜像"><a href="#使用镜像" class="headerlink" title="使用镜像"></a>使用镜像</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">arm32v7&#x2F;redis<br></code></pre></td></tr></table></figure>

<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">.<br>│  .env<br>│  docker-compose.yml<br>│<br>└─redis<br>    └─config<br></code></pre></td></tr></table></figure>


<h2 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">version: &#39;3&#39;<br><br>services:<br>  redis:<br>    container_name: reids-docker        # 指定容器的名称<br>    image: arm32v7&#x2F;redis                   # 指定镜像和版本,如果是树莓派，必须选择对应架构版本的镜像，不然无法运行<br>    restart: always<br>    command: --appendonly yes<br>    ports:<br>      - &quot;6379:6379&quot;<br>    volumes:<br>      - &quot;$&#123;REDIS_DIR&#125;&#x2F;data:&#x2F;data&quot;           # 挂载数据目录<br>      - &quot;$&#123;REDIS_DIR&#125;&#x2F;config&#x2F;redis.conf:&#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;redis.conf&quot;      # 挂载配置文件目录<br></code></pre></td></tr></table></figure>

<h2 id="env"><a href="#env" class="headerlink" title=".env"></a>.env</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">REDIS_DIR&#x3D;.&#x2F;redis<br></code></pre></td></tr></table></figure>



<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>在根目录(docker-compose.yml所在目录)</p>
<p>启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">dokcer-compose up -d<br></code></pre></td></tr></table></figure>

<p>停止</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">docker-compose stop<br></code></pre></td></tr></table></figure>

<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/WinterChenS/docker-compose-simple" target="_blank" rel="noopener">源码地址</a></p>
]]></content>
      <categories>
        <category>Raspberry</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>raspberry</tag>
        <tag>arm</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>树莓派 docker 运行 mysql</title>
    <url>/2020/03/31/2020-03-31-raspberry-docker-mysql/</url>
    <content><![CDATA[<blockquote>
<p>树莓派上运行docker是不同于其他平台，树莓派属于arm32架构，经过前期的踩坑，在树莓派中运行docker镜像需要注意镜像对于doker的支持，在官方镜像搜索页是有系统架构作为删选的，如果需要运行arm32架构的镜像，需要使用对应的版本。</p>
</blockquote>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li>树莓派4B</li>
<li>docker</li>
<li>docker-compose</li>
</ul>
<h2 id="使用镜像"><a href="#使用镜像" class="headerlink" title="使用镜像"></a>使用镜像</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">hypriot&#x2F;rpi-mysql<br></code></pre></td></tr></table></figure>

<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">.<br>│  .env<br>│  docker-compose.yml<br>│<br>└─mysql<br>    ├─config<br>    │      my.cnf<br>    │<br>    └─data<br></code></pre></td></tr></table></figure>


<h2 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">version: &#39;3&#39;<br><br>services:<br>  mysql-db:<br>    container_name: mysql-docker        # 指定容器的名称<br>    image: hypriot&#x2F;rpi-mysql                   # 指定镜像和版本<br>    ports:<br>      - &quot;3306:3306&quot;<br>    restart: always<br>    environment:<br>      MYSQL_ROOT_PASSWORD: $&#123;MYSQL_ROOT_PASSWORD&#125;<br>      MYSQL_ROOT_HOST: $&#123;MYSQL_ROOT_HOST&#125;<br>    volumes:<br>      - &quot;$&#123;MYSQL_DIR&#125;&#x2F;data:&#x2F;var&#x2F;lib&#x2F;mysql&quot;           # 挂载数据目录<br>      - &quot;$&#123;MYSQL_DIR&#125;&#x2F;config:&#x2F;etc&#x2F;mysql&#x2F;conf.d&quot;      # 挂载配置文件目录<br></code></pre></td></tr></table></figure>

<h2 id="env"><a href="#env" class="headerlink" title=".env"></a>.env</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">MYSQL_ROOT_PASSWORD&#x3D;root<br>MYSQL_ROOT_HOST&#x3D;%<br><br>MYSQL_DIR&#x3D;.&#x2F;mysql<br></code></pre></td></tr></table></figure>

<h2 id="my-cnf"><a href="#my-cnf" class="headerlink" title="my.cnf"></a>my.cnf</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">[mysqld]<br>character-set-server&#x3D;utf8mb4<br>default-time-zone&#x3D;&#39;+8:00&#39;<br>innodb_rollback_on_timeout&#x3D;&#39;ON&#39;<br>max_connections&#x3D;500<br>innodb_lock_wait_timeout&#x3D;500<br></code></pre></td></tr></table></figure>

<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>在根目录(docker-compose.yml所在目录)</p>
<p>启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">dokcer-compose up -d<br></code></pre></td></tr></table></figure>

<p>停止</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">docker-compose stop<br></code></pre></td></tr></table></figure>

<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a href="https://github.com/WinterChenS/docker-compose-simple" target="_blank" rel="noopener">源码地址</a></p>
]]></content>
      <categories>
        <category>Raspberry</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>raspberry</tag>
        <tag>mysql</tag>
        <tag>arm</tag>
      </tags>
  </entry>
  <entry>
    <title>人像摄影-樱花与儿童</title>
    <url>/2020/03/21/2020-03-21-spring-sakura/</url>
    <content><![CDATA[<p>如此明媚的夏天，谁想到在修图的时候竟下起了暴风雨甚至夹带着冰雹</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046578389278.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046579209318.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046579789376.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046582320168.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046583257345.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046584582177.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804112356.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
        <tag>人像</tag>
        <tag>樱花</tag>
      </tags>
  </entry>
  <entry>
    <title>jenkins+docker自动化运维发布</title>
    <url>/2020/03/14/2020-03-14-docker-jenkins/</url>
    <content><![CDATA[<p>面对微服务越来越繁杂的开发和运维，自动化部署的出现无异于雪中送炭，今天就开始一步一步搭建自动化部署平台，基于Docker。</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046408408030.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">jenkins持续交付流程图</span></p>
<p>本次搭建的前提；</p>
<ul>
<li>Docker</li>
</ul>
<h2 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h2><p>运行命令：</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">sudo yum remove docker \<br>                  docker-client \<br>                  docker-client-latest \<br>                  docker-common \<br>                  docker-latest \<br>                  docker-latest-logrotate \<br>                  docker-logrotate \<br>                  docker-engine<br></code></pre></td></tr></table></figure>
<p>安装所需的软件包。 yum-utils提供了yum-config-manager实用程序，devicemapper存储驱动程序需要device-mapper-persistent-data和lvm2</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">sudo yum install -y yum-utils \<br>  device-mapper-persistent-data \<br>  lvm2<br></code></pre></td></tr></table></figure>

<p>设置稳定的镜像仓库</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">sudo yum-config-manager \<br>    --add-repo \<br>    https://download.docker.com/linux/centos/docker-ce.repo<br></code></pre></td></tr></table></figure>
<p>安装最新版docker</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">sudo yum install docker-ce docker-ce-cli containerd.io<br></code></pre></td></tr></table></figure>

<h2 id="docker加速"><a href="#docker加速" class="headerlink" title="docker加速"></a>docker加速</h2><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">vim /etc/docker/daemon.json<br></code></pre></td></tr></table></figure>
<p>如果不存在daemon.json文件则新建一个</p>
<p>daemon.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">"registry-mirrors"</span>:[<span class="hljs-string">"https://docker.mirrors.ustc.edu.cn"</span>]<br>&#125;<br></code></pre></td></tr></table></figure>
<p>重启守护进程</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">sudo systemctl daemon-reload<br>sudo systemctl restart docker<br></code></pre></td></tr></table></figure>

<h3 id="docker常用命令"><a href="#docker常用命令" class="headerlink" title="docker常用命令"></a>docker常用命令</h3><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 进入容器</span><br>docker exec -it &lt;containerId&gt; /bin/bash<br><span class="hljs-meta">#</span><span class="bash"> 查看容器日志</span><br>docker logs -f &lt;containerId&gt;<br></code></pre></td></tr></table></figure>

<h2 id="jenkins和docker私有仓库registry环境安装"><a href="#jenkins和docker私有仓库registry环境安装" class="headerlink" title="jenkins和docker私有仓库registry环境安装"></a>jenkins和docker私有仓库registry环境安装</h2><p>安装jenkins</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">docker run --name devops-jenkins --user=root -p 8080:8080 -p 50000:50000 -v /opt/data/jenkins_home:/var/jenkins_home -d jenkins/jenkins:lts<br></code></pre></td></tr></table></figure>
<p>安装私有仓库</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">docker run --name devops-registry -p 5000:5000 -v /opt/devdata/registry:/var/lib/registry -d registry<br></code></pre></td></tr></table></figure>

<h2 id="jenkins-配置"><a href="#jenkins-配置" class="headerlink" title="jenkins 配置"></a>jenkins 配置</h2><h3 id="初始化jenkins及安装插件"><a href="#初始化jenkins及安装插件" class="headerlink" title="初始化jenkins及安装插件"></a>初始化jenkins及安装插件</h3><p>启动完jenkins后通过浏览器输入地址http://部署jenkins主机IP:端口</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046408678823.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>根据提示从输入administrator password 或者可以通过启动日志</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">docker logs devops-jenkins<br></code></pre></td></tr></table></figure>

<p>查看这个password 如：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046408898636.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>选择安装插件方式，这里我是默认第一个</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046409275829.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>进入插件安装界面，连网等待插件安装</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046409588027.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>安装完插件后，进入创建管理员界面</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046409917349.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>输入完管理员账号后，点击continue as admin 进入管理界面点击系统管理-插件管理中安装docker构建插件和角色管理插件<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046410087986.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>安装docker构建插件，在可选插件中查找docker build step plugin<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046410493996.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>安装角色管理插件，在可选插件中查找Role-based Authorization Strategy<br><img   class="lazyload" data-original="https://raw.githubusercontent.com/WinterChenS/imgrpo/develop/blog/20200314203553.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>安装SSH插件，用于构建成功后执行远端服务器脚本从docker本地仓库获取镜像后发布新版本<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046410824216.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>安装 Email Extension Plugin 插件，配置自动发送邮件<br><img   class="lazyload" data-original="https://raw.githubusercontent.com/WinterChenS/imgrpo/develop/blog/20200314203648.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h2 id="配置jenkins属性及相关权限"><a href="#配置jenkins属性及相关权限" class="headerlink" title="配置jenkins属性及相关权限"></a>配置jenkins属性及相关权限</h2><h3 id="jenkins属性"><a href="#jenkins属性" class="headerlink" title="jenkins属性"></a>jenkins属性</h3><p>点击系统管理-&gt;Global Tool Configuration-&gt;找到jdk点击新增按钮(自动安装请先到Oracle注册账号)</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046412428029.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>配置git<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046414103980.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>点击系统管理-&gt;Global Tool Configuration-&gt;找到maven点击新增按钮</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046415092796.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>点击系统管理-&gt;系统设置<br>配置SSH</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046416035927.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>配置docker</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046417017947.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>设置docker主机可以被远程访问</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">vim /usr/lib/systemd/system/docker.service<br>在ExecStart=/usr/bin/docker daemon 后追加 -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock<br><br><span class="hljs-meta">#</span><span class="bash">如：</span><br>ExecStart=/usr/bin/docker daemon -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock<br></code></pre></td></tr></table></figure>
<p>重启docker</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">sudo systemctl daemon-reload<br>sudo systemctl restart docker<br></code></pre></td></tr></table></figure>

<p>重新启动jenkins容器</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 查看所有的容器</span><br>docker container ls -a<br><span class="hljs-meta">#</span><span class="bash"> 找到jenkins和私有仓库的containerId，启动</span><br>docker container start &lt;container Id&gt;<br></code></pre></td></tr></table></figure>

<p>配置邮件</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046417809495.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h2 id="jenkins权限"><a href="#jenkins权限" class="headerlink" title="jenkins权限"></a>jenkins权限</h2><ol>
<li><p>选择系统管理-&gt;Configuration Global Security（全局安全设置）-&gt;进入选择启用安全：<br>TCP port for JNLP agents -&gt;禁用，访问控制-安全域-&gt;jenkins专有用户数据库，访问控制-授权策略-&gt;Role-Based Strategy 如：<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046418750899.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
</li>
<li><p>选择系统管理-&gt;Manage and Assign Roles-&gt;Manage Roles：</p>
</li>
</ol>
<ul>
<li><p>添加Global Roles(admin、member、ops、others)，<br>设置全局角色（全局角色可以对jenkins系统进行设置与项目的操作）<br>admin:对整个jenkins都可以进行操作<br>ops:可以对所有的job进行管理<br>other/member:只有读的权限</p>
</li>
<li><p>添加project Roles(dmp-manager、dmp-view、tsc-manager、tsc-view)并且给添加的角色分配如下权限</p>
</li>
</ul>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046419889709.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<ul>
<li>注意：在添加project Roles时，如果想让不同的用户看到不同的job,必须设置Pattern,如上dmp_manager角色就只能查看以dmp开头的job,Pattern规则必须是“dmp.”，注意是以“.”结尾的匹配规则，tsc亦是如此。</li>
</ul>
<ol start="3">
<li><p>选择系统管理-&gt;管理用户:新建几个管理员用户如：dmpadmin、tscadmin<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046421301054.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
</li>
<li><p>选择系统管理-&gt;Manage and Assign Roles-&gt;Assign Relos:把第三步的用户加到user/group中并授于对应的角色权限 如：</p>
</li>
</ol>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046422244534.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h2 id="创建-编译-打包-上传docker镜像任务-执行远端脚本从私有仓库获取镜像发布新版本-发布完成发送邮件推送"><a href="#创建-编译-打包-上传docker镜像任务-执行远端脚本从私有仓库获取镜像发布新版本-发布完成发送邮件推送" class="headerlink" title="创建-编译-打包-上传docker镜像任务-执行远端脚本从私有仓库获取镜像发布新版本-发布完成发送邮件推送"></a>创建-编译-打包-上传docker镜像任务-执行远端脚本从私有仓库获取镜像发布新版本-发布完成发送邮件推送</h2><h3 id="新建任务"><a href="#新建任务" class="headerlink" title="新建任务"></a>新建任务</h3><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046424059702.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="源码管理"><a href="#源码管理" class="headerlink" title="源码管理"></a>源码管理</h3><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046425340162.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046426402092.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="构建触发器"><a href="#构建触发器" class="headerlink" title="构建触发器"></a>构建触发器</h3><p>如果没有此项，请安装该插件 Generic Webhook Trigger<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046427561198.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046429360706.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h4 id="github创建webhook"><a href="#github创建webhook" class="headerlink" title="github创建webhook"></a>github创建webhook</h4><p>http://用户名:webToken@Jenkins服务器地址:端口/generic-webhook-trigger/invoke<br>如<a href="http://admin:dsfadfadsfaf@192.168.1.1:8080/generic-webhook-trigger/invoke" target="_blank" rel="noopener">http://admin:dsfadfadsfaf@192.168.1.1:8080/generic-webhook-trigger/invoke</a></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046430488461.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br>点击添加webhook<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046431727234.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046433423372.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br>图中的token和上面构建触发器中填写的token是一致的，如果都没有构建器中没有填写，那么这边可以不用添加</p>
<h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><p>1、maven 构建项目<br>2、构建docker镜像<br>3、推送docker镜像</p>
<h4 id="maven-构建镜像"><a href="#maven-构建镜像" class="headerlink" title="maven 构建镜像"></a>maven 构建镜像</h4><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046437452675.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br><img   class="lazyload" data-original="https://raw.githubusercontent.com/WinterChenS/imgrpo/develop/blog/20200314210359.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h4 id="构建和推送docker镜像"><a href="#构建和推送docker镜像" class="headerlink" title="构建和推送docker镜像"></a>构建和推送docker镜像</h4><p><img   class="lazyload" data-original="https://raw.githubusercontent.com/WinterChenS/imgrpo/develop/blog/20200314210526.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h4 id="SSH执行远端服务器脚本运行最新镜像"><a href="#SSH执行远端服务器脚本运行最新镜像" class="headerlink" title="SSH执行远端服务器脚本运行最新镜像"></a>SSH执行远端服务器脚本运行最新镜像</h4><p><img   class="lazyload" data-original="https://raw.githubusercontent.com/WinterChenS/imgrpo/develop/blog/20200314210742.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h2 id="构建后操作"><a href="#构建后操作" class="headerlink" title="构建后操作"></a>构建后操作</h2><h3 id="发送邮件推送"><a href="#发送邮件推送" class="headerlink" title="发送邮件推送"></a>发送邮件推送</h3><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046438878086.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h2 id="验证构建"><a href="#验证构建" class="headerlink" title="验证构建"></a>验证构建</h2><p>见证奇迹的时候到了</p>
<p>点击立即构建</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046440561047.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046441757809.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h2 id="my-site-run-sh"><a href="#my-site-run-sh" class="headerlink" title="my-site-run.sh"></a>my-site-run.sh</h2><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><code class="hljs shell">docker pull 118.25.36.41:5000/winterchen/my-site:1.0.0-RELEASE<br><br>docker stop 118.25.36.41:5000/winterchen/my-site:1.0.0-RELEASE<br><br>docker rm 118.25.36.41:5000/winterchen/my-site:1.0.0-RELEASE<br><br>docker run 118.25.36.41:5000/winterchen/my-site:1.0.0-RELEASE<br></code></pre></td></tr></table></figure>













]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>jenkins</tag>
        <tag>DevOps</tag>
      </tags>
  </entry>
  <entry>
    <title>静物摄影-草莓</title>
    <url>/2020/03/08/2020-03-08-black-photo-by-strawberry/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046405291900.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046406946784.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
        <tag>静物</tag>
      </tags>
  </entry>
  <entry>
    <title>人像摄影-黑白</title>
    <url>/2020/02/27/2020-02-27-black-and-white/</url>
    <content><![CDATA[<p>疫情还没有过去，宅在家里给老婆孩子拍了一组</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046386727752.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046387955974.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046389256574.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046391208940.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046393033810.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046394530884.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046396045739.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046398050762.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046399297898.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
        <tag>人像</tag>
      </tags>
  </entry>
  <entry>
    <title>每日一道算法题-三个数的和</title>
    <url>/2019/10/09/2019-10-09-arithmetic-15-3-sum/</url>
    <content><![CDATA[<h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><p>给定一个包含 n 个整数的数组 nums，判断 nums 中是否存在三个元素 a，b，c ，使得 a + b + c = 0 ？找出所有满足条件且不重复的三元组。</p>
<p>注意：答案中不可以包含重复的三元组。</p>
<p>例如, 给定数组 <code>nums = [-1, 0, 1, 2, -1, -4]</code> ，</p>
<p>满足要求的三元组集合为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">[<br>  [-1, 0, 1],<br>  [-1, -1, 2]<br>]<br></code></pre></td></tr></table></figure>

<h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>如果使用普通算法，那么复杂度为O(n3)，这样的方式效率很低；<br>我们可以采用<em>分治</em>的思想，想要找出三个数相加等于0，我们可以先将nums进行排序，然后依次遍历，每一项nums[i]我们都认为它最终都能够组成0中的一个数字(当然当nums[i]大于0的时候不可能为0)，那么我们的目标就是找到剩下的元素（除a[i]）两个相加等于-a[i]。</p>
<p>通过上面的思路，我们的问题转化为了给定一个数组，找出其中两个相加等于给定值， 这个问题是比较简单的， 我们只需要对数组进行排序，然后双指针解决即可。 加上我们需要外层遍历依次数组，因此总的时间复杂度应该是O(N^2)</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046380795935.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="关键"><a href="#关键" class="headerlink" title="关键"></a>关键</h3><ul>
<li>排序之后，用双指针</li>
<li>分治</li>
</ul>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> List&lt;List&lt;Integer&gt;&gt; threeSum(<span class="hljs-keyword">int</span>[] nums) &#123;<br>        List&lt;List&lt;Integer&gt;&gt; resultList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (nums == <span class="hljs-keyword">null</span> || nums.length &lt; <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> resultList;<br>        Arrays.sort(nums);<span class="hljs-comment">//排序</span><br>        <span class="hljs-keyword">int</span> len = nums.length;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) &#123;<span class="hljs-comment">// C位</span><br>            <span class="hljs-keyword">if</span> (nums[i] &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; nums[i] == nums[i - <span class="hljs-number">1</span>]) <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-keyword">int</span> L = i + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">int</span> R = len - <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span> (L &lt; R)&#123;<br>                <span class="hljs-keyword">int</span> sum = nums[i] + nums[L] + nums[R];<br>                <span class="hljs-keyword">if</span> (sum == <span class="hljs-number">0</span>)&#123;<br>                    resultList.add(Arrays.asList(nums[i], nums[L], nums[R]));<br>                    <span class="hljs-keyword">while</span>(L &lt; R &amp;&amp; nums[L] == nums[L + <span class="hljs-number">1</span>]) L++;<br>                    <span class="hljs-keyword">while</span>(L &lt; R &amp;&amp; nums[R] == nums[R - <span class="hljs-number">1</span>]) R--;<br>                    L++;<br>                    R--;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sum &lt; <span class="hljs-number">0</span>)&#123;<br>                    L++;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    R--;<br>                &#125;<br>            &#125;<br>        &#125;<br>            <span class="hljs-keyword">return</span> resultList;<br>    &#125;<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>每日一道算法题-有效的括号</title>
    <url>/2019/10/08/2019-10-08-arithmetic-20-valid-parentheses/</url>
    <content><![CDATA[<h3 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h3><p>给定一个只包括 <code>&#39;(&#39;，&#39;)&#39;，&#39;{&#39;，&#39;}&#39;，&#39;[&#39;，&#39;]&#39;</code> 的字符串，判断字符串是否有效。</p>
<p>有效字符串需满足：</p>
<pre><code>左括号必须用相同类型的右括号闭合。
左括号必须以正确的顺序闭合。</code></pre><p>注意空字符串可被认为是有效字符串。</p>
<p>示例 1:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">输入: &quot;()&quot;<br>输出: true<br></code></pre></td></tr></table></figure>
<p>示例 2:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">输入: &quot;()[]&#123;&#125;&quot;<br>输出: true<br></code></pre></td></tr></table></figure>
<p>示例 3:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">输入: &quot;(]&quot;<br>输出: false<br></code></pre></td></tr></table></figure>
<p>示例 4:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">输入: &quot;([)]&quot;<br>输出: false<br></code></pre></td></tr></table></figure>
<p>示例 5:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">输入: &quot;&#123;[]&#125;&quot;<br>输出: true<br></code></pre></td></tr></table></figure>

<h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><ul>
<li>使用stack</li>
<li>遍历字符串</li>
<li>如果当前字符为左半边括号是，则将其压入栈中</li>
<li>如果是右括号时，分类讨论：<ul>
<li>如栈不为空且为对应的左半边括号，则取出栈顶元素，继续循环</li>
<li>若此时栈为空，则直接返回false</li>
<li>若不为对应的左半边括号，返回false</li>
</ul>
</li>
</ul>
<p><img    class="lazyload" data-original="https://raw.githubusercontent.com/azl397985856/leetcode/master/assets/20.validParentheses.gif" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">图解</span></p>
<h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><h4 id="java"><a href="#java" class="headerlink" title="java"></a>java</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isValid</span><span class="hljs-params">(String s)</span></span>&#123;<br>        <span class="hljs-keyword">if</span> (!StringUtils.hasText(s)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        Stack&lt;Character&gt; stack = <span class="hljs-keyword">new</span> Stack&lt;&gt;();<span class="hljs-comment">//定义一个stack</span><br>        <span class="hljs-keyword">char</span>[] chars = s.toCharArray();<br>        Map&lt;Character, Character&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<span class="hljs-comment">//hash表</span><br>        map.put(<span class="hljs-string">'('</span>,<span class="hljs-string">')'</span>);<br>        map.put(<span class="hljs-string">'['</span>,<span class="hljs-string">']'</span>);<br>        map.put(<span class="hljs-string">'&#123;'</span>,<span class="hljs-string">'&#125;'</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">char</span> aChar : chars) &#123;<br>            <span class="hljs-comment">// 如果是左半边括号，则压入栈</span><br>            <span class="hljs-keyword">if</span> (map.containsKey(aChar))&#123;<br>                stack.push(aChar);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">// 不是左半边括号</span><br>                <span class="hljs-comment">// 只有栈中有左半边才有效</span><br>                <span class="hljs-keyword">if</span> (stack.size() != <span class="hljs-number">0</span>)&#123;<br>                    <span class="hljs-comment">// 出栈</span><br>                    Character pop = stack.pop();<br>                    <span class="hljs-comment">// 如果右半边与左半边无法对应则返回false</span><br>                    <span class="hljs-keyword">if</span> (!map.get(pop).equals(aChar))&#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>                    &#125;<span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">// 继续循环</span><br>                        <span class="hljs-keyword">continue</span>;<br>                    &#125;<br>                &#125;<span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 左半边括号全部出栈表示两边对应上</span><br>        <span class="hljs-keyword">return</span> stack.isEmpty();<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="js"><a href="#js" class="headerlink" title="js"></a>js</h4><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><br><span class="hljs-keyword">var</span> isValid = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s</span>) </span>&#123;<br>    <span class="hljs-keyword">let</span> valid = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">const</span> stack = [];<br>    <span class="hljs-keyword">const</span> mapper = &#123;<br>        <span class="hljs-string">'&#123;'</span>: <span class="hljs-string">"&#125;"</span>,<br>        <span class="hljs-string">"["</span>: <span class="hljs-string">"]"</span>,<br>        <span class="hljs-string">"("</span>: <span class="hljs-string">")"</span><br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i <span class="hljs-keyword">in</span> s) &#123;<br>        <span class="hljs-keyword">const</span> v = s[i];<br>        <span class="hljs-keyword">if</span> ([<span class="hljs-string">'('</span>, <span class="hljs-string">'['</span>, <span class="hljs-string">'&#123;'</span>].indexOf(v) &gt; <span class="hljs-number">-1</span>) &#123;<br>            stack.push(v);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">const</span> peak = stack.pop();<br>            <span class="hljs-keyword">if</span> (v !== mapper[peak]) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (stack.length &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">return</span> valid;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="python"><a href="#python" class="headerlink" title="python"></a>python</h4><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Solution</span>:</span><br>       <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">isValid</span><span class="hljs-params">(self,s)</span>:</span><br>         stack = []<br>         map = &#123;<br>           <span class="hljs-string">"&#123;"</span>:<span class="hljs-string">"&#125;"</span>,<br>           <span class="hljs-string">"["</span>:<span class="hljs-string">"]"</span>,<br>           <span class="hljs-string">"("</span>:<span class="hljs-string">")"</span><br>         &#125;<br>         <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> s:<br>           <span class="hljs-keyword">if</span> x <span class="hljs-keyword">in</span> map:<br>             stack.append(map[x])<br>           <span class="hljs-keyword">else</span>:<br>             <span class="hljs-keyword">if</span> len(stack)!=<span class="hljs-number">0</span>:<br>               top_element = stack.pop()<br>               <span class="hljs-keyword">if</span> x != top_element:<br>                 <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>               <span class="hljs-keyword">else</span>:<br>                 <span class="hljs-keyword">continue</span><br>             <span class="hljs-keyword">else</span>:<br>               <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>         <span class="hljs-keyword">return</span> len(stack) == <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><p>以上的代码只能针对左右完全对应上，并且中间不能出现任何字符，所以这里我想拓展一下，就像代码中一样，括号能对应上并且中间有代码；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isValid</span><span class="hljs-params">(String s)</span></span>&#123;<br>        <span class="hljs-keyword">if</span> (!StringUtils.hasText(s)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        Stack&lt;Character&gt; stack = <span class="hljs-keyword">new</span> Stack&lt;&gt;();<br>        <span class="hljs-keyword">char</span>[] chars = s.toCharArray();<br>        Map&lt;Character, Character&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        map.put(<span class="hljs-string">'('</span>,<span class="hljs-string">')'</span>);<br>        map.put(<span class="hljs-string">'['</span>,<span class="hljs-string">']'</span>);<br>        map.put(<span class="hljs-string">'&#123;'</span>,<span class="hljs-string">'&#125;'</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">char</span> aChar : chars) &#123;<br>            <span class="hljs-keyword">if</span> (map.containsKey(aChar))&#123;<br>                stack.push(aChar);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (stack.size() != <span class="hljs-number">0</span> &amp;&amp; map.containsValue(aChar))&#123;<br>                    Character pop = stack.pop();<br>                    <span class="hljs-keyword">if</span> (!map.get(pop).equals(aChar))&#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>                    &#125;<span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">continue</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> stack.isEmpty();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>输入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">&quot;&#123;[(234)]&#125;&quot;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">true<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>再访白塔公园-秋</title>
    <url>/2018/12/01/2018-12-01-hangzhou-baita-autumn/</url>
    <content><![CDATA[<p>年初的时候去了一次白塔公园，那是樱花盛开的季节，如今已是深秋，这一年已经剩下一个月不到，马上就要做年终总结了，今年的计划是不是完成了呢？</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046566220012.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046696420986.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046697263440.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-3"><a href="#-3" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046566640174.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-4"><a href="#-4" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046698387475.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-5"><a href="#-5" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046699052740.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-6"><a href="#-6" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046567275195.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-7"><a href="#-7" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046568440992.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-8"><a href="#-8" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046569637183.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-9"><a href="#-9" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046701754832.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-10"><a href="#-10" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046702845970.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-11"><a href="#-11" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046570788172.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-12"><a href="#-12" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046572183856.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-13"><a href="#-13" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046574346202.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-14"><a href="#-14" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046575196265.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-15"><a href="#-15" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046706629246.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-16"><a href="#-16" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046707391436.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2>]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
      </tags>
  </entry>
  <entry>
    <title>杭州滨江夜景</title>
    <url>/2018/11/26/2018-11-26-hangzhou/</url>
    <content><![CDATA[<p>那天晚上天气不是很好，雾霾有点重.</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/imgrpo/blog/20210804112251.jpeg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046564512198.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2>]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
      </tags>
  </entry>
  <entry>
    <title>湘湖-秋</title>
    <url>/2018/11/04/2018-11-04-xianghu/</url>
    <content><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046547438366.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046549155172.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046550627248.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-3"><a href="#-3" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046551404218.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-4"><a href="#-4" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046552038034.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-5"><a href="#-5" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046689026348.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-6"><a href="#-6" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046690752476.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046553938162.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
      </tags>
  </entry>
  <entry>
    <title>西塘汉服节</title>
    <url>/2018/10/29/2018-10-29-xitang-hanfu/</url>
    <content><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046677880761.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046678335742.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046678616388.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-3"><a href="#-3" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046679194156.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-4"><a href="#-4" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046679623686.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-5"><a href="#-5" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046679990497.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-6"><a href="#-6" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046680430368.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-7"><a href="#-7" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046680771053.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-8"><a href="#-8" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046542274854.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-9"><a href="#-9" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046682029199.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-10"><a href="#-10" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046682409438.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-11"><a href="#-11" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046542968920.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-12"><a href="#-12" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046543339594.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2>]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
      </tags>
  </entry>
  <entry>
    <title>初秋-钱塘江人像</title>
    <url>/2018/10/21/2018-10-21-woman/</url>
    <content><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046675368516.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046675889180.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046676575840.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
      </tags>
  </entry>
  <entry>
    <title>上海影视城</title>
    <url>/2018/10/04/2018-10-04-old-shagnhai/</url>
    <content><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046534278146.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046535028684.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046535933695.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-3"><a href="#-3" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046536907253.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-4"><a href="#-4" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046537618078.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-5"><a href="#-5" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046538185128.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-6"><a href="#-6" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046539394215.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-7"><a href="#-7" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046540289606.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-8"><a href="#-8" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046540891124.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046541559170.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
      </tags>
  </entry>
  <entry>
    <title>上海郊区</title>
    <url>/2018/10/01/2018-10-01-shanghai/</url>
    <content><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046664924423.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046665715370.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
      </tags>
  </entry>
  <entry>
    <title>朋友</title>
    <url>/2018/09/15/2018-09-15-friend/</url>
    <content><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046531466985.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046531888121.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046532090179.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046532301272.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
      </tags>
  </entry>
  <entry>
    <title>夏天的尾巴</title>
    <url>/2018/09/12/2018-09-12-summer-over/</url>
    <content><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046524889069.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046525552219.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046525990464.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-3"><a href="#-3" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046526425101.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-4"><a href="#-4" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046526575498.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046527429163.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h2 id="-5"><a href="#-5" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046528315204.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-6"><a href="#-6" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046528809316.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-7"><a href="#-7" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046529042099.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-8"><a href="#-8" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046529395252.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046529746296.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
      </tags>
  </entry>
  <entry>
    <title>向日葵</title>
    <url>/2018/08/12/2018-08-20-summer-sunflower/</url>
    <content><![CDATA[<p>台风天的向日葵</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046644425654.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046646280274.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046646700905.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046647490901.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046648249786.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046648922345.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046649741419.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot整合mybatis 使用HikariCP连接池</title>
    <url>/2018/07/25/spring-boot-mybatis-hikaricp/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Springboot让Java开发更加美好，本节主要讲的是使用Hikari数据库连接池，如果需要使用druid连接池的请看我另外一篇博客，<a href="https://blog.csdn.net/winter_chen001/article/details/80010967" target="_blank" rel="noopener">springboot Mybatis 整合</a>（这篇文章有详细搭建springboot项目的过程，对于刚接触springboot的新手有帮助）。</p>
<h3 id="为什么使用HikariCP"><a href="#为什么使用HikariCP" class="headerlink" title="为什么使用HikariCP"></a>为什么使用HikariCP</h3><p>在Springboot2.X版本，数据库的连接池官方推荐使用<a href="https://github.com/brettwooldridge/HikariCP" target="_blank" rel="noopener">HikariCP</a>，官方的原话：</p>
<blockquote>
<p> Production database connections can also be auto-configured by using a pooling<code>DataSource</code>. Spring Boot uses the following algorithm for choosing a specific implementation:</p>
<ol>
<li><p>We prefer<a href="https://github.com/brettwooldridge/HikariCP" target="_blank" rel="noopener">HikariCP</a>for its performance and concurrency. If HikariCP is available, we always choose it.</p>
</li>
<li><p>Otherwise, if the Tomcat pooling<code>DataSource</code>is available, we use it.</p>
</li>
<li><p>If neither HikariCP nor the Tomcat pooling datasource are available and if<a href="https://commons.apache.org/proper/commons-dbcp/" target="_blank" rel="noopener">Commons DBCP2</a>is available, we use it.</p>
</li>
</ol>
</blockquote>
<p>意思是说：</p>
<ol>
<li><p>我们更喜欢HikariCP的性能和并发性。如果有HikariCP，我们总是选择它</p>
</li>
<li><p>否则，如果Tomcat池数据源可用，我们将使用它。</p>
</li>
<li><p>如果HikariCP和Tomcat池数据源都不可用，如果Commons DBCP2可用，我们将使用它。</p>
</li>
</ol>
<p>那么如何使用HikariCP呢？</p>
<p>如果你的springboot版本是2.X，当你使用<code>spring-boot-starter-jdbc</code>或者<code>spring-boot-starter-data-jpa</code>依赖，springboot就会自动引入HikariCP的依赖了。</p>
<h3 id="使用指定的数据库连接池"><a href="#使用指定的数据库连接池" class="headerlink" title="使用指定的数据库连接池"></a>使用指定的数据库连接池</h3><p>如果你需要使用指定的数据库连接池，那么你需要在<code>application.properties</code>中配置：<code>spring.datasource.type</code></p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li><p>JDK： 1.8</p>
</li>
<li><p>Maven: 3.3.9</p>
</li>
<li><p>SpringBoot: 2.0.3.RELEASE</p>
</li>
<li><p>开发工具：Intellij IDEA 2017.1.3</p>
</li>
</ul>
<h2 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h2><p>本次的配置中我们持久层使用mybatis，使用HikariCP作为数据库连接池。</p>
<h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml">      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>		<span class="hljs-comment">&lt;!--排除默认的tomcat-jdbc--&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.46<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- mybatis一定要使用starter，不然无法自动配置和注入 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>以上的依赖就足够了，前面介绍过，只需要导入<code>spring-boot-starter-jdbc</code>依赖springboot就默认使用Hikari作为数据库连接池了。</p>
<h3 id="创建数据表"><a href="#创建数据表" class="headerlink" title="创建数据表"></a>创建数据表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> mytest;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_user(<br>  userId <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> PRIMARY <span class="hljs-keyword">KEY</span> AUTO_INCREMENT,<br>  userName <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> ,<br>  <span class="hljs-keyword">password</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> ,<br>  phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span><br>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">INNODB</span> AUTO_INCREMENT=<span class="hljs-number">1000</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8;<br></code></pre></td></tr></table></figure>



<h3 id="创建实体类"><a href="#创建实体类" class="headerlink" title="创建实体类"></a>创建实体类</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.model;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Donghua.Chen on 2018/7/25.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDomain</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Integer userId;<br><br>    <span class="hljs-keyword">private</span> String userName;<br><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-keyword">private</span> String phone;<br><br>    <span class="hljs-comment">// @TODO 省略get/set</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="创建Dao以及mapper映射"><a href="#创建Dao以及mapper映射" class="headerlink" title="创建Dao以及mapper映射"></a>创建Dao以及mapper映射</h3><h4 id="创建Dao类"><a href="#创建Dao类" class="headerlink" title="创建Dao类"></a>创建Dao类</h4><p>创建一个dao的包，并且在这个包下创建一个UserDao</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.dao;<br><br><span class="hljs-keyword">import</span> com.winterchen.model.UserDomain;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Donghua.Chen on 2018/7/25.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserDao</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(UserDomain record)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">deleteUserById</span><span class="hljs-params">(@Param(<span class="hljs-string">"userId"</span>)</span> Integer userId)</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateUser</span><span class="hljs-params">(UserDomain userDomain)</span></span>;<br><br>    <span class="hljs-function">List&lt;UserDomain&gt; <span class="hljs-title">selectUsers</span><span class="hljs-params">()</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意：一定不要忘了使用<code>@Mapper</code>注解，如果没有这个注解，spring就无法扫描到这个类，导致项目启动报错。</p>
<h4 id="创建Mapper映射"><a href="#创建Mapper映射" class="headerlink" title="创建Mapper映射"></a>创建Mapper映射</h4><p>上一步我们创建dao数据库持久层类，由于本文使用的是xml映射的方式，所以我们需要创建一个xml映射文件。</p>
<p>在<code>resources</code>文件夹下新建一个文件夹<code>mapper</code>：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.winterchen.dao.UserDao"</span> &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BASE_TABLE"</span>&gt;</span><br>        t_user<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BASE_COLUMN"</span>&gt;</span><br>        userId,userName,password,phone<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.winterchen.model.UserDomain"</span>&gt;</span><br>        INSERT INTO<br>        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"BASE_TABLE"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span>&gt;</span><br>            userName,password,<br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"phone != null"</span>&gt;</span><br>                phone,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"VALUES("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span>&gt;</span><br>            #&#123;userName, jdbcType=VARCHAR&#125;,#&#123;password, jdbcType=VARCHAR&#125;,<br>            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"phone != null"</span>&gt;</span><br>                #&#123;phone, jdbcType=VARCHAR&#125;,<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteUserById"</span>&gt;</span><br>      DELETE FROM<br>      <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"BASE_TABLE"</span>/&gt;</span><br>      WHERE<br>      userId = #&#123;userId, jdbcType=INTEGER&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 更新用户信息，为空的字段不进行置空 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateUser"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.winterchen.model.UserDomain"</span>&gt;</span><br>        UPDATE<br>        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"BASE_TABLE"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userName != null"</span>&gt;</span><br>              userName = #&#123;userName, jdbcType=VARCHAR&#125;,<br>          <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"password != null"</span>&gt;</span><br>              password = #&#123;password, jdbcType=VARCHAR&#125;,<br>          <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"phone != null"</span>&gt;</span><br>              phone = #&#123;phone, jdbcType=VARCHAR&#125;,<br>          <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>            userId = #&#123;userId, jdbcType=INTEGER&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectUsers"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.winterchen.model.UserDomain"</span>&gt;</span><br>        SELECT<br>        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"BASE_COLUMN"</span>/&gt;</span><br>        FROM<br>        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"BASE_TABLE"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>注意点：</strong> 请将<code>namespace=&quot;com.winterchen.dao.UserDao&quot;</code>改为你自己项目Dao的路径，以及下面方法的一些路径都要改为你自己项目的相关路径。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">server.port&#x3D;8080<br><br>#### 数据库连接池属性<br>spring.datasource.driver-class-name&#x3D;com.mysql.jdbc.Driver<br>spring.datasource.url&#x3D;jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;mytest?useSSL&#x3D;false&amp;useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;allowMultiQueries&#x3D;true<br>spring.datasource.username&#x3D;root<br>spring.datasource.password&#x3D;root<br>#自动提交<br>spring.datasource.default-auto-commit&#x3D;true<br>#指定updates是否自动提交<br>spring.datasource.auto-commit&#x3D;true<br>spring.datasource.maximum-pool-size&#x3D;100<br>spring.datasource.max-idle&#x3D;10<br>spring.datasource.max-wait&#x3D;10000<br>spring.datasource.min-idle&#x3D;5<br>spring.datasource.initial-size&#x3D;5<br>spring.datasource.validation-query&#x3D;SELECT 1<br>spring.datasource.test-on-borrow&#x3D;false<br>spring.datasource.test-while-idle&#x3D;true<br># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒<br>spring.datasource.time-between-eviction-runs-millis&#x3D;18800<br># 配置一个连接在池中最小生存的时间，单位是毫秒<br>spring.datasource.minEvictableIdleTimeMillis&#x3D;300000<br><br># mybatis对应的映射文件路径<br>mybatis.mapper-locations&#x3D;classpath:mapper&#x2F;*.xml<br># mybatis对应的实体类<br>mybatis.type-aliases-package&#x3D;com.winterchen.model<br></code></pre></td></tr></table></figure>



<h3 id="Service层"><a href="#Service层" class="headerlink" title="Service层"></a>Service层</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.service;<br><br><span class="hljs-keyword">import</span> com.winterchen.model.UserDomain;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Donghua.Chen on 2018/7/25.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(UserDomain record)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">deleteUserById</span><span class="hljs-params">(Integer userId)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateUser</span><span class="hljs-params">(UserDomain userDomain)</span></span>;<br><br>    <span class="hljs-function">List&lt;UserDomain&gt; <span class="hljs-title">selectUsers</span><span class="hljs-params">()</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Service-实现层"><a href="#Service-实现层" class="headerlink" title="Service 实现层"></a>Service 实现层</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.service.impl;<br><br><span class="hljs-keyword">import</span> com.winterchen.dao.UserDao;<br><span class="hljs-keyword">import</span> com.winterchen.model.UserDomain;<br><span class="hljs-keyword">import</span> com.winterchen.service.UserService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Donghua.Chen on 2018/7/25.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserDao userDao;<span class="hljs-comment">//这里会爆红，请忽略</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(UserDomain record)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> userDao.insert(record);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteUserById</span><span class="hljs-params">(Integer userId)</span> </span>&#123;<br>        userDao.deleteUserById(userId);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateUser</span><span class="hljs-params">(UserDomain userDomain)</span> </span>&#123;<br>        userDao.updateUser(userDomain);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;UserDomain&gt; <span class="hljs-title">selectUsers</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> userDao.selectUsers();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="Controller层"><a href="#Controller层" class="headerlink" title="Controller层"></a>Controller层</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.controller;<br><br><span class="hljs-keyword">import</span> com.winterchen.model.UserDomain;<br><span class="hljs-keyword">import</span> com.winterchen.service.UserService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Donghua.Chen on 2018/7/25.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/user"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">""</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title">addUser</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">            @RequestParam(value = <span class="hljs-string">"userName"</span>, required = <span class="hljs-keyword">true</span>)</span></span><br><span class="hljs-function">            String userName,</span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(value = <span class="hljs-string">"password"</span>, required = <span class="hljs-keyword">true</span>)</span></span><br><span class="hljs-function">            String password,</span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(value = <span class="hljs-string">"phone"</span>, required = <span class="hljs-keyword">false</span>)</span></span><br><span class="hljs-function">            String phone</span><br><span class="hljs-function">    )</span>&#123;<br>        UserDomain userDomain = <span class="hljs-keyword">new</span> UserDomain();<br>        userDomain.setUserName(userName);<br>        userDomain.setPassword(password);<br>        userDomain.setPhone(phone);<br>        userService.insert(userDomain);<br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">"添加成功"</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@DeleteMapping</span>(<span class="hljs-string">""</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title">deleteUser</span><span class="hljs-params">(@RequestParam(value = <span class="hljs-string">"userId"</span>, required = <span class="hljs-keyword">true</span>)</span> Integer userId)</span>&#123;<br><br>        userService.deleteUserById(userId);<br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">"删除成功"</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@PutMapping</span>(<span class="hljs-string">""</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title">updateUser</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">            @RequestParam(value = <span class="hljs-string">"userId"</span>, required = <span class="hljs-keyword">true</span>)</span></span><br><span class="hljs-function">                    Integer userId,</span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(value = <span class="hljs-string">"userName"</span>, required = <span class="hljs-keyword">false</span>)</span></span><br><span class="hljs-function">                    String userName,</span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(value = <span class="hljs-string">"password"</span>, required = <span class="hljs-keyword">false</span>)</span></span><br><span class="hljs-function">                    String password,</span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(value = <span class="hljs-string">"phone"</span>, required = <span class="hljs-keyword">false</span>)</span></span><br><span class="hljs-function">                    String phone</span><br><span class="hljs-function">    )</span>&#123;<br>        UserDomain userDomain = <span class="hljs-keyword">new</span> UserDomain();<br>        userDomain.setUserId(userId);<br>        userDomain.setUserName(userName);<br>        userDomain.setPassword(password);<br>        userDomain.setPhone(phone);<br>        userService.updateUser(userDomain);<br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-string">"更新成功"</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">""</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title">getUsers</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(userService.selectUsers());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>强行科普一下：</p>
<ul>
<li><p><code>@RequestParam</code> 用于将请求参数区数据映射到功能处理方法的参数上，<code>value</code>：参数名字，即入参的请求参数名字，如userName表示请求的参数区中的名字为userName的参数的值将传入，<code>required</code>：是否必须，默认是true，表示请求中一定要有相应的参数，否则将报404错误码；</p>
</li>
<li><p><a href="https://www.cnblogs.com/shuaifing/p/8119664.html" target="_blank" rel="noopener">@Controller和@RestController的区别？</a></p>
</li>
</ul>
<h3 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringBootMybatisHikaricpApplication</span> </span>&#123;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		SpringApplication.run(SpringBootMybatisHikaricpApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="最终项目结构"><a href="#最终项目结构" class="headerlink" title="最终项目结构"></a>最终项目结构</h3><p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046463452426.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">目录结构</span></p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>启动项目启动类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">2018-07-25 15:25:42.970  INFO 22602 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [&#x2F;**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]<br>2018-07-25 15:25:43.380  INFO 22602 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup<br>2018-07-25 15:25:43.382  INFO 22602 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Bean with name &#39;dataSource&#39; has been autodetected for JMX exposure<br>2018-07-25 15:25:43.389  INFO 22602 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Located MBean &#39;dataSource&#39;: registering with JMX server as MBean [com.zaxxer.hikari:name&#x3D;dataSource,type&#x3D;HikariDataSource]<br>2018-07-25 15:25:43.450  INFO 22602 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#39;&#39;<br>2018-07-25 15:25:43.456  INFO 22602 --- [           main] c.w.SpringBootMybatisHikaricpApplication : Started SpringBootMybatisHikaricpApplication in 6.267 seconds (JVM running for 7.784)<br></code></pre></td></tr></table></figure>

<p>这样的输出表示项目启动成功了！！如果遇到报错启动不了，请回头看看是不是有些地方没有注意到。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>项目成功启动了，那么可以开始测试了</p>
<p>推荐使用一个强大的http请求工具：Postman</p>
<h3 id="添加"><a href="#添加" class="headerlink" title="添加"></a>添加</h3><p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046463496426.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">添加</span></p>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046463538427.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">删除</span></p>
<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046463575426.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">更新</span></p>
<h3 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h3><p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046463616426.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">查找</span></p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><blockquote>
<p> 在编程的路上肯定会遇到很多的bug，程序员就是要不断的和bug作斗争，加油，愿你成为真正的大牛。有机会讲讲Hikari如何使用多数据源。</p>
</blockquote>
<p>源码地址：<a href="https://github.com/WinterChenS/springboot-learning-experience/tree/master/spring-boot-mybatis-hikaricp" target="_blank" rel="noopener">戳这里</a></p>
<p>springboot技术交流群：681513531</p>
<p>个人博客：<a href="https://winterchen.com/" target="_blank" rel="noopener">https://winterchen.com</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
        <tag>mybatis</tag>
        <tag>HikariCP</tag>
      </tags>
  </entry>
  <entry>
    <title>杭州-夜色</title>
    <url>/2018/07/05/2018-07-05-hangzhou-night/</url>
    <content><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046521010199.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046521266081.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046521681472.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-3"><a href="#-3" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046522324044.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046522939996.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>杭州记忆</p>
]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
      </tags>
  </entry>
  <entry>
    <title>初夏-荷</title>
    <url>/2018/06/25/2018-06-23-summer-after-rain/</url>
    <content><![CDATA[<p>一场初夏的雨后，天空渐渐放晴，池塘里的荷叶上盛满了雨滴，让我想起了很多年前那个追风的少年，一场暴雨淋湿了未打伞的你，用荷叶做成的雨伞的你，雨中奔跑的你，至今还留在记忆深处，无法忘怀。青春年少，如同这盛夏，又如宋冬野的《安和桥》，我知道那些夏天就像青春一样回不来，代替梦想的也只能是勉为其难，长大以后才发现生活真的是太难了，可即便是这样，还是要咬着牙继续前进啊。<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046634563046.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<hr>
<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046634701349.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046635178310.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<hr>
<p>无意间看到一个窗台前的一盆花<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046635258866.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>摄影</category>
      </categories>
      <tags>
        <tag>摄影</tag>
      </tags>
  </entry>
  <entry>
    <title>九溪十八涧行</title>
    <url>/2018/06/19/2018-06-17-travel/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046629933332.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>端午放假第一天去了九溪十八涧爬山<br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046629987797.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">茶庄</span></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046630154296.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br>喜欢这种风格的建筑，有点日式风格的感觉</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046630456340.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046630672257.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046630956295.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046631181831.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br>好清静的一个小溪，水很清澈</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046631392335.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046520043310.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br>一群小孩子在清澈的溪水中嬉戏打闹，很有童趣</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046632505170.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046632807355.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046633017320.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<hr>
<h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046633147721.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-3"><a href="#-3" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046633226005.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-4"><a href="#-4" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046520328089.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-5"><a href="#-5" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046634109410.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><h2 id="-6"><a href="#-6" class="headerlink" title=""></a><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046634189507.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046634230518.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>随笔</category>
      </categories>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>犹豫的眼神</title>
    <url>/2018/06/09/2018-06-09-pretty-gril/</url>
    <content><![CDATA[<p>18年的高考昨天结束了，六一买下来人生中第一台单反，捣鼓了几天总算知道了一些技巧，于是今天特地到云栖竹径去拍摄并且爬山，在景点门口等车的时候，看到路旁的茶园有一位优雅漂亮并且眼神中有淡淡的忧郁的妹子，按动快门记录了这一刻，不过这个照片都是后期裁剪了的，因为旁边有一个摄影师在给拍照。</p>
<a id="more"></a>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046629133224.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046629463877.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
]]></content>
      <categories>
        <category>随笔</category>
      </categories>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot2.0 mybatis 使用多数据源</title>
    <url>/2018/05/30/spring-boot-mybatis-mutil-database/</url>
    <content><![CDATA[<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046463697426.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">多数据源</span><br>springboot2.0正式版发布之后，很多的组件集成需要变更了，这次将多数据源的使用踩的坑给大家填一填。当前多数据源的主要为主从库，读写分离，动态切换数据源。使用的技术就是AOP进行dao方法的切面，所以大家的方法名开头都需要按照规范进行编写，如：<code>get***</code>、<code>add***</code> 等等，</p>
<a id="more"></a>
<h2 id="起步基础"><a href="#起步基础" class="headerlink" title="起步基础"></a>起步基础</h2><p>本次的教程需要有springboot2.0集成mybatis 作为基础：</p>
<ul>
<li><p>博客地址：<a href="https://blog.csdn.net/Winter_chen001/article/details/80010967" target="_blank" rel="noopener">springboot2.0 Mybatis 整合 (springboot2.0版本)</a></p>
</li>
<li><p>基础项目源码：<a href="https://github.com/WinterChenS/springboot2-mybatis-demo" target="_blank" rel="noopener">https://github.com/WinterChenS/springboot2-mybatis-demo</a></p>
</li>
</ul>
<p>需要以上的步骤作为基础，运行成功之后可就可以开始配置多数据源了</p>
<h2 id="开始动手"><a href="#开始动手" class="headerlink" title="开始动手"></a>开始动手</h2><h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">&lt;dependency&gt;<br>  &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;<br>  &lt;artifactId&gt;spring-boot-starter-aop&lt;&#x2F;artifactId&gt;<br>&lt;&#x2F;dependency&gt;<br></code></pre></td></tr></table></figure>

<h3 id="修改启动类"><a href="#修改启动类" class="headerlink" title="修改启动类"></a>修改启动类</h3><p>修改之前：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan</span>(<span class="hljs-string">"com.winterchen.dao"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringBootMybatisMutilDatabaseApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(SpringBootMybatisMutilDatabaseApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改之后：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringBootMybatisMutilDatabaseApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(SpringBootMybatisMutilDatabaseApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>因为改用多数据源，所以dao接口的扫描我们放在配置类中进行</p>
<h3 id="修改项目配置"><a href="#修改项目配置" class="headerlink" title="修改项目配置"></a>修改项目配置</h3><p>首先我们需要在配置文件中配置多数据源，看一下原本项目的配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>    <span class="hljs-attr">datasource:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">mysql_test</span><br>        <span class="hljs-comment">#-----------------start-----------------#  （1）</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>        <span class="hljs-comment">#-----------------end-----------------#</span><br>        <span class="hljs-comment">#druid相关配置</span><br>        <span class="hljs-attr">druid:</span><br>          <span class="hljs-comment">#监控统计拦截的filters</span><br>          <span class="hljs-attr">filters:</span> <span class="hljs-string">stat</span><br>          <span class="hljs-comment">#-----------------start-----------------# （2）</span><br>          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>          <span class="hljs-comment">#基本属性</span><br>          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/mytest?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true</span><br>          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>          <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>           <span class="hljs-comment">#-----------------end-----------------#</span><br>          <span class="hljs-comment">#配置初始化大小/最小/最大</span><br>          <span class="hljs-attr">initial-size:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">min-idle:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span><br>          <span class="hljs-comment">#获取连接等待超时时间</span><br>          <span class="hljs-attr">max-wait:</span> <span class="hljs-number">60000</span><br>          <span class="hljs-comment">#间隔多久进行一次检测，检测需要关闭的空闲连接</span><br>          <span class="hljs-attr">time-between-eviction-runs-millis:</span> <span class="hljs-number">60000</span><br>          <span class="hljs-comment">#一个连接在池中最小生存的时间</span><br>          <span class="hljs-attr">min-evictable-idle-time-millis:</span> <span class="hljs-number">300000</span><br>          <span class="hljs-attr">validation-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-string">'x'</span><br>          <span class="hljs-attr">test-while-idle:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">test-on-borrow:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">test-on-return:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-comment">#打开PSCache，并指定每个连接上PSCache的大小。oracle设为true，mysql设为false。分库分表较多推荐设置为false</span><br>          <span class="hljs-attr">pool-prepared-statements:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">max-pool-prepared-statement-per-connection-size:</span> <span class="hljs-number">20</span><br></code></pre></td></tr></table></figure>

<p>*<em>需要修改的地方: *</em></p>
<ul>
<li><p>(1) 需要将 <code>type: com.alibaba.druid.pool.DruidDataSource</code>去除；</p>
</li>
<li><p>(2) 将关于数据库的连接信息: <code>driver-class-name</code>、<code>url</code>、<code>username</code> 、<code>password</code>  去除；</p>
</li>
</ul>
<p><strong>修改后：</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>    <span class="hljs-attr">datasource:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">mysql_test</span><br>        <span class="hljs-comment">#-------------- start ----------------# (1)</span><br>        <span class="hljs-attr">master:</span><br>          <span class="hljs-comment">#基本属性--注意，这里的为【jdbcurl】-- 默认使用HikariPool作为数据库连接池</span><br>          <span class="hljs-attr">jdbcurl:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/mytest?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true</span><br>          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>          <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>        <span class="hljs-attr">slave:</span><br>          <span class="hljs-comment">#基本属性--注意，这里为 【url】-- 使用 druid 作为数据库连接池</span><br>          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/mytest?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true</span><br>          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>          <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>        <span class="hljs-attr">read:</span> <span class="hljs-string">get,select,count,list,query,find</span><br>        <span class="hljs-attr">write:</span> <span class="hljs-string">add,create,update,delete,remove,insert</span><br>        <span class="hljs-comment">#-------------- end ----------------#</span><br>        <span class="hljs-comment">#druid相关配置</span><br>        <span class="hljs-attr">druid:</span><br>          <span class="hljs-comment">#监控统计拦截的filters</span><br>          <span class="hljs-attr">filters:</span> <span class="hljs-string">stat,wall</span><br>          <span class="hljs-comment">#配置初始化大小/最小/最大</span><br>          <span class="hljs-attr">initial-size:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">min-idle:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span><br>          <span class="hljs-comment">#获取连接等待超时时间</span><br>          <span class="hljs-attr">max-wait:</span> <span class="hljs-number">60000</span><br>          <span class="hljs-comment">#间隔多久进行一次检测，检测需要关闭的空闲连接</span><br>          <span class="hljs-attr">time-between-eviction-runs-millis:</span> <span class="hljs-number">60000</span><br>          <span class="hljs-comment">#一个连接在池中最小生存的时间</span><br>          <span class="hljs-attr">min-evictable-idle-time-millis:</span> <span class="hljs-number">300000</span><br>          <span class="hljs-attr">validation-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-string">'x'</span><br>          <span class="hljs-attr">test-while-idle:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">test-on-borrow:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">test-on-return:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-comment">#打开PSCache，并指定每个连接上PSCache的大小。oracle设为true，mysql设为false。分库分表较多推荐设置为false</span><br>          <span class="hljs-attr">pool-prepared-statements:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">max-pool-prepared-statement-per-connection-size:</span> <span class="hljs-number">20</span><br></code></pre></td></tr></table></figure>

<p>需要修改地方：</p>
<ul>
<li>(1) 在如上的配置中添加<code>master</code>、<code>slave</code>两个数据源;</li>
</ul>
<p><strong>注意！！</strong>两中数据源中有一处是不一样的，原因是因为<code>master</code>数据源使用 <code>Hikari</code>连接池，<code>slave</code>使用的是<code>druid</code>作为数据库连接池，所以两处的配置分别为：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">master:</span><br>    <span class="hljs-attr">jdbcurl:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/mytest?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true</span><br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">slave:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/mytest?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true</span><br></code></pre></td></tr></table></figure>

<p>数据库的连接不一样的，如果配置成一样的会在启动的时候报错。</p>
<p><strong>注意！！</strong></p>
<p>dao接口方法的方法名规则配置在这里了，当然可以自行更改：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">read:</span> <span class="hljs-string">get,select,count,list,query,find</span><br><span class="hljs-attr">write:</span> <span class="hljs-string">add,create,update,delete,remove,insert</span><br></code></pre></td></tr></table></figure>

<h3 id="创建配置包"><a href="#创建配置包" class="headerlink" title="创建配置包"></a>创建配置包</h3><p>首先在项目的<code>/src/main/java/com/winterchen/</code>包下创建<code>config</code>包</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046463787428.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">创建config包</span></p>
<h3 id="创建数据源类型的枚举DatabaseType"><a href="#创建数据源类型的枚举DatabaseType" class="headerlink" title="创建数据源类型的枚举DatabaseType"></a>创建数据源类型的枚举DatabaseType</h3><p>该枚举类主要用来区分读写</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.config;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 列出数据源类型</span><br><span class="hljs-comment"> * Created by Donghua.Chen on 2018/5/29.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> DatabaseType &#123;<br><br>    master(<span class="hljs-string">"write"</span>), slave(<span class="hljs-string">"read"</span>);<br><br><br>    DatabaseType(String name) &#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"DatabaseType&#123;"</span> +<br>                <span class="hljs-string">"name='"</span> + name + <span class="hljs-string">'\''</span> +<br>                <span class="hljs-string">'&#125;'</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="创建线程安全的DatabaseType容器"><a href="#创建线程安全的DatabaseType容器" class="headerlink" title="创建线程安全的DatabaseType容器"></a>创建线程安全的DatabaseType容器</h3><p>多数据源必须要保证数据源的线程安全的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.config;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 保存一个线程安全的DatabaseType容器</span><br><span class="hljs-comment"> * Created by Donghua.Chen on 2018/5/29.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseContextHolder</span> </span>&#123;<br><br>        <span class="hljs-comment">//用于存放多线程环境下的成员变量</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;DatabaseType&gt; contextHolder = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDatabaseType</span><span class="hljs-params">(DatabaseType type)</span> </span>&#123;<br>        contextHolder.set(type);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DatabaseType <span class="hljs-title">getDatabaseType</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> contextHolder.get();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="创建动态数据源"><a href="#创建动态数据源" class="headerlink" title="创建动态数据源"></a>创建动态数据源</h3><p>实现数据源切换的功能就是自定义一个类扩展AbstractRoutingDataSource抽象类，其实该相当于数据源DataSource的路由中介，可以实现在项目运行时根据相应key值切换到对应的数据源DataSource上，有兴趣的同学可以看看它的源码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;DatabaseType, List&lt;String&gt;&gt; METHOD_TYPE_MAP = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br><br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">determineCurrentLookupKey</span><span class="hljs-params">()</span> </span>&#123;<br>        DatabaseType type = DatabaseContextHolder.getDatabaseType();<br>        logger.info(<span class="hljs-string">"====================dataSource =========="</span> + type);<br>        <span class="hljs-keyword">return</span> type;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setMethodType</span><span class="hljs-params">(DatabaseType type, String content)</span> </span>&#123;<br>        List&lt;String&gt; list = Arrays.asList(content.split(<span class="hljs-string">","</span>));<br>        METHOD_TYPE_MAP.put(type, list);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="创建数据源配置类DataSourceConfig"><a href="#创建数据源配置类DataSourceConfig" class="headerlink" title="创建数据源配置类DataSourceConfig"></a>创建数据源配置类DataSourceConfig</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@MapperScan</span>(<span class="hljs-string">"com.winterchen.dao"</span>)<br><span class="hljs-meta">@EnableTransactionManagement</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceConfig</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Logger logger = LoggerFactory.getLogger(DataSourceConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Environment env;  <span class="hljs-comment">// (1)</span><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DataSourceProperties properties;  <span class="hljs-comment">// (2)</span><br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.filters&#125;"</span>)   <span class="hljs-comment">// (3)</span><br>    <span class="hljs-keyword">private</span> String filters;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.initial-size&#125;"</span>)<br>    <span class="hljs-keyword">private</span> Integer initialSize;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.min-idle&#125;"</span>)<br>    <span class="hljs-keyword">private</span> Integer minIdle;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.max-active&#125;"</span>)<br>    <span class="hljs-keyword">private</span> Integer maxActive;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.max-wait&#125;"</span>)<br>    <span class="hljs-keyword">private</span> Integer maxWait;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.time-between-eviction-runs-millis&#125;"</span>)<br>    <span class="hljs-keyword">private</span> Long timeBetweenEvictionRunsMillis;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.min-evictable-idle-time-millis&#125;"</span>)<br>    <span class="hljs-keyword">private</span> Long minEvictableIdleTimeMillis;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.validation-query&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String validationQuery;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.test-while-idle&#125;"</span>)<br>    <span class="hljs-keyword">private</span> Boolean testWhileIdle;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.test-on-borrow&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> testOnBorrow;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.test-on-return&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> testOnReturn;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.pool-prepared-statements&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> poolPreparedStatements;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.druid.max-pool-prepared-statement-per-connection-size&#125;"</span>)<br>    <span class="hljs-keyword">private</span> Integer maxPoolPreparedStatementPerConnectionSize;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过Spring JDBC 快速创建 DataSource</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"masterDataSource"</span>)<br>    <span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"masterDataSource"</span>)<br>    <span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.master"</span>)  <span class="hljs-comment">// (4)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DataSource <span class="hljs-title">masterDataSource</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> DataSourceBuilder.create().build();<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 手动创建DruidDataSource,通过DataSourceProperties 读取配置</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> SQLException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"slaveDataSource"</span>)<br>    <span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"slaveDataSource"</span>)<br>    <span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.slave"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DataSource <span class="hljs-title">slaveDataSource</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>        DruidDataSource dataSource = <span class="hljs-keyword">new</span> DruidDataSource();<br>        dataSource.setFilters(filters);<br>        dataSource.setUrl(properties.getUrl());<br>        dataSource.setDriverClassName(properties.getDriverClassName());<br>        dataSource.setUsername(properties.getUsername());<br>        dataSource.setPassword(properties.getPassword());<br>        dataSource.setInitialSize(initialSize);<br>        dataSource.setMinIdle(minIdle);<br>        dataSource.setMaxActive(maxActive);<br>        dataSource.setMaxWait(maxWait);<br>        dataSource.setTimeBetweenEvictionRunsMillis(timeBetweenEvictionRunsMillis);<br>        dataSource.setMinEvictableIdleTimeMillis(minEvictableIdleTimeMillis);<br>        dataSource.setValidationQuery(validationQuery);<br>        dataSource.setTestWhileIdle(testWhileIdle);<br>        dataSource.setTestOnBorrow(testOnBorrow);<br>        dataSource.setTestOnReturn(testOnReturn);<br>        dataSource.setPoolPreparedStatements(poolPreparedStatements);<br>        dataSource.setMaxPoolPreparedStatementPerConnectionSize(maxPoolPreparedStatementPerConnectionSize);<br>        <span class="hljs-keyword">return</span> dataSource;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *  构造多数据源连接池</span><br><span class="hljs-comment">     *  Master 数据源连接池采用 HikariDataSource</span><br><span class="hljs-comment">     *  Slave  数据源连接池采用 DruidDataSource</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> master</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> slave</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Primary</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DynamicDataSource <span class="hljs-title">dataSource</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"masterDataSource"</span>)</span> DataSource master,</span><br><span class="hljs-function">                                        @<span class="hljs-title">Qualifier</span><span class="hljs-params">(<span class="hljs-string">"slaveDataSource"</span>)</span> DataSource slave) </span>&#123;<br>        Map&lt;Object, Object&gt; targetDataSources = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        targetDataSources.put(DatabaseType.master, master);<br>        targetDataSources.put(DatabaseType.slave, slave);<br><br>        DynamicDataSource dataSource = <span class="hljs-keyword">new</span> DynamicDataSource();<br>        dataSource.setTargetDataSources(targetDataSources);<span class="hljs-comment">// 该方法是AbstractRoutingDataSource的方法</span><br>        dataSource.setDefaultTargetDataSource(slave);<span class="hljs-comment">// 默认的datasource设置为myTestDbDataSource</span><br><br>        String read = env.getProperty(<span class="hljs-string">"spring.datasource.read"</span>);<br>        dataSource.setMethodType(DatabaseType.slave, read);<br><br>        String write = env.getProperty(<span class="hljs-string">"spring.datasource.write"</span>);<br>        dataSource.setMethodType(DatabaseType.master, write);<br><br>        <span class="hljs-keyword">return</span> dataSource;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title">sqlSessionFactory</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"masterDataSource"</span>)</span> DataSource myTestDbDataSource,</span><br><span class="hljs-function">                                               @<span class="hljs-title">Qualifier</span><span class="hljs-params">(<span class="hljs-string">"slaveDataSource"</span>)</span> DataSource myTestDb2DataSource) <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        SqlSessionFactoryBean fb = <span class="hljs-keyword">new</span> SqlSessionFactoryBean();<br>        fb.setDataSource(<span class="hljs-keyword">this</span>.dataSource(myTestDbDataSource, myTestDb2DataSource));<br>        fb.setTypeAliasesPackage(env.getProperty(<span class="hljs-string">"mybatis.type-aliases-package"</span>));<br>        fb.setMapperLocations(<span class="hljs-keyword">new</span> PathMatchingResourcePatternResolver().getResources(env.getProperty(<span class="hljs-string">"mybatis.mapper-locations"</span>)));<br>        <span class="hljs-keyword">return</span> fb.getObject();<br>    &#125;<br><br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DataSourceTransactionManager <span class="hljs-title">transactionManager</span><span class="hljs-params">(DynamicDataSource dataSource)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSourceTransactionManager(dataSource);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上的代码中：</p>
<ul>
<li><p>(1)  注入类 <code>Environment</code> 可以很方便的获取配置文件中的参数</p>
</li>
<li><p>(2)  <code>DataSourceProperties</code>和（4）中的 <code>@ConfigurationProperties(prefix = &quot;spring.datasource.master&quot;)</code>配合使用，将配置文件中的配置数据自动封装到实体类<code>DataSourceProperties</code>中</p>
</li>
<li><p>(3) <code>@Value</code>注解同样是指定获取配置文件中的配置;</p>
</li>
</ul>
<p>更详细的配置大家可以参考官方文档。</p>
<h3 id="配置AOP"><a href="#配置AOP" class="headerlink" title="配置AOP"></a>配置AOP</h3><p>本章的开头已经说过，多数据源动态切换的原理是利用AOP切面进行动态的切换的，当调用<code>dao</code>接口方法时，根据接口方法的方法名开头进行区分读写。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 动态处理数据源，根据命名区分</span><br><span class="hljs-comment"> * Created by Donghua.Chen on 2018/5/29.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@EnableAspectJAutoProxy</span>(proxyTargetClass = <span class="hljs-keyword">true</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceAspect</span> </span>&#123;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Logger logger = LoggerFactory.getLogger(DataSourceAspect<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>    <span class="hljs-meta">@Pointcut</span>(<span class="hljs-string">"execution(* com.winterchen.dao.*.*(..))"</span>)<span class="hljs-comment">//切点</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">aspect</span><span class="hljs-params">()</span> </span>&#123;<br><br>    &#125;<br><br><br>    <span class="hljs-meta">@Before</span>(<span class="hljs-string">"aspect()"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">before</span><span class="hljs-params">(JoinPoint point)</span> </span>&#123; <span class="hljs-comment">//在指定切点的方法之前执行</span><br>        String className = point.getTarget().getClass().getName();<br>        String method = point.getSignature().getName();<br>        String args = StringUtils.join(point.getArgs(), <span class="hljs-string">","</span>);<br>        logger.info(<span class="hljs-string">"className:&#123;&#125;, method:&#123;&#125;, args:&#123;&#125; "</span>, className, method, args);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (DatabaseType type : DatabaseType.values()) &#123;<br>                List&lt;String&gt; values = DynamicDataSource.METHOD_TYPE_MAP.get(type);<br>                <span class="hljs-keyword">for</span> (String key : values) &#123;<br>                    <span class="hljs-keyword">if</span> (method.startsWith(key)) &#123;<br>                        logger.info(<span class="hljs-string">"&gt;&gt;&#123;&#125; 方法使用的数据源为:&#123;&#125;&lt;&lt;"</span>, method, key);<br>                        DatabaseContextHolder.setDatabaseType(type);<br>                        DatabaseType types = DatabaseContextHolder.getDatabaseType();<br>                        logger.info(<span class="hljs-string">"&gt;&gt;&#123;&#125;方法使用的数据源为:&#123;&#125;&lt;&lt;"</span>, method, types);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            logger.error(e.getMessage(), e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如上可以看到，切点切在<code>dao</code>的接口方法中，根据接口方法的方法名进行匹配数据源，然后将数据源set到用于存放数据源线程安全的容器中；</p>
<p>完整的项目结构了解一下：</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046463912428.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">完整项目结构</span></p>
<h2 id="项目启动"><a href="#项目启动" class="headerlink" title="项目启动"></a>项目启动</h2><p>启动成功：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">2018-05-30 17:27:16.492  INFO 35406 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Located MBean &#39;masterDataSource&#39;: registering with JMX server as MBean [com.zaxxer.hikari:name&#x3D;masterDataSource,type&#x3D;HikariDataSource]<br>2018-05-30 17:27:16.496  INFO 35406 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Located MBean &#39;slaveDataSource&#39;: registering with JMX server as MBean [com.alibaba.druid.pool:name&#x3D;slaveDataSource,type&#x3D;DruidDataSource]<br>2018-05-30 17:27:16.498  INFO 35406 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Located MBean &#39;statFilter&#39;: registering with JMX server as MBean [com.alibaba.druid.filter.stat:name&#x3D;statFilter,type&#x3D;StatFilter]<br>2018-05-30 17:27:16.590  INFO 35406 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#39;&#39;<br>2018-05-30 17:27:16.598  INFO 35406 --- [           main] pringBootMybatisMutilDatabaseApplication : Started SpringBootMybatisMutilDatabaseApplication in 11.523 seconds (JVM running for 13.406)<br></code></pre></td></tr></table></figure>

<p>添加用户（write）：</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046464083964.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">添加用户</span></p>
<p>日志：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">2018-05-30 17:29:07.347  INFO 35406 --- [nio-8080-exec-1] com.winterchen.config.DataSourceAspect   : className:com.sun.proxy.$Proxy73, method:insert, args:com.winterchen.model.UserDomain@4b5b52dc<br>2018-05-30 17:29:07.350  INFO 35406 --- [nio-8080-exec-1] com.winterchen.config.DataSourceAspect   : &gt;&gt;insert 方法使用的数据源为:insert&lt;&lt;<br>2018-05-30 17:29:07.351  INFO 35406 --- [nio-8080-exec-1] com.winterchen.config.DataSourceAspect   : &gt;&gt;insert方法使用的数据源为:DatabaseType&#123;name&#x3D;&#39;write&#39;&#125;&lt;&lt;<br>2018-05-30 17:29:07.461  INFO 35406 --- [nio-8080-exec-1] com.winterchen.config.DynamicDataSource  : &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;dataSource &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;DatabaseType&#123;name&#x3D;&#39;write&#39;&#125;<br>2018-05-30 17:29:07.462  INFO 35406 --- [nio-8080-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...<br>2018-05-30 17:29:07.952  INFO 35406 --- [nio-8080-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.<br></code></pre></td></tr></table></figure>

<p>可以看出使用的就是<code>write</code>数据源，并且该数据源是使用<code>HikariPool</code>作为数据库连接池的</p>
<p>查询用户（read）：</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046464129009.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">查询用户</span></p>
<p>日志：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">2018-05-30 17:29:41.616  INFO 35406 --- [nio-8080-exec-2] com.winterchen.config.DataSourceAspect   : className:com.sun.proxy.$Proxy73, method:selectUsers, args:<br>2018-05-30 17:29:41.618  INFO 35406 --- [nio-8080-exec-2] com.winterchen.config.DataSourceAspect   : &gt;&gt;selectUsers 方法使用的数据源为:select&lt;&lt;<br>2018-05-30 17:29:41.618  INFO 35406 --- [nio-8080-exec-2] com.winterchen.config.DataSourceAspect   : &gt;&gt;selectUsers方法使用的数据源为:DatabaseType&#123;name&#x3D;&#39;read&#39;&#125;&lt;&lt;<br>2018-05-30 17:29:41.693  INFO 35406 --- [nio-8080-exec-2] com.winterchen.config.DynamicDataSource  : &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;dataSource &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;DatabaseType&#123;name&#x3D;&#39;read&#39;&#125;<br>2018-05-30 17:29:41.982  INFO 35406 --- [nio-8080-exec-2] com.alibaba.druid.pool.DruidDataSource   : &#123;dataSource-1&#125; inited<br></code></pre></td></tr></table></figure>

<p>可以看出使用的是<code>read</code>数据源。</p>
<p>源码地址：<a href="https://github.com/WinterChenS/springboot-learning-experience/tree/master/spring-boot-mybatis-mutil-database" target="_blank" rel="noopener">戳这里</a></p>
<p>springboot技术交流群：681513531</p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>如何在CentOS 7上安装和配置Nginx</title>
    <url>/2018/05/30/centos7-install-nginx/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046765480328.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>如何在centOS7中安装和配置nginx呢？</p>
<a id="more"></a>
<h2 id="1-安装CentOS-7-EPEL仓库"><a href="#1-安装CentOS-7-EPEL仓库" class="headerlink" title="1.安装CentOS 7 EPEL仓库"></a>1.安装CentOS 7 EPEL仓库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">sudo yum install epel-release<br></code></pre></td></tr></table></figure>

<h2 id="2-安装Nginx"><a href="#2-安装Nginx" class="headerlink" title="2.安装Nginx"></a>2.安装Nginx</h2><p>现在Nginx存储库已经安装在您的服务器上，使用以下<code>yum</code>命令安装Nginx ：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">sudo yum install nginx<br></code></pre></td></tr></table></figure>

<p>在对提示回答yes后，Nginx将在服务器上完成安装。</p>
<h2 id="3-启动Nginx"><a href="#3-启动Nginx" class="headerlink" title="3.启动Nginx"></a>3.启动Nginx</h2><p>Nginx不会自行启动。要运行Nginx，请输入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">sudo systemctl start nginx<br></code></pre></td></tr></table></figure>

<p>如果您正在运行防火墙，请运行以下命令以允许HTTP和HTTPS通信：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">sudo firewall-cmd --permanent --zone&#x3D;public --add-service&#x3D;http <br>sudo firewall-cmd --permanent --zone&#x3D;public --add-service&#x3D;https<br>sudo firewall-cmd --reload<br></code></pre></td></tr></table></figure>

<p>打开浏览器输入ip地址看到nginx的首页就说明你启动成功了</p>
<h2 id="4-设置开机启动"><a href="#4-设置开机启动" class="headerlink" title="4.设置开机启动"></a>4.设置开机启动</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">sudo systemctl enable nginx<br></code></pre></td></tr></table></figure>

<h2 id="5-配置nginx"><a href="#5-配置nginx" class="headerlink" title="5.配置nginx"></a>5.配置nginx</h2><p>使用<code>yum</code>进行安装的nginx的配置文件在<code>/etc/nginx/nginx.conf</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf<br></code></pre></td></tr></table></figure>

<h3 id="nginx-conf"><a href="#nginx-conf" class="headerlink" title="nginx.conf:"></a>nginx.conf:</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># For more information on configuration, see:<br>#   * Official English Documentation: http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;<br>#   * Official Russian Documentation: http:&#x2F;&#x2F;nginx.org&#x2F;ru&#x2F;docs&#x2F;<br><br>user nginx;<br><br>#nginx进程数，建议设置为等于CPU总核心数。<br>worker_processes auto;<br><br>#全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]<br>error_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;<br>pid &#x2F;run&#x2F;nginx.pid;#进程pid文件<br><br># Load dynamic modules. See &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;README.dynamic.<br>include &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;modules&#x2F;*.conf;<br><br>events &#123;<br>    #单个进程最大连接数（最大连接数&#x3D;连接数*进程数）<br>    #根据硬件调整，和前面工作进程配合起来用，尽量大，但是别把cpu跑到100%就行。每个进程允许的最多连接数，理论上每台nginx服务器的最大连接数为。	<br>    worker_connections 1024;<br>&#125;<br><br>#设定http服务器，利用它的反向代理功能提供负载均衡支持<br>http &#123;<br>    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;<br>                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;<br>                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;<br><br>    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;<br><br>		#开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I&#x2F;O处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成off。<br>    #sendfile指令指定 nginx 是否调用sendfile 函数（zero copy 方式）来输出文件，对于普通应用，必须设为on。如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络IO处理速度，降低系统uptime。<br>    sendfile            on;<br>    <br>    #此选项允许或禁止使用socke的TCP_CORK的选项，此选项仅在使用sendfile的时候使用<br>    tcp_nopush          on;<br>    tcp_nodelay         on;<br>    <br>    #长连接超时时间，单位是秒<br>    keepalive_timeout   65;<br>    types_hash_max_size 2048;<br><br>    include             &#x2F;etc&#x2F;nginx&#x2F;mime.types;<br>    default_type        application&#x2F;octet-stream;<br><br>    # Load modular configuration files from the &#x2F;etc&#x2F;nginx&#x2F;conf.d directory.<br>    # See http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;ngx_core_module.html#include<br>    # for more information.<br>    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;<br>	<br>  	#虚拟主机的配置<br>    server &#123;<br>    		#监听端口<br>        listen       80 default_server;<br>        listen       [::]:80 default_server;<br>        <br>        #域名可以有多个，用空格隔开<br>        server_name  luischen.cn;<br>       # root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;<br>       # 重定向至https（按照需求）<br>        rewrite ^(.*)$  https:&#x2F;&#x2F;$host$1 permanent;<br>        # Load configuration files for the default server block.<br>        include &#x2F;etc&#x2F;nginx&#x2F;default.d&#x2F;*.conf;<br><br>        location &#x2F; &#123;<br>        &#125;<br><br>        error_page 404 &#x2F;404.html;<br>            location &#x3D; &#x2F;40x.html &#123;<br>        &#125;<br><br>        error_page 500 502 503 504 &#x2F;50x.html;<br>            location &#x3D; &#x2F;50x.html &#123;<br>        &#125;<br>    &#125;<br><br># Settings for a TLS enabled server.<br><br>    server &#123;<br>    		# 监听433端口<br>        listen       443 ssl http2 default_server;<br>        listen       [::]:443 ssl http2 default_server;<br>        server_name  luischen.cn;<br>        #root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;<br>				# ssl证书<br>        ssl_certificate &quot;&#x2F;etc&#x2F;nginx&#x2F;1_luischen.cn_bundle.crt&quot;;<br>        ssl_certificate_key &quot;&#x2F;etc&#x2F;nginx&#x2F;2_luischen.cn.key&quot;;<br>        ssl_session_cache shared:SSL:1m;<br>        ssl_session_timeout  10m;<br>        ssl_ciphers HIGH:!aNULL:!MD5;<br>        ssl_prefer_server_ciphers on;<br>        <br>        #以下是一些反向代理的配置，可选。<br>        proxy_set_header X-Forwarded-Host $host;<br>        proxy_set_header X-Forwarded-Server $host;<br>        #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP<br>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>        proxy_set_header Host $host;<br>#        # Load configuration files for the default server block.<br>#        include &#x2F;etc&#x2F;nginx&#x2F;default.d&#x2F;*.conf;<br>#					<br>        location &#x2F; &#123;<br>         # 需要代理的端口-也就是nginx指向本地的端口<br>         proxy_pass http:&#x2F;&#x2F;127.0.0.1:8091;<br>         # 超时时间<br>         proxy_connect_timeout 600;<br>         proxy_read_timeout 600;<br>        &#125;<br>        <br>        error_page 404 &#x2F;404.html;<br>            location &#x3D; &#x2F;40x.html &#123;<br>        &#125;<br><br>        error_page 500 502 503 504 &#x2F;50x.html;<br>            location &#x3D; &#x2F;50x.html &#123;<br>        &#125;<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure>


<h2 id="6-nginx启动和停止命令"><a href="#6-nginx启动和停止命令" class="headerlink" title="6.nginx启动和停止命令"></a>6.nginx启动和停止命令</h2><p>启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">sudo systemctl start nginx<br></code></pre></td></tr></table></figure>

<p>停止</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">sudo systemctl stop nginx<br></code></pre></td></tr></table></figure>















]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>nginx</tag>
        <tag>centos7</tag>
      </tags>
  </entry>
  <entry>
    <title>当springMVC上下文尚未初始化的时候如何@Autowired注入对象呢？</title>
    <url>/2018/05/30/spring-autowired/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046776701619.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>一个问题困扰了我一天，场景是这样的：</p>
<ul>
<li>公司有一个独立的SSO用户权限验证中心，我负责的是公司的一个其他的独立项目；</li>
<li>每次用户session过期或者未登录的时候跳统一登录页面；</li>
<li>用户成功登录之后都会回调，回调的信息中有用户的userAccount；</li>
<li>此时需要根据用户的userAccount获取用户的详细信息；</li>
<li>权限系统提供了一个获取用户的接口；<a id="more"></a>

</li>
</ul>
<p>遇到的问题：</p>
<ul>
<li>使用的是shrio进行系统权限的控制，当用户在SSO登录页面成功登录之后会回调到shrio的配置类中；</li>
<li>需要在shrio的配置类中调用根据用户账号获取用户信息的接口：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IecWepmShiroAuthService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractShiroAuthService</span>&lt;<span class="hljs-title">SessionUser</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">EnvironmentAware</span> </span>&#123;<br><br>	<span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TenantUserCloudService tenantUserCloudService;<br>&#125;<br>```	<br><br>调用的就是这么一个接口<br><br>```java<br><span class="hljs-meta">@CloudServiceClient</span>(<span class="hljs-string">"gap-service-tenant-auth"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TenantUserCloudService</span> </span>&#123;<br><br>	<span class="hljs-meta">@RequestMapping</span>(<br>        value = &#123;<span class="hljs-string">"/tenant/user/by-emp-no"</span>&#125;,<br>        method = &#123;RequestMethod.GET&#125;<br>    )<br>    <span class="hljs-function">APIResponse&lt;TenantUser&gt; <span class="hljs-title">getTenantUserByEmpNo</span><span class="hljs-params">(@RequestParam(name = <span class="hljs-string">"tenantId"</span>,required = <span class="hljs-keyword">true</span>)</span> Integer var1, @<span class="hljs-title">RequestParam</span><span class="hljs-params">(name = <span class="hljs-string">"empNo"</span>,required = <span class="hljs-keyword">true</span>)</span> String var2)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果按照下面的代码进行注入，那么由于shrio的初始化要先与springMVC，所以导致找不到相关处理的类；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TenantUserCloudService tenantUserCloudService;<br></code></pre></td></tr></table></figure>

<p>解决的思路就是：</p>
<ul>
<li>首先不进行<code>tenantUserCloudService</code>的初始化，只有在调用该接口的时候进行初始化；</li>
<li>创建一个类实现<code>ApplicationContextAware</code>接口，实现这个接口可以很方便的从spring容器中获取bean；</li>
<li>机制就是<strong>当调用这个接口的时候才从spring容器中获取这个bean</strong>；</li>
</ul>
<p>创建一个类实现<code>ApplicationContextAware</code>接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//相当于给一个bean进行代理</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DelegateBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationContextAware</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.getLogger(DelegateBean<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>    <span class="hljs-keyword">protected</span> ApplicationContext applicationContext;<br>    <span class="hljs-keyword">protected</span> Object target;<br>    <span class="hljs-keyword">protected</span> String targetBeanName;<br>    <span class="hljs-keyword">protected</span> Class targetBeanType;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DelegateBean</span><span class="hljs-params">(String targetBeanName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.targetBeanName = targetBeanName;<br>    &#125;<br>	<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DelegateBean</span><span class="hljs-params">(Class targetBeanType)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.targetBeanType = targetBeanType;<br>    &#125;<br>	<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DelegateBean</span><span class="hljs-params">(ApplicationContext applicationContext, String targetBeanName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.applicationContext = applicationContext;<br>        <span class="hljs-keyword">this</span>.targetBeanName = targetBeanName;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DelegateBean</span><span class="hljs-params">(ApplicationContext applicationContext, Class targetBeanType)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.applicationContext = applicationContext;<br>        <span class="hljs-keyword">this</span>.targetBeanType = targetBeanType;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>        <span class="hljs-keyword">this</span>.applicationContext = applicationContext;<br>    &#125;<br>	<span class="hljs-comment">//当调用这个方法的时候才从spring容器中获取bean；</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">target</span><span class="hljs-params">()</span> </span>&#123;<br>        Assert.notNull(<span class="hljs-keyword">this</span>.applicationContext, <span class="hljs-string">"A DelegateBean should be managed by ApplicationContext or pass ApplicationContext though constructor arg"</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.target == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span>(<span class="hljs-keyword">this</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.target != <span class="hljs-keyword">null</span>?<span class="hljs-keyword">this</span>.target:(<span class="hljs-keyword">this</span>.target = <span class="hljs-keyword">this</span>.doGetBeanFromApplicationContext());<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.target;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">doGetBeanFromApplicationContext</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.targetBeanName != <span class="hljs-keyword">null</span>?<span class="hljs-keyword">this</span>.applicationContext.getBean(<span class="hljs-keyword">this</span>.targetBeanName):(<span class="hljs-keyword">this</span>.targetBeanType != <span class="hljs-keyword">null</span>?<span class="hljs-keyword">this</span>.applicationContext.getBean(<span class="hljs-keyword">this</span>.targetBeanType):<span class="hljs-keyword">null</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>只是这样配置还是不够的，我们需要在spring初始化的时候将这个代理bean交给spring容器进行管理；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IecWepmAutoConfiguration</span></span>&#123;<br><br>	<span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"tenantUserCloudService"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DelegateBean <span class="hljs-title">tenantUserCloudService</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DelegateBean(TenantUserCloudService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后再shrio的类中我们需要进行这样的使用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IecWepmShiroAuthService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractShiroAuthService</span>&lt;<span class="hljs-title">SessionUser</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">EnvironmentAware</span> </span>&#123;<br>	<span class="hljs-meta">@Autowired</span><br>    <span class="hljs-meta">@Qualifier</span>(<span class="hljs-string">"tenantUserCloudService"</span>)<br>    <span class="hljs-keyword">private</span> DelegateBean tenantUserCloudService;<br>	<br>	<span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> SessionUser <span class="hljs-title">doLogin</span><span class="hljs-params">(String userAccount, String userPwd)</span> </span>&#123;<br>        <br>        <span class="hljs-comment">//根据用户编号获取用户信息,调用target()是关键，只有在调用这个方法的时候才会从spring容器中获取信息</span><br>        APIResponse&lt;TenantUser&gt; tenantUserByEmpNo = ((TenantUserCloudService) tenantUserCloudService.target())<br>                .getTenantUserByEmpNo(TENANT_ID, userAccount);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">"success"</span>.equals(tenantUserByEmpNo.getCode()) &amp;&amp; <span class="hljs-keyword">null</span> != tenantUserByEmpNo.getData())&#123;<br>            userAccount = tenantUserByEmpNo.getData().getDomainAccountList().get(<span class="hljs-number">0</span>).getDomainAccount();<br>        &#125;<br>        UserInfoDto userInfo = userService.getUserByAccount(userAccount);<br>        SessionUser sessionUser = <span class="hljs-keyword">new</span> SessionUser();<br>        sessionUser.setUserId(Integer.valueOf(userAccount));<br>        AuthUtils.setSessionUser(sessionUser);<br>        <span class="hljs-comment">// todo 返回的SessionUser 就是保存在session里的对象 通过 SessionUser sessionUser = (SessionUser) AuthUtils.getSessionUser(); 进行获取</span><br>        <span class="hljs-keyword">return</span> sessionUser;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<p>关键： <strong>以上的思路最主要的就是，在shrio初始化的时候仅仅只是初始化一个空壳，只有当使用那个bean的时候才从spring容器中获取bean并且注入，这样的好处就是当当前bean的声明周期还未开始的时候预留一个位置，当使用的时候才从spring容器中注入，这样不会导致项目启动的时候就会找不到bean</strong>；</p>
]]></content>
      <categories>
        <category>spring</category>
      </categories>
      <tags>
        <tag>spring</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot 中 @ConditionalOnExpression注解 在特定情况下使用相关配置或者实例化bean</title>
    <url>/2018/05/30/spring-boot-conditional-on-expression/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046777524470.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>在开发中会遇到一些需求：在配置文件中设置一个enable，当这个配置为true的时候，才进行相关的配置类的初始化。</p>
<a id="more"></a>


<p>示例：</p>
<p>需要实例化的bean，请不要加@Component注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestBean</span> </span>&#123;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TestBean</span><span class="hljs-params">()</span></span>&#123;<br>    <br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">doSomeThing</span><span class="hljs-params">()</span></span>&#123;<br>    <br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>配置类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnExpression</span>(<span class="hljs-string">"$&#123;test.enabled:true&#125;"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestConfiguration</span> </span>&#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> TestBean <span class="hljs-title">testBean</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TestBean();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">test.enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>这个bean只有在<code>test.enabled: true</code>的时候才会进行初始化。</p>
]]></content>
      <categories>
        <category>spring</category>
      </categories>
      <tags>
        <tag>spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Java源码之旅(1) - ArrayList</title>
    <url>/2018/05/26/java-source-code-arraylist/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046773582634.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<blockquote>
<p> 技术在学习中成长，源码的世界没有你想象的那么复杂</p>
</blockquote>
<a id="more"></a>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>2018年的五月，开始java的源码学习之旅，从简单的角度去理解java的源码，前几天在学习交流中正好看了一下java集合的源码，才发现源码并没有想象中的那么难以理解，所以，源码之旅从java的集合类开始咯。</p>
<p>本章的源码版本为：<code>JDK1.8</code></p>
<h2 id="类的关系"><a href="#类的关系" class="headerlink" title="类的关系"></a>类的关系</h2><p>要理解<code>ArrayList</code>的源码，我们就需要从它的关系开始，<code>ArrayList</code>继承了<code>AbstractList</code>，实现了<code>List</code>接口，我们从UML图可以看出：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046462618337.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>虚线箭头表示实现接口，实线箭头表示继承关系</p>
<h2 id="ArrayList简介"><a href="#ArrayList简介" class="headerlink" title="ArrayList简介"></a>ArrayList简介</h2><p><code>ArrayList</code>是<code>java</code>中最常用的集合类了，说到<code>ArrayList</code>，我们不得不说说<code>LinkedList</code>，因为他们都是从<code>Collection</code>派生而来的，都是用来存放对象的序列的集合类，<code>ArrayList</code>相比与<code>LinkedList</code>有什么优劣呢？</p>
<ul>
<li><p><code>ArrayList</code>:</p>
<ul>
<li><p>优点：<strong>随机访问元素的速度快</strong></p>
</li>
<li><p>缺点：<strong>从中间插入和移除元素比较慢</strong></p>
</li>
</ul>
</li>
<li><p><code>LinkedList</code>：</p>
<ul>
<li><p>优点：<strong>从中间插入和移除元素速度快</strong></p>
</li>
<li><p>缺点：<strong>随机访问元素的速度比较慢</strong></p>
</li>
</ul>
</li>
</ul>
<p>接下来我们就从源码的角度去理解一下为什么有这些优缺点。</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="ArrayList的初始化"><a href="#ArrayList的初始化" class="headerlink" title="ArrayList的初始化"></a>ArrayList的初始化</h3><p><code>ArrayList</code>有三个构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//默认初始容量</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> DEFAULT_CAPACITY = <span class="hljs-number">10</span>;<br><span class="hljs-comment">//空的元素数组</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object[] EMPTY_ELEMENTDATA = &#123;&#125;;<br><span class="hljs-comment">//初始容量空的元素数组</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;<br><span class="hljs-comment">// 存放元素的数组</span><br><span class="hljs-keyword">transient</span> Object[] elementData; <span class="hljs-comment">// non-private to simplify nested class access</span><br><span class="hljs-comment">//数组的大小</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> size;<br><br><span class="hljs-comment">// 空参的构造方法</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ArrayList</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA; <span class="hljs-comment">// -- (1)</span><br>    &#125;<br><br><span class="hljs-comment">//指定初始容量的构造方法</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ArrayList</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (initialCapacity &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">this</span>.elementData = <span class="hljs-keyword">new</span> Object[initialCapacity]; <span class="hljs-comment">// -- (2)</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (initialCapacity == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">this</span>.elementData = EMPTY_ELEMENTDATA; <span class="hljs-comment">// -- (3)</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Illegal Capacity: "</span>+<br>                                               initialCapacity);<br>        &#125;<br>    &#125;<br><br><span class="hljs-comment">//初始化给定一个集合的构造函数</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ArrayList</span><span class="hljs-params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;<br>        elementData = c.toArray();    <span class="hljs-comment">// -- (4)</span><br>        <span class="hljs-keyword">if</span> ((size = elementData.length) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// c.toArray might (incorrectly) not return Object[] (see 6260652)</span><br>            <span class="hljs-keyword">if</span> (elementData.getClass() != Object[]<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><br><span class="hljs-class">                <span class="hljs-title">elementData</span> </span>= Arrays.copyOf(elementData, size, Object[]<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;  <span class="hljs-comment">// -- (5)</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// replace with empty array.</span><br>            <span class="hljs-keyword">this</span>.elementData = EMPTY_ELEMENTDATA;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>从源码中我们可以看出，<code>ArrayList</code>其实底层使用的是<code>数组</code>，<code>transient Object[] elementData</code> 这个变量就是用来存放对象的一个数组。</p>
<ul>
<li><p><code>ArrayList</code>的空参构造函数：也就是默认的构造函数，当<code>new ArrayList()</code>的时候调用这个方法，可以看出将<code>elementData</code>变量地址指向了<code>DEFAULTCAPACITY_EMPTY_ELEMENTDATA</code>这个<strong>初始容量为10，并且为空的元素数组</strong>;如步骤<code>(1)</code></p>
</li>
<li><p><code>ArrayList</code>的指定大小的构造函数：当初始化一个指定大小的<code>new ArrayList(int)</code>的时候调用该方法，这个方法首先对<code>initialCapacity</code>参数进行判断，<strong>如果大于0</strong>，那么创建一个指定大小的数组<code>(2)</code>；<strong>如果等于0</strong>,创建一个空的数组<code>(3)</code>；否则就判处异常；</p>
</li>
<li><p>初始化给定一个集合的构造函数：如果初始化的时候，给定一个集合对象，那么将这个集合转换为数组 <code>(4)</code>，然后对这个数组的长度进行判断，如果数组不等于0，那么调用<code>Arrays.copyOf(elementData, size, Object[].class)</code>方法<code>(5)</code>，这个方法是一个<strong>核心方法</strong>，这个方法就是初始化一个大小为等于当前数组的一个新的数组，然后将对象<code>copy</code>到新的数组中，然后将内存地址指定给<code>elementData</code>，从下面的<code>Arrays.copyOf</code>的源码可以看出来。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T,U&gt; T[] copyOf(U[] original, <span class="hljs-keyword">int</span> newLength, Class&lt;? extends T[]&gt; newType) &#123;<br>        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)<br>        T[] copy = ((Object)newType == (Object)Object[]<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><br>            ? (T[]) new Object[newLength]<br>            : (T[]) Array.newInstance(newType.getComponentType(), newLength);<br>        System.arraycopy(original, <span class="hljs-number">0</span>, copy, <span class="hljs-number">0</span>,<br>                         Math.min(original.length, newLength));<br>        <span class="hljs-keyword">return</span> copy;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>copyOf</code>方法首先判断两个对象的类型，如果类型一致，那么直接创建一个同大小的数组；如果类型不一致，则调用<code>Array.newInstance</code>指定类型进行初始化这个数组，当然，大小也是一致的; 最后调用<code>System.arraycopy</code>将参数数组<code>copy</code>到新的目标并返回。</p>
<h3 id="ArrayList的常用方法之-add"><a href="#ArrayList的常用方法之-add" class="headerlink" title="ArrayList的常用方法之 add"></a>ArrayList的常用方法之 add</h3><p>我们先看一下源码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(E e)</span> </span>&#123;<br>        ensureCapacityInternal(size + <span class="hljs-number">1</span>);  <span class="hljs-comment">// Increments modCount!! -- (1)</span><br>        elementData[size++] = e;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index, E element)</span> </span>&#123;<br>        rangeCheckForAdd(index);<span class="hljs-comment">//-- (2)</span><br><br>        ensureCapacityInternal(size + <span class="hljs-number">1</span>);  <span class="hljs-comment">// Increments modCount!!</span><br>        System.arraycopy(elementData, index, elementData, index + <span class="hljs-number">1</span>,<br>                         size - index); <span class="hljs-comment">//-- (3)</span><br>        elementData[index] = element;<br>        size++;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ArrayList有两个add方法，第一个方法就是按顺序将对象插入到尾部，第二个方法就是从中间插入对象。</p>
<p><code>add(E e)</code> 方法首先会判断数组的容量是否超过极限<code>ensureCapacityInternal(size + 1)</code>，这个方法首先会进行容量的判断，如果超过了极限，创建一个新的数组，大小是旧数组1.5倍，然后将旧数组中的对象全部拷贝到新的数组<code>(1)</code>，等下会详细解析这个方法。最后将参数对象插入到数组中，返回true。</p>
<p><code>add(int index, E element)</code>首先会调用<code>rangeCheckForAdd(index)</code>进行index的是否越界的验证<code>(2)</code>，然后调用上一个方法中一样的判断容量是否超过极限的方法，下一步就是一个核心的方法<code>System.arraycopy</code>，这个方法我们在<code>ArrayList初始化中</code>已经讲过了，但是这里不太一样：</p>
<ul>
<li><p><code>elementData</code> : 源数组</p>
</li>
<li><p><code>index</code>：源数组起始位置</p>
</li>
<li><p><code>elementData</code>：目标数组</p>
</li>
<li><p><code>index + 1</code>：目标数组起始位置</p>
</li>
<li><p><code>size - index</code>：复制数组元素数目</p>
</li>
</ul>
<p>从源码中可以看出，当我们往一个ArrayList中间插入一个对象的时候，index索引处后面的索引往后移动一位，最后把索引为index空出来，并将element赋值给它。这样一来我们并不知道要插入哪个位置，所以会进行匹配那么它的时间赋值度就为n。</p>
<p>接下来看一下<code>ensureCapacityInternal(size + 1)</code>这个方法的调用链：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ensureCapacityInternal</span><span class="hljs-params">(<span class="hljs-keyword">int</span> minCapacity)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;<br>    minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);<br>  &#125;<br><br>  ensureExplicitCapacity(minCapacity);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ensureExplicitCapacity</span><span class="hljs-params">(<span class="hljs-keyword">int</span> minCapacity)</span> </span>&#123;<br>  modCount++;<br><br>  <span class="hljs-comment">// overflow-conscious code</span><br>  <span class="hljs-keyword">if</span> (minCapacity - elementData.length &gt; <span class="hljs-number">0</span>)<br>    grow(minCapacity);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">grow</span><span class="hljs-params">(<span class="hljs-keyword">int</span> minCapacity)</span> </span>&#123;<br>  <span class="hljs-comment">// overflow-conscious code</span><br>  <span class="hljs-keyword">int</span> oldCapacity = elementData.length;<br>  <span class="hljs-keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="hljs-number">1</span>);<span class="hljs-comment">//oldCapacity &gt;&gt; 1 就是除以2</span><br>  <span class="hljs-keyword">if</span> (newCapacity - minCapacity &lt; <span class="hljs-number">0</span>)<br>    newCapacity = minCapacity;<br>  <span class="hljs-keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="hljs-number">0</span>)<br>    newCapacity = hugeCapacity(minCapacity);<br>  <span class="hljs-comment">// minCapacity is usually close to size, so this is a win:</span><br>  elementData = Arrays.copyOf(elementData, newCapacity);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>ensureCapacityInternal(int minCapacity)</code>方法中判断当前数组中的元素是否为空，如果为空则给定一个最大的值，然后调用<code>ensureExplicitCapacity(minCapacity)</code>，这个方法主要是判数组容量是否超过极限，如果超过极限调用<code>grow(int minCapacity)</code>，这个方法就是扩容方法，该方法会创建一个比原数组大1.5倍的新数组，然后将原数组中的所有对象<code>copy</code>到新的数组中。</p>
<h3 id="ArrayList的常用方法之-remove"><a href="#ArrayList的常用方法之-remove" class="headerlink" title="ArrayList的常用方法之 remove"></a>ArrayList的常用方法之 remove</h3><p><code>remove</code>方法其实跟从中间插入对象的<code>add</code>方法有很大的相似之处，如果我们删除某一个元素，将<code>index</code>开始后面的所有对象都往前移动一位，底层方法其实是复制一遍，所以删除一个对象的复杂度和从中间插入一个对象是差不多的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">remove</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index)</span> </span>&#123;<br>        rangeCheck(index);<br><br>        modCount++;<br>        E oldValue = elementData(index);<br><br>        <span class="hljs-keyword">int</span> numMoved = size - index - <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (numMoved &gt; <span class="hljs-number">0</span>)<br>            System.arraycopy(elementData, index+<span class="hljs-number">1</span>, elementData, index,<br>                             numMoved);<br>        elementData[--size] = <span class="hljs-keyword">null</span>; <span class="hljs-comment">// clear to let GC do its work</span><br><br>        <span class="hljs-keyword">return</span> oldValue;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h3 id="ArrayList的常用方法之-get"><a href="#ArrayList的常用方法之-get" class="headerlink" title="ArrayList的常用方法之 get"></a>ArrayList的常用方法之 get</h3><p><code>ArrayList</code>的<code>get</code>方法非常直观的就能理解了，废话不多说，直接看代码:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index)</span> </span>&#123;<br>  rangeCheck(index);<br><br>  <span class="hljs-keyword">return</span> elementData(index);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>检查index合法性，然后从数组中取出对象并返回，是不是很简单呢？</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本章列举了一些ArrayList常用的方法，了解到ArrayList底层其实是一个对象数组，以及从中间插入对象和移除对象比较慢的原因，从这些方法出发，理解ArrayList其他的方法会很简单了。下一章讲一讲LinkedList的源码。</p>
]]></content>
      <categories>
        <category>java源码</category>
      </categories>
      <tags>
        <tag>java源码</tag>
      </tags>
  </entry>
  <entry>
    <title>spring中添加自定义的拦截器</title>
    <url>/2018/05/09/my-spring-interceptor/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://images.unsplash.com/photo-1522199794616-8a62b541f762?ixlib=rb-0.3.5&ixid=eyJhcHBfaWQiOjEyMDd9&s=71b5877630deb9ab5996f91cc61b43f7&auto=format&fit=crop&w=2104&q=80" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>要想实现自定义的拦截器，我们不得不讲讲spring中的处理程序拦截器，那么什么是处理程序拦截器呢？</p>
<a id="more"></a>

<h2 id="什么是spring中的处理程序拦截器？"><a href="#什么是spring中的处理程序拦截器？" class="headerlink" title="什么是spring中的处理程序拦截器？"></a>什么是spring中的处理程序拦截器？</h2><p>要想了解拦截器在spring中的作用，我们首先要了解一下HTTP的请求执行链。</p>
<ol>
<li><p>DispatcherServlet捕获每一个请求；</p>
</li>
<li><p>DispatcherServlet将接收到的URL和相应的Controller进行映射；</p>
</li>
<li><p>在请求到达相应的Controller之前<strong>拦截器</strong>会进行请求处理；</p>
</li>
<li><p>处理完成之后进行视图的解析；</p>
</li>
<li><p>返回视图。</p>
</li>
</ol>
<p>在第3步中，也就是今天最重要的内容，在请求到达Controller之前，请求可以被拦截器处理，这些拦截器就像过滤器。只有当URL找到对应于它们的处理器时才会调用它们。在通过拦截器(拦截器预处理，其实也可以说前置处理)进行前置处理后，请求最终到达controller。之后，发送请求生成视图。但是在这之前，拦截器还是有可能来再次处理它(拦截器后置处理)。只有在最后一次操作之后，视图解析器才能捕获数据并输出视图。</p>
<p>处理程序映射拦截器基于<code>org.springframework.web.servlet.HandlerInterceptor</code>接口。这个接口有三个方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HandlerInterceptor</span> </span>&#123;<br><br>  <span class="hljs-comment">//请求发送到Controller之前调用</span><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//请求发送到Controller之后调用</span><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span><br><span class="hljs-function"><span class="hljs-params">            @Nullable ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    &#125;<br><br>    <span class="hljs-comment">//完成请求的处理的回调方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span><br><span class="hljs-function"><span class="hljs-params">            @Nullable Exception ex)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="编写自定义的拦截器"><a href="#编写自定义的拦截器" class="headerlink" title="编写自定义的拦截器"></a>编写自定义的拦截器</h2><p>要想编写自定义的拦截器，需要有两个步骤：</p>
<ul>
<li><p>实现<code>HandlerInterceptor</code>接口和方法；</p>
</li>
<li><p>将自定义拦截器添加到MVC中。</p>
</li>
</ul>
<p>下面我们来实现一下代码：</p>
<h3 id="首先我们创建一个类BaseInterceptor"><a href="#首先我们创建一个类BaseInterceptor" class="headerlink" title="首先我们创建一个类BaseInterceptor"></a>首先我们创建一个类<code>BaseInterceptor</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 实现HandlerInterceptor接口，自定义拦截器</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandlerInterceptor</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGE = LoggerFactory.getLogger(BaseInterceptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>      <span class="hljs-comment">//实现前置方法</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object o)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String uri = request.getRequestURI();<br><br>        LOGGE.info(<span class="hljs-string">"UserAgent: &#123;&#125;"</span>, request.getHeader(USER_AGENT));<br>        LOGGE.info(<span class="hljs-string">"用户访问地址: &#123;&#125;, 来路地址: &#123;&#125;"</span>, uri, IPKit.getIpAddrByRequest(request));<br><br><br>      <span class="hljs-comment">//拦截器处理用户权限</span><br>        <span class="hljs-keyword">if</span> (uri.startsWith(<span class="hljs-string">"/admin"</span>) &amp;&amp; !uri.startsWith(<span class="hljs-string">"/admin/login"</span>)) &#123;<br>            response.sendRedirect(request.getContextPath() + <span class="hljs-string">"/admin/login"</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postHandle</span><span class="hljs-params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//这个方法可以往request中添加一些公共的工具类给前端页面进行调用</span><br><br>    &#125;<br><br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCompletion</span><span class="hljs-params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//当请求处理完成调用</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上的自定义拦截器实现类中，我们实现了<code>HandlerInterceptor</code>接口，并且实现了三个方法：<code>preHandle</code>、<code>postHandle</code>、<code>afterCompletion</code>。</p>
<p>在实际的应用中呢，我们常常可以在请求处理的前置方法<code>preHandle</code>中进行权限的验证，<code>postHandle</code>后置方法在实际的使用当中可以往request中添加一些公共的工具类给前端页面进行调用。</p>
<h3 id="创建一个类WebMvcConfig实现WebMvcConfigurer接口"><a href="#创建一个类WebMvcConfig实现WebMvcConfigurer接口" class="headerlink" title="创建一个类WebMvcConfig实现WebMvcConfigurer接口"></a>创建一个类<code>WebMvcConfig</code>实现<code>WebMvcConfigurer</code>接口</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 向MVC中添加自定义组件</span><br><span class="hljs-comment"> * Created by Donghua.Chen on 2018/4/30.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">WebMvcConfigurer</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> BaseInterceptor baseInterceptor;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> </span>&#123;<br>        registry.addInterceptor(baseInterceptor);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个类的主要作用就是将我们刚才自定义的拦截器组件添加到MVC中去。</p>
<p>以上我们就完成了自定义拦截器的全部过程，是不是很简单呢？</p>
]]></content>
      <categories>
        <category>spring</category>
      </categories>
      <tags>
        <tag>spring</tag>
      </tags>
  </entry>
  <entry>
    <title>关于《三体》的一些读后感-农场主和射手</title>
    <url>/2018/04/23/about-tree-body-1/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046765113656.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>地铁上发现一件非常巧合的事情，正好读到《三体》中的一个情节，汪淼去杨冬的丈夫丁仪家，两个正在打台球验证科学理论，地铁的显示屏上同时也播放着打台球的画面。</p>
<a id="more"></a>
<p>这一章正好读到农场主和射手，两个故事都讲的令人细思极恐，农场主讲述的是，一个农场主每天准时十二点都会给火鸡喂食，假设火鸡中有一位火鸡科学家，它就发现了一个理论，<br>每天十二点上帝都会准时发放食物，于是它们每天十二点都会准时等待食物，到了复活节这一天，食物并没有如期而至，农场主把它们都杀了。<br>第二个故事射手讲的是一个射手在一个平面上每隔10厘米就会打个洞，假如平面上生活着一个二维智能生物，那么它得出了一个理论，宇宙每隔十厘米就会出现一个洞。<br>这两个故事告诉，我们我们以为的规律/理论，可能并不存在，所以，物理科学并不存在，确实挺可怕的。</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046765183636.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p> 杨东生前进行过多次的离子对撞的实验，发现每次的结果都不一样，台球就好比放大版的离子对撞实验，谁也不知道台球会不会在对撞的之后飞向宇宙。<br>杨东发现了这个事实，其实物理是不存在的，从微观世界看，这个现实世界非常的混乱，物理学就像农场主和射手的故事一样，所以杨东选择了自杀。</p>
<p> 然而，真相却是三体人发射了两个智子到地球，智子能够锁住地球的科技，经过二维展开改造后的智能微观粒子，可以进行通讯、侦查、干扰粒子高能加速器等任务，所以，杨东的粒子加速碰撞试验是智子搞的鬼，物理并不存在的学说是不对的。</p>
]]></content>
      <categories>
        <category>随笔</category>
      </categories>
      <tags>
        <tag>随笔</tag>
        <tag>三体</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot2.0 Mybatis 整合 (springboot2.0版本)</title>
    <url>/2018/04/21/springboot2-mybatis/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046782791380.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<blockquote>
<p>springboot终于迎来了2.0版本，很多新的特性让springboot更加强大，之前<a href="https://blog.csdn.net/winter_chen001/article/details/77249029" target="_blank" rel="noopener">使用1.5.6版本整合了Mybatis</a>，现在2.0版本就已经不适用了，所以，在摸索中搭建了2.0版本整合Mybatis</p>
</blockquote>
<a id="more"></a>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>本来这篇博文老在就写好了，但是后来发现很多功能其实根本就没有检验通过就发出来了，导致遗留了很多坑，比如最难搞的就是SqlSessionFactory和PageHelper，之前写过关于springboot1.5.6版本的整合，这段时间刚好springboot发布了2.0的正式版本，很多同学可能没有注意版本，导致了整合的时候出现了很多很多的问题，这几天刚好有空就试着整合一下springboot2.0 mybatis，发现了很多很多的坑，而且网上的资源也不多，终于在两天的踩坑中成功整合了，并且将翻页功能修复好了，废话不多说了，看代码：</p>
<h2 id="环境-版本一览："><a href="#环境-版本一览：" class="headerlink" title="环境/版本一览："></a>环境/版本一览：</h2><ul>
<li>开发工具：Intellij IDEA 2017.1.3</li>
<li>springboot: <strong>2.0.1.RELEASE</strong></li>
<li>jdk：1.8.0_40</li>
<li>maven:3.3.9</li>
<li>alibaba Druid 数据库连接池：1.1.0</li>
</ul>
<h3 id="额外功能："><a href="#额外功能：" class="headerlink" title="额外功能："></a>额外功能：</h3><ul>
<li>PageHelper 分页插件</li>
<li>mybatis generator 自动生成代码插件（本次搭建就不讲解了，请参照<a href="https://blog.csdn.net/winter_chen001/article/details/77249029" target="_blank" rel="noopener">Spring boot Mybatis 整合（完整版）</a>）</li>
</ul>
<h2 id="开始搭建："><a href="#开始搭建：" class="headerlink" title="开始搭建："></a>开始搭建：</h2><h3 id="创建项目："><a href="#创建项目：" class="headerlink" title="创建项目："></a>创建项目：</h3><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046466648928.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046466698922.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>添加基础的依赖：<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046466739962.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="依赖文件："><a href="#依赖文件：" class="headerlink" title="依赖文件："></a>依赖文件：</h3><p>按照pom文件补齐需要的依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">	<span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.winterchen<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springboot2-mybatis-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>springboot2-mybatis-demo<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.1.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-datatype-joda<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.module<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-module-parameter-names<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- 分页插件 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.pagehelper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pagehelper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- alibaba的druid数据库连接池 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="项目结构："><a href="#项目结构：" class="headerlink" title="项目结构："></a>项目结构：</h3><p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046466825127.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">项目结构</span></p>
<h4 id="项目启动类："><a href="#项目启动类：" class="headerlink" title="项目启动类："></a>项目启动类：</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Springboot2MybatisDemoApplication</span> </span>&#123;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		SpringApplication.run(Springboot2MybatisDemoApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="配置："><a href="#配置：" class="headerlink" title="配置："></a>配置：</h3><blockquote>
<p>可以根据个人使用习惯选择使用<code>properties</code>或者<code>yml</code>文件，本项目使用的是yml配置文件，所以把原本<code>application.properties</code>删除，创建一个<code>application.yml</code>文件</p>
</blockquote>
<p>在resource文件夹下创建<code>application.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><br><br><span class="hljs-attr">spring:</span><br>    <span class="hljs-attr">datasource:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">test</span><br>        <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/mytest?useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>        <span class="hljs-comment"># 使用druid数据源</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>        <span class="hljs-attr">filters:</span> <span class="hljs-string">stat</span><br>        <span class="hljs-attr">maxActive:</span> <span class="hljs-number">20</span><br>        <span class="hljs-attr">initialSize:</span> <span class="hljs-number">1</span><br>        <span class="hljs-attr">maxWait:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-attr">minIdle:</span> <span class="hljs-number">1</span><br>        <span class="hljs-attr">timeBetweenEvictionRunsMillis:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-attr">minEvictableIdleTimeMillis:</span> <span class="hljs-number">300000</span><br>        <span class="hljs-attr">validationQuery:</span> <span class="hljs-string">select</span> <span class="hljs-string">'x'</span><br>        <span class="hljs-attr">testWhileIdle:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">testOnBorrow:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">testOnReturn:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">poolPreparedStatements:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">maxPoolPreparedStatementPerConnectionSize:</span> <span class="hljs-number">20</span><br>        <span class="hljs-attr">maxOpenPreparedStatements:</span> <span class="hljs-number">20</span><br>        <br><span class="hljs-attr">mybatis:</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.winterchen.model</span><br><br><span class="hljs-attr">mapper:</span><br>  <span class="hljs-attr">mappers:</span>  <span class="hljs-string">com.winterchen.dao</span><br>  <span class="hljs-attr">not-empty:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">identity:</span> <span class="hljs-string">MYSQL</span><br><br><span class="hljs-comment">#pagehelper</span><br><span class="hljs-attr">pagehelper:</span><br>    <span class="hljs-attr">helperDialect:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">reasonable:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">supportMethodsArguments:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">params:</span> <span class="hljs-string">count=countSql</span><br>    <span class="hljs-attr">returnPageInfo:</span> <span class="hljs-string">check</span><br></code></pre></td></tr></table></figure>

<h3 id="创建包："><a href="#创建包：" class="headerlink" title="创建包："></a>创建包：</h3><p><code>model</code>，<code>dao</code>，<code>mapper</code>,<code>config</code></p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046466881978.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="新建配置类："><a href="#新建配置类：" class="headerlink" title="新建配置类："></a>新建配置类：</h3><p><code>PageHelperConfig.java</code></p>
<blockquote>
<p>以下配置非常的重要，<code>PageHelper</code>的Page拦截器<code>PageInterceptor</code>，如果不进行配置，那么分页功能将没有效果</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.config;<br><br><span class="hljs-keyword">import</span> com.github.pagehelper.PageInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 分页插件的配置</span><br><span class="hljs-comment"> * Created by Donghua.Chen on 2018/4/20.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PageHelperConfig</span> </span>&#123;<br><br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;pagehelper.helperDialect&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String helperDialect;<br>    <br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> PageInterceptor <span class="hljs-title">pageInterceptor</span><span class="hljs-params">()</span></span>&#123;<br>        PageInterceptor pageInterceptor = <span class="hljs-keyword">new</span> PageInterceptor();<br>        Properties properties = <span class="hljs-keyword">new</span> Properties();<br>        properties.setProperty(<span class="hljs-string">"helperDialect"</span>, helperDialect);<br>        pageInterceptor.setProperties(properties);<br>        <span class="hljs-keyword">return</span> pageInterceptor;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<p><code>DataSourceConfig.java</code></p>
<blockquote>
<p>在springboot2.0版本，如果不定义<code>SqlSessionFactory</code>，那么将会导致错误，因为无法注入<code>SqlSessionFactory</code>，<strong>并且下面注释部分的内容非常的重要，这也是整合当中遇到的很大的坑，如果不将PageInterceptor作为插件设置到SqlSessionFactoryBean中，导致分页失效</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.config;<br><br><span class="hljs-keyword">import</span> com.github.pagehelper.PageHelper;<br><span class="hljs-keyword">import</span> com.github.pagehelper.PageInterceptor;<br><span class="hljs-keyword">import</span> org.apache.ibatis.plugin.Interceptor;<br><span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;<br><span class="hljs-keyword">import</span> org.mybatis.spring.SqlSessionFactoryBean;<br><span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.core.env.Environment;<br><span class="hljs-keyword">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;<br><br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 2018/4/19 18:46</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@MapperScan</span>(<span class="hljs-string">"com.winterchen.dao"</span>)<br><span class="hljs-meta">@EnableTransactionManagement</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceConfig</span> </span>&#123;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Logger logger = LoggerFactory.getLogger(DataSourceConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Environment env;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> PageInterceptor pageInterceptor;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title">sqlSessionFactory</span><span class="hljs-params">(DataSource dataSource)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        SqlSessionFactoryBean fb = <span class="hljs-keyword">new</span> SqlSessionFactoryBean();<br>        fb.setDataSource(dataSource);<br>        <span class="hljs-comment">//该配置非常的重要，如果不将PageInterceptor设置到SqlSessionFactoryBean中，导致分页失效</span><br>        fb.setPlugins(<span class="hljs-keyword">new</span> Interceptor[]&#123;pageInterceptor&#125;);<br>        fb.setTypeAliasesPackage(env.getProperty(<span class="hljs-string">"mybatis.type-aliases-package"</span>));<br>        fb.setMapperLocations(<span class="hljs-keyword">new</span> PathMatchingResourcePatternResolver().getResources(env.getProperty(<span class="hljs-string">"mybatis.mapper-locations"</span>)));<br>        <span class="hljs-keyword">return</span> fb.getObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>DruidDBConfig.java</code></p>
<blockquote>
<p>在Spring Boot1.4.0中驱动配置信息没有问题，但是连接池的配置信息不再支持这里的配置项，即无法通过配置项直接支持相应的连接池；这里列出的这些配置项可以通过定制化DataSource来实现。<br>  目前Spring Boot中默认支持的连接池有dbcp,dbcp2, tomcat, hikari三种连接池。 </p>
</blockquote>
<p>由于Druid暂时不在Spring Bootz中的直接支持，故需要进行配置信息的定制：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.config;<br><br><span class="hljs-keyword">import</span> com.alibaba.druid.pool.DruidDataSource;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Primary;<br><br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Donghua.Chen on 2018/4/19.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DruidDBConfig</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Logger logger = LoggerFactory.getLogger(DruidDBConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.url&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String dbUrl;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.username&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String username;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.password&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.driver-class-name&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String driverClassName;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.initialSize&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> initialSize;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.minIdle&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> minIdle;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.maxActive&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> maxActive;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.maxWait&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> maxWait;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.timeBetweenEvictionRunsMillis&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> timeBetweenEvictionRunsMillis;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.minEvictableIdleTimeMillis&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> minEvictableIdleTimeMillis;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.validationQuery&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String validationQuery;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.testWhileIdle&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> testWhileIdle;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.testOnBorrow&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> testOnBorrow;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.testOnReturn&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> testOnReturn;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.poolPreparedStatements&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> poolPreparedStatements;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.maxPoolPreparedStatementPerConnectionSize&#125;"</span>)<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> maxPoolPreparedStatementPerConnectionSize;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.datasource.filters&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String filters;<br><br>    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"&#123;spring.datasource.connectionProperties&#125;"</span>)<br>    <span class="hljs-keyword">private</span> String connectionProperties;<br><br>    <span class="hljs-meta">@Bean</span>     <span class="hljs-comment">//声明其为Bean实例</span><br>    <span class="hljs-meta">@Primary</span>  <span class="hljs-comment">//在同样的DataSource中，首先使用被标注的DataSource</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DataSource <span class="hljs-title">dataSource</span><span class="hljs-params">()</span></span>&#123;<br>        DruidDataSource datasource = <span class="hljs-keyword">new</span> DruidDataSource();<br><br>        datasource.setUrl(<span class="hljs-keyword">this</span>.dbUrl);<br>        datasource.setUsername(username);<br>        datasource.setPassword(password);<br>        datasource.setDriverClassName(driverClassName);<br><br>        <span class="hljs-comment">//configuration</span><br>        datasource.setInitialSize(initialSize);<br>        datasource.setMinIdle(minIdle);<br>        datasource.setMaxActive(maxActive);<br>        datasource.setMaxWait(maxWait);<br>        datasource.setTimeBetweenEvictionRunsMillis(timeBetweenEvictionRunsMillis);<br>        datasource.setMinEvictableIdleTimeMillis(minEvictableIdleTimeMillis);<br>        datasource.setValidationQuery(validationQuery);<br>        datasource.setTestWhileIdle(testWhileIdle);<br>        datasource.setTestOnBorrow(testOnBorrow);<br>        datasource.setTestOnReturn(testOnReturn);<br>        datasource.setPoolPreparedStatements(poolPreparedStatements);<br>        datasource.setMaxPoolPreparedStatementPerConnectionSize(maxPoolPreparedStatementPerConnectionSize);<br>        <span class="hljs-keyword">try</span> &#123;<br>            datasource.setFilters(filters);<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            logger.error(<span class="hljs-string">"druid configuration initialization filter"</span>, e);<br>        &#125;<br>        datasource.setConnectionProperties(connectionProperties);<br><br>        <span class="hljs-keyword">return</span> datasource;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>




<h3 id="创建数据库和数据表"><a href="#创建数据库和数据表" class="headerlink" title="创建数据库和数据表"></a>创建数据库和数据表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> mytest;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_user(<br>  userId <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> PRIMARY <span class="hljs-keyword">KEY</span> AUTO_INCREMENT,<br>  userName <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> ,<br>  <span class="hljs-keyword">password</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> ,<br>  phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span><br>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">INNODB</span> AUTO_INCREMENT=<span class="hljs-number">1000</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8;<br></code></pre></td></tr></table></figure>

<h3 id="创建实体类：UserDomain-java"><a href="#创建实体类：UserDomain-java" class="headerlink" title="创建实体类：UserDomain.java"></a>创建实体类：<code>UserDomain.java</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.model;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDomain</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Integer userId;<br><br>    <span class="hljs-keyword">private</span> String userName;<br><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-keyword">private</span> String phone;<br><br>    <span class="hljs-comment">// get,set方法略...</span><br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="创建dao："><a href="#创建dao：" class="headerlink" title="创建dao："></a>创建dao：</h3><p><code>UserDao.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.dao;<br><br><br><br><span class="hljs-keyword">import</span> com.winterchen.model.UserDomain;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserDao</span> </span>&#123;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(UserDomain record)</span></span>;<br><br><br><br>    <span class="hljs-function">List&lt;UserDomain&gt; <span class="hljs-title">selectUsers</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="创建mybatis映射文件：-UserMapper-xml"><a href="#创建mybatis映射文件：-UserMapper-xml" class="headerlink" title="创建mybatis映射文件： UserMapper.xml"></a>创建mybatis映射文件： <code>UserMapper.xml</code></h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.winterchen.dao.UserDao"</span> &gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BASE_TABLE"</span>&gt;</span><br>    t_user<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BASE_COLUMN"</span>&gt;</span><br>    userId,userName,password,phone<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.winterchen.model.UserDomain"</span>&gt;</span><br>    INSERT INTO<br>      <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"BASE_TABLE"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span>&gt;</span><br>      userName,password,<br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"phone != null"</span>&gt;</span><br>        phone,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"VALUES("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span>&gt;</span><br>      #&#123;userName, jdbcType=VARCHAR&#125;,#&#123;password, jdbcType=VARCHAR&#125;,<br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"phone != null"</span>&gt;</span><br>        #&#123;phone, jdbcType=VARCHAR&#125;,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectUsers"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.winterchen.model.UserDomain"</span>&gt;</span><br>      SELECT<br>        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"BASE_COLUMN"</span>/&gt;</span><br>      FROM<br>        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"BASE_TABLE"</span>/&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="创建剩余的controller，service包和文件"><a href="#创建剩余的controller，service包和文件" class="headerlink" title="创建剩余的controller，service包和文件"></a>创建剩余的<code>controller</code>，<code>service</code>包和文件</h3><p><code>UserService.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.service.user;<br><br><span class="hljs-keyword">import</span> com.winterchen.model.UserDomain;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Administrator on 2018/4/19.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addUser</span><span class="hljs-params">(UserDomain user)</span></span>;<br><br>    <span class="hljs-function">List&lt;UserDomain&gt; <span class="hljs-title">findAllUser</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pageNum, <span class="hljs-keyword">int</span> pageSize)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>UserServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.service.user.impl;<br><br><span class="hljs-keyword">import</span> com.github.pagehelper.PageHelper;<br><span class="hljs-keyword">import</span> com.winterchen.dao.UserDao;<br><span class="hljs-keyword">import</span> com.winterchen.model.UserDomain;<br><span class="hljs-keyword">import</span> com.winterchen.service.user.UserService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Administrator on 2017/8/16.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span>(value = <span class="hljs-string">"userService"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserDao userDao;<span class="hljs-comment">//这里会报错，但是并不会影响</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">addUser</span><span class="hljs-params">(UserDomain user)</span> </span>&#123;<br><br>        <span class="hljs-keyword">return</span> userDao.insert(user);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    * 这个方法中用到了我们开头配置依赖的分页插件pagehelper</span><br><span class="hljs-comment">    * 很简单，只需要在service层传入参数，然后将参数传递给一个插件的一个静态方法即可；</span><br><span class="hljs-comment">    * pageNum 开始页数</span><br><span class="hljs-comment">    * pageSize 每页显示的数据条数</span><br><span class="hljs-comment">    * */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;UserDomain&gt; <span class="hljs-title">findAllUser</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pageNum, <span class="hljs-keyword">int</span> pageSize)</span> </span>&#123;<br>        <span class="hljs-comment">//将参数传给这个方法就可以实现物理分页了，非常简单。</span><br>        PageHelper.startPage(pageNum, pageSize);<br>        <span class="hljs-keyword">return</span> userDao.selectUsers();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>UserController.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.controller;<br><br><span class="hljs-keyword">import</span> com.github.pagehelper.PageHelper;<br><span class="hljs-keyword">import</span> com.winterchen.model.UserDomain;<br><span class="hljs-keyword">import</span> com.winterchen.service.user.UserService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Administrator on 2017/8/16.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/user"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/add"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">addUser</span><span class="hljs-params">(UserDomain user)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> userService.addUser(user);<br>    &#125;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/all"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">findAllUser</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">            @RequestParam(name = <span class="hljs-string">"pageNum"</span>, required = <span class="hljs-keyword">false</span>, defaultValue = <span class="hljs-string">"1"</span>)</span></span><br><span class="hljs-function">                    <span class="hljs-keyword">int</span> pageNum,</span><br><span class="hljs-function">            @<span class="hljs-title">RequestParam</span><span class="hljs-params">(name = <span class="hljs-string">"pageSize"</span>, required = <span class="hljs-keyword">false</span>, defaultValue = <span class="hljs-string">"10"</span>)</span></span><br><span class="hljs-function">                    <span class="hljs-keyword">int</span> pageSize)</span>&#123;<br>        <span class="hljs-comment">//开始分页</span><br>        PageHelper.startPage(pageNum,pageSize);<br>        <span class="hljs-keyword">return</span> userService.findAllUser(pageNum,pageSize);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="项目最终的结构"><a href="#项目最终的结构" class="headerlink" title="项目最终的结构"></a>项目最终的结构</h2><p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046467097250.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">项目结构</span></p>
<blockquote>
<p>到这里如果项目就成功搭建完成了，如果还是报错的话，请仔细看看配置，后面会给出源码地址，程序员就是要不断和bug进行斗争，加油。</p>
</blockquote>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>启动项目</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046467147252.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">启动项目</span></p>
<p>这样就表示启动成功了</p>
<p>然后，开始测试吧，博主使用的是postMan，一个进行http请求的测试工具</p>
<h3 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a>添加数据</h3><p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046467254251.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">添加数据</span></p>
<h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046467296252.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">查询数据</span></p>
<p>源码地址：</p>
<p><a href="https://github.com/WinterChenS/springboot2-mybatis-demo" target="_blank" rel="noopener">https://github.com/WinterChenS/springboot2-mybatis-demo</a></p>
<p>如果遇到问题可以加我wechat：</p>
<img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046784292084.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  width = "200" height = "200"  /><span class="image-caption">wechat</span>

























]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>用FastDFS一步步搭建文件管理系统(CentOS 7)</title>
    <url>/2018/04/10/fastdfs-centos7/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046766291606.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h1 id="一、FastDFS介绍"><a href="#一、FastDFS介绍" class="headerlink" title="一、FastDFS介绍"></a>一、FastDFS介绍</h1><p>开源地址：<a href="https://github.com/happyfish100" target="_blank" rel="noopener">https://github.com/happyfish100</a><br>参考：<a href="http://blog.chinaunix.net/uid-20196318-id-4058561.html" target="_blank" rel="noopener">分布式文件系统FastDFS设计原理</a><br>参考：<a href="http://www.cnblogs.com/Leo_wl/p/6731647.html" target="_blank" rel="noopener">FastDFS分布式文件系统</a></p>
<a id="more"></a>
<h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h2><p>FastDFS 是一个开源的高性能分布式文件系统（DFS）。 它的主要功能包括：文件存储，文件同步和文件访问，以及高容量和负载平衡。主要解决了海量数据存储问题，特别适合以中小文件（建议范围：4KB &lt; file_size &lt;500MB）为载体的在线服务。</p>
<p>FastDFS 系统有三个角色：跟踪服务器(Tracker Server)、存储服务器(Storage Server)和客户端(Client)。</p>
<p>　　<strong>Tracker Server</strong>：跟踪服务器，主要做调度工作，起到均衡的作用；负责管理所有的 storage server和 group，每个 storage 在启动后会连接 Tracker，告知自己所属 group 等信息，并保持周期性心跳。</p>
<p>　　<strong>Storage Server</strong>：存储服务器，主要提供容量和备份服务；以 group 为单位，每个 group 内可以有多台 storage server，数据互为备份。</p>
<p>　　<strong>Client</strong>：客户端，上传下载数据的服务器，也就是我们自己的项目所部署在的服务器。<br>　　<br>　　<img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046457404302.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">服务基本架构</span>
　　</p>
<h2 id="2、FastDFS的存储策略"><a href="#2、FastDFS的存储策略" class="headerlink" title="2、FastDFS的存储策略"></a>2、FastDFS的存储策略</h2><p>为了支持大容量，存储节点（服务器）采用了分卷（或分组）的组织方式。存储系统由一个或多个卷组成，卷与卷之间的文件是相互独立的，所有卷的文件容量累加就是整个存储系统中的文件容量。一个卷可以由一台或多台存储服务器组成，一个卷下的存储服务器中的文件都是相同的，卷中的多台存储服务器起到了冗余备份和负载均衡的作用。</p>
<p>在卷中增加服务器时，同步已有的文件由系统自动完成，同步完成后，系统自动将新增服务器切换到线上提供服务。当存储空间不足或即将耗尽时，可以动态添加卷。只需要增加一台或多台服务器，并将它们配置为一个新的卷，这样就扩大了存储系统的容量。</p>
<h2 id="3、FastDFS的上传过程"><a href="#3、FastDFS的上传过程" class="headerlink" title="3、FastDFS的上传过程"></a>3、FastDFS的上传过程</h2><p>FastDFS向使用者提供基本文件访问接口，比如upload、download、append、delete等，以客户端库的方式提供给用户使用。</p>
<p>Storage Server会定期的向Tracker Server发送自己的存储信息。当Tracker Server Cluster中的Tracker Server不止一个时，各个Tracker之间的关系是对等的，所以客户端上传时可以选择任意一个Tracker。</p>
<p>当Tracker收到客户端上传文件的请求时，会为该文件分配一个可以存储文件的group，当选定了group后就要决定给客户端分配group中的哪一个storage server。当分配好storage server后，客户端向storage发送写文件请求，storage将会为文件分配一个数据存储目录。然后为文件分配一个fileid，最后根据以上的信息生成文件名存储文件。</p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046457665865.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">FastDFS的上传过程</span></p>
<h2 id="4、FastDFS的文件同步"><a href="#4、FastDFS的文件同步" class="headerlink" title="4、FastDFS的文件同步"></a>4、FastDFS的文件同步</h2><p>写文件时，客户端将文件写至group内一个storage server即认为写文件成功，storage server写完文件后，会由后台线程将文件同步至同group内其他的storage server。</p>
<p>每个storage写文件后，同时会写一份binlog，binlog里不包含文件数据，只包含文件名等元信息，这份binlog用于后台同步，storage会记录向group内其他storage同步的进度，以便重启后能接上次的进度继续同步；进度以时间戳的方式进行记录，所以最好能保证集群内所有server的时钟保持同步。</p>
<p>storage的同步进度会作为元数据的一部分汇报到tracker上，tracke在选择读storage的时候会以同步进度作为参考。</p>
<h2 id="5、FastDFS的文件下载"><a href="#5、FastDFS的文件下载" class="headerlink" title="5、FastDFS的文件下载"></a>5、FastDFS的文件下载</h2><p>客户端uploadfile成功后，会拿到一个storage生成的文件名，接下来客户端根据这个文件名即可访问到该文件。<br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046457879129.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">FastDFS的文件下载过程</span></p>
<p>跟upload file一样，在downloadfile时客户端可以选择任意tracker server。tracker发送download请求给某个tracker，必须带上文件名信息，tracke从文件名中解析出文件的group、大小、创建时间等信息，然后为该请求选择一个storage用来服务读请求。</p>
<h1 id="二、安装FastDFS环境"><a href="#二、安装FastDFS环境" class="headerlink" title="二、安装FastDFS环境"></a>二、安装FastDFS环境</h1><h2 id="0、前言"><a href="#0、前言" class="headerlink" title="0、前言"></a>0、前言</h2><p>操作环境：CentOS7 X64，以下操作都是单机环境。</p>
<p>我把所有的安装包下载到/softpackages/下，解压到当前目录。</p>
<p>先做一件事，修改hosts，将文件服务器的ip与域名映射(单机TrackerServer环境)，因为后面很多配置里面都需要去配置服务器地址，ip变了，就只需要修改hosts即可。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># vim &#x2F;etc&#x2F;hosts<br><br>增加如下一行，这是我的IP<br>118.25.36.41 luischen.cn<br><br>如果要本机访问虚拟机，在C:\Windows\System32\drivers\etc\hosts中同样增加一行<br></code></pre></td></tr></table></figure>

<h2 id="1、下载安装-libfastcommon"><a href="#1、下载安装-libfastcommon" class="headerlink" title="1、下载安装 libfastcommon"></a>1、下载安装 libfastcommon</h2><p>libfastcommon是从 FastDFS 和 FastDHT 中提取出来的公共 C 函数库，基础环境，安装即可 。</p>
<h3 id="①-下载libfastcommon"><a href="#①-下载libfastcommon" class="headerlink" title="① 下载libfastcommon"></a>① 下载libfastcommon</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># wget https:&#x2F;&#x2F;github.com&#x2F;happyfish100&#x2F;libfastcommon&#x2F;archive&#x2F;V1.0.7.tar.gz<br></code></pre></td></tr></table></figure>

<h3 id="②-解压"><a href="#②-解压" class="headerlink" title="② 解压"></a>② 解压</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># tar -zxvf V1.0.7.tar.gz<br># cd libfastcommon-1.0.7<br></code></pre></td></tr></table></figure>

<h3 id="③-编译、安装"><a href="#③-编译、安装" class="headerlink" title="③ 编译、安装"></a>③ 编译、安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># .&#x2F;make.sh<br># .&#x2F;make.sh install<br></code></pre></td></tr></table></figure>

<h3 id="④-libfastcommon-so-安装到了-usr-lib64-libfastcommon-so，但是FastDFS主程序设置的lib目录是-usr-local-lib，所以需要创建软链接。"><a href="#④-libfastcommon-so-安装到了-usr-lib64-libfastcommon-so，但是FastDFS主程序设置的lib目录是-usr-local-lib，所以需要创建软链接。" class="headerlink" title="④ libfastcommon.so 安装到了/usr/lib64/libfastcommon.so，但是FastDFS主程序设置的lib目录是/usr/local/lib，所以需要创建软链接。"></a>④ libfastcommon.so 安装到了/usr/lib64/libfastcommon.so，但是FastDFS主程序设置的lib目录是/usr/local/lib，所以需要创建软链接。</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfastcommon.so &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libfastcommon.so<br># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfastcommon.so &#x2F;usr&#x2F;lib&#x2F;libfastcommon.so<br># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfdfsclient.so &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libfdfsclient.so<br># ln -s &#x2F;usr&#x2F;lib64&#x2F;libfdfsclient.so &#x2F;usr&#x2F;lib&#x2F;libfdfsclient.so<br></code></pre></td></tr></table></figure>

<h2 id="2、下载安装FastDFS"><a href="#2、下载安装FastDFS" class="headerlink" title="2、下载安装FastDFS"></a>2、下载安装FastDFS</h2><h3 id="①-下载FastDFS"><a href="#①-下载FastDFS" class="headerlink" title="① 下载FastDFS"></a>① 下载FastDFS</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># wget https:&#x2F;&#x2F;github.com&#x2F;happyfish100&#x2F;fastdfs&#x2F;archive&#x2F;V5.05.tar.gz<br></code></pre></td></tr></table></figure>

<h3 id="②-解压-1"><a href="#②-解压-1" class="headerlink" title="② 解压"></a>② 解压</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># tar -zxvf V5.05.tar.gz<br># cd fastdfs-5.05<br></code></pre></td></tr></table></figure>

<h3 id="③-编译、安装-1"><a href="#③-编译、安装-1" class="headerlink" title="③ 编译、安装"></a>③ 编译、安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># .&#x2F;make.sh<br># .&#x2F;make.sh install<br></code></pre></td></tr></table></figure>

<h3 id="④-默认安装方式安装后的相应文件与目录"><a href="#④-默认安装方式安装后的相应文件与目录" class="headerlink" title="④ 默认安装方式安装后的相应文件与目录"></a>④ 默认安装方式安装后的相应文件与目录</h3><ul>
<li>A、服务脚本：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">&#x2F;etc&#x2F;init.d&#x2F;fdfs_storaged<br>&#x2F;etc&#x2F;init.d&#x2F;fdfs_tracker<br></code></pre></td></tr></table></figure>
<ul>
<li>B、配置文件（这三个是作者给的样例配置文件） :</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">&#x2F;etc&#x2F;fdfs&#x2F;client.conf.sample<br>&#x2F;etc&#x2F;fdfs&#x2F;storage.conf.sample<br>&#x2F;etc&#x2F;fdfs&#x2F;tracker.conf.sample<br></code></pre></td></tr></table></figure>

<ul>
<li>C、命令工具在 /usr/bin/ 目录下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">fdfs_appender_test<br>fdfs_appender_test1<br>fdfs_append_file<br>fdfs_crc32<br>fdfs_delete_file<br>fdfs_download_file<br>fdfs_file_info<br>fdfs_monitor<br>fdfs_storaged<br>fdfs_test<br>fdfs_test1<br>fdfs_trackerd<br>fdfs_upload_appender<br>fdfs_upload_file<br>stop.sh<br>restart.sh<br></code></pre></td></tr></table></figure>

<h3 id="⑤-FastDFS-服务脚本设置的-bin-目录是-usr-local-bin，-但实际命令安装在-usr-bin-下。"><a href="#⑤-FastDFS-服务脚本设置的-bin-目录是-usr-local-bin，-但实际命令安装在-usr-bin-下。" class="headerlink" title="⑤ FastDFS 服务脚本设置的 bin 目录是 /usr/local/bin， 但实际命令安装在 /usr/bin/ 下。"></a>⑤ FastDFS 服务脚本设置的 bin 目录是 /usr/local/bin， 但实际命令安装在 /usr/bin/ 下。</h3><ul>
<li>建立 /usr/bin 到 /usr/local/bin 的软链接</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># ln -s &#x2F;usr&#x2F;bin&#x2F;fdfs_trackerd   &#x2F;usr&#x2F;local&#x2F;bin<br># ln -s &#x2F;usr&#x2F;bin&#x2F;fdfs_storaged   &#x2F;usr&#x2F;local&#x2F;bin<br># ln -s &#x2F;usr&#x2F;bin&#x2F;stop.sh         &#x2F;usr&#x2F;local&#x2F;bin<br># ln -s &#x2F;usr&#x2F;bin&#x2F;restart.sh      &#x2F;usr&#x2F;local&#x2F;bin<br></code></pre></td></tr></table></figure>

<h2 id="3、配置FastDFS跟踪器-Tracker"><a href="#3、配置FastDFS跟踪器-Tracker" class="headerlink" title="3、配置FastDFS跟踪器(Tracker)"></a>3、配置FastDFS跟踪器(Tracker)</h2><p>配置文件详细说明参考：<a href="http://bbs.chinaunix.net/forum.php?mod=viewthread&tid=1941456&extra=page%3D1%26filter%3Ddigest%26digest%3D1" target="_blank" rel="noopener">FastDFS 配置文件详解</a></p>
<h3 id="①-进入-etc-fdfs，复制-FastDFS-跟踪器样例配置文件-tracker-conf-sample，并重命名为-tracker-conf。"><a href="#①-进入-etc-fdfs，复制-FastDFS-跟踪器样例配置文件-tracker-conf-sample，并重命名为-tracker-conf。" class="headerlink" title="① 进入 /etc/fdfs，复制 FastDFS 跟踪器样例配置文件 tracker.conf.sample，并重命名为 tracker.conf。"></a>① 进入 /etc/fdfs，复制 FastDFS 跟踪器样例配置文件 tracker.conf.sample，并重命名为 tracker.conf。</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># cd &#x2F;etc&#x2F;fdfs<br># cp tracker.conf.sample tracker.conf<br># vim tracker.conf<br></code></pre></td></tr></table></figure>

<h3 id="②-编辑tracker-conf-，修改下，其它的默认即可。"><a href="#②-编辑tracker-conf-，修改下，其它的默认即可。" class="headerlink" title="② 编辑tracker.conf ，修改下，其它的默认即可。"></a>② 编辑tracker.conf ，修改下，其它的默认即可。</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># 配置文件是否不生效，false 为生效<br>disabled&#x3D;false<br><br># 提供服务的端口<br>port&#x3D;22122<br><br># Tracker 数据和日志目录地址(根目录必须存在,子目录会自动创建)----------【需要修改】<br>base_path&#x3D;&#x2F;data&#x2F;fastdfs&#x2F;tracker<br><br># HTTP 服务端口----------【需要修改】<br>http.server_port&#x3D;80<br></code></pre></td></tr></table></figure>

<h3 id="③-创建tracker基础数据目录，即base-path对应的目录"><a href="#③-创建tracker基础数据目录，即base-path对应的目录" class="headerlink" title="③ 创建tracker基础数据目录，即base_path对应的目录"></a>③ 创建tracker基础数据目录，即base_path对应的目录</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">mkdir -p &#x2F;data&#x2F;fastdfs&#x2F;tracker<br></code></pre></td></tr></table></figure>

<h3 id="④-防火墙中打开跟踪端口（默认的22122）"><a href="#④-防火墙中打开跟踪端口（默认的22122）" class="headerlink" title="④ 防火墙中打开跟踪端口（默认的22122）"></a>④ 防火墙中打开跟踪端口（默认的22122）</h3><p>centos7的防火墙由firewalld进行管理</p>
<ul>
<li>查看状态：<code>systemctl status firewalld</code></li>
<li>开启：<code>systemctl start firewalld</code></li>
<li>关闭:  <code>systemctl stop firewalld</code></li>
<li>添加开放IP：<code>firewall-cmd --permanent --zone=public --add-port=22122/tcp</code></li>
<li>重启： <code>firewall-cmd --reload</code></li>
</ul>
<p>查看服务的运行状态：<code>netstat -unltp|grep fdfs</code></p>
<h3 id="⑤-启动Tracker"><a href="#⑤-启动Tracker" class="headerlink" title="⑤ 启动Tracker"></a>⑤ 启动Tracker</h3><p>初次成功启动，会在 /data/fastdfs/tracker/ (配置的base_path)下创建 data、logs 两个目录。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">可以用这种方式启动<br># &#x2F;etc&#x2F;init.d&#x2F;fdfs_trackerd start<br><br>也可以用这种方式启动，前提是上面创建了软链接，后面都用这种方式<br># service fdfs_trackerd start<br></code></pre></td></tr></table></figure>

<p>查看 FastDFS Tracker 是否已成功启动 ，22122端口正在被监听，则算是Tracker服务安装成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># netstat -unltp|grep fdfs<br></code></pre></td></tr></table></figure>

<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046457980987.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>关闭Tracker命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># service fdfs_trackerd stop<br></code></pre></td></tr></table></figure>

<h3 id="⑥-设置Tracker开机启动"><a href="#⑥-设置Tracker开机启动" class="headerlink" title="⑥ 设置Tracker开机启动"></a>⑥ 设置Tracker开机启动</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># chkconfig fdfs_trackerd on<br><br>或者：<br># vim &#x2F;etc&#x2F;rc.d&#x2F;rc.local<br>加入配置：<br>&#x2F;etc&#x2F;init.d&#x2F;fdfs_trackerd start<br></code></pre></td></tr></table></figure>

<h3 id="⑦-tracker-server-目录及文件结构"><a href="#⑦-tracker-server-目录及文件结构" class="headerlink" title="⑦ tracker server 目录及文件结构"></a>⑦ tracker server 目录及文件结构</h3><p>Tracker服务启动成功后，会在base_path下创建data、logs两个目录。目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">$&#123;base_path&#125;<br>  |__data<br>  |   |__storage_groups.dat：存储分组信息<br>  |   |__storage_servers.dat：存储服务器列表<br>  |__logs<br>  |   |__trackerd.log： tracker server 日志文件<br></code></pre></td></tr></table></figure>

<h2 id="4、配置-FastDFS-存储-Storage"><a href="#4、配置-FastDFS-存储-Storage" class="headerlink" title="4、配置 FastDFS 存储 (Storage)"></a>4、配置 FastDFS 存储 (Storage)</h2><h3 id="①-进入-etc-fdfs-目录，复制-FastDFS-存储器样例配置文件-storage-conf-sample，并重命名为-storage-conf"><a href="#①-进入-etc-fdfs-目录，复制-FastDFS-存储器样例配置文件-storage-conf-sample，并重命名为-storage-conf" class="headerlink" title="① 进入 /etc/fdfs 目录，复制 FastDFS 存储器样例配置文件 storage.conf.sample，并重命名为 storage.conf"></a>① 进入 /etc/fdfs 目录，复制 FastDFS 存储器样例配置文件 storage.conf.sample，并重命名为 storage.conf</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># cd &#x2F;etc&#x2F;fdfs<br># cp storage.conf.sample storage.conf<br># vim storage.conf<br></code></pre></td></tr></table></figure>

<h3 id="②-编辑storage-conf"><a href="#②-编辑storage-conf" class="headerlink" title="② 编辑storage.conf"></a>② 编辑storage.conf</h3><p>修改以下，其它的默认即可。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># 配置文件是否不生效，false 为生效<br>disabled&#x3D;false <br><br># 指定此 storage server 所在 组(卷)<br>group_name&#x3D;group1<br><br># storage server 服务端口<br>port&#x3D;23000<br><br># 心跳间隔时间，单位为秒 (这里是指主动向 tracker server 发送心跳)<br>heart_beat_interval&#x3D;30<br><br># Storage 数据和日志目录地址(根目录必须存在，子目录会自动生成)----------【需要修改】<br>base_path&#x3D;&#x2F;data&#x2F;fastdfs&#x2F;storage<br><br># 存放文件时 storage server 支持多个路径。这里配置存放文件的基路径数目，通常只配一个目录。<br>store_path_count&#x3D;1<br><br><br># 逐一配置 store_path_count 个路径，索引号基于 0。<br># 如果不配置 store_path0，那它就和 base_path 对应的路径一样。----------【需要修改】<br>store_path0&#x3D;&#x2F;data&#x2F;fastdfs&#x2F;file<br><br># FastDFS 存储文件时，采用了两级目录。这里配置存放文件的目录个数。 <br># 如果本参数只为 N（如： 256），那么 storage server 在初次运行时，会在 store_path 下自动创建 N * N 个存放文件的子目录。<br>subdir_count_per_path&#x3D;256<br><br># tracker_server 的列表 ，会主动连接 tracker_server<br># 有多个 tracker server 时，每个 tracker server 写一行----------【需要修改】<br>tracker_server&#x3D;118.25.36.41:22122<br><br># 允许系统同步的时间段 (默认是全天) 。一般用于避免高峰同步产生一些问题而设定。<br>sync_start_time&#x3D;00:00<br>sync_end_time&#x3D;23:59<br># 访问端口----------------------------------------【需要修改】<br>http.server_port&#x3D;80<br></code></pre></td></tr></table></figure>

<h3 id="③-创建Storage基础数据目录，对应base-path目录"><a href="#③-创建Storage基础数据目录，对应base-path目录" class="headerlink" title="③ 创建Storage基础数据目录，对应base_path目录"></a>③ 创建Storage基础数据目录，对应base_path目录</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># mkdir -p &#x2F;data&#x2F;fastdfs&#x2F;storage<br><br># 这是配置的store_path0路径<br># mkdir -p &#x2F;data&#x2F;fastdfs&#x2F;file<br></code></pre></td></tr></table></figure>

<h3 id="④-防火墙中打开存储器端口（默认的-23000）"><a href="#④-防火墙中打开存储器端口（默认的-23000）" class="headerlink" title="④ 防火墙中打开存储器端口（默认的 23000）"></a>④ 防火墙中打开存储器端口（默认的 23000）</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># 添加开放IP：<br>firewall-cmd --permanent --zone&#x3D;public --add-port&#x3D;23000&#x2F;tcp<br># 重启： <br>firewall-cmd --reload<br></code></pre></td></tr></table></figure>

<h3 id="⑤-启动-Storage"><a href="#⑤-启动-Storage" class="headerlink" title="⑤ 启动 Storage"></a>⑤ 启动 Storage</h3><p>启动Storage前确保Tracker是启动的。初次启动成功，会在 /data/fastdfs/storage 目录下创建 data、 logs 两个目录。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">可以用这种方式启动<br># &#x2F;etc&#x2F;init.d&#x2F;fdfs_storaged start<br><br>也可以用这种方式，后面都用这种<br># service fdfs_storaged start<br></code></pre></td></tr></table></figure>

<p>查看 Storage 是否成功启动，23000 端口正在被监听，就算 Storage 启动成功。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># netstat -unltp|grep fdfs<br></code></pre></td></tr></table></figure>

<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046458057926.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>关闭Storage命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># service fdfs_storaged stop<br></code></pre></td></tr></table></figure>

<p>查看Storage和Tracker是否在通信：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">&#x2F;usr&#x2F;bin&#x2F;fdfs_monitor &#x2F;etc&#x2F;fdfs&#x2F;storage.conf<br></code></pre></td></tr></table></figure>

<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046458093927.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="⑥-设置-Storage-开机启动"><a href="#⑥-设置-Storage-开机启动" class="headerlink" title="⑥ 设置 Storage 开机启动"></a>⑥ 设置 Storage 开机启动</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># chkconfig fdfs_storaged on<br><br>或者：<br># vim &#x2F;etc&#x2F;rc.d&#x2F;rc.local<br>加入配置：<br>&#x2F;etc&#x2F;init.d&#x2F;fdfs_storaged start<br></code></pre></td></tr></table></figure>

<h3 id="⑦-Storage-目录"><a href="#⑦-Storage-目录" class="headerlink" title="⑦ Storage 目录"></a>⑦ Storage 目录</h3><p>同 Tracker，Storage 启动成功后，在base_path 下创建了data、logs目录，记录着 Storage Server 的信息。</p>
<p>在 store_path0 目录下，创建了N*N个子目录：</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046458151928.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h2 id="5、文件上传测试"><a href="#5、文件上传测试" class="headerlink" title="5、文件上传测试"></a>5、文件上传测试</h2><h3 id="①-修改-Tracker-服务器中的客户端配置文件"><a href="#①-修改-Tracker-服务器中的客户端配置文件" class="headerlink" title="① 修改 Tracker 服务器中的客户端配置文件"></a>① 修改 Tracker 服务器中的客户端配置文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># cd &#x2F;etc&#x2F;fdfs<br># cp client.conf.sample client.conf<br># vim client.conf<br></code></pre></td></tr></table></figure>

<p>修改如下配置即可，其它默认。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># Client 的数据和日志目录<br>base_path&#x3D;&#x2F;data&#x2F;fastdfs&#x2F;client<br><br># Tracker端口<br>tracker_server&#x3D;118.25.36.41:22122<br></code></pre></td></tr></table></figure>

<h3 id="②-上传测试"><a href="#②-上传测试" class="headerlink" title="② 上传测试"></a>② 上传测试</h3><p>首先需要创建client目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">mkdir -p &#x2F;data&#x2F;fastdfs&#x2F;client<br></code></pre></td></tr></table></figure>

<p> 在linux内部执行如下命令上传 namei.jpeg 图片</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># &#x2F;usr&#x2F;bin&#x2F;fdfs_upload_file &#x2F;etc&#x2F;fdfs&#x2F;client.conf storage.conf<br></code></pre></td></tr></table></figure>

<p> 上传成功后返回文件ID号：</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">group1&#x2F;M00&#x2F;00&#x2F;00&#x2F;Cmlg2FrLU9eAVJ-ZAAAejzOgbzU97.conf<br></code></pre></td></tr></table></figure>

<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046458201073.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">上传成功</span></p>
<p> 返回的文件ID由group、存储目录、两级子目录、fileid、文件后缀名（由客户端指定，主要用于区分文件类型）拼接而成。</p>
<p> <img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046766779695.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h1 id="三、安装Nginx"><a href="#三、安装Nginx" class="headerlink" title="三、安装Nginx"></a>三、安装Nginx</h1><p>上面将文件上传成功了，但我们无法下载。因此安装Nginx作为服务器以支持Http方式访问文件。同时，后面安装FastDFS的Nginx模块也需要Nginx环境。</p>
<p>Nginx只需要安装到StorageServer所在的服务器即可，用于访问文件。我这里由于是单机，TrackerServer和StorageServer在一台服务器上。</p>
<h2 id="1、安装nginx所需环境"><a href="#1、安装nginx所需环境" class="headerlink" title="1、安装nginx所需环境"></a>1、安装nginx所需环境</h2><h3 id="①-gcc-安装"><a href="#①-gcc-安装" class="headerlink" title="① gcc 安装"></a>① gcc 安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># yum install gcc-c++<br></code></pre></td></tr></table></figure>

<h3 id="②-PCRE-pcre-devel-安装"><a href="#②-PCRE-pcre-devel-安装" class="headerlink" title="② PCRE pcre-devel 安装"></a>② PCRE pcre-devel 安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># yum install -y pcre pcre-devel<br></code></pre></td></tr></table></figure>

<h3 id="③-zlib-安装"><a href="#③-zlib-安装" class="headerlink" title="③ zlib 安装"></a>③ zlib 安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># yum install -y zlib zlib-devel<br></code></pre></td></tr></table></figure>

<h3 id="④-OpenSSL-安装"><a href="#④-OpenSSL-安装" class="headerlink" title="④ OpenSSL 安装"></a>④ OpenSSL 安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># yum install -y openssl openssl-devel<br></code></pre></td></tr></table></figure>

<h2 id="2、安装Nginx"><a href="#2、安装Nginx" class="headerlink" title="2、安装Nginx"></a>2、安装Nginx</h2><h3 id="①-下载nginx"><a href="#①-下载nginx" class="headerlink" title="① 下载nginx"></a>① 下载nginx</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># wget -c https:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.12.1.tar.gz<br></code></pre></td></tr></table></figure>

<h3 id="②-解压-2"><a href="#②-解压-2" class="headerlink" title="② 解压"></a>② 解压</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># tar -zxvf nginx-1.12.1.tar.gz<br># cd nginx-1.12.1<br></code></pre></td></tr></table></figure>

<h3 id="③-使用默认配置"><a href="#③-使用默认配置" class="headerlink" title="③ 使用默认配置"></a>③ 使用默认配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># .&#x2F;configure<br></code></pre></td></tr></table></figure>

<h3 id="④-编译、安装"><a href="#④-编译、安装" class="headerlink" title="④ 编译、安装"></a>④ 编译、安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># make<br># make install<br></code></pre></td></tr></table></figure>

<h3 id="⑤-启动nginx"><a href="#⑤-启动nginx" class="headerlink" title="⑤ 启动nginx"></a>⑤ 启动nginx</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># cd &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;<br># .&#x2F;nginx <br><br>其它命令<br># .&#x2F;nginx -s stop<br># .&#x2F;nginx -s quit<br># .&#x2F;nginx -s reload<br></code></pre></td></tr></table></figure>

<h3 id="⑥-设置开机启动"><a href="#⑥-设置开机启动" class="headerlink" title="⑥ 设置开机启动"></a>⑥ 设置开机启动</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"><br># vim &#x2F;etc&#x2F;rc.local<br><br>添加一行：<br>&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx<br><br># 设置执行权限<br># chmod 755 &#x2F;etc&#x2F;rc.local<br></code></pre></td></tr></table></figure>

<h3 id="⑦-查看nginx的版本及模块"><a href="#⑦-查看nginx的版本及模块" class="headerlink" title="⑦ 查看nginx的版本及模块"></a>⑦ 查看nginx的版本及模块</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -V<br></code></pre></td></tr></table></figure>

<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046458483555.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="⑧-防火墙中打开Nginx端口（默认的-80）"><a href="#⑧-防火墙中打开Nginx端口（默认的-80）" class="headerlink" title="⑧ 防火墙中打开Nginx端口（默认的 80）"></a>⑧ 防火墙中打开Nginx端口（默认的 80）</h3><p>添加后就能在本机使用80端口访问了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># 添加开放IP：<br>firewall-cmd --permanent --zone&#x3D;public --add-port&#x3D;80&#x2F;tcp<br># 重启： <br>firewall-cmd --reload<br></code></pre></td></tr></table></figure>


<h2 id="3、访问文件"><a href="#3、访问文件" class="headerlink" title="3、访问文件"></a>3、访问文件</h2><p>简单的测试访问文件</p>
<h3 id="①-修改nginx-conf"><a href="#①-修改nginx-conf" class="headerlink" title="① 修改nginx.conf"></a>① 修改nginx.conf</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># vim &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf<br><br>添加如下行，将 &#x2F;group1&#x2F;M00 映射到 &#x2F;data&#x2F;fastdfs&#x2F;file&#x2F;data<br>location &#x2F;group1&#x2F;M00 &#123;<br>    alias &#x2F;data&#x2F;fastdfs&#x2F;file&#x2F;data;<br>&#125;<br><br># 重启nginx<br># &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s reload<br></code></pre></td></tr></table></figure>

<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046458524552.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>② 在浏览器访问之前上传的图片、成功。</p>
<p><a href="http://118.25.36.41/group1/M00/00/00/Cmlg2FrLU9eAVJ-ZAAAejzOgbzU97.conf" target="_blank" rel="noopener">http://118.25.36.41/group1/M00/00/00/Cmlg2FrLU9eAVJ-ZAAAejzOgbzU97.conf</a></p>
<h1 id="四、FastDFS-配置-Nginx-模块"><a href="#四、FastDFS-配置-Nginx-模块" class="headerlink" title="四、FastDFS 配置 Nginx 模块"></a>四、FastDFS 配置 Nginx 模块</h1><h2 id="1、安装配置Nginx模块"><a href="#1、安装配置Nginx模块" class="headerlink" title="1、安装配置Nginx模块"></a>1、安装配置Nginx模块</h2><h3 id="①-fastdfs-nginx-module-模块说明"><a href="#①-fastdfs-nginx-module-模块说明" class="headerlink" title="① fastdfs-nginx-module 模块说明"></a>① fastdfs-nginx-module 模块说明</h3><p>FastDFS 通过 Tracker 服务器，将文件放在 Storage 服务器存储， 但是同组存储服务器之间需要进行文件复制， 有同步延迟的问题。</p>
<p>　　假设 Tracker 服务器将文件上传到了 192.168.51.128，上传成功后文件 ID已经返回给客户端。</p>
<p>　　此时 FastDFS 存储集群机制会将这个文件同步到同组存储 192.168.51.129，在文件还没有复制完成的情况下，客户端如果用这个文件 ID 在 192.168.51.129 上取文件,就会出现文件无法访问的错误。</p>
<p>　　而 fastdfs-nginx-module 可以重定向文件链接到源服务器取文件，避免客户端由于复制延迟导致的文件无法访问错误。
　　</p>
<h3 id="②-下载-fastdfs-nginx-module、解压"><a href="#②-下载-fastdfs-nginx-module、解压" class="headerlink" title="② 下载 fastdfs-nginx-module、解压"></a>② 下载 fastdfs-nginx-module、解压</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># 这里为啥这么长一串呢，因为最新版的master与当前nginx有些版本问题。<br># wget https:&#x2F;&#x2F;github.com&#x2F;happyfish100&#x2F;fastdfs-nginx-module&#x2F;archive&#x2F;5e5f3566bbfa57418b5506aaefbe107a42c9fcb1.zip<br><br># 解压<br># unzip 5e5f3566bbfa57418b5506aaefbe107a42c9fcb1.zip<br><br># 重命名<br># mv fastdfs-nginx-module-5e5f3566bbfa57418b5506aaefbe107a42c9fcb1  fastdfs-nginx-module-master<br></code></pre></td></tr></table></figure>

<h3 id="③-配置Nginx"><a href="#③-配置Nginx" class="headerlink" title="③ 配置Nginx"></a>③ 配置Nginx</h3><p>在nginx中添加模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># 先停掉nginx服务<br># &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;ngix -s stop<br><br>进入解压包目录<br># cd &#x2F;softpackages&#x2F;nginx-1.12.1&#x2F;<br><br># 添加模块<br># .&#x2F;configure --add-module&#x3D;..&#x2F;fastdfs-nginx-module-master&#x2F;src<br><br>重新编译、安装<br># make &amp;&amp; make install<br></code></pre></td></tr></table></figure>

<h3 id="④-查看Nginx的模块"><a href="#④-查看Nginx的模块" class="headerlink" title="④ 查看Nginx的模块"></a>④ 查看Nginx的模块</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -V<br></code></pre></td></tr></table></figure>

<p>有下面这个就说明添加模块成功</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046458581094.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="⑤-复制-fastdfs-nginx-module-源码中的配置文件到-etc-fdfs-目录，-并修改"><a href="#⑤-复制-fastdfs-nginx-module-源码中的配置文件到-etc-fdfs-目录，-并修改" class="headerlink" title="⑤ 复制 fastdfs-nginx-module 源码中的配置文件到/etc/fdfs 目录， 并修改"></a>⑤ 复制 fastdfs-nginx-module 源码中的配置文件到/etc/fdfs 目录， 并修改</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># cd &#x2F;softpackages&#x2F;fastdfs-nginx-module-master&#x2F;src<br><br># cp mod_fastdfs.conf &#x2F;etc&#x2F;fdfs&#x2F;<br></code></pre></td></tr></table></figure>

<p>修改如下配置，其它默认</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># cd &#x2F;softpackages&#x2F;fastdfs-nginx-module-master&#x2F;src<br><br># cp mod_fastdfs.conf &#x2F;etc&#x2F;fdfs&#x2F;<br></code></pre></td></tr></table></figure>

<p>修改如下配置，其它默认</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># 连接超时时间<br>connect_timeout&#x3D;10<br><br># Tracker Server<br>tracker_server&#x3D;118.25.36.41:22122<br><br># StorageServer 默认端口<br>storage_server_port&#x3D;23000<br><br># 如果文件ID的uri中包含&#x2F;group**，则要设置为true<br>url_have_group_name &#x3D; true<br><br># Storage 配置的store_path0路径，必须和storage.conf中的一致<br>store_path0&#x3D;&#x2F;data&#x2F;fastdfs&#x2F;file<br></code></pre></td></tr></table></figure>

<h3 id="⑥-复制-FastDFS-的部分配置文件到-etc-fdfs-目录"><a href="#⑥-复制-FastDFS-的部分配置文件到-etc-fdfs-目录" class="headerlink" title="⑥ 复制 FastDFS 的部分配置文件到/etc/fdfs 目录"></a>⑥ 复制 FastDFS 的部分配置文件到/etc/fdfs 目录</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># cd &#x2F;softpackages&#x2F;fastdfs-5.05&#x2F;conf&#x2F;<br><br># cp anti-steal.jpg http.conf mime.types &#x2F;etc&#x2F;fdfs&#x2F;<br></code></pre></td></tr></table></figure>

<h3 id="⑦-配置nginx，修改nginx-conf"><a href="#⑦-配置nginx，修改nginx-conf" class="headerlink" title="⑦ 配置nginx，修改nginx.conf"></a>⑦ 配置nginx，修改nginx.conf</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># vim &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf<br></code></pre></td></tr></table></figure>

<p>修改配置，其它的默认</p>
<p>在80端口下添加fastdfs-nginx模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">location ~&#x2F;group([0-9])&#x2F;M00 &#123;<br>    ngx_fastdfs_module;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046458635093.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><strong>注意：</strong><br>listen 80 端口值是要与 /etc/fdfs/storage.conf 中的 http.server_port=80 (前面改成80了)相对应。如果改成其它端口，则需要统一，同时在防火墙中打开该端口。</p>
<p>　　location 的配置，如果有多个group则配置location ~/group([0-9])/M00 ，没有则不用配group。
　　</p>
<h3 id="⑧-在-data-fastdfs-file-文件存储目录下创建软连接，将其链接到实际存放数据的目录，这一步可以省略。"><a href="#⑧-在-data-fastdfs-file-文件存储目录下创建软连接，将其链接到实际存放数据的目录，这一步可以省略。" class="headerlink" title="⑧ 在/data/fastdfs/file 文件存储目录下创建软连接，将其链接到实际存放数据的目录，这一步可以省略。"></a>⑧ 在/data/fastdfs/file 文件存储目录下创建软连接，将其链接到实际存放数据的目录，这一步可以省略。</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># ln -s &#x2F;data&#x2F;fastdfs&#x2F;file&#x2F;data&#x2F; &#x2F;data&#x2F;fastdfs&#x2F;file&#x2F;data&#x2F;M00<br></code></pre></td></tr></table></figure>

<h3 id="⑨-启动nginx"><a href="#⑨-启动nginx" class="headerlink" title="⑨ 启动nginx"></a>⑨ 启动nginx</h3><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain"># &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx<br></code></pre></td></tr></table></figure>

<p>打印处如下就算配置成功</p>
<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046458687094.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="⑩-在地址栏访问"><a href="#⑩-在地址栏访问" class="headerlink" title="⑩ 在地址栏访问"></a>⑩ 在地址栏访问</h3><p>能下载文件就算安装成功。注意和第三点中直接使用nginx路由访问不同的是，这里配置 fastdfs-nginx-module 模块，可以重定向文件链接到源服务器取文件。</p>
<p><a href="http://118.25.36.41/group1/M00/00/00/Cmlg2FrLU9eAVJ-ZAAAejzOgbzU97.conf" target="_blank" rel="noopener">http://118.25.36.41/group1/M00/00/00/Cmlg2FrLU9eAVJ-ZAAAejzOgbzU97.conf</a></p>
<p>最终部署结构图(盗的图)：可以按照下面的结构搭建环境。<br><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046458722093.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>以上</p>
<p>原作者：bojiangzhou<br>原出处：<a href="http://www.cnblogs.com/chiangchou/" target="_blank" rel="noopener">http://www.cnblogs.com/chiangchou/</a>
　　</p>
]]></content>
      <categories>
        <category>FastDFS</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>FastDFS</tag>
      </tags>
  </entry>
  <entry>
    <title>如何提高即兴演讲水平？</title>
    <url>/2018/03/31/how_to_impromptu_speech/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046460667070.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br>什么是即兴演讲？</p>
<a id="more"></a>

<p>即兴演讲在演讲中的比例非常大，占到了80%以上。大到被临时邀请登上几百上千人的舞台上发言，小到平时的各种面试、遇到老板时被问起工作等，都可以说是即兴演讲。<br>即兴演讲的最大特点就是未做准备，或者说没有时间准备。同时即兴演讲在思维的敏捷性、语言的逻辑性和口头表达的雄辩性方面有更高的要求。大部分人对公众演讲的恐惧和害怕，主要来自对即兴演讲的恐惧和害怕。说到即兴演讲，大部分人都很害怕。虽然如此，但还是有方法可以训练，有技巧可以应对，让你一遇到即兴演讲，即使还没想好，但是根据这些方法技巧，你还是可以有话可讲，甚至边想边讲，边讲边想，不至于自己无话可说，呆呆站在那里，显得很白痴。今天这篇文章介绍的方法技巧，几乎可以帮你搞定所有即兴演讲。</p>
<h2 id="一-散-点-联-想-法"><a href="#一-散-点-联-想-法" class="headerlink" title="一. 散 点 联 想 法"></a>一. 散 点 联 想 法</h2><p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046504719752.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">自信</span></p>
<p>我们先来介绍一种练习即兴演讲的方法。<strong>散点联想法，简单说，就是将几个看似没有关联的、不相干的词语，通过一定的语言表达方式，巧妙的串联起来，组合成一段话，表达一个完整的意思。</strong></p>
<p>说到“苹果”， 大家会想到什么？ 身边吃的苹果， 乔布斯的苹果公司，被苹果砸下的牛顿，还是联想到其他… 如果你想到水果中的苹果，也没问题，可以说说吃苹果的好处，苹果的作用等等；如果你因为苹果而想到苹果公司，想到乔布斯，联想到创新，就可以把苹果和乔布斯关联起来，把苹果跟创新关联起来；如果你联想到了牛顿，联想到牛顿因为被苹果砸了而发现了万有引力定律，这样苹果就和万有引力，和机会(机会总是留给有准备的人，如果换成别人，被苹果砸了也就砸了，而不会发现万有引力）联系起来。这就不仅仅从表层意思说苹果，<strong>演讲起来内容更有深度</strong>。</p>
<p>散点联想法，是可以来锻炼我们的联想能力和想象能力，同时也可以提高我们的即兴演讲水平的一种训练方法。</p>
<p>比如下面三个词：  白马，老庄，天空。</p>
<p>这三个词并没什么关联，怎么把它们组成一个完成的意思呢？</p>
<p>你可以这样说：</p>
<p>白马在默默的吃草，它的一旁坐着老庄，老庄抬头看着天空。</p>
<p>三个词都用到了，也是完整的一个意思，这是一个比较静态的画面。</p>
<p>你还可以这样说：</p>
<p>老庄无聊的走在河边，突然看见前面有一匹白马，于是他就跑过去骑在白马上，白马载着老庄越跑越快，最后飞向了天空。老庄就骑着白马四处路见不平就拔刀相助，从此，地球上多了一个白马英雄。</p>
<p>这样，是不是不仅把几个不相关的词串在一起，同时还增加了故事性呢？</p>
<p>散点联想法，各个词不一定要按顺序来，也不要受现实条件的限制，想象的越丰富，故事情节越有趣越好。刚开始可以从三个词开始，后面可以增加到四个词、五个词甚至更多。难度逐渐增加，同时也可能会带来更加意想不到好玩的有趣的故事来。</p>
<p>再来一个： 马桶  洋娃娃  手机 袜子</p>
<p>我之前给青少年演讲班上课，有一个学生是这样说的：拥有人工智能的洋娃娃蹲着马桶上看手机，突然，手一抖，手机就掉马桶里了。洋娃娃很着急，于是拿起身边的一只袜子，踩在袜子上跳进了马桶，洋娃娃踩着袜子就像踩在滑板上一样，顺着马桶深处滑去，她终于找到了手机，但是她没有停止，继续踏着袜子在马桶的管道里滑啊滑，后来她滑出了管道，来到了一座城堡，遇见了一位王子。</p>
<p>下面给大家几组词，一起来练习一下吧：</p>
<ol>
<li><p>深圳   宇宙   小明  故宫</p>
</li>
<li><p>长江   大树   老虎  台灯</p>
</li>
<li><p>汽车   蚂蚁   拖鞋  电脑</p>
</li>
<li><p>红领巾 扫把 蜘蛛侠 闹钟</p>
</li>
<li><p>功夫熊猫 大海  小米 花瓶</p>
</li>
<li><p>飞机  碗  太平洋  垃圾桶</p>
</li>
</ol>
<p>散点联想法，可以和家人朋友一起练习。如果有孩子，可以和孩子一起练习，既能锻炼孩子的即兴演讲能力，还能促进和孩子的关系。也可以和朋友一起练习，不要让思维受限，可以天马行空的联想。故事越丰富越有血有肉越好。通过一段时间的练习，联想能力和想象能力都会得到提升，即兴演讲的水平也会提高。</p>
<h2 id="二-问题–原因–解决方案"><a href="#二-问题–原因–解决方案" class="headerlink" title="二. 问题–原因–解决方案"></a>二. 问题–原因–解决方案</h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046504870169.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><strong>针对问题和现象的即兴演讲技巧。</strong><br>一对夫妻商量好了，老婆做饭，老公刷碗。有一天老公没刷碗，于是出现了这样一幕：</p>
<p>老婆：你怎么又没刷碗了？</p>
<p>老公：不就忘刷碗了吗，至于这么大声吗？</p>
<p>老婆：嘿，你自己做错事，还有理了啊….</p>
<p>然后家里就咚锵咚锵咚咚锵…..</p>
<p>同样一个事情，在另一对夫妻那里是这样的：</p>
<p>老婆：老公，你怎么又没刷碗？</p>
<p>老公：老婆，对不起我忘了刷碗。因为最近太忙了，老想着工作的事，吃完饭就想去工作，就把刷碗这事给忘了。我现在马上去刷碗。下次，吃完饭后你要提醒我一下，这样我就不会忘记洗碗了。同时，我建议我们要不去买台洗碗机吧？它可洗得比我干净，我也不会忘记洗碗，还能节省一些时间。老婆，你说好吗？</p>
<p>老婆听着老公的态度诚恳，建议也是有道理的，就说：这个建议不错，我们就买台洗碗机吧。钱我来出。</p>
<p>上面两种情景，你更喜欢哪一种？</p>
<p>这里我们跟大家介绍一个即兴演讲魔法公式：<strong>问题–原因–解决方案</strong>。</p>
<p><strong>问题</strong>：先把问题阐述一下。</p>
<p><strong>原因</strong>：分析产生问题的原因有哪些?</p>
<p><strong>解决方案</strong>：针对这个问题，我们可以采取哪些措施？</p>
<p>在被<strong>问到问题和现象的时候</strong>可以用这个即兴演讲公式，这个公式在<strong>商业和职场中用的非常多。</strong></p>
<p>比如你在坐电梯时遇到老板，老板问你为什么3月份的销售额下降了。虽然在电梯里的时间很短，但是你如果学会这个公式，就可以轻松的应对你的老板。我们来演练一下：</p>
<p>老板：为什么3月的销售额下降了？</p>
<p>你：老板，3月份的销售额确实下降了一些（陈述问题）。我们也分析了原因，有以下几点：第一，2月份过年，大家都在2月份买了很多东西，3月份买的东西少了；第二，最近销售人员流失率比较大，热情也不够高；第三，竞争对手的新品在3月份上市了，抢走了我们一些客户（分析原因）。我们也做出了相应的对策：第一，会协同HR部门，招聘和培训好的销售人员，给销售人员更多激励，调动起积极性；第二，协同研发部门尽快上市我们的最新产品；第三，更深入的研究竞争对手，制定更有吸引力的价格策略（解决方案）。</p>
<p>老板：既然想到了这些方案，那你们就好好干吧，希望4月份的业绩能够上去。</p>
<p>这样的话，老板看你不仅知道了问题的存在，还自省分析了原因，而且还已经做出了相对应的解决方案。也就不为难你了，甚至可能以后会更加器重你。</p>
<p>在实际工作中，出现各种问题是难免的，<strong>关键在于，你不能把问题留给老板或上级。你还要分析原因，最好能给出解决方案。</strong>不能等着老板给你解决方法。老板是喜欢做选择题而不是问答题的人，可以给出几个不同的方案，让老板来拍板。在职场中遇到问题，灵活的应用这个方式，你离升职加薪就不远了。</p>
<p>在生<strong>活中也有很多场合可以适用</strong>的。刚才开头的那个故事，第二对夫妻的老公就是用这种方法，同时化解了矛盾。我们来分析一下。</p>
<p>问题：“老婆，对不起我忘了刷碗”，忘记刷碗这个问题。</p>
<p>原因：“因为最近太忙了，老想着工作的事，吃完饭就想去工作，就把刷碗这事给忘了。”</p>
<p>解决方案：其实有三个： </p>
<p>第一个，“我现在马上去刷碗。”；</p>
<p>第二个，“下次，吃完饭后你要提醒我一下，这样我就不会忘记洗碗了。”；</p>
<p>第三个，“同时，我建议我们要不去买台洗碗机吧？它可洗得比我干净，我也不会忘记洗碗，还能节省一些时间。”</p>
<p><strong>很多时候，在家庭生活中应用这种方法，可以避免很多家庭矛盾，让生活更和谐。</strong></p>
<p>在被问到<strong>社会问题或社会现象</strong>时，也可以很好的应用这种方法。看下面这个例子：</p>
<p>我国青少年肥胖的比率越来越高了，从1990年的10%增加到2015年的20%。你是如何看待的？</p>
<p>我可以这么说：</p>
<p>问题）的确，现在青少年肥胖的比率越来越高了。（原因）我认为导致青少年肥胖比率增加的原因有：一，现在生活水平提高，吃的东西特别多，尤其是各种高热量的垃圾食品非常多；二，青少年的时间被各种课业和辅导班占用了，运动的时间很少。（解决方案）为了解决青少年肥胖问题，我建议：第一，提倡多吃粗粮，少吃垃圾食品，吃饭只吃七分饱就行；</p>
<p>第二，减少青少年的课业，让青少年有更多的运动时间。（呼吁行动）最后，我呼吁我们社会，学校，家庭一起行动起来，让孩子尽量少吃垃圾食品，每天多一些运动的时间。这样，相信不久的将来，我们青少年肥胖的比例会得到控制，甚至降低。</p>
<p>细心的朋友可能发现了上面的例子最后还有一个呼吁行动。没错，对于”问题–原因–解决方案“结构，有时候在后面还可以加上“行动”，变成“问题–原因–解决方案–行动”，这是这个魔法公式的变体。学会了以上这个公式，以后在街头被记者采访问到你对社会问题和社会现象的看法时，你就知道怎么说了吧？</p>
<p>下面给大家几个题目来练习一下吧：</p>
<ol>
<li><p>我又长胖了。</p>
</li>
<li><p>为什么客户投诉这么多？</p>
</li>
<li><p>水污染很严重，你怎么看？</p>
</li>
<li><p>交通堵塞的现象越来越严重了。</p>
</li>
</ol>
<p>在社会、职场及日常生活中，魔法公式“问题–原因–解决方案”都可以很好的帮你在面对问题和现象时，短时间内就有一个即兴演讲框架出来。</p>
<p>你会了吗？</p>
<h2 id="三-感谢–回顾–愿景"><a href="#三-感谢–回顾–愿景" class="headerlink" title="三. 感谢–回顾–愿景"></a>三. 感谢–回顾–愿景</h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046505037447.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><strong>针对各种聚会场合的即兴演讲技巧。</strong></p>
<p>在我们的生活工作中，常常需要出席各种聚会场合，例如：亲朋好友婚礼，朋友生日会，大学毕业XX年同学会，颁奖会，公司联欢会，客户答谢会，孩子毕业典礼，家庭聚会，葬礼，同事告别会等等。这些场合，有时候会邀请你上台做即兴发言，你怎么办？</p>
<p>不用怕，放轻松，老庄现在教你一个万能公式，可以让你几乎在所有的聚会场合都能有话可讲。这个公式是：<strong>感谢–回顾–愿景</strong></p>
<p><strong>感谢</strong>：常常用在开头，表示一定的礼节性，比如感谢主持人邀请你发言，感谢主人邀请你来参加聚会等。</p>
<p><strong>回顾</strong>：简单回顾一下以往发生的事情，如果有你跟会场的主人或者在场的其他人之间的情谊往事的会更好。</p>
<p><strong>愿景</strong>：表示祝愿、畅想、祝贺、表决心等等。</p>
<p>如果用时间来分析这个公式，“感谢”是表示现在，感谢当下的人或事；“回顾”表示过去，回忆过去发生的事情；“愿景”则表示将来，对未来的畅想、祝福、祝愿以及决心行动等等。所以，你可以把这个公式简单的理解为<strong>：现在，过去和未来</strong>。</p>
<p>这个公式非常简单，就六个字。我们下面举几个例子，帮助大家更好的理解这个聚会场合即兴发言万能公式。</p>
<p>例子一：在朋友的婚礼上，邀请你上台发言，你是新郎的好友。就假设是老庄的婚礼上吧。</p>
<p>下面我们来演练一下：</p>
<p>首先，感谢婚礼主持人给我这个发言的机会，也特别感谢老庄邀请我来参加他的婚礼。（感谢）</p>
<p>我跟新郎老庄认识十年了，老庄是个非常有毅力的人，我也是在他的影响下我开始跑步。老庄也是一个非常靠谱的人，跟他一起合作过几个公益项目，跟他一起合作，感觉特别放心，所以我觉得新娘你跟老庄在一起也一定会非常安心踏实的。我也见证了老庄和新娘的美好爱情，能深深感受新郎对新娘的爱…..(回顾）</p>
<p>最后，祝福老庄夫妻新婚快乐，百年好合，早生贵子，最好三年抱两。也祝福所有在场的朋友们幸福快乐。（愿景）</p>
<p>在婚礼上可以多赞美新郎或新娘的优点，如果你跟新郎和新娘都很熟悉，可以多说说跟他们之间的一些往事，甚至是调侃的玩笑都可以。 </p>
<p>例子二：在孩子的幼儿园毕业典礼上，校方邀请你发言。还是假设老庄参加了女儿的幼儿园毕业典礼。</p>
<p>我们也来演练一下这个场景：<br>首先，感谢菲诗国幼儿园邀请我们来参加孩子的毕业典礼，也特别感谢给我这个发言的机会。</p>
<p>想想时间过得真快，三年前，把女儿送过来这里读书的时候，她那时才三岁，转眼间三年就过去了，孩子也长大了。这三年里，我女儿在这里过得非常快乐，每次回家后，她都会跟我们一起分享在幼儿园快乐有趣的事。我也能感受到老师们对孩子深深的爱，有一次……(回顾，如果有具体的例子，举一两个会更好）</p>
<p>最后，希望深圳菲诗国幼儿园越办越好，希望老师们身体健康幸福快乐，希望我的女儿以及其他即将毕业的小朋友们能够健康快乐的成长。（祝愿）</p>
<p>以后参加孩子的小学毕业典礼、中学以及大学毕业典礼，都可以用同样的方法。 </p>
<p>例子三：参加大学毕业三十周年同学聚会，你突然被邀请上去发言。还是拿老庄为例吧，这时候他五十多岁了。</p>
<p>我们来演练一下这个场景：</p>
<p>首先，非常感谢大家给我这个发言的机会。也特别感谢班长老杨和其他几个老同学一起牵头组织了这次活动。（感谢）</p>
<p>虽然三十年过去了，大家也都到了知天命的岁数，但是和大家一起走在校园里，上大学时的情景仿佛就在昨天。想起了军训时我们一起正步走，一起扛枪打靶；想起了一起欢度的中秋节；想起了在篮球场上，我们班的男生们勇夺冠军；想起了在校运会上，我们班更是刮起了一阵阵夺冠旋风.尤其是有一次，让我印象特别深刻的是，我们一起去……(回顾，多举一些大家大学时共同经历的往事，越难忘越好）</p>
<p>最后，祝老师们身体健康，寿比南山，福如东海；祝同学们也身体健康，这样我们才能有更多的聚会机会，到了六十岁、七十岁、甚至八十岁，即使走不动了，推着轮椅我们也要继续相聚！（祝愿）</p>
<p>下次同学会，知道怎么发言了吧？ </p>
<p>什么？ 你说如果参加葬礼怎么发言？ 好吧，我们还是拿老庄开刷吧，假设你是老庄的老友，参加老庄的葬礼。</p>
<p>我们来演练一下：</p>
<p>首先，感谢主持人给我这个发言的机会，让我有机会来缅怀我们共同的朋友老庄。（感谢）</p>
<p>在中学就认识了老庄，到现在已经六十年了，从懵懂的少年，到白发苍苍的老头，老庄的容貌一直在改变，但是他的品质没有改变，始终是乐观开朗善良。记得……(回顾，举几件你和老庄之间的往事，如果这些往事能够说明他的品质就更好）</p>
<p>最后，衷心祝愿我的老友老庄能够在天之灵安息，也希望老庄的家人们能够节哀顺变！（希望祝福）</p>
<p>有朋友问，在葬礼上的发言一定要悲伤的吗？其实看情况，如果你跟逝者很熟悉，也可以讲一些逝者生前开心的事情，很暖心的事情，笑中带泪。</p>
<p>上面举了四个例子，是否学会了这个公式呢？下面，大家一起来练习一下吧：</p>
<ol>
<li><p>老友生日会上，邀请你发言；</p>
</li>
<li><p>你获得菲诗国超级演说家比赛第一名，获奖感言；</p>
</li>
<li><p>你当上了部门总监或者总裁，就职感言；</p>
</li>
<li><p>你的同事要离开公司了，大家一起为ta举行告别会，请你即兴发言；</p>
</li>
<li><p>参加孩子的家长会，老师邀请你发言；</p>
</li>
<li><p>你被评为公司先进代表，在领奖时，主持人请你即兴发言.</p>
</li>
</ol>
<p><strong>感谢–回顾–愿景</strong> 这个万能公式可以应用在几乎任何的聚会场合上，学会了吗？</p>
<h2 id="四-观-音-按-揭-法"><a href="#四-观-音-按-揭-法" class="headerlink" title="四. 观 音 按 揭 法"></a>四. 观 音 按 揭 法</h2><p><strong>针对各种聚会场合的即兴演讲技巧。</strong></p>
<p>前面我们介绍了应对问题或现象的即兴演讲魔法公式和应对任何聚会场合的即兴演讲万能公式。有小伙伴问，那如果遇到观点型的，我该怎么办？</p>
<p>这里就跟大家介绍应对观点型即兴演讲的万能公式：先阐述<strong>观点</strong>，接着分析<strong>原因</strong>，最好能举出具体<strong>案例</strong>，最后再强调<strong>结论</strong>。</p>
<p>简单概括： <strong>观点–原因–案例–结论</strong> 。</p>
<p>我给这个方法取了一个名字，叫做观音按揭法，可以想象一下观音按揭买房子。</p>
<p><strong>观</strong>，表示观点；</p>
<p><strong>音</strong>，是因的同音字，表示原因；</p>
<p><strong>按</strong>，是案的同音字，表示案例；</p>
<p><strong>揭</strong>，是结的谐音字，表示结论。</p>
<p>一遇到观点型的即兴演讲，就可以马上在脑海里想到观音菩萨，观音菩萨是救苦救难的，她会帮你的，所以什么也不用怕。</p>
<p>我们来举几个例子，让大家好熟悉这个观音按揭法。</p>
<p>例子一：观音该不该在深圳按揭买房？</p>
<p>我们一起来练习一下：</p>
<p>我认为观音姐姐应该在深圳按揭买房（观，观点）。</p>
<p>观音姐姐如果在深圳买房，她在人间就有了一个落脚点，有一个根据地，可以方便她随时来人间视察。深圳是中国最有活力的城市，甚至是世界上最有活力的城市，房价上涨空间大，以后即使不想再深圳住了，还可以把房子卖了，这样还可以赚很多钱，可以赚的钱拿去救助有需要的人，这也是符合观音姐姐乐意助人的性格。而且按揭买房，不用一下子拿出很多钱，只要付首付就行了（音， 分析原因）</p>
<p>你看如来十年前在深圳华侨城买的那套别墅，当时买的才500万，去年涨到5000万，后来他卖掉了，把赚到的钱拿出一部分再去投资，剩下的钱在贵州捐建了10所如来希望小学，帮助了很多孩子（按，举出案例）。</p>
<p>所以，我认为观音应该在深圳按揭买房（揭，结论）。</p>
<p>有些感觉了吧。为什么要有案例呢？有了案例，特别是自己或者身边朋友的例子，就更有说服性。我们再来举几个现实中的例子。</p>
<p>例子二： 学习演讲很重要。</p>
<p>我们来演练一下：</p>
<p>我认为学习演讲很重要。（观）</p>
<p>演讲能够让有一个人更加自信，演讲可以让人逻辑更加清晰、表达更加清楚，演讲也会让人沟通更加有效，促进在职场中更快升职加薪。（音）</p>
<p>你看老庄那个小子，以前说话都脸红，还经常结结巴巴的，自从学习了演讲之后，现在说话不脸红了，还非常的流畅，居然还去参加了演讲比赛还获了奖，而且这两年在工作中每年都加薪两次，比别人多一次。（按）</p>
<p>所以，我认为学习演讲非常重要。（揭）</p>
<p>如果把上面的题目改一下，“老公，我要去学习演讲。”  你也是可以用上面的方法，稍微转变下:”老公，我要去学习演讲。演讲很重要，因为…….”。 同样的，“老公，我要去跑步”， 如果你用观音按揭法说一下，相信你老公会非常支持你去跑步，说不定还会跟你一起跑。 孩子想要父母给他们买东西或者做什么事，如果用这个方法，也会更容易得到父母的支持。</p>
<p>女人最喜欢问男人什么问题呢？ 想想也知道了，就是“你爱我吗？” “你爱不爱我？“男人一般怎么回答呢？ 当然想想也是知道的，“我爱你”，“我当然爱你了”。 这样的回答很简洁，但是往往会被认为是在敷衍。如果应用观音按揭法，相信会有不一样的结果。我们来演练一下。</p>
<p>例子三：</p>
<p>老婆： 你爱我吗？</p>
<p>老公： 老婆，我爱你（观）。和你在一起，我就觉得特别幸福（音）。每当我拖着疲惫的身体回到家，闻到你做的香喷喷的菜时，我的疲劳顿时都没有了。每当我遇到困难时，你总会在一旁给我鼓励。和你一起出去旅游，让我很放松。和你去的每一个地方，我都记得。尤其是那次，我们去一个小岛上，晚上两个人躺在海边的岩石上看月光….(按）所以，老婆，我爱你，我会爱你一生一世。（揭）</p>
<p>上面的回答和简单的回答“我爱你”，哪个会更好呢？ 以后男性朋友再遇到同样的问题，就不要简单的问题“我爱你”，要具体一点，相信对方会更满意，也会更爱你。</p>
<p>这个方法，有个变体，可以把观点变成<strong>建议</strong>。这样在职场上应用就更广泛了。你给老板的建议，如果用这个方法，会更有说服力。</p>
<p>我们来练习一下：</p>
<p>例子四：</p>
<p>老板，我建议我们采用xxxxx方法。（观）</p>
<p>我这样建议的理由是：第一点，xxxx；第二点，xxxx；第三点，xxxx。（音）</p>
<p>著名的L公司以前也用了这个方法，后来他们的效率提高了30%，销售额增加了20%；还有H公司两年前也使用了这种方法，销售额也增加了。（按）</p>
<p>所以，老板我建议我们可以采用xxxxx这个方案。（揭）</p>
<p>以后给老板提建议，可以试试这个方法。</p>
<p>说了这么多，大家也来练习一下吧：</p>
<ol>
<li><p>会玩很重要；</p>
</li>
<li><p>吃苹果好；</p>
</li>
<li><p>老公，我要去跑步；</p>
</li>
<li><p>老师，暑假不能布置作业；</p>
</li>
<li><p>狗是人类的好朋友。</p>
</li>
</ol>
<p>记住了，遇到观点型的即兴演讲，观音菩萨就会来帮你，不用怕哦。</p>
<h2 id="五-黄-金-三-点-法"><a href="#五-黄-金-三-点-法" class="headerlink" title="五. 黄 金 三 点 法"></a>五. 黄 金 三 点 法</h2><p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046505322138.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p>前面几篇文章都是在介绍如何更好的做即兴演讲，我们知道：</p>
<p>应对问题和现象的即兴演讲，我们可以用“问题–原因–解决方案”；</p>
<p>应对观点和建议的即兴演讲，我们可以用观音按揭法“观点–原因–案例–总结”；</p>
<p>应对各种聚会场合的即兴演讲，我们可以用“感谢–回顾–愿景”；</p>
<p>如果遇到的不是上面几种情况，或者说遇到了上面的情况，但是你不会用上面的方法，还可以怎么办呢？</p>
<p>别怕，最后再教大家一个即兴演讲的终极大招： 黄金三点法 。</p>
<p>黄金三点法，这<strong>是一种比较简便的语言组织方法，可以使你在说明情况或表明态度的时候，思路更加清晰。它借助数词或序数词区分讲话的内容，即在讲话中围绕自己要表达的中心意思，运用“1，2，3“数词或，”第一、第二、第三”，“首先、其次、然后”等序数词来表达，这样讲话，让听众听起来感觉既条理清晰，又简洁明了</strong>。那又为什么是三点而不是四点五点六点呢？说多了呢，别人记不住嘛；说少了呢，又显得没水平啦。</p>
<p>要是万一真的说不到三点呢？那也没关系，把<strong>前面的第一点和第二点结合一起就可以是第三点了，而且往往有意想不到的效果</strong>（笑果）。比如，有人问你，如何学好演讲？你可以说：第一点，坚持，坚持不懈的练习。第二点，不要脸，只要有上台演讲的机会就不要错过，厚着脸皮上台，管他讲得好不好，先讲了再说。第三点….怎么也想不出来，那就把前面两点结合在一起吧，学好演讲的</p>
<p>第三点，坚持不要脸。</p>
<p>如果你细心观察，就会发现，中国的官场最喜欢且最擅长用“黄金三点法”，最著名的就是“三个代表”。某某会场上，邀请领导讲话，领导通常会说“下面，我主要讲三点….”,”我补充三点….”, “我对大家有三个期望….”</p>
<p>“黄金三点法”在什么场合应用比较多呢？在工作生活和社交中，让你说感受，谈分享或者发表见解的时候就可以经常用到。</p>
<p>例子一：  比如你去参加一个讲座，一个课程，一次活动等等，很可能会被问到，“你对这次活动的感受如何？” 估计你会回答“很好很不错啊“。如果你这样回答也没错，因为大部分人也是这么回答的，当然你的回答也会跟大部分人一样很快被人遗忘。就拿参加菲诗国演讲来练习吧，主持人问你，“参加完菲诗国演讲你的感受如何？”</p>
<p>第一种回答“很好很不错啊”，然后就没有然后了。</p>
<p>第二种应用“黄金三点法”的回答：</p>
<p>我觉得菲诗国演讲很不错，参加完我有三点收获：第一，我变自信了，现在我在台上也不怕了，而且敢于看台下的任何一个人，还对着刚才那个帅哥抛了一个媚眼；第二，我的演讲更有技巧了，不仅内容更有逻辑，舞台的呈现也更加多彩，学会了用手势、眼神、表情、舞台移动和声音的抑扬顿挫；第三，我还结交到了一帮志同道合且都积极向上的朋友。</p>
<p>上面的两种回答，哪一种回答更让人印象深刻呢？<strong>用“黄金三点法”来分享，别人会觉得你讲话很有逻辑。</strong></p>
<p>例子二：  你去参加各种活动，很可能要被叫去做自我介绍。这时候你也可以应用“黄金三点论”来介绍自己。</p>
<p>大部分人的第一种介绍可能是像这样的：“大家好，我是老庄，我喜欢跑步，健身和演讲，很高兴认识大家。”这样的介绍也没问题，只是不容易让人记住。</p>
<p>利用“黄金三点法”的自我介绍：大家好，我是老庄，老子的老，庄子的庄。我有三个标签：第一个标签“跑步”， 我从小就喜欢跑步，到现在已经能够跑了二十多年了，从2007年开始跑马拉松，到现在也将近跑了十年的马拉松；第二个标签“健身”，我很喜欢健身，也差不多健身二十多年了，小学的时候我就又六块腹肌，现在还坚持健身；第三个标签“演讲”，我很喜欢演讲，我不仅喜欢演讲，现在还辅导别人更好的做演讲。很高兴在这里认识大家，希望能和大家成为好朋友。</p>
<p>两种自我介绍，哪一种更容易让人记住呢？用三个标签或者三个爱好或者三个特点来介绍自己，让别人更容易记住你。</p>
<p>例子三： 在街头上被记者问到，你对某某现象有何看法？  这时候“黄金三点论”也很好用。</p>
<p>比如， CNN记者用中文问你，“你对papi酱等网红有何看法？”</p>
<p>不用多想，可以直接用“黄金三点法”张口就说： </p>
<p>我对此有三点看法：</p>
<p>首先，我很喜欢papi酱，特别喜欢她吐槽各种社会现象，可逗可好玩了； </p>
<p>其次，网红的出现，说明互联网的力量和影响力越来越强大； </p>
<p>最后，网红的出现，给了个体更多展现自我的机会，当然也是成名的机会，以往只有少部分掌握资源或者有关系的人才能出名，现在普通人也可以有利用互联网成名的机会，好得很。</p>
<p><strong>“黄金三点法”在各种聚会场合也是很好用的</strong>，前面我们介绍了聚会场合的万能公式“感谢–回顾–愿景”，你要是一时想不起来，就可以用“黄金三点论”。比如，你去参加朋友的婚礼，被主持人邀请上去讲话：</p>
<p>在这里，我送上三个祝福：第一个祝福，祝福新郎新娘新婚快乐，百年好合，能够相濡以沫，执子之手，与子偕老；第二个祝福，祝福新郎新娘早生贵子，现在政策也放开了，赶紧生一对好儿女；第三个祝福，祝福在场的所有朋友们，都能够幸福快乐！</p>
<p>刚才用到了三个“祝福”，这也是一种提炼法，比简单说“三点”更有功力。常用的三点提炼法还有“三个务必”“三个坚持”“三个准备”“三个执行”“三个代表”等等。</p>
<p>比三点提炼法更需要功力的是<strong>形象提炼法，用比喻的方法来说明自己的观点</strong>。拿上面的例子一来练习，主持人问你，“参加完菲诗国演讲你的感受如何？”</p>
<p>你可以说“参加菲诗国演讲后，我遇到了张学友：张，我变得张口就敢讲话了；学，我学到了很有演讲的技巧；友，我认识了一帮积极上进的好朋友。“</p>
<p>这里的“张学友”就是一种形象提炼法，同样是说三点，但是这种方法相比会更加让人印象深刻。</p>
<p>黄金三点法，常用的套路有：</p>
<p>.  我有三点收获；</p>
<ol start="2">
<li><p>我想发表三个看法；</p>
</li>
<li><p>我给大家讲三个故事；</p>
</li>
<li><p>我就三方面来谈一下自己的心得；</p>
</li>
<li><p>我们的任务是分三步走；</p>
</li>
<li><p>我们目前有三个急需要解决的问题；</p>
</li>
<li><p>我想从三方面进行阐述；</p>
</li>
<li><p>我想给你三个建议</p>
</li>
</ol>
<h2 id="六-总-结"><a href="#六-总-结" class="headerlink" title="六. 总 结"></a>六. 总 结</h2><p>最后总结一下：</p>
<p><strong>一, 散点联想法</strong>可以用来锻炼语言的组织能力和联想能力及想象能力；</p>
<p><strong>二，“问题–原因–解决方案”</strong>可以用来应对问题和现象的即兴演讲；</p>
<p><strong>三，观音按揭法“观点–原因–案例–总结”</strong>可以用来应对观点和建议的即兴演讲；</p>
<p><strong>四， “感谢–回顾–愿景”</strong>可以在各种聚会场合的即兴演讲中使用；</p>
<p><strong>五，黄金三点法</strong>可以用在说感受，谈分享或者发表见解的时候使用以及上面的方法忘记的时候用。</p>
<p>怎么样，是不是不再那么害怕即兴演讲了？</p>
]]></content>
      <categories>
        <category>演讲</category>
      </categories>
      <tags>
        <tag>演讲</tag>
        <tag>提升自我</tag>
      </tags>
  </entry>
  <entry>
    <title>为什么说90后已经不想结婚了</title>
    <url>/2018/03/27/why_90_not_marry/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046785303203.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br>2018年，第一批90后正式跨入28岁。</p>
<p>90后出道早，10年前江湖就有他们风光无限的身影。但按照教育时间表，大多数90后，一年不耽误地读完硕士，现在也不过是刚刚走向社会，参加工作第三年，具有自主意识和自由选择的人生刚刚开始。</p>
<a id="more"></a>
<p>前天一个大叔忧心忡忡地对我说，听说现在90后都不想结婚了，不结婚、不生孩子，国家人口老龄化越来越严重，你们媒体人是不是应该呼吁一下？</p>
<p>我理解他爱国心切，但不同意他对90后的理解与绑架。</p>
<p>首先，国家可以通过放开单身生育解决问题；其次，90后现在不想结婚，不意味着他们会一辈子选择单身。</p>
<p>结婚生孩子应该是一个人心智成熟之后的主动选择，而不是被各种压力与责任绑架的结果。我在结婚前5年，信誓旦旦地觉得自己会丁克，到了30岁，忽然产生了强烈的生育渴望，后来还一鼓作气生了二胎，没有纠结没有抱怨，毕竟是自己想清楚的事。</p>
<p>小到衣服，大到婚姻，你不想要，只说明它暂时不适合你。</p>
<p>90后根本还没到应该结婚的年龄，凭什么要想结婚呢？</p>
<p>2013年的一项调查显示，法国人首婚平均年龄为男性32.3岁，女性30.5岁。比30年前，晚了7年多。同年，日本女性的平均首婚年龄为30.3岁，到了2017年，日本女性的平均首婚年龄已经提高到33岁。</p>
<p>对于90后来说，晚婚是必然。</p>
<p>长辈认为应该结婚的年龄，他们很多人刚从学校毕业，或者还在继续深造。中国家长的认真负责和中国教育的以学为本，造成了90后在生活方面的普遍晚熟。</p>
<p>二十六七岁的他们，还不知道生活是什么，也不知道自己将来会做什么，在哪里居住。</p>
<p>各种不确定性，使90后，尤其大城市的90后，根本没办法考虑结婚问题。</p>
<p>随着医疗技术的发展，女性生育年龄红杠已经从35岁抬高到了40岁。这对于女性无疑是个喜讯。她们终于可以先实现梦想再结婚，而不必匆匆忙忙把自己嫁了。</p>
<p>与80后相比，90后更加现实，为自己负责的意念更强。10年前，80后轻意相信了老妈逼婚时说的，你生了孩子我帮你带，你该怎么过还是怎么过，一点儿也不耽误，现在的90后对此就十分冷静了。</p>
<p>我家邻居的孩子92年出生，在上海工作。去年春节带男朋友回来见家长。他父母以为这是要结婚的节奏，她却说：“见家长不意味着结婚。我希望你们见过我历任男朋友，这是信任。”</p>
<p>父母让她赶紧结婚生孩子，生了孩子放在武汉，她直接怼回去：“如果我自己生，就一定要自己带。不然我哪是生孩子啊，是给你们生了个玩具。”</p>
<p>她妈跟我抱怨，怕她以后嫁不出去，也生不出孩子，可她今年还没满26岁，离她父母担心的那种状态，至少还有10年。</p>
<p>10年，对于学生，只是小学到初中，但对于成年人，可能意味着翻天覆地的变化。足够李安从一文不名，到拿奥斯卡；腾讯从刚刚注册公司的小不点，成长为美国《财富》杂志评选出的“全球最受尊敬50家公司”。</p>
<p>美国长大的华人姑娘陈愉写过一本有争议的书：《30岁前别结婚》。陈愉31岁当选为洛衫矶市市长，37岁结婚，如今是两个孩子的母亲。</p>
<p>以在国外成长的华人眼光来看，她觉得中国女性活得太紧凑了。22岁甚至25岁之前，受父母、老师的管束。刚出校门没两年，就开始忙着结婚生孩子，受丈夫、孩子、传统观念的管束。</p>
<p>“她们还没弄懂自己，怎么可能找到懂自己的男人，进而去懂自己的孩子？”</p>
<p>尽管有人觉得，“30岁以前不结婚”与“30岁以前一定要结婚”同样是一种年龄绑架，但我们必须承认，人的成长需要时间。</p>
<p>如果除开父母的帮助，有多少年轻人可以在30岁以前积累到足够的心智与经济实力，去应付婚姻生活？</p>
<p>而一定要父母帮助才能维持的婚姻，70后和80后已经暴露出太多问题，包括已婚人士的超低幸福感、居高不下的离婚率和出轨率，以及婆媳矛盾这种具有中国特色的社会癌。</p>
<p>中国传统文化中，人的生存意义似乎只有两个：成家、业立。如果你不能立业，就早点结婚生孩子。既不成家，又不业立，是废材。</p>
<p>但90后不这么认为。</p>
<p>我们团队的90后被父母逼婚的时候，父亲直接撂下狠话：“你不结婚也成不了董明珠”。</p>
<p>她不解地对我说：“我干嘛非成董明珠啊。我只想多过几年自由自在的生活，多谈几场恋爱，有问题吗？”</p>
<p>当然没问题。成功跟功成名就本来就是两个概念。与功成名就相比，成功简单和重要得多，它是一个人按照个人意愿，活成自己。</p>
<p>“把时间浪费在博得别人爱戴上，你会成为世界上最受人爱戴的死人。”美剧《权利的游戏》的这句台词，在90后中深入人心。</p>
<p>一个研究中国文化的法国朋友问我，你们中国父母为什么在子女结婚生孩子方面，紧迫感那么强，是不是他们活得太无聊了？</p>
<p>我不愿意这样想。90后的父母，也不过是离我们并不遥远的60后，70后，别忘了，60后的马东现在是90后的意见领袖。</p>
<p>传统中国人，大约心里都有一种对于“圆满”的执念。为人父母后，也希望自己的子女，人生是圆满的。上大学、工作、结婚、生孩子，一样都不少。</p>
<p>可惜，他们的孩子，眼里圆满却是，你不一定什么都要经历，但你所经历的，一定是你自愿选择的。</p>
<p>正如马东所说：“生活的乐趣就是尽力而为。”</p>
]]></content>
      <categories>
        <category>随笔</category>
      </categories>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>Java使用mpxj导入.mpp格式的Project文件（甘特图）</title>
    <url>/2018/01/18/java-read-mpp-file/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046772877237.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<blockquote>
<p>最近换工作了，主要的项目都是企业内部为支撑的管理平台，刚入入职没多久，遇到了一个需求，就是导入微软的Project文件，踩过不少坑，所以记录一下，后续还有从数据库导出Project引导文件，也就是xml文件</p>
</blockquote>
<a id="more"></a>

<p><img    class="lazyload" data-original="http://img.blog.csdn.net/20180117180051197?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2ludGVyX2NoZW4wMDE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">&lt;!-- 读取project文件 --&gt;<br>&lt;dependency&gt;<br>	&lt;groupId&gt;net.sf.mpxj&lt;&#x2F;groupId&gt;<br>	&lt;artifactId&gt;mpxj&lt;&#x2F;artifactId&gt;<br>	&lt;version&gt;7.1.0&lt;&#x2F;version&gt;<br>&lt;&#x2F;dependency&gt;<br></code></pre></td></tr></table></figure>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p> 博主使用的读取方式是递归读取的，无论Project文件中的任务有多少层，都可以读到，好了，直接看代码，注意看注释：</p>
<h3 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Transactional</span><br>   <span class="hljs-meta">@Override</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readMmpFileToDB</span><span class="hljs-params">(File file)</span> </span>&#123;<span class="hljs-comment">//如果读取的是MultipartFile，那么直接使用获取InputStream即可</span><br>       <span class="hljs-keyword">try</span>&#123;<br>       	<span class="hljs-comment">//这个是读取文件的组件</span><br>           MPPReader mppRead = <span class="hljs-keyword">new</span> MPPReader();<br>           <span class="hljs-comment">//注意，如果在这一步出现了读取异常，肯定是版本不兼容，换个版本试试</span><br>           ProjectFile pf = mppRead.read(file);<br>           <span class="hljs-comment">//从文件中获取的任务对象</span><br>           List&lt;Task&gt; tasks = pf.getChildTasks();<br>           <span class="hljs-comment">//这个可以不用，这个list只是我用来装下所有的数据，如果不需要可以不使用</span><br>           List&lt;Project&gt; proList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();<br>           <span class="hljs-comment">//这个是用来封装任务的对象，为了便于区别，初始化批次号，然后所有读取的数据都需要加上批次号</span><br>           Project pro = <span class="hljs-keyword">new</span> Project();<br>           pro.setBatchNum(StringUtils.UUID());<span class="hljs-comment">//生成批次号UUID</span><br>           <span class="hljs-comment">//这个方法是一个递归方法</span><br>           getChildrenTask(tasks.get(<span class="hljs-number">0</span>), pro ,proList, <span class="hljs-number">0</span>);<br>       &#125;<span class="hljs-keyword">catch</span> (MPXJException e) &#123;<br>           logger.error(e.getMessage());<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException();<br>       &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>           logger.error(e.getMessage());<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException();<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"> <span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 这个方法是一个递归</span><br><span class="hljs-comment"> * 方法的原理：进行读取父任务，如果下一层任务还是父任务，那么继续调用当前方法，如果到了最后一层，调用另外一个读取底层的方法</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> task</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> project</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> list</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> levelNum</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getChildrenTask</span><span class="hljs-params">(Task task, Project project, List&lt;Project&gt; list, <span class="hljs-keyword">int</span> levelNum)</span></span>&#123;<br>        <span class="hljs-keyword">if</span>(task.getResourceAssignments().size() == <span class="hljs-number">0</span>)&#123;<span class="hljs-comment">//这个判断是进行是否是最后一层任务的判断==0说明是父任务</span><br>            levelNum ++;<span class="hljs-comment">//层级号需要增加，这个只是博主用来记录该层的层级数</span><br>            List&lt;Task&gt; tasks = task.getChildTasks();<span class="hljs-comment">//继续获取子任务</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; tasks.size(); i++) &#123;<span class="hljs-comment">//该循环是遍历所有的子任务</span><br>                <span class="hljs-keyword">if</span>(tasks.get(i).getResourceAssignments().size() == <span class="hljs-number">0</span>)&#123;<span class="hljs-comment">//说明还是在父任务层</span><br>                    Project pro = <span class="hljs-keyword">new</span> Project();<br>                    <span class="hljs-keyword">if</span> (project.getProjId() != <span class="hljs-keyword">null</span>)&#123;<span class="hljs-comment">//说明不是第一次读取了，因为如果是第一层，那么还没有进行数据库的添加，没有返回主键Id</span><br>                        pro.setParentId(project.getProjId());<span class="hljs-comment">//将上一级目录的Id赋值给下一级的ParentId</span><br>                    &#125;<br>                    pro.setBatchNum(project.getBatchNum());<span class="hljs-comment">//批量号</span><br>                    pro.setImportTime(<span class="hljs-keyword">new</span> Date());<span class="hljs-comment">//导入时间</span><br>                    pro.setLevel(levelNum);<span class="hljs-comment">//层级</span><br>                    pro.setTaskName(tasks.get(i).getName());<span class="hljs-comment">//这个是获取文件中的“任务名称”列的数据</span><br>                    pro.setDurationDate(tasks.get(i).getDuration().toString());<span class="hljs-comment">//获取的是文件中的“工期”</span><br>                    pro.setStartDate(tasks.get(i).getStart());<span class="hljs-comment">//获取文件中的 “开始时间”</span><br>                    pro.setEndDate(tasks.get(i).getFinish());<span class="hljs-comment">//获取文件中的 “完成时间”</span><br>                    pro.setResource(tasks.get(i).getResourceGroup());<span class="hljs-comment">//获取文件中的 “资源名称”</span><br>                    <span class="hljs-keyword">this</span>.addProjectInfo(pro);<span class="hljs-comment">//将该条数据添加到数据库，并且会返回主键Id，用做子任务的ParentId,这个需要在mybatis的Mapper中设置</span><br>                    getChildrenTask(tasks.get(i), pro,list,levelNum);<span class="hljs-comment">//继续进行递归，当前保存的只是父任务的信息</span><br>                &#125;<span class="hljs-keyword">else</span>&#123;<span class="hljs-comment">//继续进行递归</span><br>                    getChildrenTask(tasks.get(i), project, list, levelNum);<br>                &#125;<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<span class="hljs-comment">//说明已经到了最底层的子任务了，那么就调用进行最底层数据读取的方法</span><br>            <span class="hljs-keyword">if</span> (project.getProjId() != <span class="hljs-keyword">null</span>)&#123;<br>                getResourceAssignment(task, project, list, levelNum);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getResourceAssignment</span><span class="hljs-params">(Task task, Project project, List&lt;Project&gt; proList, <span class="hljs-keyword">int</span> levelNum)</span></span>&#123;<br>    List&lt;ResourceAssignment&gt; list = task.getResourceAssignments();<span class="hljs-comment">//读取最底层的属性</span><br>    ResourceAssignment rs = list.get(<span class="hljs-number">0</span>);<br>    Project pro = <span class="hljs-keyword">new</span> Project();<br>    pro.setTaskName(task.getName());<br>    pro.setParentId(project.getProjId());<br>    pro.setLevel(levelNum);<br>    pro.setImportTime(<span class="hljs-keyword">new</span> Date());<br>    pro.setBatchNum(project.getBatchNum());<br>    pro.setDurationDate(task.getDuration().toString());<br>    pro.setStartDate(rs.getStart());<span class="hljs-comment">//注意，这个从ResourceAssignment中读取</span><br>    pro.setEndDate(rs.getFinish());<span class="hljs-comment">//同上</span><br>    String resource = <span class="hljs-string">""</span>;<br>    <span class="hljs-keyword">if</span>(list.size() &gt; <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; list.size(); i++) &#123;<br>            <span class="hljs-keyword">if</span> (list.get(i).getResource() != <span class="hljs-keyword">null</span>)&#123;<br>                <span class="hljs-keyword">if</span>(i &lt; list.size() - <span class="hljs-number">1</span>)&#123;<br>                    resource += list.get(i).getResource().getName() + <span class="hljs-string">","</span>;<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    resource += list.get(i).getResource().getName();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br><br>        <span class="hljs-keyword">if</span>(list.size() &gt; <span class="hljs-number">0</span> &amp;&amp; list.get(<span class="hljs-number">0</span>).getResource() != <span class="hljs-keyword">null</span>)&#123;<br>            resource = list.get(<span class="hljs-number">0</span>).getResource().getName();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(resource))&#123;<br>        pro.setResource(resource);<br>    &#125;<br>    <span class="hljs-keyword">this</span>.addProjectInfo(pro);<span class="hljs-comment">//将数据保存在数据库中,同样会返回主键</span><br>    proList.add(pro);<br><br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="封装对象"><a href="#封装对象" class="headerlink" title="封装对象"></a>封装对象</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">package</span> com.winter.model;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Project文件封装类</span><br><span class="hljs-comment"> * Created By Donghua.Chen on  2018/1/9</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Project</span> </span>&#123;<br>    <span class="hljs-comment">/* 自增主键Id */</span><br>    <span class="hljs-keyword">private</span> Integer projId;<br>    <span class="hljs-comment">/* 上级Id */</span><br>    <span class="hljs-keyword">private</span> Integer parentId;<br>    <span class="hljs-comment">/* 结构层级 */</span><br>    <span class="hljs-keyword">private</span> Integer level;<br>    <span class="hljs-comment">/* 任务名称 */</span><br>    <span class="hljs-keyword">private</span> String taskName;<br>    <span class="hljs-comment">/* 工期 */</span><br>    <span class="hljs-keyword">private</span> String durationDate;<br>    <span class="hljs-comment">/* 开始时间 */</span><br>    <span class="hljs-keyword">private</span> Date startDate;<br>    <span class="hljs-comment">/* 结束时间 */</span><br>    <span class="hljs-keyword">private</span> Date endDate;<br>    <span class="hljs-comment">/* 前置任务ID */</span><br>    <span class="hljs-keyword">private</span> Integer preTask;<br>    <span class="hljs-comment">/* 资源名称 */</span><br>    <span class="hljs-keyword">private</span> String resource;<br>    <span class="hljs-comment">/* 导入时间 */</span><br>    <span class="hljs-keyword">private</span> Date importTime;<br>    <span class="hljs-comment">/* 批次号 */</span><br>    <span class="hljs-keyword">private</span> String batchNum;<br><br>    <span class="hljs-comment">//省略get、set方法</span><br></code></pre></td></tr></table></figure>

<h3 id="Mybatis-接口方法"><a href="#Mybatis-接口方法" class="headerlink" title="Mybatis 接口方法"></a>Mybatis 接口方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 插入project数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> project</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addProjectSelective</span><span class="hljs-params">(Project project)</span></span>;<br></code></pre></td></tr></table></figure>

<h3 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"TABLE_PROJECT"</span>&gt;</span><br>  PROJECT<br><span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 插入数据之后返回主键 需要这两个配置： useGeneratedKeys="true" keyProperty="projId" --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"addProjectSelective"</span> <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"projId"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.winter.model.Project"</span>&gt;</span><br>    INSERT INTO<br>    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"TABLE_PROJECT"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"parentId != null"</span>&gt;</span><br>            parentId,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"level != null"</span>&gt;</span><br>            level,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"taskName != null"</span>&gt;</span><br>            taskName,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"durationDate != null"</span>&gt;</span><br>            durationDate,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"startDate != null"</span>&gt;</span><br>            startDate,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"endDate != null"</span>&gt;</span><br>            endDate,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"preTask != null"</span>&gt;</span><br>            preTask,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"resource != null"</span>&gt;</span><br>            resource,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"importTime != null"</span>&gt;</span><br>            importTime,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"importTime != null"</span>&gt;</span><br>            batchNum,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"values ("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"parentId != null"</span>&gt;</span><br>            #&#123;parentId, jdbcType=INTEGER&#125;,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"level != null"</span>&gt;</span><br>            #&#123;level, jdbcType=INTEGER&#125;,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"taskName != null"</span>&gt;</span><br>            #&#123;taskName, jdbcType=VARCHAR&#125;,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"durationDate != null"</span>&gt;</span><br>            #&#123;durationDate, jdbcType=VARCHAR&#125;,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"startDate != null"</span>&gt;</span><br>            #&#123;startDate, jdbcType=DATE&#125;,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"endDate != null"</span>&gt;</span><br>            #&#123;endDate, jdbcType=DATE&#125;,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"preTask != null"</span>&gt;</span><br>            #&#123;preTask, jdbcType=INTEGER&#125;,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"resource != null"</span>&gt;</span><br>            #&#123;resource, jdbcType=VARCHAR&#125;,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"importTime != null"</span>&gt;</span><br>            #&#123;importTime, jdbcType=DATE&#125;,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"batchNum != null"</span>&gt;</span><br>            #&#123;batchNum, jdbcType=VARCHAR&#125;,<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img    class="lazyload" data-original="http://img.blog.csdn.net/20180117180307631?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2ludGVyX2NoZW4wMDE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><p>当然，还有很多自定义的字段读取，如果有需要可以联系我，或者看官方文档<br>email：<a href="mailto:1085143002@qq.com">1085143002@qq.com</a></p>
<h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><ul>
<li>mpxj官方API文档：<a href="http://www.mpxj.org/apidocs/index.html" target="_blank" rel="noopener">http://www.mpxj.org/apidocs/index.html</a></li>
<li>项目源码：<a href="https://github.com/WinterChenS/springboot-mybatis-demo" target="_blank" rel="noopener">https://github.com/WinterChenS/springboot-mybatis-demo</a></li>
<li>导入模板在源码的file文件夹中，sql在sql文件夹中</li>
</ul>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Hibernate 自定义查询sql 并使用自定义对象接收查询结果</title>
    <url>/2018/01/18/hibernate-sql/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046767443548.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<blockquote>
<p>在很多的生产中，hibernate并不能满足我们所有的开发需求，比如，很多表的联合查询，并且查询之后的各种结果封装在自定义的dto对象中，那么我们就需要使用自定义的sql进行查询了，好了，开始我们新的旅程吧。</p>
</blockquote>
<a id="more"></a>
<h3 id="需求："><a href="#需求：" class="headerlink" title="需求："></a>需求：</h3><ul>
<li>n张表进行联合查询</li>
<li>将结果封装在一个DTO的对象中</li>
</ul>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><p><strong>本文中使用了一个很复杂的联合查询的sql，所以大家并不需要了解详细，只需要只是我们进行一个很复杂的多张表进行联合查询的操作，最后将结果使用自定义的dto对象接收即可</strong></p>
<h4 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h4><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span><br>	p9.projectId,<br>	p9.fenxiaoMoney,<br>	p9.shopCount<br><span class="hljs-keyword">FROM</span><br>	(<br>		<span class="hljs-keyword">SELECT</span><br>			p8.projectId,<br>			p8.fenxiaoMoney,<br>			<span class="hljs-keyword">count</span>(ic.inviteByPerson) shopCount<br>		<span class="hljs-keyword">FROM</span><br>		(<br>			<span class="hljs-keyword">SELECT</span><br>				p7.projectId,<br>				p7.fenxiaoMoney<br>			<span class="hljs-keyword">FROM</span><br>				(<br>					<span class="hljs-keyword">SELECT</span><br>						pp.projectId,<br>						g.fenxiaoMoney<br>					<span class="hljs-keyword">FROM</span><br>						(<br>							<span class="hljs-keyword">SELECT</span><br>								p6.projectId<br>							<span class="hljs-keyword">FROM</span><br>								(<br>									<span class="hljs-keyword">SELECT</span><br>										p5.projectId<br>									<span class="hljs-keyword">FROM</span><br>										(<br>											<span class="hljs-keyword">SELECT</span><br>												p4.projectId<br>											<span class="hljs-keyword">FROM</span><br>												(<br>													<span class="hljs-keyword">SELECT</span><br>														p2.projectId<br>													<span class="hljs-keyword">FROM</span><br>														(<br>															<span class="hljs-keyword">SELECT</span><br>																p1.projectId<br>															<span class="hljs-keyword">FROM</span><br>																(<br>																	<span class="hljs-keyword">SELECT</span><br>																		p.projectId<br>																	<span class="hljs-keyword">FROM</span><br>																		t_projects p<br>																	<span class="hljs-keyword">WHERE</span><br>																		<span class="hljs-number">1</span> = <span class="hljs-number">1</span><br>																	<span class="hljs-keyword">AND</span> p.averagePrice &gt;= <span class="hljs-number">1.0</span><br>																	<span class="hljs-keyword">AND</span> p.averagePrice &lt;= <span class="hljs-number">10000000000.0</span><br>																	<span class="hljs-keyword">AND</span> p.saleLongitude &gt;= <span class="hljs-number">1.0</span><br>																	<span class="hljs-keyword">AND</span> p.saleLongitude &lt;= <span class="hljs-number">10000.00</span><br>																	<span class="hljs-keyword">AND</span> p.saleLatitude &gt;= <span class="hljs-number">1.0</span><br>																	<span class="hljs-keyword">AND</span> p.saleLatitude &lt;= <span class="hljs-number">10000.0</span><br>																	<span class="hljs-keyword">AND</span> p.rightsYears = <span class="hljs-number">70</span><br>																	<span class="hljs-keyword">AND</span> p.city <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%330000%'</span> <span class="hljs-comment">#AND p.isOpenStatus = 1</span><br>																	<span class="hljs-keyword">AND</span> p.buildArea &gt;= <span class="hljs-number">1.0</span><br>																	<span class="hljs-keyword">AND</span> p.buildArea &lt;= <span class="hljs-number">10000000.0</span> <span class="hljs-comment">#AND p.afforestationRatio = 1</span><br>																	<span class="hljs-keyword">AND</span> p.projectName <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%%'</span> <span class="hljs-comment">#AND p.projectId = '1515269bc87448b4927fa676c624c8f6'</span><br>																) p1<br>															<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> (<br>																<span class="hljs-keyword">SELECT</span><br>																	targetId<br>																<span class="hljs-keyword">FROM</span><br>																	t_tagsrelation<br>																<span class="hljs-keyword">WHERE</span><br>																	<span class="hljs-number">1</span> = <span class="hljs-number">1</span><br>																<span class="hljs-keyword">AND</span> originalTags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%4507%'</span><br>																<span class="hljs-keyword">AND</span> originalTags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%757%'</span><br>															) t1 <span class="hljs-keyword">ON</span> p1.projectId = t1.targetId<br>														) p2<br>													<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> (<br>														<span class="hljs-keyword">SELECT</span><br>															h.projectId<br>														<span class="hljs-keyword">FROM</span><br>															t_projecthouses h<br>														<span class="hljs-keyword">WHERE</span><br>															h.houseNum <span class="hljs-keyword">IN</span> (<br>																<span class="hljs-keyword">SELECT</span><br>																	targetId<br>																<span class="hljs-keyword">FROM</span><br>																	t_tagsrelation<br>																<span class="hljs-keyword">WHERE</span><br>																	<span class="hljs-number">1</span> = <span class="hljs-number">1</span><br>																<span class="hljs-keyword">AND</span> originalTags <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%%'</span><br>															)<br>														<span class="hljs-keyword">AND</span> h.houseStatus = <span class="hljs-number">1</span><br>														<span class="hljs-keyword">AND</span> isOpen = <span class="hljs-number">1</span><br>													) p3 <span class="hljs-keyword">ON</span> p2.projectId = p3.projectId<br>												) p4<br>											<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> (<br>												<span class="hljs-keyword">SELECT</span><br>													projectId<br>												<span class="hljs-keyword">FROM</span><br>													t_projecthousetypes pht<br>												<span class="hljs-keyword">WHERE</span><br>													<span class="hljs-number">1</span> = <span class="hljs-number">1</span><br>												<span class="hljs-keyword">AND</span> pht.housType = <span class="hljs-string">'三房两厅一卫'</span><br>											) pht1 <span class="hljs-keyword">ON</span> p4.projectId = pht1.projectId<br>											<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>												p4.projectId<br>										) p5<br>									<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> (<br>										<span class="hljs-keyword">SELECT</span><br>											ph.projectId<br>										<span class="hljs-keyword">FROM</span><br>											t_projecthouses ph<br>										<span class="hljs-keyword">WHERE</span><br>											<span class="hljs-number">1</span> = <span class="hljs-number">1</span><br>										<span class="hljs-keyword">AND</span> (<br>											ph.houseKind = <span class="hljs-string">'10'</span><br>											<span class="hljs-keyword">OR</span> ph.houseKind = <span class="hljs-string">'0'</span><br>										)<br>									) hk <span class="hljs-keyword">ON</span> p5.projectId = hk.projectId<br>									<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>										p5.projectId<br>								) p6<br>							<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> (<br>								<span class="hljs-keyword">SELECT</span><br>									applyForPerson<br>								<span class="hljs-keyword">FROM</span><br>									t_applychart<br>								<span class="hljs-keyword">WHERE</span><br>									applyByPerson = <span class="hljs-string">'860635'</span><br>								<span class="hljs-keyword">AND</span> applyStatus = <span class="hljs-number">2</span><br>							) ap <span class="hljs-keyword">ON</span> p6.projectId = ap.applyForPerson<br>						) pp<br>					<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> t_projectguide g <span class="hljs-keyword">ON</span> pp.projectId = g.projectId<br>				) p7<br>		) p8<br>			<br>		<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (<span class="hljs-keyword">SELECT</span> inviteByPerson <span class="hljs-keyword">FROM</span> t_invitechart <span class="hljs-keyword">WHERE</span> inviteStatus = <span class="hljs-number">2</span>) ic <span class="hljs-keyword">ON</span> p8.projectId = ic.inviteByPerson<br>		<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>			p8.projectId<br>	) p9<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> (<br>	<span class="hljs-keyword">SELECT</span><br>		beCollectId<br>	<span class="hljs-keyword">FROM</span><br>		t_newcollectrecord<br>	<span class="hljs-keyword">WHERE</span><br>		userId = <span class="hljs-string">'4e0b0089-410a-497e-8056-6190e2a183d4'</span><br>) nc <span class="hljs-keyword">ON</span> p9.projectId = nc.beCollectId<br><span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span><br>	p9.projectId<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>	shopCount <span class="hljs-keyword">DESC</span><br><span class="hljs-keyword">LIMIT</span> <span class="hljs-number">0</span>,<br> <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<p>从sql中可以看出我们需要查的三个参数：</p>
<ul>
<li>项目的Id</li>
<li>钱的数量</li>
<li>合作店铺的数量</li>
</ul>
<p>需要的额外功能：</p>
<ul>
<li>分页</li>
<li>根据上面的参数进行排序</li>
</ul>
<h4 id="SQL拼接方法"><a href="#SQL拼接方法" class="headerlink" title="SQL拼接方法"></a>SQL拼接方法</h4><p><strong>顾名思义就是将上述的sql使用java进行拼接，因为这样便于查看和bug查找(这段并不重要)</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 拼接Hql中的p段</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> param</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> sb</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">jointHqlTheP</span><span class="hljs-params">(ShopSearchParam param, User user, StringBuilder sb)</span></span>&#123;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * SELECT</span><br><span class="hljs-comment">				p.projectId</span><br><span class="hljs-comment">			FROM</span><br><span class="hljs-comment">				t_projects p</span><br><span class="hljs-comment">			WHERE</span><br><span class="hljs-comment">				1 = 1</span><br><span class="hljs-comment">			AND p.averagePrice &gt;= 1.0</span><br><span class="hljs-comment">			AND p.averagePrice &lt;= 10000000000.0</span><br><span class="hljs-comment">			AND p.saleLongitude &gt;= 1.0</span><br><span class="hljs-comment">			AND p.saleLongitude &lt;= 10000.00</span><br><span class="hljs-comment">			AND p.saleLatitude &gt;= 1.0</span><br><span class="hljs-comment">			AND p.saleLatitude &lt;= 10000.0</span><br><span class="hljs-comment">			AND p.rightsYears = 70</span><br><span class="hljs-comment">			AND p.city LIKE '%330000%' #AND p.isOpenStatus = 1</span><br><span class="hljs-comment">			AND p.buildArea &gt;= 1.0</span><br><span class="hljs-comment">			AND p.buildArea &lt;= 10000000.0 #AND p.afforestationRatio = 1</span><br><span class="hljs-comment">			AND p.projectName LIKE '%%' #AND p.projectId = '1515269bc87448b4927fa676c624c8f6'</span><br><span class="hljs-comment">		 */</span><br>		<br>		sb.append(<span class="hljs-string">" SELECT "</span>);<br>		sb.append(<span class="hljs-string">" p.projectId "</span>);<br>		sb.append(<span class="hljs-string">" FROM "</span>);<br>		sb.append(<span class="hljs-string">" t_projects p "</span>);<br>		sb.append(<span class="hljs-string">" WHERE "</span>);<br>		sb.append(<span class="hljs-string">" 1 = 1 "</span>);<br>		<span class="hljs-keyword">if</span>(param.getMinAveragePrice() != <span class="hljs-keyword">null</span>)&#123;<br>			sb.append(<span class="hljs-string">" AND p.averagePrice &gt;= "</span> + param.getMinAveragePrice());<br>		&#125;<br>		<span class="hljs-keyword">if</span>(param.getMaxAveragePrice() != <span class="hljs-keyword">null</span>)&#123;<br>			sb.append(<span class="hljs-string">" AND p.averagePrice &lt;= "</span> + param.getMaxAveragePrice());<br>		&#125;<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.getMinLongitudes()))&#123;<br>			sb.append(<span class="hljs-string">" AND p.saleLongitude &gt;= "</span> + param.getMinLongitudes());<br>		&#125;<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.getMaxLongitudes()))&#123;<br>			sb.append(<span class="hljs-string">" AND p.saleLongitude &lt;= "</span> + param.getMaxLongitudes());<br>		&#125;<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.getMinLatitudes()))&#123;<br>			sb.append(<span class="hljs-string">" AND p.saleLatitude &gt;= "</span> + param.getMinLatitudes());<br>		&#125;<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.getMaxLatitudes()))&#123;<br>			sb.append(<span class="hljs-string">" AND p.saleLatitude &lt;= "</span> + param.getMaxLatitudes());<br>		&#125;<br>		<span class="hljs-keyword">if</span>(param.getRightsYears() != <span class="hljs-keyword">null</span>)&#123;<br>			sb.append(<span class="hljs-string">" AND p.rightsYears = "</span> + param.getRightsYears());<br>		&#125;<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.getCityId()))&#123;<br>			sb.append(<span class="hljs-string">" AND p.city LIKE '%"</span> + param.getCityId() + <span class="hljs-string">"%'"</span>);<br>		&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!isEmpty(param.getCityName()))&#123;<br>			String hql = <span class="hljs-string">"from CountryProvinceInfo where cityName = '"</span> + param.getCityName() + <span class="hljs-string">"' and cityLevel = '市' "</span>;<br>			CountryProvinceInfo cp = (CountryProvinceInfo) baseDao.loadObject(hql);<br>			String cityId = cp.getUpCityId();<br>			sb.append(<span class="hljs-string">" AND p.city LIKE '%"</span> + cityId + <span class="hljs-string">"%'"</span>);<br>		&#125;<br>		<span class="hljs-comment">//项目状态 在售、等待售、全部</span><br>		<span class="hljs-keyword">if</span>(param.getProjectStatus() != <span class="hljs-keyword">null</span>)&#123;<br>			<br>			sb.append(<span class="hljs-string">" AND p.isOpenStatus = "</span> + param.getProjectStatus());<br>		&#125;<br>		<span class="hljs-keyword">if</span>(param.getMinBulidArea() != <span class="hljs-keyword">null</span>)&#123;<br>			sb.append(<span class="hljs-string">" AND p.buildArea &gt;= "</span> + param.getMinBulidArea());<br>		&#125;<br>		<span class="hljs-keyword">if</span>(param.getMaxBuildArea() != <span class="hljs-keyword">null</span>)&#123;<br>			sb.append(<span class="hljs-string">" AND p.buildArea &lt;= "</span> + param.getMaxBuildArea());<br>		&#125;<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.getProjectName()))&#123;<br>			sb.append(<span class="hljs-string">" AND p.projectName LIKE '%"</span> + param.getProjectName() + <span class="hljs-string">"%' "</span>);<br>		&#125;<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.getProjectId()))&#123;<br>			sb.append(<span class="hljs-string">" AND p.projectId = '"</span> + param.getProjectId() + <span class="hljs-string">"' "</span>);<br>		&#125;<br>		<br>	&#125;<br>	<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 拼接Hql的p1段 -- 项目标签过滤</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> param</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> sb</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">jointHqlTheP1</span><span class="hljs-params">(ShopSearchParam param, User user, StringBuilder sb)</span></span>&#123;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * SELECT</span><br><span class="hljs-comment">				p1.projectId</span><br><span class="hljs-comment">			FROM</span><br><span class="hljs-comment">				(</span><br><span class="hljs-comment">					&#123;p&#125;//这个是p段</span><br><span class="hljs-comment">				) p1</span><br><span class="hljs-comment">			INNER JOIN (</span><br><span class="hljs-comment">				SELECT</span><br><span class="hljs-comment">					targetId</span><br><span class="hljs-comment">				FROM</span><br><span class="hljs-comment">					t_tagsrelation</span><br><span class="hljs-comment">				WHERE</span><br><span class="hljs-comment">					1 = 1</span><br><span class="hljs-comment">				AND originalTags LIKE '%4507%'</span><br><span class="hljs-comment">				AND originalTags LIKE '%757%'</span><br><span class="hljs-comment">			) t1 ON p1.projectId = t1.targetId</span><br><span class="hljs-comment">		 */</span><br>		sb.append(<span class="hljs-string">" SELECT "</span>);<br>		sb.append(<span class="hljs-string">" p1.projectId "</span>);<br>		sb.append(<span class="hljs-string">" FROM "</span>);<br>		sb.append(<span class="hljs-string">" ( "</span>);<br>		<br>		<span class="hljs-keyword">this</span>.jointHqlTheP(param, user, sb);<span class="hljs-comment">//将p加入</span><br>		<br>		sb.append(<span class="hljs-string">" ) p1 "</span>);<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.getpTags()))&#123;<br>			sb.append(<span class="hljs-string">" INNER JOIN ( "</span>);<br>			sb.append(<span class="hljs-string">" SELECT "</span>);<br>			sb.append(<span class="hljs-string">" targetId "</span>);<br>			sb.append(<span class="hljs-string">" FROM "</span>);<br>			sb.append(<span class="hljs-string">" t_tagsrelation "</span>);<br>			sb.append(<span class="hljs-string">" WHERE "</span>);<br>			sb.append(<span class="hljs-string">" 1 = 1 "</span>);<br>			String[] pTags = <span class="hljs-keyword">this</span>.stringToArray(param.getpTags());<br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; pTags.length; i++) &#123;<br>				sb.append(<span class="hljs-string">" AND originalTags LIKE '%"</span> + pTags[i] + <span class="hljs-string">"%' "</span>);<br>			&#125;<br>			sb.append(<span class="hljs-string">" ) t1 ON p1.projectId = t1.targetId "</span>);<br>		&#125;<br>		<br>	&#125;<br>	<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 拼接Hql的p2段 -- 房源标签过滤</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> param</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> sb</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">jointHqlTheP2</span><span class="hljs-params">(ShopSearchParam param, User user, StringBuilder sb)</span></span>&#123;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * SELECT</span><br><span class="hljs-comment">				p2.projectId</span><br><span class="hljs-comment">			FROM</span><br><span class="hljs-comment">				(</span><br><span class="hljs-comment">					&#123;p1&#125;//这个是p1段</span><br><span class="hljs-comment">				) p2</span><br><span class="hljs-comment">			INNER JOIN (</span><br><span class="hljs-comment">				SELECT</span><br><span class="hljs-comment">					h.projectId</span><br><span class="hljs-comment">				FROM</span><br><span class="hljs-comment">					t_projecthouses h</span><br><span class="hljs-comment">				WHERE</span><br><span class="hljs-comment">					h.houseNum IN (</span><br><span class="hljs-comment">						SELECT</span><br><span class="hljs-comment">							targetId</span><br><span class="hljs-comment">						FROM</span><br><span class="hljs-comment">							t_tagsrelation</span><br><span class="hljs-comment">						WHERE</span><br><span class="hljs-comment">							1 = 1</span><br><span class="hljs-comment">						AND originalTags LIKE '%%'</span><br><span class="hljs-comment">					)</span><br><span class="hljs-comment">				AND h.houseStatus = 1</span><br><span class="hljs-comment">				AND isOpen = 1</span><br><span class="hljs-comment">			) p3 ON p2.projectId = p3.projectId</span><br><span class="hljs-comment">		 */</span><br>		<br>		sb.append(<span class="hljs-string">" SELECT "</span>);<br>		sb.append(<span class="hljs-string">" p2.projectId "</span>);<br>		sb.append(<span class="hljs-string">" FROM "</span>);<br>		sb.append(<span class="hljs-string">" ( "</span>);<br>		<br>		<span class="hljs-keyword">this</span>.jointHqlTheP1(param, user, sb);<span class="hljs-comment">//这个拼接p1</span><br>		<br>		sb.append(<span class="hljs-string">" ) p2 "</span>);<br>		<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.gethTags()))&#123;<br>			sb.append(<span class="hljs-string">" INNER JOIN ( "</span>);<br>			sb.append(<span class="hljs-string">" SELECT "</span>);<br>			sb.append(<span class="hljs-string">" h.projectId "</span>);<br>			sb.append(<span class="hljs-string">" FROM "</span>);<br>			sb.append(<span class="hljs-string">" t_projecthouses h "</span>);<br>			sb.append(<span class="hljs-string">" WHERE "</span>);<br>			sb.append(<span class="hljs-string">" h.houseNum IN ( "</span>);<br>			sb.append(<span class="hljs-string">" SELECT "</span>);<br>			sb.append(<span class="hljs-string">" targetId "</span>);<br>			sb.append(<span class="hljs-string">" FROM "</span>);<br>			sb.append(<span class="hljs-string">" t_tagsrelation "</span>);<br>			sb.append(<span class="hljs-string">" WHERE "</span>);<br>			sb.append(<span class="hljs-string">" 1=1 "</span>);<br>			String[] hTags = <span class="hljs-keyword">this</span>.stringToArray(param.gethTags());<br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; hTags.length; i++) &#123;<br>				sb.append(<span class="hljs-string">" AND originalTags LIKE '%"</span> + hTags[i] + <span class="hljs-string">"%' "</span>);<br>			&#125;<br>			sb.append(<span class="hljs-string">" ) "</span>);<br>			sb.append(<span class="hljs-string">" AND h.houseStatus = 1 "</span>);<br>			sb.append(<span class="hljs-string">" AND isOpen = 1 "</span>);<br>			sb.append(<span class="hljs-string">" ) p3 ON p2.projectId = p3.projectId "</span>);<br>			<br>		&#125;<br>	&#125;<br>	<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 拼接Hql的p4段 -- 房源户型</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> param</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> sb</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">jointHqlTheP4</span><span class="hljs-params">(ShopSearchParam param, User user, StringBuilder sb)</span></span>&#123;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * SELECT</span><br><span class="hljs-comment">				p4.projectId</span><br><span class="hljs-comment">			FROM</span><br><span class="hljs-comment">				(</span><br><span class="hljs-comment">					&#123;p2&#125;//这个是p2段</span><br><span class="hljs-comment">				) p4</span><br><span class="hljs-comment">			INNER JOIN (</span><br><span class="hljs-comment">				SELECT</span><br><span class="hljs-comment">					projectId</span><br><span class="hljs-comment">				FROM</span><br><span class="hljs-comment">					t_projecthousetypes pht</span><br><span class="hljs-comment">				WHERE</span><br><span class="hljs-comment">					1 = 1</span><br><span class="hljs-comment">				AND pht.housType = '三房两厅一卫'</span><br><span class="hljs-comment">			) pht1 ON p4.projectId = pht1.projectId</span><br><span class="hljs-comment">			GROUP BY</span><br><span class="hljs-comment">				p4.projectId</span><br><span class="hljs-comment">		 */</span><br>		sb.append(<span class="hljs-string">" SELECT "</span>);<br>		sb.append(<span class="hljs-string">" p4.projectId "</span>);<br>		sb.append(<span class="hljs-string">" FROM "</span>);<br>		sb.append(<span class="hljs-string">" ( "</span>);<br>		<br>		<span class="hljs-keyword">this</span>.jointHqlTheP2(param, user, sb);<br>		<br>		sb.append(<span class="hljs-string">" ) p4 "</span>);<br>		<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.getHouseType()))&#123;<br>			sb.append(<span class="hljs-string">" INNER JOIN ( "</span>);<br>			sb.append(<span class="hljs-string">" SELECT "</span>);<br>			sb.append(<span class="hljs-string">" projectId "</span>);<br>			sb.append(<span class="hljs-string">" FROM "</span>);<br>			sb.append(<span class="hljs-string">" t_projecthousetypes pht "</span>);<br>			sb.append(<span class="hljs-string">" WHERE "</span>);<br>			sb.append(<span class="hljs-string">" 1 = 1 "</span>);<br>			sb.append(<span class="hljs-string">" AND pht.housType = '"</span> + param.getHouseType() + <span class="hljs-string">"' "</span>);<br>			sb.append(<span class="hljs-string">" ) pht1 ON p4.projectId = pht1.projectId "</span>);<br>			sb.append(<span class="hljs-string">" GROUP BY "</span>);<br>			sb.append(<span class="hljs-string">" p4.projectId "</span>);<br>		&#125;<br>		<br>		<br>		<br>	&#125;<br>	<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 拼接Hql的p5段 -- 房源类型过滤</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> param</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> sb</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">jointHqlTheP5</span><span class="hljs-params">(ShopSearchParam param, User user, StringBuilder sb)</span></span>&#123;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * SELECT</span><br><span class="hljs-comment">				p5.projectId</span><br><span class="hljs-comment">			FROM</span><br><span class="hljs-comment">				(</span><br><span class="hljs-comment">					&#123;p4&#125;//拼接p4段</span><br><span class="hljs-comment">				) p5</span><br><span class="hljs-comment">			INNER JOIN (</span><br><span class="hljs-comment">				SELECT</span><br><span class="hljs-comment">					ph.projectId</span><br><span class="hljs-comment">				FROM</span><br><span class="hljs-comment">					t_projecthouses ph</span><br><span class="hljs-comment">				WHERE</span><br><span class="hljs-comment">					1 = 1</span><br><span class="hljs-comment">				AND (</span><br><span class="hljs-comment">					ph.houseKind = '10'</span><br><span class="hljs-comment">					OR ph.houseKind = '0'</span><br><span class="hljs-comment">				)</span><br><span class="hljs-comment">			) hk ON p5.projectId = hk.projectId</span><br><span class="hljs-comment">			GROUP BY</span><br><span class="hljs-comment">				p5.projectId</span><br><span class="hljs-comment">		 */</span><br>		sb.append(<span class="hljs-string">" SELECT "</span>);<br>		sb.append(<span class="hljs-string">" p5.projectId "</span>);<br>		sb.append(<span class="hljs-string">" FROM "</span>);<br>		sb.append(<span class="hljs-string">" ( "</span>);<br>		<br>		<span class="hljs-keyword">this</span>.jointHqlTheP4(param, user, sb);<br>		<br>		sb.append(<span class="hljs-string">" ) p5 "</span>);<br>		<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.getHouseKinds()))&#123;<br>			sb.append(<span class="hljs-string">" INNER JOIN ( "</span>);<br>			sb.append(<span class="hljs-string">" SELECT "</span>);<br>			sb.append(<span class="hljs-string">" ph.projectId "</span>);<br>			sb.append(<span class="hljs-string">" FROM "</span>);<br>			sb.append(<span class="hljs-string">" t_projecthouses ph "</span>);<br>			sb.append(<span class="hljs-string">" WHERE "</span>);<br>			sb.append(<span class="hljs-string">" 1 = 1 "</span>);<br>			sb.append(<span class="hljs-string">" AND ( "</span>);<br>			String[] kinds = <span class="hljs-keyword">this</span>.stringToArray(param.getHouseKinds());<br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; kinds.length; i++) &#123;<br>				<span class="hljs-keyword">if</span>(i == <span class="hljs-number">0</span>)&#123;<br>					sb.append(<span class="hljs-string">" ph.houseKind = '"</span> + kinds[i] + <span class="hljs-string">"' "</span>);<br>				&#125;<span class="hljs-keyword">else</span>&#123;<br>					sb.append(<span class="hljs-string">" OR  ph.houseKind = '"</span> + kinds[i] + <span class="hljs-string">"' "</span>);<br>				&#125;<br>			&#125;<br>			sb.append(<span class="hljs-string">" ) "</span>);<br>			sb.append(<span class="hljs-string">" ) hk ON p5.projectId = hk.projectId "</span>);<br>			sb.append(<span class="hljs-string">" GROUP BY p5.projectId "</span>);<br>		&#125;<br>		<br>	&#125;<br>	<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 拼接Hql的p5段 -- 房源类型过滤</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> param</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> sb</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">jointHqlTheP6</span><span class="hljs-params">(ShopSearchParam param, User user, StringBuilder sb)</span></span>&#123;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * SELECT</span><br><span class="hljs-comment">				p6.projectId</span><br><span class="hljs-comment">			FROM</span><br><span class="hljs-comment">				(</span><br><span class="hljs-comment">					&#123;p5&#125;//拼接p5段</span><br><span class="hljs-comment">				) p6</span><br><span class="hljs-comment">			INNER JOIN (</span><br><span class="hljs-comment">				SELECT</span><br><span class="hljs-comment">					applyForPerson</span><br><span class="hljs-comment">				FROM</span><br><span class="hljs-comment">					t_applychart</span><br><span class="hljs-comment">				WHERE</span><br><span class="hljs-comment">					applyByPerson = '860635'</span><br><span class="hljs-comment">				AND applyStatus = 2</span><br><span class="hljs-comment">			) ap ON p6.projectId = ap.applyForPerson</span><br><span class="hljs-comment">		 */</span><br>		sb.append(<span class="hljs-string">" SELECT "</span>);<br>		sb.append(<span class="hljs-string">" p6.projectId "</span>);<br>		sb.append(<span class="hljs-string">" FROM "</span>);<br>		sb.append(<span class="hljs-string">" ( "</span>);<br>		<span class="hljs-keyword">this</span>.jointHqlTheP5(param, user, sb);<br>		sb.append(<span class="hljs-string">" ) p6 "</span>);<br>		<br>		<span class="hljs-keyword">if</span>(param.getInviteStatus() != <span class="hljs-keyword">null</span>)&#123;<br>			sb.append(<span class="hljs-string">" INNER JOIN ( "</span>);<br>			sb.append(<span class="hljs-string">" SELECT "</span>);<br>			sb.append(<span class="hljs-string">" applyForPerson "</span>);<br>			sb.append(<span class="hljs-string">" FROM "</span>);<br>			sb.append(<span class="hljs-string">" t_applychart "</span>);<br>			sb.append(<span class="hljs-string">" WHERE "</span>);<br>			sb.append(<span class="hljs-string">" applyByPerson = '"</span> + user.getParentId() + <span class="hljs-string">"' "</span>);<br>			sb.append(<span class="hljs-string">" AND applyStatus = "</span> + param.getInviteStatus());<br>			sb.append(<span class="hljs-string">" ) ap ON p6.projectId = ap.applyForPerson "</span>);<br>			<br>		&#125;<br>		<br>	&#125;<br>	<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 拼接Hql的PP段 -- 查看带看业务定义中的佣金</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> param</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> sb</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">jointHqlThePP</span><span class="hljs-params">(ShopSearchParam param, User user, StringBuilder sb)</span></span>&#123;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * SELECT</span><br><span class="hljs-comment">				pp.projectId,</span><br><span class="hljs-comment">				g.fenxiaoMoney</span><br><span class="hljs-comment">			FROM</span><br><span class="hljs-comment">				(</span><br><span class="hljs-comment">					&#123;p6&#125;//拼接p6段</span><br><span class="hljs-comment">				) pp</span><br><span class="hljs-comment">			LEFT JOIN t_projectguide g ON pp.projectId = g.projectId</span><br><span class="hljs-comment">		 */</span><br>		<br>		sb.append(<span class="hljs-string">" SELECT "</span>);<br>		sb.append(<span class="hljs-string">" pp.projectId, "</span>);<br>		sb.append(<span class="hljs-string">" g.fenxiaoMoney "</span>);<br>		sb.append(<span class="hljs-string">" FROM "</span>);<br>		sb.append(<span class="hljs-string">" ( "</span>);<br>		<br>		<span class="hljs-keyword">this</span>.jointHqlTheP6(param, user, sb);<br>		<br>		sb.append(<span class="hljs-string">" ) pp "</span>);<br>		sb.append(<span class="hljs-string">" LEFT JOIN t_projectguide g ON pp.projectId = g.projectId "</span>);<br>		<br>	&#125;<br>	<br>	<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 拼接Hql的P7段</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> param</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> sb</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">jointHqlTheP7</span><span class="hljs-params">(ShopSearchParam param, User user, StringBuilder sb)</span></span>&#123;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * SELECT</span><br><span class="hljs-comment">				p7.projectId,</span><br><span class="hljs-comment">				p7.fenxiaoMoney</span><br><span class="hljs-comment">			FROM</span><br><span class="hljs-comment">				(</span><br><span class="hljs-comment">					&#123;pp&#125;//拼接pp段</span><br><span class="hljs-comment">				) p7</span><br><span class="hljs-comment">		 */</span><br>		<br>		sb.append(<span class="hljs-string">" SELECT "</span>);<br>		sb.append(<span class="hljs-string">" p7.projectId, "</span>);<br>		sb.append(<span class="hljs-string">" p7.fenxiaoMoney "</span>);<br>		sb.append(<span class="hljs-string">" FROM "</span>);<br>		sb.append(<span class="hljs-string">" ( "</span>);<br>		<br>		<span class="hljs-keyword">this</span>.jointHqlThePP(param, user, sb);<br>		<br>		sb.append(<span class="hljs-string">" ) p7 "</span>);<br>	&#125;<br>	<br>	<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 拼接Hql的P8段 -- 项目的合作门店数量</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> param</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> sb</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">jointHqlTheP8</span><span class="hljs-params">(ShopSearchParam param, User user, StringBuilder sb)</span></span>&#123;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * SELECT</span><br><span class="hljs-comment">			p8.projectId,</span><br><span class="hljs-comment">			p8.fenxiaoMoney,</span><br><span class="hljs-comment">			count(ic.inviteByPerson) shopCount</span><br><span class="hljs-comment">		FROM</span><br><span class="hljs-comment">		(</span><br><span class="hljs-comment">			&#123;p7&#125; //拼接P7段</span><br><span class="hljs-comment">		) p8</span><br><span class="hljs-comment">			</span><br><span class="hljs-comment">		LEFT JOIN t_invitechart ic ON p8.projectId = ic.inviteByPerson</span><br><span class="hljs-comment">		GROUP BY</span><br><span class="hljs-comment">			p8.projectId</span><br><span class="hljs-comment">		 */</span><br>		sb.append(<span class="hljs-string">" SELECT "</span>);<br>		sb.append(<span class="hljs-string">" p8.projectId, "</span>);<br>		sb.append(<span class="hljs-string">" p8.fenxiaoMoney, "</span>);<br>		sb.append(<span class="hljs-string">" count(ic.inviteByPerson) shopCount "</span>);<br>		sb.append(<span class="hljs-string">" FROM "</span>);<br>		sb.append(<span class="hljs-string">" ( "</span>);<br>		<br>		<span class="hljs-keyword">this</span>.jointHqlTheP7(param, user, sb);<br>		<br>		sb.append(<span class="hljs-string">" ) p8 "</span>);<br>		sb.append(<span class="hljs-string">" LEFT JOIN (SELECT inviteByPerson FROM t_invitechart WHERE inviteStatus = 2) ic ON p8.projectId = ic.inviteByPerson "</span>);<br>		sb.append(<span class="hljs-string">" GROUP BY p8.projectId "</span>);<br>	&#125;<br>	<br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 拼接Hql的P9段 -- 个人是否收藏</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> param</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> user</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> sb</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">jointHqlTheP9</span><span class="hljs-params">(ShopSearchParam param, User user, StringBuilder sb, Page page)</span></span>&#123;<br>		<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">		 * SELECT</span><br><span class="hljs-comment">		 	*</span><br><span class="hljs-comment">			FROM</span><br><span class="hljs-comment">				(</span><br><span class="hljs-comment">					&#123;p8&#125;//拼接p8段</span><br><span class="hljs-comment">				) p9</span><br><span class="hljs-comment">			LEFT JOIN (</span><br><span class="hljs-comment">				SELECT</span><br><span class="hljs-comment">					beCollectId</span><br><span class="hljs-comment">				FROM</span><br><span class="hljs-comment">					t_newcollectrecord</span><br><span class="hljs-comment">				WHERE</span><br><span class="hljs-comment">					userId = '4e0b0089-410a-497e-8056-6190e2a183d4'</span><br><span class="hljs-comment">			) nc ON p9.projectId = nc.beCollectId</span><br><span class="hljs-comment">			GROUP BY</span><br><span class="hljs-comment">				p9.projectId</span><br><span class="hljs-comment">			ORDER BY</span><br><span class="hljs-comment">				shopCount DESC</span><br><span class="hljs-comment">			LIMIT 0,</span><br><span class="hljs-comment">			 10</span><br><span class="hljs-comment">		 */</span><br>		<br>		sb.append(<span class="hljs-string">" SELECT "</span>);<br>		sb.append(<span class="hljs-string">" p9.projectId, p9.fenxiaoMoney, p9.shopCount "</span>);<br>		sb.append(<span class="hljs-string">" FROM "</span>);<br>		sb.append(<span class="hljs-string">" ( "</span>);<br>		<br>		<span class="hljs-keyword">this</span>.jointHqlTheP8(param, user, sb);<br>		<br>		sb.append(<span class="hljs-string">" ) p9 "</span>);<br>		<span class="hljs-keyword">if</span>(param.getIsClikeLike() != <span class="hljs-keyword">null</span>)&#123;<br>			sb.append(<span class="hljs-string">" LEFT JOIN ( "</span>);<br>			sb.append(<span class="hljs-string">" SELECT "</span>);<br>			sb.append(<span class="hljs-string">" beCollectId "</span>);<br>			sb.append(<span class="hljs-string">" FROM "</span>);<br>			sb.append(<span class="hljs-string">" t_newcollectrecord "</span>);<br>			sb.append(<span class="hljs-string">" WHERE "</span>);<br>			sb.append(<span class="hljs-string">" userId = '"</span> + user.getUserId() + <span class="hljs-string">"' "</span>);<br>			sb.append(<span class="hljs-string">" ) nc ON p9.projectId "</span>);<br>			<span class="hljs-keyword">if</span>(param.getIsClikeLike() == <span class="hljs-number">1</span>)&#123;<span class="hljs-comment">//收藏</span><br>				sb.append(<span class="hljs-string">" = "</span>);<br>			&#125;<span class="hljs-keyword">else</span>&#123;<span class="hljs-comment">//未收藏</span><br>				sb.append(<span class="hljs-string">" != "</span>);<br>			&#125;<br>			sb.append(<span class="hljs-string">" nc.beCollectId "</span>);<br>			<br>			sb.append(<span class="hljs-string">" GROUP BY "</span>);<br>			sb.append(<span class="hljs-string">" p9.projectId "</span>);<br>		<br>		&#125;<br>		<br>		<span class="hljs-keyword">if</span>(!isEmpty(param.getOrderType()) &amp;&amp; param.getOrder() != <span class="hljs-keyword">null</span>)&#123;<br>			<br>			sb.append(<span class="hljs-string">" ORDER BY "</span>);<br>			<span class="hljs-keyword">if</span>(param.getOrderType().equals(ShopSearchConstant.ORDER_TYPE_SHOP_COUNT))&#123;<span class="hljs-comment">//合作门店数量</span><br>				sb.append(<span class="hljs-string">" p9.shopCount "</span>);<br>			&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(param.getOrderType().equals(ShopSearchConstant.ORDER_TYPE_MONEY))&#123;<span class="hljs-comment">//及时结款率  -  暂无</span><br>				sb.append(<span class="hljs-string">" p9.shopCount "</span>);<span class="hljs-comment">//暂无，暂时用这个替代</span><br>			&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(param.getOrderType().equals(ShopSearchConstant.ORDER_TYPE_COMMISSION))&#123;<span class="hljs-comment">//佣金高低</span><br>				sb.append(<span class="hljs-string">" p9.fenxiaoMoney "</span>);<br>			&#125;<br>			sb.append(param.getOrderType());<br>			<span class="hljs-keyword">if</span>(param.getOrder() == <span class="hljs-number">0</span>)&#123;<br>				sb.append(<span class="hljs-string">" DESC "</span>);<br>			&#125;<span class="hljs-keyword">else</span>&#123;<br>				sb.append(<span class="hljs-string">" ASC "</span>);<br>			&#125;<br>		&#125;<br>		<br>		<span class="hljs-keyword">if</span>(page != <span class="hljs-keyword">null</span>)&#123;<br>			sb.append(<span class="hljs-string">" LIMIT "</span> + page.getStart() + <span class="hljs-string">","</span> + page.getLimit());<br>		&#125;<br>		<br>		 <br>	&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Service-层"><a href="#Service-层" class="headerlink" title="Service 层"></a>Service 层</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//这个方法是将反射之后得到的字段类型和字段名称进行拆分</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeDtoToFieldsToArray</span><span class="hljs-params">(Field[] fields, String[] colums, String[] types)</span></span>&#123;<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; fields.length; i++) &#123;<br>			types[i] = fields[i].getType().toString().replace(<span class="hljs-string">"class java.lang."</span>, <span class="hljs-string">""</span>);<br>			colums[i] = fields[i].getName();<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>


<p><strong>下面的方法就是整个Service中的核心方法了，将自定义sql交给hibernate进行处理，并且使用自定义的dto对象进行封装</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//这个方法就是将sql进行查询</span><br><span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">findProjectListByShopSearchParam</span><span class="hljs-params">(ShopSearchParam shopSearchParam, Page page, User user)</span> </span>&#123;<br>		StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>		<br>		<span class="hljs-comment">// 利用反射获取Project组装类的所有的字段和类型</span><br>		Field[] fields = ProjectMapListDTO<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredFields</span>()</span>;<br>		String[] colums = <span class="hljs-keyword">new</span> String[fields.length];<br>		String[] types = <span class="hljs-keyword">new</span> String[fields.length];<br>		<span class="hljs-keyword">this</span>.invokeDtoToFieldsToArray(fields, colums, types);<br>		<span class="hljs-keyword">this</span>.jointHqlTheP9(shopSearchParam, user, sb, page);<br>		<span class="hljs-comment">//返回的结果</span><br>		List&lt;ProjectMapTotalDTO&gt; rsList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();<br>		<span class="hljs-comment">//当前用户所有收藏的项目</span><br>		List&lt;NewCollectRecord&gt; collList =  <span class="hljs-keyword">this</span>.findNewCollectRecordByUserId(user.getUserId(), ShopSearchConstant.COLLECT_TYPE_PROJECT,<span class="hljs-keyword">null</span>);<br>		<span class="hljs-comment">//当前门店所有的申请</span><br>		List&lt;ApplyChart&gt; appList = <span class="hljs-keyword">this</span>.findApplyChartsByShopId(user.getParentId(), <span class="hljs-keyword">null</span>);<br>		<span class="hljs-comment">//---------重要---------这个就是关键方法</span><br>		List&lt;ProjectMapListDTO&gt; list = baseDao.queryDTOBySql(sb.toString(), ProjectMapListDTO<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">colums</span>, <span class="hljs-title">types</span>)</span>;<br>		<br>		<span class="hljs-comment">//这里是工作需要，将查询出来的结果进行再次封装--看需要吧</span><br>		<span class="hljs-comment">//需要进行判断是否收藏和申请状态的判断</span><br>		<span class="hljs-keyword">for</span> (ProjectMapListDTO pd : list) &#123;<br>			<br>			ProjectMapTotalDTO ptd = <span class="hljs-keyword">new</span> ProjectMapTotalDTO();<br>			Project project = (Project) baseDao.loadById(Project<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">pd</span>.<span class="hljs-title">getProjectId</span>())</span>;<br>			ptd.setProject(project);<br>			ptd.setFenxiaoMoney(pd.getFenxiaoMoney());<br>			ptd.setShopCount(pd.getShopCount());<br>			<span class="hljs-comment">//判断是否已经被收藏</span><br>			<span class="hljs-keyword">boolean</span> flag = <span class="hljs-keyword">false</span>;<br>			<span class="hljs-keyword">for</span>(NewCollectRecord nr : collList)&#123;<br>				<span class="hljs-keyword">if</span>(nr.getBeCollectId().equals(pd.getProjectId()))&#123;<br>					flag = <span class="hljs-keyword">true</span>;<br>				&#125;<br>			&#125;<br>			<br>			<span class="hljs-comment">//查看合作关系</span><br>			<span class="hljs-keyword">for</span>(ApplyChart ac : appList)&#123;<br>				<span class="hljs-keyword">if</span>(pd.getProjectId().equals(ac.getApplyForPerson()))&#123;<br>					ptd.setApplyStatus(ac.getApplyStatus());<br>				&#125;<br>			&#125;<br>			<br>			ptd.setIsLike(flag ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);<br>			rsList.add(ptd);<br>		&#125;<br>		page.setRoot(rsList);<br><br>		List&lt;ProjectMapTotalDTO&gt; lz = <span class="hljs-keyword">this</span>.findProjectListForMapNew(shopSearchParam, user);<br>		page.setTotal(lz.size());<br>		<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>看看DTO对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sc.tradmaster.service.shop.impl.dto;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProjectMapListDTO</span> </span>&#123;<br><br>	<span class="hljs-keyword">private</span> String projectId;<br>	<span class="hljs-keyword">private</span> Double fenxiaoMoney;<br>	<span class="hljs-keyword">private</span> Integer shopCount;<br>	<br>	<span class="hljs-comment">//省略set和get方法</span><br>	<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="DAO核心方法"><a href="#DAO核心方法" class="headerlink" title="DAO核心方法"></a>DAO核心方法</h4><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseDaoImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HibernateDaoSupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BaseDao</span></span>&#123;<br><br>	<span class="hljs-meta">@Resource</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">mySessionFactory</span><span class="hljs-params">(SessionFactory sf)</span></span>&#123;<br>		<span class="hljs-keyword">super</span>.setSessionFactory(sf);<br>	&#125;<br>	<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 执行sql组装DTO对象集合</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> sql</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> clazz</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> List <span class="hljs-title">queryDTOBySql</span><span class="hljs-params">(String sql,Class clazz,String[] colums,String[] types)</span> </span>&#123;    <br>		Session session = <span class="hljs-keyword">super</span>.getSessionFactory().getCurrentSession();<br>		SQLQuery query = session.createSQLQuery(sql);<br>		<span class="hljs-keyword">if</span>(colums!=<span class="hljs-keyword">null</span> &amp;&amp; types!=<span class="hljs-keyword">null</span> &amp;&amp; colums.length==types.length)&#123;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;colums.length;i++)&#123;<br>				<span class="hljs-keyword">if</span>(types[i].equals(<span class="hljs-string">"Integer"</span>))&#123;<br>					query.addScalar(colums[i],StandardBasicTypes.INTEGER);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(types[i].equals(<span class="hljs-string">"String"</span>))&#123;<br>					query.addScalar(colums[i],StandardBasicTypes.STRING);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(types[i].equals(<span class="hljs-string">"Double"</span>))&#123;<br>					query.addScalar(colums[i],StandardBasicTypes.DOUBLE);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(types[i].equals(<span class="hljs-string">"Long"</span>))&#123;<br>					query.addScalar(colums[i],StandardBasicTypes.LONG);<br>				&#125;<br>				<br>			&#125;<br>		&#125;<br>		List&lt;Object[]&gt; list = query.setResultTransformer(Transformers.aliasToBean(clazz)).list();<br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>结语：由于是在工作中用到的代码段，所以显得有些复杂化了，以后有时间的话，使用通俗易懂的方法讲解出来，先留个坑，如果大家遇到这种使用场景无法解决的话，欢迎打扰：<a href="mailto:1085143002@qq.com">1085143002@qq.com</a></p>
</blockquote>
]]></content>
      <categories>
        <category>Hibernate</category>
      </categories>
      <tags>
        <tag>Hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring boot Mybatis 整合（注解版）</title>
    <url>/2018/01/18/spring-boot-mybatis-annotation/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046778152150.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<blockquote>
<p>  之前写过一篇关于springboot 与 mybatis整合的博文，使用了一段时间<a href="http://winterchen.com/2017/11/11/springbootdata2/" target="_blank" rel="noopener">spring-data-jpa</a>，发现那种方式真的是太爽了，mybatis的xml的映射配置总觉得有点麻烦。接口定义和映射离散在不同的文件中，阅读起来不是很方便。于是，准备使用mybatis的注解方式实现映射。如果喜欢xml方式的可以看我之前的博文：<a href="http://blog.csdn.net/winter_chen001/article/details/77249029" target="_blank" rel="noopener"> Spring boot Mybatis 整合（完整版）</a></p>
</blockquote>
<a id="more"></a>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><p>请前往文章末端查看</p>
<h3 id="开发环境："><a href="#开发环境：" class="headerlink" title="开发环境："></a>开发环境：</h3><hr>
<ul>
<li>开发工具：Intellij IDEA 2017.1.3</li>
<li>JDK : 1.8.0_101</li>
<li>spring boot 版本 ： 1.5.8.RELEASE</li>
<li>maven : 3.3.9</li>
</ul>
<h3 id="拓展："><a href="#拓展：" class="headerlink" title="拓展："></a>拓展：</h3><ul>
<li>springboot 整合 Mybatis 事务管理</li>
</ul>
<h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><h4 id="1-新建一个springboot项目："><a href="#1-新建一个springboot项目：" class="headerlink" title="1.新建一个springboot项目："></a>1.新建一个springboot项目：</h4><p><img    class="lazyload" data-original="http://img.blog.csdn.net/20171124094443907?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2ludGVyX2NoZW4wMDE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p><img    class="lazyload" data-original="http://img.blog.csdn.net/20171124094505295?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2ludGVyX2NoZW4wMDE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p><strong>添加依赖</strong><br><img    class="lazyload" data-original="http://img.blog.csdn.net/20171124094516207?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2ludGVyX2NoZW4wMDE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<h4 id="2-看一下项目结构"><a href="#2-看一下项目结构" class="headerlink" title="2.看一下项目结构"></a>2.看一下项目结构</h4><p><img    class="lazyload" data-original="http://img.blog.csdn.net/20171124094524448?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2ludGVyX2NoZW4wMDE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<h4 id="3-完整依赖"><a href="#3-完整依赖" class="headerlink" title="3.完整依赖"></a>3.完整依赖</h4><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">	<span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.winterchen<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springboot-mybatis-demo2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>springboot-mybatis-demo2<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.8.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>


<h4 id="4-配置文件"><a href="#4-配置文件" class="headerlink" title="4.配置文件"></a>4.配置文件</h4><p>因为习惯性的喜欢使用yml作为配置文件，所以将application.properties替换为application.yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>     <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/mytest</span><br>     <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>     <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>     <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br></code></pre></td></tr></table></figure>

<p>简单且简洁的完成了基本配置，下面看看我们是如何在这个基础下轻松使用Mybatis访问数据库的</p>
<h3 id="使用Mybatis"><a href="#使用Mybatis" class="headerlink" title="使用Mybatis"></a>使用Mybatis</h3><hr>
<ul>
<li><p>在Mysql数据库中创建数据表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> mytest;<br><br><span class="hljs-keyword">USE</span> mytest;<br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_user(<br>  <span class="hljs-keyword">id</span> <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> PRIMARY <span class="hljs-keyword">KEY</span> AUTO_INCREMENT,<br>  <span class="hljs-keyword">name</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> ,<br>  <span class="hljs-keyword">password</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> ,<br>  phone <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span><br>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">INNODB</span> AUTO_INCREMENT=<span class="hljs-number">1000</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8;<br></code></pre></td></tr></table></figure>
</li>
<li><p>创建映射对象User</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.domain;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * User实体映射类</span><br><span class="hljs-comment"> * Created by Administrator on 2017/11/24.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-keyword">private</span> String phone;<br><br>	<span class="hljs-comment">//省略 get 和 set ...</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>创建User映射的操作UserMapper，为了后续单元测试验证，实现插入和查询操作</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen.mapper;<br><br><span class="hljs-keyword">import</span> com.winterchen.domain.User;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Insert;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;<br><span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Select;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * User映射类</span><br><span class="hljs-comment"> * Created by Administrator on 2017/11/24.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> </span>&#123;<br><br>    <span class="hljs-meta">@Select</span>(<span class="hljs-string">"SELECT * FROM T_USER WHERE PHONE = #&#123;phone&#125;"</span>)<br>    <span class="hljs-function">User <span class="hljs-title">findUserByPhone</span><span class="hljs-params">(@Param(<span class="hljs-string">"phone"</span>)</span> String phone)</span>;<br><br>    <span class="hljs-meta">@Insert</span>(<span class="hljs-string">"INSERT INTO T_USER(NAME, PASSWORD, PHONE) VALUES(#&#123;name&#125;, #&#123;password&#125;, #&#123;phone&#125;)"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(@Param(<span class="hljs-string">"name"</span>)</span> String name, @<span class="hljs-title">Param</span><span class="hljs-params">(<span class="hljs-string">"password"</span>)</span> String password, @<span class="hljs-title">Param</span><span class="hljs-params">(<span class="hljs-string">"phone"</span>)</span> String phone)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>如果想了解更多Mybatis注解的详细：<a href="http://blog.csdn.net/winter_chen001/article/details/78623700" target="_blank" rel="noopener">springboot中使用Mybatis注解配置详解</a></strong></p>
<ul>
<li><p>创建springboot 主类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringbootMybatisDemo2Application</span> </span>&#123;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		SpringApplication.run(SpringbootMybatisDemo2Application<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>创建测试单元:</p>
<ul>
<li>测试逻辑：插入一条name为”weinterchen”的User，然后根据user的phone进行查询，并判断user的name是否为”winterchen”。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winterchen;<br><br><span class="hljs-keyword">import</span> com.winterchen.domain.User;<br><span class="hljs-keyword">import</span> com.winterchen.mapper.UserMapper;<br><span class="hljs-keyword">import</span> org.junit.Assert;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.junit.runner.RunWith;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.test.context.junit4.SpringRunner;<br><br><span class="hljs-meta">@RunWith</span>(SpringRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><br><span class="hljs-class">@<span class="hljs-title">SpringBootTest</span></span><br><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">SpringbootMybatisDemo2ApplicationTests</span> </span>&#123;<br><br><br>	<span class="hljs-meta">@Autowired</span><br>	<span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>	<span class="hljs-meta">@Test</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>&#123;<br><br>		userMapper.insert(<span class="hljs-string">"winterchen"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"12345678910"</span>);<br>		User u = userMapper.findUserByPhone(<span class="hljs-string">"12345678910"</span>);<br>		Assert.assertEquals(<span class="hljs-string">"winterchen"</span>, u.getName());<br>	&#125;<br><br>	<br><br>&#125;<br></code></pre></td></tr></table></figure>


<ul>
<li>测试结果</li>
</ul>
<p><img    class="lazyload" data-original="http://img.blog.csdn.net/20171124103725302?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2ludGVyX2NoZW4wMDE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p>说明已经成功了</p>
<h3 id="事务管理（重要）"><a href="#事务管理（重要）" class="headerlink" title="事务管理（重要）"></a>事务管理（重要）</h3><hr>
<blockquote>
<p>我们在开发企业应用时，对于业务人员的一个操作实际是对数据读写的多步操作的结合。由于数据操作在顺序执行的过程中，任何一步操作都有可能发生异常，异常会导致后续操作无法完成，此时由于业务逻辑并未正确的完成，之前成功操作数据的并不可靠，需要在这种情况下进行回退。</p>
</blockquote>
<p><strong>为了测试的成功，请把测试的内容进行替换，因为之前测试的时候已经将数据生成了，重复的数据会对测试的结果有影响</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>&#123;<br><br>	userMapper.insert(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"18600000000"</span>);<br>	<span class="hljs-keyword">int</span> a = <span class="hljs-number">1</span>/<span class="hljs-number">0</span>;<br>	userMapper.insert(<span class="hljs-string">"李四"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-string">"13500000000"</span>);<br>	User u = userMapper.findUserByPhone(<span class="hljs-string">"12345678910"</span>);<br>	Assert.assertEquals(<span class="hljs-string">"winterchen"</span>, u.getName());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>只需要在需要事务管理的方法上添加 <code>@Transactional</code> 注解即可，然后我们启动测试，会发现异常之后，数据库中没有产生数据。</p>
<p>如果大家想对springboot事务管理有更加详细的了解，欢迎大家查看：<a href="http://blog.csdn.net/Winter_chen001/article/details/78622679" target="_blank" rel="noopener"> springboot事务管理详解</a></p>
<p>源码：<a href="https://github.com/WinterChenS/springboot-mybatis-demo2/" target="_blank" rel="noopener">https://github.com/WinterChenS/springboot-mybatis-demo2/</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>layui完美分页，ajax请求分页（真分页） 【2.0版本】</title>
    <url>/2017/10/25/layui-page-2.0/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046775186684.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p><strong>使用的layui版本为：layui-v2.0以上版本，如果v1.0版本请看我另外一篇博客 <a href="https://winterchens.github.io/2017/10/25/layui-page-1.0/" target="_blank" rel="noopener"> 《layui完美分页，ajax请求分页（真分页）》</a></strong></p>
<a id="more"></a>

<p>最近因为以为学者在看了我上一篇关于layui分页的博客遇到了问题，原因是因为使用了新版本2.x，导致有一些属性改变了，所以出了这篇新版本的博客，本文是根据上一篇博客改变而成，如有疑问请联系我 email：<a href="mailto:1085143002@qq.com">1085143002@qq.com</a></p>
<h3 id="完整代码："><a href="#完整代码：" class="headerlink" title="完整代码："></a>完整代码：</h3><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">%@</span> <span class="hljs-attr">page</span> <span class="hljs-attr">language</span>=<span class="hljs-string">"java"</span> <span class="hljs-attr">contentType</span>=<span class="hljs-string">"text/html; charset=UTF-8"</span> <span class="hljs-attr">pageEncoding</span>=<span class="hljs-string">"UTF-8"</span>%&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"renderer"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"webkit"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge,chrome=1"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1, maximum-scale=1"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"apple-mobile-web-app-status-bar-style"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"black"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"apple-mobile-web-app-capable"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"yes"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"format-detection"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"telephone=no"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span>  <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"static/images/titleLogo.png"</span>  /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>门店管理后台<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"static/layui/plugins/layui/css/layui.css"</span> <span class="hljs-attr">media</span>=<span class="hljs-string">"all"</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;link rel="stylesheet" type="text/css" href="static/css/reset.css"&gt;</span><br><span class="hljs-comment">    &lt;link rel="stylesheet" type="text/css" href="static/css/commend.css"&gt; --&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;link rel="stylesheet" href="static/css/jqpagination.css" /&gt; --&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;link rel="stylesheet" type="text/css" href="static/css/shopCustomerManager.css"&gt; --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"static/js/jquery-3.1.1.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"static/layui/plugins/layui/layui.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;script type="text/javascript" src="static/js/jquery.jqpagination.js"&gt;&lt;/script&gt; --&gt;</span><br>   	<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><br><span class="javascript">	   	$(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="actionscript">	   		  <span class="hljs-comment">//ajax请求后台数据</span></span><br>		      getShopCustomerManagePageInfo();<br>		      <br>		<br><span class="actionscript">	   		  <span class="hljs-comment">//点击搜索时 搜索数据</span></span><br><span class="javascript">	   		  $(<span class="hljs-string">"#selectButton"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123; </span><br>	   			getShopCustomerManagePageInfo();<br><span class="actionscript">	   			currentPageAllAppoint = <span class="hljs-number">1</span>; <span class="hljs-comment">//当点击搜索的时候，应该回到第一页</span></span><br><span class="actionscript">	   			toPage();<span class="hljs-comment">//然后进行分页的初始化</span></span><br>	   			<br>	   	      &#125;)<br>	   	   toPage();<br>	   	&#125;);<br>	   	<br><span class="actionscript">	  	<span class="hljs-comment">//分页参数设置 这些全局变量关系到分页的功能</span></span><br><span class="actionscript">	   	<span class="hljs-keyword">var</span> startAllAppoint = <span class="hljs-number">0</span>;<span class="hljs-comment">//开始页数</span></span><br><span class="actionscript">	   	<span class="hljs-keyword">var</span> limitAllAppoint = <span class="hljs-number">10</span>;<span class="hljs-comment">//每页显示数据条数</span></span><br><span class="actionscript">	   	<span class="hljs-keyword">var</span> currentPageAllAppoint = <span class="hljs-number">1</span>;<span class="hljs-comment">//当前页数</span></span><br><span class="actionscript">	   	<span class="hljs-keyword">var</span> dataLength = <span class="hljs-number">0</span>;<span class="hljs-comment">//数据总条数</span></span><br><span class="actionscript">	   	<span class="hljs-comment">//ajax请求后台数据</span></span><br><span class="actionscript">	   	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getShopCustomerManagePageInfo</span><span class="hljs-params">()</span></span>&#123;</span><br><span class="javascript">	   		$.ajax(&#123;</span><br><span class="actionscript">	   			type:<span class="hljs-string">"post"</span>,</span><br><span class="javascript">	   			<span class="hljs-keyword">async</span>:<span class="hljs-literal">false</span>,</span><br><span class="actionscript">	   			url:<span class="hljs-string">"list_shop_customers_info"</span>,</span><br><span class="javascript">	   			data:&#123;<span class="hljs-attr">start</span>:startAllAppoint, <span class="hljs-attr">limit</span>:limitAllAppoint,<span class="hljs-attr">selectValue</span>:$(<span class="hljs-string">"#selectValue"</span>).val()&#125;,</span><br><span class="actionscript">	   			success:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data,status)</span></span>&#123;</span><br><span class="javascript">	   				data=<span class="hljs-built_in">eval</span>(<span class="hljs-string">"("</span>+data+<span class="hljs-string">")"</span>);</span><br>	   				getShopCustomesInfo(data.root);<br><span class="actionscript">	   				startAllAppoint = data.currentResult;<span class="hljs-comment">//当前页数(后台返回)</span></span><br><span class="actionscript">	   				dataLength  = data.total;<span class="hljs-comment">//数据总条数</span></span><br>	   			&#125;<br>	   		&#125;);<br>	   		<br>	   	&#125;<br>	   	<br>	   <br>	   	<br><span class="actionscript">	   	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getShopCustomesInfo</span><span class="hljs-params">(data)</span></span>&#123;</span><br><span class="handlebars"><span class="xml">	   		var s = "<span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>性别<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>电话<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>备案楼盘<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>已成交<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>归属经纪人<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>添加时间<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>";</span></span><br><span class="javascript">	   		$.each(data,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v,o</span>)</span>&#123;</span><br><span class="handlebars"><span class="xml">	   				s+='<span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>'+o.cusName+'<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>';</span></span><br><span class="actionscript">	   				s+=<span class="hljs-string">'&lt;td&gt;'</span>+o.cusSex+<span class="hljs-string">'&lt;/td&gt;'</span>;</span><br><span class="actionscript">	   				s+=<span class="hljs-string">'&lt;td&gt;'</span>+o.phone+<span class="hljs-string">'&lt;/td&gt;'</span>;</span><br><span class="actionscript">	   				s+=<span class="hljs-string">'&lt;td&gt;'</span>+o.records+<span class="hljs-string">'&lt;/td&gt;'</span>;</span><br><span class="actionscript">	   				s+=<span class="hljs-string">'&lt;td&gt;'</span>+o.alreadyDeal+<span class="hljs-string">'&lt;/td&gt;'</span>;</span><br><span class="actionscript">	   				s+=<span class="hljs-string">'&lt;td&gt;'</span>+o.theMedi+<span class="hljs-string">'&lt;/td&gt;'</span>;</span><br><span class="handlebars"><span class="xml">	   				s+='<span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>'+o.addTime+'<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>';</span></span><br>	   		&#125;);<br><br>	   		if(data.length&gt;0)&#123;<br><span class="javascript">	   			$(<span class="hljs-string">"#t_customerInfo"</span>).html(s);</span><br><span class="actionscript">	   		&#125;<span class="hljs-keyword">else</span>&#123;</span><br><span class="javascript">	   			$(<span class="hljs-string">"#page1"</span>).hide();</span><br><span class="handlebars"><span class="xml">	   			$("#t_customerInfo").html("<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'width:10%;height:30px;display:block;margin:0 auto;'</span>&gt;</span>暂无数据<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>");</span></span><br>	   		&#125;<br>	   		<br>	   		<br>	   	&#125;<br>   		<br>	   	<br>	   	<br><span class="actionscript">	   	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toPage</span><span class="hljs-params">()</span></span>&#123;</span><br>	   		<br><span class="actionscript">	   		layui.use([<span class="hljs-string">'form'</span>, <span class="hljs-string">'laypage'</span>, <span class="hljs-string">'layedit'</span>,<span class="hljs-string">'layer'</span>, <span class="hljs-string">'laydate'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="actionscript">				<span class="hljs-keyword">var</span> form = layui.form(),</span><br>					layer = layui.layer,<br>					layedit = layui.layedit,<br>					laydate = layui.laydate,<br>					laypage = layui.laypage;<br>				<br><span class="actionscript">				<span class="hljs-keyword">var</span> nums = <span class="hljs-number">10</span>;</span><br><span class="actionscript">				<span class="hljs-comment">//调用分页</span></span><br>				  laypage(&#123;<br><span class="actionscript">				    cont: <span class="hljs-string">'paged'</span></span><br><span class="actionscript">				    ,count: dataLength <span class="hljs-comment">//这个是后台返回的数据的总条数</span></span><br><span class="actionscript">				    ,limit: limitAllAppoint   <span class="hljs-comment">//每页显示的数据的条数,layui会根据count，limit进行分页的计算</span></span><br>				    ,curr: currentPageAllAppoint<br><span class="actionscript">				    ,skip: <span class="hljs-literal">true</span></span><br><span class="actionscript">				    ,jump: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, first)</span></span>&#123;</span><br>				    	<br>				    	currentPageAllAppoint = obj.curr;<br>				    	startAllAppoint = (obj.curr-1)*obj.limit;<br><span class="actionscript">				      <span class="hljs-comment">//document.getElementById('biuuu_city_list').innerHTML = render(obj, obj.curr);</span></span><br><span class="actionscript">				      <span class="hljs-keyword">if</span>(!first)&#123; <span class="hljs-comment">//一定要加此判断，否则初始时会无限刷新</span></span><br><span class="actionscript">				      getShopCustomerManagePageInfo();<span class="hljs-comment">//一定要把翻页的ajax请求放到这里，不然会请求两次。</span></span><br><span class="actionscript">				          <span class="hljs-comment">//location.href = '?page='+obj.curr;</span></span><br>				        &#125;<br>				    &#125;<br>				  &#125;);<br>				<br>				<br>			&#125;);<br>	   	&#125;;<br>	   	<br>   	<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"admin-main"</span>&gt;</span><br>	<br>	<br>				<span class="hljs-tag">&lt;<span class="hljs-name">blockquote</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-elem-quote"</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-form"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">""</span> &gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-form-item"</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-input-inline"</span>&gt;</span><br>					<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectValue"</span> <span class="hljs-attr">lay-verify</span>=<span class="hljs-string">"required"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"客户姓名，电话"</span> <span class="hljs-attr">autocomplete</span>=<span class="hljs-string">"off"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-input"</span>&gt;</span><br>			    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>			    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-btn"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectButton"</span>&gt;</span>搜索<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>				<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>				<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"shop_customer_manager_page_info"</span>&gt;</span>显示所有客户<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>				<span class="hljs-tag">&lt;/<span class="hljs-name">blockquote</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">fieldset</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-elem-field"</span>&gt;</span><br>					<span class="hljs-tag">&lt;<span class="hljs-name">legend</span>&gt;</span>客户列表<span class="hljs-tag">&lt;/<span class="hljs-name">legend</span>&gt;</span><br>					<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-field-box layui-form"</span>&gt;</span><br>						<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-table admin-table"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"t_customerInfo"</span>&gt;</span><br>							<br>						<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br>					<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>				<span class="hljs-tag">&lt;/<span class="hljs-name">fieldset</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"admin-table-page"</span>&gt;</span><br>					<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"paged"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page"</span>&gt;</span><br>					<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>				<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>			<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>	<br>   <br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="java代码："><a href="#java代码：" class="headerlink" title="java代码："></a>java代码：</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * shop 客户管理 list</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> start</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> limit</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> selectValue</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@ResponseBody</span><br>	<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/list_shop_customers_info"</span>)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">listShopCustomerInfo</span><span class="hljs-params">(Integer start, Integer limit, String selectValue)</span> </span>&#123;<br>		Page page = <span class="hljs-keyword">new</span> Page();<br>		page.setStart(start);<br>		page.setLimit(limit);<br>		<span class="hljs-comment">// 获取session中的用户信息</span><br>		User u = (User) <span class="hljs-keyword">this</span>.request.getSession().getAttribute(<span class="hljs-string">"userInfo"</span>);<br>		<span class="hljs-comment">// 获取持久化用户对象</span><br>		User user = userService.findById(u.getUserId());<br>		<span class="hljs-keyword">if</span> (user != <span class="hljs-keyword">null</span>) &#123;<br>			projectCustomerService.findShopCustomersByUser(user, selectValue, page);<br>			<span class="hljs-keyword">return</span> page;<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<h3 id="sevice层"><a href="#sevice层" class="headerlink" title="sevice层"></a>sevice层</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">findShopCustomersByUser</span><span class="hljs-params">(User user, String selectValue, Page page)</span> </span>&#123;<br>		List cmList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>		<span class="hljs-keyword">int</span> total = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">if</span>(user!=<span class="hljs-keyword">null</span> &amp;&amp; user.getParentId()!=<span class="hljs-keyword">null</span> &amp;&amp; !user.getParentId().equals(<span class="hljs-string">""</span>))&#123;<br>			String hql = <span class="hljs-string">"from ShopCustomers as model where model.shopId = "</span> + Integer.parseInt(user.getParentId());<br>			<span class="hljs-keyword">if</span>(selectValue!=<span class="hljs-keyword">null</span> &amp;&amp; !selectValue.equals(<span class="hljs-string">""</span>))&#123;<br>				hql+=<span class="hljs-string">"and model.shopCustomerName like '%"</span> +selectValue+<span class="hljs-string">"%' or model.shopCustomerPhone like '%"</span> +selectValue+<span class="hljs-string">"%'"</span>;<br>			&#125;<br>			List&lt;ShopCustomers&gt; list = baseDao.findByHql(hql,page.getStart(),page.getLimit());<br>			<span class="hljs-keyword">for</span>(ShopCustomers sc : list)&#123;<br>				User u = (User) baseDao.loadById(User<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">sc</span>.<span class="hljs-title">getUserId</span>())</span>;<br>				String cGRSHql = <span class="hljs-string">"select count(*) from GuideRecords where shopCustomerId = '"</span>+sc.getShopCustomerId()+<span class="hljs-string">"'"</span>;<br>				String cDealHql = <span class="hljs-string">"select count(*) from GuideRecords where shopCustomerId = '"</span>+sc.getShopCustomerId()+<span class="hljs-string">"' and isDeal = 1"</span>;<br>				<span class="hljs-keyword">int</span> floorCounts = baseDao.countQuery(cGRSHql);<span class="hljs-comment">//备案楼盘数</span><br>				<span class="hljs-keyword">int</span> dealCounts = baseDao.countQuery(cDealHql);<span class="hljs-comment">//已成交数</span><br>				CustomerManager cm = <span class="hljs-keyword">new</span> CustomerManager();<br>				CustomerManager cmObj = cm.createCusManObj(sc,u);<br>				cmObj.setRecords(floorCounts);<br>				cmObj.setAlreadyDeal(dealCounts);<br>				cmList.add(cmObj);<br>			&#125;<br>			String cHql = <span class="hljs-string">"select count(*) "</span>+hql;<br>			total = baseDao.countQuery(cHql);<br>		&#125;<br>		page.setRoot(cmList);<br>		page.setTotal(total);<br>	&#125;<br></code></pre></td></tr></table></figure>
<h3 id="分页对象"><a href="#分页对象" class="headerlink" title="分页对象"></a>分页对象</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sc.tradmaster.utils;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 分页对象</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> grl 2017-01-05</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page</span> </span>&#123;<br>	<span class="hljs-comment">/** 总记录数 */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> total;<br>	<span class="hljs-comment">/** 分页结果 */</span><br>	<span class="hljs-keyword">private</span> List root;<br>	<span class="hljs-comment">/** 开始页码 */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> start;<br>	<span class="hljs-comment">/** 每页多少 */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> limit;<br>	<span class="hljs-comment">/** 查询条件 */</span><br>	<span class="hljs-keyword">private</span> String wheres;<br>	<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> currentPage;	<span class="hljs-comment">//当前页</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> currentResult;	<span class="hljs-comment">//当前记录起始索引</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> totalPage;		<span class="hljs-comment">//总页数</span><br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getCurrentPage</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">if</span>(currentPage&lt;=<span class="hljs-number">0</span>)<br>			currentPage = <span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">return</span> currentPage;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCurrentPage</span><span class="hljs-params">(<span class="hljs-keyword">int</span> currentPage)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.currentPage = currentPage;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getCurrentResult</span><span class="hljs-params">()</span> </span>&#123;<br>		currentResult = (getCurrentPage()-<span class="hljs-number">1</span>)*getLimit();<br>		<span class="hljs-keyword">if</span>(currentResult&lt;<span class="hljs-number">0</span>)<br>			currentResult = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">return</span> currentResult;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCurrentResult</span><span class="hljs-params">(<span class="hljs-keyword">int</span> currentResult)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.currentResult = currentResult;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getTotalPage</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">if</span>(total%limit==<span class="hljs-number">0</span>)<br>			totalPage = total/limit;<br>		<span class="hljs-keyword">else</span><br>			totalPage = total/limit+<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">return</span> totalPage;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTotalPage</span><span class="hljs-params">(<span class="hljs-keyword">int</span> totalPage)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.totalPage = totalPage;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getTotal</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> total;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTotal</span><span class="hljs-params">(<span class="hljs-keyword">int</span> total)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.total = total;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> List <span class="hljs-title">getRoot</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> root;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setRoot</span><span class="hljs-params">(List root)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.root = root;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getStart</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> start;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStart</span><span class="hljs-params">(<span class="hljs-keyword">int</span> start)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.start = start;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getLimit</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> limit;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLimit</span><span class="hljs-params">(<span class="hljs-keyword">int</span> limit)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.limit = limit;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getWheres</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> wheres;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setWheres</span><span class="hljs-params">(String wheres)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.wheres = wheres;<br>	&#125;<br>	<br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> start+<span class="hljs-string">" "</span>+total +<span class="hljs-string">" "</span> +root;<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>


<p>如果遇到问题请联系我</p>
]]></content>
      <categories>
        <category>layui</category>
      </categories>
      <tags>
        <tag>layui</tag>
      </tags>
  </entry>
  <entry>
    <title>layui完美分页，ajax请求分页（真分页）</title>
    <url>/2017/10/25/layui-page-1.0/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046774388218.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p><strong>使用的layui版本为：layui-v1.0.9，现在新版本已经2.X了有些属性改变了，如果你的版本是2.0以上请参照我的博客：<a href="https://winterchens.github.io/2017/10/25/layui-page-2.0/" target="_blank" rel="noopener">《 layui完美分页，ajax请求分页（真分页） 【2.0版本】》</a></strong></p>
<a id="more"></a>

<p>这几天在工作当中需要使用分页控件，然后研究了一下layui的分页控件，这个控件页面非常简洁，功能齐全，而且可以通过异步进行数据的分页，如果大家遇到什么问题可以联系我 email：<a href="mailto:1085143002@qq.com">1085143002@qq.com</a></p>
<h3 id="完整代码："><a href="#完整代码：" class="headerlink" title="完整代码："></a>完整代码：</h3><figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">%@</span> <span class="hljs-attr">page</span> <span class="hljs-attr">language</span>=<span class="hljs-string">"java"</span> <span class="hljs-attr">contentType</span>=<span class="hljs-string">"text/html; charset=UTF-8"</span> <span class="hljs-attr">pageEncoding</span>=<span class="hljs-string">"UTF-8"</span>%&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"renderer"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"webkit"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge,chrome=1"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1, maximum-scale=1"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"apple-mobile-web-app-status-bar-style"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"black"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"apple-mobile-web-app-capable"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"yes"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"format-detection"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"telephone=no"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span>  <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"static/images/titleLogo.png"</span>  /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>门店管理后台<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"static/layui/plugins/layui/css/layui.css"</span> <span class="hljs-attr">media</span>=<span class="hljs-string">"all"</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;link rel="stylesheet" type="text/css" href="static/css/reset.css"&gt;</span><br><span class="hljs-comment">    &lt;link rel="stylesheet" type="text/css" href="static/css/commend.css"&gt; --&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;link rel="stylesheet" href="static/css/jqpagination.css" /&gt; --&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;link rel="stylesheet" type="text/css" href="static/css/shopCustomerManager.css"&gt; --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"static/js/jquery-3.1.1.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"static/layui/plugins/layui/layui.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;script type="text/javascript" src="static/js/jquery.jqpagination.js"&gt;&lt;/script&gt; --&gt;</span><br>   	<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><br><span class="javascript">	   	$(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;</span><br><span class="actionscript">	   		  <span class="hljs-comment">//ajax请求后台数据</span></span><br>		      getShopCustomerManagePageInfo();<br>		      <br>		<br><span class="actionscript">	   		  <span class="hljs-comment">//点击搜索时 搜索数据</span></span><br><span class="javascript">	   		  $(<span class="hljs-string">"#selectButton"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123; </span><br>	   			getShopCustomerManagePageInfo();<br><span class="actionscript">	   			currentPageAllAppoint = <span class="hljs-number">1</span>; <span class="hljs-comment">//当点击搜索的时候，应该回到第一页</span></span><br><span class="actionscript">	   			toPage();<span class="hljs-comment">//然后进行分页的初始化</span></span><br>	   			<br>	   	      &#125;)<br>	   	   toPage();<br>	   	&#125;);<br>	   	<br><span class="actionscript">	  	<span class="hljs-comment">//分页参数设置 这些全局变量关系到分页的功能</span></span><br><span class="actionscript">	   	<span class="hljs-keyword">var</span> startAllAppoint = <span class="hljs-number">0</span>;</span><br><span class="actionscript">	   	<span class="hljs-keyword">var</span> limitAllAppoint = <span class="hljs-number">10</span>;</span><br><span class="actionscript">	   	<span class="hljs-keyword">var</span> currentPageAllAppoint = <span class="hljs-number">1</span>;</span><br><span class="actionscript">	   	<span class="hljs-keyword">var</span> totalPageAllAppoint = <span class="hljs-number">0</span>;</span><br><span class="actionscript">	   	<span class="hljs-keyword">var</span> dataLength = <span class="hljs-number">0</span>;</span><br><span class="actionscript">	   	<span class="hljs-comment">//ajax请求后台数据</span></span><br><span class="actionscript">	   	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getShopCustomerManagePageInfo</span><span class="hljs-params">()</span></span>&#123;</span><br><span class="javascript">	   		$.ajax(&#123;</span><br><span class="actionscript">	   			type:<span class="hljs-string">"post"</span>,</span><br><span class="javascript">	   			<span class="hljs-keyword">async</span>:<span class="hljs-literal">false</span>,</span><br><span class="actionscript">	   			url:<span class="hljs-string">"list_shop_customers_info"</span>,</span><br><span class="javascript">	   			data:&#123;<span class="hljs-attr">start</span>:startAllAppoint, <span class="hljs-attr">limit</span>:limitAllAppoint,<span class="hljs-attr">selectValue</span>:$(<span class="hljs-string">"#selectValue"</span>).val()&#125;,</span><br><span class="actionscript">	   			success:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data,status)</span></span>&#123;</span><br><span class="javascript">	   				data=<span class="hljs-built_in">eval</span>(<span class="hljs-string">"("</span>+data+<span class="hljs-string">")"</span>);</span><br>	   				getShopCustomesInfo(data.root);<br><span class="actionscript">	   				startAllAppoint = data.currentResult;<span class="hljs-comment">//当前页数(后台返回)</span></span><br><span class="actionscript">	   				totalPageAllAppoint = data.totalPage;<span class="hljs-comment">//总页数(后台返回)</span></span><br>	   				<br>	   			&#125;<br>	   		&#125;);<br>	   		<br>	   	&#125;<br>	   	<br>	   <br>	   	<br><span class="actionscript">	   	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getShopCustomesInfo</span><span class="hljs-params">(data)</span></span>&#123;</span><br><span class="handlebars"><span class="xml">	   		var s = "<span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>性别<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>电话<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>备案楼盘<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>已成交<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>归属经纪人<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>添加时间<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>";</span></span><br><span class="javascript">	   		$.each(data,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v,o</span>)</span>&#123;</span><br><span class="handlebars"><span class="xml">	   				s+='<span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>'+o.cusName+'<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>';</span></span><br><span class="actionscript">	   				s+=<span class="hljs-string">'&lt;td&gt;'</span>+o.cusSex+<span class="hljs-string">'&lt;/td&gt;'</span>;</span><br><span class="actionscript">	   				s+=<span class="hljs-string">'&lt;td&gt;'</span>+o.phone+<span class="hljs-string">'&lt;/td&gt;'</span>;</span><br><span class="actionscript">	   				s+=<span class="hljs-string">'&lt;td&gt;'</span>+o.records+<span class="hljs-string">'&lt;/td&gt;'</span>;</span><br><span class="actionscript">	   				s+=<span class="hljs-string">'&lt;td&gt;'</span>+o.alreadyDeal+<span class="hljs-string">'&lt;/td&gt;'</span>;</span><br><span class="actionscript">	   				s+=<span class="hljs-string">'&lt;td&gt;'</span>+o.theMedi+<span class="hljs-string">'&lt;/td&gt;'</span>;</span><br><span class="handlebars"><span class="xml">	   				s+='<span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>'+o.addTime+'<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>';</span></span><br>	   		&#125;);<br><br>	   		if(data.length&gt;0)&#123;<br><span class="javascript">	   			$(<span class="hljs-string">"#t_customerInfo"</span>).html(s);</span><br><span class="actionscript">	   		&#125;<span class="hljs-keyword">else</span>&#123;</span><br><span class="javascript">	   			$(<span class="hljs-string">"#page1"</span>).hide();</span><br><span class="handlebars"><span class="xml">	   			$("#t_customerInfo").html("<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'width:10%;height:30px;display:block;margin:0 auto;'</span>&gt;</span>暂无数据<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>");</span></span><br>	   		&#125;<br>	   		<br>	   		<br>	   	&#125;<br>   		<br>	   	<br>	   	<br><span class="actionscript">	   	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toPage</span><span class="hljs-params">()</span></span>&#123;</span><br>	   		<br><span class="actionscript">	   		layui.use([<span class="hljs-string">'form'</span>, <span class="hljs-string">'laypage'</span>, <span class="hljs-string">'layedit'</span>,<span class="hljs-string">'layer'</span>, <span class="hljs-string">'laydate'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="actionscript">				<span class="hljs-keyword">var</span> form = layui.form(),</span><br>					layer = layui.layer,<br>					layedit = layui.layedit,<br>					laydate = layui.laydate,<br>					laypage = layui.laypage;<br>				<br><span class="actionscript">				<span class="hljs-keyword">var</span> nums = <span class="hljs-number">10</span>;</span><br><span class="actionscript">				<span class="hljs-comment">//调用分页</span></span><br>				  laypage(&#123;<br><span class="actionscript">				    cont: <span class="hljs-string">'paged'</span></span><br><span class="actionscript">				    ,pages: totalPageAllAppoint <span class="hljs-comment">//得到总页数，在layui2.X中使用count替代了，并且不是使用"总页数"，而是"总记录条数"</span></span><br>				    ,curr: currentPageAllAppoint<br><span class="actionscript">				    ,skip: <span class="hljs-literal">true</span></span><br><span class="actionscript">				    ,jump: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, first)</span></span>&#123;</span><br>				    	<br>				    	currentPageAllAppoint = obj.curr;<br>				    	startAllAppoint = (obj.curr-1)*limitAllAppoint;<br><span class="actionscript">				      <span class="hljs-comment">//document.getElementById('biuuu_city_list').innerHTML = render(obj, obj.curr);</span></span><br><span class="actionscript">				      <span class="hljs-keyword">if</span>(!first)&#123; <span class="hljs-comment">//一定要加此判断，否则初始时会无限刷新</span></span><br><span class="actionscript">				      getShopCustomerManagePageInfo();<span class="hljs-comment">//一定要把翻页的ajax请求放到这里，不然会请求两次。</span></span><br><span class="actionscript">				          <span class="hljs-comment">//location.href = '?page='+obj.curr;</span></span><br>				        &#125;<br>				    &#125;<br>				  &#125;);<br>				<br>				<br>			&#125;);<br>	   	&#125;;<br>	   	<br>   	<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"admin-main"</span>&gt;</span><br>	<br>	<br>				<span class="hljs-tag">&lt;<span class="hljs-name">blockquote</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-elem-quote"</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-form"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">""</span> &gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-form-item"</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-input-inline"</span>&gt;</span><br>					<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectValue"</span> <span class="hljs-attr">lay-verify</span>=<span class="hljs-string">"required"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"客户姓名，电话"</span> <span class="hljs-attr">autocomplete</span>=<span class="hljs-string">"off"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-input"</span>&gt;</span><br>			    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>			    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-btn"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectButton"</span>&gt;</span>搜索<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>				<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>				<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"shop_customer_manager_page_info"</span>&gt;</span>显示所有客户<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>				<span class="hljs-tag">&lt;/<span class="hljs-name">blockquote</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">fieldset</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-elem-field"</span>&gt;</span><br>					<span class="hljs-tag">&lt;<span class="hljs-name">legend</span>&gt;</span>客户列表<span class="hljs-tag">&lt;/<span class="hljs-name">legend</span>&gt;</span><br>					<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-field-box layui-form"</span>&gt;</span><br>						<span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layui-table admin-table"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"t_customerInfo"</span>&gt;</span><br>							<br>						<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br>					<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>				<span class="hljs-tag">&lt;/<span class="hljs-name">fieldset</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"admin-table-page"</span>&gt;</span><br>					<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"paged"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page"</span>&gt;</span><br>					<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>				<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>			<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>	<br>   <br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="java代码："><a href="#java代码：" class="headerlink" title="java代码："></a>java代码：</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * shop 客户管理 list</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> start</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> limit</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> selectValue</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@ResponseBody</span><br>	<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/list_shop_customers_info"</span>)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">listShopCustomerInfo</span><span class="hljs-params">(Integer start, Integer limit, String selectValue)</span> </span>&#123;<br>		Page page = <span class="hljs-keyword">new</span> Page();<br>		page.setStart(start);<br>		page.setLimit(limit);<br>		<span class="hljs-comment">// 获取session中的用户信息</span><br>		User u = (User) <span class="hljs-keyword">this</span>.request.getSession().getAttribute(<span class="hljs-string">"userInfo"</span>);<br>		<span class="hljs-comment">// 获取持久化用户对象</span><br>		User user = userService.findById(u.getUserId());<br>		<span class="hljs-keyword">if</span> (user != <span class="hljs-keyword">null</span>) &#123;<br>			projectCustomerService.findShopCustomersByUser(user, selectValue, page);<br>			<span class="hljs-keyword">return</span> page;<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<h3 id="sevice层"><a href="#sevice层" class="headerlink" title="sevice层"></a>sevice层</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">findShopCustomersByUser</span><span class="hljs-params">(User user, String selectValue, Page page)</span> </span>&#123;<br>		List cmList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>		<span class="hljs-keyword">int</span> total = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">if</span>(user!=<span class="hljs-keyword">null</span> &amp;&amp; user.getParentId()!=<span class="hljs-keyword">null</span> &amp;&amp; !user.getParentId().equals(<span class="hljs-string">""</span>))&#123;<br>			String hql = <span class="hljs-string">"from ShopCustomers as model where model.shopId = "</span> + Integer.parseInt(user.getParentId());<br>			<span class="hljs-keyword">if</span>(selectValue!=<span class="hljs-keyword">null</span> &amp;&amp; !selectValue.equals(<span class="hljs-string">""</span>))&#123;<br>				hql+=<span class="hljs-string">"and model.shopCustomerName like '%"</span> +selectValue+<span class="hljs-string">"%' or model.shopCustomerPhone like '%"</span> +selectValue+<span class="hljs-string">"%'"</span>;<br>			&#125;<br>			List&lt;ShopCustomers&gt; list = baseDao.findByHql(hql,page.getStart(),page.getLimit());<br>			<span class="hljs-keyword">for</span>(ShopCustomers sc : list)&#123;<br>				User u = (User) baseDao.loadById(User<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">sc</span>.<span class="hljs-title">getUserId</span>())</span>;<br>				String cGRSHql = <span class="hljs-string">"select count(*) from GuideRecords where shopCustomerId = '"</span>+sc.getShopCustomerId()+<span class="hljs-string">"'"</span>;<br>				String cDealHql = <span class="hljs-string">"select count(*) from GuideRecords where shopCustomerId = '"</span>+sc.getShopCustomerId()+<span class="hljs-string">"' and isDeal = 1"</span>;<br>				<span class="hljs-keyword">int</span> floorCounts = baseDao.countQuery(cGRSHql);<span class="hljs-comment">//备案楼盘数</span><br>				<span class="hljs-keyword">int</span> dealCounts = baseDao.countQuery(cDealHql);<span class="hljs-comment">//已成交数</span><br>				CustomerManager cm = <span class="hljs-keyword">new</span> CustomerManager();<br>				CustomerManager cmObj = cm.createCusManObj(sc,u);<br>				cmObj.setRecords(floorCounts);<br>				cmObj.setAlreadyDeal(dealCounts);<br>				cmList.add(cmObj);<br>			&#125;<br>			String cHql = <span class="hljs-string">"select count(*) "</span>+hql;<br>			total = baseDao.countQuery(cHql);<br>		&#125;<br>		page.setRoot(cmList);<br>		page.setTotal(total);<br>	&#125;<br></code></pre></td></tr></table></figure>
<h3 id="分页对象"><a href="#分页对象" class="headerlink" title="分页对象"></a>分页对象</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sc.tradmaster.utils;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 分页对象</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> grl 2017-01-05</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page</span> </span>&#123;<br>	<span class="hljs-comment">/** 总记录数 */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> total;<br>	<span class="hljs-comment">/** 分页结果 */</span><br>	<span class="hljs-keyword">private</span> List root;<br>	<span class="hljs-comment">/** 开始页码 */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> start;<br>	<span class="hljs-comment">/** 每页多少 */</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> limit;<br>	<span class="hljs-comment">/** 查询条件 */</span><br>	<span class="hljs-keyword">private</span> String wheres;<br>	<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> currentPage;	<span class="hljs-comment">//当前页</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> currentResult;	<span class="hljs-comment">//当前记录起始索引</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> totalPage;		<span class="hljs-comment">//总页数</span><br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getCurrentPage</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">if</span>(currentPage&lt;=<span class="hljs-number">0</span>)<br>			currentPage = <span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">return</span> currentPage;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCurrentPage</span><span class="hljs-params">(<span class="hljs-keyword">int</span> currentPage)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.currentPage = currentPage;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getCurrentResult</span><span class="hljs-params">()</span> </span>&#123;<br>		currentResult = (getCurrentPage()-<span class="hljs-number">1</span>)*getLimit();<br>		<span class="hljs-keyword">if</span>(currentResult&lt;<span class="hljs-number">0</span>)<br>			currentResult = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">return</span> currentResult;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCurrentResult</span><span class="hljs-params">(<span class="hljs-keyword">int</span> currentResult)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.currentResult = currentResult;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getTotalPage</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">if</span>(total%limit==<span class="hljs-number">0</span>)<br>			totalPage = total/limit;<br>		<span class="hljs-keyword">else</span><br>			totalPage = total/limit+<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">return</span> totalPage;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTotalPage</span><span class="hljs-params">(<span class="hljs-keyword">int</span> totalPage)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.totalPage = totalPage;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getTotal</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> total;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTotal</span><span class="hljs-params">(<span class="hljs-keyword">int</span> total)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.total = total;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> List <span class="hljs-title">getRoot</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> root;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setRoot</span><span class="hljs-params">(List root)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.root = root;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getStart</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> start;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStart</span><span class="hljs-params">(<span class="hljs-keyword">int</span> start)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.start = start;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getLimit</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> limit;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLimit</span><span class="hljs-params">(<span class="hljs-keyword">int</span> limit)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.limit = limit;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getWheres</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> wheres;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setWheres</span><span class="hljs-params">(String wheres)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.wheres = wheres;<br>	&#125;<br>	<br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> start+<span class="hljs-string">" "</span>+total +<span class="hljs-string">" "</span> +root;<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>layui</category>
      </categories>
      <tags>
        <tag>layui</tag>
      </tags>
  </entry>
  <entry>
    <title>Java导出Excel文档（poi），并上传到腾讯云对象存储服务器</title>
    <url>/2017/10/21/java-make-excel-poi-to-upload-cloud/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046771909687.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p><strong>后台生成周报月报季报年报Excel，将文件下载链接推送给对应客户</strong></p>
<a id="more"></a>

<h3 id="开发思路："><a href="#开发思路：" class="headerlink" title="开发思路："></a>开发思路：</h3><p><strong>1.根据选定日期生成周报，月报，季报，年报数据</strong><br><strong>2.将这些数据报告生成Excel表格</strong><br><strong>3.把生成的文件上传到腾讯云对象存储服务器</strong><br><strong>4.将服务器返回的url存储到数据库</strong></p>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><p><strong><a href="http://download.csdn.net/download/yaosir12/9475344" target="_blank" rel="noopener">poi-3.14-20160307.jar(点击可下载)</a></strong></p>
<h3 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h3><p>获取数据部分省略了</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p><strong>主方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">addReportExcelToCloud</span><span class="hljs-params">(ReportResult rr)</span> </span>&#123;<br><br>		OutputStream out = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>		ExcelProjectUtils eu = <span class="hljs-keyword">new</span> ExcelProjectUtils();<br>		eu.exportExcel(rr, out);   <span class="hljs-comment">//&lt;1&gt;</span><br>		ConvertUtil cu = <span class="hljs-keyword">new</span> ConvertUtil();<br>		<span class="hljs-keyword">try</span> &#123;<br>			ByteArrayInputStream byteInput = cu.parse(out);<br>			String rs = PicUploadToYun.uploadExcel(SysContent.getFileRename(<span class="hljs-string">"案场数据报.xls"</span>), byteInput);  <span class="hljs-comment">//&lt;2&gt;</span><br>			addReportExcelToDB(rr, rs);  <span class="hljs-comment">//&lt;3&gt;</span><br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>		&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>			e.printStackTrace();<br>		&#125;<br><br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>	&#125;<br></code></pre></td></tr></table></figure>
<p>&lt;1&gt; 将数据生成二进制Excel文件 (方法详细见下面代码)<br>&lt;2&gt; 将生成的二进制文件上传到腾讯云对象存储服务器 (方法详细见下面代码)<br>&lt;3&gt; 将服务器返回的url存储到数据库 (方法详细见下面代码)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 周报年报生成excel</span><br><span class="hljs-comment">	 * </span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> report</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> out</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exportExcel</span><span class="hljs-params">(ReportResult report, OutputStream out)</span> </span>&#123;<br><br>		<span class="hljs-comment">// 判断传入的时间间隔</span><br>		String dateStr = <span class="hljs-string">""</span>;<br>		String reportName = <span class="hljs-string">""</span>;<br>		List&lt;String&gt; dateCount = DateUtil.getTwoDateEveryDay(report.getStartTime(), report.getEndTime());<br>		<span class="hljs-keyword">if</span> (dateCount.size() &lt;= <span class="hljs-number">7</span>) &#123;<br>			dateStr += <span class="hljs-string">"本周"</span>;<br>			reportName += <span class="hljs-string">"案场周报"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dateCount.size() &gt;= <span class="hljs-number">28</span> &amp;&amp; dateCount.size() &lt;= <span class="hljs-number">31</span>) &#123;<br>			dateStr += <span class="hljs-string">"本月"</span>;<br>			reportName += <span class="hljs-string">"案场月报"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dateCount.size() &gt;= <span class="hljs-number">85</span> &amp;&amp; dateCount.size() &lt;= <span class="hljs-number">100</span>) &#123;<br>			dateStr += <span class="hljs-string">"本季度"</span>;<br>			reportName += <span class="hljs-string">"案场季报"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dateCount.size() &gt;= <span class="hljs-number">180</span> &amp;&amp; dateCount.size() &lt;= <span class="hljs-number">185</span>) &#123;<br>			dateStr += <span class="hljs-string">"本半年度"</span>;<br>			reportName += <span class="hljs-string">"案场半年报"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dateCount.size() &gt;= <span class="hljs-number">360</span> &amp;&amp; dateCount.size() &lt;= <span class="hljs-number">367</span>) &#123;<br>			dateStr += <span class="hljs-string">"本年度"</span>;<br>			reportName += <span class="hljs-string">"案场年报"</span>;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			dateStr += <span class="hljs-string">"时间段内"</span>;<br>			reportName += <span class="hljs-string">"案场阶段报"</span>;<br>		&#125;<br>		report.setReportName(reportName);<br>		<span class="hljs-comment">// 声明一个工作薄</span><br>		HSSFWorkbook workbook = <span class="hljs-keyword">new</span> HSSFWorkbook();<br>		<span class="hljs-comment">// 生成一个表格</span><br>		HSSFSheet sheet = workbook.createSheet(report.getReportName() + report.getStartTime() + <span class="hljs-string">" - "</span> + report.getEndTime());<br>		<span class="hljs-comment">// 设置表格默认列宽度为100个字节</span><br>		sheet.setDefaultColumnWidth((<span class="hljs-keyword">short</span>) <span class="hljs-number">100</span>);<br>		<span class="hljs-comment">/** ----------样式一：标题 ------------ **/</span><br>		HSSFCellStyle style = workbook.createCellStyle();<br>		<span class="hljs-comment">// 设置这些样式</span><br>		style.setBorderLeft(HSSFCellStyle.BORDER_THIN);<br>		style.setBorderRight(HSSFCellStyle.BORDER_THIN);<br>		<span class="hljs-comment">//style.setBorderTop(HSSFCellStyle.BORDER_THIN);</span><br>		style.setAlignment(HSSFCellStyle.ALIGN_CENTER);<br>		<span class="hljs-comment">// 生成一个字体</span><br>		HSSFFont font = workbook.createFont();<br>		font.setFontName(<span class="hljs-string">"宋体"</span>);<br>		<span class="hljs-comment">//font.setColor(HSSFColor.VIOLET.index);</span><br>		font.setFontHeightInPoints((<span class="hljs-keyword">short</span>) <span class="hljs-number">14</span>);<br>		font.setBoldweight(HSSFFont.BOLDWEIGHT_BOLD);<br>		<span class="hljs-comment">// 把字体应用到当前的样式</span><br>		style.setFont(font);<br>		<span class="hljs-comment">/***---------样式二：小标题---------***/</span><br>		HSSFCellStyle style2 = workbook.createCellStyle();<br>		style2.setBorderLeft(HSSFCellStyle.BORDER_THIN);<br>		style2.setBorderRight(HSSFCellStyle.BORDER_THIN);<br>		<span class="hljs-comment">//style2.setBorderTop(HSSFCellStyle.BORDER_THIN);</span><br>		style2.setAlignment(HSSFCellStyle.ALIGN_LEFT);<br>		<br>		<span class="hljs-comment">//style2.setVerticalAlignment(HSSFCellStyle.VERTICAL_CENTER);</span><br>		<span class="hljs-comment">// 生成另一个字体</span><br>		HSSFFont font2 = workbook.createFont();<br>		<span class="hljs-comment">//font2.setBoldweight(HSSFFont.BOLDWEIGHT_NORMAL);</span><br>		font2.setFontName(<span class="hljs-string">"宋体"</span>);<br>		font2.setFontHeightInPoints((<span class="hljs-keyword">short</span>) <span class="hljs-number">11</span>);<br>		font2.setBoldweight(HSSFFont.BOLDWEIGHT_BOLD);<br>		<span class="hljs-comment">// 把字体应用到当前的样式</span><br>		style2.setFont(font2);<br>		<br>		<span class="hljs-comment">/***    样式三：右侧日期       ***/</span><br>		HSSFCellStyle style3 = workbook.createCellStyle();<br>		<span class="hljs-comment">//样式</span><br>		style3.setBorderLeft(HSSFCellStyle.BORDER_THIN);<br>		style3.setBorderRight(HSSFCellStyle.BORDER_THIN);<br>		style3.setAlignment(HSSFCellStyle.ALIGN_RIGHT);<br>		style3.setBorderBottom(HSSFCellStyle.BORDER_THIN);<br>		<span class="hljs-comment">//字体</span><br>		HSSFFont font3 = workbook.createFont();<br>		font3.setFontName(<span class="hljs-string">"宋体"</span>);<br>		font3.setFontHeightInPoints((<span class="hljs-keyword">short</span>) <span class="hljs-number">11</span>);<br>		style3.setFont(font3);<br>		<br>		<span class="hljs-comment">/**       样式四：主内容        ***/</span><br>		HSSFCellStyle style4 = workbook.createCellStyle();<br>		<span class="hljs-comment">//样式</span><br>		style4.setBorderLeft(HSSFCellStyle.BORDER_THIN);<br>		style4.setBorderRight(HSSFCellStyle.BORDER_THIN);<br>		style4.setAlignment(HSSFCellStyle.ALIGN_LEFT);<br>		<span class="hljs-comment">//字体</span><br>		HSSFFont font4 = workbook.createFont();<br>		font4.setFontName(<span class="hljs-string">"宋体"</span>);<br>		font4.setFontHeightInPoints((<span class="hljs-keyword">short</span>) <span class="hljs-number">11</span>);<br>		style4.setFont(font4);<br>		<br>		<span class="hljs-comment">/**       样式五：底侧空内容       ***/</span><br>		HSSFCellStyle style5 = workbook.createCellStyle();<br>		<span class="hljs-comment">//样式</span><br>		style5.setBorderLeft(HSSFCellStyle.BORDER_THIN);<br>		style5.setBorderRight(HSSFCellStyle.BORDER_THIN);<br>		style5.setAlignment(HSSFCellStyle.ALIGN_LEFT);<br>		style5.setBorderBottom(HSSFCellStyle.BORDER_THIN);<br>		<span class="hljs-comment">//字体</span><br>		HSSFFont font5 = workbook.createFont();<br>		font5.setFontName(<span class="hljs-string">"宋体"</span>);<br>		font5.setFontHeightInPoints((<span class="hljs-keyword">short</span>) <span class="hljs-number">11</span>);<br>		style5.setFont(font5);<br>		<br>		<br>		<span class="hljs-comment">// 声明一个画图的顶级管理器</span><br>		HSSFPatriarch patriarch = sheet.createDrawingPatriarch();<br>		<span class="hljs-comment">// 定义注释的大小和位置,详见文档</span><br>		HSSFComment comment = patriarch.createComment(<span class="hljs-keyword">new</span> HSSFClientAnchor(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, (<span class="hljs-keyword">short</span>) <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, (<span class="hljs-keyword">short</span>) <span class="hljs-number">6</span>, <span class="hljs-number">5</span>));<br>		<span class="hljs-comment">// 设置注释内容</span><br>		comment.setString(<span class="hljs-keyword">new</span> HSSFRichTextString(<span class="hljs-string">"数据报"</span>));<br>		<span class="hljs-comment">// 设置注释作者，当鼠标移动到单元格上是可以在状态栏中看到该内容.</span><br>		comment.setAuthor(<span class="hljs-string">"saas"</span>);<br><br>		<span class="hljs-comment">// 产生表格标题行 -- 项目名称</span><br>		HSSFRow row = sheet.createRow(<span class="hljs-number">0</span>);<br>		createCellAndRow(style4, report.getProjectName(), row);<br><br>		<span class="hljs-comment">// 产生表格标题行 -- 周报名称</span><br>		row = sheet.createRow(<span class="hljs-number">1</span>);<br>		createCellAndRow(style, report.getReportName(), row);<br><br>		<span class="hljs-comment">// 产生表格标题行 -- 起始时间-终止时间</span><br>		row = sheet.createRow(<span class="hljs-number">2</span>);<br>		String startTime = DateUtil.format(DateUtil.parse(report.getStartTime(), DateUtil.PATTERN_CLASSICAL_SIMPLE),<br>				DateUtil.PATTERN_CLASSICAL_SIMPLE_YMD);<br>		String endTime = DateUtil.format(DateUtil.parse(report.getEndTime(), DateUtil.PATTERN_CLASSICAL_SIMPLE),<br>				DateUtil.PATTERN_CLASSICAL_SIMPLE_YMD);<br>		String date = <span class="hljs-string">"日期："</span> + startTime + <span class="hljs-string">" - "</span> + endTime;<br>		createCellAndRow(style3, date, row);<br><br>		<span class="hljs-comment">// 接访情况标题</span><br>		row = sheet.createRow(<span class="hljs-number">3</span>);<br>		createCellAndRow(style2, <span class="hljs-string">"·接访情况"</span>, row);<br><br>		<span class="hljs-comment">// 接访客户组数</span><br>		row = sheet.createRow(<span class="hljs-number">4</span>);<br>		Integer visitCount = report.getVisitCount();<br>		String visitNum = <span class="hljs-string">"1、"</span> + dateStr + <span class="hljs-string">"共计接访客户"</span> + visitCount + <span class="hljs-string">"组，来访量"</span>;<br>		<span class="hljs-keyword">if</span> (visitCount &lt; <span class="hljs-number">40</span>) &#123;<br>			visitNum += <span class="hljs-string">"较少，有待提升"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (visitCount &gt;= <span class="hljs-number">41</span> &amp;&amp; visitCount &lt;= <span class="hljs-number">99</span>) &#123;<br>			visitNum += <span class="hljs-string">"尚可，还有提高空间"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (visitCount &gt;= <span class="hljs-number">100</span> &amp;&amp; visitCount &lt;= <span class="hljs-number">139</span>) &#123;<br>			visitNum += <span class="hljs-string">"很多"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (visitCount &gt; <span class="hljs-number">140</span>) &#123;<br>			visitNum += <span class="hljs-string">"火爆"</span>;<br>		&#125;<br>		createCellAndRow(style4, visitNum, row);<br><br>		<span class="hljs-comment">// 有效接访率</span><br>		row = sheet.createRow(<span class="hljs-number">5</span>);<br>		Double visitRate = <span class="hljs-keyword">new</span> Double(report.getValidVisitRate());<br>		String visitRateStr = <span class="hljs-string">"2、有效接访率为"</span> + visitRate + <span class="hljs-string">"%，接访成效"</span>;<br>		<span class="hljs-keyword">if</span> (visitRate &lt; <span class="hljs-number">50</span>) &#123;<br>			visitRateStr += <span class="hljs-string">"较低，有待提升"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (visitRate &gt;= <span class="hljs-number">50</span> &amp;&amp; visitRate &lt;= <span class="hljs-number">65</span>) &#123;<br>			visitRateStr += <span class="hljs-string">"尚可，还有提高空间"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (visitRate &gt;= <span class="hljs-number">65</span> &amp;&amp; visitRate &lt;= <span class="hljs-number">80</span>) &#123;<br>			visitRateStr += <span class="hljs-string">"很高"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (visitRate &gt; <span class="hljs-number">80</span>) &#123;<br>			visitRateStr += <span class="hljs-string">"极高"</span>;<br>		&#125;<br>		createCellAndRow(style4, visitRateStr, row);<br><br>		<span class="hljs-comment">// 首访有效率</span><br>		row = sheet.createRow(<span class="hljs-number">6</span>);<br>		Double newVisitRate = <span class="hljs-keyword">new</span> Double(report.getValidNewCuVisitRate());<br>		String newVisitStr = <span class="hljs-string">"3、首访有效率为"</span> + newVisitRate + <span class="hljs-string">"%，来访转储客的概率"</span>;<br>		<span class="hljs-keyword">if</span> (newVisitRate &lt; <span class="hljs-number">40</span>) &#123;<br>			newVisitStr += <span class="hljs-string">"较差，有待提升"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newVisitRate &gt;= <span class="hljs-number">40</span> &amp;&amp; newVisitRate &lt;= <span class="hljs-number">60</span>) &#123;<br>			newVisitStr += <span class="hljs-string">"尚可，还有提高空间"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newVisitRate &gt;= <span class="hljs-number">60</span> &amp;&amp; newVisitRate &lt;= <span class="hljs-number">75</span>) &#123;<br>			newVisitStr += <span class="hljs-string">"很高"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newVisitRate &gt; <span class="hljs-number">75</span>) &#123;<br>			newVisitStr += <span class="hljs-string">"极高"</span>;<br>		&#125;<br>		createCellAndRow(style4, newVisitStr, row);<br><br>		<span class="hljs-comment">// 老客户接访占比</span><br>		row = sheet.createRow(<span class="hljs-number">7</span>);<br>		Double oldVisitRate = <span class="hljs-keyword">new</span> Double(report.getOldCuVisitRate());<br>		String oldVisitStr = <span class="hljs-string">"4、老客户接访比为"</span> + oldVisitRate + <span class="hljs-string">"%，老客户接访的占比"</span>;<br>		<span class="hljs-keyword">if</span> (oldVisitRate &lt; <span class="hljs-number">20</span>) &#123;<br>			oldVisitStr += <span class="hljs-string">"较低"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldVisitRate &gt;= <span class="hljs-number">20</span> &amp;&amp; oldVisitRate &lt;= <span class="hljs-number">40</span>) &#123;<br>			oldVisitStr += <span class="hljs-string">"尚可"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldVisitRate &gt;= <span class="hljs-number">40</span> &amp;&amp; oldVisitRate &lt;= <span class="hljs-number">60</span>) &#123;<br>			oldVisitStr += <span class="hljs-string">"很高"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldVisitRate &gt; <span class="hljs-number">60</span>) &#123;<br>			oldVisitStr += <span class="hljs-string">"极高"</span>;<br>		&#125;<br>		createCellAndRow(style4, oldVisitStr, row);<br><br>		<span class="hljs-comment">//空行</span><br>		row = sheet.createRow(<span class="hljs-number">8</span>);<br>		createCellAndRow(style4, <span class="hljs-string">""</span>, row);<br>		<br>		<span class="hljs-comment">// 储客情况</span><br>		row = sheet.createRow(<span class="hljs-number">9</span>);<br>		createCellAndRow(style2, <span class="hljs-string">"·储客情况"</span>, row);<br><br>		<span class="hljs-comment">// 新增储客</span><br>		row = sheet.createRow(<span class="hljs-number">10</span>);<br>		Integer newCuCount = report.getNewCuCount();<br>		String newCuStr = <span class="hljs-string">"1、"</span> + dateStr + <span class="hljs-string">"新增储客"</span> + newCuCount + <span class="hljs-string">"组，新增量"</span>;<br>		<span class="hljs-keyword">if</span> (newCuCount &lt; <span class="hljs-number">30</span>) &#123;<br>			newCuStr += <span class="hljs-string">"较少，有待提升"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newCuCount &gt;= <span class="hljs-number">31</span> &amp;&amp; newCuCount &lt;= <span class="hljs-number">60</span>) &#123;<br>			newCuStr += <span class="hljs-string">"尚可，还有提高空间"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newCuCount &gt;= <span class="hljs-number">61</span> &amp;&amp; newCuCount &lt;= <span class="hljs-number">79</span>) &#123;<br>			newCuStr += <span class="hljs-string">"很多"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newCuCount &gt; <span class="hljs-number">80</span>) &#123;<br>			newCuStr += <span class="hljs-string">"爆满"</span>;<br>		&#125;<br>		createCellAndRow(style4, newCuStr, row);<br><br>		<span class="hljs-comment">// 累计老客户</span><br>		row = sheet.createRow(<span class="hljs-number">11</span>);<br>		Integer oldCuCount = report.getTotalOldCuCount();<br>		Integer totalCuCount = report.getTotalCuCount();<br>		Double oldCuRate = <span class="hljs-keyword">new</span> Double(SysContent.getTwoNumberForValue(oldCuCount, totalCuCount));<br>		String oldCuStr = <span class="hljs-string">"2、累计老客户总量为"</span> + oldCuCount + <span class="hljs-string">"组，老客户占比为"</span> + oldCuRate + <span class="hljs-string">"%，显示老客户关注度"</span>;<br>		<span class="hljs-keyword">if</span> (oldCuRate &lt; <span class="hljs-number">15</span>) &#123;<br>			oldCuStr += <span class="hljs-string">"较低，有待提升"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldCuRate &gt;= <span class="hljs-number">15</span> &amp;&amp; oldCuRate &lt;= <span class="hljs-number">25</span>) &#123;<br>			oldCuStr += <span class="hljs-string">"尚可，还有提高空间"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldCuRate &gt;= <span class="hljs-number">25</span> &amp;&amp; oldCuRate &lt;= <span class="hljs-number">40</span>) &#123;<br>			oldCuStr += <span class="hljs-string">"很高"</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldCuRate &gt; <span class="hljs-number">40</span>) &#123;<br>			oldCuStr += <span class="hljs-string">"极高"</span>;<br>		&#125;<br>		createCellAndRow(style4, oldCuStr, row);<br><br>		<span class="hljs-comment">// 累计总储客</span><br>		row = sheet.createRow(<span class="hljs-number">12</span>);<br>		String totalOldCuStr = <span class="hljs-string">"3、累计总储客"</span> + totalCuCount + <span class="hljs-string">"组"</span>;<br>		createCellAndRow(style4, totalOldCuStr, row);<br><br>		<span class="hljs-comment">// 成交情况(周报没有，其他有)</span><br>		<span class="hljs-keyword">if</span> (report.getSubscribeHouseCount() != <span class="hljs-keyword">null</span>) &#123;<br>			<br>			<span class="hljs-comment">//空行</span><br>			row = sheet.createRow(<span class="hljs-number">13</span>);<br>			createCellAndRow(style4, <span class="hljs-string">""</span>, row);<br>			<br>			row = sheet.createRow(<span class="hljs-number">14</span>);<br>			createCellAndRow(style2, <span class="hljs-string">"·成交情况"</span>, row);<br><br>			<span class="hljs-comment">// 新增认购套数</span><br>			row = sheet.createRow(<span class="hljs-number">15</span>);<br>			Integer subscribeHouseCount = report.getSubscribeHouseCount();<br>			Double subscribeHouseRate = <span class="hljs-keyword">new</span> Double(report.getSubscribeHouseRate());<br>			String subscribeHouseStr = <span class="hljs-string">"1、"</span> + dateStr + <span class="hljs-string">"新增认购套数"</span> + subscribeHouseCount + <span class="hljs-string">"套，较"</span> + dateStr + <span class="hljs-string">"同期"</span>;<br>			<span class="hljs-keyword">if</span> (subscribeHouseRate &lt; <span class="hljs-number">0</span>) &#123;<br>				subscribeHouseStr += <span class="hljs-string">"减少"</span>;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				subscribeHouseStr += <span class="hljs-string">"增长"</span>;<br>			&#125;<br>			subscribeHouseStr += Math.abs(subscribeHouseRate) + <span class="hljs-string">"%"</span>;<br>			createCellAndRow(style4, subscribeHouseStr, row);<br><br>			<span class="hljs-comment">// 新增认购金额</span><br>			row = sheet.createRow(<span class="hljs-number">16</span>);<br>			Long subscribeMoney = report.getSubscribeMoney();<br>			Double subscribeMoneyRate = <span class="hljs-keyword">new</span> Double(report.getSubscribeMoneyRate());<br>			String subscribeMoneyStr = <span class="hljs-string">"   新增认购金额"</span> + subscribeMoney + <span class="hljs-string">"万元，较"</span> + dateStr + <span class="hljs-string">"同期"</span>;<br>			<span class="hljs-keyword">if</span> (subscribeHouseRate &lt; <span class="hljs-number">0</span>) &#123;<br>				subscribeMoneyStr += <span class="hljs-string">"减少"</span>;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				subscribeMoneyStr += <span class="hljs-string">"增长"</span>;<br>			&#125;<br>			subscribeMoneyStr += Math.abs(subscribeMoneyRate) + <span class="hljs-string">"%"</span>;<br>			createCellAndRow(style4, subscribeMoneyStr, row);<br><br>			<span class="hljs-comment">// 新增签约套数</span><br>			row = sheet.createRow(<span class="hljs-number">17</span>);<br>			Integer signCount = report.getSignCount();<br>			Double signRate = <span class="hljs-keyword">new</span> Double(report.getSignRate());<br>			String signStr = <span class="hljs-string">"2、新增签约套数"</span> + signCount + <span class="hljs-string">"套,较"</span> + dateStr + <span class="hljs-string">"同期"</span>;<br>			<span class="hljs-keyword">if</span> (signRate &lt; <span class="hljs-number">0</span>) &#123;<br>				signStr += <span class="hljs-string">"减少"</span>;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				signStr += <span class="hljs-string">"增长"</span>;<br>			&#125;<br>			signStr += Math.abs(signRate) + <span class="hljs-string">"%"</span>;<br>			createCellAndRow(style4, signStr, row);<br><br>			<span class="hljs-comment">// 新增签约金额</span><br>			row = sheet.createRow(<span class="hljs-number">18</span>);<br>			Long signHouseMoney = report.getSignHouseMoney();<br>			Double signHouseMoneyRate = <span class="hljs-keyword">new</span> Double(report.getSignHouseMoneyRate());<br>			String signHouseMoneyStr = <span class="hljs-string">"   新增签约金额"</span> + signHouseMoney + <span class="hljs-string">"万元，较"</span> + dateStr + <span class="hljs-string">"同期"</span>;<br>			<span class="hljs-keyword">if</span> (signHouseMoneyRate &lt; <span class="hljs-number">0</span>) &#123;<br>				signHouseMoneyStr += <span class="hljs-string">"减少"</span>;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				signHouseMoneyStr += <span class="hljs-string">"增长"</span>;<br>			&#125;<br>			signHouseMoneyStr += Math.abs(signHouseMoneyRate) + <span class="hljs-string">"%"</span>;<br>			createCellAndRow(style4, signHouseMoneyStr, row);<br><br>			<span class="hljs-comment">// 新接访签约率</span><br>			row = sheet.createRow(<span class="hljs-number">19</span>);<br>			Double newCustomerSignedRate = <span class="hljs-keyword">new</span> Double(report.getNewCustomerSignedRate());<br>			String newCustomerSignedStr = <span class="hljs-string">"3、"</span> + dateStr + <span class="hljs-string">"新客户接访签约率"</span> + newCustomerSignedRate + <span class="hljs-string">"%，接访签约概率"</span>;<br>			<span class="hljs-keyword">if</span> (newCustomerSignedRate &lt; <span class="hljs-number">4</span>) &#123;<br>				newCustomerSignedStr += <span class="hljs-string">"较低，与理想值差距大"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newCustomerSignedRate &gt;= <span class="hljs-number">4</span> &amp;&amp; newCustomerSignedRate &lt;= <span class="hljs-number">6</span>) &#123;<br>				newCustomerSignedStr += <span class="hljs-string">"尚可，还有提高空间"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newCustomerSignedRate &gt;= <span class="hljs-number">6</span> &amp;&amp; newCustomerSignedRate &lt;= <span class="hljs-number">7</span>) &#123;<br>				newCustomerSignedStr += <span class="hljs-string">"很高"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newCustomerSignedRate &gt; <span class="hljs-number">7</span>) &#123;<br>				newCustomerSignedStr += <span class="hljs-string">"非常高"</span>;<br>			&#125;<br>			createCellAndRow(style4, newCustomerSignedStr, row);<br><br>			<span class="hljs-comment">// 储客签约率</span><br>			row = sheet.createRow(<span class="hljs-number">20</span>);<br>			Double momeryCustomerSignedRate = <span class="hljs-keyword">new</span> Double(report.getMomeryCustomerSignedRate());<br>			String momeryCustomerSignedStr = <span class="hljs-string">"4、储客签约率"</span> + momeryCustomerSignedRate + <span class="hljs-string">"%，储备客户签约概率"</span>;<br>			<span class="hljs-keyword">if</span> (momeryCustomerSignedRate &lt; <span class="hljs-number">7</span>) &#123;<br>				momeryCustomerSignedStr += <span class="hljs-string">"较低，与理想值差距大"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (momeryCustomerSignedRate &gt;= <span class="hljs-number">7</span> &amp;&amp; momeryCustomerSignedRate &lt;= <span class="hljs-number">12</span>) &#123;<br>				momeryCustomerSignedStr += <span class="hljs-string">"尚可，还有提高空间"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (momeryCustomerSignedRate &gt;= <span class="hljs-number">12</span> &amp;&amp; momeryCustomerSignedRate &lt;= <span class="hljs-number">15</span>) &#123;<br>				momeryCustomerSignedStr += <span class="hljs-string">"很高"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (momeryCustomerSignedRate &gt; <span class="hljs-number">15</span>) &#123;<br>				momeryCustomerSignedStr += <span class="hljs-string">"非常高"</span>;<br>			&#125;<br>			createCellAndRow(style4, momeryCustomerSignedStr, row);<br><br>			<span class="hljs-comment">// 老客户签约率</span><br>			row = sheet.createRow(<span class="hljs-number">21</span>);<br>			Double oldCustomerSignedRate = <span class="hljs-keyword">new</span> Double(report.getOldCustomerSignedRate());<br>			String oldCustomerSignedStr = <span class="hljs-string">"5、老客户签约率为23.2%，高意向客户签约概率"</span>;<br>			<span class="hljs-keyword">if</span> (oldCustomerSignedRate &lt; <span class="hljs-number">25</span>) &#123;<br>				oldCustomerSignedStr += <span class="hljs-string">"较低，与理想值差距大"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldCustomerSignedRate &gt;= <span class="hljs-number">25</span> &amp;&amp; oldCustomerSignedRate &lt;= <span class="hljs-number">35</span>) &#123;<br>				oldCustomerSignedStr += <span class="hljs-string">"尚可，还有提高空间"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldCustomerSignedRate &gt;= <span class="hljs-number">35</span> &amp;&amp; oldCustomerSignedRate &lt;= <span class="hljs-number">50</span>) &#123;<br>				oldCustomerSignedStr += <span class="hljs-string">"很高"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldCustomerSignedRate &gt; <span class="hljs-number">50</span>) &#123;<br>				oldCustomerSignedStr += <span class="hljs-string">"非常高"</span>;<br>			&#125;<br>			createCellAndRow(style4, oldCustomerSignedStr, row);<br><br>			<span class="hljs-comment">// 认购客户签约率</span><br>			row = sheet.createRow(<span class="hljs-number">22</span>);<br>			Double contratCuSignedRate = <span class="hljs-keyword">new</span> Double(report.getContratCuSignedRate());<br>			String contratCuSignedStr = <span class="hljs-string">"6、认购客户签约率为92%，已认购客户签约率"</span>;<br>			<span class="hljs-keyword">if</span> (contratCuSignedRate &lt; <span class="hljs-number">95</span>) &#123;<br>				contratCuSignedStr += <span class="hljs-string">"不高，较多退订或拒签"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contratCuSignedRate &gt;= <span class="hljs-number">95</span> &amp;&amp; contratCuSignedRate &lt;= <span class="hljs-number">97</span>) &#123;<br>				contratCuSignedStr += <span class="hljs-string">"尚可，一定数量退订或拒签"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contratCuSignedRate &gt;= <span class="hljs-number">97</span> &amp;&amp; contratCuSignedRate &lt;= <span class="hljs-number">99</span>) &#123;<br>				contratCuSignedStr += <span class="hljs-string">"很高"</span>;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contratCuSignedRate &gt; <span class="hljs-number">99</span>) &#123;<br>				contratCuSignedStr += <span class="hljs-string">"非常高"</span>;<br>			&#125;<br>			createCellAndRow(style4, contratCuSignedStr, row);<br><br>			<span class="hljs-comment">//空行</span><br>			row = sheet.createRow(<span class="hljs-number">23</span>);<br>			createCellAndRow(style4, <span class="hljs-string">""</span>, row);<br>			<br>			<span class="hljs-comment">//底侧</span><br>			row = sheet.createRow(<span class="hljs-number">24</span>);<br>			createCellAndRow(style5, <span class="hljs-string">""</span>, row);<br>			<br>		&#125;<span class="hljs-keyword">else</span>&#123;<br>			row = sheet.createRow(<span class="hljs-number">13</span>);<br>			createCellAndRow(style5, <span class="hljs-string">""</span>, row);<br>		&#125;<br><br>		<span class="hljs-keyword">try</span> &#123;<br>			workbook.write(out);<br>		&#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createCellAndRow</span><span class="hljs-params">(HSSFCellStyle style, String text, HSSFRow row)</span> </span>&#123;<br>		HSSFCell cell = row.createCell(<span class="hljs-number">0</span>);<br>		cell.setCellStyle(style);<br>		HSSFRichTextString rs = <span class="hljs-keyword">new</span> HSSFRichTextString(text);<br>		cell.setCellValue(rs);<br>	&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 上传Excel</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> fileNewName</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> uploadFile</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">uploadExcel</span><span class="hljs-params">(String fileNewName,ByteArrayInputStream uploadFile)</span></span>&#123;<br>		<span class="hljs-comment">// 设置用户属性, 包括appid, secretId和SecretKey</span><br>				<span class="hljs-comment">// 这些属性可以通过cos控制台获取(https://console.qcloud.com/cos)</span><br>				String version = PropertiesUtil.getValue(<span class="hljs-string">"version"</span>);<br>					 <span class="hljs-keyword">long</span> appId = <span class="hljs-string">"你的appId"</span>;<br>	                 String secretId = <span class="hljs-string">"你的secretId "</span>;<br>	                 String secretKey = <span class="hljs-string">"你的secretKey "</span>;<br>				<br>				<span class="hljs-comment">// 设置要操作的bucket</span><br>				String bucketName = <span class="hljs-string">"root"</span>;<br>				<span class="hljs-comment">// 初始化客户端配置</span><br>				ClientConfig clientConfig = <span class="hljs-keyword">new</span> ClientConfig();<br>				<span class="hljs-comment">// 设置bucket所在的区域，比如广州(gz), 天津(tj)</span><br>				clientConfig.setRegion(<span class="hljs-string">"sh"</span>);<br>				<span class="hljs-comment">// 初始化秘钥信息</span><br>				Credentials cred = <span class="hljs-keyword">new</span> Credentials(appId, secretId, secretKey);<br>				<span class="hljs-comment">// 初始化cosClient</span><br>				COSClient cosClient = <span class="hljs-keyword">new</span> COSClient(clientConfig, cred);<br>				<span class="hljs-comment">// 文件操作 //</span><br>				<span class="hljs-comment">// 1. 上传文件(默认不覆盖)</span><br>				<span class="hljs-comment">// 将本地的local_file_1.txt上传到bucket下的根分区下,并命名为sample_file.txt</span><br>				<span class="hljs-comment">// 默认不覆盖, 如果cos上已有文件, 则返回错误</span><br>				String cosFilePath = <span class="hljs-string">"/report/"</span> + fileNewName;<br>				<br>				<span class="hljs-keyword">byte</span>[] localFilePath1 = <span class="hljs-keyword">null</span>;<br>				<span class="hljs-keyword">try</span> &#123;<br>					localFilePath1 = ConvertUtil.toByteArray(uploadFile);<br>				&#125; <span class="hljs-keyword">catch</span> (IOException e1) &#123;<br>					<span class="hljs-comment">// TODO Auto-generated catch block</span><br>					e1.printStackTrace();<br>				&#125;<br>				<br>				UploadFileRequest uploadFileRequest = <span class="hljs-keyword">new</span> UploadFileRequest(bucketName, cosFilePath, localFilePath1);<br>				uploadFileRequest.setEnableShaDigest(<span class="hljs-keyword">false</span>);<br>				String uploadFileRet = cosClient.uploadFile(uploadFileRequest);<br>				System.out.println(<span class="hljs-string">"upload file ret:"</span> + uploadFileRet);<br>				<span class="hljs-comment">//获取保存路径</span><br>				ObjectMapper om = <span class="hljs-keyword">new</span> ObjectMapper();<br>				HashMap map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>				<span class="hljs-keyword">try</span> &#123;<br>					map = om.readValue(uploadFileRet, HashMap<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<br>				&#125; <span class="hljs-keyword">catch</span> (JsonParseException e) &#123;<br>					<span class="hljs-comment">// TODO Auto-generated catch block</span><br>					e.printStackTrace();<br>				&#125; <span class="hljs-keyword">catch</span> (JsonMappingException e) &#123;<br>					<span class="hljs-comment">// TODO Auto-generated catch block</span><br>					e.printStackTrace();<br>				&#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>					<span class="hljs-comment">// TODO Auto-generated catch block</span><br>					e.printStackTrace();<br>				&#125;<br>				HashMap&lt;String, String&gt; value = (HashMap&lt;String, String&gt;) map.get(<span class="hljs-string">"data"</span>);<br>				<span class="hljs-keyword">return</span> value.get(<span class="hljs-string">"source_url"</span>);<br>				<br>	&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">addReportExcelToDB</span><span class="hljs-params">(ReportResult rr, String url)</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">if</span>(StringUtils.isEmpty(url))&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>		&#125;<br>		<span class="hljs-keyword">if</span>(rr == <span class="hljs-keyword">null</span>)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>		&#125;<br>		<br>		ProjectReportRecord prr = <span class="hljs-keyword">new</span> ProjectReportRecord();<br>		prr.setCreateTime(DateUtil.format(<span class="hljs-keyword">new</span> Date()));<br>		prr.setProjectId(rr.getProjectId());<br>		prr.setProjectName(rr.getProjectName());<br>		prr.setStartTime(rr.getStartTime());<br>		prr.setEndTime(rr.getEndTime());<br>		prr.setUrl(url);<br>		String report = <span class="hljs-string">""</span>;<br>		<span class="hljs-keyword">if</span>(<span class="hljs-string">"案场周报"</span>.equals(rr.getReportName()))&#123;<br>			report = <span class="hljs-string">"week"</span>;<br>		&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">"案场月报"</span>.equals(rr.getReportName()))&#123;<br>			report = <span class="hljs-string">"month"</span>;<br>		&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">"案场季报"</span>.equals(rr.getReportName()))&#123;<br>			report = <span class="hljs-string">"quarter"</span>;<br>		&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">"案场半年报"</span>.equals(rr.getReportName()))&#123;<br>			report = <span class="hljs-string">"half"</span>;<br>		&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">"案场年报"</span>.equals(rr.getReportName()))&#123;<br>			report = <span class="hljs-string">"year"</span>;<br>		&#125;<span class="hljs-keyword">else</span>&#123;<br>			report = <span class="hljs-string">"other"</span>;<br>		&#125;<br>		prr.setReportName(report);<br>		<br>		baseDao.save(prr);<br>		<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>	&#125;<br></code></pre></td></tr></table></figure>

<h3 id="生成的文件示例"><a href="#生成的文件示例" class="headerlink" title="生成的文件示例"></a>生成的文件示例</h3><p><strong>周报或者其他报告都是后台自动根据时间进行判断的</strong></p>
<p><strong>周报</strong><br><img    class="lazyload" data-original="http://img.blog.csdn.net/20171020105154962?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2ludGVyX2NoZW4wMDE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p><strong>季报</strong></p>
<p><img    class="lazyload" data-original="http://img.blog.csdn.net/20171020105212669?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvV2ludGVyX2NoZW4wMDE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p>以上</p>
]]></content>
      <categories>
        <category>JavaUtils</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>poi</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring中使用log4j详细配置</title>
    <url>/2017/09/26/spring-log4j/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046780016875.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br>第一步：导入log4j-1.2.17.jar包。<br>第二步：src同级创建并设置log4j.properties。<br>    log4j.properties的详细配置：</p>
<a id="more"></a>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"> ### 设置 ###</span><br><span class="hljs-meta">log4j.rootLogger</span> = <span class="hljs-string">debug,stdout,D,E</span><br><br><span class="hljs-comment">### 输出信息到控制抬 ###</span><br><span class="hljs-meta">log4j.appender.stdout</span> = <span class="hljs-string">org.apache.log4j.ConsoleAppender</span><br><span class="hljs-meta">log4j.appender.stdout.Target</span> = <span class="hljs-string">System.out</span><br><span class="hljs-meta">log4j.appender.stdout.layout</span> = <span class="hljs-string">org.apache.log4j.PatternLayout</span><br><span class="hljs-meta">log4j.appender.stdout.layout.ConversionPattern</span> = <span class="hljs-string">[%-5p] %d&#123;yyyy-MM-dd HH:mm:ss,SSS&#125; method:%l%n%m%n</span><br><br><span class="hljs-comment">### 输出DEBUG 级别以上的日志到=E://logs/error.log ###</span><br><span class="hljs-meta">log4j.appender.D</span> = <span class="hljs-string">org.apache.log4j.DailyRollingFileAppender</span><br><span class="hljs-meta">log4j.appender.D.File</span> = <span class="hljs-string">E://logs/log.log</span><br><span class="hljs-meta">log4j.appender.D.Append</span> = <span class="hljs-string">true</span><br><span class="hljs-meta">log4j.appender.D.Threshold</span> = <span class="hljs-string">DEBUG </span><br><span class="hljs-meta">log4j.appender.D.layout</span> = <span class="hljs-string">org.apache.log4j.PatternLayout</span><br><span class="hljs-meta">log4j.appender.D.layout.ConversionPattern</span> = <span class="hljs-string">%-d&#123;yyyy-MM-dd HH:mm:ss&#125;  [ %t:%r ] - [ %p ]  %m%n</span><br><br><span class="hljs-comment">### 输出ERROR 级别以上的日志到=E://logs/error.log ###</span><br><span class="hljs-meta">log4j.appender.E</span> = <span class="hljs-string">org.apache.log4j.DailyRollingFileAppender</span><br><span class="hljs-meta">log4j.appender.E.File</span> =<span class="hljs-string">E://logs/error.log </span><br><span class="hljs-meta">log4j.appender.E.Append</span> = <span class="hljs-string">true</span><br><span class="hljs-meta">log4j.appender.E.Threshold</span> = <span class="hljs-string">ERROR </span><br><span class="hljs-meta">log4j.appender.E.layout</span> = <span class="hljs-string">org.apache.log4j.PatternLayout</span><br><span class="hljs-meta">log4j.appender.E.layout.ConversionPattern</span> = <span class="hljs-string">%-d&#123;yyyy-MM-dd HH:mm:ss&#125;  [ %t:%r ] - [ %p ]  %m%n</span><br></code></pre></td></tr></table></figure>

<p><a href="http://blog.csdn.net/qq_30175203/article/details/52084127" target="_blank" rel="noopener">更详细的log4j.properties配置</a></p>
<p>第三步：web.xml中加入配置详细：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 设置根目录 --&gt;</span>  <br><span class="hljs-comment">&lt;!--初始化log4j.properties--&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>log4jConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>/WEB-INF/classes/log4j.properties<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>  <br><span class="hljs-comment">&lt;!-- 3000表示 开一条watchdog线程每60秒扫描一下配置文件的变化;这样便于日志存放位置的改变 --&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>    <br>        <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>log4jRefreshInterval<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>    <br>        <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>3000<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>    <br>   <span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>   <br><span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.springframework.web.util.Log4jConfigListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span><br></code></pre></td></tr></table></figure>


<p>applicationContext.xml就不需要配置了</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>  </span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span>  </span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:aop</span>=<span class="hljs-string">"http://www.springframework.org/schema/aop"</span>  </span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"    </span></span><br><span class="hljs-tag"><span class="hljs-string"></span></span><br><span class="hljs-tag"><span class="hljs-string">http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string"></span></span><br><span class="hljs-tag"><span class="hljs-string"></span></span><br><span class="hljs-tag"><span class="hljs-string">http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string"></span></span><br><span class="hljs-tag"><span class="hljs-string"></span></span><br><span class="hljs-tag"><span class="hljs-string">http://www.springframework.org/schema/aop</span></span><br><span class="hljs-tag"><span class="hljs-string"></span></span><br><span class="hljs-tag"><span class="hljs-string"></span></span><br><span class="hljs-tag"><span class="hljs-string">http://www.springframework.org/schema/aop/spring-aop-3.2.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string"></span></span><br><span class="hljs-tag"><span class="hljs-string"></span></span><br><span class="hljs-tag"><span class="hljs-string">http://www.springframework.org/schema/context</span></span><br><span class="hljs-tag"><span class="hljs-string"></span></span><br><span class="hljs-tag"><span class="hljs-string">           http://www.springframework.org/schema/context/spring-context-3.2.xsd"</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>然后日志就可以随着spring的启动而启动了。</p>
<p>如果想把日志文件打印到Tomcat日志文件中：<br>log4j.appender.R.File=${catalina.home}/logs/youLogFile.log </p>
<p>这个方法只能Tomcat使用，其它容器就不行了。</p>
]]></content>
      <categories>
        <category>spring</category>
      </categories>
      <tags>
        <tag>spring</tag>
        <tag>log4j</tag>
      </tags>
  </entry>
  <entry>
    <title>解决Mysql存入大量TEXT类型的数据报错</title>
    <url>/2017/09/26/mysql-text/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046776177067.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br>主要的原因是因为max_sort_length的默认值为1024,=<br>解决办法：该参数是动态参数，任何客户端都可以在Mysql数据库运行时更改该参数的值，例如：<br>1.首先应该查询一下这个参数的默认值为多少</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">mysql&gt; SELECT @@global.max_sort_length;<br></code></pre></td></tr></table></figure>
<a id="more"></a>
<p>2.然后去设置这个值：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">mysql&gt; SET GLOBAL max_sort_length&#x3D;2048;  &#x2F;&#x2F;2048这个数值由你了<br></code></pre></td></tr></table></figure>
<p>3.然后再查询一下这个参数的默认值：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">mysql&gt; SELECT @@global.max_sort_length;<br></code></pre></td></tr></table></figure>
<p>以上问题就解决了</p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring boot Mybatis 整合（完整版）</title>
    <url>/2017/09/25/springboot-mybatis/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046780820013.jpg" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""></p>
<p><strong>本项目使用的环境：</strong></p>
<ul>
<li>开发工具：Intellij IDEA 2017.1.3</li>
<li>jdk：1.8.0_161</li>
<li>maven:3.3.9<a id="more"></a>

</li>
</ul>
<p><strong>额外功能</strong></p>
<ul>
<li>PageHelper 分页插件</li>
<li>mybatis generator 自动生成代码插件</li>
</ul>
<p><strong>步骤：</strong><br><strong>1.创建一个springboot项目：</strong><br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046464261112.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span><br><strong>2.创建项目的文件结构以及jdk的版本</strong><br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046464366644.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span><br><strong>3.选择项目所需要的依赖</strong><br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046464475646.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span><br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046464579648.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span><br>然后点击finish</p>
<p><strong>5.看一下文件的结构：</strong><br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046464693133.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p><strong>6.查看一下pom.xml：</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">	<span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.winter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springboot-mybatis-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>springboot-mybatis-demo<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.6.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.reporting.outputEncoding</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.7<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.35<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- alibaba的druid数据库连接池 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-datatype-joda<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.module<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-module-parameter-names<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- 分页插件 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.pagehelper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- alibaba的druid数据库连接池 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>			<span class="hljs-comment">&lt;!-- mybatis generator 自动生成代码插件 --&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.generator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>				<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>					<span class="hljs-tag">&lt;<span class="hljs-name">configurationFile</span>&gt;</span>$&#123;basedir&#125;/src/main/resources/generator/generatorConfig.xml<span class="hljs-tag">&lt;/<span class="hljs-name">configurationFile</span>&gt;</span><br>					<span class="hljs-tag">&lt;<span class="hljs-name">overwrite</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">overwrite</span>&gt;</span><br>					<span class="hljs-tag">&lt;<span class="hljs-name">verbose</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">verbose</span>&gt;</span><br>				<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>			<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>7.项目不使用application.properties文件 而使用更加简洁的application.yml文件：</strong><br><strong>将原有的resource文件夹下的application.properties文件删除，创建一个新的application.yml配置文件，</strong><br><strong>文件的内容如下：</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><br><span class="hljs-attr">spring:</span><br>    <span class="hljs-attr">datasource:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">test</span><br>        <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/depot</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>        <span class="hljs-comment"># 使用druid数据源</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>        <span class="hljs-attr">filters:</span> <span class="hljs-string">stat</span><br>        <span class="hljs-attr">maxActive:</span> <span class="hljs-number">20</span><br>        <span class="hljs-attr">initialSize:</span> <span class="hljs-number">1</span><br>        <span class="hljs-attr">maxWait:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-attr">minIdle:</span> <span class="hljs-number">1</span><br>        <span class="hljs-attr">timeBetweenEvictionRunsMillis:</span> <span class="hljs-number">60000</span><br>        <span class="hljs-attr">minEvictableIdleTimeMillis:</span> <span class="hljs-number">300000</span><br>        <span class="hljs-attr">validationQuery:</span> <span class="hljs-string">select</span> <span class="hljs-string">'x'</span><br>        <span class="hljs-attr">testWhileIdle:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">testOnBorrow:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">testOnReturn:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">poolPreparedStatements:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">maxOpenPreparedStatements:</span> <span class="hljs-number">20</span><br><span class="hljs-attr">mybatis:</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapping/*.xml</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.winter.model</span><br><br><span class="hljs-comment">#pagehelper分页插件</span><br><span class="hljs-attr">pagehelper:</span><br>    <span class="hljs-attr">helperDialect:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">reasonable:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">supportMethodsArguments:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">params:</span> <span class="hljs-string">count=countSql</span><br></code></pre></td></tr></table></figure>
<p><strong>8.创建数据库：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs mysql">CREATE DATABASE mytest;<br><br>CREATE TABLE t_user(<br>  user_id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,<br>  user_name VARCHAR(255) NOT NULL ,<br>  password VARCHAR(255) NOT NULL ,<br>  phone VARCHAR(255) NOT NULL<br>) ENGINE&#x3D;INNODB AUTO_INCREMENT&#x3D;1000 DEFAULT CHARSET&#x3D;utf8;<br></code></pre></td></tr></table></figure>
<p><strong>9.使用mybatis generator 自动生成代码：</strong></p>
<ul>
<li>配置pom.xml中generator 插件所对应的配置文件       ${basedir}/src/main/resources/generator/generatorConfig.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">generatorConfiguration</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd"</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">generatorConfiguration</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 数据库驱动:选择你的本地硬盘上面的数据库驱动包--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">classPathEntry</span>  <span class="hljs-attr">location</span>=<span class="hljs-string">"E:\developer\mybatis-generator-core-1.3.2\lib\mysql-connector-java-5.1.25-bin.jar"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"DB2Tables"</span>  <span class="hljs-attr">targetRuntime</span>=<span class="hljs-string">"MyBatis3"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">commentGenerator</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"suppressDate"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span><br>            <span class="hljs-comment">&lt;!-- 是否去除自动生成的注释 true：是 ： false:否 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"suppressAllComments"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">commentGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--数据库链接URL，用户名、密码 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">jdbcConnection</span> <span class="hljs-attr">driverClass</span>=<span class="hljs-string">"com.mysql.jdbc.Driver"</span> <span class="hljs-attr">connectionURL</span>=<span class="hljs-string">"jdbc:mysql://127.0.0.1/mytest"</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">"root"</span> <span class="hljs-attr">password</span>=<span class="hljs-string">"root"</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">jdbcConnection</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javaTypeResolver</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"forceBigDecimals"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"false"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javaTypeResolver</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 生成模型的包名和位置--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javaModelGenerator</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">"com.winter.model"</span> <span class="hljs-attr">targetProject</span>=<span class="hljs-string">"src/main/java"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"enableSubPackages"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"trimStrings"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javaModelGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 生成映射文件的包名和位置--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sqlMapGenerator</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">"mapping"</span> <span class="hljs-attr">targetProject</span>=<span class="hljs-string">"src/main/resources"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"enableSubPackages"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">sqlMapGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 生成DAO的包名和位置--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javaClientGenerator</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"XMLMAPPER"</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">"com.winter.mapper"</span> <span class="hljs-attr">targetProject</span>=<span class="hljs-string">"src/main/java"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"enableSubPackages"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javaClientGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 要生成的表 tableName是数据库中的表名或视图名 domainObjectName是实体类名--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">"t_user"</span> <span class="hljs-attr">domainObjectName</span>=<span class="hljs-string">"User"</span> <span class="hljs-attr">enableCountByExample</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">enableUpdateByExample</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">enableDeleteByExample</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">enableSelectByExample</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">selectByExampleQueryId</span>=<span class="hljs-string">"false"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">context</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">generatorConfiguration</span>&gt;</span><br></code></pre></td></tr></table></figure>


<ul>
<li>点击run-Edit Configurations </li>
</ul>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046464807165.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<ul>
<li>添加配置</li>
</ul>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046464921174.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<ul>
<li><p>运行<br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046465025562.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p>  最后生成的文件以及结构：</p>
</li>
</ul>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046465055490.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p><strong>10. 生成的文件</strong></p>
<p><strong>UserMapper.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winter.mapper;<br><br><span class="hljs-keyword">import</span> com.winter.model.User;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteByPrimaryKey</span><span class="hljs-params">(Integer userId)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(User record)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertSelective</span><span class="hljs-params">(User record)</span></span>;<br><br>    <span class="hljs-function">User <span class="hljs-title">selectByPrimaryKey</span><span class="hljs-params">(Integer userId)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKeySelective</span><span class="hljs-params">(User record)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKey</span><span class="hljs-params">(User record)</span></span>;<br>	<span class="hljs-comment">//这个方式我自己加的</span><br>	<span class="hljs-function">List&lt;User&gt; <span class="hljs-title">selectAllUser</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>User.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winter.model;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Integer userId;<br><br>    <span class="hljs-keyword">private</span> String userName;<br><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-keyword">private</span> String phone;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getUserId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> userId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserId</span><span class="hljs-params">(Integer userId)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.userId = userId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUserName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> userName;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserName</span><span class="hljs-params">(String userName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.userName = userName == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : userName.trim();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPassword</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> password;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPassword</span><span class="hljs-params">(String password)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.password = password == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : password.trim();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPhone</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> phone;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPhone</span><span class="hljs-params">(String phone)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.phone = phone == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : phone.trim();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>对于sql语句这种黄色的背景，真心是看不下去了（解决方案）：<br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046465130102.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p>*<em>UserMapper.xml    *</em></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.winter.mapper.UserMapper"</span> &gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.winter.model.User"</span> &gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"user_id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"userId"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"user_name"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"userName"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"phone"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"phone"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Base_Column_List"</span> &gt;</span><br>    user_id, user_name, password, phone<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByPrimaryKey"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span><br>    select <br>    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span> /&gt;</span><br>    from t_user<br>    where user_id = #&#123;userId,jdbcType=INTEGER&#125;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- 这个方法是我自己加的 --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectAllUser"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span>&gt;</span><br>    select<br>    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span> /&gt;</span><br>    from t_user<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span><br>    delete from t_user<br>    where user_id = #&#123;userId,jdbcType=INTEGER&#125;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.winter.model.User"</span> &gt;</span><br>    insert into t_user (user_id, user_name, password, <br>      phone)<br>    values (#&#123;userId,jdbcType=INTEGER&#125;, #&#123;userName,jdbcType=VARCHAR&#125;, #&#123;password,jdbcType=VARCHAR&#125;, <br>      #&#123;phone,jdbcType=VARCHAR&#125;)<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insertSelective"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.winter.model.User"</span> &gt;</span><br>    insert into t_user<br>    <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userId != null"</span> &gt;</span><br>        user_id,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userName != null"</span> &gt;</span><br>        user_name,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"password != null"</span> &gt;</span><br>        password,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"phone != null"</span> &gt;</span><br>        phone,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"values ("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userId != null"</span> &gt;</span><br>        #&#123;userId,jdbcType=INTEGER&#125;,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userName != null"</span> &gt;</span><br>        #&#123;userName,jdbcType=VARCHAR&#125;,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"password != null"</span> &gt;</span><br>        #&#123;password,jdbcType=VARCHAR&#125;,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"phone != null"</span> &gt;</span><br>        #&#123;phone,jdbcType=VARCHAR&#125;,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKeySelective"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.winter.model.User"</span> &gt;</span><br>    update t_user<br>    <span class="hljs-tag">&lt;<span class="hljs-name">set</span> &gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userName != null"</span> &gt;</span><br>        user_name = #&#123;userName,jdbcType=VARCHAR&#125;,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"password != null"</span> &gt;</span><br>        password = #&#123;password,jdbcType=VARCHAR&#125;,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"phone != null"</span> &gt;</span><br>        phone = #&#123;phone,jdbcType=VARCHAR&#125;,<br>      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>    where user_id = #&#123;userId,jdbcType=INTEGER&#125;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.winter.model.User"</span> &gt;</span><br>    update t_user<br>    set user_name = #&#123;userName,jdbcType=VARCHAR&#125;,<br>      password = #&#123;password,jdbcType=VARCHAR&#125;,<br>      phone = #&#123;phone,jdbcType=VARCHAR&#125;<br>    where user_id = #&#123;userId,jdbcType=INTEGER&#125;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>11.打开类SpringbootMybatisDemoApplication.java，这个是springboot的启动类。我们需要添加点东西：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winter;<br><br><span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan</span>(<span class="hljs-string">"com.winter.mapper"</span>)<span class="hljs-comment">//将项目中对应的mapper类的路径加进来就可以了</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringbootMybatisDemoApplication</span> </span>&#123;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		SpringApplication.run(SpringbootMybatisDemoApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>12.到这里所有的搭建工作都完成了，接下来就是测试的工作，没使用junit4进行测试：</strong><br><strong>首先看一下完成之后的文件的结构：</strong><br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046465294088.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p><strong>现在controller，service层的代码都写好：</strong></p>
<p><strong>UserController.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winter.Controller;<br><br><span class="hljs-keyword">import</span> com.winter.model.User;<br><span class="hljs-keyword">import</span> com.winter.service.UserService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Administrator on 2017/8/16.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/user"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/add"</span>, produces = &#123;<span class="hljs-string">"application/json;charset=UTF-8"</span>&#125;)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">addUser</span><span class="hljs-params">(User user)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> userService.addUser(user);<br>    &#125;<br><br>	<span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/all/&#123;pageNum&#125;/&#123;pageSize&#125;"</span>, produces = &#123;<span class="hljs-string">"application/json;charset=UTF-8"</span>&#125;)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">findAllUser</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"pageNum"</span>)</span> <span class="hljs-keyword">int</span> pageNum, @<span class="hljs-title">PathVariable</span><span class="hljs-params">(<span class="hljs-string">"pageSize"</span>)</span> <span class="hljs-keyword">int</span> pageSize)</span>&#123;<br><br>        <span class="hljs-keyword">return</span> userService.findAllUser(pageNum,pageSize);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>UserService.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winter.service;<br><br><span class="hljs-keyword">import</span> com.winter.model.User;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Administrator on 2017/8/16.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addUser</span><span class="hljs-params">(User user)</span></span>;<br><br>    <span class="hljs-function">List&lt;User&gt; <span class="hljs-title">findAllUser</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pageNum, <span class="hljs-keyword">int</span> pageSize)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>UserServiceImpl.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.winter.service.impl;<br><br><span class="hljs-keyword">import</span> com.github.pagehelper.PageHelper;<br><span class="hljs-keyword">import</span> com.winter.mapper.UserMapper;<br><span class="hljs-keyword">import</span> com.winter.model.User;<br><span class="hljs-keyword">import</span> com.winter.service.UserService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Administrator on 2017/8/16.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span>(value = <span class="hljs-string">"userService"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<span class="hljs-comment">//这里会报错，但是并不会影响</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">addUser</span><span class="hljs-params">(User user)</span> </span>&#123;<br><br>        <span class="hljs-keyword">return</span> userMapper.insertSelective(user);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    * 这个方法中用到了我们开头配置依赖的分页插件pagehelper</span><br><span class="hljs-comment">    * 很简单，只需要在service层传入参数，然后将参数传递给一个插件的一个静态方法即可；</span><br><span class="hljs-comment">    * pageNum 开始页数</span><br><span class="hljs-comment">    * pageSize 每页显示的数据条数</span><br><span class="hljs-comment">    * */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title">findAllUser</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pageNum, <span class="hljs-keyword">int</span> pageSize)</span> </span>&#123;<br>        <span class="hljs-comment">//将参数传给这个方法就可以实现物理分页了，非常简单。</span><br>        PageHelper.startPage(pageNum, pageSize);<br>        <span class="hljs-keyword">return</span> userMapper.selectAllUser();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果强迫症看不下去那个报错：（解决方法）<br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046465377128.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p><strong>测试我使用了idea一个很用心的功能。</strong><br><strong>可以发http请求的插件</strong>：<br><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046466520408.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p><img    class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046466577040.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="   ><span class="image-caption">这里写图片描述</span></p>
<p>点击左侧的运行按钮就可以发送请求了；<br>如果返回值正确 说明你已经搭建成功了！！</p>
<p><strong>如果大家想使用事务控制的话，请参照<a href="http://blog.csdn.net/Winter_chen001/article/details/78622141" target="_blank" rel="noopener">Spring boot Mybatis 整合（注解版）</a> ,这个里面就有关于事务控制的使用</strong></p>
<p>源码地址：<a href="https://github.com/WinterChenS/springboot-mybatis-demo" target="_blank" rel="noopener">https://github.com/WinterChenS/springboot-mybatis-demo</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>java优雅的输出helloWorld</title>
    <url>/2017/09/25/java-print-helloworld/</url>
    <content><![CDATA[<p><img   class="lazyload" data-original="https://cdn.jsdelivr.net/gh/WinterChenS/img/posts/1628046462268258.png" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="  alt=""><br>在java中很优雅的输出helloworld，可以试一试</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    		System.out.println(randomString(-<span class="hljs-number">229985452</span>) + <span class="hljs-string">" "</span> + randomString(-<span class="hljs-number">147909649</span>));<br>    	&#125;<br>    	<br>    	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">randomString</span><span class="hljs-params">(<span class="hljs-keyword">int</span> seed)</span></span>&#123;<br>    		Random rand = <span class="hljs-keyword">new</span> Random(seed);<br>    		StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>    		<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>    			<span class="hljs-keyword">int</span> n = rand.nextInt(<span class="hljs-number">27</span>);<br>    			<span class="hljs-keyword">if</span>(n==<span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;<br>    			sb.append((<span class="hljs-keyword">char</span>)(<span class="hljs-string">'`'</span>+n));<br>    				<br>    		&#125;<br>    		<span class="hljs-keyword">return</span> sb.toString();<br>    	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java基础</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
</search>
